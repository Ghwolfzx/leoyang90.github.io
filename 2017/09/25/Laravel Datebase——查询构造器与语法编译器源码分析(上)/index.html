<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0" />






<meta name="description" content="Laravel Datebase——查询构造器与语法编译器源码分析(上)前言在前两个文章中，我们分析了数据库的连接启动与数据库底层 CRUD 的原理，底层数据库服务支持原生 sql 的运行。本文以 mysql 为例，向大家讲述支持 Fluent 的查询构造器 query 与语法编译器 grammer 的原理。
DB::table 与 查询构造器若是不想使用原生的 sql 语句，我们可以使用 DB:">
<meta property="og:type" content="article">
<meta property="og:title" content="LEOYANG'S BLOG">
<meta property="og:url" content="https://leoyang90.github.io/2017/09/25/Laravel Datebase——查询构造器与语法编译器源码分析(上)/index.html">
<meta property="og:site_name" content="LEOYANG'S BLOG">
<meta property="og:description" content="Laravel Datebase——查询构造器与语法编译器源码分析(上)前言在前两个文章中，我们分析了数据库的连接启动与数据库底层 CRUD 的原理，底层数据库服务支持原生 sql 的运行。本文以 mysql 为例，向大家讲述支持 Fluent 的查询构造器 query 与语法编译器 grammer 的原理。
DB::table 与 查询构造器若是不想使用原生的 sql 语句，我们可以使用 DB:">
<meta property="og:image" content="http://owql68l6p.bkt.clouddn.com/17-9-23/27965477.jpg">
<meta property="og:image" content="http://owql68l6p.bkt.clouddn.com/17-9-23/10116808.jpg">
<meta property="og:updated_time" content="2017-09-25T13:43:55.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LEOYANG'S BLOG">
<meta name="twitter:description" content="Laravel Datebase——查询构造器与语法编译器源码分析(上)前言在前两个文章中，我们分析了数据库的连接启动与数据库底层 CRUD 的原理，底层数据库服务支持原生 sql 的运行。本文以 mysql 为例，向大家讲述支持 Fluent 的查询构造器 query 与语法编译器 grammer 的原理。
DB::table 与 查询构造器若是不想使用原生的 sql 语句，我们可以使用 DB:">
<meta name="twitter:image" content="http://owql68l6p.bkt.clouddn.com/17-9-23/27965477.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'LeoYang'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://leoyang90.github.io/2017/09/25/Laravel Datebase——查询构造器与语法编译器源码分析(上)/"/>





  <title>  | LEOYANG'S BLOG </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c45898c39ba7512b69229aa34c07263a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">LEOYANG'S BLOG</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Notes and Blogs</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'qzqmBx1WzwFX9LPuU1Rc','2.0.0');
</script>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/09/25/Laravel Datebase——查询构造器与语法编译器源码分析(上)/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-25T13:43:55+00:00">
                2017-09-25
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/09/25/Laravel Datebase——查询构造器与语法编译器源码分析(上)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/09/25/Laravel Datebase——查询构造器与语法编译器源码分析(上)/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/09/25/Laravel Datebase——查询构造器与语法编译器源码分析(上)/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Laravel-Datebase——查询构造器与语法编译器源码分析-上"><a href="#Laravel-Datebase——查询构造器与语法编译器源码分析-上" class="headerlink" title="Laravel Datebase——查询构造器与语法编译器源码分析(上)"></a>Laravel Datebase——查询构造器与语法编译器源码分析(上)</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在前两个文章中，我们分析了数据库的连接启动与数据库底层 <code>CRUD</code> 的原理，底层数据库服务支持原生 <code>sql</code> 的运行。本文以 <code>mysql</code> 为例，向大家讲述支持 <code>Fluent</code> 的查询构造器 <code>query</code> 与语法编译器 <code>grammer</code> 的原理。</p>
<h2 id="DB-table-与-查询构造器"><a href="#DB-table-与-查询构造器" class="headerlink" title="DB::table 与 查询构造器"></a>DB::table 与 查询构造器</h2><p>若是不想使用原生的 <code>sql</code> 语句，我们可以使用 <code>DB::table</code> 语句，该语句会返回一个 <code>query</code> 对象：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">table</span><span class="params">($table)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;query()-&gt;from($table);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">query</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> QueryBuilder(</div><div class="line">        <span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;getQueryGrammar(), <span class="keyword">$this</span>-&gt;getPostProcessor()</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以看到，<code>query</code> 会有两个成员，<code>queryGrammar</code> 与 <code>postProcessor</code>。<code>queryGrammar</code> 负责对 <code>QueryBuilcder</code> 的结果进行 <code>sql</code> 语言的转化，<code>postProcessor</code> 负责查询结果的后处理。</p>
<p>之所以 <code>laravel</code> 推荐我们使用查询构造器，而不是原生的 <code>sql</code>，原因在于可以避免 <code>sql</code> 注入漏洞。当然，我们也可以在使用 <code>DB::select()</code> 函数中手动写 <code>bindings</code> 的值，但是这样的话，我们写 <code>sql</code> 的语句是就必须是这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::select(<span class="string">'select * from table where col=?'</span>,[<span class="number">1</span>]);</div></pre></td></tr></table></figure>
<p>必然会带来很多不便。</p>
<p>有了查询构造器，我们就可以写出 <code>fluent</code> 类型的语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'table'</span>)-&gt;select(<span class="string">'*'</span>)-&gt;where(<span class="string">'col'</span>, <span class="number">1</span>);</div></pre></td></tr></table></figure>
<p>是不是很方便？</p>
<h2 id="CRUD-与语法编译器"><a href="#CRUD-与语法编译器" class="headerlink" title="CRUD 与语法编译器"></a>CRUD 与语法编译器</h2><p>相应于 <code>connection</code> 对象的 <code>CRUD</code>，语法编译器有 <code>compileInsert</code>、<code>compileSelect</code>、<code>compileUpdate</code>、<code>compileDelete</code>。其中最重要的是 <code>compileSelect</code>，因为它不仅负责了 <code>select</code> 语句的语法编译，还负责聚合语句 <code>aggregate</code>、<code>from</code> 语句、<code>join</code> 连接语句、<code>wheres</code> 条件语句、<code>groups</code> 分组语句、<code>havings</code> 条件语句、<code>orders</code> 排序语句、<code>limit</code> 语句、<code>offset</code> 语句、<code>unions</code> 联合语句、<code>lock</code> 语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $selectComponents = [</div><div class="line">    <span class="string">'aggregate'</span>,</div><div class="line">    <span class="string">'columns'</span>,</div><div class="line">    <span class="string">'from'</span>,</div><div class="line">    <span class="string">'joins'</span>,</div><div class="line">    <span class="string">'wheres'</span>,</div><div class="line">    <span class="string">'groups'</span>,</div><div class="line">    <span class="string">'havings'</span>,</div><div class="line">    <span class="string">'orders'</span>,</div><div class="line">    <span class="string">'limit'</span>,</div><div class="line">    <span class="string">'offset'</span>,</div><div class="line">    <span class="string">'unions'</span>,</div><div class="line">    <span class="string">'lock'</span>,</div><div class="line">];</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">compileSelect</span><span class="params">(Builder $query)</span></span></div><div class="line">&#123;</div><div class="line">   </div><div class="line">    $original = $query-&gt;columns;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (is_null($query-&gt;columns)) &#123;</div><div class="line">        $query-&gt;columns = [<span class="string">'*'</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $sql = trim(<span class="keyword">$this</span>-&gt;concatenate(</div><div class="line">        <span class="keyword">$this</span>-&gt;compileComponents($query))</div><div class="line">    );</div><div class="line"></div><div class="line">    $query-&gt;columns = $original;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $sql;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileComponents</span><span class="params">(Builder $query)</span></span></div><div class="line">&#123;</div><div class="line">    $sql = [];</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;selectComponents <span class="keyword">as</span> $component) &#123;</div><div class="line">        <span class="keyword">if</span> (! is_null($query-&gt;$component)) &#123;</div><div class="line">            $method = <span class="string">'compile'</span>.ucfirst($component);</div><div class="line"></div><div class="line">            $sql[$component] = <span class="keyword">$this</span>-&gt;$method($query, $query-&gt;$component);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $sql;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出来，语法编译器会将上述所有的语句放入 <code>$sql[]</code> 成员中，然后通过 <code>concatenate</code> 函数组装成 <code>sql</code> 语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">concatenate</span><span class="params">($segments)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> implode(<span class="string">' '</span>, array_filter($segments, <span class="function"><span class="keyword">function</span> <span class="params">($value)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (string) $value !== <span class="string">''</span>;</div><div class="line">    &#125;));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="wrap-函数"><a href="#wrap-函数" class="headerlink" title="wrap 函数"></a>wrap 函数</h3><p>若想要了解语法编译器，我们就必须先要了解 <code>grammer</code> 中一个重要的函数 <code>wrap</code>，这个函数专门对表名与列名进行处理，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">wrap</span><span class="params">($value, $prefixAlias = false)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isExpression($value)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getValue($value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (strpos(strtolower($value), <span class="string">' as '</span>) !== <span class="keyword">false</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrapAliasedValue($value, $prefixAlias);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrapSegments(explode(<span class="string">'.'</span>, $value));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>处理的流程：</p>
<ul>
<li>若是 <code>Expression</code> 对象，利用函数 <code>getValue</code> 直接取出对象值，不对其进行任何处理，用于处理原生 <code>sql</code>。<code>expression</code> 对象的作用是保护原始参数，避免框架解析的一种方式。也就是说，当我们用了 <code>expression</code> 来包装参数的话，<code>laravel</code> 将不会对其进行任何处理，包括库名解析、表名前缀、别名等。</li>
<li>若表名/列名存在 <code>as</code>，则利用函数 <code>wrapAliasedValue</code> 为表名设置别名。</li>
<li>若表名/列名含有 <code>.</code>，则会被分解为 <code>库名/表名</code>，或者 <code>表名/列名</code>，并调用函数 <code>wrapSegments</code>。</li>
</ul>
<h3 id="wrapAliasedValue-函数"><a href="#wrapAliasedValue-函数" class="headerlink" title="wrapAliasedValue 函数"></a>wrapAliasedValue 函数</h3><p><code>wrapAliasedValue</code> 函数用于处理别名：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapAliasedValue</span><span class="params">($value, $prefixAlias = false)</span></span></div><div class="line">&#123;</div><div class="line">    $segments = preg_split(<span class="string">'/\s+as\s+/i'</span>, $value);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($prefixAlias) &#123;</div><div class="line">        $segments[<span class="number">1</span>] = <span class="keyword">$this</span>-&gt;tablePrefix.$segments[<span class="number">1</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap(</div><div class="line">        $segments[<span class="number">0</span>]).<span class="string">' as '</span>.<span class="keyword">$this</span>-&gt;wrapValue($segments[<span class="number">1</span>]</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，首先程序会根据 <code>as</code> 将字符串分为两部分，<code>as</code> 前的部分递归调用 <code>wrap</code> 函数，<code>as</code> 后的部分调用 <code>wrapValue</code> 函数.</p>
<h3 id="wrapValue-函数"><a href="#wrapValue-函数" class="headerlink" title="wrapValue 函数"></a>wrapValue 函数</h3><p><code>wrapValue</code> 函数用来处理添加符号 <code>&quot;</code>，例如 <code>table</code>，会被这个函数变为 <code>&quot;table&quot;</code>。需要注意的是 <code>table1&quot;table2</code> 这种情况，假如我们的数据库中存在一个表，名字就叫做: <code>table1&quot;table2</code>，我们在数据库查询的时候，必须将表名转化为 <code>&quot;table1&quot;&quot;table2&quot;</code>，只有这样，数据库才会有效地转化表名为 <code>&quot;table1&quot;table2&quot;</code>，否则数据库就会报告错误：找不到表。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapValue</span><span class="params">($value)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> ($value !== <span class="string">'*'</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'"'</span>.str_replace(<span class="string">'"'</span>, <span class="string">'""'</span>, $value).<span class="string">'"'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="wrapSegments-函数"><a href="#wrapSegments-函数" class="headerlink" title="wrapSegments 函数"></a>wrapSegments 函数</h3><p><code>wrapSegments</code> 函数会判断当前参数，如果是 <code>table.column</code>，会将前一部分 <code>table</code> 调用 <code>wrapTable</code>, <code>column</code> 调用 <code>wrapValue</code>，最后生成 <code>“table”.&quot;column&quot;</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapSegments</span><span class="params">($segments)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> collect($segments)-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($segment, $key)</span> <span class="title">use</span> <span class="params">($segments)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $key == <span class="number">0</span> &amp;&amp; count($segments) &gt; <span class="number">1</span></div><div class="line">                        ? <span class="keyword">$this</span>-&gt;wrapTable($segment)</div><div class="line">                        : <span class="keyword">$this</span>-&gt;wrapValue($segment);</div><div class="line">    &#125;)-&gt;implode(<span class="string">'.'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="wrapTable-函数"><a href="#wrapTable-函数" class="headerlink" title="wrapTable 函数"></a>wrapTable 函数</h3><p><code>wrapTable</code> 函数用于为数据表添加表前缀：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public function wrapTable($table)</div><div class="line">&#123;</div><div class="line">    if (! $this-&gt;isExpression($table)) &#123;</div><div class="line">        return $this-&gt;wrap($this-&gt;tablePrefix.$table, true);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return $this-&gt;getValue($table);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>wrap</code> 整体流程图如下：</p>
<p><img src="http://owql68l6p.bkt.clouddn.com/17-9-23/27965477.jpg" alt="Markdown"></p>
<h2 id="from-语句"><a href="#from-语句" class="headerlink" title="from 语句"></a>from 语句</h2><p>我们看到 <code>DB::table</code> 实际上是调用了查询构造器的 <code>from</code> 函数。接下来我们就看看，当我们写下了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'table'</span>)-&gt;get()</div></pre></td></tr></table></figure>
<p>时发生了什么。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">from</span><span class="params">($table)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;from = $table;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们看到，<code>from</code> 函数极其简单，我们接下来看 <code>get</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($columns = [<span class="string">'*'</span>])</span></span></div><div class="line">&#123;</div><div class="line">    $original = <span class="keyword">$this</span>-&gt;columns;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (is_null($original)) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;columns = $columns;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $results = <span class="keyword">$this</span>-&gt;processor-&gt;processSelect(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;runSelect());</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;columns = $original;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> collect($results);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>laravel</code> 的查询构造器是懒加载的，只有调用了 <code>get</code> 函数才会真正的调用语法编译器，采用调用底层 <code>connection</code> 对象进行数据库查询：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runSelect</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;connection-&gt;select(</div><div class="line">        <span class="keyword">$this</span>-&gt;toSql(), <span class="keyword">$this</span>-&gt;getBindings(), ! <span class="keyword">$this</span>-&gt;useWritePdo</div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toSql</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;grammar-&gt;compileSelect(<span class="keyword">$this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="compileFrom-函数"><a href="#compileFrom-函数" class="headerlink" title="compileFrom 函数"></a>compileFrom 函数</h3><p>首先我们先看看流程图：</p>
<p><img src="http://owql68l6p.bkt.clouddn.com/17-9-23/10116808.jpg" alt="Markdown"></p>
<p>语法编译器 <code>grammer</code> 对于 <code>from</code> 语句的处理由函数 <code>compileFrom</code> 负责：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileFrom</span><span class="params">(Builder $query, $table)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'from '</span>.<span class="keyword">$this</span>-&gt;wrapTable($table);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从流程图可以看出，具体流程与 <code>wrap</code> 类似。</p>
<p>我们调用 <code>from</code> 时，可以传递两种参数，一种是字符串，另一种是 <code>expression</code> 对象：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'table'</span>);</div><div class="line">DB::table(<span class="keyword">new</span> Expression(<span class="string">'table'</span>));</div></pre></td></tr></table></figure>
<ul>
<li>传递 <code>expression</code> 对象</li>
</ul>
<p>当我们传递 <code>expression</code> 对象的时候，<code>grammer</code> 就会调用 <code>getValue</code> 取出原生 <code>sql</code> 语句。</p>
<ul>
<li>传递字符串</li>
</ul>
<p>当我们向 <code>from</code> 传递普通的字符串时，<code>laravel</code> 就会对字符串调用 <code>wrap</code> 函数进行处理，处理流程上一个小节已经说明：</p>
<ul>
<li>为表名加上前缀 <code>$this-&gt;tablePrefix</code></li>
<li>若字符串存在 <code>as</code>，则为表名设置别名。</li>
<li>若字符串含有 <code>.</code>，则会被分解为 <code>库名</code> 与 <code>表名</code>，并进行分别调用 <code>wrapTable</code> 函数与 <code>wrapValue</code> 进行处理。</li>
<li>为表名前后添加 <code>&quot;</code>，例如 <code>t1.t2</code> 会被转化为 <code>&quot;t1&quot;.&quot;t2&quot;</code>（不同的数据库添加的字符不同，mysql 就不是 <code>&quot;</code>）</li>
</ul>
<p><code>laravel</code> 对 <code>from</code> 处理流程存在一些问题，表名前缀设置功能与数据库名功能公用存在问题，相关 <code>issue</code> 地址是：<a href="https://github.com/laravel/framework/issues/21305" target="_blank" rel="external">[Bug] Table prefix added to database name when using database.table</a>，有任何兴趣的同学可以在这个 <code>issue</code> 里面讨论，或者直接向作者提 <code>PR</code>。若作者对此部分有任何修改，我会同步修改这篇文章。</p>
<h2 id="Select-语句"><a href="#Select-语句" class="headerlink" title="Select 语句"></a>Select 语句</h2><p>本小节会介绍 <code>select</code> 语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span><span class="params">($columns = [<span class="string">'*'</span>])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;columns = is_array($columns) ? $columns : func_get_args();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>queryBuilder</code> 的 <code>select</code> 语句很简单，我们不多讨论.</p>
<p><code>selectRaw</code> ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">selectRaw</span><span class="params">($expression, array $bindings = [])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;addSelect(<span class="keyword">new</span> Expression($expression));</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($bindings) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;addBinding($bindings, <span class="string">'select'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addSelect</span><span class="params">($column)</span></span></div><div class="line">&#123;</div><div class="line">    $column = is_array($column) ? $column : func_get_args();</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;columns = array_merge((<span class="keyword">array</span>) <span class="keyword">$this</span>-&gt;columns, $column);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到， <code>selectRaw</code> 就是将 <code>Expression</code> 对象赋值到 <code>columns</code> 中，我们在前面说到，框架不会对 <code>Expression</code> 进行任何处理（更准确的说是 <code>wrap</code> 函数），这样就保证了原生语句的执行。</p>
<p>我们接着看 <code>grammer</code> .</p>
<h3 id="compileColumns-函数"><a href="#compileColumns-函数" class="headerlink" title="compileColumns 函数"></a>compileColumns 函数</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileColumns</span><span class="params">(Builder $query, $columns)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (! is_null($query-&gt;aggregate)) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $select = $query-&gt;distinct ? <span class="string">'select distinct '</span> : <span class="string">'select '</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $select.<span class="keyword">$this</span>-&gt;columnize($columns);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">columnize</span><span class="params">(array $columns)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> implode(<span class="string">', '</span>, array_map([<span class="keyword">$this</span>, <span class="string">'wrap'</span>], $columns));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，<code>grammer</code> 对 <code>select</code> 的语法编译调用 <code>wrap</code> 函数对每个 <code>select</code> 的字段进行处理，处理过程在上面详解过，在此不再赘述。</p>
<h2 id="selectSub-语句"><a href="#selectSub-语句" class="headerlink" title="selectSub 语句"></a>selectSub 语句</h2><p>所谓的 <code>select</code> 子查询，就是查询的字段来源于其他数据表。对于这种查询，可以分成两部来理解，首先忽略整个select子查询，查出第一个表中的数据，然后根据第一个表的数据执行子查询，</p>
<p><code>laravel</code> 的 <code>selectSub</code> 支持闭包函数、<code>queryBuild</code> 对象或者原生 <code>sql</code> 语句，以下是单元测试样例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$query = DB::table(<span class="string">'one'</span>)-&gt;select([<span class="string">'foo'</span>, <span class="string">'bar'</span>])-&gt;where(<span class="string">'key'</span>, <span class="string">'='</span>, <span class="string">'val'</span>);</div><div class="line"></div><div class="line">$query-&gt;selectSub(<span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">        $query-&gt;from(<span class="string">'two'</span>)-&gt;select(<span class="string">'baz'</span>)-&gt;where(<span class="string">'subkey'</span>, <span class="string">'='</span>, <span class="string">'subval'</span>);</div><div class="line">    &#125;, <span class="string">'sub'</span>);</div></pre></td></tr></table></figure>
<p>另一种写法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$query = DB::table(<span class="string">'one'</span>)-&gt;select([<span class="string">'foo'</span>, <span class="string">'bar'</span>])-&gt;where(<span class="string">'key'</span>, <span class="string">'='</span>, <span class="string">'val'</span>);</div><div class="line">$query_sub = DB::table(<span class="string">'one'</span>)-&gt;select(<span class="string">'baz'</span>)-&gt;where(<span class="string">'subkey'</span>, <span class="string">'='</span>, <span class="string">'subval'</span>);</div><div class="line"></div><div class="line">$query-&gt;selectSub($query_sub, <span class="string">'sub'</span>);</div></pre></td></tr></table></figure>
<p>生成的 <code>sql</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">select &quot;foo&quot;, &quot;bar&quot;, (select &quot;baz&quot; from &quot;two&quot; where &quot;subkey&quot; = &apos;subval&apos;) as &quot;sub&quot; from &quot;one&quot; where &quot;key&quot; = &apos;val&apos;</div><div class="line">```   </div><div class="line"></div><div class="line">`selectSub` 语句的实现比较简单：</div><div class="line"></div><div class="line">```php</div><div class="line">public function selectSub($query, $as)</div><div class="line">&#123;</div><div class="line">    if ($query instanceof Closure) &#123;</div><div class="line">        $callback = $query;</div><div class="line"></div><div class="line">        $callback($query = $this-&gt;forSubQuery());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    list($query, $bindings) = $this-&gt;parseSubSelect($query);</div><div class="line"></div><div class="line">    return $this-&gt;selectRaw(</div><div class="line">        &apos;(&apos;.$query.&apos;) as &apos;.$this-&gt;grammar-&gt;wrap($as), $bindings</div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line">protected function parseSubSelect($query)</div><div class="line">&#123;</div><div class="line">    if ($query instanceof self) &#123;</div><div class="line">        $query-&gt;columns = [$query-&gt;columns[0]];</div><div class="line"></div><div class="line">        return [$query-&gt;toSql(), $query-&gt;getBindings()];</div><div class="line">    &#125; elseif (is_string($query)) &#123;</div><div class="line">        return [$query, []];</div><div class="line">    &#125; else &#123;</div><div class="line">        throw new InvalidArgumentException;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，如果 <code>selectSub</code> 的参数是闭包函数，那么就会先执行闭包函数，闭包函数将会为 <code>query</code> 根据查询语句更新对象。</p>
<p><code>parseSubSelect</code> 函数为子查询解析 <code>sql</code> 语句与 <code>binding</code> 变量。</p>
<h2 id="where-语句总结"><a href="#where-语句总结" class="headerlink" title="where 语句总结"></a>where 语句总结</h2><p>在 <code>laravel</code> 文档中，<code>queryBuild</code> 的用法很详尽，但是为了更好的理解源码，我们在这里再次大概的总结一下：</p>
<h3 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">users = DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'votes'</span>, <span class="string">'='</span>, <span class="number">100</span>)-&gt;get();</div><div class="line">$users = DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'votes'</span>, <span class="number">100</span>)-&gt;get();</div></pre></td></tr></table></figure>
<p>这两个是等价的写法。</p>
<h3 id="where-数组"><a href="#where-数组" class="headerlink" title="where 数组"></a><code>where</code> 数组</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)-&gt;where(</div><div class="line">    [<span class="string">'status'</span> =&gt; <span class="number">1</span>, <span class="string">'subscribed'</span> =&gt; <span class="number">1</span>],</div><div class="line">)-&gt;get();</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)-&gt;where([</div><div class="line">    [<span class="string">'status'</span>, <span class="string">'1'</span>],</div><div class="line">    [<span class="string">'subscribed'</span>, <span class="string">'1'</span>],</div><div class="line">])-&gt;get();</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)-&gt;where([</div><div class="line">    [<span class="string">'status'</span>, <span class="string">'1'</span>],</div><div class="line">    [<span class="string">'subscribed'</span>, <span class="string">'&lt;&gt;'</span>, <span class="string">'1'</span>],</div><div class="line">])-&gt;get();</div></pre></td></tr></table></figure>
<h3 id="where-查询组"><a href="#where-查询组" class="headerlink" title="where 查询组"></a><code>where</code> 查询组</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)</div><div class="line">    -&gt;where(<span class="string">'name'</span>, <span class="string">'='</span>, <span class="string">'John'</span>)</div><div class="line">    -&gt;orWhere(<span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">        $query-&gt;where(<span class="string">'votes'</span>, <span class="string">'&gt;'</span>, <span class="number">100</span>)</div><div class="line">              -&gt;where(<span class="string">'title'</span>, <span class="string">'&lt;&gt;'</span>, <span class="string">'Admin'</span>);</div><div class="line">    &#125;)</div><div class="line">    -&gt;get();</div></pre></td></tr></table></figure>
<p>这一句的 <code>sql</code> 语句是 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select * from users where name = <span class="string">'John'</span> <span class="keyword">or</span> (votes &gt; <span class="number">100</span> <span class="keyword">and</span> title &lt;&gt; <span class="string">'Admin'</span>)</div></pre></td></tr></table></figure>
<h3 id="where-子查询"><a href="#where-子查询" class="headerlink" title="where 子查询"></a><code>where</code> 子查询</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testFullSubSelects</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    $builder = <span class="keyword">$this</span>-&gt;getBuilder();</div><div class="line">    DB::table(<span class="string">'users'</span>)</div><div class="line">        -&gt;Where(<span class="string">'id'</span>, <span class="string">'='</span>, <span class="function"><span class="keyword">function</span> <span class="params">($q)</span> </span>&#123;</div><div class="line">        $q-&gt;select(<span class="keyword">new</span> Raw(<span class="string">'max(id)'</span>))-&gt;from(<span class="string">'users'</span>)-&gt;where(<span class="string">'email'</span>, <span class="string">'='</span>, <span class="string">'bar'</span>);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这一句的 <code>sql</code> 语句是 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select * from <span class="string">"users"</span> where <span class="string">"email"</span> = foo <span class="keyword">or</span> <span class="string">"id"</span> = (select max(id) from <span class="string">"users"</span> where <span class="string">"email"</span> = bar`</div></pre></td></tr></table></figure>
<h3 id="orWhere"><a href="#orWhere" class="headerlink" title="orWhere"></a>orWhere</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;where(<span class="string">'votes'</span>, <span class="string">'&gt;'</span>, <span class="number">100</span>)</div><div class="line">            -&gt;orWhere(<span class="string">'name'</span>, <span class="string">'John'</span>)</div><div class="line">            -&gt;get();</div></pre></td></tr></table></figure>
<h3 id="whereDate-whereMonth-whereDay-whereYear-whereTime"><a href="#whereDate-whereMonth-whereDay-whereYear-whereTime" class="headerlink" title="whereDate / whereMonth / whereDay / whereYear / whereTime"></a>whereDate / whereMonth / whereDay / whereYear / whereTime</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">	        -&gt;whereDate(<span class="string">'created_at'</span>, <span class="string">'2016-12-31'</span>)</div><div class="line">	        -&gt;get();</div><div class="line">	        </div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereMonth(<span class="string">'created_at'</span>, <span class="string">'12'</span>)</div><div class="line">            -&gt;get();	        </div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereDay(<span class="string">'created_at'</span>, <span class="string">'31'</span>)</div><div class="line">            -&gt;get();</div><div class="line">            </div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereYear(<span class="string">'created_at'</span>, <span class="string">'2016'</span>)</div><div class="line">            -&gt;get();</div><div class="line">            </div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereTime(<span class="string">'created_at'</span>, <span class="string">'&gt;='</span>, <span class="string">'22:00'</span>)</div><div class="line">            -&gt;get();</div></pre></td></tr></table></figure>
<h3 id="whereBetween-whereNotBetween"><a href="#whereBetween-whereNotBetween" class="headerlink" title="whereBetween / whereNotBetween"></a>whereBetween / whereNotBetween</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereBetween(<span class="string">'votes'</span>, [<span class="number">1</span>, <span class="number">100</span>])-&gt;get();</div><div class="line">            </div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereNotBetween(<span class="string">'votes'</span>, [<span class="number">1</span>, <span class="number">100</span>])</div><div class="line">            -&gt;get();</div></pre></td></tr></table></figure>
<h3 id="whereRaw-orWhereRaw"><a href="#whereRaw-orWhereRaw" class="headerlink" title="whereRaw / orWhereRaw"></a>whereRaw / orWhereRaw</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereRaw(<span class="string">'id = ? or email = ?'</span>, [<span class="number">1</span>, <span class="string">'foo'</span>])</div><div class="line">            -&gt;get();</div><div class="line">            </div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;orWhereRaw(<span class="string">'id = ? or email = ?'</span>, [<span class="number">1</span>, <span class="string">'foo'</span>])</div><div class="line">            -&gt;get();</div></pre></td></tr></table></figure>
<h3 id="whereIn-whereNotIn-orWhereIn-orWhereNotIn"><a href="#whereIn-whereNotIn-orWhereIn-orWhereNotIn" class="headerlink" title="whereIn / whereNotIn / orWhereIn / orWhereNotIn"></a>whereIn / whereNotIn / orWhereIn / orWhereNotIn</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereIn(<span class="string">'id'</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</div><div class="line">            -&gt;get();</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereNotIn(<span class="string">'id'</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</div><div class="line">            -&gt;get();</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)            </div><div class="line">				-&gt;whereIn(<span class="string">'id'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($q)</span> </span>&#123;</div><div class="line">        			$q-&gt;select(<span class="string">'id'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;where(<span class="string">'age'</span>, <span class="string">'&gt;'</span>, <span class="number">25</span>)-&gt;take(<span class="number">3</span>);</div><div class="line">    			&#125;);       </div><div class="line">    			</div><div class="line">$users = DB::table(<span class="string">'users'</span>)            </div><div class="line">				-&gt;whereNotIn(<span class="string">'id'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($q)</span> </span>&#123;</div><div class="line">        			$q-&gt;select(<span class="string">'id'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;where(<span class="string">'age'</span>, <span class="string">'&gt;'</span>, <span class="number">25</span>)-&gt;take(<span class="number">3</span>);</div><div class="line">    			&#125;);  </div><div class="line">    			</div><div class="line">$query = DB::table(<span class="string">'users'</span>)-&gt;select(<span class="string">'id'</span>)-&gt;where(<span class="string">'age'</span>, <span class="string">'&gt;'</span>, <span class="number">25</span>)-&gt;take(<span class="number">3</span>);</div><div class="line">$users = DB::table(<span class="string">'users'</span>)-&gt;whereIn(<span class="string">'id'</span>, $query);   </div><div class="line">$users = DB::table(<span class="string">'users'</span>)-&gt;whereNotIn(<span class="string">'id'</span>, $query);</div></pre></td></tr></table></figure>
<p>有意思的是，当我们在 <code>whereIn / whereNotIn / orWhereIn / orWhereNotIn</code> 中传入空数组的时候：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereIn(<span class="string">'id'</span>, [])</div><div class="line">            -&gt;get();</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;orWhereIn(<span class="string">'id'</span>, [])</div><div class="line">            -&gt;get();</div></pre></td></tr></table></figure>
<p>这个时候，框架自动会生成如下的 <code>sql</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">select * from <span class="string">"users"</span> where <span class="number">0</span> = <span class="number">1</span>;</div><div class="line"></div><div class="line">select * from <span class="string">"users"</span> where <span class="string">"id"</span> = ? <span class="keyword">or</span> <span class="number">0</span> = <span class="number">1</span></div></pre></td></tr></table></figure>
<h3 id="whereColumn"><a href="#whereColumn" class="headerlink" title="whereColumn"></a>whereColumn</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereColumn(<span class="string">'first_name'</span>, <span class="string">'last_name'</span>)</div><div class="line">            -&gt;get();</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereColumn(<span class="string">'updated_at'</span>, <span class="string">'&gt;'</span>, <span class="string">'created_at'</span>)</div><div class="line">            -&gt;get();</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereColumn([</div><div class="line">                [<span class="string">'first_name'</span>, <span class="string">'='</span>, <span class="string">'last_name'</span>],</div><div class="line">                [<span class="string">'updated_at'</span>, <span class="string">'&gt;'</span>, <span class="string">'created_at'</span>]</div><div class="line">            ])-&gt;get();</div></pre></td></tr></table></figure>
<h3 id="whereNull-whereNotNull-orWhereNull-orWhereNotNull"><a href="#whereNull-whereNotNull-orWhereNull-orWhereNotNull" class="headerlink" title="whereNull / whereNotNull / orWhereNull / orWhereNotNull"></a>whereNull / whereNotNull / orWhereNull / orWhereNotNull</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereNull(<span class="string">'updated_at'</span>)</div><div class="line">            -&gt;get();</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereNotNull(<span class="string">'updated_at'</span>)</div><div class="line">            -&gt;get();</div><div class="line">            </div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;orWhereNull(<span class="string">'updated_at'</span>)</div><div class="line">            -&gt;get();</div><div class="line">            </div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;orWhereNotNull(<span class="string">'updated_at'</span>)</div><div class="line">            -&gt;get();</div></pre></td></tr></table></figure>
<h3 id="whereExists-whereNotExists-orWhereExists-orWhereNotExists"><a href="#whereExists-whereNotExists-orWhereExists-orWhereNotExists" class="headerlink" title="whereExists / whereNotExists / orWhereExists / orWhereNotExists"></a>whereExists / whereNotExists / orWhereExists / orWhereNotExists</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)</div><div class="line">    -&gt;whereExists(<span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">        $query-&gt;select(DB::raw(<span class="number">1</span>))</div><div class="line">              -&gt;from(<span class="string">'orders'</span>)</div><div class="line">              -&gt;whereRaw(<span class="string">'orders.user_id = users.id'</span>);</div><div class="line">    &#125;)</div><div class="line">    -&gt;get(); </div><div class="line"><span class="comment">// select * from users where exists ( select 1 from orders where orders.user_id = users.id)</span></div><div class="line"></div><div class="line">DB::table(<span class="string">'users'</span>)</div><div class="line">    -&gt;whereNotExists(<span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">        $query-&gt;select(DB::raw(<span class="number">1</span>))</div><div class="line">              -&gt;from(<span class="string">'orders'</span>)</div><div class="line">              -&gt;whereRaw(<span class="string">'orders.user_id = users.id'</span>);</div><div class="line">    &#125;)</div><div class="line">    -&gt;get();</div><div class="line"><span class="comment">// select * from users where not exists ( select 1 from orders where orders.user_id = users.id)</span></div><div class="line">    </div><div class="line">DB::table(<span class="string">'users'</span>)</div><div class="line">    -&gt;orWhereExists(<span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">        $query-&gt;select(DB::raw(<span class="number">1</span>))</div><div class="line">              -&gt;from(<span class="string">'orders'</span>)</div><div class="line">              -&gt;whereRaw(<span class="string">'orders.user_id = users.id'</span>);</div><div class="line">    &#125;)</div><div class="line">    -&gt;get();</div><div class="line"><span class="comment">// select * from users or exists ( select 1 from orders where orders.user_id = users.id)</span></div><div class="line">    </div><div class="line">DB::table(<span class="string">'users'</span>)</div><div class="line">    -&gt;orWhereNotExists(<span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">        $query-&gt;select(DB::raw(<span class="number">1</span>))</div><div class="line">              -&gt;from(<span class="string">'orders'</span>)</div><div class="line">              -&gt;whereRaw(<span class="string">'orders.user_id = users.id'</span>);</div><div class="line">    &#125;)</div><div class="line">    -&gt;get();  </div><div class="line"><span class="comment">// select * from users or not exists ( select 1 from orders where orders.user_id = users.id)</span></div></pre></td></tr></table></figure>
<h2 id="where-函数"><a href="#where-函数" class="headerlink" title="where 函数"></a>where 函数</h2><p>我们首先先看看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">where</span><span class="params">($column, $operator = null, $value = null, $boolean = <span class="string">'and'</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (is_array($column)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;addArrayOfWheres($column, $boolean);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">list</span>($value, $operator) = <span class="keyword">$this</span>-&gt;prepareValueAndOperator(</div><div class="line">        $value, $operator, func_num_args() == <span class="number">2</span></div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($column <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;whereNested($column, $boolean);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;invalidOperator($operator)) &#123;</div><div class="line">        <span class="keyword">list</span>($value, $operator) = [$operator, <span class="string">'='</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($value <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;whereSub($column, $operator, $value, $boolean);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (is_null($value)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;whereNull($column, $boolean, $operator !== <span class="string">'='</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (Str::contains($column, <span class="string">'-&gt;'</span>) &amp;&amp; is_bool($value)) &#123;</div><div class="line">        $value = <span class="keyword">new</span> Expression($value ? <span class="string">'true'</span> : <span class="string">'false'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $type = <span class="string">'Basic'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(</div><div class="line">        <span class="string">'type'</span>, <span class="string">'column'</span>, <span class="string">'operator'</span>, <span class="string">'value'</span>, <span class="string">'boolean'</span></div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! $value <span class="keyword">instanceof</span> Expression) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;addBinding($value, <span class="string">'where'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，为了支持框架的多种 <code>where</code> 形式，<code>where</code> 的代码中写了很多的条件语句。我们接下来一个个分析。</p>
<h3 id="grammer——compileWheres-函数"><a href="#grammer——compileWheres-函数" class="headerlink" title="grammer——compileWheres 函数"></a>grammer——compileWheres 函数</h3><p>在此之前，我们先看看语法编译器对 <code>where</code> 查询的处理：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileWheres</span><span class="params">(Builder $query)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (is_null($query-&gt;wheres)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">''</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (count($sql = <span class="keyword">$this</span>-&gt;compileWheresToArray($query)) &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;concatenateWhereClauses($query, $sql);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">''</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>compileWheres</code> 函数负责所有 <code>where</code> 查询条件的语法编译工作，<code>compileWheresToArray</code> 函数负责循环编译查询条件，<code>concatenateWhereClauses</code> 函数负责将多个查询条件合并。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileWheresToArray</span><span class="params">($query)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> collect($query-&gt;wheres)-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($where)</span> <span class="title">use</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $where[<span class="string">'boolean'</span>].<span class="string">' '</span>.<span class="keyword">$this</span>-&gt;&#123;<span class="string">"where&#123;$where['type']&#125;"</span>&#125;($query, $where);</div><div class="line">    &#125;)-&gt;all();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">concatenateWhereClauses</span><span class="params">($query, $sql)</span></span></div><div class="line">&#123;</div><div class="line">    $conjunction = $query <span class="keyword">instanceof</span> JoinClause ? <span class="string">'on'</span> : <span class="string">'where'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $conjunction.<span class="string">' '</span>.<span class="keyword">$this</span>-&gt;removeLeadingBoolean(implode(<span class="string">' '</span>, $sql));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>compileWheresToArray</code> 函数负责把 <code>$query-&gt;wheres</code> 中多个 <code>where</code> 条件循环起来：</p>
<ul>
<li><code>$where[&#39;boolean&#39;]</code> 是多个查询条件的连接，<code>and</code> 或者 <code>or</code>，一般 <code>where</code> 条件默认为 <code>and</code>,各种 <code>orWhere</code> 的连接是 <code>or</code></li>
<li><code>where{$where[&#39;type&#39;]}</code> 是查询的类型，<code>laravel</code> 把查询条件分为以下几类：<code>base</code>、<code>raw</code>、<code>in</code>、<code>notIn</code>、<code>inSub</code>、<code>notInSub</code>、<code>null</code>、<code>notNull</code>、<code>between</code>、<code>column</code>、<code>nested</code>、<code>sub</code>、<code>exist</code>、<code>notExist</code>。每种类型的查询条件都有对应的 <code>grammer</code> 方法</li>
</ul>
<p><code>concatenateWhereClauses</code> 函数负责连接所有的搜索条件，由于 <code>join</code> 的连接条件也会调用 <code>compileWheres</code> 函数，所以会有判断是否是真正的 <code>where</code> 查询，</p>
<h3 id="where-数组-1"><a href="#where-数组-1" class="headerlink" title="where 数组"></a>where 数组</h3><p>如果 <code>column</code> 是数组的话，就会调用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addArrayOfWheres</span><span class="params">($column, $boolean, $method = <span class="string">'where'</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;whereNested(<span class="function"><span class="keyword">function</span> <span class="params">($query)</span> <span class="title">use</span> <span class="params">($column, $method, $boolean)</span> </span>&#123;</div><div class="line">        <span class="keyword">foreach</span> ($column <span class="keyword">as</span> $key =&gt; $value) &#123;</div><div class="line">            <span class="keyword">if</span> (is_numeric($key) &amp;&amp; is_array($value)) &#123;</div><div class="line">                $query-&gt;&#123;$method&#125;(...array_values($value));</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                $query-&gt;$method($key, <span class="string">'='</span>, $value, $boolean);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;, $boolean);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，数组分为两类，一种是列名为 <code>key</code>，例如 <code>[&#39;foo&#39; =&gt; 1, &#39;bar&#39; =&gt; 2]</code>，这个时候就是调用 <code>query-&gt;where(&#39;foo&#39;, &#39;=&#39;, &#39;1&#39;, ‘and’)</code>。还有一种是 <code>[[&#39;foo&#39;,&#39;1&#39;],[&#39;bar&#39;,&#39;2&#39;]]</code>，这个时候就会调用 <code>$query-&gt;where([&#39;foo&#39;,&#39;1&#39;])</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">whereNested</span><span class="params">(Closure $callback, $boolean = <span class="string">'and'</span>)</span></span></div><div class="line">&#123;</div><div class="line">    call_user_func($callback, $query = <span class="keyword">$this</span>-&gt;forNestedWhere());</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;addNestedWhereQuery($query, $boolean);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addNestedWhereQuery</span><span class="params">($query, $boolean = <span class="string">'and'</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (count($query-&gt;wheres)) &#123;</div><div class="line">        $type = <span class="string">'Nested'</span>;</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;wheres[] = compact(<span class="string">'type'</span>, <span class="string">'query'</span>, <span class="string">'boolean'</span>);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;addBinding($query-&gt;getBindings(), <span class="string">'where'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="grammer——whereNested"><a href="#grammer——whereNested" class="headerlink" title="grammer——whereNested"></a>grammer——whereNested</h4><p>语法编译器中负责查询组的函数是 <code>whereNested</code>，它会取出 <code>where</code> 中的 <code>query</code>，递归调用 <code>compileWheres</code> 函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereNested</span><span class="params">(Builder $query, $where)</span></span></div><div class="line">&#123;</div><div class="line">    $offset = $query <span class="keyword">instanceof</span> JoinClause ? <span class="number">3</span> : <span class="number">6</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">'('</span>.substr(<span class="keyword">$this</span>-&gt;compileWheres($where[<span class="string">'query'</span>]), $offset).<span class="string">')'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于 <code>compileWheres</code> 会返回 <code>where ...</code> 或者 <code>on ...</code> 等开头的 <code>sql</code> 语句，所以我们需要把返回结果截取前3个字符或6个字符。</p>
<h3 id="where-查询组-1"><a href="#where-查询组-1" class="headerlink" title="where 查询组"></a>where 查询组</h3><p>若查询条件是一个闭包函数，也就是第一个参数 <code>column</code> 是个闭包函数，那么就要调用 <code>whereNested</code> 函数，过程和上述过程一致。</p>
<h3 id="whereSub-子查询"><a href="#whereSub-子查询" class="headerlink" title="whereSub 子查询"></a>whereSub 子查询</h3><p>如果第二个参数或者第三个参数是一个闭包函数的话，就是 <code>where</code> 子查询语句，这时需要调用 <code>whereSub</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereSub</span><span class="params">($column, $operator, Closure $callback, $boolean)</span></span></div><div class="line">&#123;</div><div class="line">    $type = <span class="string">'Sub'</span>;</div><div class="line"></div><div class="line">    call_user_func($callback, $query = <span class="keyword">$this</span>-&gt;forSubQuery());</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(</div><div class="line">        <span class="string">'type'</span>, <span class="string">'column'</span>, <span class="string">'operator'</span>, <span class="string">'query'</span>, <span class="string">'boolean'</span></div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;addBinding($query-&gt;getBindings(), <span class="string">'where'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="grammer——whereSub"><a href="#grammer——whereSub" class="headerlink" title="grammer——whereSub"></a>grammer——whereSub</h4><p><code>grammer</code> 中负责子查询的是 <code>whereSub</code> 函数： </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereSub</span><span class="params">(Builder $query, $where)</span></span></div><div class="line">&#123;</div><div class="line">    $select = <span class="keyword">$this</span>-&gt;compileSelect($where[<span class="string">'query'</span>]);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'column'</span>]).<span class="string">' '</span>.$where[<span class="string">'operator'</span>].<span class="string">" ($select)"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为子查询中可以存在 <code>select</code> 、<code>where</code> 、<code>join</code> 等一切 <code>sql</code> 语句，所以递归的是 <code>compileSelect</code> 这个大的函数，而不是仅仅 <code>compileWheres</code>。</p>
<h3 id="whereNull-语句"><a href="#whereNull-语句" class="headerlink" title="whereNull 语句"></a>whereNull 语句</h3><p><code>whereNull</code> 函数也很简单：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">whereNull</span><span class="params">($column, $boolean = <span class="string">'and'</span>, $not = false)</span></span></div><div class="line">&#123;</div><div class="line">    $type = $not ? <span class="string">'NotNull'</span> : <span class="string">'Null'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(<span class="string">'type'</span>, <span class="string">'column'</span>, <span class="string">'boolean'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="grammer——whereNull-函数"><a href="#grammer——whereNull-函数" class="headerlink" title="grammer——whereNull 函数"></a>grammer——whereNull 函数</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereNull</span><span class="params">(Builder $query, $where)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'column'</span>]).<span class="string">' is null'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="whereBasic-语句"><a href="#whereBasic-语句" class="headerlink" title="whereBasic 语句"></a>whereBasic 语句</h3><p>如果上述情况都不符合，那么就是最基础的 <code>where</code> 语句，类型是 <code>basic</code>.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$type = <span class="string">'Basic'</span>;</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;wheres[] = compact(</div><div class="line">    <span class="string">'type'</span>, <span class="string">'column'</span>, <span class="string">'operator'</span>, <span class="string">'value'</span>, <span class="string">'boolean'</span></div><div class="line">);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (! $value <span class="keyword">instanceof</span> Expression) &#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;addBinding($value, <span class="string">'where'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="grammer——whereBasic-函数"><a href="#grammer——whereBasic-函数" class="headerlink" title="grammer——whereBasic 函数"></a>grammer——whereBasic 函数</h4><p><code>grammer</code> 中最基础的 <code>where</code> 语句由 <code>wherebasic</code> 函数负责：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereBasic</span><span class="params">(Builder $query, $where)</span></span></div><div class="line">&#123;</div><div class="line">    $value = <span class="keyword">$this</span>-&gt;parameter($where[<span class="string">'value'</span>]);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'column'</span>]).<span class="string">' '</span>.$where[<span class="string">'operator'</span>].<span class="string">' '</span>.$value;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parameter</span><span class="params">($value)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;isExpression($value) ? <span class="keyword">$this</span>-&gt;getValue($value) : <span class="string">'?'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>wherebasic</code> 函数对参数进行了替换，利用 <code>?</code> 来替换真正的值。</p>
<h2 id="orWhere-语句"><a href="#orWhere-语句" class="headerlink" title="orWhere 语句"></a>orWhere 语句</h2><p><code>orWhere</code> 函数只是在 <code>where</code> 函数的基础上固定了最后一个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">orWhere</span><span class="params">($column, $operator = null, $value = null)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;where($column, $operator, $value, <span class="string">'or'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="whereColumn-语句"><a href="#whereColumn-语句" class="headerlink" title="whereColumn 语句"></a>whereColumn 语句</h2><p><code>whereColumn</code> 函数是简化版的 <code>where</code> 函数，只是 <code>where</code> 类型不是 <code>basic</code>，而是 <code>column</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">whereColumn</span><span class="params">($first, $operator = null, $second = null, $boolean = <span class="string">'and'</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (is_array($first)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;addArrayOfWheres($first, $boolean, <span class="string">'whereColumn'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;invalidOperator($operator)) &#123;</div><div class="line">        <span class="keyword">list</span>($second, $operator) = [$operator, <span class="string">'='</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $type = <span class="string">'Column'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(</div><div class="line">        <span class="string">'type'</span>, <span class="string">'first'</span>, <span class="string">'operator'</span>, <span class="string">'second'</span>, <span class="string">'boolean'</span></div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="grammer——whereColumn"><a href="#grammer——whereColumn" class="headerlink" title="grammer——whereColumn"></a>grammer——whereColumn</h3><p>可以看到 <code>whereColumn</code> 与 <code>whereBasic</code> 的区别是对 <code>value</code> 的不同处理，<code>whereBasic</code> 实际上是将其看作值，需要用 <code>?</code> 来替换，参数加载到 <code>binding</code> 中去的。而 <code>whereColumn</code> 是将 <code>second</code> 当做列名来处理，是需要经过表名、别名等处理的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereColumn</span><span class="params">(Builder $query, $where)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'first'</span>]).<span class="string">' '</span>.$where[<span class="string">'operator'</span>].<span class="string">' '</span>.<span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'second'</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="whereIn-语句"><a href="#whereIn-语句" class="headerlink" title="whereIn 语句"></a>whereIn 语句</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">whereIn</span><span class="params">($column, $values, $boolean = <span class="string">'and'</span>, $not = false)</span></span></div><div class="line">&#123;</div><div class="line">    $type = $not ? <span class="string">'NotIn'</span> : <span class="string">'In'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($values <span class="keyword">instanceof</span> EloquentBuilder) &#123;</div><div class="line">        $values = $values-&gt;getQuery();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($values <span class="keyword">instanceof</span> <span class="keyword">self</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;whereInExistingQuery(</div><div class="line">            $column, $values, $boolean, $not</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($values <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;whereInSub($column, $values, $boolean, $not);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($values <span class="keyword">instanceof</span> Arrayable) &#123;</div><div class="line">        $values = $values-&gt;toArray();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(<span class="string">'type'</span>, <span class="string">'column'</span>, <span class="string">'values'</span>, <span class="string">'boolean'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> ($values <span class="keyword">as</span> $value) &#123;</div><div class="line">        <span class="keyword">if</span> (! $value <span class="keyword">instanceof</span> Expression) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;addBinding($value, <span class="string">'where'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出来，<code>whereIn</code> 支持四种参数: <code>EloquentBuilder</code>、<code>queryBuilder</code>、<code>Closure</code>、<code>Arrayable</code>。</p>
<h3 id="whereInExistingQuery-函数"><a href="#whereInExistingQuery-函数" class="headerlink" title="whereInExistingQuery 函数"></a>whereInExistingQuery 函数</h3><p>当 <code>whereIn</code> 第二个参数是 <code>queryBuild</code> 时，就会调用 <code>whereInExistingQuery</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereInExistingQuery</span><span class="params">($column, $query, $boolean, $not)</span></span></div><div class="line">&#123;</div><div class="line">    $type = $not ? <span class="string">'NotInSub'</span> : <span class="string">'InSub'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(<span class="string">'type'</span>, <span class="string">'column'</span>, <span class="string">'query'</span>, <span class="string">'boolean'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;addBinding($query-&gt;getBindings(), <span class="string">'where'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，这个函数添加了一个类型为 <code>InSub</code> 或 <code>NotInSub</code> 类型的 <code>where</code>，我们接着在语法编译器来看：</p>
<h4 id="grammer——whereInSub-whereNotInSub"><a href="#grammer——whereInSub-whereNotInSub" class="headerlink" title="grammer——whereInSub / whereNotInSub"></a>grammer——whereInSub / whereNotInSub</h4><p><code>whereInSub</code> / <code>whereNotInSub</code> 与 <code>whereSub</code> 类似，只是 <code>operator</code> 被固定成 <code>in</code> / <code>not in</code> 而已：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereInSub</span><span class="params">(Builder $query, $where)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'column'</span>]).<span class="string">' in ('</span>.<span class="keyword">$this</span>-&gt;compileSelect($where[<span class="string">'query'</span>]).<span class="string">')'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereNotInSub</span><span class="params">(Builder $query, $where)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'column'</span>]).<span class="string">' not in ('</span>.<span class="keyword">$this</span>-&gt;compileSelect($where[<span class="string">'query'</span>]).<span class="string">')'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="whereInSub-函数"><a href="#whereInSub-函数" class="headerlink" title="whereInSub 函数"></a>whereInSub 函数</h3><p>当 <code>whereIn</code> 第二个参数是闭包函数的时候，就会调用 <code>whereInSub</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereInSub</span><span class="params">($column, Closure $callback, $boolean, $not)</span></span></div><div class="line">&#123;</div><div class="line">    $type = $not ? <span class="string">'NotInSub'</span> : <span class="string">'InSub'</span>;</div><div class="line"></div><div class="line">    call_user_func($callback, $query = <span class="keyword">$this</span>-&gt;forSubQuery());</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(<span class="string">'type'</span>, <span class="string">'column'</span>, <span class="string">'query'</span>, <span class="string">'boolean'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;addBinding($query-&gt;getBindings(), <span class="string">'where'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出来，除了闭包函数需要执行获得 <code>query</code> 对象之外，<code>whereInSub</code> 函数与 <code>whereInExistingQuery</code> 函数一致。</p>
<h3 id="In-NotIn-类型-where"><a href="#In-NotIn-类型-where" class="headerlink" title="In / NotIn 类型 where"></a>In / NotIn 类型 where</h3><p>如果参数传递了数组，那么就会创建 <code>In</code> 或者 <code>NotIn</code> 类型的 <code>where</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;wheres[] = compact(<span class="string">'type'</span>, <span class="string">'column'</span>, <span class="string">'values'</span>, <span class="string">'boolean'</span>);</div><div class="line"></div><div class="line"><span class="keyword">foreach</span> ($values <span class="keyword">as</span> $value) &#123;</div><div class="line">    <span class="keyword">if</span> (! $value <span class="keyword">instanceof</span> Expression) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;addBinding($value, <span class="string">'where'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="grammer——whereIn-whereNotIn"><a href="#grammer——whereIn-whereNotIn" class="headerlink" title="grammer——whereIn / whereNotIn"></a>grammer——whereIn / whereNotIn</h4><p><code>whereIn</code> 或者 <code>whereNotIn</code> 与 <code>whereBasic</code> 函数基本一致，只是参数值需要循环调用 <code>parameter</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereIn</span><span class="params">(Builder $query, $where)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>($where[<span class="string">'values'</span>])) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'column'</span>]).<span class="string">' in ('</span>.<span class="keyword">$this</span>-&gt;parameterize($where[<span class="string">'values'</span>]).<span class="string">')'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">'0 = 1'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereNotIn</span><span class="params">(Builder $query, $where)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>($where[<span class="string">'values'</span>])) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'column'</span>]).<span class="string">' not in ('</span>.<span class="keyword">$this</span>-&gt;parameterize($where[<span class="string">'values'</span>]).<span class="string">')'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">'1 = 1'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parameterize</span><span class="params">(array $values)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> implode(<span class="string">', '</span>, array_map([<span class="keyword">$this</span>, <span class="string">'parameter'</span>], $values));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="whereBetween-语句"><a href="#whereBetween-语句" class="headerlink" title="whereBetween 语句"></a>whereBetween 语句</h2><p>类似的 <code>whereBetween</code> 创建了新的 <code>between</code> 类型的 <code>where</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">whereBetween</span><span class="params">($column, array $values, $boolean = <span class="string">'and'</span>, $not = false)</span></span></div><div class="line">&#123;</div><div class="line">    $type = <span class="string">'between'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(<span class="string">'column'</span>, <span class="string">'type'</span>, <span class="string">'boolean'</span>, <span class="string">'not'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;addBinding($values, <span class="string">'where'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="grammer——whereBetween"><a href="#grammer——whereBetween" class="headerlink" title="grammer——whereBetween"></a>grammer——whereBetween</h3><p>有意思的是，<code>whereBetween</code> 不支持原生的参数值，也就是不支持 <code>expression</code> 对象，所以直接用 <code>?</code> 来代替参数值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereBetween</span><span class="params">(Builder $query, $where)</span></span></div><div class="line">&#123;</div><div class="line">    $between = $where[<span class="string">'not'</span>] ? <span class="string">'not between'</span> : <span class="string">'between'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'column'</span>]).<span class="string">' '</span>.$between.<span class="string">' ? and ?'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="whereExist-语句"><a href="#whereExist-语句" class="headerlink" title="whereExist 语句"></a>whereExist 语句</h2><p><code>whereExist</code> 只支持闭包函数作为子查询语句，和之前一样，创建了 <code>Exist</code> 或者 <code>NotExist</code> 类型的 <code>where</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">whereExists</span><span class="params">(Closure $callback, $boolean = <span class="string">'and'</span>, $not = false)</span></span></div><div class="line">&#123;</div><div class="line">    $query = <span class="keyword">$this</span>-&gt;forSubQuery();</div><div class="line"></div><div class="line">    call_user_func($callback, $query);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;addWhereExistsQuery($query, $boolean, $not);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addWhereExistsQuery</span><span class="params">(Builder $query, $boolean = <span class="string">'and'</span>, $not = false)</span></span></div><div class="line">&#123;</div><div class="line">    $type = $not ? <span class="string">'NotExists'</span> : <span class="string">'Exists'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(<span class="string">'type'</span>, <span class="string">'operator'</span>, <span class="string">'query'</span>, <span class="string">'boolean'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;addBinding($query-&gt;getBindings(), <span class="string">'where'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="grammer——whereExists-whereNotExists"><a href="#grammer——whereExists-whereNotExists" class="headerlink" title="grammer——whereExists / whereNotExists"></a>grammer——whereExists / whereNotExists</h3><p>可以看到，这部分的语法编译器仍然和 <code>whereSub</code> 非常类似：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereExists</span><span class="params">(Builder $query, $where)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'exists ('</span>.<span class="keyword">$this</span>-&gt;compileSelect($where[<span class="string">'query'</span>]).<span class="string">')'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereNotExists</span><span class="params">(Builder $query, $where)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'not exists ('</span>.<span class="keyword">$this</span>-&gt;compileSelect($where[<span class="string">'query'</span>]).<span class="string">')'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="whereDate-whereMonth-whereDay-whereYear-whereTime-1"><a href="#whereDate-whereMonth-whereDay-whereYear-whereTime-1" class="headerlink" title="whereDate / whereMonth / whereDay / whereYear / whereTime"></a>whereDate / whereMonth / whereDay / whereYear / whereTime</h2><p>关于时间的查询条件都由函数 <code>addDateBasedWhere</code> 负责创建新的类型的 <code>where</code>，由于这些函数大致相同，我这里只贴一种：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addDateBasedWhere</span><span class="params">($type, $column, $operator, $value, $boolean = <span class="string">'and'</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(<span class="string">'column'</span>, <span class="string">'type'</span>, <span class="string">'boolean'</span>, <span class="string">'operator'</span>, <span class="string">'value'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;addBinding($value, <span class="string">'where'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">whereDate</span><span class="params">($column, $operator, $value = null, $boolean = <span class="string">'and'</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">list</span>($value, $operator) = <span class="keyword">$this</span>-&gt;prepareValueAndOperator(</div><div class="line">        $value, $operator, func_num_args() == <span class="number">2</span></div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;addDateBasedWhere(<span class="string">'Date'</span>, $column, $operator, $value, $boolean);</div><div class="line">&#125;</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure>
<h3 id="grammer——dateBasedWhere"><a href="#grammer——dateBasedWhere" class="headerlink" title="grammer——dateBasedWhere"></a>grammer——dateBasedWhere</h3><p>时间查询条件都是利用数据库的 <code>date</code>、<code>month</code>、<code>day</code>、<code>year</code>、<code>time</code> 函数实现的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereTime</span><span class="params">(Builder $query, $where)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dateBasedWhere(<span class="string">'time'</span>, $query, $where);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">dateBasedWhere</span><span class="params">($type, Builder $query, $where)</span></span></div><div class="line">&#123;</div><div class="line">    $value = <span class="keyword">$this</span>-&gt;parameter($where[<span class="string">'value'</span>]);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $type.<span class="string">'('</span>.<span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'column'</span>]).<span class="string">') '</span>.$where[<span class="string">'operator'</span>].<span class="string">' '</span>.$value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="whereRaw-语句"><a href="#whereRaw-语句" class="headerlink" title="whereRaw 语句"></a>whereRaw 语句</h2><p>原生的 <code>sql</code> 语句及其简单：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">whereRaw</span><span class="params">($sql, $bindings = [], $boolean = <span class="string">'and'</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = [<span class="string">'type'</span> =&gt; <span class="string">'raw'</span>, <span class="string">'sql'</span> =&gt; $sql, <span class="string">'boolean'</span> =&gt; $boolean];</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;addBinding((<span class="keyword">array</span>) $bindings, <span class="string">'where'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>语法编译器工作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereRaw</span><span class="params">(Builder $query, $where)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> $where[<span class="string">'sql'</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/09/17/Laravel Database——数据库的 CRUD 操作/" rel="next" title="">
                <i class="fa fa-chevron-left"></i> 
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/10/01/Laravel Database——分页原理与源码分析/" rel="prev" title="">
                 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <div class="ds-share flat" data-thread-key="2017/09/25/Laravel Datebase——查询构造器与语法编译器源码分析(上)/"
     data-title=""
     data-content=""
     data-url="https://leoyang90.github.io/2017/09/25/Laravel Datebase——查询构造器与语法编译器源码分析(上)/">
  <div class="ds-share-inline">
    <ul  class="ds-share-icons-16">

      <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
      <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
      <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
      <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
      <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>

    </ul>
    <div class="ds-share-icons-more">
    </div>
  </div>
</div>
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2017/09/25/Laravel Datebase——查询构造器与语法编译器源码分析(上)/"
           data-title="" data-url="https://leoyang90.github.io/2017/09/25/Laravel Datebase——查询构造器与语法编译器源码分析(上)/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/master.jpg"
               alt="Leo Yang" />
          <p class="site-author-name" itemprop="name">Leo Yang</p>
           
              <p class="site-description motion-element" itemprop="description">Life and Learn!</p>
          
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/LeoYang90" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/liang-de-tai-yang" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Laravel-Datebase——查询构造器与语法编译器源码分析-上"><span class="nav-number">1.</span> <span class="nav-text">Laravel Datebase——查询构造器与语法编译器源码分析(上)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DB-table-与-查询构造器"><span class="nav-number">1.2.</span> <span class="nav-text">DB::table 与 查询构造器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CRUD-与语法编译器"><span class="nav-number">1.3.</span> <span class="nav-text">CRUD 与语法编译器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#wrap-函数"><span class="nav-number">1.3.1.</span> <span class="nav-text">wrap 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#wrapAliasedValue-函数"><span class="nav-number">1.3.2.</span> <span class="nav-text">wrapAliasedValue 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#wrapValue-函数"><span class="nav-number">1.3.3.</span> <span class="nav-text">wrapValue 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#wrapSegments-函数"><span class="nav-number">1.3.4.</span> <span class="nav-text">wrapSegments 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#wrapTable-函数"><span class="nav-number">1.3.5.</span> <span class="nav-text">wrapTable 函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#from-语句"><span class="nav-number">1.4.</span> <span class="nav-text">from 语句</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#compileFrom-函数"><span class="nav-number">1.4.1.</span> <span class="nav-text">compileFrom 函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Select-语句"><span class="nav-number">1.5.</span> <span class="nav-text">Select 语句</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#compileColumns-函数"><span class="nav-number">1.5.1.</span> <span class="nav-text">compileColumns 函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#selectSub-语句"><span class="nav-number">1.6.</span> <span class="nav-text">selectSub 语句</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#where-语句总结"><span class="nav-number">1.7.</span> <span class="nav-text">where 语句总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基础用法"><span class="nav-number">1.7.1.</span> <span class="nav-text">基础用法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#where-数组"><span class="nav-number">1.7.2.</span> <span class="nav-text">where 数组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#where-查询组"><span class="nav-number">1.7.3.</span> <span class="nav-text">where 查询组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#where-子查询"><span class="nav-number">1.7.4.</span> <span class="nav-text">where 子查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#orWhere"><span class="nav-number">1.7.5.</span> <span class="nav-text">orWhere</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#whereDate-whereMonth-whereDay-whereYear-whereTime"><span class="nav-number">1.7.6.</span> <span class="nav-text">whereDate / whereMonth / whereDay / whereYear / whereTime</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#whereBetween-whereNotBetween"><span class="nav-number">1.7.7.</span> <span class="nav-text">whereBetween / whereNotBetween</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#whereRaw-orWhereRaw"><span class="nav-number">1.7.8.</span> <span class="nav-text">whereRaw / orWhereRaw</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#whereIn-whereNotIn-orWhereIn-orWhereNotIn"><span class="nav-number">1.7.9.</span> <span class="nav-text">whereIn / whereNotIn / orWhereIn / orWhereNotIn</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#whereColumn"><span class="nav-number">1.7.10.</span> <span class="nav-text">whereColumn</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#whereNull-whereNotNull-orWhereNull-orWhereNotNull"><span class="nav-number">1.7.11.</span> <span class="nav-text">whereNull / whereNotNull / orWhereNull / orWhereNotNull</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#whereExists-whereNotExists-orWhereExists-orWhereNotExists"><span class="nav-number">1.7.12.</span> <span class="nav-text">whereExists / whereNotExists / orWhereExists / orWhereNotExists</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#where-函数"><span class="nav-number">1.8.</span> <span class="nav-text">where 函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#grammer——compileWheres-函数"><span class="nav-number">1.8.1.</span> <span class="nav-text">grammer——compileWheres 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#where-数组-1"><span class="nav-number">1.8.2.</span> <span class="nav-text">where 数组</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#grammer——whereNested"><span class="nav-number">1.8.2.1.</span> <span class="nav-text">grammer——whereNested</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#where-查询组-1"><span class="nav-number">1.8.3.</span> <span class="nav-text">where 查询组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#whereSub-子查询"><span class="nav-number">1.8.4.</span> <span class="nav-text">whereSub 子查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#grammer——whereSub"><span class="nav-number">1.8.4.1.</span> <span class="nav-text">grammer——whereSub</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#whereNull-语句"><span class="nav-number">1.8.5.</span> <span class="nav-text">whereNull 语句</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#grammer——whereNull-函数"><span class="nav-number">1.8.5.1.</span> <span class="nav-text">grammer——whereNull 函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#whereBasic-语句"><span class="nav-number">1.8.6.</span> <span class="nav-text">whereBasic 语句</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#grammer——whereBasic-函数"><span class="nav-number">1.8.6.1.</span> <span class="nav-text">grammer——whereBasic 函数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#orWhere-语句"><span class="nav-number">1.9.</span> <span class="nav-text">orWhere 语句</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#whereColumn-语句"><span class="nav-number">1.10.</span> <span class="nav-text">whereColumn 语句</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#grammer——whereColumn"><span class="nav-number">1.10.1.</span> <span class="nav-text">grammer——whereColumn</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#whereIn-语句"><span class="nav-number">1.11.</span> <span class="nav-text">whereIn 语句</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#whereInExistingQuery-函数"><span class="nav-number">1.11.1.</span> <span class="nav-text">whereInExistingQuery 函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#grammer——whereInSub-whereNotInSub"><span class="nav-number">1.11.1.1.</span> <span class="nav-text">grammer——whereInSub / whereNotInSub</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#whereInSub-函数"><span class="nav-number">1.11.2.</span> <span class="nav-text">whereInSub 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#In-NotIn-类型-where"><span class="nav-number">1.11.3.</span> <span class="nav-text">In / NotIn 类型 where</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#grammer——whereIn-whereNotIn"><span class="nav-number">1.11.3.1.</span> <span class="nav-text">grammer——whereIn / whereNotIn</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#whereBetween-语句"><span class="nav-number">1.12.</span> <span class="nav-text">whereBetween 语句</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#grammer——whereBetween"><span class="nav-number">1.12.1.</span> <span class="nav-text">grammer——whereBetween</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#whereExist-语句"><span class="nav-number">1.13.</span> <span class="nav-text">whereExist 语句</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#grammer——whereExists-whereNotExists"><span class="nav-number">1.13.1.</span> <span class="nav-text">grammer——whereExists / whereNotExists</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#whereDate-whereMonth-whereDay-whereYear-whereTime-1"><span class="nav-number">1.14.</span> <span class="nav-text">whereDate / whereMonth / whereDay / whereYear / whereTime</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#grammer——dateBasedWhere"><span class="nav-number">1.14.1.</span> <span class="nav-text">grammer——dateBasedWhere</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#whereRaw-语句"><span class="nav-number">1.15.</span> <span class="nav-text">whereRaw 语句</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Leo Yang</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"leoyang90"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("ftMscWAwCsyt12PCu9jVqOrL-gzGzoHsz", "39fy4YEUohtU0wVi4r4MuKEI");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
