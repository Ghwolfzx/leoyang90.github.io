<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0" />






<meta name="description" content="Life and Learn!">
<meta property="og:type" content="website">
<meta property="og:title" content="LEOYANG&#39;S BLOG">
<meta property="og:url" content="https://leoyang90.github.io/index.html">
<meta property="og:site_name" content="LEOYANG&#39;S BLOG">
<meta property="og:description" content="Life and Learn!">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LEOYANG&#39;S BLOG">
<meta name="twitter:description" content="Life and Learn!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'LeoYang'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://leoyang90.github.io/"/>





  <title> LEOYANG'S BLOG </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c45898c39ba7512b69229aa34c07263a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">LEOYANG'S BLOG</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Notes and Blogs</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'qzqmBx1WzwFX9LPuU1Rc','2.0.0');
</script>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/10/09/Laravel Database——Eloquent Model 源码分析（下）/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/09/Laravel Database——Eloquent Model 源码分析（下）/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-09T23:50:57+08:00">
                2017-10-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/10/09/Laravel Database——Eloquent Model 源码分析（下）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/10/09/Laravel Database——Eloquent Model 源码分析（下）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/10/09/Laravel Database——Eloquent Model 源码分析（下）/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Laravel-Database——Eloquent-Model-源码分析（下）"><a href="#Laravel-Database——Eloquent-Model-源码分析（下）" class="headerlink" title="Laravel Database——Eloquent Model 源码分析（下）"></a>Laravel Database——Eloquent Model 源码分析（下）</h1><h2 id="获取模型"><a href="#获取模型" class="headerlink" title="获取模型"></a>获取模型</h2><h3 id="get-函数"><a href="#get-函数" class="headerlink" title="get 函数"></a>get 函数</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($columns = [<span class="string">'*'</span>])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $builder = <span class="keyword">$this</span>-&gt;applyScopes();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (count($models = $builder-&gt;getModels($columns)) &gt; <span class="number">0</span>) &#123;</div><div class="line">        $models = $builder-&gt;eagerLoadRelations($models);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $builder-&gt;getModel()-&gt;newCollection($models);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getModels</span><span class="params">($columns = [<span class="string">'*'</span>])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;model-&gt;hydrate(</div><div class="line">        <span class="keyword">$this</span>-&gt;query-&gt;get($columns)-&gt;all()</div><div class="line">    )-&gt;all();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>get</code> 函数会将 <code>QueryBuilder</code> 所获取的数据进一步包装 <code>hydrate</code>。<code>hydrate</code> 函数会将数据库取回来的数据打包成数据库模型对象 <code>Eloquent Model</code>，如果可以获取到数据，还会利用函数 <code>eagerLoadRelations</code> 来预加载关系模型。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hydrate</span><span class="params">(array $items)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $instance = <span class="keyword">$this</span>-&gt;newModelInstance();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $instance-&gt;newCollection(array_map(<span class="function"><span class="keyword">function</span> <span class="params">($item)</span> <span class="title">use</span> <span class="params">($instance)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $instance-&gt;newFromBuilder($item);</div><div class="line">    &#125;, $items));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>newModelInstance</code> 函数创建了一个新的数据库模型对象，重要的是这个函数为新的数据库模型对象赋予了 <code>connection</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">newModelInstance</span><span class="params">($attributes = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;model-&gt;newInstance($attributes)-&gt;setConnection(</div><div class="line">        <span class="keyword">$this</span>-&gt;query-&gt;getConnection()-&gt;getName()</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>newFromBuilder</code> 函数会将所有数据库数据存入另一个新的 <code>Eloquent Model</code> 的 <code>attributes</code> 中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">newFromBuilder</span><span class="params">($attributes = [], $connection = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $model = <span class="keyword">$this</span>-&gt;newInstance([], <span class="keyword">true</span>);</div><div class="line"></div><div class="line">    $model-&gt;setRawAttributes((<span class="keyword">array</span>) $attributes, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">    $model-&gt;setConnection($connection ?: <span class="keyword">$this</span>-&gt;getConnectionName());</div><div class="line"></div><div class="line">    $model-&gt;fireModelEvent(<span class="string">'retrieved'</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $model;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>newInstance 函数专用于创建新的数据库对象模型：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">newInstance</span><span class="params">($attributes = [], $exists = false)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $model = <span class="keyword">new</span> <span class="keyword">static</span>((<span class="keyword">array</span>) $attributes);</div><div class="line"></div><div class="line">    $model-&gt;exists = $exists;</div><div class="line"></div><div class="line">    $model-&gt;setConnection(</div><div class="line">        <span class="keyword">$this</span>-&gt;getConnectionName()</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $model;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>值得注意的是 <code>newInstance</code> 将 <code>exist</code> 设置为 <code>true</code>，意味着当前这个数据库模型对象是从数据库中获取而来，并非是手动新建的，这个 <code>exist</code> 为真，我们才能对这个数据库对象进行 <code>update</code>。</p>
<p><code>setRawAttributes</code> 函数为新的数据库对象赋予属性值，并且进行 <code>sync</code>，标志着对象的原始状态：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setRawAttributes</span><span class="params">(array $attributes, $sync = false)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;attributes = $attributes;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($sync) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;syncOriginal();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">syncOriginal</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;original = <span class="keyword">$this</span>-&gt;attributes;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个原始状态的记录十分重要，原因是 <code>save</code> 函数就是利用原始值 <code>original</code> 与属性值 <code>attributes</code> 的差异来决定更新的字段。</p>
<h3 id="find-函数"><a href="#find-函数" class="headerlink" title="find 函数"></a>find 函数</h3><p><code>find</code> 函数用于利用主键 <code>id</code> 来查询数据，<code>find</code> 函数也可以传入数组，查询多个数据</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">find</span><span class="params">($id, $columns = [<span class="string">'*'</span>])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (is_array($id) || $id <span class="keyword">instanceof</span> Arrayable) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;findMany($id, $columns);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;whereKey($id)-&gt;first($columns);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findMany</span><span class="params">($ids, $columns = [<span class="string">'*'</span>])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($ids)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;model-&gt;newCollection();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;whereKey($ids)-&gt;get($columns);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="findOrFail"><a href="#findOrFail" class="headerlink" title="findOrFail"></a>findOrFail</h3><p><code>laravel</code> 还提供 <code>findOrFail</code> 函数，一般用于 <code>controller</code>，在未找到记录的时候会抛出异常。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findOrFail</span><span class="params">($id, $columns = [<span class="string">'*'</span>])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $result = <span class="keyword">$this</span>-&gt;find($id, $columns);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (is_array($id)) &#123;</div><div class="line">        <span class="keyword">if</span> (count($result) == count(array_unique($id))) &#123;</div><div class="line">            <span class="keyword">return</span> $result;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">elseif</span> (! is_null($result)) &#123;</div><div class="line">        <span class="keyword">return</span> $result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> (<span class="keyword">new</span> ModelNotFoundException)-&gt;setModel(</div><div class="line">        get_class(<span class="keyword">$this</span>-&gt;model), $id</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="其他查询与数据获取方法"><a href="#其他查询与数据获取方法" class="headerlink" title="其他查询与数据获取方法"></a>其他查询与数据获取方法</h3><p>所用 <code>Query Builder</code> 支持的查询方法，例如 <code>select</code>、<code>selectSub</code>、<code>whereDate</code>、<code>whereBetween</code> 等等，都可以直接对 <code>Eloquent Model</code> 直接使用，程序会通过魔术方法调用 <code>Query Builder</code> 的相关方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $passthru = [</div><div class="line">    <span class="string">'insert'</span>, <span class="string">'insertGetId'</span>, <span class="string">'getBindings'</span>, <span class="string">'toSql'</span>,</div><div class="line">    <span class="string">'exists'</span>, <span class="string">'count'</span>, <span class="string">'min'</span>, <span class="string">'max'</span>, <span class="string">'avg'</span>, <span class="string">'sum'</span>, <span class="string">'getConnection'</span>,</div><div class="line">];</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $parameters)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    ...</div><div class="line"> </div><div class="line">    <span class="keyword">if</span> (in_array($method, <span class="keyword">$this</span>-&gt;passthru)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;toBase()-&gt;&#123;$method&#125;(...$parameters);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;query-&gt;&#123;$method&#125;(...$parameters);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>passthru</code> 中的各个函数在调用前需要加载查询作用域，原因是这些操作基本上是 <code>aggregate</code> 的，需要添加搜索条件才能更加符合预期：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toBase</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;applyScopes()-&gt;getQuery();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="添加和更新模型"><a href="#添加和更新模型" class="headerlink" title="添加和更新模型"></a>添加和更新模型</h2><h3 id="save-函数"><a href="#save-函数" class="headerlink" title="save 函数"></a>save 函数</h3><p>在 <code>Eloquent Model</code> 中，添加与更新模型可以统一用 <code>save</code> 函数。在添加模型的时候需要事先为 <code>model</code> 属性赋值，可以单个手动赋值，也可以批量赋值。在更新模型的时候，需要事先从数据库中取出模型，然后修改模型属性，最后执行 <code>save</code> 更新操作。官方文档：<a href="https://d.laravel-china.org/docs/5.5/eloquent#inserting-and-updating-models" target="_blank" rel="external">添加和更新模型</a> </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">(array $options = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $query = <span class="keyword">$this</span>-&gt;newQueryWithoutScopes();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;fireModelEvent(<span class="string">'saving'</span>) === <span class="keyword">false</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;exists) &#123;</div><div class="line">        $saved = <span class="keyword">$this</span>-&gt;isDirty() ?</div><div class="line">                    <span class="keyword">$this</span>-&gt;performUpdate($query) : <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        $saved = <span class="keyword">$this</span>-&gt;performInsert($query);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;getConnectionName() &amp;&amp;</div><div class="line">            $connection = $query-&gt;getConnection()) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;setConnection($connection-&gt;getName());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($saved) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;finishSave($options);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $saved;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>save</code> 函数不会加载全局作用域，原因是凡是利用 <code>save</code> 函数进行的插入或者更新的操作都不会存在 <code>where</code> 条件，仅仅利用自身的主键属性来进行更新。如果需要 <code>where</code> 条件可以使用 <code>query\builder</code> 的 <code>update</code> 函数，我们在下面会详细介绍：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">newQueryWithoutScopes</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $builder = <span class="keyword">$this</span>-&gt;newEloquentBuilder(<span class="keyword">$this</span>-&gt;newBaseQueryBuilder());</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $builder-&gt;setModel(<span class="keyword">$this</span>)</div><div class="line">                -&gt;with(<span class="keyword">$this</span>-&gt;with)</div><div class="line">                -&gt;withCount(<span class="keyword">$this</span>-&gt;withCount);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">newBaseQueryBuilder</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $connection = <span class="keyword">$this</span>-&gt;getConnection();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> QueryBuilder(</div><div class="line">        $connection, $connection-&gt;getQueryGrammar(), $connection-&gt;getPostProcessor()</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>newQueryWithoutScopes 函数创建新的没有任何其他条件的 <code>Eloquent\builder</code> 类，而 <code>Eloquent\builder</code> 类需要 <code>Query\builder</code> 类作为底层查询构造器。</p>
<h3 id="performUpdate-函数"><a href="#performUpdate-函数" class="headerlink" title="performUpdate 函数"></a>performUpdate 函数</h3><p>如果当前的数据库模型对象是从数据库中取出的，也就是直接或间接的调用 <code>get()</code> 函数从数据库中获取到的数据库对象，那么其 <code>exists</code> 必然是 <code>true</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isDirty</span><span class="params">($attributes = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasChanges(</div><div class="line">        <span class="keyword">$this</span>-&gt;getDirty(), is_array($attributes) ? $attributes : func_get_args()</div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDirty</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $dirty = [];</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;getAttributes() <span class="keyword">as</span> $key =&gt; $value) &#123;</div><div class="line">        <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;originalIsEquivalent($key, $value)) &#123;</div><div class="line">            $dirty[$key] = $value;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $dirty;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>getDirty</code> 函数可以获取所有与原始值不同的属性值，也就是需要更新的数据库字段。关键函数在于 <code>originalIsEquivalent</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">originalIsEquivalent</span><span class="params">($key, $current)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! array_key_exists($key, <span class="keyword">$this</span>-&gt;original)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $original = <span class="keyword">$this</span>-&gt;getOriginal($key);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($current === $original) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">elseif</span> (is_null($current)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">$this</span>-&gt;isDateAttribute($key)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fromDateTime($current) ===</div><div class="line">               <span class="keyword">$this</span>-&gt;fromDateTime($original);</div><div class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">$this</span>-&gt;hasCast($key)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;castAttribute($key, $current) ===</div><div class="line">               <span class="keyword">$this</span>-&gt;castAttribute($key, $original);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> is_numeric($current) &amp;&amp; is_numeric($original)</div><div class="line">            &amp;&amp; strcmp((string) $current, (string) $original) === <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，对于数据库可以转化的属性都要先进行转化，然后再开始对比。比较出的结果，就是我们需要 <code>update</code> 的字段。</p>
<p>执行更新的时候，除了 <code>getDirty</code> 函数获得的待更新字段，还会有 <code>UPDATED_AT</code> 这个字段：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">performUpdate</span><span class="params">(Builder $query)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;fireModelEvent(<span class="string">'updating'</span>) === <span class="keyword">false</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;usesTimestamps()) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;updateTimestamps();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $dirty = <span class="keyword">$this</span>-&gt;getDirty();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (count($dirty) &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;setKeysForSaveQuery($query)-&gt;update($dirty);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;fireModelEvent(<span class="string">'updated'</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;syncChanges();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">updateTimestamps</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $time = <span class="keyword">$this</span>-&gt;freshTimestamp();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! is_null(<span class="keyword">static</span>::UPDATED_AT) &amp;&amp; ! <span class="keyword">$this</span>-&gt;isDirty(<span class="keyword">static</span>::UPDATED_AT)) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;setUpdatedAt($time);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;exists &amp;&amp; ! <span class="keyword">$this</span>-&gt;isDirty(<span class="keyword">static</span>::CREATED_AT)) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;setCreatedAt($time);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>执行更新的时候，<code>where</code> 条件只有一个，那就是主键 <code>id</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setKeysForSaveQuery</span><span class="params">(Builder $query)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $query-&gt;where(<span class="keyword">$this</span>-&gt;getKeyName(), <span class="string">'='</span>, <span class="keyword">$this</span>-&gt;getKeyForSaveQuery());</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $query;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getKeyForSaveQuery</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;original[<span class="keyword">$this</span>-&gt;getKeyName()]</div><div class="line">                    ?? <span class="keyword">$this</span>-&gt;getKey();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getKey</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getAttribute(<span class="keyword">$this</span>-&gt;getKeyName());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后会调用 <code>EloquentBuilder</code> 的 <code>update</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(array $values)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;toBase()-&gt;update(<span class="keyword">$this</span>-&gt;addUpdatedAtColumn($values));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addUpdatedAtColumn</span><span class="params">(array $values)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;model-&gt;usesTimestamps()) &#123;</div><div class="line">        <span class="keyword">return</span> $values;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Arr::add(</div><div class="line">        $values, <span class="keyword">$this</span>-&gt;model-&gt;getUpdatedAtColumn(),</div><div class="line">        <span class="keyword">$this</span>-&gt;model-&gt;freshTimestampString()</div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">freshTimestampString</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fromDateTime(<span class="keyword">$this</span>-&gt;freshTimestamp());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fromDateTime</span><span class="params">($value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> is_null($value) ? $value : <span class="keyword">$this</span>-&gt;asDateTime($value)-&gt;format(</div><div class="line">        <span class="keyword">$this</span>-&gt;getDateFormat()</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="performInsert"><a href="#performInsert" class="headerlink" title="performInsert"></a>performInsert</h3><p>关于数据库对象的插入，如果数据库的主键被设置为 <code>increment</code>，也就是自增的话，程序会调用 <code>insertAndSetId</code>，这个时候不需要给数据库模型对象手动赋值主键 <code>id</code>。若果数据库的主键并不支持自增，那么就需要在插入前，为数据库对象的主键 <code>id</code> 赋值，否则数据库会报错。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">performInsert</span><span class="params">(Builder $query)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;fireModelEvent(<span class="string">'creating'</span>) === <span class="keyword">false</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;usesTimestamps()) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;updateTimestamps();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $attributes = <span class="keyword">$this</span>-&gt;attributes;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;getIncrementing()) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;insertAndSetId($query, $attributes);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($attributes)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $query-&gt;insert($attributes);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;exists = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;wasRecentlyCreated = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;fireModelEvent(<span class="string">'created'</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>laravel</code> 默认数据库的主键支持自增属性，程序调用的也是函数 <code>insertAndSetId</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">insertAndSetId</span><span class="params">(Builder $query, $attributes)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $id = $query-&gt;insertGetId($attributes, $keyName = <span class="keyword">$this</span>-&gt;getKeyName());</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;setAttribute($keyName, $id);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>插入后，会将插入后得到的主键 <code>id</code> 返回，并赋值到模型的属性当中。</p>
<p>如果数据库主键不支持自增，那么我们在数据库类中要设置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> $incrementing = <span class="keyword">false</span>;</div></pre></td></tr></table></figure>
<p>每次进行插入数据的时候，需要手动给主键赋值。</p>
<h3 id="update-函数"><a href="#update-函数" class="headerlink" title="update 函数"></a>update 函数</h3><p><code>save</code> 函数仅仅支持手动的属性赋值，无法批量赋值。<code>laravel</code> 的 <code>Eloquent Model</code> 还有一个函数: <code>update</code> 支持批量属性赋值。有意思的是，<code>Eloquent Builder</code> 也有函数 <code>update</code>，那个是上一小节提到的 <code>performUpdate</code> 所调用的函数。</p>
<p>两个 <code>update</code> 功能一致，只是 <code>Model</code> 的 <code>update</code> 函数比较适用于更新从数据库取回的数据库对象：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$flight = App\Flight::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$flight-&gt;update([<span class="string">'name'</span> =&gt; <span class="string">'New Flight Name'</span>,<span class="string">'desc'</span> =&gt; <span class="string">'test'</span>]);</div></pre></td></tr></table></figure>
<p>而 <code>Builder</code> 的 <code>update</code> 适用于多查询条件下的更新：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">App\Flight::where(<span class="string">'active'</span>, <span class="number">1</span>)</div><div class="line">          -&gt;where(<span class="string">'destination'</span>, <span class="string">'San Diego'</span>)</div><div class="line">          -&gt;update([<span class="string">'delayed'</span> =&gt; <span class="number">1</span>]);</div></pre></td></tr></table></figure>
<p>无论哪一种，都会自动更新 <code>updated_at</code> 字段。</p>
<p><code>Model</code> 的 <code>update</code> 函数借助 <code>fill</code> 函数与 <code>save</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(array $attributes = [], array $options = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;exists) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fill($attributes)-&gt;save($options);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="make-函数"><a href="#make-函数" class="headerlink" title="make 函数"></a>make 函数</h3><p>同样的，<code>save</code> 的插入也仅仅支持手动属性赋值，如果想实现批量属性赋值的插入可以使用 <code>make</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$model = App\Flight::make([<span class="string">'name'</span> =&gt; <span class="string">'New Flight Name'</span>,<span class="string">'desc'</span> =&gt; <span class="string">'test'</span>]);</div><div class="line"></div><div class="line">$model-&gt;save();</div></pre></td></tr></table></figure>
<p><code>make</code> 函数实际上仅仅是新建了一个 <code>Eloquent Model</code>，并批量赋予属性值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">(array $attributes = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;newModelInstance($attributes);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">newModelInstance</span><span class="params">($attributes = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;model-&gt;newInstance($attributes)-&gt;setConnection(</div><div class="line">        <span class="keyword">$this</span>-&gt;query-&gt;getConnection()-&gt;getName()</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="create-函数"><a href="#create-函数" class="headerlink" title="create 函数"></a>create 函数</h3><p>如果想要一步到位，批量赋值属性与插入一起操作，可以使用 <code>create</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">App\Flight::create([<span class="string">'name'</span> =&gt; <span class="string">'New Flight Name'</span>,<span class="string">'desc'</span> =&gt; <span class="string">'test'</span>]);</div></pre></td></tr></table></figure>
<p>相比较 <code>make</code> 函数，<code>create</code> 函数更进一步调用了 <code>save</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(array $attributes = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> tap(<span class="keyword">$this</span>-&gt;newModelInstance($attributes), <span class="function"><span class="keyword">function</span> <span class="params">($instance)</span> </span>&#123;</div><div class="line">        $instance-&gt;save();</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实际上，属性值是否可以批量赋值需要受 <code>fillable</code> 或 <code>guarded</code> 来控制，如果我们想要强制批量赋值可以使用 <code>forceCreate</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">forceCreate</span><span class="params">(array $attributes)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;model-&gt;unguarded(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($attributes)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;newModelInstance()-&gt;create($attributes);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="findOrNew-函数"><a href="#findOrNew-函数" class="headerlink" title="findOrNew 函数"></a>findOrNew 函数</h3><p><code>laravel</code> 提供一种主键查询或者新建数据库对象的函数：<code>findOrNew</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findOrNew</span><span class="params">($id, $columns = [<span class="string">'*'</span>])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! is_null($model = <span class="keyword">$this</span>-&gt;find($id, $columns))) &#123;</div><div class="line">        <span class="keyword">return</span> $model;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;newModelInstance();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>值得注意的是，当查询失败的时候，会返回一个全新的数据库对象，不含有任何 <code>attributes</code>。</p>
<h3 id="firstOrNew-函数"><a href="#firstOrNew-函数" class="headerlink" title="firstOrNew 函数"></a>firstOrNew 函数</h3><p><code>laravel</code> 提供一种自定义查询或者新建数据库对象的函数：<code>firstOrNew</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">firstOrNew</span><span class="params">(array $attributes, array $values = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! is_null($instance = <span class="keyword">$this</span>-&gt;where($attributes)-&gt;first())) &#123;</div><div class="line">        <span class="keyword">return</span> $instance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;newModelInstance($attributes + $values);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>值得注意的是，如果查询失败，会返回一个含有 <code>attributes</code> 和 <code>values</code> 两者合并的属性的数据库对象。</p>
<h3 id="firstOrCreate-函数"><a href="#firstOrCreate-函数" class="headerlink" title="firstOrCreate 函数"></a>firstOrCreate 函数</h3><p>类似于 <code>firstOrNew</code> 函数，<code>firstOrCreate</code> 函数也用于自定义查询或者新建数据库对象，不同的是，<code>firstOrCreate</code> 函数还进一步对数据进行了插入操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">firstOrCreate</span><span class="params">(array $attributes, array $values = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! is_null($instance = <span class="keyword">$this</span>-&gt;where($attributes)-&gt;first())) &#123;</div><div class="line">        <span class="keyword">return</span> $instance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> tap(<span class="keyword">$this</span>-&gt;newModelInstance($attributes + $values), <span class="function"><span class="keyword">function</span> <span class="params">($instance)</span> </span>&#123;</div><div class="line">        $instance-&gt;save();</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="updateOrCreate-函数"><a href="#updateOrCreate-函数" class="headerlink" title="updateOrCreate 函数"></a>updateOrCreate 函数</h3><p>在 <code>firstOrCreate</code> 函数基础上，除了对数据进行查询，还会对查询成功的数据利用 <code>value</code> 进行更新：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">updateOrCreate</span><span class="params">(array $attributes, array $values = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> tap(<span class="keyword">$this</span>-&gt;firstOrNew($attributes), <span class="function"><span class="keyword">function</span> <span class="params">($instance)</span> <span class="title">use</span> <span class="params">($values)</span> </span>&#123;</div><div class="line">        $instance-&gt;fill($values)-&gt;save();</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="firstOr-函数"><a href="#firstOr-函数" class="headerlink" title="firstOr 函数"></a>firstOr 函数</h3><p>如果想要自定义查找失败后的操作，可以使用 <code>firstOr</code> 函数，该函数可以传入闭包函数，处理找不到数据的情况：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">firstOr</span><span class="params">($columns = [<span class="string">'*'</span>], Closure $callback = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> ($columns <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">        $callback = $columns;</div><div class="line"></div><div class="line">        $columns = [<span class="string">'*'</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! is_null($model = <span class="keyword">$this</span>-&gt;first($columns))) &#123;</div><div class="line">        <span class="keyword">return</span> $model;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> call_user_func($callback);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="删除模型"><a href="#删除模型" class="headerlink" title="删除模型"></a>删除模型</h2><p>删除模型也会分为两种，一种是针对 <code>Eloquent Model</code> 的删除，这种删除必须是从数据库中取出的对象。还有一种是 <code>Eloquent Builder</code> 的删除，这种删除一般会带有多个查询条件。我们这一小节主要讲 <code>model</code> 的删除：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (is_null(<span class="keyword">$this</span>-&gt;getKeyName())) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'No primary key defined on model.'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;exists) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;fireModelEvent(<span class="string">'deleting'</span>) === <span class="keyword">false</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;touchOwners();</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;performDeleteOnModel();</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;fireModelEvent(<span class="string">'deleted'</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>删除模型时，模型对象必然要有主键。<code>performDeleteOnModel</code> 函数执行具体的删除操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">performDeleteOnModel</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;setKeysForSaveQuery(<span class="keyword">$this</span>-&gt;newQueryWithoutScopes())-&gt;delete();</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;exists = <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setKeysForSaveQuery</span><span class="params">(Builder $query)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $query-&gt;where(<span class="keyword">$this</span>-&gt;getKeyName(), <span class="string">'='</span>, <span class="keyword">$this</span>-&gt;getKeyForSaveQuery());</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $query;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以实际上，<code>Model</code> 调用的也是 <code>builder</code> 的 <code>delete</code> 函数。</p>
<h3 id="软删除"><a href="#软删除" class="headerlink" title="软删除"></a>软删除</h3><p>如果想要使用软删除，需要使用 <code>Illuminate\Database\Eloquent\SoftDeletes</code> 这个 trait。并且需要定义软删除字段，默认为 <code>deleted_at</code>，将软删除字段放入 <code>dates</code> 中，具体用法可参考官方文档:<a href="https://d.laravel-china.org/docs/5.5/eloquent#soft-deleting" target="_blank" rel="external">软删除</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">use</span> <span class="title">SoftDeletes</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 需要被转换成日期的属性。</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> $dates = [<span class="string">'deleted_at'</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们先看看这个 <code>trait</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">trait</span> SoftDeletes </div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">bootSoftDeletes</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">static</span>::addGlobalScope(<span class="keyword">new</span> SoftDeletingScope);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果使用了软删除，在 <code>model</code> 的启动过程中，就会启动软删除的这个函数。可以看出来，软删除是需要查询作用域来合作发挥作用的。我们看看这个 <code>SoftDeletingScope</code> :</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SoftDeletingScope</span> <span class="keyword">implements</span> <span class="title">Scope</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">protected</span> $extensions = [<span class="string">'Restore'</span>, <span class="string">'WithTrashed'</span>, <span class="string">'WithoutTrashed'</span>, <span class="string">'OnlyTrashed'</span>];</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">apply</span><span class="params">(Builder $builder, Model $model)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $builder-&gt;whereNull($model-&gt;getQualifiedDeletedAtColumn());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">extend</span><span class="params">(Builder $builder)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;extensions <span class="keyword">as</span> $extension) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;&#123;<span class="string">"add&#123;$extension&#125;"</span>&#125;($builder);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $builder-&gt;onDelete(<span class="function"><span class="keyword">function</span> <span class="params">(Builder $builder)</span> </span>&#123;</div><div class="line">            $column = <span class="keyword">$this</span>-&gt;getDeletedAtColumn($builder);</div><div class="line"></div><div class="line">            <span class="keyword">return</span> $builder-&gt;update([</div><div class="line">                $column =&gt; $builder-&gt;getModel()-&gt;freshTimestampString(),</div><div class="line">            ]);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>apply</code> 函数是加载全局域调用的函数，每次进行查询的时候，调用 <code>get</code> 函数就会自动加载这个函数，<code>whereNull</code> 这个查询条件会被加载到具体的 <code>where</code> 条件中。<code>deleted_at</code> 字段一般被设置为 <code>null</code>，在执行软删除的时候，该字段会被赋予时间格式的值，标志着被删除的时间。</p>
<p>在加载全局作用域的时候，还会调用 <code>extend</code> 函数，<code>extend</code> 函数为 <code>model</code> 添加了四个函数：</p>
<ul>
<li>WithTrashed</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addWithTrashed</span><span class="params">(Builder $builder)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $builder-&gt;macro(<span class="string">'withTrashed'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Builder $builder)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $builder-&gt;withoutGlobalScope(<span class="keyword">$this</span>);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>withTrashed</code> 函数取消了软删除的全局作用域，这样我们查询数据的时候就会查询到正常数据和被软删除的数据。</p>
<ul>
<li>withoutTrashed</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addWithoutTrashed</span><span class="params">(Builder $builder)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $builder-&gt;macro(<span class="string">'withoutTrashed'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Builder $builder)</span> </span>&#123;</div><div class="line">        $model = $builder-&gt;getModel();</div><div class="line"></div><div class="line">        $builder-&gt;withoutGlobalScope(<span class="keyword">$this</span>)-&gt;whereNull(</div><div class="line">            $model-&gt;getQualifiedDeletedAtColumn()</div><div class="line">        );</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $builder;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>withTrashed</code> 函数着重强调了不要获取软删除的数据。</p>
<ul>
<li>onlyTrashed</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addOnlyTrashed</span><span class="params">(Builder $builder)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $builder-&gt;macro(<span class="string">'onlyTrashed'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Builder $builder)</span> </span>&#123;</div><div class="line">        $model = $builder-&gt;getModel();</div><div class="line"></div><div class="line">        $builder-&gt;withoutGlobalScope(<span class="keyword">$this</span>)-&gt;whereNotNull(</div><div class="line">            $model-&gt;getQualifiedDeletedAtColumn()</div><div class="line">        );</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $builder;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果只想获取被软删除的数据，可以使用这个函数 <code>onlyTrashed</code>，可以看到，它使用了 <code>whereNotNull</code>。</p>
<ul>
<li>restore</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addRestore</span><span class="params">(Builder $builder)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $builder-&gt;macro(<span class="string">'restore'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Builder $builder)</span> </span>&#123;</div><div class="line">        $builder-&gt;withTrashed();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $builder-&gt;update([$builder-&gt;getModel()-&gt;getDeletedAtColumn() =&gt; <span class="keyword">null</span>]);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果想要恢复被删除的数据，还可以使用 <code>restore</code>，重新将 <code>deleted_at</code> 数据恢复为 null。</p>
<h3 id="performDeleteOnModel"><a href="#performDeleteOnModel" class="headerlink" title="performDeleteOnModel"></a>performDeleteOnModel</h3><p>SoftDeletes 这个 trait 会重载 <code>performDeleteOnModel</code> 函数，它将不会调用 <code>Eloquent Builder</code> 的 <code>delete</code> 方法，而是采用更新操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">performDeleteOnModel</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;forceDeleting) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;newQueryWithoutScopes()-&gt;where(<span class="keyword">$this</span>-&gt;getKeyName(), <span class="keyword">$this</span>-&gt;getKey())-&gt;forceDelete();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;runSoftDelete();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runSoftDelete</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $query = <span class="keyword">$this</span>-&gt;newQueryWithoutScopes()-&gt;where(<span class="keyword">$this</span>-&gt;getKeyName(), <span class="keyword">$this</span>-&gt;getKey());</div><div class="line"></div><div class="line">    $time = <span class="keyword">$this</span>-&gt;freshTimestamp();</div><div class="line"></div><div class="line">    $columns = [<span class="keyword">$this</span>-&gt;getDeletedAtColumn() =&gt; <span class="keyword">$this</span>-&gt;fromDateTime($time)];</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;getDeletedAtColumn()&#125; = $time;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;timestamps) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;getUpdatedAtColumn()&#125; = $time;</div><div class="line"></div><div class="line">        $columns[<span class="keyword">$this</span>-&gt;getUpdatedAtColumn()] = <span class="keyword">$this</span>-&gt;fromDateTime($time);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $query-&gt;update($columns);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>删除操作不仅更新了 <code>deleted_at</code>，还更新了 <code>updated_at</code> 字段。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/10/05/Laravel Database——Eloquent Model 源码分析(上)/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/05/Laravel Database——Eloquent Model 源码分析(上)/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-05T23:25:13+08:00">
                2017-10-05
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/10/05/Laravel Database——Eloquent Model 源码分析(上)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/10/05/Laravel Database——Eloquent Model 源码分析(上)/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/10/05/Laravel Database——Eloquent Model 源码分析(上)/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Laravel-Database——Eloquent-Model-源码分析（上）"><a href="#Laravel-Database——Eloquent-Model-源码分析（上）" class="headerlink" title="Laravel Database——Eloquent Model 源码分析（上）"></a>Laravel Database——Eloquent Model 源码分析（上）</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前面几个博客向大家介绍了查询构造器的原理与源码，然而查询构造器更多是为 <code>Eloquent Model</code> 服务的，我们对数据库操作更加方便的是使用 <code>Eloquent Model</code>。 本篇文章将会大家介绍 <code>Model</code> 的一些特性原理。</p>
<h2 id="Eloquent-Model-修改器"><a href="#Eloquent-Model-修改器" class="headerlink" title="Eloquent Model 修改器"></a>Eloquent Model 修改器</h2><p>当我们在 <code>Eloquent</code> 模型实例中设置某些属性值的时候，修改器允许对 <code>Eloquent</code> 属性值进行格式化。如果对修改器不熟悉，请参考官方文档：<a href="https://d.laravel-china.org/docs/5.5/eloquent-mutators" target="_blank" rel="external">Eloquent： 修改器</a></p>
<p>下面先看看修改器的原理：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetSet</span><span class="params">($offset, $value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;setAttribute($offset, $value);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setAttribute</span><span class="params">($key, $value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;hasSetMutator($key)) &#123;</div><div class="line">        $method = <span class="string">'set'</span>.Str::studly($key).<span class="string">'Attribute'</span>;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;&#123;$method&#125;($value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">elseif</span> ($value &amp;&amp; <span class="keyword">$this</span>-&gt;isDateAttribute($key)) &#123;</div><div class="line">        $value = <span class="keyword">$this</span>-&gt;fromDateTime($value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isJsonCastable($key) &amp;&amp; ! is_null($value)) &#123;</div><div class="line">        $value = <span class="keyword">$this</span>-&gt;castAttributeAsJson($key, $value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (Str::contains($key, <span class="string">'-&gt;'</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fillJsonAttribute($key, $value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;attributes[$key] = $value;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="自定义修改器"><a href="#自定义修改器" class="headerlink" title="自定义修改器"></a>自定义修改器</h3><p>当我们为 <code>model</code> 的成员变量赋值的时候，就会调用 <code>offsetSet</code> 函数，进而运行 <code>setAttribute</code> 函数，在这个函数中第一个检查的就是是否存在预处理函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasSetMutator</span><span class="params">($key)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> method_exists(<span class="keyword">$this</span>, <span class="string">'set'</span>.Str::studly($key).<span class="string">'Attribute'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果存在该函数，就会直接调用自定义修改器。</p>
<h3 id="日期转换器"><a href="#日期转换器" class="headerlink" title="日期转换器"></a>日期转换器</h3><p>接着如果没有自定义修改器的话，还会检查当前更新的成员变量是否是日期属性：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">isDateAttribute</span><span class="params">($key)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> in_array($key, <span class="keyword">$this</span>-&gt;getDates()) ||</div><div class="line">                                <span class="keyword">$this</span>-&gt;isDateCastable($key);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDates</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $defaults = [<span class="keyword">static</span>::CREATED_AT, <span class="keyword">static</span>::UPDATED_AT];</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;usesTimestamps()</div><div class="line">                ? array_unique(array_merge(<span class="keyword">$this</span>-&gt;dates, $defaults))</div><div class="line">                : <span class="keyword">$this</span>-&gt;dates;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">isDateCastable</span><span class="params">($key)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasCast($key, [<span class="string">'date'</span>, <span class="string">'datetime'</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>字段的时间属性有两种设置方法，一种是设置 <code>$dates</code> 属性：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $dates = [<span class="string">'date_attr'</span>];</div></pre></td></tr></table></figure>
<p>还有一种方法是设置 <code>cast</code> 数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $casts = [<span class="string">'date_attr'</span> =&gt; <span class="string">'date'</span>];</div></pre></td></tr></table></figure>
<p>只要是时间属性的字段，无论是什么类型的值，<code>laravel</code> 都会自动将其转化为数据库的时间格式。数据库的时间格式设置是 <code>dateFormat</code> 成员变量，不设置的时候，默认的时间格式为 `Y-m-d H:i:s’:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $dateFormat = [<span class="string">'U'</span>];</div><div class="line"></div><div class="line"><span class="keyword">protected</span> $dateFormat = [<span class="string">'Y-m-d H:i:s'</span>];</div></pre></td></tr></table></figure>
<p>当数据库对应的字段是时间类型时，为其赋值就可以非常灵活。我们可以赋值 <code>Carbon</code> 类型、<code>DateTime</code> 类型、数字类型、字符串等等：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fromDateTime</span><span class="params">($value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> is_null($value) ? $value : <span class="keyword">$this</span>-&gt;asDateTime($value)-&gt;format(</div><div class="line">        <span class="keyword">$this</span>-&gt;getDateFormat()</div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">asDateTime</span><span class="params">($value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> ($value <span class="keyword">instanceof</span> Carbon) &#123;</div><div class="line">        <span class="keyword">return</span> $value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($value <span class="keyword">instanceof</span> DateTimeInterface) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Carbon(</div><div class="line">            $value-&gt;format(<span class="string">'Y-m-d H:i:s.u'</span>), $value-&gt;getTimezone()</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (is_numeric($value)) &#123;</div><div class="line">        <span class="keyword">return</span> Carbon::createFromTimestamp($value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isStandardDateFormat($value)) &#123;</div><div class="line">        <span class="keyword">return</span> Carbon::createFromFormat(<span class="string">'Y-m-d'</span>, $value)-&gt;startOfDay();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Carbon::createFromFormat(</div><div class="line">        <span class="keyword">$this</span>-&gt;getDateFormat(), $value</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="json-转换器"><a href="#json-转换器" class="headerlink" title="json 转换器"></a>json 转换器</h3><p>接下来，如果该变量被设置为 <code>array</code>、<code>json</code> 等属性，那么其将会转化为 <code>json</code> 类型。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">isJsonCastable</span><span class="params">($key)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasCast($key, [<span class="string">'array'</span>, <span class="string">'json'</span>, <span class="string">'object'</span>, <span class="string">'collection'</span>]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">asJson</span><span class="params">($value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> json_encode($value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Eloquent-Model-访问器"><a href="#Eloquent-Model-访问器" class="headerlink" title="Eloquent Model 访问器"></a>Eloquent Model 访问器</h2><p>相比较修改器来说，访问器的适用情景会更加多。例如，我们经常把一些关于类型的字段设置为 <code>1</code>、<code>2</code>、<code>3</code> 等等，例如用户数据表中用户性别字段，<code>1</code> 代表男，<code>2</code> 代表女，很多时候我们取出这些值之后必然要经过转换，然后再显示出来。这时候就需要定义访问器。</p>
<p>访问器的源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttribute</span><span class="params">($key)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! $key) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (array_key_exists($key, <span class="keyword">$this</span>-&gt;attributes) ||</div><div class="line">        <span class="keyword">$this</span>-&gt;hasGetMutator($key)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getAttributeValue($key);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (method_exists(<span class="keyword">self</span>::class, $key)) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getRelationValue($key);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，当我们访问数据库对象的成员变量的时候，大致可以分为两类：属性值与关系对象。关系对象我们以后再详细来说，本文中先说关于属性的访问。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttributeValue</span><span class="params">($key)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $value = <span class="keyword">$this</span>-&gt;getAttributeFromArray($key);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;hasGetMutator($key)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;mutateAttribute($key, $value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;hasCast($key)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;castAttribute($key, $value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (in_array($key, <span class="keyword">$this</span>-&gt;getDates()) &amp;&amp;</div><div class="line">        ! is_null($value)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;asDateTime($value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与修改器类似，访问器也由三部分构成：自定义访问器、日期访问器、类型访问器。</p>
<h3 id="获取原始值"><a href="#获取原始值" class="headerlink" title="获取原始值"></a>获取原始值</h3><p>访问器的第一步就是从成员变量 <code>attributes</code> 中获取原始的字段值，一般指的是存在数据库的值。有的时候，我们要取的属性并不在 <code>attributes</code> 中，这时候就会返回 <code>null</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttributeFromArray</span><span class="params">($key)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;attributes[$key])) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;attributes[$key];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="自定义访问器"><a href="#自定义访问器" class="headerlink" title="自定义访问器"></a>自定义访问器</h3><p>如果定义了访问器，那么就会调用访问器，获取返回值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasGetMutator</span><span class="params">($key)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> method_exists(<span class="keyword">$this</span>, <span class="string">'get'</span>.Str::studly($key).<span class="string">'Attribute'</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">mutateAttribute</span><span class="params">($key, $value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;&#123;<span class="string">'get'</span>.Str::studly($key).<span class="string">'Attribute'</span>&#125;($value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h3><p>若我们在成员变量 <code>$casts</code> 数组中为属性定义了类型转换，那么就要进行类型转换：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasCast</span><span class="params">($key, $types = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (array_key_exists($key, <span class="keyword">$this</span>-&gt;getCasts())) &#123;</div><div class="line">        <span class="keyword">return</span> $types ? in_array(<span class="keyword">$this</span>-&gt;getCastType($key), (<span class="keyword">array</span>) $types, <span class="keyword">true</span>) : <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">castAttribute</span><span class="params">($key, $value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (is_null($value)) &#123;</div><div class="line">        <span class="keyword">return</span> $value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">switch</span> (<span class="keyword">$this</span>-&gt;getCastType($key)) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'int'</span>:</div><div class="line">        <span class="keyword">case</span> <span class="string">'integer'</span>:</div><div class="line">            <span class="keyword">return</span> (int) $value;</div><div class="line">        <span class="keyword">case</span> <span class="string">'real'</span>:</div><div class="line">        <span class="keyword">case</span> <span class="string">'float'</span>:</div><div class="line">        <span class="keyword">case</span> <span class="string">'double'</span>:</div><div class="line">            <span class="keyword">return</span> (float) $value;</div><div class="line">        <span class="keyword">case</span> <span class="string">'string'</span>:</div><div class="line">            <span class="keyword">return</span> (string) $value;</div><div class="line">        <span class="keyword">case</span> <span class="string">'bool'</span>:</div><div class="line">        <span class="keyword">case</span> <span class="string">'boolean'</span>:</div><div class="line">            <span class="keyword">return</span> (bool) $value;</div><div class="line">        <span class="keyword">case</span> <span class="string">'object'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fromJson($value, <span class="keyword">true</span>);</div><div class="line">        <span class="keyword">case</span> <span class="string">'array'</span>:</div><div class="line">        <span class="keyword">case</span> <span class="string">'json'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fromJson($value);</div><div class="line">        <span class="keyword">case</span> <span class="string">'collection'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> BaseCollection(<span class="keyword">$this</span>-&gt;fromJson($value));</div><div class="line">        <span class="keyword">case</span> <span class="string">'date'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;asDate($value);</div><div class="line">        <span class="keyword">case</span> <span class="string">'datetime'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;asDateTime($value);</div><div class="line">        <span class="keyword">case</span> <span class="string">'timestamp'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;asTimestamp($value);</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> $value;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="日期转换"><a href="#日期转换" class="headerlink" title="日期转换"></a>日期转换</h3><p>若当前属性是 <code>CREATED_AT</code>、<code>UPDATED_AT</code> 或者被存入成员变量 <code>dates</code> 中，那么就要进行日期转换。日期转换函数 <code>asDateTime</code> 可以查看上一节中的内容。</p>
<h2 id="Eloquent-Model-数组转化"><a href="#Eloquent-Model-数组转化" class="headerlink" title="Eloquent Model 数组转化"></a>Eloquent Model 数组转化</h2><p>在使用数据库对象中，我们经常使用 <code>toArray</code> 函数，它可以将从数据库中取出的所有属性和关系模型转化为数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> array_merge(<span class="keyword">$this</span>-&gt;attributesToArray(), <span class="keyword">$this</span>-&gt;relationsToArray());</div><div class="line">&#125;</div><div class="line">``` </div><div class="line"></div><div class="line">本文中只介绍属性转化为数组的部分：</div><div class="line"></div><div class="line">```php</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">attributesToArray</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $attributes = <span class="keyword">$this</span>-&gt;addDateAttributesToArray(</div><div class="line">        $attributes = <span class="keyword">$this</span>-&gt;getArrayableAttributes()</div><div class="line">    );</div><div class="line"></div><div class="line">    $attributes = <span class="keyword">$this</span>-&gt;addMutatedAttributesToArray(</div><div class="line">        $attributes, $mutatedAttributes = <span class="keyword">$this</span>-&gt;getMutatedAttributes()</div><div class="line">    );</div><div class="line">    </div><div class="line">    $attributes = <span class="keyword">$this</span>-&gt;addCastAttributesToArray(</div><div class="line">        $attributes, $mutatedAttributes</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;getArrayableAppends() <span class="keyword">as</span> $key) &#123;</div><div class="line">        $attributes[$key] = <span class="keyword">$this</span>-&gt;mutateAttributeForArray($key, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $attributes;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与访问器与修改器类似，需要转为数组的元素有日期类型、自定义访问器、类型转换，我们接下来一个个看：</p>
<h3 id="getArrayableAttributes-原始值获取"><a href="#getArrayableAttributes-原始值获取" class="headerlink" title="getArrayableAttributes 原始值获取"></a>getArrayableAttributes 原始值获取</h3><p>首先我们要从成员变量 <code>attributes</code> 数组中获取原始值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getArrayableAttributes</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getArrayableItems(<span class="keyword">$this</span>-&gt;attributes);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getArrayableItems</span><span class="params">(array $values)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (count(<span class="keyword">$this</span>-&gt;getVisible()) &gt; <span class="number">0</span>) &#123;</div><div class="line">        $values = array_intersect_key($values, array_flip(<span class="keyword">$this</span>-&gt;getVisible()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (count(<span class="keyword">$this</span>-&gt;getHidden()) &gt; <span class="number">0</span>) &#123;</div><div class="line">        $values = array_diff_key($values, array_flip(<span class="keyword">$this</span>-&gt;getHidden()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $values;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们还可以为数据库对象设置可见元素 <code>$visible</code> 与隐藏元素 <code>$hidden</code>，这两个变量会控制 <code>toArray</code> 可转化的元素属性。</p>
<h3 id="日期转换-1"><a href="#日期转换-1" class="headerlink" title="日期转换"></a>日期转换</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addDateAttributesToArray</span><span class="params">(array $attributes)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;getDates() <span class="keyword">as</span> $key) &#123;</div><div class="line">        <span class="keyword">if</span> (! <span class="keyword">isset</span>($attributes[$key])) &#123;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $attributes[$key] = <span class="keyword">$this</span>-&gt;serializeDate(</div><div class="line">            <span class="keyword">$this</span>-&gt;asDateTime($attributes[$key])</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $attributes;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">serializeDate</span><span class="params">(DateTimeInterface $date)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> $date-&gt;format(<span class="keyword">$this</span>-&gt;getDateFormat());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="自定义访问器转换"><a href="#自定义访问器转换" class="headerlink" title="自定义访问器转换"></a>自定义访问器转换</h3><p>定义了自定义访问器的属性，会调用访问器函数来覆盖原有的属性值，首先我们需要获取所有的自定义访问器变量：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getMutatedAttributes</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $class = <span class="keyword">static</span>::class;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="keyword">static</span>::$mutatorCache[$class])) &#123;</div><div class="line">        <span class="keyword">static</span>::cacheMutatedAttributes($class);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">static</span>::$mutatorCache[$class];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">cacheMutatedAttributes</span><span class="params">($class)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">static</span>::$mutatorCache[$class] = collect(<span class="keyword">static</span>::getMutatorMethods($class))-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($match)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> lcfirst(<span class="keyword">static</span>::$snakeAttributes ? Str::snake($match) : $match);</div><div class="line">    &#125;)-&gt;all();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getMutatorMethods</span><span class="params">($class)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    preg_match_all(<span class="string">'/(?&lt;=^|;)get([^;]+?)Attribute(;|$)/'</span>, implode(<span class="string">';'</span>, get_class_methods($class)), $matches);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $matches[<span class="number">1</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，函数用 <code>get_class_methods</code> 获取类内所有的函数，并筛选出符合 <code>get...Attribute</code> 的函数，获得自定义的访问器变量，并缓存到 <code>mutatorCache</code> 中。</p>
<p>接着将会利用自定义访问器变量替换原始值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addMutatedAttributesToArray</span><span class="params">(array $attributes, array $mutatedAttributes)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">foreach</span> ($mutatedAttributes <span class="keyword">as</span> $key) &#123;</div><div class="line">        <span class="keyword">if</span> (! array_key_exists($key, $attributes)) &#123;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $attributes[$key] = <span class="keyword">$this</span>-&gt;mutateAttributeForArray(</div><div class="line">            $key, $attributes[$key]</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $attributes;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">mutateAttributeForArray</span><span class="params">($key, $value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $value = <span class="keyword">$this</span>-&gt;mutateAttribute($key, $value);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $value <span class="keyword">instanceof</span> Arrayable ? $value-&gt;toArray() : $value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="cast-类型转换"><a href="#cast-类型转换" class="headerlink" title="cast 类型转换"></a>cast 类型转换</h3><p>被定义在 <code>cast</code> 数组中的变量也要进行数组转换，调用的方法和访问器相同，也是 <code>castAttribute</code>，如果是时间类型，还要按照时间格式来转换：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addCastAttributesToArray</span><span class="params">(array $attributes, array $mutatedAttributes)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;getCasts() <span class="keyword">as</span> $key =&gt; $value) &#123;</div><div class="line">        <span class="keyword">if</span> (! array_key_exists($key, $attributes) || in_array($key, $mutatedAttributes)) &#123;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $attributes[$key] = <span class="keyword">$this</span>-&gt;castAttribute(</div><div class="line">            $key, $attributes[$key]</div><div class="line">        );</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ($attributes[$key] &amp;&amp;</div><div class="line">            ($value === <span class="string">'date'</span> || $value === <span class="string">'datetime'</span>)) &#123;</div><div class="line">            $attributes[$key] = <span class="keyword">$this</span>-&gt;serializeDate($attributes[$key]);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $attributes;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="appends-额外属性添加"><a href="#appends-额外属性添加" class="headerlink" title="appends 额外属性添加"></a>appends 额外属性添加</h3><p><code>toArray()</code> 还会将我们定义在 <code>appends</code> 变量中的属性一起进行数组转换，但是注意被放入 <code>appends</code> 成员变量数组中的属性需要有自定义访问器函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getArrayableAppends</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! count(<span class="keyword">$this</span>-&gt;appends)) &#123;</div><div class="line">        <span class="keyword">return</span> [];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getArrayableItems(</div><div class="line">        array_combine(<span class="keyword">$this</span>-&gt;appends, <span class="keyword">$this</span>-&gt;appends)</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="查询作用域"><a href="#查询作用域" class="headerlink" title="查询作用域"></a>查询作用域</h2><p>查询作用域分为全局作用域与本地作用域。全局作用域不需要手动调用，由程序在每次的查询中自动加载，本地作用域需要在查询的时候进行手动调用。官方文档：<a href="https://d.laravel-china.org/docs/5.5/eloquent#query-scopes" target="_blank" rel="external">查询作用域</a></p>
<h3 id="全局作用域"><a href="#全局作用域" class="headerlink" title="全局作用域"></a>全局作用域</h3><p>一般全局作用域需要定义一个实现 <code>Illuminate\Database\Eloquent\Scope</code> 接口的类，该接口要求你实现一个方法：<code>apply</code>。需要的话可以在 <code>apply</code> 方法中添加 <code>where</code> 条件到查询。</p>
<p>要将全局作用域分配给模型，需要重写给定模型的 <code>boot</code> 方法并使用 <code>addGlobalScope</code> 方法。</p>
<p>另外，我们还可以向 <code>addGlobalScope</code> 中添加匿名函数实现匿名全局作用域。</p>
<p>我们先看看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">addGlobalScope</span><span class="params">($scope, Closure $implementation = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (is_string($scope) &amp;&amp; ! is_null($implementation)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::$globalScopes[<span class="keyword">static</span>::class][$scope] = $implementation;</div><div class="line">    &#125; <span class="keyword">elseif</span> ($scope <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::$globalScopes[<span class="keyword">static</span>::class][spl_object_hash($scope)] = $scope;</div><div class="line">    &#125; <span class="keyword">elseif</span> ($scope <span class="keyword">instanceof</span> Scope) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::$globalScopes[<span class="keyword">static</span>::class][get_class($scope)] = $scope;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(<span class="string">'Global scope must be an instance of Closure or Scope.'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，全局作用域使用的是全局的静态变量 <code>globalScopes</code>，该变量保存着所有数据库对象的全局作用域。</p>
<p><code>Eloquent\Model</code> 类并不负责查询功能，相关功能由 <code>Eloquent\Builder</code> 负责，因此每次查询都会间接调用 <code>Eloquent\Builder</code> 类。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $parameters)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (in_array($method, [<span class="string">'increment'</span>, <span class="string">'decrement'</span>])) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;$method(...$parameters);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;newQuery()-&gt;$method(...$parameters);</div><div class="line">    &#125; <span class="keyword">catch</span> (BadMethodCallException $e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BadMethodCallException(</div><div class="line">            sprintf(<span class="string">'Call to undefined method %s::%s()'</span>, get_class(<span class="keyword">$this</span>), $method)</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>创建新的 <code>Eloquent\Builder</code> 类需要 <code>newQuery</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">newQuery</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $builder = <span class="keyword">$this</span>-&gt;newQueryWithoutScopes();</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;getGlobalScopes() <span class="keyword">as</span> $identifier =&gt; $scope) &#123;</div><div class="line">        $builder-&gt;withGlobalScope($identifier, $scope);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $builder;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getGlobalScopes</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> Arr::get(<span class="keyword">static</span>::$globalScopes, <span class="keyword">static</span>::class, []);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">withGlobalScope</span><span class="params">($identifier, $scope)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;scopes[$identifier] = $scope;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (method_exists($scope, <span class="string">'extend'</span>)) &#123;</div><div class="line">        $scope-&gt;extend(<span class="keyword">$this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>newQuery</code> 函数为 <code>Eloquent\builder</code> 加载全局作用域，这样静态变量 <code>globalScopes</code> 的值就会被赋到 <code>Eloquent\builder</code> 的 <code>scopes</code> 成员变量中。</p>
<p>当我们使用 <code>get()</code> 函数获取数据库数据的时候，也需要借助魔术方法调用 <code>Illuminate\Database\Eloquent\Builder</code> 类的 <code>get</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($columns = [<span class="string">'*'</span>])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $builder = <span class="keyword">$this</span>-&gt;applyScopes();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (count($models = $builder-&gt;getModels($columns)) &gt; <span class="number">0</span>) &#123;</div><div class="line">        $models = $builder-&gt;eagerLoadRelations($models);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $builder-&gt;getModel()-&gt;newCollection($models);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用 <code>applyScopes</code> 函数加载所有的全局作用域：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">applyScopes</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;scopes) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $builder = <span class="keyword">clone</span> <span class="keyword">$this</span>;</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;scopes <span class="keyword">as</span> $identifier =&gt; $scope) &#123;</div><div class="line">        <span class="keyword">if</span> (! <span class="keyword">isset</span>($builder-&gt;scopes[$identifier])) &#123;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $builder-&gt;callScope(<span class="function"><span class="keyword">function</span> <span class="params">(Builder $builder)</span> <span class="title">use</span> <span class="params">($scope)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> ($scope <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">                $scope($builder);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> ($scope <span class="keyword">instanceof</span> Scope) &#123;</div><div class="line">                $scope-&gt;apply($builder, <span class="keyword">$this</span>-&gt;getModel());</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $builder;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，<code>builder</code> 查询类会通过 <code>callScope</code> 加载全局作用域的查询条件。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">callScope</span><span class="params">(callable $scope, $parameters = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    array_unshift($parameters, <span class="keyword">$this</span>);</div><div class="line"></div><div class="line">    $query = <span class="keyword">$this</span>-&gt;getQuery();</div><div class="line"></div><div class="line">    $originalWhereCount = is_null($query-&gt;wheres)</div><div class="line">                ? <span class="number">0</span> : count($query-&gt;wheres);</div><div class="line"></div><div class="line">    $result = $scope(...array_values($parameters)) ?? <span class="keyword">$this</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (count((<span class="keyword">array</span>) $query-&gt;wheres) &gt; $originalWhereCount) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;addNewWheresWithinGroup($query, $originalWhereCount);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>callScope</code> 函数首先会获取更加底层的 <code>Query\builder</code>，更新 <code>query\bulid</code> 的 <code>where</code> 条件。</p>
<p><code>addNewWheresWithinGroup</code> 这个函数很重要，它为 <code>Query\builder</code> 提供 <code>nest</code> 类型的 <code>where</code> 条件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addNewWheresWithinGroup</span><span class="params">(QueryBuilder $query, $originalWhereCount)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $allWheres = $query-&gt;wheres;</div><div class="line"></div><div class="line">    $query-&gt;wheres = [];</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;groupWhereSliceForScope(</div><div class="line">        $query, array_slice($allWheres, <span class="number">0</span>, $originalWhereCount)</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;groupWhereSliceForScope(</div><div class="line">        $query, array_slice($allWheres, $originalWhereCount)</div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">groupWhereSliceForScope</span><span class="params">(QueryBuilder $query, $whereSlice)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $whereBooleans = collect($whereSlice)-&gt;pluck(<span class="string">'boolean'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($whereBooleans-&gt;contains(<span class="string">'or'</span>)) &#123;</div><div class="line">        $query-&gt;wheres[] = <span class="keyword">$this</span>-&gt;createNestedWhere(</div><div class="line">            $whereSlice, $whereBooleans-&gt;first()</div><div class="line">        );</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $query-&gt;wheres = array_merge($query-&gt;wheres, $whereSlice);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createNestedWhere</span><span class="params">($whereSlice, $boolean = <span class="string">'and'</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $whereGroup = <span class="keyword">$this</span>-&gt;getQuery()-&gt;forNestedWhere();</div><div class="line"></div><div class="line">    $whereGroup-&gt;wheres = $whereSlice;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> [<span class="string">'type'</span> =&gt; <span class="string">'Nested'</span>, <span class="string">'query'</span> =&gt; $whereGroup, <span class="string">'boolean'</span> =&gt; $boolean];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当我们在查询作用域中，所有的查询条件连接符都是 <code>and</code> 的时候，可以直接合并到 <code>where</code> 中。</p>
<p>如果我们在查询作用域中或者原查询条件写下了 <code>orWhere</code>、<code>orWhereColumn</code> 等等连接符为 <code>or</code> 的查询条件，那么就会利用 <code>createNestedWhere</code> 函数创建 <code>nest</code> 类型的 <code>where</code> 条件。这个 <code>where</code> 条件会包含查询作用域的所有查询条件，或者原查询的所有查询条件。</p>
<h3 id="本地作用域"><a href="#本地作用域" class="headerlink" title="本地作用域"></a>本地作用域</h3><p>全局作用域会自定加载到所有的查询条件当中，<code>laravel</code> 中还有本地作用域，只有在查询时调用才会生效。</p>
<p>本地作用域是由魔术方法 <code>__call</code> 实现的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $parameters)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    ...</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (method_exists(<span class="keyword">$this</span>-&gt;model, $scope = <span class="string">'scope'</span>.ucfirst($method))) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;callScope([<span class="keyword">$this</span>-&gt;model, $scope], $parameters);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (in_array($method, <span class="keyword">$this</span>-&gt;passthru)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;toBase()-&gt;&#123;$method&#125;(...$parameters);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;query-&gt;&#123;$method&#125;(...$parameters);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="批量调用本地作用域"><a href="#批量调用本地作用域" class="headerlink" title="批量调用本地作用域"></a>批量调用本地作用域</h3><p><code>laravel</code> 还提供一个方法可以一次性调用多个本地作用域：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$scopes = [</div><div class="line">    <span class="string">'published'</span>,</div><div class="line">    <span class="string">'category'</span> =&gt; <span class="string">'Laravel'</span>,</div><div class="line">    <span class="string">'framework'</span> =&gt; [<span class="string">'Laravel'</span>, <span class="string">'5.3'</span>],</div><div class="line">];</div><div class="line"></div><div class="line">(<span class="keyword">new</span> EloquentModelStub)-&gt;scopes($scopes);</div></pre></td></tr></table></figure>
<p>上面的写法会调用三个本地作用域，它们的参数是 <code>$scopes</code> 的值。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">scopes</span><span class="params">(array $scopes)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $builder = <span class="keyword">$this</span>;</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> ($scopes <span class="keyword">as</span> $scope =&gt; $parameters) &#123;</div><div class="line">        <span class="keyword">if</span> (is_int($scope)) &#123;</div><div class="line">            <span class="keyword">list</span>($scope, $parameters) = [$parameters, []];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $builder = $builder-&gt;callScope(</div><div class="line">            [<span class="keyword">$this</span>-&gt;model, <span class="string">'scope'</span>.ucfirst($scope)],</div><div class="line">            (<span class="keyword">array</span>) $parameters</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $builder;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="fill-批量赋值"><a href="#fill-批量赋值" class="headerlink" title="fill 批量赋值"></a>fill 批量赋值</h2><p><code>Eloquent Model</code> 默认只能一个一个的设置数据库对象的属性，这是为了保护数据库。但是有的时候，字段过多会造成代码很繁琐。因此，<code>laravel</code> 提供属性批量赋值的功能，<code>fill</code> 函数，相关的官方文档：<a href="https://d.laravel-china.org/docs/5.5/eloquent#mass-assignment" target="_blank" rel="external">批量赋值</a></p>
<h3 id="fill-函数"><a href="#fill-函数" class="headerlink" title="fill 函数"></a>fill 函数</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fill</span><span class="params">(array $attributes)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $totallyGuarded = <span class="keyword">$this</span>-&gt;totallyGuarded();</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;fillableFromArray($attributes) <span class="keyword">as</span> $key =&gt; $value) &#123;</div><div class="line">        $key = <span class="keyword">$this</span>-&gt;removeTableFromKey($key);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isFillable($key)) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;setAttribute($key, $value);</div><div class="line">        &#125; <span class="keyword">elseif</span> ($totallyGuarded) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MassAssignmentException($key);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>fill</code> 函数会从参数 <code>attributes</code> 中选取可以批量赋值的属性。所谓的可以批量赋值的属性，是指被 <code>fillable</code> 或 <code>guarded</code> 成员变量设置的参数。被放入 <code>fillable</code> 的属性允许批量赋值的属性，被放入 <code>guarded</code> 的属性禁止批量赋值。</p>
<p>获取可批量赋值的属性：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">fillableFromArray</span><span class="params">(array $attributes)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (count(<span class="keyword">$this</span>-&gt;getFillable()) &gt; <span class="number">0</span> &amp;&amp; ! <span class="keyword">static</span>::$unguarded) &#123;</div><div class="line">        <span class="keyword">return</span> array_intersect_key($attributes, array_flip(<span class="keyword">$this</span>-&gt;getFillable()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $attributes;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFillable</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fillable;</div><div class="line">&#125;</div><div class="line">``` </div><div class="line">可以看到，若想要实现批量赋值，需要将属性设置在 `fillable` 成员数组中。</div><div class="line"></div><div class="line">在 `laravel` 中，有一种数据库对象关系是 `morph`，也就是 `多态` 关系，这种关系也会调用 `fill` 函数，这个时候传入的参数 `attributes` 会带有数据库前缀。接下来，就要调用 `removeTableFromKey` 函数来去除数据库前缀：</div><div class="line"></div><div class="line">```php</div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">removeTableFromKey</span><span class="params">($key)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> Str::contains($key, <span class="string">'.'</span>) ? last(explode(<span class="string">'.'</span>, $key)) : $key;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下一步，还要进一步验证属性的 <code>fillable</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isFillable</span><span class="params">($key)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">static</span>::$unguarded) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (in_array($key, <span class="keyword">$this</span>-&gt;getFillable())) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isGuarded($key)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;getFillable()) &amp;&amp;</div><div class="line">        ! Str::startsWith($key, <span class="string">'_'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果当前 <code>unguarded</code> 开启，也就是不会保护任何属性，那么直接返回 <code>true</code>。如果当前属性在 <code>fillable</code> 中，也会返回 <code>true</code>。如果当前属性在 <code>guarded</code> 中，返回 <code>false</code>。最后，如果 <code>fillable</code> 是空数组，也会返回 <code>true</code>。</p>
<h3 id="forceFill"><a href="#forceFill" class="headerlink" title="forceFill"></a>forceFill</h3><p>如果不想受 <code>fillable</code> 或者 <code>guarded</code> 等的影响，还可以使用 <code>forceFill</code> 强制来批量赋值。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">forceFill</span><span class="params">(array $attributes)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">static</span>::unguarded(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($attributes)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fill($attributes);</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">unguarded</span><span class="params">(callable $callback)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">static</span>::$unguarded) &#123;</div><div class="line">        <span class="keyword">return</span> $callback();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span>::unguard();</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">return</span> $callback();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">static</span>::reguard();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/10/02/Laravel Database——查询构造器与语法编译器源码分析(下)/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/02/Laravel Database——查询构造器与语法编译器源码分析(下)/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-02T11:15:06+08:00">
                2017-10-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/10/02/Laravel Database——查询构造器与语法编译器源码分析(下)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/10/02/Laravel Database——查询构造器与语法编译器源码分析(下)/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/10/02/Laravel Database——查询构造器与语法编译器源码分析(下)/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Laravel-Database——查询构造器与语法编译器源码分析-下"><a href="#Laravel-Database——查询构造器与语法编译器源码分析-下" class="headerlink" title="Laravel Database——查询构造器与语法编译器源码分析(下)"></a>Laravel Database——查询构造器与语法编译器源码分析(下)</h1><h2 id="insert-语句"><a href="#insert-语句" class="headerlink" title="insert 语句"></a>insert 语句</h2><p><code>insert</code> 语句也是我们经常使用的数据库操作，它的源码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert</span><span class="params">(array $values)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($values)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! is_array(reset($values))) &#123;</div><div class="line">        $values = [$values];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">foreach</span> ($values <span class="keyword">as</span> $key =&gt; $value) &#123;</div><div class="line">            ksort($value);</div><div class="line"></div><div class="line">            $values[$key] = $value;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;connection-&gt;insert(</div><div class="line">        <span class="keyword">$this</span>-&gt;grammar-&gt;compileInsert(<span class="keyword">$this</span>, $values),</div><div class="line">        <span class="keyword">$this</span>-&gt;cleanBindings(Arr::flatten($values, <span class="number">1</span>))</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>laravel</code> 的 <code>insert</code> 是允许批量插入的，方法如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;insert([[<span class="string">'email'</span> =&gt; <span class="string">'foo'</span>, <span class="string">'name'</span> =&gt; <span class="string">'taylor'</span>], [<span class="string">'email'</span> =&gt; <span class="string">'bar'</span>, <span class="string">'name'</span> =&gt; <span class="string">'dayle'</span>]]);</div></pre></td></tr></table></figure>
<p>一个语句可以向数据库插入两条记录。<code>sql</code> 语句为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">insert into users (`email`,`name`) values (<span class="string">'foo'</span>, <span class="string">'taylor'</span>), (<span class="string">'bar'</span>, <span class="string">'dayle'</span>);</div></pre></td></tr></table></figure>
<p>因此，<code>laravel</code> 在处理 <code>insert</code> 的时候，首先会判断当前的参数是单条插入还是批量插入。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (! is_array(reset($values))) &#123;</div><div class="line">    $values = [$values];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>reset</code> 会返回 <code>values</code> 的第一个元素。如果是批量插入的话，第一个元素必然也是数组。如果的单条插入的话，第一个元素是列名与列值。因此如果是单条插入的话，会在最外层再套一个数组，统一插入的格式。</p>
<p>如果是批量插入的话，首先需要把插入的各个字段进行排序，保证插入时各个记录的列顺序一致。</p>
<h3 id="compileInsert"><a href="#compileInsert" class="headerlink" title="compileInsert"></a>compileInsert</h3><p>对 <code>insert</code> 的编译也是按照批量插入的标准来进行的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">compileInsert</span><span class="params">(Builder $query, array $values)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $table = <span class="keyword">$this</span>-&gt;wrapTable($query-&gt;from);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! is_array(reset($values))) &#123;</div><div class="line">        $values = [$values];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $columns = <span class="keyword">$this</span>-&gt;columnize(array_keys(reset($values)));</div><div class="line"></div><div class="line">    $parameters = collect($values)-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($record)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'('</span>.<span class="keyword">$this</span>-&gt;parameterize($record).<span class="string">')'</span>;</div><div class="line">    &#125;)-&gt;implode(<span class="string">', '</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">"insert into $table ($columns) values $parameters"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先对插入的列名进行 <code>columnze</code> 函数处理，之后对每个记录的插入都调用 <code>parameterize</code> 函数来对列值进行处理，并用 <code>（）</code> 包围起来。</p>
<h2 id="update-语句"><a href="#update-语句" class="headerlink" title="update 语句"></a>update 语句</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(array $values)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $sql = <span class="keyword">$this</span>-&gt;grammar-&gt;compileUpdate(<span class="keyword">$this</span>, $values);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;connection-&gt;update($sql, <span class="keyword">$this</span>-&gt;cleanBindings(</div><div class="line">        <span class="keyword">$this</span>-&gt;grammar-&gt;prepareBindingsForUpdate(<span class="keyword">$this</span>-&gt;bindings, $values)</div><div class="line">    ));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与插入语句相比，更新语句更加复杂，因为更新语句必然带有 <code>where</code> 条件，有时还会有 <code>join</code> 条件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">compileUpdate</span><span class="params">(Builder $query, $values)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $table = <span class="keyword">$this</span>-&gt;wrapTable($query-&gt;from);</div><div class="line"></div><div class="line">    $columns = collect($values)-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($value, $key)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap($key).<span class="string">' = '</span>.<span class="keyword">$this</span>-&gt;parameter($value);</div><div class="line">    &#125;)-&gt;implode(<span class="string">', '</span>);</div><div class="line"></div><div class="line">    $joins = <span class="string">''</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($query-&gt;joins)) &#123;</div><div class="line">        $joins = <span class="string">' '</span>.<span class="keyword">$this</span>-&gt;compileJoins($query, $query-&gt;joins);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $wheres = <span class="keyword">$this</span>-&gt;compileWheres($query);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> trim(<span class="string">"update &#123;$table&#125;&#123;$joins&#125; set $columns $wheres"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="updateOrInsert-语句"><a href="#updateOrInsert-语句" class="headerlink" title="updateOrInsert 语句"></a>updateOrInsert 语句</h2><p><code>updateOrInsert</code> 语句会先根据 <code>attributes</code> 条件查询，如果查询失败，就会合并 <code>attributes</code> 与 <code>values</code> 两个数组，并插入新的记录。如果查询成功，就会利用 <code>values</code> 更新数据。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">updateOrInsert</span><span class="params">(array $attributes, array $values = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;where($attributes)-&gt;exists()) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;insert(array_merge($attributes, $values));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (bool) <span class="keyword">$this</span>-&gt;take(<span class="number">1</span>)-&gt;update($values);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="delete-语句"><a href="#delete-语句" class="headerlink" title="delete 语句"></a>delete 语句</h2><p>删除语句比较简单，参数仅仅需要 id 即可，<code>delete</code> 语句会添加 <code>id</code> 的 <code>where</code> 条件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span><span class="params">($id = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! is_null($id)) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;where(<span class="keyword">$this</span>-&gt;from.<span class="string">'.id'</span>, <span class="string">'='</span>, $id);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;connection-&gt;delete(</div><div class="line">        <span class="keyword">$this</span>-&gt;grammar-&gt;compileDelete(<span class="keyword">$this</span>), <span class="keyword">$this</span>-&gt;getBindings()</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>删除语句的编译需要先编译 <code>where</code> 条件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">compileDelete</span><span class="params">(Builder $query)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $wheres = is_array($query-&gt;wheres) ? <span class="keyword">$this</span>-&gt;compileWheres($query) : <span class="string">''</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> trim(<span class="string">"delete from &#123;$this-&gt;wrapTable($query-&gt;from)&#125; $wheres"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="动态-where"><a href="#动态-where" class="headerlink" title="动态 where"></a>动态 where</h2><p><code>laravel</code> 有一个有趣的功能：动态 where。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;whereFooBarAndBazOrQux(<span class="string">'corge'</span>, <span class="string">'waldo'</span>, <span class="string">'fred'</span>)</div></pre></td></tr></table></figure>
<p>这个语句会生成下面的 <code>sql</code> 语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select * from users where foo_bar = <span class="string">'corge'</span> <span class="keyword">and</span> baz = <span class="string">'waldo'</span> <span class="keyword">or</span> qux = <span class="string">'fred'</span>;</div></pre></td></tr></table></figure>
<p>也就是说，动态 <code>where</code> 将函数名解析为列名与连接条件，将参数作为搜索的值。</p>
<p>我们先看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dynamicWhere</span><span class="params">($method, $parameters)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"></div><div class="line">    $finder = substr($method, <span class="number">5</span>);</div><div class="line"></div><div class="line">    $segments = preg_split(</div><div class="line">        <span class="string">'/(And|Or)(?=[A-Z])/'</span>, $finder, <span class="number">-1</span>, PREG_SPLIT_DELIM_CAPTURE</div><div class="line">    );</div><div class="line"></div><div class="line">    $connector = <span class="string">'and'</span>;</div><div class="line"></div><div class="line">    $index = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> ($segments <span class="keyword">as</span> $segment) &#123;</div><div class="line">        <span class="keyword">if</span> ($segment !== <span class="string">'And'</span> &amp;&amp; $segment !== <span class="string">'Or'</span>) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;addDynamic($segment, $connector, $parameters, $index);</div><div class="line"></div><div class="line">            $index++;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            $connector = $segment;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addDynamic</span><span class="params">($segment, $connector, $parameters, $index)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $bool = strtolower($connector);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;where(Str::snake($segment), <span class="string">'='</span>, $parameters[$index], $bool);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>首先，程序会提取函数名 <code>whereFooBarAndBazOrQux</code>，删除前 5 个字符，<code>FooBarAndBazOrQux</code>。</p>
</li>
<li><p>正则判断，根据 <code>And</code> 或 <code>Or</code> 对函数名进行切割:<code>FooBar</code>、<code>And</code>、<code>Baz</code>、<code>Or</code>、<code>Qux</code>。</p>
</li>
<li><p>添加 <code>where</code> 条件，将驼峰命名改为蛇型命名。</p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/09/30/Laravel Database——分页原理与源码分析/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/30/Laravel Database——分页原理与源码分析/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-30T22:32:35+08:00">
                2017-09-30
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/09/30/Laravel Database——分页原理与源码分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/09/30/Laravel Database——分页原理与源码分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/09/30/Laravel Database——分页原理与源码分析/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Laravel-Database——paginate-分页服务源码分析"><a href="#Laravel-Database——paginate-分页服务源码分析" class="headerlink" title="Laravel Database——paginate 分页服务源码分析"></a>Laravel Database——paginate 分页服务源码分析</h1><h2 id="paginate-分页"><a href="#paginate-分页" class="headerlink" title="paginate 分页"></a>paginate 分页</h2><p><code>laravel</code> 的分页用起来非常简单，只需要对 <code>query</code> 调用 <code>paginate</code> 函数，把返回的对象扔给前端 <code>blade</code> 文件，在 <code>blade</code> 文件调用函数 <code>render</code> 函数或者 <code>link</code> 函数，就可以得到 <code>上一页</code>、<code>下一页</code> 等等分页特效。</p>
<p>实际上，我们可以简单地把分页服务看作一个前端资源，<code>render</code> 函数或者 <code>link</code> 函数的结果就是分页前端代码。</p>
<p>如果你还对 <code>laravel</code> 的分页不是很熟悉，请先阅读官方文档 ： <a href="https://d.laravel-china.org/docs/5.5/pagination" target="_blank" rel="external">分页</a>。</p>
<h2 id="分页服务的启动"><a href="#分页服务的启动" class="headerlink" title="分页服务的启动"></a>分页服务的启动</h2><p>分页功能也是由一个服务提供者所启动的，<code>PaginationServiceProvider</code> 就是负责注册和启动分页服务的服务提供者：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaginationServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        Paginator::viewFactoryResolver(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;app[<span class="string">'view'</span>];</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        Paginator::currentPathResolver(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;app[<span class="string">'request'</span>]-&gt;url();</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        Paginator::currentPageResolver(<span class="function"><span class="keyword">function</span> <span class="params">($pageName = <span class="string">'page'</span>)</span> </span>&#123;</div><div class="line">            $page = <span class="keyword">$this</span>-&gt;app[<span class="string">'request'</span>]-&gt;input($pageName);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (filter_var($page, FILTER_VALIDATE_INT) !== <span class="keyword">false</span> &amp;&amp; (int) $page &gt;= <span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">return</span> $page;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们看到，服务提供者的注册函数为 <code>Paginator</code> 设置三个闭包函数：</p>
<ul>
<li>viewFactoryResolver 为 <code>Paginator</code> 设置了生成前端资源的类，用于获取分页前端代码。</li>
<li>currentPathResolver 为 <code>Paginator</code> 设置了 <code>url</code> 的地址。我们知道， <code>上一页</code>、<code>下一页</code> 等等都是可以执行翻页的操作，所以实际上这些按钮必然含有链接，而链接的地址就是当前请求的 <code>url</code> 地址，不同的按钮的链接地址只是 <code>page</code> 的参数不同而已。</li>
<li>currentPageResolver 为 <code>Paginator</code> 获取了当前的页数。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;loadViewsFrom(<span class="keyword">__DIR__</span>.<span class="string">'/resources/views'</span>, <span class="string">'pagination'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;app-&gt;runningInConsole()) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;publishes([</div><div class="line">            <span class="keyword">__DIR__</span>.<span class="string">'/resources/views'</span> =&gt; <span class="keyword">$this</span>-&gt;app-&gt;resourcePath(<span class="string">'views/vendor/pagination'</span>),</div><div class="line">        ], <span class="string">'laravel-pagination'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">loadViewsFrom</span><span class="params">($path, $namespace)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (is_dir($appPath = <span class="keyword">$this</span>-&gt;app-&gt;resourcePath().<span class="string">'/views/vendor/'</span>.$namespace)) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;app[<span class="string">'view'</span>]-&gt;addNamespace($namespace, $appPath);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;app[<span class="string">'view'</span>]-&gt;addNamespace($namespace, $path);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>服务的启动函数为分页服务设置了默认的前端分页资源。</p>
<h2 id="分页服务-paginator"><a href="#分页服务-paginator" class="headerlink" title="分页服务 paginator"></a>分页服务 paginator</h2><p>分页服务 <code>paginator</code> 函数用于 <code>queryBuilder</code>，用于获取分页的数据库数据：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">paginate</span><span class="params">($perPage = <span class="number">15</span>, $columns = [<span class="string">'*'</span>], $pageName = <span class="string">'page'</span>, $page = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $page = $page ?: Paginator::resolveCurrentPage($pageName);</div><div class="line"></div><div class="line">    $total = <span class="keyword">$this</span>-&gt;getCountForPagination($columns);</div><div class="line"></div><div class="line">    $results = $total</div><div class="line">        ? <span class="keyword">$this</span>-&gt;forPage($page, $perPage)-&gt;get($columns) : collect();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;paginator($results, $total, $perPage, $page, [</div><div class="line">        <span class="string">'path'</span> =&gt; Paginator::resolveCurrentPath(),</div><div class="line">        <span class="string">'pageName'</span> =&gt; $pageName,</div><div class="line">    ]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">paginator</span><span class="params">($items, $total, $perPage, $currentPage, $options)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> Container::getInstance()-&gt;makeWith(LengthAwarePaginator::class, compact(</div><div class="line">        <span class="string">'items'</span>, <span class="string">'total'</span>, <span class="string">'perPage'</span>, <span class="string">'currentPage'</span>, <span class="string">'options'</span></div><div class="line">    ));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>也就是说，当我们写下这样的代码时：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'user'</span>)-&gt;select(<span class="string">'*'</span>)-&gt;where(<span class="string">'status'</span>,<span class="number">1</span>)-&gt;paginator();</div></pre></td></tr></table></figure>
<p>我们可以获取到一个 <code>LengthAwarePaginator</code> 类对象，对这个对象调用 <code>render</code> 函数就可以获取分页前端资源。</p>
<p>我们先来研究一下 <code>paginator</code> 函数。</p>
<h3 id="获取当前页"><a href="#获取当前页" class="headerlink" title="获取当前页"></a>获取当前页</h3><p>我们可以看到，在这个函数中程序先获取当前页数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveCurrentPage</span><span class="params">($pageName = <span class="string">'page'</span>, $default = <span class="number">1</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">static</span>::$currentPageResolver)) &#123;</div><div class="line">        <span class="keyword">return</span> call_user_func(<span class="keyword">static</span>::$currentPageResolver, $pageName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $default;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>currentPageResolver 就是上一节中 <code>currentPageResolver</code> 设置的闭包函数，这个闭包函数从请求参数中获取当前页：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$page = <span class="keyword">$this</span>-&gt;app[<span class="string">'request'</span>]-&gt;input($pageName);</div></pre></td></tr></table></figure>
<h3 id="获取数据库总记录数"><a href="#获取数据库总记录数" class="headerlink" title="获取数据库总记录数"></a>获取数据库总记录数</h3><p>计算数据库符合搜索条件的总记录数理所当然的是使用聚合函数 <code>count</code> ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCountForPagination</span><span class="params">($columns = [<span class="string">'*'</span>])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $results = <span class="keyword">$this</span>-&gt;runPaginationCountQuery($columns);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;groups)) &#123;</div><div class="line">        <span class="keyword">return</span> count($results);</div><div class="line">    &#125; <span class="keyword">elseif</span> (! <span class="keyword">isset</span>($results[<span class="number">0</span>])) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125; <span class="keyword">elseif</span> (is_object($results[<span class="number">0</span>])) &#123;</div><div class="line">        <span class="keyword">return</span> (int) $results[<span class="number">0</span>]-&gt;aggregate;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> (int) array_change_key_case((<span class="keyword">array</span>) $results[<span class="number">0</span>])[<span class="string">'aggregate'</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runPaginationCountQuery</span><span class="params">($columns = [<span class="string">'*'</span>])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;cloneWithout([<span class="string">'columns'</span>, <span class="string">'orders'</span>, <span class="string">'limit'</span>, <span class="string">'offset'</span>])</div><div class="line">                -&gt;cloneWithoutBindings([<span class="string">'select'</span>, <span class="string">'order'</span>])</div><div class="line">                -&gt;setAggregate(<span class="string">'count'</span>, <span class="keyword">$this</span>-&gt;withoutSelectAliases($columns))</div><div class="line">                -&gt;get()-&gt;all();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="获取当前页数据"><a href="#获取当前页数据" class="headerlink" title="获取当前页数据"></a>获取当前页数据</h3><p>获取当前页当然是使用 <code>forPage</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$results = $total</div><div class="line">        ? <span class="keyword">$this</span>-&gt;forPage($page, $perPage)-&gt;get($columns) : collect();</div></pre></td></tr></table></figure>
<h3 id="初始化-LengthAwarePaginator"><a href="#初始化-LengthAwarePaginator" class="headerlink" title="初始化 LengthAwarePaginator"></a>初始化 LengthAwarePaginator</h3><p><code>paginator</code> 函数利用 Ioc 容器来生成 <code>LengthAwarePaginator</code> 实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">paginator</span><span class="params">($items, $total, $perPage, $currentPage, $options)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> Container::getInstance()-&gt;makeWith(LengthAwarePaginator::class, compact(</div><div class="line">        <span class="string">'items'</span>, <span class="string">'total'</span>, <span class="string">'perPage'</span>, <span class="string">'currentPage'</span>, <span class="string">'options'</span></div><div class="line">    ));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>LengthAwarePaginator</code> 的初始化：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($items, $total, $perPage, $currentPage = null, array $options = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">foreach</span> ($options <span class="keyword">as</span> $key =&gt; $value) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;&#123;$key&#125; = $value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;total = $total;</div><div class="line">    <span class="keyword">$this</span>-&gt;perPage = $perPage;</div><div class="line">    <span class="keyword">$this</span>-&gt;lastPage = max((int) ceil($total / $perPage), <span class="number">1</span>);</div><div class="line">    <span class="keyword">$this</span>-&gt;path = <span class="keyword">$this</span>-&gt;path !== <span class="string">'/'</span> ? rtrim(<span class="keyword">$this</span>-&gt;path, <span class="string">'/'</span>) : <span class="keyword">$this</span>-&gt;path;</div><div class="line">    <span class="keyword">$this</span>-&gt;currentPage = <span class="keyword">$this</span>-&gt;setCurrentPage($currentPage, <span class="keyword">$this</span>-&gt;pageName);</div><div class="line">    <span class="keyword">$this</span>-&gt;items = $items <span class="keyword">instanceof</span> Collection ? $items : Collection::make($items);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="分页资源-render"><a href="#分页资源-render" class="headerlink" title="分页资源 render"></a>分页资源 render</h2><p>对 <code>LengthAwarePaginator</code> 调用 <code>render</code> 函数会得到分页所需要的前端资源：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">($view = null, $data = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HtmlString(<span class="keyword">static</span>::viewFactory()-&gt;make($view ?: <span class="keyword">static</span>::$defaultView, array_merge($data, [</div><div class="line">        <span class="string">'paginator'</span> =&gt; <span class="keyword">$this</span>,</div><div class="line">        <span class="string">'elements'</span> =&gt; <span class="keyword">$this</span>-&gt;elements(),</div><div class="line">    ]))-&gt;render());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当我们使用默认的分页样式的时候，不需要向 <code>render</code> 函数传入 <code>view</code> 参数，此时程序会自动加载默认的前端资源:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> $defaultView = <span class="string">'pagination::default'</span>;</div></pre></td></tr></table></figure>
<p>该资源的默认地址是 <code>illuminate\Pagination\resources\views\default.blade.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">@<span class="keyword">if</span> ($paginator-&gt;hasPages())</div><div class="line">    &lt;ul class="pagination"&gt;</div><div class="line">        &#123;&#123;-- Previous Page Link --&#125;&#125;</div><div class="line">        @<span class="keyword">if</span> ($paginator-&gt;onFirstPage())</div><div class="line">            &lt;li class="disabled"&gt;&lt;span&gt;&lt;&lt;&lt;/span&gt;&lt;/li&gt;</div><div class="line">        @<span class="keyword">else</span></div><div class="line">            &lt;li&gt;&lt;a href=<span class="string">"&#123;&#123; $paginator-&gt;previousPageUrl() &#125;&#125;"</span> rel=<span class="string">"prev"</span>&gt;&lt;&lt;&lt;/a&gt;&lt;/li&gt;</div><div class="line">        @<span class="keyword">endif</span></div><div class="line"></div><div class="line">        &#123;&#123;-- Pagination Elements --&#125;&#125;</div><div class="line">        @<span class="keyword">foreach</span> ($elements <span class="keyword">as</span> $element)</div><div class="line">            &#123;&#123;-- <span class="string">"Three Dots"</span> Separator --&#125;&#125;</div><div class="line">            @<span class="keyword">if</span> (is_string($element))</div><div class="line">                &lt;li class="disabled"&gt;&lt;span&gt;&#123;&#123; $element &#125;&#125;&lt;/span&gt;&lt;/li&gt;</div><div class="line">            @<span class="keyword">endif</span></div><div class="line"></div><div class="line">            &#123;&#123;-- <span class="keyword">Array</span> Of Links --&#125;&#125;</div><div class="line">            @<span class="keyword">if</span> (is_array($element))</div><div class="line">                @<span class="keyword">foreach</span> ($element <span class="keyword">as</span> $page =&gt; $url)</div><div class="line">                    @<span class="keyword">if</span> ($page == $paginator-&gt;currentPage())</div><div class="line">                        &lt;li class="active"&gt;&lt;span&gt;&#123;&#123; $page &#125;&#125;&lt;/span&gt;&lt;/li&gt;</div><div class="line">                    @<span class="keyword">else</span></div><div class="line">                        &lt;li&gt;&lt;a href=<span class="string">"&#123;&#123; $url &#125;&#125;"</span>&gt;&#123;&#123; $page &#125;&#125;&lt;/a&gt;&lt;/li&gt;</div><div class="line">                    @<span class="keyword">endif</span></div><div class="line">                @<span class="keyword">endforeach</span></div><div class="line">            @<span class="keyword">endif</span></div><div class="line">        @<span class="keyword">endforeach</span></div><div class="line"></div><div class="line">        &#123;&#123;-- Next Page Link --&#125;&#125;</div><div class="line">        @<span class="keyword">if</span> ($paginator-&gt;hasMorePages())</div><div class="line">            &lt;li&gt;&lt;a href=<span class="string">"&#123;&#123; $paginator-&gt;nextPageUrl() &#125;&#125;"</span> rel=<span class="string">"next"</span>&gt;&gt;&gt;&lt;/a&gt;&lt;/li&gt;</div><div class="line">        @<span class="keyword">else</span></div><div class="line">            &lt;li class="disabled"&gt;&lt;span&gt;&gt;&gt;&lt;/span&gt;&lt;/li&gt;</div><div class="line">        @<span class="keyword">endif</span></div><div class="line">    &lt;/ul&gt;</div><div class="line">@<span class="keyword">endif</span></div></pre></td></tr></table></figure>
<p>可以看到，分页效果的代码分为三部分：前一页、后一页、分页元素。</p>
<h3 id="前一页"><a href="#前一页" class="headerlink" title="前一页"></a>前一页</h3><p>如果当前页是第一页的话，<code>前一页</code> 按钮需要置灰：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onFirstPage</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;currentPage() &lt;= <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>否则的话，就要为 <code>前一页</code> 按钮赋予链接：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">previousPageUrl</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;currentPage() &gt; <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;url(<span class="keyword">$this</span>-&gt;currentPage() - <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">url</span><span class="params">($page)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> ($page &lt;= <span class="number">0</span>) &#123;</div><div class="line">        $page = <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $parameters = [<span class="keyword">$this</span>-&gt;pageName =&gt; $page];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (count(<span class="keyword">$this</span>-&gt;query) &gt; <span class="number">0</span>) &#123;</div><div class="line">        $parameters = array_merge(<span class="keyword">$this</span>-&gt;query, $parameters);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;path</div><div class="line">                    .(Str::contains(<span class="keyword">$this</span>-&gt;path, <span class="string">'?'</span>) ? <span class="string">'&amp;'</span> : <span class="string">'?'</span>)</div><div class="line">                    .http_build_query($parameters, <span class="string">''</span>, <span class="string">'&amp;'</span>)</div><div class="line">                    .<span class="keyword">$this</span>-&gt;buildFragment();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果列表页中存在一些搜索条件，这些搜索条件会被加载到 <code>$this-&gt;query</code> 成员变量中，生成 <code>url</code> 的时候，这些搜索添加会被加到 <code>request</code> 的参数中。可以使用 <code>append</code> 方法附加查询参数到分页链接中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">appends</span><span class="params">($key, $value = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (is_array($key)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;appendArray($key);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;addQuery($key, $value);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">appendArray</span><span class="params">(array $keys)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">foreach</span> ($keys <span class="keyword">as</span> $key =&gt; $value) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;addQuery($key, $value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="下一页"><a href="#下一页" class="headerlink" title="下一页"></a>下一页</h3><p>与 <code>前一页</code> 类似，如果已经在最后一页，那么 <code>下一页</code> 按钮将会被置灰：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasMorePages</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;currentPage() &lt; <span class="keyword">$this</span>-&gt;lastPage();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下一页的链接：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">nextPageUrl</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;lastPage() &gt; <span class="keyword">$this</span>-&gt;currentPage()) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;url(<span class="keyword">$this</span>-&gt;currentPage() + <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>上一页</code> 与 <code>下一页</code> 按钮的功能比较简单，至于中间的分页特效比较复杂，我们由下一节来说。</p>
<h2 id="分页-elements"><a href="#分页-elements" class="headerlink" title="分页 elements"></a>分页 elements</h2><p>我们先说一下不同的分页样式：</p>
<ul>
<li>当我们设置两侧页数为 3 时，当前数据总页数小于 8 页时分页效果：</li>
</ul>
<p><img src="http://owql68l6p.bkt.clouddn.com/QQ20171001-104935@2x.png" alt=""></p>
<ul>
<li>总页数大于 6 页，且当前页在前 8 页（2 * 3 + 2）时分页效果：</li>
</ul>
<p><img src="http://owql68l6p.bkt.clouddn.com/QQ20171001-102833@2x.png" alt="img"></p>
<ul>
<li>当前页在前 6 页与后 6 页之间分页效果：</li>
</ul>
<p><img src="http://owql68l6p.bkt.clouddn.com/QQ20171001-102858@2x.png" alt="img"></p>
<ul>
<li>当前页在最后 6 页时分页效果：</li>
</ul>
<p><img src="http://owql68l6p.bkt.clouddn.com/QQ20171001-102916@2x.png" alt="img"></p>
<p>分页效果样式的关键来源于 <code>UrlWindow</code>，这个类用于根据总页数与当前页的不同来控制不同的分页样式。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">elements</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $window = UrlWindow::make(<span class="keyword">$this</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> array_filter([</div><div class="line">        $window[<span class="string">'first'</span>],</div><div class="line">        is_array($window[<span class="string">'slider'</span>]) ? <span class="string">'...'</span> : <span class="keyword">null</span>,</div><div class="line">        $window[<span class="string">'slider'</span>],</div><div class="line">        is_array($window[<span class="string">'last'</span>]) ? <span class="string">'...'</span> : <span class="keyword">null</span>,</div><div class="line">        $window[<span class="string">'last'</span>],</div><div class="line">    ]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">(PaginatorContract $paginator, $onEachSide = <span class="number">3</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> <span class="keyword">static</span>($paginator))-&gt;get($onEachSide);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($onEachSide = <span class="number">3</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;paginator-&gt;lastPage() &lt; ($onEachSide * <span class="number">2</span>) + <span class="number">6</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getSmallSlider();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getUrlSlider($onEachSide);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="小型分页-getSmallSlider"><a href="#小型分页-getSmallSlider" class="headerlink" title="小型分页 getSmallSlider"></a>小型分页 getSmallSlider</h3><p>如果当前总页数小于 <code>($onEachSide * 2) + 6</code> 的话，就会调用小型分页效果，这种小型分页效果直接将所有页数全部显示：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getSmallSlider</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> [</div><div class="line">        <span class="string">'first'</span>  =&gt; <span class="keyword">$this</span>-&gt;paginator-&gt;getUrlRange(<span class="number">1</span>, <span class="keyword">$this</span>-&gt;lastPage()),</div><div class="line">        <span class="string">'slider'</span> =&gt; <span class="keyword">null</span>,</div><div class="line">        <span class="string">'last'</span>   =&gt; <span class="keyword">null</span>,</div><div class="line">    ];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUrlRange</span><span class="params">($start, $end)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> collect(range($start, $end))-&gt;mapWithKeys(<span class="function"><span class="keyword">function</span> <span class="params">($page)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> [$page =&gt; <span class="keyword">$this</span>-&gt;url($page)];</div><div class="line">    &#125;)-&gt;all();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="CloseToBeginning-分页效果"><a href="#CloseToBeginning-分页效果" class="headerlink" title="CloseToBeginning 分页效果"></a>CloseToBeginning 分页效果</h3><p>当前页数位于前 <code>($onEachSide * 2)</code> 页时：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getUrlSlider</span><span class="params">($onEachSide)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $window = $onEachSide * <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;hasPages()) &#123;</div><div class="line">        <span class="keyword">return</span> [<span class="string">'first'</span> =&gt; <span class="keyword">null</span>, <span class="string">'slider'</span> =&gt; <span class="keyword">null</span>, <span class="string">'last'</span> =&gt; <span class="keyword">null</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;currentPage() &lt;= $window) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getSliderTooCloseToBeginning($window);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">elseif</span> (<span class="keyword">$this</span>-&gt;currentPage() &gt; (<span class="keyword">$this</span>-&gt;lastPage() - $window)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getSliderTooCloseToEnding($window);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getFullSlider($onEachSide);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getSliderTooCloseToBeginning</span><span class="params">($window)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> [</div><div class="line">        <span class="string">'first'</span> =&gt; <span class="keyword">$this</span>-&gt;paginator-&gt;getUrlRange(<span class="number">1</span>, $window + <span class="number">2</span>),</div><div class="line">        <span class="string">'slider'</span> =&gt; <span class="keyword">null</span>,</div><div class="line">        <span class="string">'last'</span> =&gt; <span class="keyword">$this</span>-&gt;getFinish(),</div><div class="line">    ];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFinish</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;paginator-&gt;getUrlRange(</div><div class="line">        <span class="keyword">$this</span>-&gt;lastPage() - <span class="number">1</span>,</div><div class="line">        <span class="keyword">$this</span>-&gt;lastPage()</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>假设我们设置当前两侧页数为 3，当前页为 5，总页数22，函数 <code>getSliderTooCloseToBeginning</code> 返回结果为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> [</div><div class="line">    <span class="string">'first'</span> =&gt; [</div><div class="line">        <span class="number">1</span> =&gt; <span class="string">'/www.example.com/example?page=1'</span>, </div><div class="line">        <span class="number">2</span> =&gt; <span class="string">'/www.example.com/example?page=2'</span></div><div class="line">        <span class="number">3</span> =&gt; <span class="string">'/www.example.com/example?page=3'</span></div><div class="line">        <span class="number">4</span> =&gt; <span class="string">'/www.example.com/example?page=4'</span></div><div class="line">        <span class="number">5</span> =&gt; <span class="string">'/www.example.com/example?page=5'</span></div><div class="line">        <span class="number">6</span> =&gt; <span class="string">'/www.example.com/example?page=6'</span></div><div class="line">        <span class="number">7</span> =&gt; <span class="string">'/www.example.com/example?page=7'</span></div><div class="line">        <span class="number">8</span> =&gt; <span class="string">'/www.example.com/example?page=8'</span>],</div><div class="line">    <span class="string">'slider'</span> =&gt; <span class="keyword">null</span>,</div><div class="line">    <span class="string">'last'</span> =&gt; [</div><div class="line">        <span class="number">21</span> =&gt; <span class="string">'/www.example.com/example?page=21'</span>,</div><div class="line">        <span class="number">22</span> =&gt; <span class="string">'/www.example.com/example?page=22'</span>],</div><div class="line">];</div></pre></td></tr></table></figure>
<p>这个时候 <code>element</code> 函数返回数据：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">elements</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $window = UrlWindow::make(<span class="keyword">$this</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> array_filter([</div><div class="line">        $window[<span class="string">'first'</span>],</div><div class="line">        is_array($window[<span class="string">'slider'</span>]) ? <span class="string">'...'</span> : <span class="keyword">null</span>,</div><div class="line">        $window[<span class="string">'slider'</span>],</div><div class="line">        is_array($window[<span class="string">'last'</span>]) ? <span class="string">'...'</span> : <span class="keyword">null</span>,</div><div class="line">        $window[<span class="string">'last'</span>],</div><div class="line">    ]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//返回结果</span></div><div class="line">[</div><div class="line">    [</div><div class="line">        <span class="number">1</span> =&gt; <span class="string">'/www.example.com/example?page=1'</span>, </div><div class="line">        <span class="number">2</span> =&gt; <span class="string">'/www.example.com/example?page=2'</span>,</div><div class="line">        <span class="number">3</span> =&gt; <span class="string">'/www.example.com/example?page=3'</span>,</div><div class="line">        <span class="number">4</span> =&gt; <span class="string">'/www.example.com/example?page=4'</span>,</div><div class="line">        <span class="number">5</span> =&gt; <span class="string">'/www.example.com/example?page=5'</span>,</div><div class="line">        <span class="number">6</span> =&gt; <span class="string">'/www.example.com/example?page=6'</span>,</div><div class="line">        <span class="number">7</span> =&gt; <span class="string">'/www.example.com/example?page=7'</span>,</div><div class="line">        <span class="number">8</span> =&gt; <span class="string">'/www.example.com/example?page=8'</span>,</div><div class="line">    ],                                        <span class="comment">//$window['first']</span></div><div class="line">    ‘...’,                                    <span class="comment">//is_array($window['last']) ? '...' : null</span></div><div class="line">    [</div><div class="line">        <span class="number">21</span> =&gt; <span class="string">'/www.example.com/example?page=21'</span>,</div><div class="line">        <span class="number">22</span> =&gt; <span class="string">'/www.example.com/example?page=22'</span>,</div><div class="line">    ],                                        <span class="comment">//$window['last']</span></div><div class="line">]</div></pre></td></tr></table></figure>
<h3 id="TooCloseToEnding-分页效果"><a href="#TooCloseToEnding-分页效果" class="headerlink" title="TooCloseToEnding 分页效果"></a>TooCloseToEnding 分页效果</h3><p>当前页数位于后 <code>($onEachSide * 2)</code> 页时：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getSliderTooCloseToEnding</span><span class="params">($window)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $last = <span class="keyword">$this</span>-&gt;paginator-&gt;getUrlRange(</div><div class="line">        <span class="keyword">$this</span>-&gt;lastPage() - ($window + <span class="number">2</span>),</div><div class="line">        <span class="keyword">$this</span>-&gt;lastPage()</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">return</span> [</div><div class="line">        <span class="string">'first'</span> =&gt; <span class="keyword">$this</span>-&gt;getStart(),</div><div class="line">        <span class="string">'slider'</span> =&gt; <span class="keyword">null</span>,</div><div class="line">        <span class="string">'last'</span> =&gt; $last,</div><div class="line">    ];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getStart</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;paginator-&gt;getUrlRange(<span class="number">1</span>, <span class="number">2</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>假设我们设置当前两侧页数为 3，当前页为 18，总页数22，函数 <code>getSliderTooCloseToEnding</code> 返回结果为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> [</div><div class="line">    <span class="string">'first'</span> =&gt; [</div><div class="line">        <span class="number">1</span> =&gt; <span class="string">'/www.example.com/example?page=1'</span>, </div><div class="line">        <span class="number">2</span> =&gt; <span class="string">'/www.example.com/example?page=2'</span></div><div class="line">    ],</div><div class="line">    <span class="string">'slider'</span> =&gt; <span class="keyword">null</span>,</div><div class="line">    <span class="string">'last'</span> =&gt; [</div><div class="line">        <span class="number">15</span> =&gt; <span class="string">'/www.example.com/example?page=15'</span>,</div><div class="line">        <span class="number">16</span> =&gt; <span class="string">'/www.example.com/example?page=16'</span>,</div><div class="line">        <span class="number">17</span> =&gt; <span class="string">'/www.example.com/example?page=17'</span>,</div><div class="line">        <span class="number">18</span> =&gt; <span class="string">'/www.example.com/example?page=18'</span>,</div><div class="line">        <span class="number">19</span> =&gt; <span class="string">'/www.example.com/example?page=19'</span>,</div><div class="line">        <span class="number">20</span> =&gt; <span class="string">'/www.example.com/example?page=20'</span>,</div><div class="line">        <span class="number">21</span> =&gt; <span class="string">'/www.example.com/example?page=21'</span>,</div><div class="line">        <span class="number">22</span> =&gt; <span class="string">'/www.example.com/example?page=22'</span>,</div><div class="line">    ],</div><div class="line">];</div></pre></td></tr></table></figure>
<p>这个时候 <code>element</code> 函数返回数据：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">	[</div><div class="line">	    <span class="number">1</span> =&gt; <span class="string">'/www.example.com/example?page=1'</span>, </div><div class="line">	    <span class="number">2</span> =&gt; <span class="string">'/www.example.com/example?page=2'</span></div><div class="line">   ],</div><div class="line">   <span class="string">'...'</span>,</div><div class="line">   [</div><div class="line">   		<span class="number">15</span> =&gt; <span class="string">'/www.example.com/example?page=15'</span>,</div><div class="line">   		<span class="number">16</span> =&gt; <span class="string">'/www.example.com/example?page=16'</span>,</div><div class="line">   		<span class="number">17</span> =&gt; <span class="string">'/www.example.com/example?page=17'</span>,</div><div class="line">   		<span class="number">18</span> =&gt; <span class="string">'/www.example.com/example?page=18'</span>,</div><div class="line">   		<span class="number">19</span> =&gt; <span class="string">'/www.example.com/example?page=19'</span>,</div><div class="line">   		<span class="number">20</span> =&gt; <span class="string">'/www.example.com/example?page=20'</span>,</div><div class="line">   		<span class="number">21</span> =&gt; <span class="string">'/www.example.com/example?page=21'</span>,</div><div class="line">   		<span class="number">22</span> =&gt; <span class="string">'/www.example.com/example?page=22'</span>,</div><div class="line">   ]</div><div class="line">]</div></pre></td></tr></table></figure>
<h3 id="FullSlider-分页效果"><a href="#FullSlider-分页效果" class="headerlink" title="FullSlider 分页效果"></a>FullSlider 分页效果</h3><p>当前页数位于中间时：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getFullSlider</span><span class="params">($onEachSide)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> [</div><div class="line">        <span class="string">'first'</span>  =&gt; <span class="keyword">$this</span>-&gt;getStart(),</div><div class="line">        <span class="string">'slider'</span> =&gt; <span class="keyword">$this</span>-&gt;getAdjacentUrlRange($onEachSide),</div><div class="line">        <span class="string">'last'</span>   =&gt; <span class="keyword">$this</span>-&gt;getFinish(),</div><div class="line">    ];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAdjacentUrlRange</span><span class="params">($onEachSide)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;paginator-&gt;getUrlRange(</div><div class="line">        <span class="keyword">$this</span>-&gt;currentPage() - $onEachSide,</div><div class="line">        <span class="keyword">$this</span>-&gt;currentPage() + $onEachSide</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>假设我们设置当前两侧页数为 3，当前页为 10，总页数22，函数 <code>getFullSlider</code> 返回结果为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> [</div><div class="line">    <span class="string">'first'</span> =&gt; [</div><div class="line">        <span class="number">1</span> =&gt; <span class="string">'/www.example.com/example?page=1'</span>, </div><div class="line">        <span class="number">2</span> =&gt; <span class="string">'/www.example.com/example?page=2'</span></div><div class="line">    ],</div><div class="line">    <span class="string">'slider'</span> =&gt; [</div><div class="line">        <span class="number">7</span> =&gt; <span class="string">'/www.example.com/example?page=7'</span>, </div><div class="line">        <span class="number">8</span> =&gt; <span class="string">'/www.example.com/example?page=8'</span>, </div><div class="line">        <span class="number">9</span> =&gt; <span class="string">'/www.example.com/example?page=9'</span>,</div><div class="line">        <span class="number">10</span> =&gt; <span class="string">'/www.example.com/example?page=10'</span>, </div><div class="line">        <span class="number">11</span> =&gt; <span class="string">'/www.example.com/example?page=11'</span>, </div><div class="line">        <span class="number">12</span> =&gt; <span class="string">'/www.example.com/example?page=12'</span>,</div><div class="line">        <span class="number">13</span> =&gt; <span class="string">'/www.example.com/example?page=13'</span>, </div><div class="line">    ],</div><div class="line">    <span class="string">'last'</span> =&gt; [</div><div class="line">        <span class="number">21</span> =&gt; <span class="string">'/www.example.com/example?page=21'</span>,</div><div class="line">        <span class="number">22</span> =&gt; <span class="string">'/www.example.com/example?page=22'</span>,</div><div class="line">    ],</div><div class="line">];</div></pre></td></tr></table></figure>
<p>这个时候 <code>element</code> 函数返回数据：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">	[</div><div class="line">	    <span class="number">1</span> =&gt; <span class="string">'/www.example.com/example?page=1'</span>, </div><div class="line">	    <span class="number">2</span> =&gt; <span class="string">'/www.example.com/example?page=2'</span></div><div class="line">   ],</div><div class="line">   <span class="string">'...'</span>,</div><div class="line">   [</div><div class="line">       <span class="number">7</span> =&gt; <span class="string">'/www.example.com/example?page=7'</span>, </div><div class="line">       <span class="number">8</span> =&gt; <span class="string">'/www.example.com/example?page=8'</span>, </div><div class="line">       <span class="number">9</span> =&gt; <span class="string">'/www.example.com/example?page=9'</span>,</div><div class="line">       <span class="number">10</span> =&gt; <span class="string">'/www.example.com/example?page=10'</span>, </div><div class="line">       <span class="number">11</span> =&gt; <span class="string">'/www.example.com/example?page=11'</span>, </div><div class="line">       <span class="number">12</span> =&gt; <span class="string">'/www.example.com/example?page=12'</span>,</div><div class="line">       <span class="number">13</span> =&gt; <span class="string">'/www.example.com/example?page=13'</span>,</div><div class="line">   ],</div><div class="line">   <span class="string">'...'</span>,</div><div class="line">   [</div><div class="line">   		<span class="number">21</span> =&gt; <span class="string">'/www.example.com/example?page=21'</span>,</div><div class="line">   		<span class="number">22</span> =&gt; <span class="string">'/www.example.com/example?page=22'</span>,</div><div class="line">   ]</div><div class="line">]</div></pre></td></tr></table></figure>
<h2 id="simplePaginate-简单分页"><a href="#simplePaginate-简单分页" class="headerlink" title="simplePaginate 简单分页"></a>simplePaginate 简单分页</h2><p>简单分页相比以上的功能来说，精简了 <code>elements</code> 的特效：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">simplePaginate</span><span class="params">($perPage = <span class="number">15</span>, $columns = [<span class="string">'*'</span>], $pageName = <span class="string">'page'</span>, $page = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $page = $page ?: Paginator::resolveCurrentPage($pageName);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;skip(($page - <span class="number">1</span>) * $perPage)-&gt;take($perPage + <span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;simplePaginator(<span class="keyword">$this</span>-&gt;get($columns), $perPage, $page, [</div><div class="line">        <span class="string">'path'</span> =&gt; Paginator::resolveCurrentPath(),</div><div class="line">        <span class="string">'pageName'</span> =&gt; $pageName,</div><div class="line">    ]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">simplePaginator</span><span class="params">($items, $perPage, $currentPage, $options)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> Container::getInstance()-&gt;makeWith(Paginator::class, compact(</div><div class="line">        <span class="string">'items'</span>, <span class="string">'perPage'</span>, <span class="string">'currentPage'</span>, <span class="string">'options'</span></div><div class="line">    ));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>分页服务的类不再使用 <code>LengthAwarePaginator</code> 类，而开始使用 <code>Paginator</code>，这两个类最大的不同在于 <code>render</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> $defaultSimpleView = <span class="string">'pagination::simple-default'</span>;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">($view = null, $data = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HtmlString(</div><div class="line">        <span class="keyword">static</span>::viewFactory()-&gt;make($view ?: <span class="keyword">static</span>::$defaultSimpleView, array_merge($data, [</div><div class="line">            <span class="string">'paginator'</span> =&gt; <span class="keyword">$this</span>,</div><div class="line">        ]))-&gt;render()</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>render</code> 函数调用的前端资源默认地址为 <code>illuminate\Pagination\resources\views\simple-default.blade.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">@<span class="keyword">if</span> ($paginator-&gt;hasPages())</div><div class="line">    &lt;ul class="pagination"&gt;</div><div class="line">        &#123;&#123;-- Previous Page Link --&#125;&#125;</div><div class="line">        @<span class="keyword">if</span> ($paginator-&gt;onFirstPage())</div><div class="line">            &lt;li class="disabled"&gt;&lt;span&gt;@lang('pagination.previous')&lt;/span&gt;&lt;/li&gt;</div><div class="line">        @<span class="keyword">else</span></div><div class="line">            &lt;li&gt;&lt;a href=<span class="string">"&#123;&#123; $paginator-&gt;previousPageUrl() &#125;&#125;"</span> rel=<span class="string">"prev"</span>&gt;@lang(<span class="string">'pagination.previous'</span>)&lt;/a&gt;&lt;/li&gt;</div><div class="line">        @<span class="keyword">endif</span></div><div class="line"></div><div class="line">        &#123;&#123;-- Next Page Link --&#125;&#125;</div><div class="line">        @<span class="keyword">if</span> ($paginator-&gt;hasMorePages())</div><div class="line">            &lt;li&gt;&lt;a href=<span class="string">"&#123;&#123; $paginator-&gt;nextPageUrl() &#125;&#125;"</span> rel=<span class="string">"next"</span>&gt;@lang(<span class="string">'pagination.next'</span>)&lt;/a&gt;&lt;/li&gt;</div><div class="line">        @<span class="keyword">else</span></div><div class="line">            &lt;li class="disabled"&gt;&lt;span&gt;@lang('pagination.next')&lt;/span&gt;&lt;/li&gt;</div><div class="line">        @<span class="keyword">endif</span></div><div class="line">    &lt;/ul&gt;</div><div class="line">@<span class="keyword">endif</span></div></pre></td></tr></table></figure>
<p>可以看到，简单分页只有 <code>上一页</code>、<code>下一页</code> 两个按钮。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/09/26/Laravel Database——查询构造器与语法编译器源码分析(中)/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/26/Laravel Database——查询构造器与语法编译器源码分析(中)/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-26T00:33:15+08:00">
                2017-09-26
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/09/26/Laravel Database——查询构造器与语法编译器源码分析(中)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/09/26/Laravel Database——查询构造器与语法编译器源码分析(中)/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/09/26/Laravel Database——查询构造器与语法编译器源码分析(中)/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Laravel-Database——查询构造器与语法编译器源码分析-中"><a href="#Laravel-Database——查询构造器与语法编译器源码分析-中" class="headerlink" title="Laravel Database——查询构造器与语法编译器源码分析(中)"></a>Laravel Database——查询构造器与语法编译器源码分析(中)</h1><h2 id="join-语句"><a href="#join-语句" class="headerlink" title="join 语句"></a>join 语句</h2><p><code>join</code> 语句对数据库进行连接操作，<code>join</code> 函数的连接条件可以非常简单：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'services'</span>)-&gt;select(<span class="string">'*'</span>)-&gt;join(<span class="string">'translations AS t'</span>, <span class="string">'t.item_id'</span>, <span class="string">'='</span>, <span class="string">'services.id'</span>);</div></pre></td></tr></table></figure>
<p>也可以比较复杂：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;select(<span class="string">'*'</span>)-&gt;join(<span class="string">'contacts'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($j)</span> </span>&#123;</div><div class="line">        $j-&gt;on(<span class="string">'users.id'</span>, <span class="string">'='</span>, <span class="string">'contacts.id'</span>)-&gt;orOn(<span class="string">'users.name'</span>, <span class="string">'='</span>, <span class="string">'contacts.name'</span>);</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">//select * from "users" inner join "contacts" on "users"."id" = "contacts"."id" or "users"."name" = "contacts"."name"</span></div><div class="line"></div><div class="line">    $builder = <span class="keyword">$this</span>-&gt;getBuilder();</div><div class="line">    DB::table(<span class="string">'users'</span>)-&gt;select(<span class="string">'*'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;joinWhere(<span class="string">'contacts'</span>, <span class="string">'col1'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($j)</span> </span>&#123;</div><div class="line">        $j-&gt;select(<span class="string">'users.col2'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;where(<span class="string">'users.id'</span>, <span class="string">'='</span>, <span class="string">'foo'</span>)</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">//select * from "users" inner join "contacts" on "col1" = (select "users"."col2" from "users" where "users"."id" = foo)</span></div></pre></td></tr></table></figure>
<p>还可以更加复杂：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;select(<span class="string">'*'</span>)-&gt;leftJoin(<span class="string">'contacts'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($j)</span> </span>&#123;</div><div class="line">        $j-&gt;on(<span class="string">'users.id'</span>, <span class="string">'='</span>, <span class="string">'contacts.id'</span>)-&gt;where(<span class="function"><span class="keyword">function</span> <span class="params">($j)</span> </span>&#123;</div><div class="line">            $j-&gt;where(<span class="string">'contacts.country'</span>, <span class="string">'='</span>, <span class="string">'US'</span>)-&gt;orWhere(<span class="string">'contacts.is_partner'</span>, <span class="string">'='</span>, <span class="number">1</span>);</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">//select * from "users" left join "contacts" on "users"."id" = "contacts"."id" and ("contacts"."country" = 'US' or "contacts"."is_partner" = 1)</span></div><div class="line"></div><div class="line">    DB::table(<span class="string">'users'</span>)-&gt;select(<span class="string">'*'</span>)-&gt;leftJoin(<span class="string">'contacts'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($j)</span> </span>&#123;</div><div class="line">        $j-&gt;on(<span class="string">'users.id'</span>, <span class="string">'='</span>, <span class="string">'contacts.id'</span>)-&gt;where(<span class="string">'contacts.is_active'</span>, <span class="string">'='</span>, <span class="number">1</span>)-&gt;orOn(<span class="function"><span class="keyword">function</span> <span class="params">($j)</span> </span>&#123;</div><div class="line">            $j-&gt;orWhere(<span class="function"><span class="keyword">function</span> <span class="params">($j)</span> </span>&#123;</div><div class="line">                $j-&gt;where(<span class="string">'contacts.country'</span>, <span class="string">'='</span>, <span class="string">'UK'</span>)-&gt;orOn(<span class="string">'contacts.type'</span>, <span class="string">'='</span>, <span class="string">'users.type'</span>);</div><div class="line">            &#125;)-&gt;where(<span class="function"><span class="keyword">function</span> <span class="params">($j)</span> </span>&#123;</div><div class="line">                $j-&gt;where(<span class="string">'contacts.country'</span>, <span class="string">'='</span>, <span class="string">'US'</span>)-&gt;orWhereNull(<span class="string">'contacts.is_partner'</span>);</div><div class="line">            &#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">//select * from "users" left join "contacts" on "users"."id" = "contacts"."id" and "contacts"."is_active" = 1 or (("contacts"."country" = 'UK' or "contacts"."type" = "users"."type") and ("contacts"."country" = 'US' or "contacts"."is_partner" is null))</span></div></pre></td></tr></table></figure>
<p>其实 <code>join</code> 语句与 <code>where</code> 语句非常相似，将 <code>join</code> 语句的连接条件看作 <code>where</code> 的查询条件完全可以，接下来我们看看源码。</p>
<h3 id="join-语句-1"><a href="#join-语句-1" class="headerlink" title="join 语句"></a>join 语句</h3><p>从上面的示例代码可以看出，<code>join</code> 函数的参数多变，第二个参数可以是列名，也有可能是闭包函数。当第二个参数是列名的时候，第三个参数可以是闭包，还可以是符号 <code>=</code>、<code>&gt;=</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">join</span><span class="params">($table, $first, $operator = null, $second = null, $type = <span class="string">'inner'</span>, $where = false)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $join = <span class="keyword">new</span> JoinClause(<span class="keyword">$this</span>, $type, $table);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($first <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">        call_user_func($first, $join);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;joins[] = $join;</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;addBinding($join-&gt;getBindings(), <span class="string">'join'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        $method = $where ? <span class="string">'where'</span> : <span class="string">'on'</span>;</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;joins[] = $join-&gt;$method($first, $operator, $second);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;addBinding($join-&gt;getBindings(), <span class="string">'join'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，程序首先新建了一个 <code>JoinClause</code> 类对象，这个类实际上继承 <code>queryBuilder</code>，也就是说 <code>queryBuilder</code> 上的很多方法它都可以直接用，例如 <code>where</code>、<code>whereNull</code>、<code>whereDate</code> 等等。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JoinClause</span> <span class="keyword">extends</span> <span class="title">Builder</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果第二个参数是闭包函数的话，就会像查询组一样根据查询条件更新 <code>$join</code>。</p>
<p>如果第二个参数是列名，那么就会调用 <code>on</code> 方法或 <code>where</code> 方法。这两个方法的区别是，<code>on</code> 方法只支持 <code>whereColumn</code>方法和 <code>whereNested</code>，也就是说只能写出 <code>join on col1 = col2</code> 这样的语句，而 <code>where</code> 方法可以传递数组、子查询等等.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">on</span><span class="params">($first, $operator = null, $second = null, $boolean = <span class="string">'and'</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> ($first <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;whereNested($first, $boolean);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;whereColumn($first, $operator, $second, $boolean);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">orOn</span><span class="params">($first, $operator = null, $second = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;on($first, $operator, $second, <span class="string">'or'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="grammer——compileJoins"><a href="#grammer——compileJoins" class="headerlink" title="grammer——compileJoins"></a>grammer——compileJoins</h3><p>接下来我们来看看如何编译 <code>join</code> 语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileJoins</span><span class="params">(Builder $query, $joins)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> collect($joins)-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($join)</span> <span class="title">use</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">        $table = <span class="keyword">$this</span>-&gt;wrapTable($join-&gt;table);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> trim(<span class="string">"&#123;$join-&gt;type&#125; join &#123;$table&#125; &#123;$this-&gt;compileWheres($join)&#125;"</span>);</div><div class="line">    &#125;)-&gt;implode(<span class="string">' '</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，<code>JoinClause</code> 在编译中是作为 <code>queryBuild</code> 对象来看待的。</p>
<h2 id="union-语句"><a href="#union-语句" class="headerlink" title="union 语句"></a>union 语句</h2><p><code>union</code> 用于合并两个或多个 <code>SELECT</code> 语句的结果集。<code>Union</code> 因为要进行重复值扫描，所以效率低。如果合并没有刻意要删除重复行，那么就使用 <code>Union All</code>。</p>
<p>我们在 <code>laravel</code> 中可以这样使用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$query = DB::table(<span class="string">'users'</span>)-&gt;select(<span class="string">'*'</span>)-&gt;where(<span class="string">'id'</span>, <span class="string">'='</span>, <span class="number">1</span>);</div><div class="line">$query-&gt;union(DB::table(<span class="string">'users'</span>)-&gt;select(<span class="string">'*'</span>)-&gt;where(<span class="string">'id'</span>, <span class="string">'='</span>, <span class="number">2</span>));</div><div class="line"><span class="comment">//(select * from `users` where `id` = 1) union (select * from `users` where `id` = 2)</span></div><div class="line">```  </div><div class="line">还可以添加多个 `union` 语句：</div><div class="line"></div><div class="line">```php</div><div class="line">$query = DB::table(<span class="string">'users'</span>)-&gt;select(<span class="string">'*'</span>)-&gt;where(<span class="string">'id'</span>, <span class="string">'='</span>, <span class="number">1</span>);</div><div class="line">$query-&gt;union(DB::table(<span class="string">'users'</span>)-&gt;select(<span class="string">'*'</span>)-&gt;where(<span class="string">'id'</span>, <span class="string">'='</span>, <span class="number">2</span>));</div><div class="line">$query-&gt;union(DB::table(<span class="string">'users'</span>)-&gt;select(<span class="string">'*'</span>)-&gt;where(<span class="string">'id'</span>, <span class="string">'='</span>, <span class="number">3</span>));      </div><div class="line"><span class="comment">//(select * from "users" where "id" = 1) union (select * from "users" where "id" = 2) union (select * from "users" where "id" = 3)</span></div></pre></td></tr></table></figure>
<p><code>union</code> 语句可以与 <code>orderBy</code> 相结合：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$query = DB::table(<span class="string">'users'</span>)-&gt;select(<span class="string">'*'</span>)-&gt;where(<span class="string">'id'</span>, <span class="string">'='</span>, <span class="number">1</span>);</div><div class="line">$query-&gt;union(DB::table(<span class="string">'users'</span>)-&gt;select(<span class="string">'*'</span>)-&gt;where(<span class="string">'id'</span>, <span class="string">'='</span>, <span class="number">2</span>));</div><div class="line">$query-&gt;orderBy(<span class="string">'id'</span>, <span class="string">'desc'</span>);</div><div class="line"><span class="comment">//(select * from `users` where `id` = ?) union (select * from `users` where `id` = ?) order by `id` desc</span></div></pre></td></tr></table></figure>
<p><code>union</code> 语句可以与 <code>limit</code>、<code>offset</code> 相结合：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$query = DB::table(<span class="string">'users'</span>)-&gt;select(<span class="string">'*'</span>);</div><div class="line">$query-&gt;union(DB::table(<span class="string">'users'</span>)-&gt;select(<span class="string">'*'</span>));</div><div class="line">$builder-&gt;skip(<span class="number">5</span>)-&gt;take(<span class="number">10</span>);</div><div class="line"><span class="comment">//(select * from `users`) union (select * from `dogs`) limit 10 offset 5</span></div></pre></td></tr></table></figure>
<h3 id="union-函数"><a href="#union-函数" class="headerlink" title="union 函数"></a>union 函数</h3><p><code>union</code> 函数比较简单：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">union</span><span class="params">($query, $all = false)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> ($query <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">        call_user_func($query, $query = <span class="keyword">$this</span>-&gt;newQuery());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;unions[] = compact(<span class="string">'query'</span>, <span class="string">'all'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;addBinding($query-&gt;getBindings(), <span class="string">'union'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="grammer——compileUnions"><a href="#grammer——compileUnions" class="headerlink" title="grammer——compileUnions"></a>grammer——compileUnions</h3><p>语法编译器对 <code>union</code> 的处理：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">compileSelect</span><span class="params">(Builder $query)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $sql = <span class="keyword">parent</span>::compileSelect($query);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($query-&gt;unions) &#123;</div><div class="line">        $sql = <span class="string">'('</span>.$sql.<span class="string">') '</span>.<span class="keyword">$this</span>-&gt;compileUnions($query);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $sql;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileUnions</span><span class="params">(Builder $query)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $sql = <span class="string">''</span>;</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> ($query-&gt;unions <span class="keyword">as</span> $union) &#123;</div><div class="line">        $sql .= <span class="keyword">$this</span>-&gt;compileUnion($union);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>($query-&gt;unionOrders)) &#123;</div><div class="line">        $sql .= <span class="string">' '</span>.<span class="keyword">$this</span>-&gt;compileOrders($query, $query-&gt;unionOrders);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($query-&gt;unionLimit)) &#123;</div><div class="line">        $sql .= <span class="string">' '</span>.<span class="keyword">$this</span>-&gt;compileLimit($query, $query-&gt;unionLimit);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($query-&gt;unionOffset)) &#123;</div><div class="line">        $sql .= <span class="string">' '</span>.<span class="keyword">$this</span>-&gt;compileOffset($query, $query-&gt;unionOffset);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ltrim($sql);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileUnion</span><span class="params">(array $union)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $conjuction = $union[<span class="string">'all'</span>] ? <span class="string">' union all '</span> : <span class="string">' union '</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $conjuction.<span class="string">'('</span>.$union[<span class="string">'query'</span>]-&gt;toSql().<span class="string">')'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，<code>union</code> 的处理比较简单，都是调用 <code>query-&gt;toSql</code> 语句而已。值得注意的是，在处理 <code>union</code> 的时候，要特别处理 <code>order</code>、<code>limit</code>、<code>offset</code>。</p>
<h2 id="orderBy-语句"><a href="#orderBy-语句" class="headerlink" title="orderBy 语句"></a>orderBy 语句</h2><p>orderBy 语句用法很简单，可以设置多个排序字段，也可以用原生排序语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;select(<span class="string">'*'</span>)-&gt;orderBy(<span class="string">'email'</span>)-&gt;orderBy(<span class="string">'age'</span>, <span class="string">'desc'</span>);</div><div class="line"></div><div class="line">DB::table(<span class="string">'users'</span>)-&gt;select(<span class="string">'*'</span>)-&gt;orderBy(<span class="string">'email'</span>)-&gt;orderByRaw(<span class="string">'age desc'</span>);</div></pre></td></tr></table></figure>
<h3 id="orderBy-函数"><a href="#orderBy-函数" class="headerlink" title="orderBy 函数"></a>orderBy 函数</h3><p>如果当前查询中有 <code>union</code> 的话，排序的变量会被放入 <code>unionOrders</code> 数组中，这个数组只有在 <code>compileUnions</code> 函数中才会被编译成 <code>sql</code> 语句。否则会被放入 <code>orders</code> 数组中，这时会被 <code>compileOrders</code> 处理：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">orderBy</span><span class="params">($column, $direction = <span class="string">'asc'</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;unions ? <span class="string">'unionOrders'</span> : <span class="string">'orders'</span>&#125;[] = [</div><div class="line">        <span class="string">'column'</span> =&gt; $column,</div><div class="line">        <span class="string">'direction'</span> =&gt; strtolower($direction) == <span class="string">'asc'</span> ? <span class="string">'asc'</span> : <span class="string">'desc'</span>,</div><div class="line">    ];</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="grammer——compileOrders"><a href="#grammer——compileOrders" class="headerlink" title="grammer——compileOrders"></a>grammer——compileOrders</h3><p>orderBy 的编译也很简单：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileOrders</span><span class="params">(Builder $query, $orders)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>($orders)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'order by '</span>.implode(<span class="string">', '</span>, <span class="keyword">$this</span>-&gt;compileOrdersToArray($query, $orders));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">''</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileOrdersToArray</span><span class="params">(Builder $query, $orders)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> array_map(<span class="function"><span class="keyword">function</span> <span class="params">($order)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> ! <span class="keyword">isset</span>($order[<span class="string">'sql'</span>])</div><div class="line">                    ? <span class="keyword">$this</span>-&gt;wrap($order[<span class="string">'column'</span>]).<span class="string">' '</span>.$order[<span class="string">'direction'</span>]</div><div class="line">                    : $order[<span class="string">'sql'</span>];</div><div class="line">    &#125;, $orders);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="limit-offset-forPage-语句"><a href="#limit-offset-forPage-语句" class="headerlink" title="limit offset forPage 语句"></a>limit offset forPage 语句</h2><p>limit offset 或者 skip take 用法很简单，有趣的是，<code>laravel</code> 考虑了负数的情况：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">DB::select(<span class="string">'*'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;offset(<span class="number">5</span>)-&gt;limit(<span class="number">10</span>);</div><div class="line"></div><div class="line">DB::select(<span class="string">'*'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;skip(<span class="number">5</span>)-&gt;take(<span class="number">10</span>);</div><div class="line"></div><div class="line">DB::select(<span class="string">'*'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;skip(<span class="number">-5</span>)-&gt;take(<span class="number">-10</span>);</div><div class="line"></div><div class="line">DB::select(<span class="string">'*'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;forPage(<span class="number">5</span>, <span class="number">10</span>);</div></pre></td></tr></table></figure>
<h3 id="limit-offset-函数"><a href="#limit-offset-函数" class="headerlink" title="limit offset 函数"></a>limit offset 函数</h3><p>和 orderBy 一样，如果当前查询中有 <code>union</code> 的话，limit / offset 会被放入 unionLimit / unionOffset 中，在编译 union 的时候解析：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">take</span><span class="params">($value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;limit($value);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">limit</span><span class="params">($value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $property = <span class="keyword">$this</span>-&gt;unions ? <span class="string">'unionLimit'</span> : <span class="string">'limit'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($value &gt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;$property = $value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">skip</span><span class="params">($value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;offset($value);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offset</span><span class="params">($value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $property = <span class="keyword">$this</span>-&gt;unions ? <span class="string">'unionOffset'</span> : <span class="string">'offset'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;$property = max(<span class="number">0</span>, $value);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">forPage</span><span class="params">($page, $perPage = <span class="number">15</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;skip(($page - <span class="number">1</span>) * $perPage)-&gt;take($perPage);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="grammer——compileLimit-compileOffset"><a href="#grammer——compileLimit-compileOffset" class="headerlink" title="grammer——compileLimit compileOffset"></a>grammer——compileLimit compileOffset</h3><p>这个不能再简单了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileLimit</span><span class="params">(Builder $query, $limit)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'limit '</span>.(int) $limit;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileOffset</span><span class="params">(Builder $query, $offset)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'offset '</span>.(int) $offset;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="group-语句"><a href="#group-语句" class="headerlink" title="group 语句"></a>group 语句</h2><p><code>groupBy</code> 语句的参数形式有多种： </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">DB::select(<span class="string">'*'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;groupBy(<span class="string">'email'</span>);</div><div class="line"></div><div class="line">DB::select(<span class="string">'*'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;groupBy(<span class="string">'id'</span>, <span class="string">'email'</span>);</div><div class="line"></div><div class="line">DB::select(<span class="string">'*'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;groupBy([<span class="string">'id'</span>, <span class="string">'email'</span>]);</div><div class="line"></div><div class="line">DB::select(<span class="string">'*'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;groupBy(<span class="keyword">new</span> Raw(<span class="string">'DATE(created_at)'</span>));</div></pre></td></tr></table></figure>
<p><code>groupBy</code> 函数很简单，仅仅是为 <code>$this-&gt;groups</code> 成员变量合并数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">groupBy</span><span class="params">(...$groups)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">foreach</span> ($groups <span class="keyword">as</span> $group) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;groups = array_merge(</div><div class="line">            (<span class="keyword">array</span>) <span class="keyword">$this</span>-&gt;groups,</div><div class="line">            Arr::wrap($group)</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>语法编译器的处理：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileGroups</span><span class="params">(Builder $query, $groups)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'group by '</span>.<span class="keyword">$this</span>-&gt;columnize($groups);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="having-语句"><a href="#having-语句" class="headerlink" title="having 语句"></a>having 语句</h2><p><code>having</code> 语句的用法也很简单。大致有 <code>having</code>、<code>orHaving</code>、<code>havingRaw</code>、<code>orHavingRaw</code> 这几个函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">DB::select(<span class="string">'*'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;having(<span class="string">'email'</span>, <span class="string">'&gt;'</span>, <span class="number">1</span>);</div><div class="line"></div><div class="line">DB::select(<span class="string">'*'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;groupBy(<span class="string">'email'</span>)-&gt;having(<span class="string">'email'</span>, <span class="string">'&gt;'</span>, <span class="number">1</span>);</div><div class="line"></div><div class="line">DB::select(<span class="string">'*'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;having(<span class="string">'email'</span>, <span class="number">1</span>)-&gt;orHaving(<span class="string">'email'</span>, <span class="number">2</span>);</div><div class="line"></div><div class="line">DB::select(<span class="string">'*'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;havingRaw(<span class="string">'user_foo &lt; user_bar'</span>);</div><div class="line"></div><div class="line">DB::select(<span class="string">'*'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;having(<span class="string">'baz'</span>, <span class="string">'='</span>, <span class="number">1</span>)-&gt;orHavingRaw(<span class="string">'user_foo &lt; user_bar'</span>);</div></pre></td></tr></table></figure>
<h3 id="having-函数"><a href="#having-函数" class="headerlink" title="having 函数"></a>having 函数</h3><p><code>having</code> 函数大致与 <code>whereColumn</code> 相同：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">having</span><span class="params">($column, $operator = null, $value = null, $boolean = <span class="string">'and'</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $type = <span class="string">'Basic'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">list</span>($value, $operator) = <span class="keyword">$this</span>-&gt;prepareValueAndOperator(</div><div class="line">        $value, $operator, func_num_args() == <span class="number">2</span></div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;invalidOperator($operator)) &#123;</div><div class="line">        <span class="keyword">list</span>($value, $operator) = [$operator, <span class="string">'='</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;havings[] = compact(<span class="string">'type'</span>, <span class="string">'column'</span>, <span class="string">'operator'</span>, <span class="string">'value'</span>, <span class="string">'boolean'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! $value <span class="keyword">instanceof</span> Expression) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;addBinding($value, <span class="string">'having'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>havingRaw</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">havingRaw</span><span class="params">($sql, array $bindings = [], $boolean = <span class="string">'and'</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $type = <span class="string">'Raw'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;havings[] = compact(<span class="string">'type'</span>, <span class="string">'sql'</span>, <span class="string">'boolean'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;addBinding($bindings, <span class="string">'having'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="grammer——compileHavings"><a href="#grammer——compileHavings" class="headerlink" title="grammer——compileHavings"></a>grammer——compileHavings</h3><p>语法编译器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileHavings</span><span class="params">(Builder $query, $havings)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $sql = implode(<span class="string">' '</span>, array_map([<span class="keyword">$this</span>, <span class="string">'compileHaving'</span>], $havings));</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">'having '</span>.<span class="keyword">$this</span>-&gt;removeLeadingBoolean($sql);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileHaving</span><span class="params">(array $having)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> ($having[<span class="string">'type'</span>] === <span class="string">'Raw'</span>) &#123;</div><div class="line">        <span class="keyword">return</span> $having[<span class="string">'boolean'</span>].<span class="string">' '</span>.$having[<span class="string">'sql'</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;compileBasicHaving($having);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileBasicHaving</span><span class="params">($having)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $column = <span class="keyword">$this</span>-&gt;wrap($having[<span class="string">'column'</span>]);</div><div class="line"></div><div class="line">    $parameter = <span class="keyword">$this</span>-&gt;parameter($having[<span class="string">'value'</span>]);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $having[<span class="string">'boolean'</span>].<span class="string">' '</span>.$column.<span class="string">' '</span>.$having[<span class="string">'operator'</span>].<span class="string">' '</span>.$parameter;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="when-tap-unless-语句"><a href="#when-tap-unless-语句" class="headerlink" title="when / tap / unless 语句"></a>when / tap / unless 语句</h2><p><code>when</code> 语句可以根据条件来判断是否执行查询条件，<code>unless</code> 与 <code>when</code> 相反，第一个参数是 <code>false</code> 才会调用闭包函数执行查询，<code>tap</code> 指定 <code>when</code> 的第一参数永远为真：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$callback = <span class="function"><span class="keyword">function</span> <span class="params">($query, $condition)</span> </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals($condition, <span class="string">'truthy'</span>);</div><div class="line"></div><div class="line">    $query-&gt;where(<span class="string">'id'</span>, <span class="string">'='</span>, <span class="number">1</span>);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">$default = <span class="function"><span class="keyword">function</span> <span class="params">($query, $condition)</span> </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals($condition, <span class="number">0</span>);</div><div class="line"></div><div class="line">    $query-&gt;where(<span class="string">'id'</span>, <span class="string">'='</span>, <span class="number">2</span>);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">DB::select(<span class="string">'*'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;when(<span class="string">'truthy'</span>, $callback, $default)-&gt;where(<span class="string">'email'</span>, <span class="string">'foo'</span>);</div><div class="line"></div><div class="line">DB::select(<span class="string">'*'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;tap($callback)-&gt;where(<span class="string">'email'</span>, <span class="string">'foo'</span>);</div><div class="line"></div><div class="line">DB::select(<span class="string">'*'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;unless(<span class="string">'truthy'</span>, $callback, $default)-&gt;where(<span class="string">'email'</span>, <span class="string">'foo'</span>);</div></pre></td></tr></table></figure>
<p><code>when</code>、<code>unless</code>、<code>tap</code> 函数的实现：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">when</span><span class="params">($value, $callback, $default = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> ($value) &#123;</div><div class="line">        <span class="keyword">return</span> $callback(<span class="keyword">$this</span>, $value) ?: <span class="keyword">$this</span>;</div><div class="line">    &#125; <span class="keyword">elseif</span> ($default) &#123;</div><div class="line">        <span class="keyword">return</span> $default(<span class="keyword">$this</span>, $value) ?: <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unless</span><span class="params">($value, $callback, $default = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! $value) &#123;</div><div class="line">        <span class="keyword">return</span> $callback(<span class="keyword">$this</span>, $value) ?: <span class="keyword">$this</span>;</div><div class="line">    &#125; <span class="keyword">elseif</span> ($default) &#123;</div><div class="line">        <span class="keyword">return</span> $default(<span class="keyword">$this</span>, $value) ?: <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tap</span><span class="params">($callback)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;when(<span class="keyword">true</span>, $callback);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Aggregate-查询"><a href="#Aggregate-查询" class="headerlink" title="Aggregate 查询"></a>Aggregate 查询</h2><p>聚合方法也是 sql 的重要组成部分，<code>laravel</code> 提供 <code>count</code>、<code>max</code>、<code>min</code>、<code>avg</code>、<code>sum</code>、<code>exist</code> 等聚合方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;count();<span class="comment">//select count(*) as aggregate from "users"</span></div><div class="line"></div><div class="line">DB::table(<span class="string">'users'</span>)-&gt;max(<span class="string">'id'</span>);<span class="comment">//select max("id") as aggregate from "users"</span></div><div class="line"></div><div class="line">DB::table(<span class="string">'users'</span>)-&gt;min(<span class="string">'id'</span>);<span class="comment">//select min("id") as aggregate from "users"</span></div><div class="line"></div><div class="line">DB::table(<span class="string">'users'</span>)-&gt;sum(<span class="string">'id'</span>);<span class="comment">//select sum("id") as aggregate from "users"</span></div><div class="line"></div><div class="line">DB::table(<span class="string">'users'</span>)-&gt;exists();<span class="comment">//select exists(select * from "users") as "exists"</span></div></pre></td></tr></table></figure>
<p>这些聚合函数实际上都是调用 <code>aggregate</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">count</span><span class="params">($columns = <span class="string">'*'</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> (int) <span class="keyword">$this</span>-&gt;aggregate(<span class="keyword">__FUNCTION__</span>, Arr::wrap($columns));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">aggregate</span><span class="params">($function, $columns = [<span class="string">'*'</span>])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $results = <span class="keyword">$this</span>-&gt;cloneWithout([<span class="string">'columns'</span>])</div><div class="line">                    -&gt;cloneWithoutBindings([<span class="string">'select'</span>])</div><div class="line">                    -&gt;setAggregate($function, $columns)</div><div class="line">                    -&gt;get($columns);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! $results-&gt;isEmpty()) &#123;</div><div class="line">        <span class="keyword">return</span> array_change_key_case((<span class="keyword">array</span>) $results[<span class="number">0</span>])[<span class="string">'aggregate'</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出来，<code>aggregate</code> 函数复制了一份 <code>queryBuilder</code>，只是缺少了 <code>select</code>、<code>bingding</code> 成员变量:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">cloneWithout</span><span class="params">(array $properties)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> tap(<span class="keyword">clone</span> <span class="keyword">$this</span>, <span class="function"><span class="keyword">function</span> <span class="params">($clone)</span> <span class="title">use</span> <span class="params">($properties)</span> </span>&#123;</div><div class="line">        <span class="keyword">foreach</span> ($properties <span class="keyword">as</span> $property) &#123;</div><div class="line">            $clone-&gt;&#123;$property&#125; = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">cloneWithoutBindings</span><span class="params">(array $except)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> tap(<span class="keyword">clone</span> <span class="keyword">$this</span>, <span class="function"><span class="keyword">function</span> <span class="params">($clone)</span> <span class="title">use</span> <span class="params">($except)</span> </span>&#123;</div><div class="line">        <span class="keyword">foreach</span> ($except <span class="keyword">as</span> $type) &#123;</div><div class="line">            $clone-&gt;bindings[$type] = [];</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setAggregate</span><span class="params">($function, $columns)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;aggregate = compact(<span class="string">'function'</span>, <span class="string">'columns'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;groups)) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;orders = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;bindings[<span class="string">'order'</span>] = [];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>exist</code> 聚合函数和其他不一样，它的流程与 <code>whereExist</code> 大致相同：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exists</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $results = <span class="keyword">$this</span>-&gt;connection-&gt;select(</div><div class="line">        <span class="keyword">$this</span>-&gt;grammar-&gt;compileExists(<span class="keyword">$this</span>), <span class="keyword">$this</span>-&gt;getBindings(), ! <span class="keyword">$this</span>-&gt;useWritePdo</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($results[<span class="number">0</span>])) &#123;</div><div class="line">        $results = (<span class="keyword">array</span>) $results[<span class="number">0</span>];</div><div class="line"></div><div class="line">        <span class="keyword">return</span> (bool) $results[<span class="string">'exists'</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="grammer——compileAggregate"><a href="#grammer——compileAggregate" class="headerlink" title="grammer——compileAggregate"></a>grammer——compileAggregate</h3><p><code>laravel</code> 的聚合函数具有独占性，也就是说调用聚合函数后，不能再 <code>select</code> 其他的列:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileAggregate</span><span class="params">(Builder $query, $aggregate)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $column = <span class="keyword">$this</span>-&gt;columnize($aggregate[<span class="string">'columns'</span>]);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($query-&gt;distinct &amp;&amp; $column !== <span class="string">'*'</span>) &#123;</div><div class="line">        $column = <span class="string">'distinct '</span>.$column;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">'select '</span>.$aggregate[<span class="string">'function'</span>].<span class="string">'('</span>.$column.<span class="string">') as aggregate'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileColumns</span><span class="params">(Builder $query, $columns)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! is_null($query-&gt;aggregate)) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $select = $query-&gt;distinct ? <span class="string">'select distinct '</span> : <span class="string">'select '</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $select.<span class="keyword">$this</span>-&gt;columnize($columns);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，如果存在聚合函数，那么编译 <code>select</code> 的 <code>compileColumns</code> 函数将不会运行。</p>
<h2 id="first-find-value-pluck-implode"><a href="#first-find-value-pluck-implode" class="headerlink" title="first / find / value / pluck / implode"></a>first / find / value / pluck / implode</h2><p>从数据库中取出后数据，我们可以使用 <code>laravel</code> 提供给我们的一些函数进行包装处理。</p>
<p><code>first</code> 函数可以让我们只查询第一条：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'id'</span>, <span class="string">'='</span>, <span class="number">1</span>)-&gt;first();</div></pre></td></tr></table></figure>
<p><code>find</code> 函数，可以利用数据库表的主键来查询第一条：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(&apos;users&apos;)-&gt;find(1);</div></pre></td></tr></table></figure>
<p><code>pluck</code> 函数可以取查询记录的某一列：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'id'</span>, <span class="string">'='</span>, <span class="number">1</span>)-&gt;pluck(<span class="string">'foo'</span>);/[<span class="string">'bar'</span>, <span class="string">'baz'</span>]</div></pre></td></tr></table></figure>
<p><code>pluck</code> 函数取查询记录的某一列的同时，还可以设置列名的 <code>key</code>： </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'id'</span>, <span class="string">'='</span>, <span class="number">1</span>)-&gt;pluck(<span class="string">'foo'</span>, <span class="string">'id'</span>);<span class="comment">//[1 =&gt; 'bar', 10 =&gt; 'baz']</span></div></pre></td></tr></table></figure>
<p><code>value</code> 函数可以取第一条数据的某一列：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'id'</span>, <span class="string">'='</span>, <span class="number">1</span>)-&gt;value(<span class="string">'foo'</span>);<span class="comment">//bar</span></div></pre></td></tr></table></figure>
<p><code>implode</code> 函数可以将多条数据的某一列拼成字符串：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'id'</span>, <span class="string">'='</span>, <span class="number">1</span>)-&gt;implode(<span class="string">'foo'</span>, <span class="string">','</span>);<span class="comment">//'bar,baz'</span></div></pre></td></tr></table></figure>
<h3 id="first-函数"><a href="#first-函数" class="headerlink" title="first 函数"></a>first 函数</h3><p><code>find</code> 函数，使用了 <code>limit 1</code> 的 <code>sql</code> 语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">first</span><span class="params">($columns = [<span class="string">'*'</span>])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;take(<span class="number">1</span>)-&gt;get($columns)-&gt;first();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="find-函数"><a href="#find-函数" class="headerlink" title="find 函数"></a>find 函数</h3><p><code>find</code> 函数实际利用主键调用 <code>first</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">find</span><span class="params">($id, $columns = [<span class="string">'*'</span>])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;where(<span class="string">'id'</span>, <span class="string">'='</span>, $id)-&gt;first($columns);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="pluck-函数"><a href="#pluck-函数" class="headerlink" title="pluck 函数"></a>pluck 函数</h3><p><code>pluck</code> 函数主要对得到的数据调用 <code>pluck</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pluck</span><span class="params">($column, $key = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $results = <span class="keyword">$this</span>-&gt;get(is_null($key) ? [$column] : [$column, $key]);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $results-&gt;pluck(</div><div class="line">        <span class="keyword">$this</span>-&gt;stripTableForPluck($column),</div><div class="line">        <span class="keyword">$this</span>-&gt;stripTableForPluck($key)</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="implod-函数"><a href="#implod-函数" class="headerlink" title="implod 函数"></a>implod 函数</h3><p><code>implod</code> 函数对一维数组调用 <code>implod</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">implode</span><span class="params">($column, $glue = <span class="string">''</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;pluck($column)-&gt;implode($glue);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="chunk-语句"><a href="#chunk-语句" class="headerlink" title="chunk 语句"></a>chunk 语句</h2><p>如果你需要操作数千条数据库记录，可以考虑使用 chunk 方法。这个方法每次只取出一小块结果，并会将每个块传递给一个闭包处理。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;orderBy(<span class="string">'id'</span>)-&gt;chunk(<span class="number">100</span>, <span class="function"><span class="keyword">function</span> <span class="params">($users)</span> </span>&#123;</div><div class="line">    <span class="keyword">foreach</span> ($users <span class="keyword">as</span> $user) &#123;</div><div class="line">        <span class="comment">//</span></div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>你可以从 闭包 中返回 false，以停止对后续分块的处理：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;orderBy(<span class="string">'id'</span>)-&gt;chunk(<span class="number">100</span>, <span class="function"><span class="keyword">function</span> <span class="params">($users)</span> </span>&#123;</div><div class="line">    <span class="comment">// Process the records...</span></div><div class="line">    <span class="keyword">if</span> (...) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125; </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>如果不想按照主键 id 来进行分块，我们还可以自定义分块主键：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;orderBy(<span class="string">'id'</span>)-&gt;chunkById(<span class="number">100</span>, <span class="function"><span class="keyword">function</span> <span class="params">($users)</span> </span>&#123;</div><div class="line">    <span class="keyword">foreach</span> ($users <span class="keyword">as</span> $user) &#123;</div><div class="line">        <span class="comment">//</span></div><div class="line">    &#125;</div><div class="line">&#125;, <span class="string">'someIdField'</span>);</div></pre></td></tr></table></figure>
<h3 id="chunk-函数"><a href="#chunk-函数" class="headerlink" title="chunk 函数"></a>chunk 函数</h3><p><code>chunk</code> 函数的实现实际上是 <code>forPage</code> 函数，当从数据库获得数据后，先判断是否拿到了数据，如果拿到了就会继续执行闭包函数，否则就会中断程序。执行闭包函数后，需要判断返回状态。若取出的数据小于分块的条数，说明数据已经全部获取完毕，结束程序。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">chunk</span><span class="params">($count, callable $callback)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;enforceOrderBy();</div><div class="line"></div><div class="line">    $page = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        $results = <span class="keyword">$this</span>-&gt;forPage($page, $count)-&gt;get();</div><div class="line"></div><div class="line">        $countResults = $results-&gt;count();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ($countResults == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ($callback($results, $page) === <span class="keyword">false</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">unset</span>($results);</div><div class="line"></div><div class="line">        $page++;</div><div class="line">    &#125; <span class="keyword">while</span> ($countResults == $count);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">enforceOrderBy</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;query-&gt;orders) &amp;&amp; <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;query-&gt;unionOrders)) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;orderBy(<span class="keyword">$this</span>-&gt;model-&gt;getQualifiedKeyName(), <span class="string">'asc'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>enforceOrderBy</code> 函数是用于数据按照主键的大小进行排序。</p>
<h3 id="chunkById-函数"><a href="#chunkById-函数" class="headerlink" title="chunkById 函数"></a>chunkById 函数</h3><p>chunkById 函数与 chunk 函数唯一不同的是 <code>forPage</code> 函数被换成了 <code>forPageAfterId</code> 函数，目的是替换主键：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">chunkById</span><span class="params">($count, callable $callback, $column = <span class="string">'id'</span>, $alias = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $alias = $alias ?: $column;</div><div class="line"></div><div class="line">    $lastId = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        $clone = <span class="keyword">clone</span> <span class="keyword">$this</span>;</div><div class="line"></div><div class="line">        $results = $clone-&gt;forPageAfterId($count, $lastId, $column)-&gt;get();</div><div class="line"></div><div class="line">        $countResults = $results-&gt;count();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ($countResults == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ($callback($results) === <span class="keyword">false</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $lastId = $results-&gt;last()-&gt;&#123;$alias&#125;;</div><div class="line"></div><div class="line">        <span class="keyword">unset</span>($results);</div><div class="line">    &#125; <span class="keyword">while</span> ($countResults == $count);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>forPageAfterId</code> 函数实际上是把 <code>offset</code> 函数删除，并按照自定义的列来排序，每次获取最后一条数据的自定义列的数值，利用 <code>where</code> 条件不断获取下一部分分块数据：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">forPageAfterId</span><span class="params">($perPage = <span class="number">15</span>, $lastId = <span class="number">0</span>, $column = <span class="string">'id'</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;orders = <span class="keyword">$this</span>-&gt;removeExistingOrdersFor($column);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;where($column, <span class="string">'&gt;'</span>, $lastId)</div><div class="line">                -&gt;orderBy($column, <span class="string">'asc'</span>)</div><div class="line">                -&gt;take($perPage);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">removeExistingOrdersFor</span><span class="params">($column)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> Collection::make(<span class="keyword">$this</span>-&gt;orders)</div><div class="line">                -&gt;reject(<span class="function"><span class="keyword">function</span> <span class="params">($order)</span> <span class="title">use</span> <span class="params">($column)</span> </span>&#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">isset</span>($order[<span class="string">'column'</span>])</div><div class="line">                           ? $order[<span class="string">'column'</span>] === $column : <span class="keyword">false</span>;</div><div class="line">                &#125;)-&gt;values()-&gt;all();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/09/19/Laravel Datebase——查询构造器与语法编译器源码分析(上)/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/19/Laravel Datebase——查询构造器与语法编译器源码分析(上)/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-19T23:46:28+08:00">
                2017-09-19
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/09/19/Laravel Datebase——查询构造器与语法编译器源码分析(上)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/09/19/Laravel Datebase——查询构造器与语法编译器源码分析(上)/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/09/19/Laravel Datebase——查询构造器与语法编译器源码分析(上)/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Laravel-Datebase——查询构造器与语法编译器源码分析-上"><a href="#Laravel-Datebase——查询构造器与语法编译器源码分析-上" class="headerlink" title="Laravel Datebase——查询构造器与语法编译器源码分析(上)"></a>Laravel Datebase——查询构造器与语法编译器源码分析(上)</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在前两个文章中，我们分析了数据库的连接启动与数据库底层 <code>CRUD</code> 的原理，底层数据库服务支持原生 <code>sql</code> 的运行。本文以 <code>mysql</code> 为例，向大家讲述支持 <code>Fluent</code> 的查询构造器 <code>query</code> 与语法编译器 <code>grammer</code> 的原理。</p>
<h2 id="DB-table-与-查询构造器"><a href="#DB-table-与-查询构造器" class="headerlink" title="DB::table 与 查询构造器"></a>DB::table 与 查询构造器</h2><p>若是不想使用原生的 <code>sql</code> 语句，我们可以使用 <code>DB::table</code> 语句，该语句会返回一个 <code>query</code> 对象：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">table</span><span class="params">($table)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;query()-&gt;from($table);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">query</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> QueryBuilder(</div><div class="line">        <span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;getQueryGrammar(), <span class="keyword">$this</span>-&gt;getPostProcessor()</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以看到，<code>query</code> 会有两个成员，<code>queryGrammar</code> 与 <code>postProcessor</code>。<code>queryGrammar</code> 负责对 <code>QueryBuilcder</code> 的结果进行 <code>sql</code> 语言的转化，<code>postProcessor</code> 负责查询结果的后处理。</p>
<p>之所以 <code>laravel</code> 推荐我们使用查询构造器，而不是原生的 <code>sql</code>，原因在于可以避免 <code>sql</code> 注入漏洞。当然，我们也可以在使用 <code>DB::select()</code> 函数中手动写 <code>bindings</code> 的值，但是这样的话，我们写 <code>sql</code> 的语句是就必须是这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::select(<span class="string">'select * from table where col=?'</span>,[<span class="number">1</span>]);</div></pre></td></tr></table></figure>
<p>必然会带来很多不便。</p>
<p>有了查询构造器，我们就可以写出 <code>fluent</code> 类型的语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'table'</span>)-&gt;select(<span class="string">'*'</span>)-&gt;where(<span class="string">'col'</span>, <span class="number">1</span>);</div></pre></td></tr></table></figure>
<p>是不是很方便？</p>
<h2 id="CRUD-与语法编译器"><a href="#CRUD-与语法编译器" class="headerlink" title="CRUD 与语法编译器"></a>CRUD 与语法编译器</h2><p>相应于 <code>connection</code> 对象的 <code>CRUD</code>，语法编译器有 <code>compileInsert</code>、<code>compileSelect</code>、<code>compileUpdate</code>、<code>compileDelete</code>。其中最重要的是 <code>compileSelect</code>，因为它不仅负责了 <code>select</code> 语句的语法编译，还负责聚合语句 <code>aggregate</code>、<code>from</code> 语句、<code>join</code> 连接语句、<code>wheres</code> 条件语句、<code>groups</code> 分组语句、<code>havings</code> 条件语句、<code>orders</code> 排序语句、<code>limit</code> 语句、<code>offset</code> 语句、<code>unions</code> 联合语句、<code>lock</code> 语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $selectComponents = [</div><div class="line">    <span class="string">'aggregate'</span>,</div><div class="line">    <span class="string">'columns'</span>,</div><div class="line">    <span class="string">'from'</span>,</div><div class="line">    <span class="string">'joins'</span>,</div><div class="line">    <span class="string">'wheres'</span>,</div><div class="line">    <span class="string">'groups'</span>,</div><div class="line">    <span class="string">'havings'</span>,</div><div class="line">    <span class="string">'orders'</span>,</div><div class="line">    <span class="string">'limit'</span>,</div><div class="line">    <span class="string">'offset'</span>,</div><div class="line">    <span class="string">'unions'</span>,</div><div class="line">    <span class="string">'lock'</span>,</div><div class="line">];</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">compileSelect</span><span class="params">(Builder $query)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">   </div><div class="line">    $original = $query-&gt;columns;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (is_null($query-&gt;columns)) &#123;</div><div class="line">        $query-&gt;columns = [<span class="string">'*'</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $sql = trim(<span class="keyword">$this</span>-&gt;concatenate(</div><div class="line">        <span class="keyword">$this</span>-&gt;compileComponents($query))</div><div class="line">    );</div><div class="line"></div><div class="line">    $query-&gt;columns = $original;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $sql;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileComponents</span><span class="params">(Builder $query)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $sql = [];</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;selectComponents <span class="keyword">as</span> $component) &#123;</div><div class="line">        <span class="keyword">if</span> (! is_null($query-&gt;$component)) &#123;</div><div class="line">            $method = <span class="string">'compile'</span>.ucfirst($component);</div><div class="line"></div><div class="line">            $sql[$component] = <span class="keyword">$this</span>-&gt;$method($query, $query-&gt;$component);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $sql;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出来，语法编译器会将上述所有的语句放入 <code>$sql[]</code> 成员中，然后通过 <code>concatenate</code> 函数组装成 <code>sql</code> 语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">concatenate</span><span class="params">($segments)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> implode(<span class="string">' '</span>, array_filter($segments, <span class="function"><span class="keyword">function</span> <span class="params">($value)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (string) $value !== <span class="string">''</span>;</div><div class="line">    &#125;));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="wrap-函数"><a href="#wrap-函数" class="headerlink" title="wrap 函数"></a>wrap 函数</h3><p>若想要了解语法编译器，我们就必须先要了解 <code>grammer</code> 中一个重要的函数 <code>wrap</code>，这个函数专门对表名与列名进行处理，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">wrap</span><span class="params">($value, $prefixAlias = false)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isExpression($value)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getValue($value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (strpos(strtolower($value), <span class="string">' as '</span>) !== <span class="keyword">false</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrapAliasedValue($value, $prefixAlias);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrapSegments(explode(<span class="string">'.'</span>, $value));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>处理的流程：</p>
<ul>
<li>若是 <code>Expression</code> 对象，利用函数 <code>getValue</code> 直接取出对象值，不对其进行任何处理，用于处理原生 <code>sql</code>。<code>expression</code> 对象的作用是保护原始参数，避免框架解析的一种方式。也就是说，当我们用了 <code>expression</code> 来包装参数的话，<code>laravel</code> 将不会对其进行任何处理，包括库名解析、表名前缀、别名等。</li>
<li>若表名/列名存在 <code>as</code>，则利用函数 <code>wrapAliasedValue</code> 为表名设置别名。</li>
<li>若表名/列名含有 <code>.</code>，则会被分解为 <code>库名/表名</code>，或者 <code>表名/列名</code>，并调用函数 <code>wrapSegments</code>。</li>
</ul>
<h3 id="wrapAliasedValue-函数"><a href="#wrapAliasedValue-函数" class="headerlink" title="wrapAliasedValue 函数"></a>wrapAliasedValue 函数</h3><p><code>wrapAliasedValue</code> 函数用于处理别名：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapAliasedValue</span><span class="params">($value, $prefixAlias = false)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $segments = preg_split(<span class="string">'/\s+as\s+/i'</span>, $value);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($prefixAlias) &#123;</div><div class="line">        $segments[<span class="number">1</span>] = <span class="keyword">$this</span>-&gt;tablePrefix.$segments[<span class="number">1</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap(</div><div class="line">        $segments[<span class="number">0</span>]).<span class="string">' as '</span>.<span class="keyword">$this</span>-&gt;wrapValue($segments[<span class="number">1</span>]</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，首先程序会根据 <code>as</code> 将字符串分为两部分，<code>as</code> 前的部分递归调用 <code>wrap</code> 函数，<code>as</code> 后的部分调用 <code>wrapValue</code> 函数.</p>
<h3 id="wrapValue-函数"><a href="#wrapValue-函数" class="headerlink" title="wrapValue 函数"></a>wrapValue 函数</h3><p><code>wrapValue</code> 函数用来处理添加符号 <code>&quot;</code>，例如 <code>table</code>，会被这个函数变为 <code>&quot;table&quot;</code>。需要注意的是 <code>table1&quot;table2</code> 这种情况，假如我们的数据库中存在一个表，名字就叫做: <code>table1&quot;table2</code>，我们在数据库查询的时候，必须将表名转化为 <code>&quot;table1&quot;&quot;table2&quot;</code>，只有这样，数据库才会有效地转化表名为 <code>&quot;table1&quot;table2&quot;</code>，否则数据库就会报告错误：找不到表。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapValue</span><span class="params">($value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> ($value !== <span class="string">'*'</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'"'</span>.str_replace(<span class="string">'"'</span>, <span class="string">'""'</span>, $value).<span class="string">'"'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="wrapSegments-函数"><a href="#wrapSegments-函数" class="headerlink" title="wrapSegments 函数"></a>wrapSegments 函数</h3><p><code>wrapSegments</code> 函数会判断当前参数，如果是 <code>table.column</code>，会将前一部分 <code>table</code> 调用 <code>wrapTable</code>, <code>column</code> 调用 <code>wrapValue</code>，最后生成 <code>“table”.&quot;column&quot;</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapSegments</span><span class="params">($segments)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> collect($segments)-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($segment, $key)</span> <span class="title">use</span> <span class="params">($segments)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $key == <span class="number">0</span> &amp;&amp; count($segments) &gt; <span class="number">1</span></div><div class="line">                        ? <span class="keyword">$this</span>-&gt;wrapTable($segment)</div><div class="line">                        : <span class="keyword">$this</span>-&gt;wrapValue($segment);</div><div class="line">    &#125;)-&gt;implode(<span class="string">'.'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="wrapTable-函数"><a href="#wrapTable-函数" class="headerlink" title="wrapTable 函数"></a>wrapTable 函数</h3><p><code>wrapTable</code> 函数用于为数据表添加表前缀：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public function wrapTable($table)</div><div class="line">&#123;</div><div class="line">    if (! $this-&gt;isExpression($table)) &#123;</div><div class="line">        return $this-&gt;wrap($this-&gt;tablePrefix.$table, true);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return $this-&gt;getValue($table);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>wrap</code> 整体流程图如下：</p>
<p><img src="http://owql68l6p.bkt.clouddn.com/17-9-23/27965477.jpg" alt="Markdown"></p>
<h2 id="from-语句"><a href="#from-语句" class="headerlink" title="from 语句"></a>from 语句</h2><p>我们看到 <code>DB::table</code> 实际上是调用了查询构造器的 <code>from</code> 函数。接下来我们就看看，当我们写下了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'table'</span>)-&gt;get()</div></pre></td></tr></table></figure>
<p>时发生了什么。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">from</span><span class="params">($table)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;from = $table;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们看到，<code>from</code> 函数极其简单，我们接下来看 <code>get</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($columns = [<span class="string">'*'</span>])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $original = <span class="keyword">$this</span>-&gt;columns;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (is_null($original)) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;columns = $columns;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $results = <span class="keyword">$this</span>-&gt;processor-&gt;processSelect(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;runSelect());</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;columns = $original;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> collect($results);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>laravel</code> 的查询构造器是懒加载的，只有调用了 <code>get</code> 函数才会真正的调用语法编译器，采用调用底层 <code>connection</code> 对象进行数据库查询：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runSelect</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;connection-&gt;select(</div><div class="line">        <span class="keyword">$this</span>-&gt;toSql(), <span class="keyword">$this</span>-&gt;getBindings(), ! <span class="keyword">$this</span>-&gt;useWritePdo</div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toSql</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;grammar-&gt;compileSelect(<span class="keyword">$this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="compileFrom-函数"><a href="#compileFrom-函数" class="headerlink" title="compileFrom 函数"></a>compileFrom 函数</h3><p>首先我们先看看流程图：</p>
<p><img src="http://owql68l6p.bkt.clouddn.com/17-9-23/10116808.jpg" alt="Markdown"></p>
<p>语法编译器 <code>grammer</code> 对于 <code>from</code> 语句的处理由函数 <code>compileFrom</code> 负责：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileFrom</span><span class="params">(Builder $query, $table)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'from '</span>.<span class="keyword">$this</span>-&gt;wrapTable($table);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从流程图可以看出，具体流程与 <code>wrap</code> 类似。</p>
<p>我们调用 <code>from</code> 时，可以传递两种参数，一种是字符串，另一种是 <code>expression</code> 对象：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'table'</span>);</div><div class="line">DB::table(<span class="keyword">new</span> Expression(<span class="string">'table'</span>));</div></pre></td></tr></table></figure>
<ul>
<li>传递 <code>expression</code> 对象</li>
</ul>
<p>当我们传递 <code>expression</code> 对象的时候，<code>grammer</code> 就会调用 <code>getValue</code> 取出原生 <code>sql</code> 语句。</p>
<ul>
<li>传递字符串</li>
</ul>
<p>当我们向 <code>from</code> 传递普通的字符串时，<code>laravel</code> 就会对字符串调用 <code>wrap</code> 函数进行处理，处理流程上一个小节已经说明：</p>
<ul>
<li>为表名加上前缀 <code>$this-&gt;tablePrefix</code></li>
<li>若字符串存在 <code>as</code>，则为表名设置别名。</li>
<li>若字符串含有 <code>.</code>，则会被分解为 <code>库名</code> 与 <code>表名</code>，并进行分别调用 <code>wrapTable</code> 函数与 <code>wrapValue</code> 进行处理。</li>
<li>为表名前后添加 <code>&quot;</code>，例如 <code>t1.t2</code> 会被转化为 <code>&quot;t1&quot;.&quot;t2&quot;</code>（不同的数据库添加的字符不同，mysql 就不是 <code>&quot;</code>）</li>
</ul>
<p><code>laravel</code> 对 <code>from</code> 处理流程存在一些问题，表名前缀设置功能与数据库名功能公用存在问题，相关 <code>issue</code> 地址是：<a href="https://github.com/laravel/framework/issues/21305" target="_blank" rel="external">[Bug] Table prefix added to database name when using database.table</a>，有任何兴趣的同学可以在这个 <code>issue</code> 里面讨论，或者直接向作者提 <code>PR</code>。若作者对此部分有任何修改，我会同步修改这篇文章。</p>
<h2 id="Select-语句"><a href="#Select-语句" class="headerlink" title="Select 语句"></a>Select 语句</h2><p>本小节会介绍 <code>select</code> 语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span><span class="params">($columns = [<span class="string">'*'</span>])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;columns = is_array($columns) ? $columns : func_get_args();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>queryBuilder</code> 的 <code>select</code> 语句很简单，我们不多讨论.</p>
<p><code>selectRaw</code> ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">selectRaw</span><span class="params">($expression, array $bindings = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;addSelect(<span class="keyword">new</span> Expression($expression));</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($bindings) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;addBinding($bindings, <span class="string">'select'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addSelect</span><span class="params">($column)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $column = is_array($column) ? $column : func_get_args();</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;columns = array_merge((<span class="keyword">array</span>) <span class="keyword">$this</span>-&gt;columns, $column);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到， <code>selectRaw</code> 就是将 <code>Expression</code> 对象赋值到 <code>columns</code> 中，我们在前面说到，框架不会对 <code>Expression</code> 进行任何处理（更准确的说是 <code>wrap</code> 函数），这样就保证了原生语句的执行。</p>
<p>我们接着看 <code>grammer</code> .</p>
<h3 id="compileColumns-函数"><a href="#compileColumns-函数" class="headerlink" title="compileColumns 函数"></a>compileColumns 函数</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileColumns</span><span class="params">(Builder $query, $columns)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! is_null($query-&gt;aggregate)) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $select = $query-&gt;distinct ? <span class="string">'select distinct '</span> : <span class="string">'select '</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $select.<span class="keyword">$this</span>-&gt;columnize($columns);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">columnize</span><span class="params">(array $columns)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> implode(<span class="string">', '</span>, array_map([<span class="keyword">$this</span>, <span class="string">'wrap'</span>], $columns));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，<code>grammer</code> 对 <code>select</code> 的语法编译调用 <code>wrap</code> 函数对每个 <code>select</code> 的字段进行处理，处理过程在上面详解过，在此不再赘述。</p>
<h2 id="selectSub-语句"><a href="#selectSub-语句" class="headerlink" title="selectSub 语句"></a>selectSub 语句</h2><p>所谓的 <code>select</code> 子查询，就是查询的字段来源于其他数据表。对于这种查询，可以分成两部来理解，首先忽略整个select子查询，查出第一个表中的数据，然后根据第一个表的数据执行子查询，</p>
<p><code>laravel</code> 的 <code>selectSub</code> 支持闭包函数、<code>queryBuild</code> 对象或者原生 <code>sql</code> 语句，以下是单元测试样例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$query = DB::table(<span class="string">'one'</span>)-&gt;select([<span class="string">'foo'</span>, <span class="string">'bar'</span>])-&gt;where(<span class="string">'key'</span>, <span class="string">'='</span>, <span class="string">'val'</span>);</div><div class="line"></div><div class="line">$query-&gt;selectSub(<span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">        $query-&gt;from(<span class="string">'two'</span>)-&gt;select(<span class="string">'baz'</span>)-&gt;where(<span class="string">'subkey'</span>, <span class="string">'='</span>, <span class="string">'subval'</span>);</div><div class="line">    &#125;, <span class="string">'sub'</span>);</div></pre></td></tr></table></figure>
<p>另一种写法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$query = DB::table(<span class="string">'one'</span>)-&gt;select([<span class="string">'foo'</span>, <span class="string">'bar'</span>])-&gt;where(<span class="string">'key'</span>, <span class="string">'='</span>, <span class="string">'val'</span>);</div><div class="line">$query_sub = DB::table(<span class="string">'one'</span>)-&gt;select(<span class="string">'baz'</span>)-&gt;where(<span class="string">'subkey'</span>, <span class="string">'='</span>, <span class="string">'subval'</span>);</div><div class="line"></div><div class="line">$query-&gt;selectSub($query_sub, <span class="string">'sub'</span>);</div></pre></td></tr></table></figure>
<p>生成的 <code>sql</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">select &quot;foo&quot;, &quot;bar&quot;, (select &quot;baz&quot; from &quot;two&quot; where &quot;subkey&quot; = &apos;subval&apos;) as &quot;sub&quot; from &quot;one&quot; where &quot;key&quot; = &apos;val&apos;</div><div class="line">```   </div><div class="line"></div><div class="line">`selectSub` 语句的实现比较简单：</div><div class="line"></div><div class="line">```php</div><div class="line">public function selectSub($query, $as)</div><div class="line">&#123;</div><div class="line">    if ($query instanceof Closure) &#123;</div><div class="line">        $callback = $query;</div><div class="line"></div><div class="line">        $callback($query = $this-&gt;forSubQuery());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    list($query, $bindings) = $this-&gt;parseSubSelect($query);</div><div class="line"></div><div class="line">    return $this-&gt;selectRaw(</div><div class="line">        &apos;(&apos;.$query.&apos;) as &apos;.$this-&gt;grammar-&gt;wrap($as), $bindings</div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line">protected function parseSubSelect($query)</div><div class="line">&#123;</div><div class="line">    if ($query instanceof self) &#123;</div><div class="line">        $query-&gt;columns = [$query-&gt;columns[0]];</div><div class="line"></div><div class="line">        return [$query-&gt;toSql(), $query-&gt;getBindings()];</div><div class="line">    &#125; elseif (is_string($query)) &#123;</div><div class="line">        return [$query, []];</div><div class="line">    &#125; else &#123;</div><div class="line">        throw new InvalidArgumentException;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，如果 <code>selectSub</code> 的参数是闭包函数，那么就会先执行闭包函数，闭包函数将会为 <code>query</code> 根据查询语句更新对象。</p>
<p><code>parseSubSelect</code> 函数为子查询解析 <code>sql</code> 语句与 <code>binding</code> 变量。</p>
<h2 id="where-语句总结"><a href="#where-语句总结" class="headerlink" title="where 语句总结"></a>where 语句总结</h2><p>在 <code>laravel</code> 文档中，<code>queryBuild</code> 的用法很详尽，但是为了更好的理解源码，我们在这里再次大概的总结一下：</p>
<h3 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">users = DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'votes'</span>, <span class="string">'='</span>, <span class="number">100</span>)-&gt;get();</div><div class="line">$users = DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'votes'</span>, <span class="number">100</span>)-&gt;get();</div></pre></td></tr></table></figure>
<p>这两个是等价的写法。</p>
<h3 id="where-数组"><a href="#where-数组" class="headerlink" title="where 数组"></a><code>where</code> 数组</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)-&gt;where(</div><div class="line">    [<span class="string">'status'</span> =&gt; <span class="number">1</span>, <span class="string">'subscribed'</span> =&gt; <span class="number">1</span>],</div><div class="line">)-&gt;get();</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)-&gt;where([</div><div class="line">    [<span class="string">'status'</span>, <span class="string">'1'</span>],</div><div class="line">    [<span class="string">'subscribed'</span>, <span class="string">'1'</span>],</div><div class="line">])-&gt;get();</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)-&gt;where([</div><div class="line">    [<span class="string">'status'</span>, <span class="string">'1'</span>],</div><div class="line">    [<span class="string">'subscribed'</span>, <span class="string">'&lt;&gt;'</span>, <span class="string">'1'</span>],</div><div class="line">])-&gt;get();</div></pre></td></tr></table></figure>
<h3 id="where-查询组"><a href="#where-查询组" class="headerlink" title="where 查询组"></a><code>where</code> 查询组</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)</div><div class="line">    -&gt;where(<span class="string">'name'</span>, <span class="string">'='</span>, <span class="string">'John'</span>)</div><div class="line">    -&gt;orWhere(<span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">        $query-&gt;where(<span class="string">'votes'</span>, <span class="string">'&gt;'</span>, <span class="number">100</span>)</div><div class="line">              -&gt;where(<span class="string">'title'</span>, <span class="string">'&lt;&gt;'</span>, <span class="string">'Admin'</span>);</div><div class="line">    &#125;)</div><div class="line">    -&gt;get();</div></pre></td></tr></table></figure>
<p>这一句的 <code>sql</code> 语句是 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select * from users where name = <span class="string">'John'</span> <span class="keyword">or</span> (votes &gt; <span class="number">100</span> <span class="keyword">and</span> title &lt;&gt; <span class="string">'Admin'</span>)</div></pre></td></tr></table></figure>
<h3 id="where-子查询"><a href="#where-子查询" class="headerlink" title="where 子查询"></a><code>where</code> 子查询</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testFullSubSelects</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $builder = <span class="keyword">$this</span>-&gt;getBuilder();</div><div class="line">    DB::table(<span class="string">'users'</span>)</div><div class="line">        -&gt;Where(<span class="string">'id'</span>, <span class="string">'='</span>, <span class="function"><span class="keyword">function</span> <span class="params">($q)</span> </span>&#123;</div><div class="line">        $q-&gt;select(<span class="keyword">new</span> Raw(<span class="string">'max(id)'</span>))-&gt;from(<span class="string">'users'</span>)-&gt;where(<span class="string">'email'</span>, <span class="string">'='</span>, <span class="string">'bar'</span>);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这一句的 <code>sql</code> 语句是 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select * from <span class="string">"users"</span> where <span class="string">"email"</span> = foo <span class="keyword">or</span> <span class="string">"id"</span> = (select max(id) from <span class="string">"users"</span> where <span class="string">"email"</span> = bar`</div></pre></td></tr></table></figure>
<h3 id="orWhere"><a href="#orWhere" class="headerlink" title="orWhere"></a>orWhere</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;where(<span class="string">'votes'</span>, <span class="string">'&gt;'</span>, <span class="number">100</span>)</div><div class="line">            -&gt;orWhere(<span class="string">'name'</span>, <span class="string">'John'</span>)</div><div class="line">            -&gt;get();</div></pre></td></tr></table></figure>
<h3 id="whereDate-whereMonth-whereDay-whereYear-whereTime"><a href="#whereDate-whereMonth-whereDay-whereYear-whereTime" class="headerlink" title="whereDate / whereMonth / whereDay / whereYear / whereTime"></a>whereDate / whereMonth / whereDay / whereYear / whereTime</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">	        -&gt;whereDate(<span class="string">'created_at'</span>, <span class="string">'2016-12-31'</span>)</div><div class="line">	        -&gt;get();</div><div class="line">	        </div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereMonth(<span class="string">'created_at'</span>, <span class="string">'12'</span>)</div><div class="line">            -&gt;get();	        </div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereDay(<span class="string">'created_at'</span>, <span class="string">'31'</span>)</div><div class="line">            -&gt;get();</div><div class="line">            </div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereYear(<span class="string">'created_at'</span>, <span class="string">'2016'</span>)</div><div class="line">            -&gt;get();</div><div class="line">            </div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereTime(<span class="string">'created_at'</span>, <span class="string">'&gt;='</span>, <span class="string">'22:00'</span>)</div><div class="line">            -&gt;get();</div></pre></td></tr></table></figure>
<h3 id="whereBetween-whereNotBetween"><a href="#whereBetween-whereNotBetween" class="headerlink" title="whereBetween / whereNotBetween"></a>whereBetween / whereNotBetween</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereBetween(<span class="string">'votes'</span>, [<span class="number">1</span>, <span class="number">100</span>])-&gt;get();</div><div class="line">            </div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereNotBetween(<span class="string">'votes'</span>, [<span class="number">1</span>, <span class="number">100</span>])</div><div class="line">            -&gt;get();</div></pre></td></tr></table></figure>
<h3 id="whereRaw-orWhereRaw"><a href="#whereRaw-orWhereRaw" class="headerlink" title="whereRaw / orWhereRaw"></a>whereRaw / orWhereRaw</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereRaw(<span class="string">'id = ? or email = ?'</span>, [<span class="number">1</span>, <span class="string">'foo'</span>])</div><div class="line">            -&gt;get();</div><div class="line">            </div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;orWhereRaw(<span class="string">'id = ? or email = ?'</span>, [<span class="number">1</span>, <span class="string">'foo'</span>])</div><div class="line">            -&gt;get();</div></pre></td></tr></table></figure>
<h3 id="whereIn-whereNotIn-orWhereIn-orWhereNotIn"><a href="#whereIn-whereNotIn-orWhereIn-orWhereNotIn" class="headerlink" title="whereIn / whereNotIn / orWhereIn / orWhereNotIn"></a>whereIn / whereNotIn / orWhereIn / orWhereNotIn</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereIn(<span class="string">'id'</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</div><div class="line">            -&gt;get();</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereNotIn(<span class="string">'id'</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</div><div class="line">            -&gt;get();</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)            </div><div class="line">				-&gt;whereIn(<span class="string">'id'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($q)</span> </span>&#123;</div><div class="line">        			$q-&gt;select(<span class="string">'id'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;where(<span class="string">'age'</span>, <span class="string">'&gt;'</span>, <span class="number">25</span>)-&gt;take(<span class="number">3</span>);</div><div class="line">    			&#125;);       </div><div class="line">    			</div><div class="line">$users = DB::table(<span class="string">'users'</span>)            </div><div class="line">				-&gt;whereNotIn(<span class="string">'id'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($q)</span> </span>&#123;</div><div class="line">        			$q-&gt;select(<span class="string">'id'</span>)-&gt;from(<span class="string">'users'</span>)-&gt;where(<span class="string">'age'</span>, <span class="string">'&gt;'</span>, <span class="number">25</span>)-&gt;take(<span class="number">3</span>);</div><div class="line">    			&#125;);  </div><div class="line">    			</div><div class="line">$query = DB::table(<span class="string">'users'</span>)-&gt;select(<span class="string">'id'</span>)-&gt;where(<span class="string">'age'</span>, <span class="string">'&gt;'</span>, <span class="number">25</span>)-&gt;take(<span class="number">3</span>);</div><div class="line">$users = DB::table(<span class="string">'users'</span>)-&gt;whereIn(<span class="string">'id'</span>, $query);   </div><div class="line">$users = DB::table(<span class="string">'users'</span>)-&gt;whereNotIn(<span class="string">'id'</span>, $query);</div></pre></td></tr></table></figure>
<p>有意思的是，当我们在 <code>whereIn / whereNotIn / orWhereIn / orWhereNotIn</code> 中传入空数组的时候：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereIn(<span class="string">'id'</span>, [])</div><div class="line">            -&gt;get();</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;orWhereIn(<span class="string">'id'</span>, [])</div><div class="line">            -&gt;get();</div></pre></td></tr></table></figure>
<p>这个时候，框架自动会生成如下的 <code>sql</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">select * from <span class="string">"users"</span> where <span class="number">0</span> = <span class="number">1</span>;</div><div class="line"></div><div class="line">select * from <span class="string">"users"</span> where <span class="string">"id"</span> = ? <span class="keyword">or</span> <span class="number">0</span> = <span class="number">1</span></div></pre></td></tr></table></figure>
<h3 id="whereColumn"><a href="#whereColumn" class="headerlink" title="whereColumn"></a>whereColumn</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereColumn(<span class="string">'first_name'</span>, <span class="string">'last_name'</span>)</div><div class="line">            -&gt;get();</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereColumn(<span class="string">'updated_at'</span>, <span class="string">'&gt;'</span>, <span class="string">'created_at'</span>)</div><div class="line">            -&gt;get();</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereColumn([</div><div class="line">                [<span class="string">'first_name'</span>, <span class="string">'='</span>, <span class="string">'last_name'</span>],</div><div class="line">                [<span class="string">'updated_at'</span>, <span class="string">'&gt;'</span>, <span class="string">'created_at'</span>]</div><div class="line">            ])-&gt;get();</div></pre></td></tr></table></figure>
<h3 id="whereNull-whereNotNull-orWhereNull-orWhereNotNull"><a href="#whereNull-whereNotNull-orWhereNull-orWhereNotNull" class="headerlink" title="whereNull / whereNotNull / orWhereNull / orWhereNotNull"></a>whereNull / whereNotNull / orWhereNull / orWhereNotNull</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereNull(<span class="string">'updated_at'</span>)</div><div class="line">            -&gt;get();</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;whereNotNull(<span class="string">'updated_at'</span>)</div><div class="line">            -&gt;get();</div><div class="line">            </div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;orWhereNull(<span class="string">'updated_at'</span>)</div><div class="line">            -&gt;get();</div><div class="line">            </div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">            -&gt;orWhereNotNull(<span class="string">'updated_at'</span>)</div><div class="line">            -&gt;get();</div></pre></td></tr></table></figure>
<h3 id="whereExists-whereNotExists-orWhereExists-orWhereNotExists"><a href="#whereExists-whereNotExists-orWhereExists-orWhereNotExists" class="headerlink" title="whereExists / whereNotExists / orWhereExists / orWhereNotExists"></a>whereExists / whereNotExists / orWhereExists / orWhereNotExists</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)</div><div class="line">    -&gt;whereExists(<span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">        $query-&gt;select(DB::raw(<span class="number">1</span>))</div><div class="line">              -&gt;from(<span class="string">'orders'</span>)</div><div class="line">              -&gt;whereRaw(<span class="string">'orders.user_id = users.id'</span>);</div><div class="line">    &#125;)</div><div class="line">    -&gt;get(); </div><div class="line"><span class="comment">// select * from users where exists ( select 1 from orders where orders.user_id = users.id)</span></div><div class="line"></div><div class="line">DB::table(<span class="string">'users'</span>)</div><div class="line">    -&gt;whereNotExists(<span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">        $query-&gt;select(DB::raw(<span class="number">1</span>))</div><div class="line">              -&gt;from(<span class="string">'orders'</span>)</div><div class="line">              -&gt;whereRaw(<span class="string">'orders.user_id = users.id'</span>);</div><div class="line">    &#125;)</div><div class="line">    -&gt;get();</div><div class="line"><span class="comment">// select * from users where not exists ( select 1 from orders where orders.user_id = users.id)</span></div><div class="line">    </div><div class="line">DB::table(<span class="string">'users'</span>)</div><div class="line">    -&gt;orWhereExists(<span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">        $query-&gt;select(DB::raw(<span class="number">1</span>))</div><div class="line">              -&gt;from(<span class="string">'orders'</span>)</div><div class="line">              -&gt;whereRaw(<span class="string">'orders.user_id = users.id'</span>);</div><div class="line">    &#125;)</div><div class="line">    -&gt;get();</div><div class="line"><span class="comment">// select * from users or exists ( select 1 from orders where orders.user_id = users.id)</span></div><div class="line">    </div><div class="line">DB::table(<span class="string">'users'</span>)</div><div class="line">    -&gt;orWhereNotExists(<span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">        $query-&gt;select(DB::raw(<span class="number">1</span>))</div><div class="line">              -&gt;from(<span class="string">'orders'</span>)</div><div class="line">              -&gt;whereRaw(<span class="string">'orders.user_id = users.id'</span>);</div><div class="line">    &#125;)</div><div class="line">    -&gt;get();  </div><div class="line"><span class="comment">// select * from users or not exists ( select 1 from orders where orders.user_id = users.id)</span></div></pre></td></tr></table></figure>
<h2 id="where-函数"><a href="#where-函数" class="headerlink" title="where 函数"></a>where 函数</h2><p>我们首先先看看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">where</span><span class="params">($column, $operator = null, $value = null, $boolean = <span class="string">'and'</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (is_array($column)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;addArrayOfWheres($column, $boolean);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">list</span>($value, $operator) = <span class="keyword">$this</span>-&gt;prepareValueAndOperator(</div><div class="line">        $value, $operator, func_num_args() == <span class="number">2</span></div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($column <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;whereNested($column, $boolean);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;invalidOperator($operator)) &#123;</div><div class="line">        <span class="keyword">list</span>($value, $operator) = [$operator, <span class="string">'='</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($value <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;whereSub($column, $operator, $value, $boolean);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (is_null($value)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;whereNull($column, $boolean, $operator !== <span class="string">'='</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (Str::contains($column, <span class="string">'-&gt;'</span>) &amp;&amp; is_bool($value)) &#123;</div><div class="line">        $value = <span class="keyword">new</span> Expression($value ? <span class="string">'true'</span> : <span class="string">'false'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $type = <span class="string">'Basic'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(</div><div class="line">        <span class="string">'type'</span>, <span class="string">'column'</span>, <span class="string">'operator'</span>, <span class="string">'value'</span>, <span class="string">'boolean'</span></div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! $value <span class="keyword">instanceof</span> Expression) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;addBinding($value, <span class="string">'where'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，为了支持框架的多种 <code>where</code> 形式，<code>where</code> 的代码中写了很多的条件语句。我们接下来一个个分析。</p>
<h3 id="grammer——compileWheres-函数"><a href="#grammer——compileWheres-函数" class="headerlink" title="grammer——compileWheres 函数"></a>grammer——compileWheres 函数</h3><p>在此之前，我们先看看语法编译器对 <code>where</code> 查询的处理：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileWheres</span><span class="params">(Builder $query)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (is_null($query-&gt;wheres)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">''</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (count($sql = <span class="keyword">$this</span>-&gt;compileWheresToArray($query)) &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;concatenateWhereClauses($query, $sql);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">''</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>compileWheres</code> 函数负责所有 <code>where</code> 查询条件的语法编译工作，<code>compileWheresToArray</code> 函数负责循环编译查询条件，<code>concatenateWhereClauses</code> 函数负责将多个查询条件合并。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileWheresToArray</span><span class="params">($query)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> collect($query-&gt;wheres)-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($where)</span> <span class="title">use</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $where[<span class="string">'boolean'</span>].<span class="string">' '</span>.<span class="keyword">$this</span>-&gt;&#123;<span class="string">"where&#123;$where['type']&#125;"</span>&#125;($query, $where);</div><div class="line">    &#125;)-&gt;all();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">concatenateWhereClauses</span><span class="params">($query, $sql)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $conjunction = $query <span class="keyword">instanceof</span> JoinClause ? <span class="string">'on'</span> : <span class="string">'where'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $conjunction.<span class="string">' '</span>.<span class="keyword">$this</span>-&gt;removeLeadingBoolean(implode(<span class="string">' '</span>, $sql));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>compileWheresToArray</code> 函数负责把 <code>$query-&gt;wheres</code> 中多个 <code>where</code> 条件循环起来：</p>
<ul>
<li><code>$where[&#39;boolean&#39;]</code> 是多个查询条件的连接，<code>and</code> 或者 <code>or</code>，一般 <code>where</code> 条件默认为 <code>and</code>,各种 <code>orWhere</code> 的连接是 <code>or</code></li>
<li><code>where{$where[&#39;type&#39;]}</code> 是查询的类型，<code>laravel</code> 把查询条件分为以下几类：<code>base</code>、<code>raw</code>、<code>in</code>、<code>notIn</code>、<code>inSub</code>、<code>notInSub</code>、<code>null</code>、<code>notNull</code>、<code>between</code>、<code>column</code>、<code>nested</code>、<code>sub</code>、<code>exist</code>、<code>notExist</code>。每种类型的查询条件都有对应的 <code>grammer</code> 方法</li>
</ul>
<p><code>concatenateWhereClauses</code> 函数负责连接所有的搜索条件，由于 <code>join</code> 的连接条件也会调用 <code>compileWheres</code> 函数，所以会有判断是否是真正的 <code>where</code> 查询，</p>
<h3 id="where-数组-1"><a href="#where-数组-1" class="headerlink" title="where 数组"></a>where 数组</h3><p>如果 <code>column</code> 是数组的话，就会调用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addArrayOfWheres</span><span class="params">($column, $boolean, $method = <span class="string">'where'</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;whereNested(<span class="function"><span class="keyword">function</span> <span class="params">($query)</span> <span class="title">use</span> <span class="params">($column, $method, $boolean)</span> </span>&#123;</div><div class="line">        <span class="keyword">foreach</span> ($column <span class="keyword">as</span> $key =&gt; $value) &#123;</div><div class="line">            <span class="keyword">if</span> (is_numeric($key) &amp;&amp; is_array($value)) &#123;</div><div class="line">                $query-&gt;&#123;$method&#125;(...array_values($value));</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                $query-&gt;$method($key, <span class="string">'='</span>, $value, $boolean);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;, $boolean);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，数组分为两类，一种是列名为 <code>key</code>，例如 <code>[&#39;foo&#39; =&gt; 1, &#39;bar&#39; =&gt; 2]</code>，这个时候就是调用 <code>query-&gt;where(&#39;foo&#39;, &#39;=&#39;, &#39;1&#39;, ‘and’)</code>。还有一种是 <code>[[&#39;foo&#39;,&#39;1&#39;],[&#39;bar&#39;,&#39;2&#39;]]</code>，这个时候就会调用 <code>$query-&gt;where([&#39;foo&#39;,&#39;1&#39;])</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">whereNested</span><span class="params">(Closure $callback, $boolean = <span class="string">'and'</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    call_user_func($callback, $query = <span class="keyword">$this</span>-&gt;forNestedWhere());</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;addNestedWhereQuery($query, $boolean);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addNestedWhereQuery</span><span class="params">($query, $boolean = <span class="string">'and'</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (count($query-&gt;wheres)) &#123;</div><div class="line">        $type = <span class="string">'Nested'</span>;</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;wheres[] = compact(<span class="string">'type'</span>, <span class="string">'query'</span>, <span class="string">'boolean'</span>);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;addBinding($query-&gt;getBindings(), <span class="string">'where'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="grammer——whereNested"><a href="#grammer——whereNested" class="headerlink" title="grammer——whereNested"></a>grammer——whereNested</h4><p>语法编译器中负责查询组的函数是 <code>whereNested</code>，它会取出 <code>where</code> 中的 <code>query</code>，递归调用 <code>compileWheres</code> 函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereNested</span><span class="params">(Builder $query, $where)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $offset = $query <span class="keyword">instanceof</span> JoinClause ? <span class="number">3</span> : <span class="number">6</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">'('</span>.substr(<span class="keyword">$this</span>-&gt;compileWheres($where[<span class="string">'query'</span>]), $offset).<span class="string">')'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于 <code>compileWheres</code> 会返回 <code>where ...</code> 或者 <code>on ...</code> 等开头的 <code>sql</code> 语句，所以我们需要把返回结果截取前3个字符或6个字符。</p>
<h3 id="where-查询组-1"><a href="#where-查询组-1" class="headerlink" title="where 查询组"></a>where 查询组</h3><p>若查询条件是一个闭包函数，也就是第一个参数 <code>column</code> 是个闭包函数，那么就要调用 <code>whereNested</code> 函数，过程和上述过程一致。</p>
<h3 id="whereSub-子查询"><a href="#whereSub-子查询" class="headerlink" title="whereSub 子查询"></a>whereSub 子查询</h3><p>如果第二个参数或者第三个参数是一个闭包函数的话，就是 <code>where</code> 子查询语句，这时需要调用 <code>whereSub</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereSub</span><span class="params">($column, $operator, Closure $callback, $boolean)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $type = <span class="string">'Sub'</span>;</div><div class="line"></div><div class="line">    call_user_func($callback, $query = <span class="keyword">$this</span>-&gt;forSubQuery());</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(</div><div class="line">        <span class="string">'type'</span>, <span class="string">'column'</span>, <span class="string">'operator'</span>, <span class="string">'query'</span>, <span class="string">'boolean'</span></div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;addBinding($query-&gt;getBindings(), <span class="string">'where'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="grammer——whereSub"><a href="#grammer——whereSub" class="headerlink" title="grammer——whereSub"></a>grammer——whereSub</h4><p><code>grammer</code> 中负责子查询的是 <code>whereSub</code> 函数： </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereSub</span><span class="params">(Builder $query, $where)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $select = <span class="keyword">$this</span>-&gt;compileSelect($where[<span class="string">'query'</span>]);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'column'</span>]).<span class="string">' '</span>.$where[<span class="string">'operator'</span>].<span class="string">" ($select)"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为子查询中可以存在 <code>select</code> 、<code>where</code> 、<code>join</code> 等一切 <code>sql</code> 语句，所以递归的是 <code>compileSelect</code> 这个大的函数，而不是仅仅 <code>compileWheres</code>。</p>
<h3 id="whereNull-语句"><a href="#whereNull-语句" class="headerlink" title="whereNull 语句"></a>whereNull 语句</h3><p><code>whereNull</code> 函数也很简单：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">whereNull</span><span class="params">($column, $boolean = <span class="string">'and'</span>, $not = false)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $type = $not ? <span class="string">'NotNull'</span> : <span class="string">'Null'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(<span class="string">'type'</span>, <span class="string">'column'</span>, <span class="string">'boolean'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="grammer——whereNull-函数"><a href="#grammer——whereNull-函数" class="headerlink" title="grammer——whereNull 函数"></a>grammer——whereNull 函数</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereNull</span><span class="params">(Builder $query, $where)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'column'</span>]).<span class="string">' is null'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="whereBasic-语句"><a href="#whereBasic-语句" class="headerlink" title="whereBasic 语句"></a>whereBasic 语句</h3><p>如果上述情况都不符合，那么就是最基础的 <code>where</code> 语句，类型是 <code>basic</code>.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$type = <span class="string">'Basic'</span>;</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;wheres[] = compact(</div><div class="line">    <span class="string">'type'</span>, <span class="string">'column'</span>, <span class="string">'operator'</span>, <span class="string">'value'</span>, <span class="string">'boolean'</span></div><div class="line">);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (! $value <span class="keyword">instanceof</span> Expression) &#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;addBinding($value, <span class="string">'where'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="grammer——whereBasic-函数"><a href="#grammer——whereBasic-函数" class="headerlink" title="grammer——whereBasic 函数"></a>grammer——whereBasic 函数</h4><p><code>grammer</code> 中最基础的 <code>where</code> 语句由 <code>wherebasic</code> 函数负责：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereBasic</span><span class="params">(Builder $query, $where)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $value = <span class="keyword">$this</span>-&gt;parameter($where[<span class="string">'value'</span>]);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'column'</span>]).<span class="string">' '</span>.$where[<span class="string">'operator'</span>].<span class="string">' '</span>.$value;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parameter</span><span class="params">($value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;isExpression($value) ? <span class="keyword">$this</span>-&gt;getValue($value) : <span class="string">'?'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>wherebasic</code> 函数对参数进行了替换，利用 <code>?</code> 来替换真正的值。</p>
<h2 id="orWhere-语句"><a href="#orWhere-语句" class="headerlink" title="orWhere 语句"></a>orWhere 语句</h2><p><code>orWhere</code> 函数只是在 <code>where</code> 函数的基础上固定了最后一个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">orWhere</span><span class="params">($column, $operator = null, $value = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;where($column, $operator, $value, <span class="string">'or'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="whereColumn-语句"><a href="#whereColumn-语句" class="headerlink" title="whereColumn 语句"></a>whereColumn 语句</h2><p><code>whereColumn</code> 函数是简化版的 <code>where</code> 函数，只是 <code>where</code> 类型不是 <code>basic</code>，而是 <code>column</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">whereColumn</span><span class="params">($first, $operator = null, $second = null, $boolean = <span class="string">'and'</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (is_array($first)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;addArrayOfWheres($first, $boolean, <span class="string">'whereColumn'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;invalidOperator($operator)) &#123;</div><div class="line">        <span class="keyword">list</span>($second, $operator) = [$operator, <span class="string">'='</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $type = <span class="string">'Column'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(</div><div class="line">        <span class="string">'type'</span>, <span class="string">'first'</span>, <span class="string">'operator'</span>, <span class="string">'second'</span>, <span class="string">'boolean'</span></div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="grammer——whereColumn"><a href="#grammer——whereColumn" class="headerlink" title="grammer——whereColumn"></a>grammer——whereColumn</h3><p>可以看到 <code>whereColumn</code> 与 <code>whereBasic</code> 的区别是对 <code>value</code> 的不同处理，<code>whereBasic</code> 实际上是将其看作值，需要用 <code>?</code> 来替换，参数加载到 <code>binding</code> 中去的。而 <code>whereColumn</code> 是将 <code>second</code> 当做列名来处理，是需要经过表名、别名等处理的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereColumn</span><span class="params">(Builder $query, $where)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'first'</span>]).<span class="string">' '</span>.$where[<span class="string">'operator'</span>].<span class="string">' '</span>.<span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'second'</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="whereIn-语句"><a href="#whereIn-语句" class="headerlink" title="whereIn 语句"></a>whereIn 语句</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">whereIn</span><span class="params">($column, $values, $boolean = <span class="string">'and'</span>, $not = false)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $type = $not ? <span class="string">'NotIn'</span> : <span class="string">'In'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($values <span class="keyword">instanceof</span> EloquentBuilder) &#123;</div><div class="line">        $values = $values-&gt;getQuery();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($values <span class="keyword">instanceof</span> <span class="keyword">self</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;whereInExistingQuery(</div><div class="line">            $column, $values, $boolean, $not</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($values <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;whereInSub($column, $values, $boolean, $not);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($values <span class="keyword">instanceof</span> Arrayable) &#123;</div><div class="line">        $values = $values-&gt;toArray();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(<span class="string">'type'</span>, <span class="string">'column'</span>, <span class="string">'values'</span>, <span class="string">'boolean'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> ($values <span class="keyword">as</span> $value) &#123;</div><div class="line">        <span class="keyword">if</span> (! $value <span class="keyword">instanceof</span> Expression) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;addBinding($value, <span class="string">'where'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出来，<code>whereIn</code> 支持四种参数: <code>EloquentBuilder</code>、<code>queryBuilder</code>、<code>Closure</code>、<code>Arrayable</code>。</p>
<h3 id="whereInExistingQuery-函数"><a href="#whereInExistingQuery-函数" class="headerlink" title="whereInExistingQuery 函数"></a>whereInExistingQuery 函数</h3><p>当 <code>whereIn</code> 第二个参数是 <code>queryBuild</code> 时，就会调用 <code>whereInExistingQuery</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereInExistingQuery</span><span class="params">($column, $query, $boolean, $not)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $type = $not ? <span class="string">'NotInSub'</span> : <span class="string">'InSub'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(<span class="string">'type'</span>, <span class="string">'column'</span>, <span class="string">'query'</span>, <span class="string">'boolean'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;addBinding($query-&gt;getBindings(), <span class="string">'where'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，这个函数添加了一个类型为 <code>InSub</code> 或 <code>NotInSub</code> 类型的 <code>where</code>，我们接着在语法编译器来看：</p>
<h4 id="grammer——whereInSub-whereNotInSub"><a href="#grammer——whereInSub-whereNotInSub" class="headerlink" title="grammer——whereInSub / whereNotInSub"></a>grammer——whereInSub / whereNotInSub</h4><p><code>whereInSub</code> / <code>whereNotInSub</code> 与 <code>whereSub</code> 类似，只是 <code>operator</code> 被固定成 <code>in</code> / <code>not in</code> 而已：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereInSub</span><span class="params">(Builder $query, $where)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'column'</span>]).<span class="string">' in ('</span>.<span class="keyword">$this</span>-&gt;compileSelect($where[<span class="string">'query'</span>]).<span class="string">')'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereNotInSub</span><span class="params">(Builder $query, $where)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'column'</span>]).<span class="string">' not in ('</span>.<span class="keyword">$this</span>-&gt;compileSelect($where[<span class="string">'query'</span>]).<span class="string">')'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="whereInSub-函数"><a href="#whereInSub-函数" class="headerlink" title="whereInSub 函数"></a>whereInSub 函数</h3><p>当 <code>whereIn</code> 第二个参数是闭包函数的时候，就会调用 <code>whereInSub</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereInSub</span><span class="params">($column, Closure $callback, $boolean, $not)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $type = $not ? <span class="string">'NotInSub'</span> : <span class="string">'InSub'</span>;</div><div class="line"></div><div class="line">    call_user_func($callback, $query = <span class="keyword">$this</span>-&gt;forSubQuery());</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(<span class="string">'type'</span>, <span class="string">'column'</span>, <span class="string">'query'</span>, <span class="string">'boolean'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;addBinding($query-&gt;getBindings(), <span class="string">'where'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出来，除了闭包函数需要执行获得 <code>query</code> 对象之外，<code>whereInSub</code> 函数与 <code>whereInExistingQuery</code> 函数一致。</p>
<h3 id="In-NotIn-类型-where"><a href="#In-NotIn-类型-where" class="headerlink" title="In / NotIn 类型 where"></a>In / NotIn 类型 where</h3><p>如果参数传递了数组，那么就会创建 <code>In</code> 或者 <code>NotIn</code> 类型的 <code>where</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;wheres[] = compact(<span class="string">'type'</span>, <span class="string">'column'</span>, <span class="string">'values'</span>, <span class="string">'boolean'</span>);</div><div class="line"></div><div class="line"><span class="keyword">foreach</span> ($values <span class="keyword">as</span> $value) &#123;</div><div class="line">    <span class="keyword">if</span> (! $value <span class="keyword">instanceof</span> Expression) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;addBinding($value, <span class="string">'where'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="grammer——whereIn-whereNotIn"><a href="#grammer——whereIn-whereNotIn" class="headerlink" title="grammer——whereIn / whereNotIn"></a>grammer——whereIn / whereNotIn</h4><p><code>whereIn</code> 或者 <code>whereNotIn</code> 与 <code>whereBasic</code> 函数基本一致，只是参数值需要循环调用 <code>parameter</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereIn</span><span class="params">(Builder $query, $where)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>($where[<span class="string">'values'</span>])) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'column'</span>]).<span class="string">' in ('</span>.<span class="keyword">$this</span>-&gt;parameterize($where[<span class="string">'values'</span>]).<span class="string">')'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">'0 = 1'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereNotIn</span><span class="params">(Builder $query, $where)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>($where[<span class="string">'values'</span>])) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'column'</span>]).<span class="string">' not in ('</span>.<span class="keyword">$this</span>-&gt;parameterize($where[<span class="string">'values'</span>]).<span class="string">')'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">'1 = 1'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parameterize</span><span class="params">(array $values)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> implode(<span class="string">', '</span>, array_map([<span class="keyword">$this</span>, <span class="string">'parameter'</span>], $values));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="whereBetween-语句"><a href="#whereBetween-语句" class="headerlink" title="whereBetween 语句"></a>whereBetween 语句</h2><p>类似的 <code>whereBetween</code> 创建了新的 <code>between</code> 类型的 <code>where</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">whereBetween</span><span class="params">($column, array $values, $boolean = <span class="string">'and'</span>, $not = false)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $type = <span class="string">'between'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(<span class="string">'column'</span>, <span class="string">'type'</span>, <span class="string">'boolean'</span>, <span class="string">'not'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;addBinding($values, <span class="string">'where'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="grammer——whereBetween"><a href="#grammer——whereBetween" class="headerlink" title="grammer——whereBetween"></a>grammer——whereBetween</h3><p>有意思的是，<code>whereBetween</code> 不支持原生的参数值，也就是不支持 <code>expression</code> 对象，所以直接用 <code>?</code> 来代替参数值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereBetween</span><span class="params">(Builder $query, $where)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $between = $where[<span class="string">'not'</span>] ? <span class="string">'not between'</span> : <span class="string">'between'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'column'</span>]).<span class="string">' '</span>.$between.<span class="string">' ? and ?'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="whereExist-语句"><a href="#whereExist-语句" class="headerlink" title="whereExist 语句"></a>whereExist 语句</h2><p><code>whereExist</code> 只支持闭包函数作为子查询语句，和之前一样，创建了 <code>Exist</code> 或者 <code>NotExist</code> 类型的 <code>where</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">whereExists</span><span class="params">(Closure $callback, $boolean = <span class="string">'and'</span>, $not = false)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $query = <span class="keyword">$this</span>-&gt;forSubQuery();</div><div class="line"></div><div class="line">    call_user_func($callback, $query);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;addWhereExistsQuery($query, $boolean, $not);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addWhereExistsQuery</span><span class="params">(Builder $query, $boolean = <span class="string">'and'</span>, $not = false)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $type = $not ? <span class="string">'NotExists'</span> : <span class="string">'Exists'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(<span class="string">'type'</span>, <span class="string">'operator'</span>, <span class="string">'query'</span>, <span class="string">'boolean'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;addBinding($query-&gt;getBindings(), <span class="string">'where'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="grammer——whereExists-whereNotExists"><a href="#grammer——whereExists-whereNotExists" class="headerlink" title="grammer——whereExists / whereNotExists"></a>grammer——whereExists / whereNotExists</h3><p>可以看到，这部分的语法编译器仍然和 <code>whereSub</code> 非常类似：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereExists</span><span class="params">(Builder $query, $where)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'exists ('</span>.<span class="keyword">$this</span>-&gt;compileSelect($where[<span class="string">'query'</span>]).<span class="string">')'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereNotExists</span><span class="params">(Builder $query, $where)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'not exists ('</span>.<span class="keyword">$this</span>-&gt;compileSelect($where[<span class="string">'query'</span>]).<span class="string">')'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="whereDate-whereMonth-whereDay-whereYear-whereTime-1"><a href="#whereDate-whereMonth-whereDay-whereYear-whereTime-1" class="headerlink" title="whereDate / whereMonth / whereDay / whereYear / whereTime"></a>whereDate / whereMonth / whereDay / whereYear / whereTime</h2><p>关于时间的查询条件都由函数 <code>addDateBasedWhere</code> 负责创建新的类型的 <code>where</code>，由于这些函数大致相同，我这里只贴一种：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addDateBasedWhere</span><span class="params">($type, $column, $operator, $value, $boolean = <span class="string">'and'</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(<span class="string">'column'</span>, <span class="string">'type'</span>, <span class="string">'boolean'</span>, <span class="string">'operator'</span>, <span class="string">'value'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;addBinding($value, <span class="string">'where'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">whereDate</span><span class="params">($column, $operator, $value = null, $boolean = <span class="string">'and'</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">list</span>($value, $operator) = <span class="keyword">$this</span>-&gt;prepareValueAndOperator(</div><div class="line">        $value, $operator, func_num_args() == <span class="number">2</span></div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;addDateBasedWhere(<span class="string">'Date'</span>, $column, $operator, $value, $boolean);</div><div class="line">&#125;</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure>
<h3 id="grammer——dateBasedWhere"><a href="#grammer——dateBasedWhere" class="headerlink" title="grammer——dateBasedWhere"></a>grammer——dateBasedWhere</h3><p>时间查询条件都是利用数据库的 <code>date</code>、<code>month</code>、<code>day</code>、<code>year</code>、<code>time</code> 函数实现的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereTime</span><span class="params">(Builder $query, $where)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dateBasedWhere(<span class="string">'time'</span>, $query, $where);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">dateBasedWhere</span><span class="params">($type, Builder $query, $where)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $value = <span class="keyword">$this</span>-&gt;parameter($where[<span class="string">'value'</span>]);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $type.<span class="string">'('</span>.<span class="keyword">$this</span>-&gt;wrap($where[<span class="string">'column'</span>]).<span class="string">') '</span>.$where[<span class="string">'operator'</span>].<span class="string">' '</span>.$value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="whereRaw-语句"><a href="#whereRaw-语句" class="headerlink" title="whereRaw 语句"></a>whereRaw 语句</h2><p>原生的 <code>sql</code> 语句及其简单：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">whereRaw</span><span class="params">($sql, $bindings = [], $boolean = <span class="string">'and'</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;wheres[] = [<span class="string">'type'</span> =&gt; <span class="string">'raw'</span>, <span class="string">'sql'</span> =&gt; $sql, <span class="string">'boolean'</span> =&gt; $boolean];</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;addBinding((<span class="keyword">array</span>) $bindings, <span class="string">'where'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>语法编译器工作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">whereRaw</span><span class="params">(Builder $query, $where)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> $where[<span class="string">'sql'</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/09/16/Laravel Database——数据库的 CRUD 操作/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/16/Laravel Database——数据库的 CRUD 操作/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-16T17:17:56+08:00">
                2017-09-16
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/09/16/Laravel Database——数据库的 CRUD 操作/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/09/16/Laravel Database——数据库的 CRUD 操作/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/09/16/Laravel Database——数据库的 CRUD 操作/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Laravel-Database——数据库的-CRUD-操作"><a href="#Laravel-Database——数据库的-CRUD-操作" class="headerlink" title="Laravel Database——数据库的 CRUD 操作"></a>Laravel Database——数据库的 CRUD 操作</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>当 <code>connection</code> 对象构建初始化完成后，我们就可以利用 <code>DB</code> 来进行数据库的 <code>CRUD</code> ( <code>Create</code>、<code>Retrieve</code>、<code>Update</code>、<code>Delete</code>)操作。本篇文章，我们将会讲述 <code>laravel</code> 如何与 <code>pdo</code> 交互，实现基本数据库服务的原理。</p>
<h2 id="run"><a href="#run" class="headerlink" title="run"></a>run</h2><p><code>laravel</code> 中任何数据库的操作都要经过 <code>run</code> 这个函数，这个函数作用在于重新连接数据库、记录数据库日志、数据库异常处理：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">($query, $bindings, Closure $callback)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;reconnectIfMissingConnection();</div><div class="line"></div><div class="line">    $start = microtime(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        $result = <span class="keyword">$this</span>-&gt;runQueryCallback($query, $bindings, $callback);</div><div class="line">    &#125; <span class="keyword">catch</span> (QueryException $e) &#123;</div><div class="line">        $result = <span class="keyword">$this</span>-&gt;handleQueryException(</div><div class="line">            $e, $query, $bindings, $callback</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;logQuery(</div><div class="line">        $query, $bindings, <span class="keyword">$this</span>-&gt;getElapsedTime($start)</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="重新连接数据库-reconnect"><a href="#重新连接数据库-reconnect" class="headerlink" title="重新连接数据库 reconnect"></a>重新连接数据库 reconnect</h3><p>如果当期的 <code>pdo</code> 是空，那么就会调用 <code>reconnector</code> 重新与数据库进行连接：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">reconnectIfMissingConnection</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (is_null(<span class="keyword">$this</span>-&gt;pdo)) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;reconnect();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">reconnect</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (is_callable(<span class="keyword">$this</span>-&gt;reconnector)) &#123;</div><div class="line">        <span class="keyword">return</span> call_user_func(<span class="keyword">$this</span>-&gt;reconnector, <span class="keyword">$this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> LogicException(<span class="string">'Lost connection and no reconnector available.'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="运行数据库操作"><a href="#运行数据库操作" class="headerlink" title="运行数据库操作"></a>运行数据库操作</h3><p>数据库的 curd 操作会被包装成为一个闭包函数，作为 <code>runQueryCallback</code> 的一个参数，当运行正常时，会返回结果，如果遇到异常的话，会将异常转化为 <code>QueryException</code>，并且抛出。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runQueryCallback</span><span class="params">($query, $bindings, Closure $callback)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        $result = $callback($query, $bindings);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> QueryException(</div><div class="line">            $query, <span class="keyword">$this</span>-&gt;prepareBindings($bindings), $e</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="数据库异常处理"><a href="#数据库异常处理" class="headerlink" title="数据库异常处理"></a>数据库异常处理</h3><p>当 <code>pdo</code> 查询返回异常的时候，如果当前是事务进行时，那么直接返回异常，让上一层事务来处理。</p>
<p>如果是由于与数据库事情连接导致的异常，那么就要重新与数据库进行连接：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">handleQueryException</span><span class="params">($e, $query, $bindings, Closure $callback)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;transactions &gt;= <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> $e;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;tryAgainIfCausedByLostConnection(</div><div class="line">        $e, $query, $bindings, $callback</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与数据库失去连接：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">tryAgainIfCausedByLostConnection</span><span class="params">(QueryException $e, $query, $bindings, Closure $callback)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;causedByLostConnection($e-&gt;getPrevious())) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;reconnect();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;runQueryCallback($query, $bindings, $callback);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> $e;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">causedByLostConnection</span><span class="params">(Exception $e)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $message = $e-&gt;getMessage();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Str::contains($message, [</div><div class="line">        <span class="string">'server has gone away'</span>,</div><div class="line">        <span class="string">'no connection to the server'</span>,</div><div class="line">        <span class="string">'Lost connection'</span>,</div><div class="line">        <span class="string">'is dead or not enabled'</span>,</div><div class="line">        <span class="string">'Error while sending'</span>,</div><div class="line">        <span class="string">'decryption failed or bad record mac'</span>,</div><div class="line">        <span class="string">'server closed the connection unexpectedly'</span>,</div><div class="line">        <span class="string">'SSL connection has been closed unexpectedly'</span>,</div><div class="line">        <span class="string">'Error writing data to the connection'</span>,</div><div class="line">        <span class="string">'Resource deadlock avoided'</span>,</div><div class="line">        <span class="string">'Transaction() on null'</span>,</div><div class="line">        <span class="string">'child connection forced to terminate due to client_idle_limit'</span>,</div><div class="line">    ]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="数据库日志"><a href="#数据库日志" class="headerlink" title="数据库日志"></a>数据库日志</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">logQuery</span><span class="params">($query, $bindings, $time = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;event(<span class="keyword">new</span> QueryExecuted($query, $bindings, $time, <span class="keyword">$this</span>));</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;loggingQueries) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;queryLog[] = compact(<span class="string">'query'</span>, <span class="string">'bindings'</span>, <span class="string">'time'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>想要开启或关闭日志功能：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">enableQueryLog</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;loggingQueries = <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">disableQueryLog</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;loggingQueries = <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Select-查询"><a href="#Select-查询" class="headerlink" title="Select 查询"></a>Select 查询</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span><span class="params">($query, $bindings = [], $useReadPdo = true)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;run($query, $bindings, <span class="function"><span class="keyword">function</span> <span class="params">($query, $bindings)</span> <span class="title">use</span> <span class="params">($useReadPdo)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;pretending()) &#123;</div><div class="line">            <span class="keyword">return</span> [];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $statement = <span class="keyword">$this</span>-&gt;prepared(<span class="keyword">$this</span>-&gt;getPdoForSelect($useReadPdo)</div><div class="line">                          -&gt;prepare($query));</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;bindValues($statement, <span class="keyword">$this</span>-&gt;prepareBindings($bindings));</div><div class="line"></div><div class="line">        $statement-&gt;execute();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $statement-&gt;fetchAll();</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>数据库的查询主要有一下几个步骤：</p>
<ul>
<li>获取 <code>$this-&gt;pdo</code> 成员变量，若当前未连接数据库，则进行数据库连接，获取 <code>pdo</code> 对象。</li>
<li>设置 <code>pdo</code> 数据 <code>fetch</code> 模式</li>
<li><code>pdo</code> 进行 <code>sql</code> 语句预处理，<code>pdo</code> 绑定参数</li>
<li><code>sql</code> 语句执行，并获取数据。</li>
</ul>
<h3 id="getPdoForSelect-获取-pdo-对象"><a href="#getPdoForSelect-获取-pdo-对象" class="headerlink" title="getPdoForSelect 获取 pdo 对象"></a>getPdoForSelect 获取 pdo 对象</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getPdoForSelect</span><span class="params">($useReadPdo = true)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> $useReadPdo ? <span class="keyword">$this</span>-&gt;getReadPdo() : <span class="keyword">$this</span>-&gt;getPdo();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getPdo</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;pdo <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;pdo = call_user_func(<span class="keyword">$this</span>-&gt;pdo);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;pdo;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getReadPdo</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;transactions &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getPdo();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;getConfig(<span class="string">'sticky'</span>) &amp;&amp; <span class="keyword">$this</span>-&gt;recordsModified) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getPdo();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;readPdo <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;readPdo = call_user_func(<span class="keyword">$this</span>-&gt;readPdo);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;readPdo ?: <span class="keyword">$this</span>-&gt;getPdo();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>getPdo</code> 这里逻辑比较简单，值得我们注意的是 <code>getReadPdo</code>。为了减缓数据库的压力，我们常常对数据库进行读写分离，也就是只要当写数据库这种操作发生时，才会使用写数据库，否则都会用读数据库。这种措施减少了数据库的压力，但是也带来了一些问题，那就是读写两个数据库在一定时间内会出现数据不一致的情况，原因就是写库的数据未能及时推送给读库，造成读库数据延迟的现象。为了在一定程度上解决这类问题，<code>laravel</code> 增添了 <code>sticky</code> 选项，</p>
<p>从程序中我们可以看出，当我们设置选项 <code>sticky</code> 为真，并且的确对数据库进行了写操作后，<code>getReadPdo</code> 会强制返回主库的连接，这样就避免了读写分离造成的延迟问题。</p>
<p>还有一种情况，当数据库在执行事务期间，所有的读取操作也会被强制连接主库。</p>
<h3 id="prepared-设置数据获取方式"><a href="#prepared-设置数据获取方式" class="headerlink" title="prepared 设置数据获取方式"></a>prepared 设置数据获取方式</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $fetchMode = PDO::FETCH_OBJ;</div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">prepared</span><span class="params">(PDOStatement $statement)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $statement-&gt;setFetchMode(<span class="keyword">$this</span>-&gt;fetchMode);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;event(<span class="keyword">new</span> Events\StatementPrepared(</div><div class="line">        <span class="keyword">$this</span>, $statement</div><div class="line">    ));</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $statement;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>pdo</code> 的 <code>setFetchMode</code> 函数用于为语句设置默认的获取模式，通常模式有一下几种：</p>
<ul>
<li>PDO::FETCH_ASSOC       //从结果集中获取以列名为索引的关联数组。</li>
<li>PDO::FETCH_NUM         //从结果集中获取一个以列在行中的数值偏移量为索引的值数组。</li>
<li>PDO::FETCH_BOTH        //这是默认值，包含上面两种数组。</li>
<li>PDO::FETCH_OBJ         //从结果集当前行的记录中获取其属性对应各个列名的一个对象。</li>
<li>PDO::FETCH_BOUND       //使用fetch()返回TRUE，并将获取的列值赋给在bindParm()方法中指定的相应变量。</li>
<li>PDO::FETCH_LAZY        //创建关联数组和索引数组，以及包含列属性的一个对象，从而可以在这三种接口中任选一种。</li>
</ul>
<h3 id="pdo-的-prepare-函数"><a href="#pdo-的-prepare-函数" class="headerlink" title="pdo 的 prepare 函数"></a>pdo 的 prepare 函数</h3><p><code>prepare</code> 函数会为 <code>PDOStatement::execute()</code> 方法准备要执行的 <code>SQL</code> 语句，<code>SQL</code> 语句可以包含零个或多个命名（<code>:name</code>）或问号（<code>?</code>）参数标记，参数在SQL执行时会被替换。</p>
<p>不能在 <code>SQL</code> 语句中同时包含命名（<code>:name</code>）或问号（<code>?</code>）参数标记，只能选择其中一种风格。</p>
<p>预处理 <code>SQL</code> 语句中的参数在使用 <code>PDOStatement::execute()</code> 方法时会传递真实的参数。</p>
<p>之所以使用 <code>prepare</code> 函数，是因为这个函数可以防止 <code>SQL</code> 注入，并且可以加快同一查询语句的速度。关于预处理与参数绑定防止 <code>SQL</code> 漏洞注入的原理可以参考：<a href="http://www.cnblogs.com/csniper/p/5802202.html" target="_blank" rel="external">Web安全之SQL注入攻击技巧与防范</a>.</p>
<h3 id="pdo-的-bindValues-函数"><a href="#pdo-的-bindValues-函数" class="headerlink" title="pdo 的 bindValues 函数"></a>pdo 的 bindValues 函数</h3><p>在调用 <code>pdo</code> 的参数绑定函数之前，<code>laravel</code> 对参数值进一步进行了优化，把时间类型的对象利用 <code>grammer</code> 的设置重新格式化，<code>false</code> 也改为0。</p>
<p><code>pdo</code> 的参数绑定函数 <code>bindValue</code>，对于使用命名占位符的预处理语句，应是类似 :name 形式的参数名。对于使用问号占位符的预处理语句，应是以1开始索引的参数位置。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">prepareBindings</span><span class="params">(array $bindings)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $grammar = <span class="keyword">$this</span>-&gt;getQueryGrammar();</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> ($bindings <span class="keyword">as</span> $key =&gt; $value) &#123;</div><div class="line">        <span class="keyword">if</span> ($value <span class="keyword">instanceof</span> DateTimeInterface) &#123;</div><div class="line">            $bindings[$key] = $value-&gt;format($grammar-&gt;getDateFormat());</div><div class="line">        &#125; <span class="keyword">elseif</span> ($value === <span class="keyword">false</span>) &#123;</div><div class="line">            $bindings[$key] = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $bindings;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bindValues</span><span class="params">($statement, $bindings)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">foreach</span> ($bindings <span class="keyword">as</span> $key =&gt; $value) &#123;</div><div class="line">        $statement-&gt;bindValue(</div><div class="line">            is_string($key) ? $key : $key + <span class="number">1</span>, $value,</div><div class="line">            is_int($value) ? PDO::PARAM_INT : PDO::PARAM_STR</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="insert"><a href="#insert" class="headerlink" title="insert"></a>insert</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert</span><span class="params">($query, $bindings = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;statement($query, $bindings);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">statement</span><span class="params">($query, $bindings = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;run($query, $bindings, <span class="function"><span class="keyword">function</span> <span class="params">($query, $bindings)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;pretending()) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $statement = <span class="keyword">$this</span>-&gt;getPdo()-&gt;prepare($query);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;bindValues($statement, <span class="keyword">$this</span>-&gt;prepareBindings($bindings));</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;recordsHaveBeenModified();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $statement-&gt;execute();</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这部分的代码与 <code>select</code> 非常相似，不同之处有一下几个：</p>
<ul>
<li>直接获取写库的连接，不会考虑读库</li>
<li>由于不需要返回任何数据库数据，因此也不必设置 <code>fetchMode</code>。</li>
<li><code>recordsHaveBeenModified</code> 函数标志当前连接数据库已被写入。</li>
<li>不需要调用函数 <code>fetchAll</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">recordsHaveBeenModified</span><span class="params">($value = true)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;recordsModified) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;recordsModified = $value;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="update、delete"><a href="#update、delete" class="headerlink" title="update、delete"></a>update、delete</h2><p><code>affectingStatement</code> 这个函数与上面的 <code>statement</code> 函数一致，只是最后会返回更新、删除影响的行数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">($query, $bindings = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;affectingStatement($query, $bindings);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span><span class="params">($query, $bindings = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;affectingStatement($query, $bindings);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">affectingStatement</span><span class="params">($query, $bindings = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;run($query, $bindings, <span class="function"><span class="keyword">function</span> <span class="params">($query, $bindings)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;pretending()) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $statement = <span class="keyword">$this</span>-&gt;getPdo()-&gt;prepare($query);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;bindValues($statement, <span class="keyword">$this</span>-&gt;prepareBindings($bindings));</div><div class="line"></div><div class="line">        $statement-&gt;execute();</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;recordsHaveBeenModified(</div><div class="line">            ($count = $statement-&gt;rowCount()) &gt; <span class="number">0</span></div><div class="line">        );</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $count;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="transaction-数据库事务"><a href="#transaction-数据库事务" class="headerlink" title="transaction 数据库事务"></a>transaction 数据库事务</h2><p>为保持数据的一致性，对于重要的数据我们经常使用数据库事务，<code>transaction</code> 函数接受一个闭包函数，与一个重复尝试的次数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">transaction</span><span class="params">(Closure $callback, $attempts = <span class="number">1</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">for</span> ($currentAttempt = <span class="number">1</span>; $currentAttempt &lt;= $attempts; $currentAttempt++) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;beginTransaction();</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> tap($callback(<span class="keyword">$this</span>), <span class="function"><span class="keyword">function</span> <span class="params">($result)</span> </span>&#123;</div><div class="line">                <span class="keyword">$this</span>-&gt;commit();</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;handleTransactionException(</div><div class="line">                $e, $currentAttempt, $attempts</div><div class="line">            );</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable $e) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;rollBack();</div><div class="line"></div><div class="line">            <span class="keyword">throw</span> $e;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="开始事务"><a href="#开始事务" class="headerlink" title="开始事务"></a>开始事务</h3><p>数据库事务中非常重要的成员变量是 <code>$this-&gt;transactions</code>，它标志着当前事务的进程：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">beginTransaction</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;createTransaction();</div><div class="line"></div><div class="line">    ++<span class="keyword">$this</span>-&gt;transactions;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;fireConnectionEvent(<span class="string">'beganTransaction'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，当创建事务成功后，就会累加 <code>$this-&gt;transactions</code>，并且启动 <code>event</code>，创建事务：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createTransaction</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;transactions == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;getPdo()-&gt;beginTransaction();</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;handleBeginTransactionException($e);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">$this</span>-&gt;transactions &gt;= <span class="number">1</span> &amp;&amp; <span class="keyword">$this</span>-&gt;queryGrammar-&gt;supportsSavepoints()) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;createSavepoint();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果当前没有任何事务，那么就会调用 <code>pdo</code> 来开启事务。</p>
<p>如果当前已经在事务保护的范围内，那么就会创建 <code>SAVEPOINT</code>，实现数据库嵌套事务：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createSavepoint</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;getPdo()-&gt;exec(</div><div class="line">        <span class="keyword">$this</span>-&gt;queryGrammar-&gt;compileSavepoint(<span class="string">'trans'</span>.(<span class="keyword">$this</span>-&gt;transactions + <span class="number">1</span>))</div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">compileSavepoint</span><span class="params">($name)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'SAVEPOINT '</span>.$name;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果创建事务失败，那么就会调用 <code>handleBeginTransactionException</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">handleBeginTransactionException</span><span class="params">($e)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;causedByLostConnection($e)) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;reconnect();</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;pdo-&gt;beginTransaction();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">throw</span> $e;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果创建事务失败是由于与数据库失去连接的话，那么就会重新连接数据库，否则就要抛出异常。</p>
<h3 id="事务异常"><a href="#事务异常" class="headerlink" title="事务异常"></a>事务异常</h3><p>事务的异常处理比较复杂，可以先看一看代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">handleTransactionException</span><span class="params">($e, $currentAttempt, $maxAttempts)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;causedByDeadlock($e) &amp;&amp;</div><div class="line">        <span class="keyword">$this</span>-&gt;transactions &gt; <span class="number">1</span>) &#123;</div><div class="line">        --<span class="keyword">$this</span>-&gt;transactions;</div><div class="line"></div><div class="line">        <span class="keyword">throw</span> $e;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;rollBack();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;causedByDeadlock($e) &amp;&amp;</div><div class="line">        $currentAttempt &lt; $maxAttempts) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> $e;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">causedByDeadlock</span><span class="params">(Exception $e)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $message = $e-&gt;getMessage();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Str::contains($message, [</div><div class="line">        <span class="string">'Deadlock found when trying to get lock'</span>,</div><div class="line">        <span class="string">'deadlock detected'</span>,</div><div class="line">        <span class="string">'The database file is locked'</span>,</div><div class="line">        <span class="string">'database is locked'</span>,</div><div class="line">        <span class="string">'database table is locked'</span>,</div><div class="line">        <span class="string">'A table in the database is locked'</span>,</div><div class="line">        <span class="string">'has been chosen as the deadlock victim'</span>,</div><div class="line">        <span class="string">'Lock wait timeout exceeded; try restarting transaction'</span>,</div><div class="line">    ]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里可以分为四种情况：</p>
<ul>
<li>单一事务，非死锁导致的异常</li>
</ul>
<p>单一事务就是说，此时的事务只有一层，没有嵌套事务的存在。数据库的异常也不是死锁导致的，一般是由于 <code>sql</code> 语句不正确引起的。这个时候，<code>handleTransactionException</code> 会直接回滚事务，并且抛出异常到外层：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">return</span> tap($callback(<span class="keyword">$this</span>), <span class="function"><span class="keyword">function</span> <span class="params">($result)</span> </span>&#123;</div><div class="line">          <span class="keyword">$this</span>-&gt;commit();</div><div class="line">      &#125;);</div><div class="line">&#125;</div><div class="line"><span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</div><div class="line">     <span class="keyword">$this</span>-&gt;handleTransactionException(</div><div class="line">         $e, $currentAttempt, $attempts</div><div class="line">     );</div><div class="line">&#125; <span class="keyword">catch</span> (Throwable $e) &#123;</div><div class="line">       <span class="keyword">$this</span>-&gt;rollBack();</div><div class="line"></div><div class="line">       <span class="keyword">throw</span> $e;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接到异常之后，程序会再次回滚，但是由于 <code>$this-&gt;transactions</code> 已经为 0，因此回滚直接返回，并未真正执行，之后就会抛出异常。</p>
<ul>
<li>单一事务，死锁异常</li>
</ul>
<p>有死锁导致的单一事务异常，一般是由于其他程序同时更改了数据库，这个时候，就要判断当前重复尝试的次数是否大于用户设置的 <code>maxAttempts</code>，如果小于就继续尝试，如果大于，那么就会抛出异常。</p>
<ul>
<li>嵌套事务，非死锁异常</li>
</ul>
<p>如果出现嵌套事务，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">\DB::transaction(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">//directly or indirectly call another transaction:</span></div><div class="line">    \DB::transaction(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</div><div class="line">        ...</div><div class="line">        ...</div><div class="line">    &#125;, <span class="number">2</span>);<span class="comment">//attempt twice</span></div><div class="line">&#125;, <span class="number">2</span>);<span class="comment">//attempt twice</span></div></pre></td></tr></table></figure>
<p>如果是非死锁导致的异常，那么就要首先回滚内层的事务，抛出异常到外层事务，再回滚外层事务，抛出异常，让用户来处理。也就是说，对于嵌套事务来说，内部事务异常，一定要回滚整个事务，而不是仅仅回滚内部事务。</p>
<ul>
<li>嵌套事务，死锁异常</li>
</ul>
<p>嵌套事务的死锁异常，仍然和嵌套事务非死锁异常一样，内部事务异常，一定要回滚整个事务。</p>
<p>但是，不同的是，<code>mysql</code> 对于嵌套事务的回滚会导致外部事务一并回滚:<a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-error-handling.html" target="_blank" rel="external">InnoDB Error Handling</a>，因此这时，我们仅仅将 <code>$this-&gt;transactions</code> 减一，并抛出异常，使得外层事务回滚抛出异常即可。</p>
<h3 id="回滚事务"><a href="#回滚事务" class="headerlink" title="回滚事务"></a>回滚事务</h3><p>如果事务内的数据库更新操作失败，那么就要进行回滚：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rollBack</span><span class="params">($toLevel = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $toLevel = is_null($toLevel)</div><div class="line">                ? <span class="keyword">$this</span>-&gt;transactions - <span class="number">1</span></div><div class="line">                : $toLevel;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($toLevel &lt; <span class="number">0</span> || $toLevel &gt;= <span class="keyword">$this</span>-&gt;transactions) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;performRollBack($toLevel);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;transactions = $toLevel;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;fireConnectionEvent(<span class="string">'rollingBack'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>回滚的第一件事就是要减少 <code>$this-&gt;transactions</code> 的值，标志当前事务失败。</p>
<p>回滚的时候仍然要判断当前事务的状态，如果当前处于嵌套事务的话，就要进行回滚到 <code>SAVEPOINT</code>，如果是单一事务的话，才会真正回滚退出事务：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">performRollBack</span><span class="params">($toLevel)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> ($toLevel == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;getPdo()-&gt;rollBack();</div><div class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">$this</span>-&gt;queryGrammar-&gt;supportsSavepoints()) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;getPdo()-&gt;exec(</div><div class="line">            <span class="keyword">$this</span>-&gt;queryGrammar-&gt;compileSavepointRollBack(<span class="string">'trans'</span>.($toLevel + <span class="number">1</span>))</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">compileSavepointRollBack</span><span class="params">($name)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'ROLLBACK TO SAVEPOINT '</span>.$name;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="提交事务"><a href="#提交事务" class="headerlink" title="提交事务"></a>提交事务</h2><p>提交事务比较简单，仅仅是调用 <code>pdo</code> 的 <code>commit</code> 即可。需要注意的是对于嵌套事务的事务提交，<code>commit</code> 函数仅仅更新了 <code>$this-&gt;transactions</code>，而并没有真正提交事务，原因是内层事务的提交对于 <code>mysql</code> 来说是无效的，只有外部事务的提交才能更新整个事务。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">commit</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;transactions == <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;getPdo()-&gt;commit();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;transactions = max(<span class="number">0</span>, <span class="keyword">$this</span>-&gt;transactions - <span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;fireConnectionEvent(<span class="string">'committed'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/09/13/Laravel Database——数据库服务的启动与连接/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/13/Laravel Database——数据库服务的启动与连接/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-13T00:50:28+08:00">
                2017-09-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/09/13/Laravel Database——数据库服务的启动与连接/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/09/13/Laravel Database——数据库服务的启动与连接/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/09/13/Laravel Database——数据库服务的启动与连接/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Laravel-Database——数据库服务的启动与连接"><a href="#Laravel-Database——数据库服务的启动与连接" class="headerlink" title="Laravel Database——数据库服务的启动与连接"></a>Laravel Database——数据库服务的启动与连接</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>数据库是 <code>laravel</code> 及其重要的组成部分，大致的讲，<code>laravel</code> 的数据库功能可以分为两部分：数据库 <code>DB</code>、数据库 <code>Eloquent Model</code>。数据库的 <code>Eloquent</code> 是功能十分丰富的 <code>ORM</code>，让我们可以避免写繁杂的 <code>sql</code> 语句。数据库 <code>DB</code> 是比较底层的与 <code>pdo</code> 交互的功能，<code>Eloquent</code> 的底层依赖于 <code>DB</code>。本文将会介绍数据库 <code>DB</code> 中关于数据库服务的启动与连接部分。</p>
<p>在详细讲解数据库各个功能之前，我们先看看支撑着整个 <code>laravel</code> 数据库功能的框架：</p>
<p><img src="http://i4.bvimg.com/593560/51a4d30b1f7231d3.png" alt="Markdown"></p>
<ul>
<li><code>DB</code> 也就是 <code>DatabaseManager</code>，承担着数据库接口的工作，一切数据库相关的操作，例如查询、更新、插入、删除都可以通过 <code>DB</code> 这个接口来完成。但是，具体的调用 <code>pdo</code> API 的工作却不是由该类完成的，它仅仅是一个对外的接口而已。</li>
<li><code>ConnectionFactory</code> 顾名思义专门为 <code>DB</code> 构造初始化 <code>connector</code>、<code>connection</code> 对象， </li>
<li><code>connector</code> 负责数据库的连接功能，为保障程序的高效，<code>laravel</code> 将其包装成为闭包函数，并将闭包函数作为 <code>connection</code> 的一个成员对象，实现懒加载。</li>
<li><code>connection</code> 负责数据库的具体功能，负责底层与 <code>pdo</code> API 的交互。</li>
</ul>
<h2 id="数据库服务的注册与启动"><a href="#数据库服务的注册与启动" class="headerlink" title="数据库服务的注册与启动"></a>数据库服务的注册与启动</h2><p>数据库服务也是一种服务提供者：<code>Illuminate\Database\DatabaseServiceProvider</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    Model::clearBootedModels();</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;registerConnectionServices();</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;registerEloquentFactory();</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;registerQueueableEntityResolver();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们先来看这个注册函数的第一句: <code>Model::clearBootedModels()</code>。这一句其实是为了 <code>Eloquent</code> 服务的启动做准备。数据库的 <code>Eloquent Model</code> 有一个静态的成员变量数组 <code>$booted</code>，这个静态数组存储了所有已经被初始化的数据库 <code>model</code> ，以便加载数据库模型时更加迅速。因此，在 <code>Eloquent</code> 服务启动之前需要初始化静态成员变量 <code>$booted</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">clearBootedModels</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">static</span>::$booted = [];</div><div class="line"></div><div class="line">    <span class="keyword">static</span>::$globalScopes = [];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来我们就开始看数据库服务的注册最重要的两部分：<code>ConnectionServices</code> 与 <code>Eloquent</code>.</p>
<h3 id="ConnectionServices-注册"><a href="#ConnectionServices-注册" class="headerlink" title="ConnectionServices 注册"></a>ConnectionServices 注册</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerConnectionServices</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;app-&gt;singleton(<span class="string">'db.factory'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ConnectionFactory($app);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">   <span class="keyword">$this</span>-&gt;app-&gt;singleton(<span class="string">'db'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DatabaseManager($app, $app[<span class="string">'db.factory'</span>]);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;app-&gt;bind(<span class="string">'db.connection'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $app[<span class="string">'db'</span>]-&gt;connection();</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，数据库服务向 <code>IOC</code> 容器注册了 <code>db</code>、<code>db.factory</code> 与 <code>db.connection</code>。</p>
<ul>
<li>最重要的莫过于 <code>db</code> 对象，它有一个 <code>Facade</code> 是 <code>DB</code>， 我们可以利用 <code>DB::connection()</code> 来连接任意数据库，可以利用 <code>DB::select()</code> 来进行数据库的查询，可以说 <code>DB</code> 就是我们操作数据库的接口。</li>
<li><code>db.factory</code> 负责为 <code>DB</code> 创建 <code>connector</code> 提供数据库的底层连接服务，负责为 <code>DB</code> 创建 <code>connection</code> 对象来进行数据库的查询等操作。</li>
<li><code>db.cønnection</code> 是 <code>laravel</code> 用于与数据库 <code>pdo</code> 接口进行交互的底层类，可用于数据库的查询、更新、创建等操作。</li>
</ul>
<h3 id="Eloquent-注册"><a href="#Eloquent-注册" class="headerlink" title="Eloquent 注册"></a>Eloquent 注册</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerEloquentFactory</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;app-&gt;singleton(FakerGenerator::class, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> FakerFactory::create();</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;app-&gt;singleton(EloquentFactory::class, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> EloquentFactory::construct(</div><div class="line">            $app-&gt;make(FakerGenerator::class), database_path(<span class="string">'factories'</span>)</div><div class="line">        );</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>EloquentFactory</code> 用于创建 <code>Eloquent Model</code>，用于全局函数 <code>factory()</code> 来创建数据库模型。</p>
<h3 id="数据库服务的启动"><a href="#数据库服务的启动" class="headerlink" title="数据库服务的启动"></a>数据库服务的启动</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    Model::setConnectionResolver(<span class="keyword">$this</span>-&gt;app[<span class="string">'db'</span>]);</div><div class="line"></div><div class="line">    Model::setEventDispatcher(<span class="keyword">$this</span>-&gt;app[<span class="string">'events'</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>数据库服务的启动主要设置 <code>Eloquent Model</code> 的 <code>connection resolver</code>，用于数据库模型 <code>model</code> 利用 <code>db</code> 来来连接数据库。<br>还有设置数据库事件的分发器 <code>dispatcher</code>，用于监听数据库的事件。</p>
<h2 id="DatabaseManager——数据库的接口"><a href="#DatabaseManager——数据库的接口" class="headerlink" title="DatabaseManager——数据库的接口"></a>DatabaseManager——数据库的接口</h2><p>如果我们想要使用任何数据库服务，首先要做的事情当然是利用用户名与密码来连接数据库。在 <code>laravel</code> 中，数据库的用户名与密码一般放在 <code>.env</code> 文件中或者放入 <code>nginx</code> 配置中，并且利用数据库的接口 <code>DB</code> 来与 <code>pdo</code> 进行交互，利用 <code>pdo</code> 来连接数据库。</p>
<p><code>DB</code> 即是类 <code>Illuminate\Database\DatabaseManager</code>，首先我们来看看其构造函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($app, ConnectionFactory $factory)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;app = $app;</div><div class="line">    <span class="keyword">$this</span>-&gt;factory = $factory;</div><div class="line">&#125;</div><div class="line">``` </div><div class="line">我们称 `DB` 为一个接口，或者是一个门面模式，是因为数据库操作，例如数据库的连接或者查询、更新等操作均不是 `DB` 的功能，数据库的连接使用类 `Illuminate\Database\Connectors\Connector` 完成，数据库的查询等操作由类 `Illuminate\Database\Connection` 完成，</div><div class="line"></div><div class="line">因此，我们不必直接操作 `connector` 或者 `connection`，仅仅会操作 `DB` 即可。</div><div class="line"></div><div class="line">那么 `DB` 是如何实现 `connector` 或者 `connection` 的功能的呢？关键还是这个 `ConnectionFactory` 类，这个工厂类专门为 `DB` 来生成 `connection` 对象，并将其放入 `DB` 的成员变量数组 `$connections` 中去。`connection` 中会包含 `connector` 对象来实现数据库的连接工作。</div><div class="line"></div><div class="line">```php</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DatabaseManager</span> <span class="keyword">implements</span> <span class="title">ConnectionResolverInterface</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">protected</span> $app;</div><div class="line">	<span class="keyword">protected</span> $factory;</div><div class="line">	<span class="keyword">protected</span> $connections = [];</div><div class="line">	</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $parameters)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;connection()-&gt;$method(...$parameters);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>魔术函数实现了 <code>DB</code> 与 <code>connection</code> 的无缝连接，任何对数据库的操作，例如 <code>DB::select()</code>、<code>DB::table(&#39;user&#39;)-&gt;save()</code>，都会被转移至 <code>connection</code> 中去。</p>
<h3 id="connection-函数——获取数据库连接对象"><a href="#connection-函数——获取数据库连接对象" class="headerlink" title="connection 函数——获取数据库连接对象"></a>connection 函数——获取数据库连接对象</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">connection</span><span class="params">($name = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">list</span>($database, $type) = <span class="keyword">$this</span>-&gt;parseConnectionName($name);</div><div class="line"></div><div class="line">    $name = $name ?: $database;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;connections[$name])) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;connections[$name] = <span class="keyword">$this</span>-&gt;configure(</div><div class="line">                $connection = <span class="keyword">$this</span>-&gt;makeConnection($database), $type</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;connections[$name];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>具体流程如下：</p>
<p><img src="http://i4.bvimg.com/593560/8b709ecb8a9c6cf5.png" alt="Markdown"></p>
<p><code>DB</code> 的 <code>connection</code> 函数可以传入数据库的名字，也可以不传任何参数，此时会连接默认数据库，默认数据库的设置在 <code>config/database</code> 文件中。</p>
<p><code>connection</code> 函数流程：</p>
<ul>
<li>解析数据库名称与数据库类型，例如只读、写</li>
<li>若没有创建过与该数据库的连接，则开始创建数据库连接</li>
<li>返回数据库连接对象 <code>connection</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseConnectionName</span><span class="params">($name)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $name = $name ?: <span class="keyword">$this</span>-&gt;getDefaultConnection();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Str::endsWith($name, [<span class="string">'::read'</span>, <span class="string">'::write'</span>])</div><div class="line">                        ? explode(<span class="string">'::'</span>, $name, <span class="number">2</span>) : [$name, <span class="keyword">null</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDefaultConnection</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;app[<span class="string">'config'</span>][<span class="string">'database.default'</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，若没有特别指定连接的数据库名称，那么就会利用文件 <code>config/database</code> 文件中设置的 <code>default</code> 数据库名称作为默认连接数据库名称。若数据库支持读写分离，那么还可以指定数据库的读写属性，例如 <code>mysql::read</code>。</p>
<h3 id="makeConnection-函数——创建新的数据库连接对象"><a href="#makeConnection-函数——创建新的数据库连接对象" class="headerlink" title="makeConnection 函数——创建新的数据库连接对象"></a>makeConnection 函数——创建新的数据库连接对象</h3><p>当框架从未连接过当前数据库的时候，就要对数据库进行连接操作，首先程序会调用 <code>makeConnection</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">makeConnection</span><span class="params">($name)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $config = <span class="keyword">$this</span>-&gt;configuration($name);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;extensions[$name])) &#123;</div><div class="line">        <span class="keyword">return</span> call_user_func(<span class="keyword">$this</span>-&gt;extensions[$name], $config, $name);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;extensions[$driver = $config[<span class="string">'driver'</span>]])) &#123;</div><div class="line">        <span class="keyword">return</span> call_user_func(<span class="keyword">$this</span>-&gt;extensions[$driver], $config, $name);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;factory-&gt;make($config, $name);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，连接数据库仅仅需要两个步骤：获取数据库配置、利用 <code>connection factory</code> 获取 <code>connection</code> 对象。</p>
<p>获取数据库配置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">configuration</span><span class="params">($name)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $name = $name ?: <span class="keyword">$this</span>-&gt;getDefaultConnection();</div><div class="line"></div><div class="line">    $connections = <span class="keyword">$this</span>-&gt;app[<span class="string">'config'</span>][<span class="string">'database.connections'</span>];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (is_null($config = Arr::get($connections, $name))) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(<span class="string">"Database [$name] not configured."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $config;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>也是非常简单，直接从配置文件中获取当前数据库的配置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="string">'connections'</span> =&gt; [</div><div class="line">    <span class="string">'mysql'</span> =&gt; [</div><div class="line">        <span class="string">'driver'</span> =&gt; <span class="string">'mysql'</span>,</div><div class="line">        <span class="string">'host'</span> =&gt; env(<span class="string">'DB_HOST'</span>, <span class="string">'127.0.0.1'</span>),</div><div class="line">        <span class="string">'port'</span> =&gt; env(<span class="string">'DB_PORT'</span>, <span class="string">'3306'</span>),</div><div class="line">        <span class="string">'database'</span> =&gt; env(<span class="string">'DB_DATABASE'</span>, <span class="string">'forge'</span>),</div><div class="line">        <span class="string">'username'</span> =&gt; env(<span class="string">'DB_USERNAME'</span>, <span class="string">'forge'</span>),</div><div class="line">        <span class="string">'password'</span> =&gt; env(<span class="string">'DB_PASSWORD'</span>, <span class="string">''</span>),</div><div class="line">        <span class="string">'charset'</span> =&gt; <span class="string">'utf8mb4'</span>,</div><div class="line">        <span class="string">'collation'</span> =&gt; <span class="string">'utf8mb4_unicode_ci'</span>,</div><div class="line">        <span class="string">'prefix'</span> =&gt; <span class="string">''</span>,</div><div class="line">        <span class="string">'strict'</span> =&gt; <span class="keyword">true</span>,</div><div class="line">        <span class="string">'engine'</span> =&gt; <span class="keyword">null</span>,</div><div class="line">        <span class="string">'read'</span> =&gt; [</div><div class="line">            <span class="string">'database'</span>  =&gt; env(<span class="string">'DB_DATABASE'</span>, <span class="string">'forge'</span>),</div><div class="line">        ],</div><div class="line">        <span class="string">'write'</span> =&gt; [</div><div class="line">            <span class="string">'database'</span>  =&gt; env(<span class="string">'DB_DATABASE'</span>, <span class="string">'forge'</span>),</div><div class="line">        ],</div><div class="line">    ],</div><div class="line">],</div></pre></td></tr></table></figure>
<p><code>$this-&gt;factory-&gt;make($config, $name)</code> 函数向我们提供了数据库连接对象。</p>
<h3 id="configure——连接对象读写配置"><a href="#configure——连接对象读写配置" class="headerlink" title="configure——连接对象读写配置"></a>configure——连接对象读写配置</h3><p>当我们从 <code>connection factory</code> 中获取到连接对象 <code>connection</code> 之后，我们就要根据传入的参数进行读写配置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">configure</span><span class="params">(Connection $connection, $type)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $connection = <span class="keyword">$this</span>-&gt;setPdoForType($connection, $type);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;app-&gt;bound(<span class="string">'events'</span>)) &#123;</div><div class="line">        $connection-&gt;setEventDispatcher(<span class="keyword">$this</span>-&gt;app[<span class="string">'events'</span>]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $connection-&gt;setReconnector(<span class="function"><span class="keyword">function</span> <span class="params">($connection)</span> </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;reconnect($connection-&gt;getName());</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $connection;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>setPdoForType</code> 函数就是根据 <code>type</code> 来设置读写：</p>
<p>当我们需要 <code>read</code> 数据库连接时，我们将 <code>read-pdo</code> 设置为主 <code>pdo</code>。当我们需要 <code>write</code> 数据库连接时，我们将读写 <code>pdo</code> 都设置为 <code>write-pdo</code>：  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setPdoForType</span><span class="params">(Connection $connection, $type = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> ($type == <span class="string">'read'</span>) &#123;</div><div class="line">        $connection-&gt;setPdo($connection-&gt;getReadPdo());</div><div class="line">    &#125; <span class="keyword">elseif</span> ($type == <span class="string">'write'</span>) &#123;</div><div class="line">        $connection-&gt;setReadPdo($connection-&gt;getPdo());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $connection;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ConnectionFactory——数据库连接对象工厂"><a href="#ConnectionFactory——数据库连接对象工厂" class="headerlink" title="ConnectionFactory——数据库连接对象工厂"></a>ConnectionFactory——数据库连接对象工厂</h2><p><img src="http://i4.bvimg.com/593560/bc5fdc170a074e1c.png" alt="Markdown"></p>
<h3 id="make-函数——工厂接口"><a href="#make-函数——工厂接口" class="headerlink" title="make 函数——工厂接口"></a>make 函数——工厂接口</h3><p>获取到了数据库的配置参数之后，就要利用 <code>ConnectionFactory</code> 来获取 <code>connection</code> 对象了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">(array $config, $name = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $config = <span class="keyword">$this</span>-&gt;parseConfig($config, $name);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($config[<span class="string">'read'</span>])) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;createReadWriteConnection($config);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;createSingleConnection($config);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseConfig</span><span class="params">(array $config, $name)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> Arr::add(Arr::add($config, <span class="string">'prefix'</span>, <span class="string">''</span>), <span class="string">'name'</span>, $name);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在建立连接之前，要先向配置参数中添加默认的 <code>prefix</code> 属性与 <code>name</code> 属性。</p>
<p>接着，就要判断我们在配置文件中是否设置了读写分离。如果设置了读写分离，那么就会调用 <code>createReadWriteConnection</code> 函数，生成具有读、写两个功能的 <code>connection</code>；否则的话，就会调用 <code>createSingleConnection</code> 函数，生成普通的连接对象。</p>
<h3 id="createSingleConnection-函数——制造数据库连接对象"><a href="#createSingleConnection-函数——制造数据库连接对象" class="headerlink" title="createSingleConnection 函数——制造数据库连接对象"></a>createSingleConnection 函数——制造数据库连接对象</h3><p><code>createSingleConnection</code> 函数是类 <code>ConnectionFactory</code> 的核心，用于生成新的数据库连接对象。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createSingleConnection</span><span class="params">(array $config)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $pdo = <span class="keyword">$this</span>-&gt;createPdoResolver($config);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;createConnection(</div><div class="line">        $config[<span class="string">'driver'</span>], $pdo, $config[<span class="string">'database'</span>], $config[<span class="string">'prefix'</span>], $config</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>ConnectionFactory</code> 也很简单，只做了两件事情：制造 <code>pdo</code> 连接的闭包函数、构造一个新的 <code>connection</code> 对象。</p>
<h3 id="createPdoResolver——数据库连接器闭包函数"><a href="#createPdoResolver——数据库连接器闭包函数" class="headerlink" title="createPdoResolver——数据库连接器闭包函数"></a>createPdoResolver——数据库连接器闭包函数</h3><p>根据配置参数中是否含有 <code>host</code>，创建不同的闭包函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createPdoResolver</span><span class="params">(array $config)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> array_key_exists(<span class="string">'host'</span>, $config)</div><div class="line">                        ? <span class="keyword">$this</span>-&gt;createPdoResolverWithHosts($config)</div><div class="line">                        : <span class="keyword">$this</span>-&gt;createPdoResolverWithoutHosts($config);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不带有 <code>host</code> 的 <code>pdo</code> 闭包函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createPdoResolverWithoutHosts</span><span class="params">(array $config)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($config)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;createConnector($config)-&gt;connect($config);</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，不带有 <code>pdo</code> 的闭包函数非常简单，仅仅创建 <code>connector</code> 对象，利用 <code>connector</code> 对象进行数据库的连接。</p>
<p>带有 <code>host</code> 的 <code>pdo</code> 闭包函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createPdoResolverWithHosts</span><span class="params">(array $config)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($config)</span> </span>&#123;</div><div class="line">        <span class="keyword">foreach</span> (Arr::shuffle($hosts = <span class="keyword">$this</span>-&gt;parseHosts($config)) <span class="keyword">as</span> $key =&gt; $host) &#123;</div><div class="line">            $config[<span class="string">'host'</span>] = $host;</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;createConnector($config)-&gt;connect($config);</div><div class="line">            &#125; <span class="keyword">catch</span> (PDOException $e) &#123;</div><div class="line">                <span class="keyword">if</span> (count($hosts) - <span class="number">1</span> === $key &amp;&amp; <span class="keyword">$this</span>-&gt;container-&gt;bound(ExceptionHandler::class)) &#123;</div><div class="line">                    <span class="keyword">$this</span>-&gt;container-&gt;make(ExceptionHandler::class)-&gt;report($e);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">throw</span> $e;</div><div class="line">    &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseHosts</span><span class="params">(array $config)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $hosts = array_wrap($config[<span class="string">'host'</span>]);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($hosts)) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(<span class="string">'Database hosts array is empty.'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $hosts;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>带有 <code>host</code> 的闭包函数相对比较复杂，首先程序会随机选择不同的数据库依次来建立数据库连接，若均失败，就会报告异常。</p>
<h3 id="createConnector——创建连接器"><a href="#createConnector——创建连接器" class="headerlink" title="createConnector——创建连接器"></a>createConnector——创建连接器</h3><p>程序会根据配置参数中 <code>driver</code> 的不同来创建不同的连接器，每个连接器都继承自 <code>connector</code> 类，用于连接数据库。 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createConnector</span><span class="params">(array $config)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">isset</span>($config[<span class="string">'driver'</span>])) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(<span class="string">'A driver must be specified.'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;container-&gt;bound($key = <span class="string">"db.connector.&#123;$config['driver']&#125;"</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;container-&gt;make($key);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">switch</span> ($config[<span class="string">'driver'</span>]) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'mysql'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> MySqlConnector;</div><div class="line">        <span class="keyword">case</span> <span class="string">'pgsql'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PostgresConnector;</div><div class="line">        <span class="keyword">case</span> <span class="string">'sqlite'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SQLiteConnector;</div><div class="line">        <span class="keyword">case</span> <span class="string">'sqlsrv'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SqlServerConnector;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(<span class="string">"Unsupported driver [&#123;$config['driver']&#125;]"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="createConnection——创建连接对象"><a href="#createConnection——创建连接对象" class="headerlink" title="createConnection——创建连接对象"></a>createConnection——创建连接对象</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createConnection</span><span class="params">($driver, $connection, $database, $prefix = <span class="string">''</span>, array $config = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> ($resolver = Connection::getResolver($driver)) &#123;</div><div class="line">        <span class="keyword">return</span> $resolver($connection, $database, $prefix, $config);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">switch</span> ($driver) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'mysql'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> MySqlConnection($connection, $database, $prefix, $config);</div><div class="line">        <span class="keyword">case</span> <span class="string">'pgsql'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PostgresConnection($connection, $database, $prefix, $config);</div><div class="line">        <span class="keyword">case</span> <span class="string">'sqlite'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SQLiteConnection($connection, $database, $prefix, $config);</div><div class="line">        <span class="keyword">case</span> <span class="string">'sqlsrv'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SqlServerConnection($connection, $database, $prefix, $config);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(<span class="string">"Unsupported driver [$driver]"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>创建 <code>pdo</code> 闭包函数之后，会将该闭包函数放入 <code>connection</code> 对象当中去。以后我们利用 <code>connection</code> 对象进行查询或者更新数据库时，程序便会运行该闭包函数，与数据库进行连接。</p>
<h3 id="createReadWriteConnection——创建读写连接对象"><a href="#createReadWriteConnection——创建读写连接对象" class="headerlink" title="createReadWriteConnection——创建读写连接对象"></a>createReadWriteConnection——创建读写连接对象</h3><p>当配置文件中有 <code>read</code>、<code>write</code> 等配置项时，说明用户希望创建一个可以读写分离的数据库连接，此时：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createReadWriteConnection</span><span class="params">(array $config)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $connection = <span class="keyword">$this</span>-&gt;createSingleConnection(<span class="keyword">$this</span>-&gt;getWriteConfig($config));</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $connection-&gt;setReadPdo(<span class="keyword">$this</span>-&gt;createReadPdo($config));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getWriteConfig</span><span class="params">(array $config)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;mergeReadWriteConfig(</div><div class="line">        $config, <span class="keyword">$this</span>-&gt;getReadWriteConfig($config, <span class="string">'write'</span>)</div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getReadWriteConfig</span><span class="params">(array $config, $type)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">isset</span>($config[$type][<span class="number">0</span>])</div><div class="line">                    ? $config[$type][array_rand($config[$type])]</div><div class="line">                    : $config[$type];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">mergeReadWriteConfig</span><span class="params">(array $config, array $merge)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> Arr::except(array_merge($config, $merge), [<span class="string">'read'</span>, <span class="string">'write'</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，程序先读出关于 <code>write</code> 数据库的配置，之后将其合并到总配置当中，删除关于 <code>read</code> 数据库的配置，然后进行 <code>createSingleConnection</code> 建立新的连接对象。</p>
<p>建立连接对象之后，再根据 <code>read</code> 数据库的配置，生成 <code>read</code> 数据库的 <code>pdo</code> 闭包函数，并调用 <code>setReadPdo</code> 将其设置为读库 <code>pdo</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createReadPdo</span><span class="params">(array $config)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;createPdoResolver(<span class="keyword">$this</span>-&gt;getReadConfig($config));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getReadConfig</span><span class="params">(array $config)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;mergeReadWriteConfig(</div><div class="line">        $config, <span class="keyword">$this</span>-&gt;getReadWriteConfig($config, <span class="string">'read'</span>)</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="connector-连接"><a href="#connector-连接" class="headerlink" title="connector 连接"></a>connector 连接</h2><p>我们以 <code>mysql</code> 为例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySqlConnector</span> <span class="keyword">extends</span> <span class="title">Connector</span> <span class="keyword">implements</span> <span class="title">ConnectorInterface</span> </span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span><span class="params">(array $config)</span></span></div><div class="line"><span class="function">	</span>&#123;</div><div class="line">    	$dsn = <span class="keyword">$this</span>-&gt;getDsn($config);</div><div class="line"></div><div class="line">    	$options = <span class="keyword">$this</span>-&gt;getOptions($config);</div><div class="line"></div><div class="line">    	$connection = <span class="keyword">$this</span>-&gt;createConnection($dsn, $config, $options);</div><div class="line"></div><div class="line">   		<span class="keyword">if</span> (! <span class="keyword">empty</span>($config[<span class="string">'database'</span>])) &#123;</div><div class="line">       	 $connection-&gt;exec(<span class="string">"use `&#123;$config['database']&#125;`;"</span>);</div><div class="line">    	&#125;</div><div class="line"></div><div class="line">    	<span class="keyword">$this</span>-&gt;configureEncoding($connection, $config);</div><div class="line"></div><div class="line">    	<span class="keyword">$this</span>-&gt;configureTimezone($connection, $config);</div><div class="line"></div><div class="line">   		<span class="keyword">$this</span>-&gt;setModes($connection, $config);</div><div class="line"></div><div class="line">      <span class="keyword">return</span> $connection;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="getDsn——获取数据库连接DSN参数"><a href="#getDsn——获取数据库连接DSN参数" class="headerlink" title="getDsn——获取数据库连接DSN参数"></a>getDsn——获取数据库连接DSN参数</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getDsn</span><span class="params">(array $config)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasSocket($config)</div><div class="line">                        ? <span class="keyword">$this</span>-&gt;getSocketDsn($config)</div><div class="line">                        : <span class="keyword">$this</span>-&gt;getHostDsn($config);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">hasSocket</span><span class="params">(array $config)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">isset</span>($config[<span class="string">'unix_socket'</span>]) &amp;&amp; ! <span class="keyword">empty</span>($config[<span class="string">'unix_socket'</span>]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getSocketDsn</span><span class="params">(array $config)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"mysql:unix_socket=&#123;$config['unix_socket']&#125;;dbname=&#123;$config['database']&#125;"</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getHostDsn</span><span class="params">(array $config)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    extract($config, EXTR_SKIP);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">isset</span>($port)</div><div class="line">                ? <span class="string">"mysql:host=&#123;$host&#125;;port=&#123;$port&#125;;dbname=&#123;$database&#125;"</span></div><div class="line">                : <span class="string">"mysql:host=&#123;$host&#125;;dbname=&#123;$database&#125;"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>mysql</code> 数据库的连接有两种：tcp连接与socket连接。</p>
<p><code>socket</code> 连接更快，但是它要求应用程序与数据库在同一台机器，更普通的是使用 <code>tcp</code> 的方式连接数据库。框架根据配置参数来选择是采用 <code>socket</code> 还是 <code>tcp</code> 的方式连接数据库。</p>
<h3 id="getOptions——pdo-属性设置"><a href="#getOptions——pdo-属性设置" class="headerlink" title="getOptions——pdo 属性设置"></a>getOptions——pdo 属性设置</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $options = [</div><div class="line">    PDO::ATTR_CASE =&gt; PDO::CASE_NATURAL,</div><div class="line">    PDO::ATTR_ERRMODE =&gt; PDO::ERRMODE_EXCEPTION,</div><div class="line">    PDO::ATTR_ORACLE_NULLS =&gt; PDO::NULL_NATURAL,</div><div class="line">    PDO::ATTR_STRINGIFY_FETCHES =&gt; <span class="keyword">false</span>,</div><div class="line">    PDO::ATTR_EMULATE_PREPARES =&gt; <span class="keyword">false</span>,</div><div class="line">];</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getOptions</span><span class="params">(array $config)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $options = Arr::get($config, <span class="string">'options'</span>, []);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> array_diff_key(<span class="keyword">$this</span>-&gt;options, $options) + $options;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>pdo</code> 的属性主要有以下几种：</p>
<ul>
<li><code>PDO::ATTR_CASE</code> 强制列名为指定的大小写。他的$value可为：<ul>
<li><code>PDO::CASE_LOWER</code>：强制列名小写。</li>
<li><code>PDO::CASE_NATURAL</code>：保留数据库驱动返回的列名。</li>
<li><code>PDO::CASE_UPPER</code>：强制列名大写。</li>
</ul>
</li>
<li><code>PDO::ATTR_ERRMODE</code>：错误报告。他的$value可为：<ul>
<li><code>PDO::ERRMODE_SILENT</code>： 仅设置错误代码。</li>
<li><code>PDO::ERRMODE_WARNING</code>: 引发 E_WARNING 错误.</li>
<li><code>PDO::ERRMODE_EXCEPTION</code>: 抛出 exceptions 异常。</li>
</ul>
</li>
<li><code>PDO::ATTR_ORACLE_NULLS</code> （在所有驱动中都可用，不仅限于Oracle）： 转换 NULL 和空字符串。他的$value可为:       <ul>
<li><code>PDO::NULL_NATURAL</code>: 不转换。 </li>
<li><code>PDO::NULL_EMPTY_STRING</code>： 将空字符串转换成 NULL 。</li>
<li><code>PDO::NULL_TO_STRING</code>: 将 NULL 转换成空字符串。</li>
</ul>
</li>
<li><code>PDO::ATTR_STRINGIFY_FETCHES</code>: 提取的时候将数值转换为字符串。</li>
<li><code>PDO::ATTR_EMULATE_PREPARES</code> 启用或禁用预处理语句的模拟。 有些驱动不支持或有限度地支持本地预处理。使用此设置强制PDO总是模拟预处理语句（如果为 TRUE ），或试着使用本地预处理语句（如果为 <code>FALSE</code> ）。如果驱动不能成功预处理当前查询，它将总是回到模拟预处理语句上。 需要 <code>bool</code> 类型。</li>
<li><code>PDO::ATTR_AUTOCOMMIT</code>：设置当前连接 <code>Mysql</code> 服务器的客户端的SQL语句是否自动执行，默认是自动提交.</li>
<li><code>PDO::ATTR_PERSISTENT</code>：当前对Mysql服务器的连接是否是长连接.</li>
</ul>
<h3 id="createConnection——创建数据库连接"><a href="#createConnection——创建数据库连接" class="headerlink" title="createConnection——创建数据库连接"></a>createConnection——创建数据库连接</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createConnection</span><span class="params">($dsn, array $config, array $options)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">list</span>($username, $password) = [</div><div class="line">        Arr::get($config, <span class="string">'username'</span>), Arr::get($config, <span class="string">'password'</span>),</div><div class="line">    ];</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;createPdoConnection(</div><div class="line">            $dsn, $username, $password, $options</div><div class="line">        );</div><div class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;tryAgainIfCausedByLostConnection(</div><div class="line">            $e, $dsn, $username, $password, $options</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createPdoConnection</span><span class="params">($dsn, $username, $password, $options)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (class_exists(PDOConnection::class) &amp;&amp; ! <span class="keyword">$this</span>-&gt;isPersistentConnection($options)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PDOConnection($dsn, $username, $password, $options);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PDO($dsn, $username, $password, $options);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当 <code>pdo</code> 对象成功的建立起来后，说明我们已经与数据库成功地建立起来了一个连接，接下来我们就可以利用这个 <code>pdo</code> 对象进行查询或者更新等操作。</p>
<p>当创建 <code>pdo</code> 的时候抛出异常时：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">tryAgainIfCausedByLostConnection</span><span class="params">(Exception $e, $dsn, $username, $password, $options)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;causedByLostConnection($e)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;createPdoConnection($dsn, $username, $password, $options);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> $e;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">causedByLostConnection</span><span class="params">(Exception $e)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $message = $e-&gt;getMessage();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Str::contains($message, [</div><div class="line">        <span class="string">'server has gone away'</span>,</div><div class="line">        <span class="string">'no connection to the server'</span>,</div><div class="line">        <span class="string">'Lost connection'</span>,</div><div class="line">        <span class="string">'is dead or not enabled'</span>,</div><div class="line">        <span class="string">'Error while sending'</span>,</div><div class="line">        <span class="string">'decryption failed or bad record mac'</span>,</div><div class="line">        <span class="string">'server closed the connection unexpectedly'</span>,</div><div class="line">        <span class="string">'SSL connection has been closed unexpectedly'</span>,</div><div class="line">        <span class="string">'Error writing data to the connection'</span>,</div><div class="line">        <span class="string">'Resource deadlock avoided'</span>,</div><div class="line">    ]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当判断出的异常是上面几种情况时，框架会再次尝试连接数据库。</p>
<h3 id="configureEncoding——设置字符集与校对集"><a href="#configureEncoding——设置字符集与校对集" class="headerlink" title="configureEncoding——设置字符集与校对集"></a>configureEncoding——设置字符集与校对集</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">configureEncoding</span><span class="params">($connection, array $config)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">isset</span>($config[<span class="string">'charset'</span>])) &#123;</div><div class="line">        <span class="keyword">return</span> $connection;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $connection-&gt;prepare(</div><div class="line">        <span class="string">"set names '&#123;$config['charset']&#125;'"</span>.<span class="keyword">$this</span>-&gt;getCollation($config)</div><div class="line">    )-&gt;execute();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getCollation</span><span class="params">(array $config)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> ! is_null($config[<span class="string">'collation'</span>]) ? <span class="string">" collate '&#123;$config['collation']&#125;'"</span> : <span class="string">''</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果配置参数中设置了字符集与校对集，程序会利用配置的参数对数据库进行相关设置。</p>
<p>所谓的字符集与校对集设置，可以参考<a href="http://www.360doc.com/content/11/0303/01/2588264_97631236.shtml" target="_blank" rel="external">mysql 中 character set 与 collation 的点滴理解</a></p>
<h3 id="configureTimezone——设置时间区"><a href="#configureTimezone——设置时间区" class="headerlink" title="configureTimezone——设置时间区"></a>configureTimezone——设置时间区</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">configureTimezone</span><span class="params">($connection, array $config)</span>~</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($config[<span class="string">'timezone'</span>])) &#123;</div><div class="line">        $connection-&gt;prepare(<span class="string">'set time_zone="'</span>.$config[<span class="string">'timezone'</span>].<span class="string">'"'</span>)-&gt;execute();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="setModes——设置-SQL-MODE-模式"><a href="#setModes——设置-SQL-MODE-模式" class="headerlink" title="setModes——设置 SQL_MODE 模式"></a>setModes——设置 SQL_MODE 模式</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setModes</span><span class="params">(PDO $connection, array $config)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($config[<span class="string">'modes'</span>])) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;setCustomModes($connection, $config);</div><div class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($config[<span class="string">'strict'</span>])) &#123;</div><div class="line">        <span class="keyword">if</span> ($config[<span class="string">'strict'</span>]) &#123;</div><div class="line">            $connection-&gt;prepare(<span class="keyword">$this</span>-&gt;strictMode())-&gt;execute();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            $connection-&gt;prepare(<span class="string">"set session sql_mode='NO_ENGINE_SUBSTITUTION'"</span>)-&gt;execute();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setCustomModes</span><span class="params">(PDO $connection, array $config)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $modes = implode(<span class="string">','</span>, $config[<span class="string">'modes'</span>]);</div><div class="line"></div><div class="line">    $connection-&gt;prepare(<span class="string">"set session sql_mode='&#123;$modes&#125;'"</span>)-&gt;execute();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">strictMode</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"set session sql_mode='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以下内容参考：<a href="http://www.xlaoyu.info/mysql/2016/06/07/mysql-sql_mode-setting.html" target="_blank" rel="external">mysql的sql_mode设置简介</a>:</p>
<p><code>SQL_MODE</code> 直接理解就是：sql的运作模式。官方的说法是：sql_mode可以影响sql支持的语法以及数据的校验执行，这使得MySQL可以运行在不同的环境中以及和其他数据库一起运作。 </p>
<p>想设置sql_mode有三种方式：</p>
<ul>
<li>在命令行启动MySQL时添加参数 –sql-mode=”modes”</li>
<li>在MySQL的配置文件（my.cnf或者my.ini）中添加一个配置sql-mode=”modes”</li>
<li>运行时修改SQL mode可以通过以下命令之一：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">SET <span class="keyword">GLOBAL</span> sql_mode = <span class="string">'modes'</span>;</div><div class="line">SET SESSION sql_mode = <span class="string">'modes'</span>;</div></pre></td></tr></table></figure>
<p>几种常见的mode介绍</p>
<ul>
<li><p><code>ONLY_FULL_GROUP_BY</code>： 出现在 <code>select</code> 语句、<code>HAVING</code> 条件和 <code>ORDER BY</code> 语句中的列，必须是 <code>GROUP BY</code> 的列或者依赖于 <code>GROUP BY</code> 列的函数列。</p>
</li>
<li><p><code>NO_AUTO_VALUE_ON_ZERO</code>： 该值影响自增长列的插入。默认设置下，插入0或 <code>NULL</code> 代表生成下一个自增长值。如果用户 希望插入的值为0，而该列又是自增长的，那么这个选项就有用了。</p>
</li>
<li><p><code>STRICT_TRANS_TABLES</code>： 在该模式下，如果一个值不能插入到一个事务表中，则中断当前的操作，对非事务表不做限制</p>
</li>
<li><p><code>NO_ZERO_IN_DATE</code>： 这个模式影响了是否允许日期中的月份和日包含0。如果开启此模式，2016-01-00是不允许的，但是0000-02-01是允许的。它实际的行为受到 <code>strict mode</code> 是否开启的影响1。</p>
</li>
<li><p><code>NO_ZERO_DATE</code>： 设置该值，<code>mysql</code> 数据库不允许插入零日期。它实际的行为受到 <code>strict mode</code> 是否开启的影响2。</p>
</li>
<li><p><code>ERROR_FOR_DIVISION_BY_ZERO</code>： 在 <code>INSERT</code> 或 <code>UPDATE</code> 过程中，如果数据被零除，则产生错误而非警告。如 果未给出该模式，那么数据被零除时 <code>MySQL</code> 返回 <code>NULL</code></p>
</li>
<li><p><code>NO_AUTO_CREATE_USER</code>： 禁止 <code>GRANT</code> 创建密码为空的用户</p>
</li>
<li><p><code>NO_ENGINE_SUBSTITUTION</code>： 如果需要的存储引擎被禁用或未编译，那么抛出错误。不设置此值时，用默认的存储引擎替代，并抛出一个异常</p>
</li>
<li><p><code>PIPES_AS_CONCAT</code>： 将”||”视为字符串的连接操作符而非或运算符，这和Oracle数据库是一样的，也和字符串的拼接函数Concat相类似</p>
</li>
<li><p><code>ANSI_QUOTES</code>： 启用 <code>ANSI_QUOTES</code> 后，不能用双引号来引用字符串，因为它被解释为识别符</p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/08/14/Laravel Providers/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/14/Laravel Providers/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-14T19:19:02+08:00">
                2017-08-14
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/14/Laravel Providers/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/08/14/Laravel Providers/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/08/14/Laravel Providers/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>服务提供者是 <code>laravel</code> 框架的重要组成部分，承载着各种服务，自定义的应用以及所有 <code>Laravel</code> 的核心服务都是通过服务提供者启动。本文将会介绍服务提供者的源码分析，关于服务提供者的使用，请参考官方文档 ：<a href="http://laravelacademy.org/post/6703.html" target="_blank" rel="external">服务提供者</a>。</p>
<h1 id="服务提供者的注册"><a href="#服务提供者的注册" class="headerlink" title="服务提供者的注册"></a>服务提供者的注册</h1><p>服务提供者的启动由类 <code>\Illuminate\Foundation\Bootstrap\RegisterProviders::class</code> 负责，该类用于加载所有服务提供者的 <code>register</code> 函数，并保存延迟加载的服务的信息，以便实现延迟加载。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterProviders</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span><span class="params">(Application $app)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $app-&gt;registerConfiguredProviders();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">Container</span> <span class="keyword">implements</span> <span class="title">ApplicationContract</span>, <span class="title">HttpKernelInterface</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">registerConfiguredProviders</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        (<span class="keyword">new</span> ProviderRepository(<span class="keyword">$this</span>, <span class="keyword">new</span> Filesystem, <span class="keyword">$this</span>-&gt;getCachedServicesPath()))</div><div class="line">                    -&gt;load(<span class="keyword">$this</span>-&gt;config[<span class="string">'app.providers'</span>]);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCachedServicesPath</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;bootstrapPath().<span class="string">'/cache/services.php'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上可以看出，所有服务提供者都在配置文件 <code>app.php</code> 文件的 <code>providers</code> 数组中。类 <code>ProviderRepository</code> 负责所有的服务加载功能：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProviderRepository</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span><span class="params">(array $providers)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $manifest = <span class="keyword">$this</span>-&gt;loadManifest();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;shouldRecompile($manifest, $providers)) &#123;</div><div class="line">            $manifest = <span class="keyword">$this</span>-&gt;compileManifest($providers);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">foreach</span> ($manifest[<span class="string">'when'</span>] <span class="keyword">as</span> $provider =&gt; $events) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;registerLoadEvents($provider, $events);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">foreach</span> ($manifest[<span class="string">'eager'</span>] <span class="keyword">as</span> $provider) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;app-&gt;register($provider);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;app-&gt;addDeferredServices($manifest[<span class="string">'deferred'</span>]);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="加载服务缓存文件"><a href="#加载服务缓存文件" class="headerlink" title="加载服务缓存文件"></a>加载服务缓存文件</h2><p><code>laravel</code> 会把所有的服务整理起来，作为缓存写在缓存文件中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="keyword">array</span> (</div><div class="line">	<span class="string">'providers'</span> =&gt; </div><div class="line">	<span class="keyword">array</span> (</div><div class="line">	  <span class="number">0</span> =&gt; <span class="string">'Illuminate\\Auth\\AuthServiceProvider'</span>,</div><div class="line">	  <span class="number">1</span> =&gt; <span class="string">'Illuminate\\Broadcasting\\BroadcastServiceProvider'</span>,</div><div class="line">	  ...</div><div class="line">	),</div><div class="line">	</div><div class="line">	<span class="string">'eager'</span> =&gt; </div><div class="line">	<span class="keyword">array</span> (</div><div class="line">      <span class="number">0</span> =&gt; <span class="string">'Illuminate\\Auth\\AuthServiceProvider'</span>,</div><div class="line">      <span class="number">1</span> =&gt; <span class="string">'Illuminate\\Cookie\\CookieServiceProvider'</span>,</div><div class="line">      ...</div><div class="line">    ),</div><div class="line">    </div><div class="line">    <span class="string">'deferred'</span> =&gt; </div><div class="line">    <span class="keyword">array</span> (</div><div class="line">      <span class="string">'Illuminate\\Broadcasting\\BroadcastManager'</span> =&gt; <span class="string">'Illuminate\\Broadcasting\\BroadcastServiceProvider'</span>,</div><div class="line">      <span class="string">'Illuminate\\Contracts\\Broadcasting\\Factory'</span> =&gt; <span class="string">'Illuminate\\Broadcasting\\BroadcastServiceProvider'</span>,</div><div class="line">      ...</div><div class="line">    ),</div><div class="line">    </div><div class="line">    <span class="string">'when'</span> =&gt; </div><div class="line">    <span class="keyword">array</span> (</div><div class="line">      <span class="string">'Illuminate\\Broadcasting\\BroadcastServiceProvider'</span> =&gt; </div><div class="line">      <span class="keyword">array</span> (</div><div class="line">      ),</div><div class="line">      ...</div><div class="line">    ),</div></pre></td></tr></table></figure>
<ul>
<li>缓存文件中 <code>providers</code> 放入了所有自定义和框架核心的服务。</li>
<li><code>eager</code> 数组中放入了所有需要立即启动的服务提供者。</li>
<li><code>deferred</code> 数组中放入了所有需要延迟加载的服务提供者。</li>
<li><code>when</code> 放入了延迟加载需要激活的事件。</li>
</ul>
<p>加载服务提供者缓存文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadManifest</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;files-&gt;exists(<span class="keyword">$this</span>-&gt;manifestPath)) &#123;</div><div class="line">        $manifest = <span class="keyword">$this</span>-&gt;files-&gt;getRequire(<span class="keyword">$this</span>-&gt;manifestPath);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ($manifest) &#123;</div><div class="line">            <span class="keyword">return</span> array_merge([<span class="string">'when'</span> =&gt; []], $manifest);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="编译服务提供者"><a href="#编译服务提供者" class="headerlink" title="编译服务提供者"></a>编译服务提供者</h2><p>若 <code>laravel</code> 中的服务提供者没有缓存文件或者有变动，那么就会重新生成缓存文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">shouldRecompile</span><span class="params">($manifest, $providers)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> is_null($manifest) || $manifest[<span class="string">'providers'</span>] != $providers;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileManifest</span><span class="params">($providers)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $manifest = <span class="keyword">$this</span>-&gt;freshManifest($providers);</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> ($providers <span class="keyword">as</span> $provider) &#123;</div><div class="line">        $instance = <span class="keyword">$this</span>-&gt;createProvider($provider);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ($instance-&gt;isDeferred()) &#123;</div><div class="line">            <span class="keyword">foreach</span> ($instance-&gt;provides() <span class="keyword">as</span> $service) &#123;</div><div class="line">                $manifest[<span class="string">'deferred'</span>][$service] = $provider;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            $manifest[<span class="string">'when'</span>][$provider] = $instance-&gt;when();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            $manifest[<span class="string">'eager'</span>][] = $provider;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;writeManifest($manifest);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">freshManifest</span><span class="params">(array $providers)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> [<span class="string">'providers'</span> =&gt; $providers, <span class="string">'eager'</span> =&gt; [], <span class="string">'deferred'</span> =&gt; []];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>如果服务提供者是需要立即注册的，那么将会放入缓存文件中 <code>eager</code> 数组中。</li>
<li>如果服务提供者是延迟加载的，那么其函数 <code>provides()</code> 通常会提供服务别名，这个服务别名通常是向服务容器中注册的别名，别名将会放入缓存文件的 <code>deferred</code> 数组中。</li>
<li>延迟加载若有 <code>event</code> 事件激活，那么可以在 <code>when</code> 函数中写入事件类，并写入缓存文件的 <code>when</code> 数组中。</li>
</ul>
<h2 id="延迟服务提供者事件注册"><a href="#延迟服务提供者事件注册" class="headerlink" title="延迟服务提供者事件注册"></a>延迟服务提供者事件注册</h2><p>延迟服务提供者除了利用 <code>IOC</code> 容器解析服务方式激活，还可以利用 <code>Event</code> 事件来激活：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerLoadEvents</span><span class="params">($provider, array $events)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (count($events) &lt; <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;app-&gt;make(<span class="string">'events'</span>)-&gt;listen($events, <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($provider)</span> </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;app-&gt;register($provider);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="注册即时启动的服务提供者"><a href="#注册即时启动的服务提供者" class="headerlink" title="注册即时启动的服务提供者"></a>注册即时启动的服务提供者</h2><p>服务提供者的注册函数 <code>register()</code> 由类 <code>Application</code> 来调用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">Container</span> <span class="keyword">implements</span> <span class="title">ApplicationContract</span>, <span class="title">HttpKernelInterface</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">($provider, $options = [], $force = false)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (($registered = <span class="keyword">$this</span>-&gt;getProvider($provider)) &amp;&amp; ! $force) &#123;</div><div class="line">            <span class="keyword">return</span> $registered;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (is_string($provider)) &#123;</div><div class="line">            $provider = <span class="keyword">$this</span>-&gt;resolveProvider($provider);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (method_exists($provider, <span class="string">'register'</span>)) &#123;</div><div class="line">            $provider-&gt;register();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;markAsRegistered($provider);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;booted) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;bootProvider($provider);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $provider;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getProvider</span><span class="params">($provider)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $name = is_string($provider) ? $provider : get_class($provider);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> Arr::first(<span class="keyword">$this</span>-&gt;serviceProviders, <span class="function"><span class="keyword">function</span> <span class="params">($value)</span> <span class="title">use</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> $value <span class="keyword">instanceof</span> $name;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveProvider</span><span class="params">($provider)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> $provider(<span class="keyword">$this</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">markAsRegistered</span><span class="params">($provider)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;serviceProviders[] = $provider;</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;loadedProviders[get_class($provider)] = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">bootProvider</span><span class="params">(ServiceProvider $provider)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (method_exists($provider, <span class="string">'boot'</span>)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;call([$provider, <span class="string">'boot'</span>]);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，服务提供者的注册过程：</p>
<ul>
<li>判断当前服务提供者是否被注册过，如注册过直接返回对象</li>
<li>解析服务提供者</li>
<li>调用服务提供者的 <code>register</code> 函数</li>
<li>标记当前服务提供者已经注册完毕</li>
<li>若框架已经加载注册完毕所有的服务容器，那么就启动服务提供者的 <code>boot</code> 函数，该函数由于是 <code>call</code> 调用，所以支持依赖注入。</li>
</ul>
<h2 id="延迟服务提供者激活与注册"><a href="#延迟服务提供者激活与注册" class="headerlink" title="延迟服务提供者激活与注册"></a>延迟服务提供者激活与注册</h2><p>延迟服务提供者首先需要添加到 <code>Application</code> 中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addDeferredServices</span><span class="params">(array $services)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;deferredServices = array_merge(<span class="keyword">$this</span>-&gt;deferredServices, $services);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们之前说过，延迟服务提供者的激活注册有两种方法：事件与服务解析。</p>
<p>当特定的事件被激发后，就会调用 <code>Application</code> 的 <code>register</code> 函数，进而调用服务提供者的 <code>register</code> 函数，实现服务的注册。</p>
<p>当利用 <code>Ioc</code> 容器解析服务名时，例如解析服务名 <code>BroadcastingFactory</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BroadcastServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">protected</span> $defer = <span class="keyword">true</span>;</div><div class="line">	</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">provides</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> [</div><div class="line">            BroadcastManager::class,</div><div class="line">            BroadcastingFactory::class,</div><div class="line">            BroadcasterContract::class,</div><div class="line">        ];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">($abstract)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $abstract = <span class="keyword">$this</span>-&gt;getAlias($abstract);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;deferredServices[$abstract])) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;loadDeferredProvider($abstract);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">parent</span>::make($abstract);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadDeferredProvider</span><span class="params">($service)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;deferredServices[$service])) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $provider = <span class="keyword">$this</span>-&gt;deferredServices[$service];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;loadedProviders[$provider])) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;registerDeferredProvider($provider, $service);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由 <code>deferredServices</code> 数组可以得知，<code>BroadcastingFactory</code> 为延迟服务，接着程序会利用函数 <code>loadDeferredProvider</code> 来加载延迟服务提供者，调用服务提供者的 <code>register</code> 函数，若当前的框架还未注册完全部服务。那么将会放入服务启动的回调函数中，以待服务启动时调用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">registerDeferredProvider</span><span class="params">($provider, $service = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> ($service) &#123;</div><div class="line">        <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;deferredServices[$service]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;register($instance = <span class="keyword">new</span> $provider(<span class="keyword">$this</span>));</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;booted) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;booting(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($instance)</span> </span>&#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;bootProvider($instance);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>关于服务提供者的注册函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BroadcastServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">protected</span> $defer = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;app-&gt;singleton(BroadcastManager::class, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> BroadcastManager($app);</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;app-&gt;singleton(BroadcasterContract::class, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> $app-&gt;make(BroadcastManager::class)-&gt;connection();</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;app-&gt;alias(</div><div class="line">            BroadcastManager::class, BroadcastingFactory::class</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">provides</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> [</div><div class="line">            BroadcastManager::class,</div><div class="line">            BroadcastingFactory::class,</div><div class="line">            BroadcasterContract::class,</div><div class="line">        ];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>函数 <code>register</code> 为类 <code>BroadcastingFactory</code> 向 <code>Ioc</code> 容器绑定了特定的实现类 <code>BroadcastManager</code>，这样 <code>Ioc</code> 容器中的 <code>make</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">($abstract)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $abstract = <span class="keyword">$this</span>-&gt;getAlias($abstract);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;deferredServices[$abstract])) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;loadDeferredProvider($abstract);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">parent</span>::make($abstract);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>parent::make($abstract)</code> 就会正确的解析服务 <code>BroadcastingFactory</code>。</p>
<p>因此函数 <code>provides()</code> 返回的元素一定都是 <code>register()</code> 向 <code>IOC</code> 容器中绑定的类名或者别名。这样当我们利用服务容器来利用 <code>App::make()</code> 解析这些类名的时候，服务容器才会根据服务提供者的 <code>register()</code> 函数中绑定的实现类，从而正确解析服务功能。</p>
<h1 id="服务容器的启动"><a href="#服务容器的启动" class="headerlink" title="服务容器的启动"></a>服务容器的启动</h1><p>服务容器的启动由类 <code>\Illuminate\Foundation\Bootstrap\BootProviders::class</code> 负责：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BootProviders</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span><span class="params">(Application $app)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $app-&gt;boot();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">Container</span> <span class="keyword">implements</span> <span class="title">ApplicationContract</span>, <span class="title">HttpKernelInterface</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;booted) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;fireAppCallbacks(<span class="keyword">$this</span>-&gt;bootingCallbacks);</div><div class="line"></div><div class="line">        array_walk(<span class="keyword">$this</span>-&gt;serviceProviders, <span class="function"><span class="keyword">function</span> <span class="params">($p)</span> </span>&#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;bootProvider($p);</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;booted = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;fireAppCallbacks(<span class="keyword">$this</span>-&gt;bootedCallbacks);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">bootProvider</span><span class="params">(ServiceProvider $provider)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (method_exists($provider, <span class="string">'boot'</span>)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;call([$provider, <span class="string">'boot'</span>]);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/08/13/Laravel Exceptions——异常与错误处理/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/13/Laravel Exceptions——异常与错误处理/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-13T23:45:01+08:00">
                2017-08-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/13/Laravel Exceptions——异常与错误处理/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/08/13/Laravel Exceptions——异常与错误处理/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/08/13/Laravel Exceptions——异常与错误处理/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>对于一个优秀的框架来说，正确的异常处理可以防止暴露自身接口给用户，可以提供快速追溯问题的提示给开发人员。本文会详细的介绍 <code>laravel</code> 异常处理的源码。</p>
<h1 id="PHP-异常处理"><a href="#PHP-异常处理" class="headerlink" title="PHP 异常处理"></a>PHP 异常处理</h1><p>本章节参考 <a href="http://blog.csdn.net/hguisu/article/details/7464977" target="_blank" rel="external">PHP错误异常处理详解</a>。</p>
<p>异常处理（又称为错误处理）功能提供了处理程序运行时出现的错误或异常情况的方法。<br>　　<br>异常处理通常是防止未知错误产生所采取的处理措施。异常处理的好处是你不用再绞尽脑汁去考虑各种错误，这为处理某一类错误提供了一个很有效的方法，使编程效率大大提高。当异常被触发时，通常会发生：</p>
<ul>
<li>当前代码状态被保存</li>
<li>代码执行被切换到预定义的异常处理器函数</li>
<li>根据情况，处理器也许会从保存的代码状态重新开始执行代码，终止脚本执行，或从代码中另外的位置继续执行脚本</li>
</ul>
<p>PHP 5 提供了一种新的面向对象的错误处理方法。可以使用检测（try）、抛出（throw）和捕获（catch）异常。即使用try检测有没有抛出（throw）异常，若有异常抛出（throw），使用catch捕获异常。</p>
<p>一个 try 至少要有一个与之对应的 catch。定义多个 catch 可以捕获不同的对象。php 会按这些 catch 被定义的顺序执行，直到完成最后一个为止。而在这些 catch 内，又可以抛出新的异常。</p>
<h2 id="异常的抛出"><a href="#异常的抛出" class="headerlink" title="异常的抛出"></a>异常的抛出</h2><p>当一个异常被抛出时，其后的代码将不会继续执行，PHP 会尝试查找匹配的 <code>catch</code> 代码块。如果一个异常没有被捕获，而且又没用使用<code>set_exception_handler()</code> 作相应的处理的话，那么 <code>PHP</code> 将会产生一个严重的错误，并且输出未能捕获异常 <code>(Uncaught Exception ... )</code> 的提示信息。</p>
<p>抛出异常，但不去捕获它：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ini_set(<span class="string">'display_errors'</span>, <span class="string">'On'</span>);  </div><div class="line">error_reporting(E_ALL &amp; ~ E_WARNING);  </div><div class="line">$error = <span class="string">'Always throw this error'</span>;  </div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>($error);  </div><div class="line"><span class="comment">// 继续执行  </span></div><div class="line"><span class="keyword">echo</span> <span class="string">'Hello World'</span>;</div></pre></td></tr></table></figure>
<p>上面的代码会获得类似这样的一个致命错误：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Fatal error: Uncaught <span class="keyword">exception</span> <span class="string">'Exception'</span> with message <span class="string">'Always throw this error'</span> in E:\sngrep\index.php on line <span class="number">5</span>  </div><div class="line"><span class="keyword">Exception</span>: Always <span class="keyword">throw</span> this error in E:\sngrep\index.php on line <span class="number">5</span>  </div><div class="line">Call Stack:  </div><div class="line">    <span class="number">0.0005</span>     <span class="number">330680</span>   <span class="number">1.</span> &#123;main&#125;() E:\sngrep\index.php:<span class="number">0</span></div></pre></td></tr></table></figure>
<h2 id="Try-throw-和-catch"><a href="#Try-throw-和-catch" class="headerlink" title="Try, throw 和 catch"></a>Try, throw 和 catch</h2><p>要避免上面这个致命错误，可以使用try catch捕获掉。</p>
<p>处理处理程序应当包括：</p>
<ul>
<li>Try - 使用异常的函数应该位于 “try” 代码块内。如果没有触发异常，则代码将照常继续执行。但是如果异常被触发，会抛出一个异常。</li>
<li>Throw - 这里规定如何触发异常。每一个 “throw” 必须对应至少一个 “catch”</li>
<li>Catch - “catch” 代码块会捕获异常，并创建一个包含异常信息的对象</li>
</ul>
<p>抛出异常并捕获掉，可以继续执行后面的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;  </div><div class="line">    $error = <span class="string">'Always throw this error'</span>;  </div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>($error);  </div><div class="line">  </div><div class="line">    <span class="comment">// 从这里开始，tra 代码块内的代码将不会被执行  </span></div><div class="line">    <span class="keyword">echo</span> <span class="string">'Never executed'</span>;  </div><div class="line">  </div><div class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;  </div><div class="line">    <span class="keyword">echo</span> <span class="string">'Caught exception: '</span>,  $e-&gt;getMessage(),<span class="string">'&lt;br&gt;'</span>;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="comment">// 继续执行  </span></div><div class="line"><span class="keyword">echo</span> <span class="string">'Hello World'</span>;</div></pre></td></tr></table></figure>
<h2 id="顶层异常处理器-set-exception-handler"><a href="#顶层异常处理器-set-exception-handler" class="headerlink" title="顶层异常处理器 set_exception_handler"></a>顶层异常处理器 set_exception_handler</h2><p>在我们实际开发中，异常捕捉仅仅靠 <code>try {} catch ()</code> 是远远不够的。<code>set_exception_handler()</code> 函数可设置处理所有未捕获异常的用户定义函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">myException</span><span class="params">($exception)</span>  </span></div><div class="line"><span class="function"></span>&#123;  </div><div class="line"><span class="keyword">echo</span> <span class="string">"&lt;b&gt;Exception:&lt;/b&gt; "</span> , $exception-&gt;getMessage();  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">set_exception_handler(<span class="string">'myException'</span>);  </div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'Uncaught Exception occurred'</span>);</div></pre></td></tr></table></figure>
<h2 id="扩展-PHP-内置的异常处理类"><a href="#扩展-PHP-内置的异常处理类" class="headerlink" title="扩展 PHP 内置的异常处理类"></a>扩展 PHP 内置的异常处理类</h2><p>用户可以用自定义的异常处理类来扩展 PHP 内置的异常处理类。以下的代码说明了在内置的异常处理类中，哪些属性和方法在子类中是可访问和可继承的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Exception</span>  </span></div><div class="line"><span class="class"></span>&#123;  </div><div class="line">    <span class="keyword">protected</span> $message = <span class="string">'Unknown exception'</span>;   <span class="comment">// 异常信息  </span></div><div class="line">    <span class="keyword">protected</span> $code = <span class="number">0</span>;                        <span class="comment">// 用户自定义异常代码  </span></div><div class="line">    <span class="keyword">protected</span> $file;                            <span class="comment">// 发生异常的文件名  </span></div><div class="line">    <span class="keyword">protected</span> $line;                            <span class="comment">// 发生异常的代码行号  </span></div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($message = null, $code = <span class="number">0</span>)</span></span>;  </div><div class="line">  </div><div class="line">    <span class="keyword">final</span> <span class="function"><span class="keyword">function</span> <span class="title">getMessage</span><span class="params">()</span></span>;                <span class="comment">// 返回异常信息  </span></div><div class="line">    <span class="keyword">final</span> <span class="function"><span class="keyword">function</span> <span class="title">getCode</span><span class="params">()</span></span>;                   <span class="comment">// 返回异常代码  </span></div><div class="line">    <span class="keyword">final</span> <span class="function"><span class="keyword">function</span> <span class="title">getFile</span><span class="params">()</span></span>;                   <span class="comment">// 返回发生异常的文件名  </span></div><div class="line">    <span class="keyword">final</span> <span class="function"><span class="keyword">function</span> <span class="title">getLine</span><span class="params">()</span></span>;                   <span class="comment">// 返回发生异常的代码行号  </span></div><div class="line">    <span class="keyword">final</span> <span class="function"><span class="keyword">function</span> <span class="title">getTrace</span><span class="params">()</span></span>;                  <span class="comment">// backtrace() 数组  </span></div><div class="line">    <span class="keyword">final</span> <span class="function"><span class="keyword">function</span> <span class="title">getTraceAsString</span><span class="params">()</span></span>;          <span class="comment">// 已格成化成字符串的 getTrace() 信息  </span></div><div class="line">  </div><div class="line">    <span class="comment">/* 可重载的方法 */</span>  </div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>;                       <span class="comment">// 可输出的字符串  </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果使用自定义的类来扩展内置异常处理类，并且要重新定义构造函数的话，建议同时调用 <code>parent::__construct()</code> 来检查所有的变量是否已被赋值。当对象要输出字符串的时候，可以重载 <code>__toString()</code> 并自定义输出的样式。 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyException</span> <span class="keyword">extends</span> <span class="title">Exception</span>  </span></div><div class="line"><span class="class"></span>&#123;  </div><div class="line">    <span class="comment">// 重定义构造器使 message 变为必须被指定的属性  </span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($message, $code = <span class="number">0</span>)</span> </span>&#123;  </div><div class="line">        <span class="comment">// 自定义的代码  </span></div><div class="line">  </div><div class="line">        <span class="comment">// 确保所有变量都被正确赋值  </span></div><div class="line">        <span class="keyword">parent</span>::__construct($message, $code);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="comment">// 自定义字符串输出的样式 */  </span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="keyword">return</span> <span class="keyword">__CLASS__</span> . <span class="string">": [&#123;$this-&gt;code&#125;]: &#123;$this-&gt;message&#125;\n"</span>;  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">customFunction</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="keyword">echo</span> <span class="string">"A Custom function for this type of exception\n"</span>;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>MyException</code> 类是作为旧的 exception 类的一个扩展来创建的。这样它就继承了旧类的所有属性和方法，我们可以使用 <code>exception</code> 类的方法，比如 <code>getLine()</code> 、 <code>getFile()</code> 以及 <code>getMessage()</code>。</p>
<h1 id="PHP-错误处理"><a href="#PHP-错误处理" class="headerlink" title="PHP 错误处理"></a>PHP 错误处理</h1><h2 id="PHP-的错误级别"><a href="#PHP-的错误级别" class="headerlink" title="PHP 的错误级别"></a>PHP 的错误级别</h2><table>
<thead>
<tr>
<th style="text-align:center">值</th>
<th style="text-align:left">常量</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:left">E_ERROR</td>
<td style="text-align:left">致命的运行时错误。这类错误一般是不可恢复的情况，例如内存分配导致的问题。后果是导致脚本终止不再继续运行。</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:left">E_WARNING</td>
<td style="text-align:left">运行时警告 (非致命错误)。仅给出提示信息，但是脚本不会终止运行。</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:left">E_PARSE</td>
<td style="text-align:left">编译时语法解析错误。解析错误仅仅由分析器产生。</td>
</tr>
<tr>
<td style="text-align:center">8</td>
<td style="text-align:left">E_NOTICE</td>
<td style="text-align:left">运行时通知。表示脚本遇到可能会表现为错误的情况，但是在可以正常运行的脚本里面也可能会有类似的通知。</td>
</tr>
<tr>
<td style="text-align:center">16</td>
<td style="text-align:left">E_CORE_ERROR</td>
<td style="text-align:left">在PHP初始化启动过程中发生的致命错误。该错误类似 E_ERROR，但是是由PHP引擎核心产生的。</td>
</tr>
<tr>
<td style="text-align:center">32</td>
<td style="text-align:left">E_CORE_WARNING</td>
<td style="text-align:left">PHP初始化启动过程中发生的警告 (非致命错误) 。类似 E_WARNING，但是是由PHP引擎核心产生的。</td>
</tr>
<tr>
<td style="text-align:center">64</td>
<td style="text-align:left">E_COMPILE_ERROR</td>
<td style="text-align:left">致命编译时错误。类似E_ERROR, 但是是由Zend脚本引擎产生的。</td>
</tr>
<tr>
<td style="text-align:center">128</td>
<td style="text-align:left">E_COMPILE_WARNING</td>
<td style="text-align:left">编译时警告 (非致命错误)。类似 E_WARNING，但是是由Zend脚本引擎产生的。</td>
</tr>
<tr>
<td style="text-align:center">256</td>
<td style="text-align:left">E_USER_ERROR</td>
<td style="text-align:left">用户产生的错误信息。类似 E_ERROR, 但是是由用户自己在代码中使用PHP函数 trigger_error()来产生的。</td>
</tr>
<tr>
<td style="text-align:center">512</td>
<td style="text-align:left">E_USER_WARNING</td>
<td style="text-align:left">用户产生的警告信息。类似 E_WARNING, 但是是由用户自己在代码中使用PHP函数 trigger_error()来产生的。</td>
</tr>
<tr>
<td style="text-align:center">1024</td>
<td style="text-align:left">E_USER_NOTICE</td>
<td style="text-align:left">用户产生的通知信息。类似 E_NOTICE, 但是是由用户自己在代码中使用PHP函数 trigger_error()来产生的。</td>
</tr>
<tr>
<td style="text-align:center">2048</td>
<td style="text-align:left">E_STRICT</td>
<td style="text-align:left">启用 PHP 对代码的修改建议，以确保代码具有最佳的互操作性和向前兼容性。</td>
</tr>
<tr>
<td style="text-align:center">4096</td>
<td style="text-align:left">E_RECOVERABLE_ERROR</td>
<td style="text-align:left">可被捕捉的致命错误。 它表示发生了一个可能非常危险的错误，但是还没有导致PHP引擎处于不稳定的状态。 如果该错误没有被用户自定义句柄捕获 (参见 set_error_handler())，将成为一个 E_ERROR　从而脚本会终止运行。</td>
</tr>
<tr>
<td style="text-align:center">8192</td>
<td style="text-align:left">E_DEPRECATED</td>
<td style="text-align:left">运行时通知。启用后将会对在未来版本中可能无法正常工作的代码给出警告。</td>
</tr>
<tr>
<td style="text-align:center">16384</td>
<td style="text-align:left">E_USER_DEPRECATED</td>
<td style="text-align:left">用户产少的警告信息。 类似 E_DEPRECATED, 但是是由用户自己在代码中使用PHP函数 trigger_error()来产生的。</td>
</tr>
<tr>
<td style="text-align:center">30719</td>
<td style="text-align:left">E_ALL</td>
<td style="text-align:left">用户产少的警告信息。 类似 E_DEPRECATED, 但是是由用户自己在代码中使用PHP函数 trigger_error()来产生的。</td>
</tr>
</tbody>
</table>
<h2 id="错误的抛出"><a href="#错误的抛出" class="headerlink" title="错误的抛出"></a>错误的抛出</h2><p>除了系统在运行 php 代码抛出的意外错误。我们还可以利用 <code>rigger_error</code> 产生一个自定义的用户级别的 <code>error/warning/notice</code> 错误信息:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($divisor == <span class="number">0</span>) &#123;</div><div class="line">    trigger_error(<span class="string">"Cannot divide by zero"</span>, E_USER_ERROR);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="顶级错误处理器"><a href="#顶级错误处理器" class="headerlink" title="顶级错误处理器"></a>顶级错误处理器</h2><p>顶级错误处理器 <code>set_error_handler</code> 一般用于捕捉  <code>E_NOTICE</code> 、<code>E_USER_ERROR</code>、<code>E_USER_WARNING</code>、<code>E_USER_NOTICE</code> 级别的错误，不能捕捉 <code>E_ERROR</code>, <code>E_PARSE</code>, <code>E_CORE_ERROR</code>, <code>E_CORE_WARNING</code>, <code>E_COMPILE_ERROR</code> 和<code>E_COMPILE_WARNING</code>。</p>
<h2 id="register-shutdown-function"><a href="#register-shutdown-function" class="headerlink" title="register_shutdown_function"></a><code>register_shutdown_function</code></h2><p><code>register_shutdown_function()</code> 函数可实现当程序执行完成后执行的函数，其功能为可实现程序执行完成的后续操作。程序在运行的时候可能存在执行超时，或强制关闭等情况，但这种情况下默认的提示是非常不友好的，如果使用 <code>register_shutdown_function()</code> 函数捕获异常，就能提供更加友好的错误展示方式，同时可以实现一些功能的后续操作，如执行完成后的临时数据清理，包括临时文件等。</p>
<p>可以这样理解调用条件：</p>
<ul>
<li>当页面被用户强制停止时</li>
<li>当程序代码运行超时时</li>
<li>当ＰＨＰ代码执行完成时，代码执行存在异常和错误、警告</li>
</ul>
<p>我们前面说过，<code>set_error_handler</code> 能够捕捉的错误类型有限，很多致命错误例如解析错误等都无法捕捉，但是这类致命错误发生时，PHP 会调用 <code>register_shutdown_function</code> 所注册的函数，如果结合函数 <code>error_get_last</code>，就会获取错误发生的信息。</p>
<h1 id="Laravel-异常处理"><a href="#Laravel-异常处理" class="headerlink" title="Laravel 异常处理"></a>Laravel 异常处理</h1><p><code>laravel</code> 的异常处理由类 <code>\Illuminate\Foundation\Bootstrap\HandleExceptions::class</code> 完成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HandleExceptions</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span><span class="params">(Application $app)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;app = $app;</div><div class="line"></div><div class="line">        error_reporting(<span class="number">-1</span>);</div><div class="line"></div><div class="line">        set_error_handler([<span class="keyword">$this</span>, <span class="string">'handleError'</span>]);</div><div class="line"></div><div class="line">        set_exception_handler([<span class="keyword">$this</span>, <span class="string">'handleException'</span>]);</div><div class="line"></div><div class="line">        register_shutdown_function([<span class="keyword">$this</span>, <span class="string">'handleShutdown'</span>]);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (! $app-&gt;environment(<span class="string">'testing'</span>)) &#123;</div><div class="line">            ini_set(<span class="string">'display_errors'</span>, <span class="string">'Off'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="异常转化"><a href="#异常转化" class="headerlink" title="异常转化"></a>异常转化</h2><p><code>laravel</code> 的异常处理均由函数 <code>handleException</code> 负责。 </p>
<p><code>PHP7</code> 实现了一个全局的 <code>throwable</code> 接口，原来的 <code>Exception</code> 和部分 <code>Error</code> 都实现了这个接口， 以接口的方式定义了异常的继承结构。于是，<code>PHP7</code> 中更多的 <code>Error</code> 变为可捕获的 <code>Exception</code> 返回给开发者，如果不进行捕获则为 <code>Error</code> ，如果捕获就变为一个可在程序内处理的 <code>Exception</code>。这些可被捕获的 <code>Error</code> 通常都是不会对程序造成致命伤害的 <code>Error</code>，例如函数不存在。</p>
<p><code>PHP7</code> 中，基于 <code>/Error exception</code>，派生了5个新的engine exception：<code>ArithmeticError</code> / <code>AssertionError</code> / <code>DivisionByZeroError</code> / <code>ParseError</code> / <code>TypeError</code>。在 <code>PHP7</code> 里，无论是老的 <code>/Exception</code> 还是新的 <code>/Error</code> ，它们都实现了一个共同的interface: <code>/Throwable</code>。</p>
<p>因此，遇到非 <code>Exception</code> 类型的异常，首先就要将其转化为 <code>FatalThrowableError</code> 类型：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleException</span><span class="params">($e)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! $e <span class="keyword">instanceof</span> <span class="keyword">Exception</span>) &#123;</div><div class="line">        $e = <span class="keyword">new</span> FatalThrowableError($e);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;getExceptionHandler()-&gt;report($e);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;app-&gt;runningInConsole()) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;renderForConsole($e);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;renderHttpResponse($e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>FatalThrowableError</code> 是 <code>Symfony</code> 继承 <code>\ErrorException</code> 的错误异常类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FatalThrowableError</span> <span class="keyword">extends</span> <span class="title">FatalErrorException</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(\Throwable $e)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> ($e <span class="keyword">instanceof</span> \ParseError) &#123;</div><div class="line">            $message = <span class="string">'Parse error: '</span>.$e-&gt;getMessage();</div><div class="line">            $severity = E_PARSE;</div><div class="line">        &#125; <span class="keyword">elseif</span> ($e <span class="keyword">instanceof</span> \TypeError) &#123;</div><div class="line">            $message = <span class="string">'Type error: '</span>.$e-&gt;getMessage();</div><div class="line">            $severity = E_RECOVERABLE_ERROR;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            $message = $e-&gt;getMessage();</div><div class="line">            $severity = E_ERROR;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        \ErrorException::__construct(</div><div class="line">            $message,</div><div class="line">            $e-&gt;getCode(),</div><div class="line">            $severity,</div><div class="line">            $e-&gt;getFile(),</div><div class="line">            $e-&gt;getLine()</div><div class="line">        );</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;setTrace($e-&gt;getTrace());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="异常-Log"><a href="#异常-Log" class="headerlink" title="异常 Log"></a>异常 Log</h2><p>当遇到异常情况的时候，<code>laravel</code> 首要做的事情就是记录 <code>log</code>，这个就是 <code>report</code> 函数的作用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getExceptionHandler</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;app-&gt;make(ExceptionHandler::class);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>laravel</code> 在 <code>Ioc</code> 容器中默认的异常处理类是 <code>Illuminate\Foundation\Exceptions\Handler</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handler</span> <span class="keyword">implements</span> <span class="title">ExceptionHandlerContract</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">report</span><span class="params">(Exception $e)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;shouldntReport($e)) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            $logger = <span class="keyword">$this</span>-&gt;container-&gt;make(LoggerInterface::class);</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $ex) &#123;</div><div class="line">            <span class="keyword">throw</span> $e; <span class="comment">// throw the original exception</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $logger-&gt;error($e);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">shouldntReport</span><span class="params">(Exception $e)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $dontReport = array_merge(<span class="keyword">$this</span>-&gt;dontReport, [HttpResponseException::class]);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> ! is_null(collect($dontReport)-&gt;first(<span class="function"><span class="keyword">function</span> <span class="params">($type)</span> <span class="title">use</span> <span class="params">($e)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> $e <span class="keyword">instanceof</span> $type;</div><div class="line">        &#125;));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="异常页面展示"><a href="#异常页面展示" class="headerlink" title="异常页面展示"></a>异常页面展示</h2><p>记录 <code>log</code> 后，就要将异常转化为页面向开发者展示异常的信息，以便查看问题的来源：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">renderHttpResponse</span><span class="params">(Exception $e)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;getExceptionHandler()-&gt;render(<span class="keyword">$this</span>-&gt;app[<span class="string">'request'</span>], $e)-&gt;send();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handler</span> <span class="keyword">implements</span> <span class="title">ExceptionHandlerContract</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">($request, Exception $e)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $e = <span class="keyword">$this</span>-&gt;prepareException($e);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ($e <span class="keyword">instanceof</span> HttpResponseException) &#123;</div><div class="line">            <span class="keyword">return</span> $e-&gt;getResponse();</div><div class="line">        &#125; <span class="keyword">elseif</span> ($e <span class="keyword">instanceof</span> AuthenticationException) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;unauthenticated($request, $e);</div><div class="line">        &#125; <span class="keyword">elseif</span> ($e <span class="keyword">instanceof</span> ValidationException) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;convertValidationExceptionToResponse($e, $request);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;prepareResponse($request, $e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于不同的异常，<code>laravel</code> 有不同的处理，大致有 <code>HttpException</code>、<code>HttpResponseException</code>、<code>AuthorizationException</code>、<code>ModelNotFoundException</code>、<code>AuthenticationException</code>、<code>ValidationException</code>。由于特定的不同异常带有自身的不同需求，本文不会特别介绍。本文继续介绍最普通的异常 <code>HttpException</code> 的处理：    </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">prepareResponse</span><span class="params">($request, Exception $e)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isHttpException($e)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;toIlluminateResponse(<span class="keyword">$this</span>-&gt;renderHttpException($e), $e);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;toIlluminateResponse(<span class="keyword">$this</span>-&gt;convertExceptionToResponse($e), $e);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">renderHttpException</span><span class="params">(HttpException $e)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $status = $e-&gt;getStatusCode();</div><div class="line"></div><div class="line">    view()-&gt;replaceNamespace(<span class="string">'errors'</span>, [</div><div class="line">        resource_path(<span class="string">'views/errors'</span>),</div><div class="line">        <span class="keyword">__DIR__</span>.<span class="string">'/views'</span>,</div><div class="line">    ]);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (view()-&gt;exists(<span class="string">"errors::&#123;$status&#125;"</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> response()-&gt;view(<span class="string">"errors::&#123;$status&#125;"</span>, [<span class="string">'exception'</span> =&gt; $e], $status, $e-&gt;getHeaders());</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;convertExceptionToResponse($e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于 <code>HttpException</code> 来说，会根据其错误的状态码，选取不同的错误页面模板，若不存在相关的模板，则会通过 <code>SymfonyResponse</code> 来构造异常展示页面：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">convertExceptionToResponse</span><span class="params">(Exception $e)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $e = FlattenException::create($e);</div><div class="line"></div><div class="line">    $handler = <span class="keyword">new</span> SymfonyExceptionHandler(config(<span class="string">'app.debug'</span>));</div><div class="line"></div><div class="line">    <span class="keyword">return</span> SymfonyResponse::create($handler-&gt;getHtml($e), $e-&gt;getStatusCode(), $e-&gt;getHeaders());</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">toIlluminateResponse</span><span class="params">($response, Exception $e)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> ($response <span class="keyword">instanceof</span> SymfonyRedirectResponse) &#123;</div><div class="line">        $response = <span class="keyword">new</span> RedirectResponse($response-&gt;getTargetUrl(), $response-&gt;getStatusCode(), $response-&gt;headers-&gt;all());</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $response = <span class="keyword">new</span> Response($response-&gt;getContent(), $response-&gt;getStatusCode(), $response-&gt;headers-&gt;all());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $response-&gt;withException($e);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="laravel-错误处理"><a href="#laravel-错误处理" class="headerlink" title="laravel 错误处理"></a>laravel 错误处理</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleError</span><span class="params">($level, $message, $file = <span class="string">''</span>, $line = <span class="number">0</span>, $context = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (error_reporting() &amp; $level) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ErrorException($message, <span class="number">0</span>, $level, $file, $line);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleShutdown</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! is_null($error = error_get_last()) &amp;&amp; <span class="keyword">$this</span>-&gt;isFatal($error[<span class="string">'type'</span>])) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;handleException(<span class="keyword">$this</span>-&gt;fatalExceptionFromError($error, <span class="number">0</span>));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">fatalExceptionFromError</span><span class="params">(array $error, $traceOffset = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FatalErrorException(</div><div class="line">        $error[<span class="string">'message'</span>], $error[<span class="string">'type'</span>], <span class="number">0</span>, $error[<span class="string">'file'</span>], $error[<span class="string">'line'</span>], $traceOffset</div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">isFatal</span><span class="params">($type)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> in_array($type, [E_COMPILE_ERROR, E_CORE_ERROR, E_ERROR, E_PARSE]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于不致命的错误，例如 <code>notice</code>级别的错误，<code>handleError</code> 即可截取， <code>laravel</code> 将错误转化为了异常，交给了 <code>handleException</code> 去处理。</p>
<p>对于致命错误，例如 <code>E_PARSE</code> 解析错误，<code>handleShutdown</code> 将会启动，并且判断当前脚本结束是否是由于致命错误，如果是致命错误，将会将其转化为 <code>FatalErrorException</code>, 交给了 <code>handleException</code> 作为异常去处理。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/master.jpg"
               alt="Leo Yang" />
          <p class="site-author-name" itemprop="name">Leo Yang</p>
           
              <p class="site-description motion-element" itemprop="description">Life and Learn!</p>
          
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/LeoYang90" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/liang-de-tai-yang" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Leo Yang</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"leoyang90"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("ftMscWAwCsyt12PCu9jVqOrL-gzGzoHsz", "39fy4YEUohtU0wVi4r4MuKEI");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
