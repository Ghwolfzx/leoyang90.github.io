<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0" />






<meta name="description" content="Life and Learn!">
<meta property="og:type" content="website">
<meta property="og:title" content="LEOYANG&#39;S BLOG">
<meta property="og:url" content="https://leoyang90.github.io/page/2/index.html">
<meta property="og:site_name" content="LEOYANG&#39;S BLOG">
<meta property="og:description" content="Life and Learn!">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LEOYANG&#39;S BLOG">
<meta name="twitter:description" content="Life and Learn!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'LeoYang'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://leoyang90.github.io/page/2/"/>





  <title> LEOYANG'S BLOG </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c45898c39ba7512b69229aa34c07263a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">LEOYANG'S BLOG</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Notes and Blogs</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'qzqmBx1WzwFX9LPuU1Rc','2.0.0');
</script>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/08/12/Laravel Config—— 配置文件的加载与源码解析/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/12/Laravel Config—— 配置文件的加载与源码解析/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-12T17:05:59+08:00">
                2017-08-12
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/12/Laravel Config—— 配置文件的加载与源码解析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/08/12/Laravel Config—— 配置文件的加载与源码解析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/08/12/Laravel Config—— 配置文件的加载与源码解析/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文主要介绍 <code>laravel</code> 加载 <code>config</code> 配置文件的相关源码。</p>
<h1 id="config-配置文件的加载"><a href="#config-配置文件的加载" class="headerlink" title="config 配置文件的加载"></a>config 配置文件的加载</h1><p>config 配置文件由类 <code>\Illuminate\Foundation\Bootstrap\LoadConfiguration::class</code> 完成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoadConfiguration</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span><span class="params">(Application $app)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $items = [];</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (file_exists($cached = $app-&gt;getCachedConfigPath())) &#123;</div><div class="line">            $items = <span class="keyword">require</span> $cached;</div><div class="line"></div><div class="line">            $loadedFromCache = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $app-&gt;instance(<span class="string">'config'</span>, $config = <span class="keyword">new</span> Repository($items));</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (! <span class="keyword">isset</span>($loadedFromCache)) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;loadConfigurationFiles($app, $config);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $app-&gt;detectEnvironment(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($config)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> $config-&gt;get(<span class="string">'app.env'</span>, <span class="string">'production'</span>);</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        date_default_timezone_set($config-&gt;get(<span class="string">'app.timezone'</span>, <span class="string">'UTC'</span>));</div><div class="line"></div><div class="line">        mb_internal_encoding(<span class="string">'UTF-8'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，配置文件的加载步骤：</p>
<ul>
<li>加载缓存</li>
<li>若缓存不存在，则利用函数 <code>loadConfigurationFiles</code> 加载配置文件</li>
<li>加载环境变量、时间区、编码方式</li>
</ul>
<p>函数 <code>loadConfigurationFiles</code> 用于加载配置文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">loadConfigurationFiles</span><span class="params">(Application $app, RepositoryContract $repository)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;getConfigurationFiles($app) <span class="keyword">as</span> $key =&gt; $path) &#123;</div><div class="line">        $repository-&gt;set($key, <span class="keyword">require</span> $path);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>加载配置文件有两部分：搜索配置文件、加载配置文件的数组变量值</p>
<h2 id="搜索配置文件"><a href="#搜索配置文件" class="headerlink" title="搜索配置文件"></a>搜索配置文件</h2><p><code>getConfigurationFiles</code> 可以根据配置文件目录搜索所有的 <code>php</code> 为后缀的文件，并将其转化为 <code>files</code> 数组，其 <code>key</code> 为目录名以字符 <code>.</code> 为连接的字符串 ，<code>value</code> 为文件真实路径：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getConfigurationFiles</span><span class="params">(Application $app)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $files = [];</div><div class="line"></div><div class="line">    $configPath = realpath($app-&gt;configPath());</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> (Finder::create()-&gt;files()-&gt;name(<span class="string">'*.php'</span>)-&gt;in($configPath) <span class="keyword">as</span> $file) &#123;</div><div class="line">        $directory = <span class="keyword">$this</span>-&gt;getNestedDirectory($file, $configPath);</div><div class="line"></div><div class="line">        $files[$directory.basename($file-&gt;getRealPath(), <span class="string">'.php'</span>)] = $file-&gt;getRealPath();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $files;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getNestedDirectory</span><span class="params">(SplFileInfo $file, $configPath)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $directory = $file-&gt;getPath();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($nested = trim(str_replace($configPath, <span class="string">''</span>, $directory), DIRECTORY_SEPARATOR)) &#123;</div><div class="line">        $nested = str_replace(DIRECTORY_SEPARATOR, <span class="string">'.'</span>, $nested).<span class="string">'.'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $nested;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="加载配置文件数组"><a href="#加载配置文件数组" class="headerlink" title="加载配置文件数组"></a>加载配置文件数组</h2><p>加载配置文件由类 <code>Illuminate\Config\Repository\LoadConfiguration</code> 完成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Repository</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">($key, $value = null)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $keys = is_array($key) ? $key : [$key =&gt; $value];</div><div class="line"></div><div class="line">        <span class="keyword">foreach</span> ($keys <span class="keyword">as</span> $key =&gt; $value) &#123;</div><div class="line">            Arr::set(<span class="keyword">$this</span>-&gt;items, $key, $value);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>加载配置文件时间上就是将所有配置文件的数值放入一个巨大的多维数组中，这一部分由类 <code>Illuminate\Support\Arr</code> 完成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Arr</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">(&amp;$array, $key, $value)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (is_null($key)) &#123;</div><div class="line">            <span class="keyword">return</span> $array = $value;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $keys = explode(<span class="string">'.'</span>, $key);</div><div class="line"></div><div class="line">        <span class="keyword">while</span> (count($keys) &gt; <span class="number">1</span>) &#123;</div><div class="line">            $key = array_shift($keys);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (! <span class="keyword">isset</span>($array[$key]) || ! is_array($array[$key])) &#123;</div><div class="line">                $array[$key] = [];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            $array = &amp;$array[$key];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $array[array_shift($keys)] = $value;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $array;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>例如 <code>dir1.dir2.app</code> ,配置文件会生成 <code>$array[dir1][dir2][app]</code> 这样的数组。</p>
<h1 id="配置文件数值的获取"><a href="#配置文件数值的获取" class="headerlink" title="配置文件数值的获取"></a>配置文件数值的获取</h1><p>当我们利用全局函数 <code>config</code> 来获取配置值的时候：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">config</span><span class="params">($key = null, $default = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (is_null($key)) &#123;</div><div class="line">        <span class="keyword">return</span> app(<span class="string">'config'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (is_array($key)) &#123;</div><div class="line">        <span class="keyword">return</span> app(<span class="string">'config'</span>)-&gt;set($key);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> app(<span class="string">'config'</span>)-&gt;get($key, $default);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>配置文件的获取和加载类似，都是将字符串转为多维数组，然后获取具体数组值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($array, $key, $default = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">static</span>::accessible($array)) &#123;</div><div class="line">        <span class="keyword">return</span> value($default);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (is_null($key)) &#123;</div><div class="line">        <span class="keyword">return</span> $array;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">static</span>::exists($array, $key)) &#123;</div><div class="line">        <span class="keyword">return</span> $array[$key];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> (explode(<span class="string">'.'</span>, $key) <span class="keyword">as</span> $segment) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">static</span>::accessible($array) &amp;&amp; <span class="keyword">static</span>::exists($array, $segment)) &#123;</div><div class="line">            $array = $array[$segment];</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> value($default);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $array;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/08/12/Laravel ENV—— 环境变量的加载与源码解析/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/12/Laravel ENV—— 环境变量的加载与源码解析/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-12T15:41:13+08:00">
                2017-08-12
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/12/Laravel ENV—— 环境变量的加载与源码解析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/08/12/Laravel ENV—— 环境变量的加载与源码解析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/08/12/Laravel ENV—— 环境变量的加载与源码解析/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>laravel</code> 在启动时，会加载项目的 <code>env</code> 文件，本文将会详细介绍 <code>env</code> 文件的使用与源码的分析。</p>
<h1 id="ENV-文件的使用"><a href="#ENV-文件的使用" class="headerlink" title="ENV 文件的使用"></a>ENV 文件的使用</h1><h2 id="多环境-ENV-文件的设置"><a href="#多环境-ENV-文件的设置" class="headerlink" title="多环境 ENV 文件的设置"></a>多环境 ENV 文件的设置</h2><p>一、在项目写多个 <code>ENV</code> 文件，例如三个 <code>env</code> 文件： </p>
<ul>
<li><code>.env.development</code>、</li>
<li><code>.env.staging</code>、</li>
<li><code>.env.production</code>，</li>
</ul>
<p>这三个文件中分别针对不同环境为某些变量配置了不同的值，</p>
<p>二、配置 <code>APP_ENV</code> 环境变量值</p>
<p>配置环境变量的方法有很多，其中一个方法是在 <code>nginx</code> 的配置文件中写下这句代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fastcgi_param  APP_ENV  production;</div></pre></td></tr></table></figure>
<p>那么 <code>laravel</code> 会通过 <code>env(&#39;APP_ENV&#39;)</code> 根据环境变量 <code>APP_ENV</code> 来判断当前具体的环境，假如环境变量 <code>APP_ENV</code> 为 <code>production</code>，那么 <code>laravel</code> 将会自动加载 <code>.env.production</code> 文件。</p>
<h2 id="自定义-ENV-文件的路径与文件名"><a href="#自定义-ENV-文件的路径与文件名" class="headerlink" title="自定义 ENV 文件的路径与文件名"></a>自定义 ENV 文件的路径与文件名</h2><p><code>laravel</code> 为用户提供了自定义 <code>ENV</code> 文件路径或文件名的函数，</p>
<p>例如，若想要自定义 <code>env</code> 路径，就可以在 <code>bootstrap</code> 文件夹中 <code>app.php</code> 文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$app = <span class="keyword">new</span> Illuminate\Foundation\Application(</div><div class="line">    realpath(<span class="keyword">__DIR__</span>.<span class="string">'/../'</span>)</div><div class="line">);</div><div class="line"></div><div class="line">$app-&gt;useEnvironmentPath(<span class="string">'/customer/path'</span>)</div></pre></td></tr></table></figure>
<p>若想要自定义 <code>env</code> 文件名称，就可以在 <code>bootstrap</code> 文件夹中 <code>app.php</code> 文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$app = <span class="keyword">new</span> Illuminate\Foundation\Application(</div><div class="line">    realpath(<span class="keyword">__DIR__</span>.<span class="string">'/../'</span>)</div><div class="line">);</div><div class="line"></div><div class="line">$app-&gt;loadEnvironmentFrom(<span class="string">'customer.env'</span>)</div></pre></td></tr></table></figure>
<h2 id="ENV-文件变量设置"><a href="#ENV-文件变量设置" class="headerlink" title="ENV 文件变量设置"></a>ENV 文件变量设置</h2><ul>
<li>在 <code>env</code> 文件中，我们可以为变量赋予具体值：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CFOO=bar</div></pre></td></tr></table></figure>
<p>值得注意的是，这种具体值不允许赋予多个，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CFOO=bar baz</div></pre></td></tr></table></figure>
<ul>
<li>可以为变量赋予字符串引用</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CQUOTES=<span class="string">"a value with a # character"</span></div></pre></td></tr></table></figure>
<p>值得注意的是，这种引用不允许字符串中存在符号 <code>\</code>，只能使用转义字符 <code>\\</code></p>
<p>而且也不允许内嵌符号 <code>&quot;&quot;</code>，只能使用转移字符 <code>\&quot;</code>,否则取值会意外结束：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">CQUOTESWITHQUOTE=<span class="string">"a value with a # character &amp; a quote \" character inside quotes"</span> <span class="comment"># " this is a comment</span></div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'a value with a # character &amp; a quote " character inside quotes'</span>, getenv(<span class="string">'CQUOTESWITHQUOTE'</span>));</div></pre></td></tr></table></figure>
<ul>
<li>可以在 <code>env</code> 文件中添加注释，方法是以 <code>#</code> 开始：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CQUOTES=<span class="string">"a value with a # character"</span> <span class="comment"># this is a comment</span></div></pre></td></tr></table></figure>
<ul>
<li>可以使用 <code>export</code> 来为变量赋值：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">export EFOO=<span class="string">"bar"</span></div></pre></td></tr></table></figure>
<ul>
<li>可以在 <code>env</code> 文件中使用变量为变量赋值：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">NVAR1=<span class="string">"Hello"</span></div><div class="line">NVAR2=<span class="string">"World!"</span></div><div class="line">NVAR3=<span class="string">"&#123;$NVAR1&#125; &#123;$NVAR2&#125;"</span></div><div class="line">NVAR4=<span class="string">"$&#123;NVAR1&#125; $&#123;NVAR2&#125;"</span></div><div class="line">NVAR5=<span class="string">"$NVAR1 &#123;NVAR2&#125;"</span></div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'&#123;$NVAR1&#125; &#123;$NVAR2&#125;'</span>, $_ENV[<span class="string">'NVAR3'</span>]); <span class="comment">// not resolved</span></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'Hello World!'</span>, $_ENV[<span class="string">'NVAR4'</span>]);</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'$NVAR1 &#123;NVAR2&#125;'</span>, $_ENV[<span class="string">'NVAR5'</span>]); <span class="comment">// not resolved</span></div></pre></td></tr></table></figure>
<h1 id="ENV-加载源码分析"><a href="#ENV-加载源码分析" class="headerlink" title="ENV 加载源码分析"></a>ENV 加载源码分析</h1><h2 id="laravel-加载-ENV"><a href="#laravel-加载-ENV" class="headerlink" title="laravel 加载 ENV"></a>laravel 加载 ENV</h2><p><code>ENV</code> 的加载功能由类 <code>\Illuminate\Foundation\Bootstrap\LoadEnvironmentVariables::class</code> 完成，它的启动函数为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span><span class="params">(Application $app)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> ($app-&gt;configurationIsCached()) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;checkForSpecificEnvironmentFile($app);</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        (<span class="keyword">new</span> Dotenv($app-&gt;environmentPath(), $app-&gt;environmentFile()))-&gt;load();</div><div class="line">    &#125; <span class="keyword">catch</span> (InvalidPathException $e) &#123;</div><div class="line">        <span class="comment">//</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果我们在环境变量中设置了 <code>APP_ENV</code> 变量，那么就会调用函数 <code>checkForSpecificEnvironmentFile</code> 来根据环境加载不同的 <code>env</code> 文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">checkForSpecificEnvironmentFile</span><span class="params">($app)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (php_sapi_name() == <span class="string">'cli'</span> &amp;&amp; with($input = <span class="keyword">new</span> ArgvInput)-&gt;hasParameterOption(<span class="string">'--env'</span>)) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;setEnvironmentFilePath(</div><div class="line">            $app, $app-&gt;environmentFile().<span class="string">'.'</span>.$input-&gt;getParameterOption(<span class="string">'--env'</span>)</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! env(<span class="string">'APP_ENV'</span>)) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;setEnvironmentFilePath(</div><div class="line">        $app, $app-&gt;environmentFile().<span class="string">'.'</span>.env(<span class="string">'APP_ENV'</span>)</div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setEnvironmentFilePath</span><span class="params">($app, $file)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (file_exists($app-&gt;environmentPath().<span class="string">'/'</span>.$file)) &#123;</div><div class="line">        $app-&gt;loadEnvironmentFrom($file);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="vlucas-phpdotenv-源码解读"><a href="#vlucas-phpdotenv-源码解读" class="headerlink" title="vlucas/phpdotenv 源码解读"></a>vlucas/phpdotenv 源码解读</h2><p><code>laravel</code> 中对 <code>env</code> 文件的读取是采用 <code>vlucas/phpdotenv</code> 的开源项目：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dotenv</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path, $file = <span class="string">'.env'</span>)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;filePath = <span class="keyword">$this</span>-&gt;getFilePath($path, $file);</div><div class="line">        <span class="keyword">$this</span>-&gt;loader = <span class="keyword">new</span> Loader(<span class="keyword">$this</span>-&gt;filePath, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;loadData();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">loadData</span><span class="params">($overload = false)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;loader = <span class="keyword">new</span> Loader(<span class="keyword">$this</span>-&gt;filePath, !$overload);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;loader-&gt;load();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>env</code> 文件变量的读取依赖类 <code>/Dotenv/Loader</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Loader</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;ensureFileIsReadable();</div><div class="line"></div><div class="line">        $filePath = <span class="keyword">$this</span>-&gt;filePath;</div><div class="line">        $lines = <span class="keyword">$this</span>-&gt;readLinesFromFile($filePath);</div><div class="line">        <span class="keyword">foreach</span> ($lines <span class="keyword">as</span> $line) &#123;</div><div class="line">            <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;isComment($line) &amp;&amp; <span class="keyword">$this</span>-&gt;looksLikeSetter($line)) &#123;</div><div class="line">                <span class="keyword">$this</span>-&gt;setEnvironmentVariable($line);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $lines;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以看到，<code>env</code> 文件的读取的流程：</p>
<ul>
<li>判断 <code>env</code> 文件是否可读</li>
<li>读取整个 <code>env</code> 文件，并将文件按行存储</li>
<li>循环读取每一行，略过注释</li>
<li>进行环境变量赋值</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">ensureFileIsReadable</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (!is_readable(<span class="keyword">$this</span>-&gt;filePath) || !is_file(<span class="keyword">$this</span>-&gt;filePath)) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidPathException(sprintf(<span class="string">'Unable to read the environment file at %s.'</span>, <span class="keyword">$this</span>-&gt;filePath));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">readLinesFromFile</span><span class="params">($filePath)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="comment">// Read file into an array of lines with auto-detected line endings</span></div><div class="line">    $autodetect = ini_get(<span class="string">'auto_detect_line_endings'</span>);</div><div class="line">    ini_set(<span class="string">'auto_detect_line_endings'</span>, <span class="string">'1'</span>);</div><div class="line">    $lines = file($filePath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);</div><div class="line">    ini_set(<span class="string">'auto_detect_line_endings'</span>, $autodetect);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $lines;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">isComment</span><span class="params">($line)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> strpos(ltrim($line), <span class="string">'#'</span>) === <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">looksLikeSetter</span><span class="params">($line)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> strpos($line, <span class="string">'='</span>) !== <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>环境变量赋值是 <code>env</code> 文件加载的核心，主要由 <code>setEnvironmentVariable</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setEnvironmentVariable</span><span class="params">($name, $value = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">list</span>($name, $value) = <span class="keyword">$this</span>-&gt;normaliseEnvironmentVariable($name, $value);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;immutable &amp;&amp; <span class="keyword">$this</span>-&gt;getEnvironmentVariable($name) !== <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (function_exists(<span class="string">'apache_getenv'</span>) &amp;&amp; function_exists(<span class="string">'apache_setenv'</span>) &amp;&amp; apache_getenv($name)) &#123;</div><div class="line">        apache_setenv($name, $value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (function_exists(<span class="string">'putenv'</span>)) &#123;</div><div class="line">        putenv(<span class="string">"$name=$value"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $_ENV[$name] = $value;</div><div class="line">    $_SERVER[$name] = $value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>normaliseEnvironmentVariable</code> 函数用来加载各种类型的环境变量：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">normaliseEnvironmentVariable</span><span class="params">($name, $value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">list</span>($name, $value) = <span class="keyword">$this</span>-&gt;splitCompoundStringIntoParts($name, $value);</div><div class="line">    <span class="keyword">list</span>($name, $value) = <span class="keyword">$this</span>-&gt;sanitiseVariableName($name, $value);</div><div class="line">    <span class="keyword">list</span>($name, $value) = <span class="keyword">$this</span>-&gt;sanitiseVariableValue($name, $value);</div><div class="line"></div><div class="line">    $value = <span class="keyword">$this</span>-&gt;resolveNestedVariables($value);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">array</span>($name, $value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>splitCompoundStringIntoParts</code> 用于将赋值语句转化为环境变量名 <code>name</code> 和环境变量值 <code>value</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">splitCompoundStringIntoParts</span><span class="params">($name, $value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (strpos($name, <span class="string">'='</span>) !== <span class="keyword">false</span>) &#123;</div><div class="line">        <span class="keyword">list</span>($name, $value) = array_map(<span class="string">'trim'</span>, explode(<span class="string">'='</span>, $name, <span class="number">2</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">array</span>($name, $value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>sanitiseVariableName</code> 用于格式化环境变量名：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitiseVariableName</span><span class="params">($name, $value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $name = trim(str_replace(<span class="keyword">array</span>(<span class="string">'export '</span>, <span class="string">'\''</span>, <span class="string">'"'</span>), <span class="string">''</span>, $name));</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">array</span>($name, $value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>sanitiseVariableValue</code> 用于格式化环境变量值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitiseVariableValue</span><span class="params">($name, $value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $value = trim($value);</div><div class="line">    <span class="keyword">if</span> (!$value) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">array</span>($name, $value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;beginsWithAQuote($value)) &#123; <span class="comment">// value starts with a quote</span></div><div class="line">        $quote = $value[<span class="number">0</span>];</div><div class="line">        $regexPattern = sprintf(</div><div class="line">            <span class="string">'/^</span></div><div class="line"><span class="string">            %1$s          # match a quote at the start of the value</span></div><div class="line"><span class="string">            (             # capturing sub-pattern used</span></div><div class="line"><span class="string">             (?:          # we do not need to capture this</span></div><div class="line"><span class="string">              [^%1$s\\\\] # any character other than a quote or backslash</span></div><div class="line"><span class="string">              |\\\\\\\\   # or two backslashes together</span></div><div class="line"><span class="string">              |\\\\%1$s   # or an escaped quote e.g \"</span></div><div class="line"><span class="string">             )*           # as many characters that match the previous rules</span></div><div class="line"><span class="string">            )             # end of the capturing sub-pattern</span></div><div class="line"><span class="string">            %1$s          # and the closing quote</span></div><div class="line"><span class="string">            .*$           # and discard any string after the closing quote</span></div><div class="line"><span class="string">            /mx'</span>,</div><div class="line">            $quote</div><div class="line">        );</div><div class="line">        $value = preg_replace($regexPattern, <span class="string">'$1'</span>, $value);</div><div class="line">        $value = str_replace(<span class="string">"\\$quote"</span>, $quote, $value);</div><div class="line">        $value = str_replace(<span class="string">'\\\\'</span>, <span class="string">'\\'</span>, $value);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $parts = explode(<span class="string">' #'</span>, $value, <span class="number">2</span>);</div><div class="line">        $value = trim($parts[<span class="number">0</span>]);</div><div class="line"></div><div class="line">        <span class="comment">// Unquoted values cannot contain whitespace</span></div><div class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/\s+/'</span>, $value) &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidFileException(<span class="string">'Dotenv values containing spaces must be surrounded by quotes.'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">array</span>($name, trim($value));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码是加载 <code>env</code> 文件最复杂的部分，我们详细来说：</p>
<ul>
<li><p>若环境变量值是具体值，那么仅仅需要分割注释 <code>#</code> 部分，并判断是否存在空格符即可。</p>
</li>
<li><p>若环境变量值由引用构成，那么就需要进行正则匹配，具体的正则表达式为：</p>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/^<span class="string">"((?:[^"</span>\\]|\\\\|\\<span class="string">"))"</span>.*$/mx</div></pre></td></tr></table></figure>
<p>这个正则表达式的意思是：</p>
<ul>
<li>提取 <code>“”</code> 双引号内部的字符串，抛弃双引号之后的字符串</li>
<li>若双引号内部还有双引号，那么以最前面的双引号为提取内容，例如 “dfd(“dfd”)fdf”，我们只能提取出来最前面的部分 “dfd(“</li>
<li>对于内嵌的引用可以使用 <code>\&quot;</code> ，例如 “dfd\”dfd\”fdf”,我们就可以提取出来 “dfd\”dfd\”fdf”。</li>
<li>不允许引用中含有 <code>\</code>，但可以使用转义字符 <code>\\</code></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/08/07/Laravel Http——重定向的使用与源码分析/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/07/Laravel Http——重定向的使用与源码分析/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-07T11:12:57+08:00">
                2017-08-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/07/Laravel Http——重定向的使用与源码分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/08/07/Laravel Http——重定向的使用与源码分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/08/07/Laravel Http——重定向的使用与源码分析/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>laravel</code> 为我们提供便携的重定向功能，可以由门面 <code>Redirect</code>，或者全局函数 <code>redirect()</code> 来启用，本篇文章将会介绍重定向功能的具体细节及源码分析。</p>
<h1 id="URI-重定向"><a href="#URI-重定向" class="headerlink" title="URI 重定向"></a>URI 重定向</h1><p>重定向功能是由类 <code>UrlGenerator</code> 所实现，这个类需要 <code>request</code> 来进行初始化：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> $url = <span class="keyword">new</span> UrlGenerator(</div><div class="line">    $routes = <span class="keyword">new</span> RouteCollection,</div><div class="line">    $request = Request::create(<span class="string">'http://www.foo.com/'</span>)</div><div class="line">);</div></pre></td></tr></table></figure>
<h2 id="重定向到-uri"><a href="#重定向到-uri" class="headerlink" title="重定向到 uri"></a>重定向到 uri</h2><ul>
<li>当我们想要重定向到某个地址时，可以使用 <code>to</code> 函数：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'http://www.foo.com/foo/bar'</span>, $url-&gt;to(<span class="string">'foo/bar'</span>));</div></pre></td></tr></table></figure>
<ul>
<li>当我们想要添加额外的路径，可以将数组赋给第二个参数：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'https://www.foo.com/foo/bar/baz/boom'</span>, $url-&gt;to(<span class="string">'foo/bar'</span>, [<span class="string">'baz'</span>, <span class="string">'boom'</span>], <span class="keyword">true</span>));</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'https://www.foo.com/foo/bar/baz?foo=bar'</span>, $url-&gt;to(<span class="string">'foo/bar?foo=bar'</span>, [<span class="string">'baz'</span>], <span class="keyword">true</span>));</div></pre></td></tr></table></figure>
<h2 id="强制-https"><a href="#强制-https" class="headerlink" title="强制 https"></a>强制 https</h2><p>如果我们想要重定向到 <code>https</code> ，我们可以设置第三个参数为 <code>true</code> :</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'https://www.foo.com/foo/bar'</span>, $url-&gt;to(<span class="string">'foo/bar'</span>, [], <span class="keyword">true</span>));</div></pre></td></tr></table></figure>
<p>或者使用 <code>forceScheme</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$url-&gt;forceScheme(<span class="string">'https'</span>);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'https://www.foo.com/foo/bar'</span>, $url-&gt;to(<span class="string">'foo/bar'</span>);</div></pre></td></tr></table></figure>
<h2 id="强制域名"><a href="#强制域名" class="headerlink" title="强制域名"></a>强制域名</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$url-&gt;forceRootUrl(<span class="string">'https://www.bar.com'</span>);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'https://www.bar.com/foo/bar'</span>, $url-&gt;to(<span class="string">'foo/bar'</span>);</div></pre></td></tr></table></figure>
<h2 id="路径自定义"><a href="#路径自定义" class="headerlink" title="路径自定义"></a>路径自定义</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$url-&gt;formatPathUsing(<span class="function"><span class="keyword">function</span> <span class="params">($path)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'/something'</span>.$path;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'http://www.foo.com/something/foo/bar'</span>, $url-&gt;to(<span class="string">'foo/bar'</span>));</div></pre></td></tr></table></figure>
<h1 id="路由重定向"><a href="#路由重定向" class="headerlink" title="路由重定向"></a>路由重定向</h1><p>重定向另一个非常重要的功能是重定向到路由所在的地址中去：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$route = <span class="keyword">new</span> Route([<span class="string">'GET'</span>], <span class="string">'/named-route'</span>, [<span class="string">'as'</span> =&gt; <span class="string">'plain'</span>]);</div><div class="line">$routes-&gt;add($route);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'http:/www.bar.com/named-route'</span>, $url-&gt;route(<span class="string">'plain'</span>));</div></pre></td></tr></table></figure>
<h2 id="非域名路径"><a href="#非域名路径" class="headerlink" title="非域名路径"></a>非域名路径</h2><p><code>laravel</code> 路由重定向可以选择重定向后的地址是否仍然带有域名，这个特性由第三个参数决定：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$route = <span class="keyword">new</span> Route([<span class="string">'GET'</span>], <span class="string">'/named-route'</span>, [<span class="string">'as'</span> =&gt; <span class="string">'plain'</span>]);</div><div class="line">$routes-&gt;add($route);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'/named-route'</span>, $url-&gt;route(<span class="string">'plain'</span>, [], <span class="keyword">false</span>));</div></pre></td></tr></table></figure>
<h2 id="重定向端口号"><a href="#重定向端口号" class="headerlink" title="重定向端口号"></a>重定向端口号</h2><p>路由重定向可以允许带有 <code>request</code> 自己的端口：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$url = <span class="keyword">new</span> UrlGenerator(</div><div class="line">    $routes = <span class="keyword">new</span> RouteCollection,</div><div class="line">    $request = Request::create(<span class="string">'http://www.foo.com:8080/'</span>)</div><div class="line">);</div><div class="line"></div><div class="line">$route = <span class="keyword">new</span> Route([<span class="string">'GET'</span>], <span class="string">'foo/bar/&#123;baz&#125;'</span>, [<span class="string">'as'</span> =&gt; <span class="string">'bar'</span>, <span class="string">'domain'</span> =&gt; <span class="string">'sub.&#123;foo&#125;.com'</span>]);</div><div class="line">$routes-&gt;add($route);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'http://sub.taylor.com:8080/foo/bar/otwell'</span>, $url-&gt;route(<span class="string">'bar'</span>, [<span class="string">'taylor'</span>, <span class="string">'otwell'</span>]));</div></pre></td></tr></table></figure>
<h2 id="重定向路径参数绑定"><a href="#重定向路径参数绑定" class="headerlink" title="重定向路径参数绑定"></a>重定向路径参数绑定</h2><p>如果路由中含有参数，可以将需要的参数赋给 <code>route</code> 第二个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$route = <span class="keyword">new</span> Route([<span class="string">'GET'</span>], <span class="string">'foo/bar/&#123;baz&#125;'</span>, [<span class="string">'as'</span> =&gt; <span class="string">'foobar'</span>]);</div><div class="line">$routes-&gt;add($route);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'http://www.foo.com/foo/bar/taylor'</span>, $url-&gt;route(<span class="string">'foobar'</span>, <span class="string">'taylor'</span>));</div></pre></td></tr></table></figure>
<p>也可以根据参数的命名来指定参数绑定：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$route = <span class="keyword">new</span> Route([<span class="string">'GET'</span>], <span class="string">'foo/bar/&#123;baz&#125;/breeze/&#123;boom&#125;'</span>, [<span class="string">'as'</span> =&gt; <span class="string">'bar'</span>]);</div><div class="line">$routes-&gt;add($route);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'http://www.foo.com/foo/bar/otwell/breeze/taylor'</span>, $url-&gt;route(<span class="string">'bar'</span>, [<span class="string">'boom'</span> =&gt; <span class="string">'taylor'</span>, <span class="string">'baz'</span> =&gt; <span class="string">'otwell'</span>]));</div></pre></td></tr></table></figure>
<p>还可以利用 <code>defaults</code> 函数为重定向提供默认的参数来绑定：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$url-&gt;defaults([<span class="string">'locale'</span> =&gt; <span class="string">'en'</span>]);</div><div class="line">$route = <span class="keyword">new</span> Route([<span class="string">'GET'</span>], <span class="string">'foo'</span>, [<span class="string">'as'</span> =&gt; <span class="string">'defaults'</span>, <span class="string">'domain'</span> =&gt; <span class="string">'&#123;locale&#125;.example.com'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">&#125;]);</div><div class="line">$routes-&gt;add($route);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'http://en.example.com/foo'</span>, $url-&gt;route(<span class="string">'defaults'</span>));</div></pre></td></tr></table></figure>
<h2 id="重定向路由-querystring-添加"><a href="#重定向路由-querystring-添加" class="headerlink" title="重定向路由 querystring 添加"></a>重定向路由 querystring 添加</h2><p>当在 <code>route</code> 函数中赋给的参数多于路径参数的时候，多余的参数会被添加到 <code>querystring</code> 中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$route = <span class="keyword">new</span> Route([<span class="string">'GET'</span>], <span class="string">'foo/bar/&#123;baz&#125;/breeze/&#123;boom&#125;'</span>, [<span class="string">'as'</span> =&gt; <span class="string">'bar'</span>]);</div><div class="line">$routes-&gt;add($route);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'http://www.foo.com/foo/bar/taylor/breeze/otwell?fly=wall'</span>, $url-&gt;route(<span class="string">'bar'</span>, [<span class="string">'taylor'</span>, <span class="string">'otwell'</span>, <span class="string">'fly'</span> =&gt; <span class="string">'wall'</span>]));</div></pre></td></tr></table></figure>
<h2 id="fragment-重定向"><a href="#fragment-重定向" class="headerlink" title="fragment 重定向"></a>fragment 重定向</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$route = <span class="keyword">new</span> Route([<span class="string">'GET'</span>], <span class="string">'foo/bar#derp'</span>, [<span class="string">'as'</span> =&gt; <span class="string">'fragment'</span>]);</div><div class="line">$routes-&gt;add($route);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'/foo/bar?baz=%C3%A5%CE%B1%D1%84#derp'</span>, $url-&gt;route(<span class="string">'fragment'</span>, [<span class="string">'baz'</span> =&gt; <span class="string">'åαф'</span>], <span class="keyword">false</span>));</div></pre></td></tr></table></figure>
<h2 id="路由-action-重定向"><a href="#路由-action-重定向" class="headerlink" title="路由 action 重定向"></a>路由 action 重定向</h2><p>我们不仅可以通过路由的别名来重定向，还可以利用路由的控制器方法来重定向：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$route = <span class="keyword">new</span> Route([<span class="string">'GET'</span>], <span class="string">'foo/bam'</span>, [<span class="string">'controller'</span> =&gt; <span class="string">'foo@bar'</span>]);</div><div class="line">$routes-&gt;add($route);</div><div class="line">   </div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'http://www.foo.com/foo/bam'</span>, $url-&gt;action(<span class="string">'foo@bar'</span>));</div></pre></td></tr></table></figure>
<p>可以设定重定向控制器的默认命名空间：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$url-&gt;setRootControllerNamespace(<span class="string">'namespace'</span>);</div><div class="line"></div><div class="line">$route = <span class="keyword">new</span> Route([<span class="string">'GET'</span>], <span class="string">'foo/bar'</span>, [<span class="string">'controller'</span> =&gt; <span class="string">'namespace\foo@bar'</span>]);</div><div class="line">        $routes-&gt;add($route);</div><div class="line"></div><div class="line">$route = <span class="keyword">new</span> Route([<span class="string">'GET'</span>], <span class="string">'something/else'</span>, [<span class="string">'controller'</span> =&gt; <span class="string">'something\foo@bar'</span>]);</div><div class="line">$routes-&gt;add($route);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'http://www.foo.com/foo/bar'</span>, $url-&gt;action(<span class="string">'foo@bar'</span>));</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'http://www.foo.com/something/else'</span>, $url-&gt;action(<span class="string">'\something\foo@bar'</span>));</div></pre></td></tr></table></figure>
<h2 id="UrlRoutable-参数绑定"><a href="#UrlRoutable-参数绑定" class="headerlink" title="UrlRoutable 参数绑定"></a>UrlRoutable 参数绑定</h2><p>可以为重定向传入 <code>UrlRoutable</code> 类型的参数，重定向会通过类方法 <code>getRouteKey</code> 来获取对象的某个属性，进而绑定到路由的参数中去。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testRoutableInterfaceRoutingWithSingleParameter</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $url = <span class="keyword">new</span> UrlGenerator(</div><div class="line">        $routes = <span class="keyword">new</span> RouteCollection,</div><div class="line">        $request = Request::create(<span class="string">'http://www.foo.com/'</span>)</div><div class="line">    );</div><div class="line"></div><div class="line">    $route = <span class="keyword">new</span> Route([<span class="string">'GET'</span>], <span class="string">'foo/&#123;bar&#125;'</span>, [<span class="string">'as'</span> =&gt; <span class="string">'routable'</span>]);</div><div class="line">    $routes-&gt;add($route);</div><div class="line"></div><div class="line">    $model = <span class="keyword">new</span> RoutableInterfaceStub;</div><div class="line">    $model-&gt;key = <span class="string">'routable'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'/foo/routable'</span>, $url-&gt;route(<span class="string">'routable'</span>, $model, <span class="keyword">false</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RoutableInterfaceStub</span> <span class="keyword">implements</span> <span class="title">UrlRoutable</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> $key;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRouteKey</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;getRouteKeyName()&#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRouteKeyName</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'key'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="URI-重定向源码分析"><a href="#URI-重定向源码分析" class="headerlink" title="URI 重定向源码分析"></a>URI 重定向源码分析</h1><p>在说重定向的源码之前，我们先了解一下一般的 <code>uri</code> 基本组成：</p>
<p><code>scheme://domain:port/path?queryString</code></p>
<p>也就是说，一般 <code>uri</code> 由五部分构成。重定向实际上就是按照各种传入的参数以及属性的设置来重新生成上面的五部分：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">to</span><span class="params">($path, $extra = [], $secure = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isValidUrl($path)) &#123;</div><div class="line">        <span class="keyword">return</span> $path;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $tail = implode(<span class="string">'/'</span>, array_map(</div><div class="line">        <span class="string">'rawurlencode'</span>, (<span class="keyword">array</span>) <span class="keyword">$this</span>-&gt;formatParameters($extra))</div><div class="line">    );</div><div class="line"></div><div class="line">    $root = <span class="keyword">$this</span>-&gt;formatRoot(<span class="keyword">$this</span>-&gt;formatScheme($secure));</div><div class="line"></div><div class="line">    <span class="keyword">list</span>($path, $query) = <span class="keyword">$this</span>-&gt;extractQueryString($path);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;format(</div><div class="line">        $root, <span class="string">'/'</span>.trim($path.<span class="string">'/'</span>.$tail, <span class="string">'/'</span>)</div><div class="line">    ).$query;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="重定向-scheme"><a href="#重定向-scheme" class="headerlink" title="重定向 scheme"></a>重定向 scheme</h2><p>重定向的 <code>scheme</code> 由函数 <code>formatScheme</code> 生成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">formatScheme</span><span class="params">($secure)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! is_null($secure)) &#123;</div><div class="line">        <span class="keyword">return</span> $secure ? <span class="string">'https://'</span> : <span class="string">'http://'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (is_null(<span class="keyword">$this</span>-&gt;cachedSchema)) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;cachedSchema = <span class="keyword">$this</span>-&gt;forceScheme ?: <span class="keyword">$this</span>-&gt;request-&gt;getScheme().<span class="string">'://'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;cachedSchema;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">forceScheme</span><span class="params">($schema)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;cachedSchema = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;forceScheme = $schema.<span class="string">'://'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出来， <code>scheme</code> 的生成存在优先级：</p>
<ul>
<li>由 <code>to</code> 传入的 <code>secure</code> 参数</li>
<li>由 <code>forceScheme</code> 设置的 <code>schema</code> 参数</li>
<li><code>request</code> 自带的 <code>scheme</code></li>
</ul>
<h2 id="重定向-domain"><a href="#重定向-domain" class="headerlink" title="重定向 domain"></a>重定向 domain</h2><p>重定向的 <code>domain</code> 由函数 <code>formatRoot</code> 生成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">formatRoot</span><span class="params">($scheme, $root = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (is_null($root)) &#123;</div><div class="line">        <span class="keyword">if</span> (is_null(<span class="keyword">$this</span>-&gt;cachedRoot)) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;cachedRoot = <span class="keyword">$this</span>-&gt;forcedRoot ?: <span class="keyword">$this</span>-&gt;request-&gt;root();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $root = <span class="keyword">$this</span>-&gt;cachedRoot;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $start = Str::startsWith($root, <span class="string">'http://'</span>) ? <span class="string">'http://'</span> : <span class="string">'https://'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> preg_replace(<span class="string">'~'</span>.$start.<span class="string">'~'</span>, $scheme, $root, <span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">forceRootUrl</span><span class="params">($root)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;forcedRoot = rtrim($root, <span class="string">'/'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;cachedRoot = <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与 <code>scheme</code> 类似，<code>root</code> 的生成也存在优先级：</p>
<ul>
<li>由 <code>to</code> 传入的 <code>root</code> 参数</li>
<li>由 <code>forceRootUrl</code> 设置的 <code>root</code> 参数</li>
<li><code>request</code> 自带的 <code>root</code></li>
</ul>
<h2 id="重定向-path"><a href="#重定向-path" class="headerlink" title="重定向 path"></a>重定向 path</h2><p>重定向的 <code>path</code> 由三部分构成，一部分是 <code>request</code> 自带的 <code>path</code>，一部分是函数 <code>to</code> 原有的 <code>path</code> ，另一部分是函数 <code>to</code> 传入的参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">formatParameters</span><span class="params">($parameters)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $parameters = array_wrap($parameters);</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> ($parameters <span class="keyword">as</span> $key =&gt; $parameter) &#123;</div><div class="line">        <span class="keyword">if</span> ($parameter <span class="keyword">instanceof</span> UrlRoutable) &#123;</div><div class="line">            $parameters[$key] = $parameter-&gt;getRouteKey();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $parameters;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">extractQueryString</span><span class="params">($path)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (($queryPosition = strpos($path, <span class="string">'?'</span>)) !== <span class="keyword">false</span>) &#123;</div><div class="line">        <span class="keyword">return</span> [</div><div class="line">            substr($path, <span class="number">0</span>, $queryPosition),</div><div class="line">            substr($path, $queryPosition),</div><div class="line">        ];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> [$path, <span class="string">''</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="路由重定向源码分析"><a href="#路由重定向源码分析" class="headerlink" title="路由重定向源码分析"></a>路由重定向源码分析</h1><p>相对于 <code>uri</code> 的重定向来说，路由重定向的 <code>scheme</code>、<code>root</code> 、<code>path</code>、<code>queryString</code> 都要以路由自身的属性为第一优先级，此外还要利用额外参数来绑定路由的 <code>uri</code> 参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">route</span><span class="params">($name, $parameters = [], $absolute = true)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! is_null($route = <span class="keyword">$this</span>-&gt;routes-&gt;getByName($name))) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;toRoute($route, $parameters, $absolute);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(<span class="string">"Route [&#123;$name&#125;] not defined."</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">to</span><span class="params">($route, $parameters = [], $absolute = false)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $domain = <span class="keyword">$this</span>-&gt;getRouteDomain($route, $parameters);</div><div class="line"></div><div class="line">    $uri = <span class="keyword">$this</span>-&gt;addQueryString(<span class="keyword">$this</span>-&gt;url-&gt;format(</div><div class="line">        $root = <span class="keyword">$this</span>-&gt;replaceRootParameters($route, $domain, $parameters),</div><div class="line">        <span class="keyword">$this</span>-&gt;replaceRouteParameters($route-&gt;uri(), $parameters)</div><div class="line">    ), $parameters);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (preg_match(<span class="string">'/\&#123;.*?\&#125;/'</span>, $uri)) &#123;</div><div class="line">        <span class="keyword">throw</span> UrlGenerationException::forMissingParameters($route);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $uri = strtr(rawurlencode($uri), <span class="keyword">$this</span>-&gt;dontEncode);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! $absolute) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'/'</span>.ltrim(str_replace($root, <span class="string">''</span>, $uri), <span class="string">'/'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $uri;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="路由重定向-scheme"><a href="#路由重定向-scheme" class="headerlink" title="路由重定向 scheme"></a>路由重定向 scheme</h2><p>路由的重定向 <code>scheme</code> 需要先判断路由的 <code>scheme</code> 属性：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRouteScheme</span><span class="params">($route)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> ($route-&gt;httpOnly()) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'http://'</span>;</div><div class="line">    &#125; <span class="keyword">elseif</span> ($route-&gt;httpsOnly()) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'https://'</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;url-&gt;formatScheme(<span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="路由重定向-domain"><a href="#路由重定向-domain" class="headerlink" title="路由重定向 domain"></a>路由重定向 domain</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">to</span><span class="params">($route, $parameters = [], $absolute = false)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">	$domain = <span class="keyword">$this</span>-&gt;getRouteDomain($route, $parameters);</div><div class="line"></div><div class="line">    $uri = <span class="keyword">$this</span>-&gt;addQueryString(<span class="keyword">$this</span>-&gt;url-&gt;format(</div><div class="line">        $root = <span class="keyword">$this</span>-&gt;replaceRootParameters($route, $domain, $parameters),</div><div class="line">        <span class="keyword">$this</span>-&gt;replaceRouteParameters($route-&gt;uri(), $parameters)</div><div class="line">    ), $parameters);</div><div class="line">	...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRouteDomain</span><span class="params">($route, &amp;$parameters)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> $route-&gt;domain() ? <span class="keyword">$this</span>-&gt;formatDomain($route, $parameters) : <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">formatDomain</span><span class="params">($route, &amp;$parameters)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;addPortToDomain(</div><div class="line">        <span class="keyword">$this</span>-&gt;getRouteScheme($route).$route-&gt;domain()</div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addPortToDomain</span><span class="params">($domain)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $secure = <span class="keyword">$this</span>-&gt;request-&gt;isSecure();</div><div class="line"></div><div class="line">    $port = (int) <span class="keyword">$this</span>-&gt;request-&gt;getPort();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ($secure &amp;&amp; $port === <span class="number">443</span>) || (! $secure &amp;&amp; $port === <span class="number">80</span>)</div><div class="line">            ? $domain : $domain.<span class="string">':'</span>.$port;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">replaceRootParameters</span><span class="params">($route, $domain, &amp;$parameters)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $scheme = <span class="keyword">$this</span>-&gt;getRouteScheme($route);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;replaceRouteParameters(</div><div class="line">        <span class="keyword">$this</span>-&gt;url-&gt;formatRoot($scheme, $domain), $parameters</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出路由重定向时，域名的生成主要先经过函数 <code>getRouteDomain</code>, 判断路由是否有 <code>domain</code> 属性,如果有域名属性，则将会作为 <code>formatRoot</code> 函数的参数传入，否则就会默认启动 1<code>uri</code> 重定向的域名生成方法。</p>
<h2 id="路由重定向参数绑定"><a href="#路由重定向参数绑定" class="headerlink" title="路由重定向参数绑定"></a>路由重定向参数绑定</h2><p>路由重定向可以利用函数 <code>replaceRootParameters</code> 在域名当中参数绑定，，也可以在路径当中利用函数 <code>replaceRouteParameters</code> 进行参数绑定。参数绑定分为命名参数绑定与匿名参数绑定：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">replaceRouteParameters</span><span class="params">($path, array &amp;$parameters)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $path = <span class="keyword">$this</span>-&gt;replaceNamedParameters($path, $parameters);</div><div class="line"></div><div class="line">    $path = preg_replace_callback(<span class="string">'/\&#123;.*?\&#125;/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($match)</span> <span class="title">use</span> <span class="params">(&amp;$parameters)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">empty</span>($parameters) &amp;&amp; ! Str::endsWith($match[<span class="number">0</span>], <span class="string">'?&#125;'</span>))</div><div class="line">                    ? $match[<span class="number">0</span>]</div><div class="line">                    : array_shift($parameters);</div><div class="line">    &#125;, $path);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> trim(preg_replace(<span class="string">'/\&#123;.*?\?\&#125;/'</span>, <span class="string">''</span>, $path), <span class="string">'/'</span>);</div><div class="line">&#125;</div><div class="line">``` </div><div class="line"></div><div class="line">对于命名参数绑定,程序会分别从变量列表、默认变量列表中获取并替换路由参数对应的数值，若不存在该参数，则直接返回：</div><div class="line"></div><div class="line">```php</div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">replaceNamedParameters</span><span class="params">($path, &amp;$parameters)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> preg_replace_callback(<span class="string">'/\&#123;(.*?)\??\&#125;/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($m)</span> <span class="title">use</span> <span class="params">(&amp;$parameters)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($parameters[$m[<span class="number">1</span>]])) &#123;</div><div class="line">            <span class="keyword">return</span> Arr::pull($parameters, $m[<span class="number">1</span>]);</div><div class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;defaultParameters[$m[<span class="number">1</span>]])) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;defaultParameters[$m[<span class="number">1</span>]];</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> $m[<span class="number">0</span>];</div><div class="line">        &#125;</div><div class="line">    &#125;, $path);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>命名参数绑定结束后，剩下的未被替换的路由参数将会被未命名的变量按顺序来替换。</p>
<h2 id="路由重定向-queryString"><a href="#路由重定向-queryString" class="headerlink" title="路由重定向 queryString"></a>路由重定向 queryString</h2><p>如果变量列表在绑定路由后仍然有剩余，那么变量将会作为路由的 <code>queryString</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addQueryString</span><span class="params">($uri, array $parameters)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! is_null($fragment = parse_url($uri, PHP_URL_FRAGMENT))) &#123;</div><div class="line">        $uri = preg_replace(<span class="string">'/#.*/'</span>, <span class="string">''</span>, $uri);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $uri .= <span class="keyword">$this</span>-&gt;getRouteQueryString($parameters);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> is_null($fragment) ? $uri : $uri.<span class="string">"#&#123;$fragment&#125;"</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRouteQueryString</span><span class="params">(array $parameters)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (count($parameters) == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">''</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $query = http_build_query(</div><div class="line">        $keyed = <span class="keyword">$this</span>-&gt;getStringParameters($parameters)</div><div class="line">    );</div><div class="line"></div><div class="line">        </div><div class="line">    <span class="keyword">if</span> (count($keyed) &lt; count($parameters)) &#123;</div><div class="line">        $query .= <span class="string">'&amp;'</span>.implode(</div><div class="line">            <span class="string">'&amp;'</span>, <span class="keyword">$this</span>-&gt;getNumericParameters($parameters)</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">'?'</span>.trim($query, <span class="string">'&amp;'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="路由重定向结束"><a href="#路由重定向结束" class="headerlink" title="路由重定向结束"></a>路由重定向结束</h2><p>路由 <code>uri</code> 构建完成后，将会继续判断是否存在违背绑定的路由参数，是否显示 <code>absolute</code> 的路由地址</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">to</span><span class="params">($route, $parameters = [], $absolute = false)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">	...</div><div class="line">	<span class="keyword">if</span> (preg_match(<span class="string">'/\&#123;.*?\&#125;/'</span>, $uri)) &#123;</div><div class="line">        <span class="keyword">throw</span> UrlGenerationException::forMissingParameters($route);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    $uri = strtr(rawurlencode($uri), <span class="keyword">$this</span>-&gt;dontEncode);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! $absolute) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'/'</span>.ltrim(str_replace($root, <span class="string">''</span>, $uri), <span class="string">'/'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $uri;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/08/04/RESTFul 路由的使用与源码分析/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/04/RESTFul 路由的使用与源码分析/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-04T00:44:28+08:00">
                2017-08-04
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/04/RESTFul 路由的使用与源码分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/08/04/RESTFul 路由的使用与源码分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/08/04/RESTFul 路由的使用与源码分析/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我们在前面的文章已经讲了整个路由与控制器的源码，我们今天这个文章开始向大家介绍在 <code>laravel</code> 中创建 <code>RESTFul</code> 风格的控制器。</p>
<p>关于什么是RESTFul风格及其规范可参考这篇文章：<a href="http://www.ruanyifeng.com/blog/2011/09/restful.html" target="_blank" rel="external">理解RESTful架构</a>。</p>
<p>关于 <code>laravel</code> 中 <code>RESTFul</code> 风格控制器的创建简要介绍 ： <a href="http://laravelacademy.org/post/549.html" target="_blank" rel="external">HTTP控制器实例教程 —— 创建 <code>RESTFul</code> 风格控制器实现文章增删改查</a></p>
<h1 id="创建-RESTFul-风格控制器"><a href="#创建-RESTFul-风格控制器" class="headerlink" title="创建 RESTFul 风格控制器"></a>创建 <code>RESTFul</code> 风格控制器</h1><p>要想在 <code>laravel</code> 中创建 <code>RESTFul</code> 风格控制器，只需要一句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Route::resource(<span class="string">'post'</span>,<span class="string">'PostController'</span>);</div></pre></td></tr></table></figure>
<p>该路由包含了指向多个动作的子路由：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>路径</th>
<th>动作</th>
<th>路由名称</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/post</td>
<td>index</td>
<td>post.index</td>
</tr>
<tr>
<td>GET</td>
<td>/post/create</td>
<td>create</td>
<td>post.create</td>
</tr>
<tr>
<td>POST</td>
<td>/post</td>
<td>store</td>
<td>post.store</td>
</tr>
<tr>
<td>GET</td>
<td>/post/{post}</td>
<td>show</td>
<td>post.show </td>
</tr>
<tr>
<td>GET</td>
<td>/post/{post}/edit</td>
<td>edit</td>
<td>post.edit</td>
</tr>
<tr>
<td>PUT/PATCH</td>
<td>/post/{post}</td>
<td>update</td>
<td>post.update</td>
</tr>
<tr>
<td>DELETE</td>
<td>/post/{post}</td>
<td>destroy</td>
<td>post.destroy</td>
</tr>
</tbody>
</table>
<p>这种用法既简单又方便，接下来，我们将会说一下 <code>laravel</code> 为我们提供的更加灵活的用法。</p>
<h2 id="前缀-RESTFul-路由"><a href="#前缀-RESTFul-路由" class="headerlink" title="前缀 RESTFul 路由"></a>前缀 <code>RESTFul</code> 路由</h2><p>可以为 <code>RESTFul</code> 路由定义前缀：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$router-&gt;resource(<span class="string">'prefix/foos'</span>, <span class="string">'FooController'</span>);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'prefix/foos/&#123;foo&#125;'</span>, $routes[<span class="number">3</span>]-&gt;uri());</div></pre></td></tr></table></figure>
<h2 id="双参数-RESTFul-路由"><a href="#双参数-RESTFul-路由" class="headerlink" title="双参数 RESTFul 路由"></a>双参数 <code>RESTFul</code> 路由</h2><p><code>laravel</code> 允许定义拥有两个参数的 <code>RESTFul</code> 路由：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$router-&gt;resource(<span class="string">'foos.bars'</span>, <span class="string">'FooController'</span>);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'foos/&#123;foo&#125;/bars/&#123;bar&#125;'</span>, $routes[<span class="number">3</span>]-&gt;uri());</div></pre></td></tr></table></figure>
<h2 id="参数自定义命名"><a href="#参数自定义命名" class="headerlink" title="参数自定义命名"></a>参数自定义命名</h2><p>一般来说，<code>RESTFul</code> 路由的参数命名规则是路由单数，符号 <code>-</code> 转为 <code>_</code>，例如下面例子中 <code>bars</code>，和 <code>foo-baz</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$router-&gt;resource(<span class="string">'foos'</span>, <span class="string">'FooController'</span>);</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'foos/&#123;foo&#125;'</span>, $routes[<span class="number">3</span>]-&gt;uri());</div><div class="line"></div><div class="line">$router-&gt;resource(<span class="string">'foo-bar.foo-baz'</span>, <span class="string">'FooController'</span>, [<span class="string">'only'</span> =&gt; [<span class="string">'show'</span>]]);</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'foo-bar/&#123;foo_bar&#125;/foo-baz/&#123;foo_baz&#125;'</span>, $routes[<span class="number">0</span>]-&gt;uri());</div></pre></td></tr></table></figure>
<p>我们可以利用 <code>parameters</code> 强制这种单数模式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$router-&gt;resource(<span class="string">'foos'</span>, <span class="string">'FooController'</span>, [<span class="string">'parameters'</span> =&gt; <span class="string">'singular'</span>]);</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'foos/&#123;foo&#125;'</span>, $routes[<span class="number">3</span>]-&gt;uri());</div></pre></td></tr></table></figure>
<p>我们也可以利用 <code>singularParameters</code> 来强制：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ResourceRegistrar::singularParameters(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">$router-&gt;resource(<span class="string">'foos'</span>, <span class="string">'FooController'</span>, [<span class="string">'parameters'</span> =&gt; <span class="string">'singular'</span>]);</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'foos/&#123;foo&#125;'</span>, $routes[<span class="number">3</span>]-&gt;uri());</div></pre></td></tr></table></figure>
<p>我们还可以不使用单数，利用 <code>parameters</code> 用自己自定义的名字来定义参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$router-&gt;resource(<span class="string">'bars.foos.bazs'</span>, <span class="string">'FooController'</span>, [<span class="string">'parameters'</span> =&gt; [<span class="string">'foos'</span> =&gt; <span class="string">'oof'</span>, <span class="string">'bazs'</span> =&gt; <span class="string">'b'</span>]]);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'bars/&#123;bar&#125;/foos/&#123;oof&#125;/bazs/&#123;b&#125;'</span>, $routes[<span class="number">3</span>]-&gt;uri());</div></pre></td></tr></table></figure>
<p>同时，我们仍然可以利用 <code>setParameters</code> 函数来自定义参数命名：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ResourceRegistrar::setParameters([<span class="string">'foos'</span> =&gt; <span class="string">'oof'</span>, <span class="string">'bazs'</span> =&gt; <span class="string">'b'</span>]);</div><div class="line"></div><div class="line">$router-&gt;resource(<span class="string">'bars.foos.bazs'</span>, <span class="string">'FooController'</span>);</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'bars/&#123;bar&#125;/foos/&#123;oof&#125;/bazs/&#123;b&#125;'</span>, $routes[<span class="number">3</span>]-&gt;uri());</div></pre></td></tr></table></figure>
<h2 id="RESTFul-路由动词控制"><a href="#RESTFul-路由动词控制" class="headerlink" title="RESTFul 路由动词控制"></a><code>RESTFul</code> 路由动词控制</h2><p><code>laravel</code> 为 <code>RESTFul</code> 路由生成了两个带有动词的路由： <code>create</code> 、 <code>edit</code>，分别用于加载订单的创建页面与编辑页面，这两个动词 <code>laravel</code> 是允许修改的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">ResourceRegistrar::verbs([</div><div class="line">    <span class="string">'create'</span> =&gt; <span class="string">'ajouter'</span>,</div><div class="line">    <span class="string">'edit'</span> =&gt; <span class="string">'modifier'</span>,</div><div class="line">]);</div><div class="line"></div><div class="line">$router-&gt;resource(<span class="string">'foo'</span>, <span class="string">'FooController'</span>);</div><div class="line">$routes = $router-&gt;getRoutes();</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'foo/ajouter'</span>, $routes-&gt;getByName(<span class="string">'foo.create'</span>)-&gt;uri());</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'foo/&#123;foo&#125;/modifier'</span>, $routes-&gt;getByName(<span class="string">'foo.edit'</span>)-&gt;uri());</div></pre></td></tr></table></figure>
<h2 id="控制器方法约束"><a href="#控制器方法约束" class="headerlink" title="控制器方法约束"></a>控制器方法约束</h2><p>一般情况下，我们都会一次性想要上面所生成的七个路由，然而，有时候，我们只需要其中几个，或者不想要其中几个。这时候就可以利用 <code>only</code>  或者 <code>except</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">$router-&gt;resource(<span class="string">'foo'</span>, <span class="string">'FooController'</span>, [<span class="string">'only'</span> =&gt; [<span class="string">'show'</span>, <span class="string">'destroy'</span>]]);</div><div class="line">$routes = $router-&gt;getRoutes();</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertCount(<span class="number">2</span>, $routes);</div></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">$router-&gt;resource(<span class="string">'foo'</span>, <span class="string">'FooController'</span>, [<span class="string">'except'</span> =&gt; [<span class="string">'show'</span>, <span class="string">'destroy'</span>]]);</div><div class="line">$routes = $router-&gt;getRoutes();</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertCount(<span class="number">5</span>, $routes);</div></pre></td></tr></table></figure>
<h2 id="RESTFul-路由名称自定义"><a href="#RESTFul-路由名称自定义" class="headerlink" title="RESTFul 路由名称自定义"></a><code>RESTFul</code> 路由名称自定义</h2><p><code>RESTFul</code> 路由的每个路由都要自己默认的路由名称，<code>laravel</code> 允许我们对路由名称进行修改：</p>
<p>我们可以用 <code>as</code> 来为路由名称添加前缀：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$router-&gt;resource(<span class="string">'foo-bars'</span>, <span class="string">'FooController'</span>, [<span class="string">'only'</span> =&gt; [<span class="string">'show'</span>], <span class="string">'as'</span> =&gt; <span class="string">'prefix'</span>]);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'prefix.foo-bars.show'</span>, $routes[<span class="number">0</span>]-&gt;getName());</div></pre></td></tr></table></figure>
<p>当有多个路由参数的时候，路由参数默认添加到了路由名称中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$router-&gt;resource(<span class="string">'prefix/foo.bar'</span>, <span class="string">'FooController'</span>);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertTrue($router-&gt;getRoutes()-&gt;hasNamedRoute(<span class="string">'foo.bar.index'</span>));</div></pre></td></tr></table></figure>
<p>可以利用 <code>names</code> 为单个路由来命名：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$router-&gt;resource(<span class="string">'foo'</span>, <span class="string">'FooController'</span>, [<span class="string">'names'</span> =&gt; [</div><div class="line">    <span class="string">'index'</span> =&gt; <span class="string">'foo'</span>,</div><div class="line">    <span class="string">'show'</span> =&gt; <span class="string">'bar'</span>,</div><div class="line">]]);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertTrue($router-&gt;getRoutes()-&gt;hasNamedRoute(<span class="string">'foo'</span>));</div><div class="line"><span class="keyword">$this</span>-&gt;assertTrue($router-&gt;getRoutes()-&gt;hasNamedRoute(<span class="string">'bar'</span>));</div></pre></td></tr></table></figure>
<p>还可以利用 <code>names</code> 为所有路由来命名：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$router-&gt;resource(<span class="string">'foo'</span>, <span class="string">'FooController'</span>, [<span class="string">'names'</span> =&gt; <span class="string">'bar'</span>]);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertTrue($router-&gt;getRoutes()-&gt;hasNamedRoute(<span class="string">'bar.index'</span>));</div></pre></td></tr></table></figure>
<h1 id="RESTFul-路由源码分析"><a href="#RESTFul-路由源码分析" class="headerlink" title="RESTFul 路由源码分析"></a><code>RESTFul</code> 路由源码分析</h1><p><code>RESTFul</code> 路由的创建工作由类 <code>ResourceRegistrar</code> 负责，这个类为默认为用户创建七个路由，函数方法 <code>register</code> 是创建路由的主函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResourceRegistrar</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">($name, $controller, array $options = [])</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($options[<span class="string">'parameters'</span>]) &amp;&amp; ! <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;parameters)) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;parameters = $options[<span class="string">'parameters'</span>];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (Str::contains($name, <span class="string">'/'</span>)) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;prefixedResource($name, $controller, $options);</div><div class="line"></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $base = <span class="keyword">$this</span>-&gt;getResourceWildcard(last(explode(<span class="string">'.'</span>, $name)));</div><div class="line"></div><div class="line">        $defaults = <span class="keyword">$this</span>-&gt;resourceDefaults;</div><div class="line"></div><div class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;getResourceMethods($defaults, $options) <span class="keyword">as</span> $m) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;&#123;<span class="string">'addResource'</span>.ucfirst($m)&#125;($name, $base, $controller, $options);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个函数主要流程分为三段：</p>
<ul>
<li>判断是否由前缀</li>
<li>获取路由的基础参数</li>
<li>添加路由</li>
</ul>
<h2 id="拥有前缀的-RESTFul-路由"><a href="#拥有前缀的-RESTFul-路由" class="headerlink" title="拥有前缀的 RESTFul 路由"></a>拥有前缀的 <code>RESTFul</code> 路由</h2><p>如果我们为 <code>RESTFul</code> 路由添加了前缀，那么 <code>laravel</code> 将会以 <code>group</code> 的形式添加路由：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">prefixedResource</span><span class="params">($name, $controller, array $options)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">list</span>($name, $prefix) = <span class="keyword">$this</span>-&gt;getResourcePrefix($name);</div><div class="line"></div><div class="line">    $callback = <span class="function"><span class="keyword">function</span> <span class="params">($me)</span> <span class="title">use</span> <span class="params">($name, $controller, $options)</span> </span>&#123;</div><div class="line">        $me-&gt;resource($name, $controller, $options);</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;router-&gt;group(compact(<span class="string">'prefix'</span>), $callback);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getResourcePrefix</span><span class="params">($name)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $segments = explode(<span class="string">'/'</span>, $name);</div><div class="line"></div><div class="line">    $prefix = implode(<span class="string">'/'</span>, array_slice($segments, <span class="number">0</span>, <span class="number">-1</span>));</div><div class="line"></div><div class="line">    <span class="keyword">return</span> [end($segments), $prefix];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="获取基础-RESTFul-路由参数"><a href="#获取基础-RESTFul-路由参数" class="headerlink" title="获取基础 RESTFul 路由参数"></a>获取基础 <code>RESTFul</code> 路由参数</h2><p>在添加各种路由之前，我们需要先获取路由的基础参数，也就是当存在多参数情况下，最后的参数。获取参数后，如果用户有自定义命名，则获取自定义命名：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResourceWildcard</span><span class="params">($value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;parameters[$value])) &#123;</div><div class="line">        $value = <span class="keyword">$this</span>-&gt;parameters[$value];</div><div class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">static</span>::$parameterMap[$value])) &#123;</div><div class="line">        $value = <span class="keyword">static</span>::$parameterMap[$value];</div><div class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">$this</span>-&gt;parameters === <span class="string">'singular'</span> || <span class="keyword">static</span>::$singularParameters) &#123;</div><div class="line">        $value = Str::singular($value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> str_replace(<span class="string">'-'</span>, <span class="string">'_'</span>, $value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="添加各种路由"><a href="#添加各种路由" class="headerlink" title="添加各种路由"></a>添加各种路由</h2><p>添加路由主要有三个步骤：</p>
<ul>
<li>计算路由 <code>uri</code></li>
<li>获取路由属性</li>
<li>创建路由</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addResourceIndex</span><span class="params">($name, $base, $controller, $options)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $uri = <span class="keyword">$this</span>-&gt;getResourceUri($name);</div><div class="line"></div><div class="line">    $action = <span class="keyword">$this</span>-&gt;getResourceAction($name, $controller, <span class="string">'index'</span>, $options);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;router-&gt;get($uri, $action);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当计算路由 <code>uri</code> 时，由于存在多参数的情况，需要循环计算路由参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResourceUri</span><span class="params">($resource)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! Str::contains($resource, <span class="string">'.'</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> $resource;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $segments = explode(<span class="string">'.'</span>, $resource);</div><div class="line"></div><div class="line">    $uri = <span class="keyword">$this</span>-&gt;getNestedResourceUri($segments);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> str_replace(<span class="string">'/&#123;'</span>.<span class="keyword">$this</span>-&gt;getResourceWildcard(end($segments)).<span class="string">'&#125;'</span>, <span class="string">''</span>, $uri);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getNestedResourceUri</span><span class="params">(array $segments)</span></span></div><div class="line"><span class="function"></span>&#123;  </div><div class="line">    <span class="keyword">return</span> implode(<span class="string">'/'</span>, array_map(<span class="function"><span class="keyword">function</span> <span class="params">($s)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $s.<span class="string">'/&#123;'</span>.<span class="keyword">$this</span>-&gt;getResourceWildcard($s).<span class="string">'&#125;'</span>;</div><div class="line">    &#125;, $segments));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当计算路由的属性时，最重要的是获取路由的名字，路由的名字可以是默认，也可以是用户利用 <code>names</code> 或者 <code>as</code> 属性来自定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getResourceAction</span><span class="params">($resource, $controller, $method, $options)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $name = <span class="keyword">$this</span>-&gt;getResourceRouteName($resource, $method, $options);</div><div class="line"></div><div class="line">    $action = [<span class="string">'as'</span> =&gt; $name, <span class="string">'uses'</span> =&gt; $controller.<span class="string">'@'</span>.$method];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($options[<span class="string">'middleware'</span>])) &#123;</div><div class="line">        $action[<span class="string">'middleware'</span>] = $options[<span class="string">'middleware'</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $action;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getResourceRouteName</span><span class="params">($resource, $method, $options)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $name = $resource;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($options[<span class="string">'names'</span>])) &#123;</div><div class="line">        <span class="keyword">if</span> (is_string($options[<span class="string">'names'</span>])) &#123;</div><div class="line">            $name = $options[<span class="string">'names'</span>];</div><div class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($options[<span class="string">'names'</span>][$method])) &#123;</div><div class="line">            <span class="keyword">return</span> $options[<span class="string">'names'</span>][$method];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">        </div><div class="line">    $prefix = <span class="keyword">isset</span>($options[<span class="string">'as'</span>]) ? $options[<span class="string">'as'</span>].<span class="string">'.'</span> : <span class="string">''</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> trim(sprintf(<span class="string">'%s%s.%s'</span>, $prefix, $name, $method), <span class="string">'.'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>值得注意的是，如果单独为某一个方法命名，那么直接回返回命名，而不会受 <code>as</code> 和方法名 ‘method’ 的影响。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/08/01/路由控制器的运行/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/01/路由控制器的运行/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-01T16:05:56+08:00">
                2017-08-01
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/01/路由控制器的运行/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/08/01/路由控制器的运行/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/08/01/路由控制器的运行/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>经过前面一系列中间件的工作，现在请求终于要达到了正确的控制器方法了。本篇文章主要讲 <code>laravel</code> 如何调用控制器方法，并且为控制器方法依赖注入构建参数的过程。</p>
<h1 id="路由控制器的调用"><a href="#路由控制器的调用" class="headerlink" title="路由控制器的调用"></a>路由控制器的调用</h1><p>我们前面已经解析过中间件的搜集与排序、pipeline 的原理，接下来就要进行路由的 <code>run</code> 运行函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runRouteWithinStack</span><span class="params">(Route $route, Request $request)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $shouldSkipMiddleware = <span class="keyword">$this</span>-&gt;container-&gt;bound(<span class="string">'middleware.disable'</span>) &amp;&amp;</div><div class="line">                            <span class="keyword">$this</span>-&gt;container-&gt;make(<span class="string">'middleware.disable'</span>) === <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    $middleware = $shouldSkipMiddleware ? [] : <span class="keyword">$this</span>-&gt;gatherRouteMiddleware($route);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline(<span class="keyword">$this</span>-&gt;container))</div><div class="line">                    -&gt;send($request)</div><div class="line">                    -&gt;through($middleware)</div><div class="line">                    -&gt;then(<span class="function"><span class="keyword">function</span> <span class="params">($request)</span> <span class="title">use</span> <span class="params">($route)</span> </span>&#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;prepareResponse(</div><div class="line">                            $request, $route-&gt;run()</div><div class="line">                        );</div><div class="line">                    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>路由的 <code>run</code> 函数主要负责路由控制器方法与路由闭包函数的运行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;container = <span class="keyword">$this</span>-&gt;container ?: <span class="keyword">new</span> Container;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isControllerAction()) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;runController();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;runCallable();</div><div class="line">    &#125; <span class="keyword">catch</span> (HttpResponseException $e) &#123;</div><div class="line">        <span class="keyword">return</span> $e-&gt;getResponse();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>路由的运行主要靠 <code>ControllerDispatcher</code> 这个类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Route</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">isControllerAction</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> is_string(<span class="keyword">$this</span>-&gt;action[<span class="string">'uses'</span>]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runController</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> ControllerDispatcher(<span class="keyword">$this</span>-&gt;container))-&gt;dispatch(</div><div class="line">            <span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;getController(), <span class="keyword">$this</span>-&gt;getControllerMethod()</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ControllerDispatcher</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">use</span> <span class="title">RouteDependencyResolverTrait</span>;</div><div class="line">	</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">(Route $route, $controller, $method)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $parameters = <span class="keyword">$this</span>-&gt;resolveClassMethodDependencies(</div><div class="line">            $route-&gt;parametersWithoutNulls(), $controller, $method</div><div class="line">        );</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (method_exists($controller, <span class="string">'callAction'</span>)) &#123;</div><div class="line">            <span class="keyword">return</span> $controller-&gt;callAction($method, $parameters);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $controller-&gt;&#123;$method&#125;(...array_values($parameters));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面可以很清晰地看出，控制器的运行分为两步：解析函数参数、调用callAction</p>
<h2 id="解析控制器方法参数"><a href="#解析控制器方法参数" class="headerlink" title="解析控制器方法参数"></a>解析控制器方法参数</h2><p>解析参数的功能主要由 <code>ControllerDispatcher</code> 类的 <code>RouteDependencyResolverTrait</code> 这一 <code>trait</code> 负责：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">trait</span> RouteDependencyResolverTrait</div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveClassMethodDependencies</span><span class="params">(array $parameters, $instance, $method)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (! method_exists($instance, $method)) &#123;</div><div class="line">            <span class="keyword">return</span> $parameters;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resolveMethodDependencies(</div><div class="line">            $parameters, <span class="keyword">new</span> ReflectionMethod($instance, $method)</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveMethodDependencies</span><span class="params">(array $parameters, ReflectionFunctionAbstract $reflector)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $instanceCount = <span class="number">0</span>;</div><div class="line"></div><div class="line">        $values = array_values($parameters);</div><div class="line"></div><div class="line">        <span class="keyword">foreach</span> ($reflector-&gt;getParameters() <span class="keyword">as</span> $key =&gt; $parameter) &#123;</div><div class="line">            $instance = <span class="keyword">$this</span>-&gt;transformDependency(</div><div class="line">                $parameter, $parameters</div><div class="line">            );</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (! is_null($instance)) &#123;</div><div class="line">                $instanceCount++;</div><div class="line"></div><div class="line">                <span class="keyword">$this</span>-&gt;spliceIntoParameters($parameters, $key, $instance);</div><div class="line">            &#125; <span class="keyword">elseif</span> (! <span class="keyword">isset</span>($values[$key - $instanceCount]) &amp;&amp;</div><div class="line">                      $parameter-&gt;isDefaultValueAvailable()) &#123;</div><div class="line">                <span class="keyword">$this</span>-&gt;spliceIntoParameters($parameters, $key, $parameter-&gt;getDefaultValue());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $parameters;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">``` </div><div class="line"></div><div class="line">控制器方法函数参数构造难点在于，参数来源有三种：</div><div class="line"></div><div class="line">- 路由参数赋值</div><div class="line">- Ioc 容器自动注入</div><div class="line">- 函数自带默认值</div><div class="line"></div><div class="line">在 Ioc 容器自动注入的时候，要保证路由的现有参数中没有相应的类，防止依赖注入覆盖路由绑定的参数：</div><div class="line"></div><div class="line">```php</div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">transformDependency</span><span class="params">(ReflectionParameter $parameter, $parameters)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $class = $parameter-&gt;getClass();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($class &amp;&amp; ! <span class="keyword">$this</span>-&gt;alreadyInParameters($class-&gt;name, $parameters)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;container-&gt;make($class-&gt;name);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">alreadyInParameters</span><span class="params">($class, array $parameters)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> ! is_null(Arr::first($parameters, <span class="function"><span class="keyword">function</span> <span class="params">($value)</span> <span class="title">use</span> <span class="params">($class)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $value <span class="keyword">instanceof</span> $class;</div><div class="line">	&#125;));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由 Ioc 容器构造出的参数需要插入到原有的路由参数数组中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (! is_null($instance)) &#123;</div><div class="line">    $instanceCount++;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;spliceIntoParameters($parameters, $key, $instance);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">spliceIntoParameters</span><span class="params">(array &amp;$parameters, $offset, $value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    array_splice(</div><div class="line">        $parameters, $offset, <span class="number">0</span>, [$value]</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当路由的参数数组与 Ioc 容器构造的参数数量不足以覆盖控制器参数个数时，就要去判断控制器是否具有默认参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">elseif</span> (! <span class="keyword">isset</span>($values[$key - $instanceCount]) &amp;&amp;</div><div class="line">       $parameter-&gt;isDefaultValueAvailable()) &#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;spliceIntoParameters($parameters, $key, $parameter-&gt;getDefaultValue());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="调用控制器方法-callAction"><a href="#调用控制器方法-callAction" class="headerlink" title="调用控制器方法 callAction"></a>调用控制器方法 callAction</h2><p>所有的控制器并非是直接调用相应方法的，而是通过 <code>callAction</code> 函数再分配，如果实在没有相应方法还会调用魔术方法 <code>__call()</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">callAction</span><span class="params">($method, $parameters)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> call_user_func_array([<span class="keyword">$this</span>, $method], $parameters);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $parameters)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BadMethodCallException(<span class="string">"Method [&#123;$method&#125;] does not exist."</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="路由闭包函数的调用"><a href="#路由闭包函数的调用" class="headerlink" title="路由闭包函数的调用"></a>路由闭包函数的调用</h1><p>路由闭包函数的调用与控制器方法一样，仍然需要依赖注入，参数构造：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runCallable</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $callable = <span class="keyword">$this</span>-&gt;action[<span class="string">'uses'</span>];</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $callable(...array_values(<span class="keyword">$this</span>-&gt;resolveMethodDependencies(</div><div class="line">        <span class="keyword">$this</span>-&gt;parametersWithoutNulls(), <span class="keyword">new</span> ReflectionFunction(<span class="keyword">$this</span>-&gt;action[<span class="string">'uses'</span>])</div><div class="line">    )));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/08/01/SubstituteBindings 参数绑定中间件的使用与源码解析/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/01/SubstituteBindings 参数绑定中间件的使用与源码解析/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-01T10:29:04+08:00">
                2017-08-01
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/01/SubstituteBindings 参数绑定中间件的使用与源码解析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/08/01/SubstituteBindings 参数绑定中间件的使用与源码解析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/08/01/SubstituteBindings 参数绑定中间件的使用与源码解析/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>当路由与请求进行正则匹配后，各个路由的参数就获得了它们各自的数值。然而，有些路由参数变量，我们还想要把它转化为特定的对象，这时候就需要中间件的帮助。 <code>SubstituteBindings</code> 中间件就是一个将路由参数转化为特定对象的组件，它默认可以将特定名称的路由参数转化数据库模型对象，可以转化已绑定的路由参数为把绑定的对象。</p>
<h1 id="SubstituteBindings-中间件的使用"><a href="#SubstituteBindings-中间件的使用" class="headerlink" title="SubstituteBindings 中间件的使用"></a><code>SubstituteBindings</code> 中间件的使用</h1><h2 id="数据库模型隐性转化"><a href="#数据库模型隐性转化" class="headerlink" title="数据库模型隐性转化"></a>数据库模型隐性转化</h2><p>首先我们定义了一个带有路由参数的路由：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Route::put(<span class="string">'user/&#123;userid&#125;'</span>, <span class="string">'UserController@update'</span>);</div></pre></td></tr></table></figure>
<p>然后我们在路由的控制器方法中或者路由闭包函数中定义一个数据库模型类型的参数，这个参数名与路由参数相同：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(UserModel $userid)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $userid-&gt;name = <span class="string">'taylor'</span>;</div><div class="line">        $userid-&gt;update();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这时，路由的参数会被中间件隐性地转化为 <code>UserModel</code>，且模型变量 <code>$userid</code> 的主键值为参数变量 <code>{userid}</code> 正则匹配后的数值。</p>
<p>综合测试样例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testImplicitBindingsWithOptionalParameter</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">unset</span>($_SERVER[<span class="string">'__test.controller_callAction_parameters'</span>]);</div><div class="line">    $router-&gt;get(($str = str_random()).<span class="string">'/&#123;user&#125;/&#123;defaultNull?&#125;/&#123;team?&#125;'</span>, [</div><div class="line">        <span class="string">'middleware'</span> =&gt; SubstituteBindings::class,</div><div class="line">        <span class="string">'uses'</span> =&gt; <span class="string">'Illuminate\Tests\Routing\RouteTestAnotherControllerWithParameterStub@withModels'</span>,</div><div class="line">    ]);</div><div class="line">    </div><div class="line">    $router-&gt;dispatch(Request::create($str.<span class="string">'/1'</span>, <span class="string">'GET'</span>));</div><div class="line"></div><div class="line">    $values = array_values($_SERVER[<span class="string">'__test.controller_callAction_parameters'</span>]);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="number">1</span>, $values[<span class="number">0</span>]-&gt;value);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteTestAnotherControllerWithParameterStub</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">callAction</span><span class="params">($method, $parameters)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $_SERVER[<span class="string">'__test.controller_callAction_parameters'</span>] = $parameters;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">withModels</span><span class="params">(RoutingTestUserModel $user)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RoutingTestUserModel</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRouteKeyName</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'id'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">where</span><span class="params">($key, $value)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;value = $value;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">first</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">firstOrFail</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="路由显示绑定"><a href="#路由显示绑定" class="headerlink" title="路由显示绑定"></a>路由显示绑定</h2><p>除了隐示地转化路由参数外，我们还可以给路由参数显示提供绑定。显示绑定有 <code>bind</code>、<code>model</code> 两种方法。</p>
<ul>
<li>通过 <code>bind</code> 为参数绑定闭包函数：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testRouteBinding</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">    $router-&gt;get(<span class="string">'foo/&#123;bar&#125;'</span>, [<span class="string">'middleware'</span> =&gt; SubstituteBindings::class, <span class="string">'uses'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">         <span class="keyword">return</span> $name;</div><div class="line">    &#125;]);</div><div class="line">    $router-&gt;bind(<span class="string">'bar'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($value)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> strtoupper($value);</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'TAYLOR'</span>, $router-&gt;dispatch(Request::create(<span class="string">'foo/taylor'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>通过 <code>bind</code> 为参数绑定类方法，可以指定 <code>classname@method</code>，也可以直接使用类名，默认会调用类的 <code>bind</code> 函数：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testRouteClassBinding</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">    $router-&gt;get(<span class="string">'foo/&#123;bar&#125;'</span>, [<span class="string">'middleware'</span> =&gt; SubstituteBindings::class, <span class="string">'uses'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">    	<span class="keyword">return</span> $name;</div><div class="line">    &#125;]);</div><div class="line">    $router-&gt;bind(<span class="string">'bar'</span>, <span class="string">'Illuminate\Tests\Routing\RouteBindingStub'</span>);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'TAYLOR'</span>, $router-&gt;dispatch(Request::create(<span class="string">'foo/taylor'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testRouteClassMethodBinding</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">    $router-&gt;get(<span class="string">'foo/&#123;bar&#125;'</span>, [<span class="string">'middleware'</span> =&gt; SubstituteBindings::class, <span class="string">'uses'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $name;</div><div class="line">    &#125;]);</div><div class="line">    $router-&gt;bind(<span class="string">'bar'</span>, <span class="string">'Illuminate\Tests\Routing\RouteBindingStub@find'</span>);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'dragon'</span>, $router-&gt;dispatch(Request::create(<span class="string">'foo/Dragon'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteBindingStub</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span><span class="params">($value, $route)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> strtoupper($value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">find</span><span class="params">($value, $route)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> strtolower($value);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>通过 <code>model</code> 为参数绑定数据库模型，路由的参数就不需要和控制器方法中的变量名相同，<code>laravel</code> 会利用路由参数的值去调用 <code>where</code> 方法查找对应记录：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($model = $instance-&gt;where($instance-&gt;getRouteKeyName(), $value)-&gt;first()) &#123;</div><div class="line">     <span class="keyword">return</span> $model;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试样例如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testModelBinding</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">    $router-&gt;get(<span class="string">'foo/&#123;bar&#125;'</span>, [<span class="string">'middleware'</span> =&gt; SubstituteBindings::class, <span class="string">'uses'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $name;</div><div class="line">    &#125;]);</div><div class="line">    $router-&gt;model(<span class="string">'bar'</span>, <span class="string">'Illuminate\Tests\Routing\RouteModelBindingStub'</span>);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'TAYLOR'</span>, $router-&gt;dispatch(Request::create(<span class="string">'foo/taylor'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteModelBindingStub</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRouteKeyName</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'id'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">where</span><span class="params">($key, $value)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;value = $value;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">first</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> strtoupper(<span class="keyword">$this</span>-&gt;value);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>若绑定的 <code>model</code> 并没有找到对应路由参数的记录，可以在 <code>model</code> 中定义一个闭包函数，路由参数会调用闭包函数：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testModelBindingWithCustomNullReturn</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">    $router-&gt;get(<span class="string">'foo/&#123;bar&#125;'</span>, [<span class="string">'middleware'</span> =&gt; SubstituteBindings::class, <span class="string">'uses'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $name;</div><div class="line">    &#125;]);</div><div class="line">    $router-&gt;model(<span class="string">'bar'</span>, <span class="string">'Illuminate\Tests\Routing\RouteModelBindingNullStub'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'missing'</span>;</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'missing'</span>, $router-&gt;dispatch(Request::create(<span class="string">'foo/taylor'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testModelBindingWithBindingClosure</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">    $router-&gt;get(<span class="string">'foo/&#123;bar&#125;'</span>, [<span class="string">'middleware'</span> =&gt; SubstituteBindings::class, <span class="string">'uses'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $name;</div><div class="line">    &#125;]);</div><div class="line">    $router-&gt;model(<span class="string">'bar'</span>, <span class="string">'Illuminate\Tests\Routing\RouteModelBindingNullStub'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($value)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> RouteModelBindingClosureStub())-&gt;findAlternate($value);</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'tayloralt'</span>, $router-&gt;dispatch(Request::create(<span class="string">'foo/TAYLOR'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteModelBindingNullStub</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRouteKeyName</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'id'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">where</span><span class="params">($key, $value)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">first</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteModelBindingClosureStub</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findAlternate</span><span class="params">($value)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> strtolower($value).<span class="string">'alt'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="SubstituteBindings-中间件的源码解析"><a href="#SubstituteBindings-中间件的源码解析" class="headerlink" title="SubstituteBindings 中间件的源码解析"></a><code>SubstituteBindings</code> 中间件的源码解析</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubstituteBindings</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;router-&gt;substituteBindings($route = $request-&gt;route());</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;router-&gt;substituteImplicitBindings($route);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $next($request);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从代码来看，<code>substituteBindings</code> 用于显示的参数转化，<code>substituteImplicitBindings</code> 用于隐性的参数转化。</p>
<h2 id="隐性参数转化源码解析"><a href="#隐性参数转化源码解析" class="headerlink" title="隐性参数转化源码解析"></a>隐性参数转化源码解析</h2><p>进行隐性参数转化，其步骤为：</p>
<ul>
<li>扫描控制器方法或者闭包函数所有的参数，提取出数据库模型类型对象</li>
<li>根据模型类型对象的 <code>name</code>，找出与模型对象命名相同的路由参数</li>
<li>根据模型类型对象的 <code>classname</code>，构建数据库模型类型对象，根据路由参数的数值在数据库中执行 <code>sql</code> 语句查询</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">substituteImplicitBindings</span><span class="params">($route)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    ImplicitRouteBinding::resolveForRoute(<span class="keyword">$this</span>-&gt;container, $route);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImplicitRouteBinding</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveForRoute</span><span class="params">($container, $route)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $parameters = $route-&gt;parameters();</div><div class="line"></div><div class="line">        <span class="keyword">foreach</span> ($route-&gt;signatureParameters(Model::class) <span class="keyword">as</span> $parameter) &#123;</div><div class="line">            $class = $parameter-&gt;getClass();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (array_key_exists($parameter-&gt;name, $parameters) &amp;&amp;</div><div class="line">                ! $route-&gt;parameter($parameter-&gt;name) <span class="keyword">instanceof</span> Model) &#123;</div><div class="line">                $method = $parameter-&gt;isDefaultValueAvailable() ? <span class="string">'first'</span> : <span class="string">'firstOrFail'</span>;</div><div class="line"></div><div class="line">                $model = $container-&gt;make($class-&gt;name);</div><div class="line"></div><div class="line">                $route-&gt;setParameter(</div><div class="line">                    $parameter-&gt;name, $model-&gt;where(</div><div class="line">                        $model-&gt;getRouteKeyName(), $parameters[$parameter-&gt;name]</div><div class="line">                    )-&gt;&#123;$method&#125;()</div><div class="line">                );</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>值得注意的是，显示参数转化的优先级要高于隐性转化，如果当前参数已经被 <code>model</code> 函数显示转化，那么该参数并不会进行隐性转化，也就是上面语句 <code>! $route-&gt;parameter($parameter-&gt;name) instanceof Model</code> 的作用。</p>
<p>其中扫描控制器方法参数的功能主要利用反射机制：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">signatureParameters</span><span class="params">($subClass = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> RouteSignatureParameters::fromAction(<span class="keyword">$this</span>-&gt;action, $subClass);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteSignatureParameters</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">fromAction</span><span class="params">(array $action, $subClass = null)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $parameters = is_string($action[<span class="string">'uses'</span>])</div><div class="line">                        ? <span class="keyword">static</span>::fromClassMethodString($action[<span class="string">'uses'</span>])</div><div class="line">                        : (<span class="keyword">new</span> ReflectionFunction($action[<span class="string">'uses'</span>]))-&gt;getParameters();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> is_null($subClass) ? $parameters : array_filter($parameters, <span class="function"><span class="keyword">function</span> <span class="params">($p)</span> <span class="title">use</span> <span class="params">($subClass)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> $p-&gt;getClass() &amp;&amp; $p-&gt;getClass()-&gt;isSubclassOf($subClass);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">fromClassMethodString</span><span class="params">($uses)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">list</span>($class, $method) = Str::parseCallback($uses);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> ReflectionMethod($class, $method))-&gt;getParameters();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="bind-显示参数绑定"><a href="#bind-显示参数绑定" class="headerlink" title="bind 显示参数绑定"></a>bind 显示参数绑定</h2><p>路由的 <code>bind</code> 功能由专门的 <code>binders</code> 数组负责，这个数组中保存着所有的需要显示转化的路由参数与他们的转化闭包函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span><span class="params">($key, $binder)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;binders[str_replace(<span class="string">'-'</span>, <span class="string">'_'</span>, $key)] = RouteBinding::forCallback(</div><div class="line">        <span class="keyword">$this</span>-&gt;container, $binder</div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteBinding</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">forCallback</span><span class="params">($container, $binder)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (is_string($binder)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">static</span>::createClassBinding($container, $binder);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $binder;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">createClassBinding</span><span class="params">($container, $binding)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($value, $route)</span> <span class="title">use</span> <span class="params">($container, $binding)</span> </span>&#123;</div><div class="line">            <span class="keyword">list</span>($class, $method) = Str::parseCallback($binding, <span class="string">'bind'</span>);</div><div class="line"></div><div class="line">            $callable = [$container-&gt;make($class), $method];</div><div class="line"></div><div class="line">            <span class="keyword">return</span> call_user_func($callable, $value, $route);</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，<code>bind</code> 函数可以绑定闭包、<code>classname@method</code>、<code>classname</code>，如果仅仅绑定了一个类名，那么程序默认调用类中 <code>bind</code> 方法。</p>
<h2 id="model-显示参数绑定"><a href="#model-显示参数绑定" class="headerlink" title="model 显示参数绑定"></a>model 显示参数绑定</h2><p><code>model</code> 调用 <code>bind</code> 函数，赋给 <code>bind</code> 函数一个提前包装好的闭包函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">model</span><span class="params">($key, $class, Closure $callback = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;bind($key, RouteBinding::forModel(<span class="keyword">$this</span>-&gt;container, $class, $callback));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteBinding</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">forModel</span><span class="params">($container, $class, $callback = null)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($value)</span> <span class="title">use</span> <span class="params">($container, $class, $callback)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (is_null($value)) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            $instance = $container-&gt;make($class);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> ($model = $instance-&gt;where($instance-&gt;getRouteKeyName(), $value)-&gt;first()) &#123;</div><div class="line">                <span class="keyword">return</span> $model;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> ($callback <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">                <span class="keyword">return</span> call_user_func($callback, $value);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">throw</span> (<span class="keyword">new</span> ModelNotFoundException)-&gt;setModel($class);</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，这个闭包函数与隐性转化很相似，都是首先创建数据库模型对象，再利用路由参数值来查询数据库，返回对象。 <code>model</code> 还可以提供默认的闭包函数，以供查询不到数据库时调用。</p>
<h2 id="显示路由参数转化"><a href="#显示路由参数转化" class="headerlink" title="显示路由参数转化"></a>显示路由参数转化</h2><p>当运行中间件 <code>SubstituteBindings</code> 时，就会将先前绑定的各个闭包函数执行，并对路由参数进行转化：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">substituteBindings</span><span class="params">($route)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">foreach</span> ($route-&gt;parameters() <span class="keyword">as</span> $key =&gt; $value) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;binders[$key])) &#123;</div><div class="line">            $route-&gt;setParameter($key, <span class="keyword">$this</span>-&gt;performBinding($key, $value, $route));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $route;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">performBinding</span><span class="params">($key, $value, $route)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> call_user_func(<span class="keyword">$this</span>-&gt;binders[$key], $value, $route);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setParameter</span><span class="params">($name, $value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;parameters();</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;parameters[$name] = $value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/07/27/Laravel Http——路由中间件源码分析/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/27/Laravel Http——路由中间件源码分析/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-27T21:32:54+08:00">
                2017-07-27
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/27/Laravel Http——路由中间件源码分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/27/Laravel Http——路由中间件源码分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/27/Laravel Http——路由中间件源码分析/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>当进行了路由匹配与路由参数绑定后，接下来就要进行路由闭包或者控制器的运行，在此之前，本文先介绍中间件的相关源码。</p>
<h1 id="中间件的搜集"><a href="#中间件的搜集" class="headerlink" title="中间件的搜集"></a>中间件的搜集</h1><p>由于定义的中间件方式很灵活，所以在运行控制器或者路由闭包之前，我们需要先将在各个地方注册的所有中间件都搜集到一起，然后集中排序。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRoute</span><span class="params">(Request $request)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $route = <span class="keyword">$this</span>-&gt;findRoute($request);</div><div class="line"></div><div class="line">    $request-&gt;setRouteResolver(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($route)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $route;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;events-&gt;dispatch(<span class="keyword">new</span> Events\RouteMatched($route, $request));</div><div class="line"></div><div class="line">    $response = <span class="keyword">$this</span>-&gt;runRouteWithinStack($route, $request);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;prepareResponse($request, $response);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runRouteWithinStack</span><span class="params">(Route $route, Request $request)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $shouldSkipMiddleware = <span class="keyword">$this</span>-&gt;container-&gt;bound(<span class="string">'middleware.disable'</span>) &amp;&amp;</div><div class="line">                            <span class="keyword">$this</span>-&gt;container-&gt;make(<span class="string">'middleware.disable'</span>) === <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    $middleware = $shouldSkipMiddleware ? [] : <span class="keyword">$this</span>-&gt;gatherRouteMiddleware($route);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline(<span class="keyword">$this</span>-&gt;container))</div><div class="line">                    -&gt;send($request)</div><div class="line">                    -&gt;through($middleware)</div><div class="line">                    -&gt;then(<span class="function"><span class="keyword">function</span> <span class="params">($request)</span> <span class="title">use</span> <span class="params">($route)</span> </span>&#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;prepareResponse(</div><div class="line">                            $request, $route-&gt;run()</div><div class="line">                        );</div><div class="line">                    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">gatherRouteMiddleware</span><span class="params">(Route $route)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $middleware = collect($route-&gt;gatherMiddleware())-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">array</span>) MiddlewareNameResolver::resolve($name, <span class="keyword">$this</span>-&gt;middleware, <span class="keyword">$this</span>-&gt;middlewareGroups);</div><div class="line">    &#125;)-&gt;flatten();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;sortMiddleware($middleware);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>路由的中间件大致有两个大的来源：</p>
<ul>
<li>在路由的定义过程中，利用关键字 <code>middleware</code> 为路由添加中间件，这种中间件都是在文件 <code>App\Http\Kernel</code> 中<code>$middlewareGroups</code> 、<code>$routeMiddleware</code> 这两个数组定义的中间件别名。</li>
<li>在路由控制器的构造函数中，添加中间件，可以在这里定义一个闭包作为中间件，也可以利用中间件别名。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">gatherMiddleware</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! is_null(<span class="keyword">$this</span>-&gt;computedMiddleware)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;computedMiddleware;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;computedMiddleware = [];</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;computedMiddleware = array_unique(array_merge(</div><div class="line">        <span class="keyword">$this</span>-&gt;middleware(), <span class="keyword">$this</span>-&gt;controllerMiddleware()</div><div class="line">    ), SORT_REGULAR);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="路由定义的中间件是从-action-数组中取出来的："><a href="#路由定义的中间件是从-action-数组中取出来的：" class="headerlink" title="路由定义的中间件是从 action 数组中取出来的："></a>路由定义的中间件是从 <code>action</code> 数组中取出来的：</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">middleware</span><span class="params">($middleware = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (is_null($middleware)) &#123;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">array</span>) Arr::get(<span class="keyword">$this</span>-&gt;action, <span class="string">'middleware'</span>, []);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (is_string($middleware)) &#123;</div><div class="line">        $middleware = func_get_args();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;action[<span class="string">'middleware'</span>] = array_merge(</div><div class="line">        (<span class="keyword">array</span>) Arr::get(<span class="keyword">$this</span>-&gt;action, <span class="string">'middleware'</span>, []), $middleware</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="控制器定义的中间件："><a href="#控制器定义的中间件：" class="headerlink" title="控制器定义的中间件："></a>控制器定义的中间件：</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">controllerMiddleware</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;isControllerAction()) &#123;</div><div class="line">        <span class="keyword">return</span> [];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ControllerDispatcher::getMiddleware(</div><div class="line">        <span class="keyword">$this</span>-&gt;getController(), <span class="keyword">$this</span>-&gt;getControllerMethod()</div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getController</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $class = <span class="keyword">$this</span>-&gt;parseControllerCallback()[<span class="number">0</span>];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;controller) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;controller = <span class="keyword">$this</span>-&gt;container-&gt;make($class);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;controller;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getControllerMethod</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;parseControllerCallback()[<span class="number">1</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseControllerCallback</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> Str::parseCallback(<span class="keyword">$this</span>-&gt;action[<span class="string">'uses'</span>]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">parseCallback</span><span class="params">($callback, $default = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">static</span>::contains($callback, <span class="string">'@'</span>) ? explode(<span class="string">'@'</span>, $callback, <span class="number">2</span>) : [$callback, $default];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当前的路由如果使用控制器的时候，就要解析属性 <code>use</code>，解析出控制器的类名与类方法。接下来就需要 <code>ControllerDispatcher</code> 类。</p>
<p>在讲解 <code>ControllerDispatcher</code> 类之前，我们需要先了解一下控制器中间件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">middleware</span><span class="params">($middleware, array $options = [])</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">foreach</span> ((<span class="keyword">array</span>) $middleware <span class="keyword">as</span> $m) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;middleware[] = [</div><div class="line">                <span class="string">'middleware'</span> =&gt; $m,</div><div class="line">                <span class="string">'options'</span> =&gt; &amp;$options,</div><div class="line">            ];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ControllerMiddlewareOptions($options);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ControllerMiddlewareOptions</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">protected</span> $options;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(array &amp;$options)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;options = &amp;$options;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">only</span><span class="params">($methods)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;options[<span class="string">'only'</span>] = is_array($methods) ? $methods : func_get_args();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">except</span><span class="params">($methods)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;options[<span class="string">'except'</span>] = is_array($methods) ? $methods : func_get_args();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在为控制器定义中间的是，可以为中间件利用 <code>only</code> 指定在当前控制器中调用该中间件的特定控制器方法，也可以利用 <code>except</code>指定在当前控制器禁止调用中间件的方法。这些信息都保存在控制器的变量 <code>middleware</code> 的 <code>options</code> 中。</p>
<p>在搜集控制器的中间件时，就要利用中间件的这些信息：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ControllerDispatcher</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getMiddleware</span><span class="params">($controller, $method)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (! method_exists($controller, <span class="string">'getMiddleware'</span>)) &#123;</div><div class="line">            <span class="keyword">return</span> [];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> collect($controller-&gt;getMiddleware())-&gt;reject(<span class="function"><span class="keyword">function</span> <span class="params">($data)</span> <span class="title">use</span> <span class="params">($method)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">static</span>::methodExcludedByOptions($method, $data[<span class="string">'options'</span>]);</div><div class="line">        &#125;)-&gt;pluck(<span class="string">'middleware'</span>)-&gt;all();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">methodExcludedByOptions</span><span class="params">($method, array $options)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">isset</span>($options[<span class="string">'only'</span>]) &amp;&amp; ! in_array($method, (<span class="keyword">array</span>) $options[<span class="string">'only'</span>])) ||</div><div class="line">            (! <span class="keyword">empty</span>($options[<span class="string">'except'</span>]) &amp;&amp; in_array($method, (<span class="keyword">array</span>) $options[<span class="string">'except'</span>]));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>ControllerDispatcher</code> 类中，利用了 <code>reject</code> 函数对每一个中间件都进行了控制器方法的判断，排除了不支持该控制器方法的中间件。<code>pluck</code> 函数获取了控制器 <code>$this-&gt;middleware[]</code> 数组中 <code>middleware</code> 的所有元素。</p>
<h1 id="中间件的解析"><a href="#中间件的解析" class="headerlink" title="中间件的解析"></a>中间件的解析</h1><p>中间件解析主要的工作是将路由中中间件的别名转化为中间件全程，主要流程为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MiddlewareNameResolver</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">resolve</span><span class="params">($name, $map, $middlewareGroups)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> ($name <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">            <span class="keyword">return</span> $name;</div><div class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($map[$name]) &amp;&amp; $map[$name] <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">            <span class="keyword">return</span> $map[$name];</div><div class="line"></div><div class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($middlewareGroups[$name])) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">static</span>::parseMiddlewareGroup(</div><div class="line">                $name, $map, $middlewareGroups</div><div class="line">            );</div><div class="line"></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">list</span>($name, $parameters) = array_pad(explode(<span class="string">':'</span>, $name, <span class="number">2</span>), <span class="number">2</span>, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">            <span class="keyword">return</span> (<span class="keyword">isset</span>($map[$name]) ? $map[$name] : $name).</div><div class="line">                   (! is_null($parameters) ? <span class="string">':'</span>.$parameters : <span class="string">''</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，解析的中间件对象有三种：闭包、中间件别名、中间件组。</p>
<ul>
<li>对于闭包来说，<code>resolve</code> 直接返回闭包；</li>
<li>对于中间件别名来说，例如 <code>auth</code> ，会从 <code>App\Http\Kernel</code> 文件 <code>$routeMiddleware</code> 数组中寻找中间件全名 <code>\Illuminate\Auth\Middleware\Authenticate::class</code></li>
<li>对于具有参数的中间件别名来说，例如 <code>throttle:60,1</code>,会将别名转化为全名 <code>\Illuminate\Routing\Middleware\ThrottleRequests::60,1</code></li>
<li>对于中间件组来说，会调用 <code>parseMiddlewareGroup</code> 函数。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">parseMiddlewareGroup</span><span class="params">($name, $map, $middlewareGroups)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $results = [];</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> ($middlewareGroups[$name] <span class="keyword">as</span> $middleware) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($middlewareGroups[$middleware])) &#123;</div><div class="line">            $results = array_merge($results, <span class="keyword">static</span>::parseMiddlewareGroup(</div><div class="line">                $middleware, $map, $middlewareGroups</div><div class="line">            ));</div><div class="line"></div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">list</span>($middleware, $parameters) = array_pad(</div><div class="line">            explode(<span class="string">':'</span>, $middleware, <span class="number">2</span>), <span class="number">2</span>, <span class="keyword">null</span></div><div class="line">        );</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($map[$middleware])) &#123;</div><div class="line">            $middleware = $map[$middleware];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $results[] = $middleware.($parameters ? <span class="string">':'</span>.$parameters : <span class="string">''</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $results;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，对于中间件组来说，就要从 <code>App\Http\Kernel</code> 文件 <code>$$middlewareGroups</code> 数组中寻找组内的多个中间件，例如中间件组 <code>api</code> ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="string">'api'</span> =&gt; [</div><div class="line">    <span class="string">'throttle:60,1'</span>,</div><div class="line">    <span class="string">'bindings'</span>,</div><div class="line">]</div></pre></td></tr></table></figure>
<p>解析出的中间件可能存在参数，别名转化为全名后函数返回。值得注意的是，中间件组内不一定都是别名，也有可能是中间件组的组名，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="string">'api'</span> =&gt; [</div><div class="line">    <span class="string">'throttle:60,1'</span>,</div><div class="line">    <span class="string">'web'</span>,</div><div class="line">]</div><div class="line"></div><div class="line"><span class="string">'web'</span> =&gt; [</div><div class="line">    \App\Http\Middleware\EncryptCookies::class,</div><div class="line">    \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,</div><div class="line">],</div></pre></td></tr></table></figure>
<p>这时，就需要迭代解析。</p>
<h1 id="中间件的排序"><a href="#中间件的排序" class="headerlink" title="中间件的排序"></a>中间件的排序</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">gatherRouteMiddleware</span><span class="params">(Route $route)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $middleware = collect($route-&gt;gatherMiddleware())-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">array</span>) MiddlewareNameResolver::resolve($name, <span class="keyword">$this</span>-&gt;middleware, <span class="keyword">$this</span>-&gt;middlewareGroups);</div><div class="line">    &#125;)-&gt;flatten();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;sortMiddleware($middleware);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>将所有中间件搜集并解析完毕后，接下来就要对中间件的调用顺序做一些调整，以确保中间件功能正常。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $middlewarePriority = [</div><div class="line">    \Illuminate\Session\Middleware\StartSession::class,</div><div class="line">    \Illuminate\View\Middleware\ShareErrorsFromSession::class,</div><div class="line">    \Illuminate\Auth\Middleware\Authenticate::class,</div><div class="line">    \Illuminate\Session\Middleware\AuthenticateSession::class,</div><div class="line">    \Illuminate\Routing\Middleware\SubstituteBindings::class,</div><div class="line">    \Illuminate\Auth\Middleware\Authorize::class,</div><div class="line">];</div></pre></td></tr></table></figure>
<p>数组 <code>middlewarePriority</code> 中保存着必须有一定顺序的中间件，例如 <code>StartSession</code> 中间件就必须运行在 <code>ShareErrorsFromSession</code> 之前。因此一旦路由中有这两个中间件，那么就要确保两者的顺序一致。</p>
<p>中间件的排序由函数 <code>sortMiddleware</code> 负责：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SortedMiddleware</span> <span class="keyword">extends</span> <span class="title">Collection</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(array $priorityMap, $middlewares)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> ($middlewares <span class="keyword">instanceof</span> Collection) &#123;</div><div class="line">            $middlewares = $middlewares-&gt;all();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;items = <span class="keyword">$this</span>-&gt;sortMiddleware($priorityMap, $middlewares);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sortMiddleware</span><span class="params">($priorityMap, $middlewares)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $lastIndex = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="keyword">foreach</span> ($middlewares <span class="keyword">as</span> $index =&gt; $middleware) &#123;</div><div class="line">            <span class="keyword">if</span> (! is_string($middleware)) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            $stripped = head(explode(<span class="string">':'</span>, $middleware));</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (in_array($stripped, $priorityMap)) &#123;</div><div class="line">                $priorityIndex = array_search($stripped, $priorityMap);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>($lastPriorityIndex) &amp;&amp; $priorityIndex &lt; $lastPriorityIndex) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;sortMiddleware(</div><div class="line">                        $priorityMap, array_values(</div><div class="line">                            <span class="keyword">$this</span>-&gt;moveMiddleware($middlewares, $index, $lastIndex)</div><div class="line">                        )</div><div class="line">                    );</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    $lastIndex = $index;</div><div class="line">                    $lastPriorityIndex = $priorityIndex;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> array_values(array_unique($middlewares, SORT_REGULAR));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">moveMiddleware</span><span class="params">($middlewares, $from, $to)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        array_splice($middlewares, $to, <span class="number">0</span>, $middlewares[$from]);</div><div class="line"></div><div class="line">        <span class="keyword">unset</span>($middlewares[$from + <span class="number">1</span>]);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $middlewares;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>函数的方法很简单，检测当前中间件数组，查看是否存在中间件是数组 <code>middlewarePriority</code> 内元素。如果发现了两个中间件不符合顺序，那么就要调换中间件顺序，然后进行迭代。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/07/26/Laravel Http——路由的匹配与参数绑定/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/26/Laravel Http——路由的匹配与参数绑定/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-26T22:18:02+08:00">
                2017-07-26
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/26/Laravel Http——路由的匹配与参数绑定/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/26/Laravel Http——路由的匹配与参数绑定/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/26/Laravel Http——路由的匹配与参数绑定/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一篇文章我们说到路由的正则编译，正则编译的目的就是和请求的 <code>url</code> 来匹配，只有匹配上的路由才是我们真正想要的，此外也会通过正则匹配来获取路由的参数。</p>
<h1 id="路由的匹配"><a href="#路由的匹配" class="headerlink" title="路由的匹配"></a>路由的匹配</h1><p>路由进行正则编译后，就要与请求 <code>request</code> 来进行正则匹配，并且进行一些验证，例如 <code>UriValidator</code>、<code>MethodValidator</code>、<code>SchemeValidator</code>、<code>HostValidator</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteCollection</span> <span class="keyword">implements</span> <span class="title">Countable</span>, <span class="title">IteratorAggregate</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">match</span><span class="params">(Request $request)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $routes = <span class="keyword">$this</span>-&gt;get($request-&gt;getMethod());</div><div class="line"></div><div class="line">        $route = <span class="keyword">$this</span>-&gt;matchAgainstRoutes($routes, $request);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (! is_null($route)) &#123;</div><div class="line">            <span class="keyword">return</span> $route-&gt;bind($request);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $others = <span class="keyword">$this</span>-&gt;checkForAlternateVerbs($request);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (count($others) &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getRouteForMethods($request, $others);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotFoundHttpException;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">matchAgainstRoutes</span><span class="params">(array $routes, $request, $includingMethod = true)</span></span></div><div class="line"><span class="function">	</span>&#123;</div><div class="line">   		 <span class="keyword">return</span> Arr::first($routes, <span class="function"><span class="keyword">function</span> <span class="params">($value)</span> <span class="title">use</span> <span class="params">($request, $includingMethod)</span> </span>&#123;</div><div class="line">	    	 <span class="keyword">return</span> $value-&gt;matches($request, $includingMethod);</div><div class="line">   		 &#125;);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Route</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">matches</span><span class="params">(Request $request, $includingMethod = true)</span></span></div><div class="line"><span class="function">	</span>&#123;</div><div class="line">   		 <span class="keyword">$this</span>-&gt;compileRoute();</div><div class="line"></div><div class="line">    	<span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;getValidators() <span class="keyword">as</span> $validator) &#123;</div><div class="line">        	<span class="keyword">if</span> (! $includingMethod &amp;&amp; $validator <span class="keyword">instanceof</span> MethodValidator) &#123;</div><div class="line">           	 <span class="keyword">continue</span>;</div><div class="line">       	 &#125;</div><div class="line"></div><div class="line">       	 <span class="keyword">if</span> (! $validator-&gt;matches(<span class="keyword">$this</span>, $request)) &#123;</div><div class="line">           	 <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       	 &#125;</div><div class="line">   		 &#125;</div><div class="line"></div><div class="line">   		 <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getValidators</span><span class="params">()</span></span></div><div class="line"><span class="function">	</span>&#123;</div><div class="line">    	<span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">static</span>::$validators)) &#123;</div><div class="line">        	<span class="keyword">return</span> <span class="keyword">static</span>::$validators;</div><div class="line">    	&#125;</div><div class="line"></div><div class="line">    	<span class="keyword">return</span> <span class="keyword">static</span>::$validators = [</div><div class="line">        	<span class="keyword">new</span> UriValidator, <span class="keyword">new</span> MethodValidator,</div><div class="line">        	<span class="keyword">new</span> SchemeValidator, <span class="keyword">new</span> HostValidator,</div><div class="line">    	];</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="UriValidator-uri-验证"><a href="#UriValidator-uri-验证" class="headerlink" title="UriValidator uri 验证"></a>UriValidator uri 验证</h2><p><code>UriValidator</code> 验证主要是目的是查看路由正则与请求是否匹配：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UriValidator</span> <span class="keyword">implements</span> <span class="title">ValidatorInterface</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">matches</span><span class="params">(Route $route, Request $request)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $path = $request-&gt;path() == <span class="string">'/'</span> ? <span class="string">'/'</span> : <span class="string">'/'</span>.$request-&gt;path();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> preg_match($route-&gt;getCompiled()-&gt;getRegex(), rawurldecode($path));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>值得注意的是，在匹配路径之前，程序使用了 <code>rawurldecode</code> 来对请求进行解码。</p>
<h2 id="MethodValidator-验证"><a href="#MethodValidator-验证" class="headerlink" title="MethodValidator 验证"></a>MethodValidator 验证</h2><p>请求方法验证：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MethodValidator</span> <span class="keyword">implements</span> <span class="title">ValidatorInterface</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">matches</span><span class="params">(Route $route, Request $request)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> in_array($request-&gt;getMethod(), $route-&gt;methods());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="SchemeValidator-验证"><a href="#SchemeValidator-验证" class="headerlink" title="SchemeValidator 验证"></a>SchemeValidator 验证</h2><p>路由 <code>scheme</code> 协议验证：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SchemeValidator</span> <span class="keyword">implements</span> <span class="title">ValidatorInterface</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">matches</span><span class="params">(Route $route, Request $request)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> ($route-&gt;httpOnly()) &#123;</div><div class="line">            <span class="keyword">return</span> ! $request-&gt;secure();</div><div class="line">        &#125; <span class="keyword">elseif</span> ($route-&gt;secure()) &#123;</div><div class="line">            <span class="keyword">return</span> $request-&gt;secure();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">httpOnly</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> in_array(<span class="string">'http'</span>, <span class="keyword">$this</span>-&gt;action, <span class="keyword">true</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">secure</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> in_array(<span class="string">'https'</span>, <span class="keyword">$this</span>-&gt;action, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="HostValidator-验证"><a href="#HostValidator-验证" class="headerlink" title="HostValidator 验证"></a>HostValidator 验证</h2><p>主域验证：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HostValidator</span> <span class="keyword">implements</span> <span class="title">ValidatorInterface</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">matches</span><span class="params">(Route $route, Request $request)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (is_null($route-&gt;getCompiled()-&gt;getHostRegex())) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> preg_match($route-&gt;getCompiled()-&gt;getHostRegex(), $request-&gt;getHost());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>也就是说，如果路由中并不设置 <code>host</code> 属性，那么这个验证并不进行。</p>
<h1 id="路由的参数绑定"><a href="#路由的参数绑定" class="headerlink" title="路由的参数绑定"></a>路由的参数绑定</h1><p>一旦某个路由符合请求的 <code>uri</code> 四项认证，就将会被返回，接下来就要对路由的参数进行绑定与赋值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteCollection</span> <span class="keyword">implements</span> <span class="title">Countable</span>, <span class="title">IteratorAggregate</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span><span class="params">(Request $request)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;compileRoute();</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;parameters = (<span class="keyword">new</span> RouteParameterBinder(<span class="keyword">$this</span>))</div><div class="line">                        -&gt;parameters($request);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>bind</code> 函数负责路由参数与请求 <code>url</code> 的绑定工作:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteParameterBinder</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parameters</span><span class="params">($request)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $parameters = <span class="keyword">$this</span>-&gt;bindPathParameters($request);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (! is_null(<span class="keyword">$this</span>-&gt;route-&gt;compiled-&gt;getHostRegex())) &#123;</div><div class="line">            $parameters = <span class="keyword">$this</span>-&gt;bindHostParameters(</div><div class="line">                $request, $parameters</div><div class="line">            );</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;replaceDefaults($parameters);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，路由参数绑定分为主域参数绑定与路径参数绑定，我们先看路径参数绑定：</p>
<h2 id="路径参数绑定"><a href="#路径参数绑定" class="headerlink" title="路径参数绑定"></a>路径参数绑定</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteParameterBinder</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">bindPathParameters</span><span class="params">($request)</span></span></div><div class="line"><span class="function">	</span>&#123;</div><div class="line">  		  preg_match(<span class="keyword">$this</span>-&gt;route-&gt;compiled-&gt;getRegex(), <span class="string">'/'</span>.$request-&gt;decodedPath(), $matches);</div><div class="line"></div><div class="line">  	 	 <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;matchToKeys(array_slice($matches, <span class="number">1</span>));</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>例如，<code>{foo}/{baz?}.{ext?}</code> 进行正则编译后结果：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#^/(?P&lt;foo&gt;[^/]++)(?:/(?P&lt;baz&gt;[^/\.]++)(?:\.(?P&lt;ext&gt;[^/]++))?)?$#s</span></div></pre></td></tr></table></figure>
<p>其与 <code>request</code> 匹配后的结果为： </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$matches = <span class="keyword">array</span> (</div><div class="line">    <span class="number">0</span>   = <span class="string">"/foo/baz.ext"</span>,</div><div class="line">    <span class="number">1</span>   = <span class="string">"foo"</span>,</div><div class="line">    foo = <span class="string">"foo"</span>,</div><div class="line">    <span class="number">2</span>   = <span class="string">"baz"</span>,</div><div class="line">    baz = <span class="string">"baz"</span>,</div><div class="line">    <span class="number">3</span>   = <span class="string">"ext"</span>,</div><div class="line">    ext = <span class="string">"ext"</span>,</div><div class="line">)</div></pre></td></tr></table></figure>
<p><code>array_slice($matches, 1)</code> 取出了 <code>$matches</code> 数组 1 之后的结果，然后调用了 <code>matchToKeys</code> 函数，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">matchToKeys</span><span class="params">(array $matches)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">	 <span class="keyword">if</span> (<span class="keyword">empty</span>($parameterNames = <span class="keyword">$this</span>-&gt;route-&gt;parameterNames())) &#123;</div><div class="line">  		  <span class="keyword">return</span> [];</div><div class="line">	 &#125;</div><div class="line"></div><div class="line">	$parameters = array_intersect_key($matches, array_flip($parameterNames));</div><div class="line"></div><div class="line">	<span class="keyword">return</span> array_filter($parameters, <span class="function"><span class="keyword">function</span> <span class="params">($value)</span> </span>&#123;</div><div class="line">   		 <span class="keyword">return</span> is_string($value) &amp;&amp; strlen($value) &gt; <span class="number">0</span>;</div><div class="line">	 &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该函数中利用正则获取了路由的所有参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Route</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parameterNames</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;parameterNames)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;parameterNames;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;parameterNames = <span class="keyword">$this</span>-&gt;compileParameterNames();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileParameterNames</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        preg_match_all(<span class="string">'/\&#123;(.*?)\&#125;/'</span>, <span class="keyword">$this</span>-&gt;domain().<span class="keyword">$this</span>-&gt;uri, $matches);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> array_map(<span class="function"><span class="keyword">function</span> <span class="params">($m)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> trim($m, <span class="string">'?'</span>);</div><div class="line">        &#125;, $matches[<span class="number">1</span>]);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，获取路由参数的正则表达式采用了勉强模式，意图提取出所有的路由参数。否则，对于路由 <code>{foo}/{baz?}.{ext?}</code>,贪婪型正则表达式 <code>/\{(.*)\}/</code> 将会匹配整个字符串，而不是各个参数分组。</p>
<p>提取出的参数结果为： </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$matches = <span class="keyword">array</span> (</div><div class="line">	<span class="number">0</span> = <span class="keyword">array</span> (</div><div class="line">		<span class="number">0</span> = <span class="string">"&#123;foo&#125;"</span>.</div><div class="line">		<span class="number">1</span> = <span class="string">"&#123;baz?&#125;"</span>,</div><div class="line">		<span class="number">2</span> = <span class="string">"&#123;ext?&#125;"</span>,</div><div class="line">	)</div><div class="line">	<span class="number">1</span> = <span class="keyword">array</span> (</div><div class="line">		<span class="number">0</span> = <span class="string">"foo"</span>.</div><div class="line">		<span class="number">1</span> = <span class="string">"baz?"</span>,</div><div class="line">		<span class="number">2</span> = <span class="string">"ext?"</span>,</div><div class="line">	)</div><div class="line">)</div></pre></td></tr></table></figure>
<p>得出的结果将会去除 <code>$matches[1]</code>，并且将会删除结果中最后的 <code>?</code>。</p>
<p>之后，在 <code>matchToKeys</code> 函数中，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$parameters = array_intersect_key($matches, array_flip($parameterNames));</div></pre></td></tr></table></figure>
<p>获取了匹配结果与路由所有参数的交集：</p>
 <figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$parameters = <span class="keyword">array</span> (</div><div class="line">   foo = <span class="string">"foo"</span>,</div><div class="line">   baz = <span class="string">"baz"</span>,</div><div class="line">   ext = <span class="string">"ext"</span>,</div><div class="line">)</div></pre></td></tr></table></figure>
<h2 id="主域参数绑定"><a href="#主域参数绑定" class="headerlink" title="主域参数绑定"></a>主域参数绑定</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">bindHostParameters</span><span class="params">($request, $parameters)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    preg_match(<span class="keyword">$this</span>-&gt;route-&gt;compiled-&gt;getHostRegex(), $request-&gt;getHost(), $matches);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> array_merge(<span class="keyword">$this</span>-&gt;matchToKeys(array_slice($matches, <span class="number">1</span>)), $parameters);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>步骤与路由参数绑定一致。</p>
<h2 id="替换默认值"><a href="#替换默认值" class="headerlink" title="替换默认值"></a>替换默认值</h2><p>进行参数绑定后，有一些可选参数并没有在 <code>request</code> 中匹配到，这时候就要用可选参数的默认值添加到变量 <code>parameters</code> 中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">replaceDefaults</span><span class="params">(array $parameters)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">foreach</span> ($parameters <span class="keyword">as</span> $key =&gt; $value) &#123;</div><div class="line">        $parameters[$key] = <span class="keyword">isset</span>($value) ? $value : Arr::get(<span class="keyword">$this</span>-&gt;route-&gt;defaults, $key);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;route-&gt;defaults <span class="keyword">as</span> $key =&gt; $value) &#123;</div><div class="line">        <span class="keyword">if</span> (! <span class="keyword">isset</span>($parameters[$key])) &#123;</div><div class="line">            $parameters[$key] = $value;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $parameters;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="匹配异常处理"><a href="#匹配异常处理" class="headerlink" title="匹配异常处理"></a>匹配异常处理</h1><p>如果 <code>url</code> 匹配失败，没有找到任何路由与请求相互匹配，就会切换 <code>method</code> 方法，以求任意路由来匹配：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">checkForAlternateVerbs</span><span class="params">($request)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $methods = array_diff(Router::$verbs, [$request-&gt;getMethod()]);</div><div class="line"></div><div class="line">    $others = [];</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> ($methods <span class="keyword">as</span> $method) &#123;</div><div class="line">        <span class="keyword">if</span> (! is_null(<span class="keyword">$this</span>-&gt;matchAgainstRoutes(<span class="keyword">$this</span>-&gt;get($method), $request, <span class="keyword">false</span>))) &#123;</div><div class="line">            $others[] = $method;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $others;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果使用其他方法匹配成功，就要判断当前方法是否是 <code>options</code>，如果是则直接返回，否则报出异常：    </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRouteForMethods</span><span class="params">($request, array $methods)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> ($request-&gt;method() == <span class="string">'OPTIONS'</span>) &#123;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> Route(<span class="string">'OPTIONS'</span>, $request-&gt;path(), <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($methods)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Response(<span class="string">''</span>, <span class="number">200</span>, [<span class="string">'Allow'</span> =&gt; implode(<span class="string">','</span>, $methods)]);</div><div class="line">        &#125;))-&gt;bind($request);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;methodNotAllowed($methods);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">methodNotAllowed</span><span class="params">(array $others)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> MethodNotAllowedHttpException($others);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/07/24/Laravel Http——路由的正则编译/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/24/Laravel Http——路由的正则编译/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T17:05:10+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/24/Laravel Http——路由的正则编译/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/24/Laravel Http——路由的正则编译/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/24/Laravel Http——路由的正则编译/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>利用 <code>pipeline</code> 进行中间件的层层处理后，接下来 <code>laravel</code> 就会利用请求的 <code>url</code> 来寻找与其对应的路由，<code>laravel</code> 采用对路由注册的 <code>uri</code> 进行正则编译，然后利用 <code>request</code> 的 <code>url</code> 进行正则匹配来寻找正确的路由。</p>
<h1 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h1><p>在上一篇文章中，我们了解了 <code>Pipeline</code> 的原理，我们知道它调用了 <code>dispatchToRouter()</code> 这个函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequestThroughRouter</span><span class="params">($request)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</div><div class="line"></div><div class="line">    Facade::clearResolvedInstance(<span class="string">'request'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;bootstrap();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline(<span class="keyword">$this</span>-&gt;app))</div><div class="line">                -&gt;send($request)</div><div class="line">                -&gt;through(<span class="keyword">$this</span>-&gt;app-&gt;shouldSkipMiddleware() ? [] : <span class="keyword">$this</span>-&gt;middleware)</div><div class="line">                -&gt;then(<span class="keyword">$this</span>-&gt;dispatchToRouter());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRouter</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($request)</span> </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;router-&gt;dispatch($request);</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个函数实际上利用的是 <code>Router</code> 的 <code>dispatch</code>,这个函数的任务是进行路由匹配，并且调用路由绑定的控制器或者闭包函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span> <span class="keyword">implements</span> <span class="title">RegistrarContract</span>, <span class="title">BindingRegistrar</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">(Request $request)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;currentRequest = $request;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dispatchToRoute($request);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRoute</span><span class="params">(Request $request)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $route = <span class="keyword">$this</span>-&gt;findRoute($request);</div><div class="line"></div><div class="line">        $request-&gt;setRouteResolver(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($route)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> $route;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;events-&gt;dispatch(<span class="keyword">new</span> Events\RouteMatched($route, $request));</div><div class="line"></div><div class="line">        $response = <span class="keyword">$this</span>-&gt;runRouteWithinStack($route, $request);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;prepareResponse($request, $response);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们这篇文章就是讲解第一句: <code>findRoute()</code> 路由匹配:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">findRoute</span><span class="params">($request)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;current = $route = <span class="keyword">$this</span>-&gt;routes-&gt;match($request);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;container-&gt;instance(Route::class, $route);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $route;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>寻找路由的任务由 <code>RouteCollection</code> 负责，这个函数负责匹配路由，并且把 <code>request</code> 的 <code>url</code> 参数绑定到路由中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteCollection</span> <span class="keyword">implements</span> <span class="title">Countable</span>, <span class="title">IteratorAggregate</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">match</span><span class="params">(Request $request)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $routes = <span class="keyword">$this</span>-&gt;get($request-&gt;getMethod());</div><div class="line"></div><div class="line">        $route = <span class="keyword">$this</span>-&gt;matchAgainstRoutes($routes, $request);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (! is_null($route)) &#123;</div><div class="line">            <span class="keyword">return</span> $route-&gt;bind($request);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $others = <span class="keyword">$this</span>-&gt;checkForAlternateVerbs($request);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (count($others) &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getRouteForMethods($request, $others);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotFoundHttpException;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">matchAgainstRoutes</span><span class="params">(array $routes, $request, $includingMethod = true)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> Arr::first($routes, <span class="function"><span class="keyword">function</span> <span class="params">($value)</span> <span class="title">use</span> <span class="params">($request, $includingMethod)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> $value-&gt;matches($request, $includingMethod);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="路由正则匹配"><a href="#路由正则匹配" class="headerlink" title="路由正则匹配"></a>路由正则匹配</h1><p>如何去寻找请求 <code>request</code> 想要调用的路由呢？ <code>laravel</code> 首先对路由进行正则编译，得到路由的正则匹配串，然后利用请求的 <code>url</code> 尝试去匹配，如果匹配成功，那么就会选定该路由：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Route</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">matches</span><span class="params">(Request $request, $includingMethod = true)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;compileRoute();</div><div class="line"></div><div class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;getValidators() <span class="keyword">as</span> $validator) &#123;</div><div class="line">            <span class="keyword">if</span> (! $includingMethod &amp;&amp; $validator <span class="keyword">instanceof</span> MethodValidator) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (! $validator-&gt;matches(<span class="keyword">$this</span>, $request)) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileRoute</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;compiled) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;compiled = (<span class="keyword">new</span> RouteCompiler(<span class="keyword">$this</span>))-&gt;compile();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;compiled;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，路由的正则编译由 <code>RouteCompiler</code> 类专门负责：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteCompiler</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($route)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;route = $route;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">compile</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $optionals = <span class="keyword">$this</span>-&gt;getOptionalParameters();</div><div class="line"></div><div class="line">        $uri = preg_replace(<span class="string">'/\&#123;(\w+?)\?\&#125;/'</span>, <span class="string">'&#123;$1&#125;'</span>, <span class="keyword">$this</span>-&gt;route-&gt;uri());</div><div class="line"></div><div class="line">        <span class="keyword">return</span> (</div><div class="line">            <span class="keyword">new</span> SymfonyRoute($uri, $optionals, <span class="keyword">$this</span>-&gt;route-&gt;wheres, [], <span class="keyword">$this</span>-&gt;route-&gt;domain() ?: <span class="string">''</span>)</div><div class="line">        )-&gt;compile();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出， <code>laravel</code> 真正的正则编译是重用 <code>symfony</code> 框架的，但是在利用 <code>symfony</code> 进行正则编译之前，<code>laravel</code> 先对路由的 <code>uri</code> 进行了一些处理，以适应 <code>symfony</code> 的要求。</p>
<h2 id="路由可选参数转换"><a href="#路由可选参数转换" class="headerlink" title="路由可选参数转换"></a>路由可选参数转换</h2><p>对于 <code>laravel</code> 来说，可以选择某个路由 <code>url</code> 的参数是可选的，通常来说，这种可选参数都有默认值。 <code>laravel</code> 利用 <code>?</code> 来表示可选参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$router-&gt;get(<span class="string">'&#123;foo?&#125;/&#123;baz?&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($name = <span class="string">'taylor'</span>, $age = <span class="number">25</span>)</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> $name.$age;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>但是对于 <code>symfony</code> 来说， <code>?</code> 没有任何特殊意义， <code>symfony</code> 利用 <code>SymfonyRoute</code> 类进行路由初始化，并把第二个参数作为可选参数，因此 <code>laravel</code> 需要把可选参数提取出来，然后赋给 <code>SymfonyRoute</code> 构造函数。</p>
<p>可选参数的提取由 <code>getOptionalParameters</code> 负责：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getOptionalParameters</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    preg_match_all(<span class="string">'/\&#123;(\w+?)\?\&#125;/'</span>, <span class="keyword">$this</span>-&gt;route-&gt;uri(), $matches);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">isset</span>($matches[<span class="number">1</span>]) ? array_fill_keys($matches[<span class="number">1</span>], <span class="keyword">null</span>) : [];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p> <code>preg_match_all</code> 函数用于进行正则表达式全局匹配，成功返回整个模式匹配的次数（可能为零），如果出错返回 FALSE。 </p>
<p>默认排序方式为 <code>PREG_PATTERN_ORDER</code>,结果排序为 <code>$matches[0]</code> 保存完整模式的所有匹配, <code>$matches[1]</code> 保存第一个子组的所有匹配，以此类推。</p>
<p>若排序方式为 <code>PREG_SET_ORDER</code>,结果排序为 <code>$matches[0]</code> 包含第一次匹配得到的所有匹配(包含子组)， <code>$matches[1]</code> 是包含第二次匹配到的所有匹配(包含子组)的数组，以此类推。</p>
</blockquote>
<p>以 <code>{foo?}/{baz?}</code> 为例，得到的 <code>matches[0]</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">matches[<span class="number">0</span>] = <span class="keyword">array</span> (</div><div class="line">    <span class="number">0</span> = <span class="string">'&#123;foo?&#125;'</span>,</div><div class="line">    <span class="number">1</span> = <span class="string">'&#123;baz?&#125;'</span>,</div><div class="line">)</div></pre></td></tr></table></figure>
<p>得到的结果 <code>matches</code> 中 <code>matches[1]</code> 是被匹配上的字符串，以 <code>{foo?}/{baz?}</code> 为例，得到的 <code>matches[1]</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">matches[<span class="number">1</span>] = <span class="keyword">array</span> (</div><div class="line">    <span class="number">0</span> = <span class="string">'foo'</span>,</div><div class="line">    <span class="number">1</span> = <span class="string">'baz'</span>,</div><div class="line">)</div></pre></td></tr></table></figure>
<p><code>array_fill_keys</code> 函数负责使用指定的键和值填充数组，例如上例中就可以得到：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">optionals = <span class="keyword">array</span> (</div><div class="line">    foo = <span class="keyword">null</span>,</div><div class="line">    baz = <span class="keyword">null</span>,</div><div class="line">)</div></pre></td></tr></table></figure>
<p>得到可选参数的数组 <code>optionals</code> 后，就要将路由的 <code>uri</code> 中 <code>?</code> 替换掉，这也就是 <code>preg_replace</code> 的作用，以 <code>{foo?}/{baz?}</code> 为例，最后得到的替换结果为 <code>{foo}/{baz}</code>。</p>
<h2 id="Symfony-路由初始化"><a href="#Symfony-路由初始化" class="headerlink" title="Symfony 路由初始化"></a>Symfony 路由初始化</h2><p>在 <code>symfony</code> 的路由初始化中，由很多参数：</p>
<ul>
<li>path 是路由的 <code>uri</code></li>
<li>defaults 是路由可选参数</li>
<li>requirements 是路由的参数正则约束</li>
<li>options 路由的选项参数，例如路由正则编译类等</li>
<li>host 是路由的主域</li>
<li>schenes 是 web 的协议，例如 http, https</li>
<li>methods 是调用的方法，例如 <code>get</code>、<code>post</code></li>
<li>condition </li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Routing</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Route</span> <span class="keyword">implements</span> \<span class="title">Serializable</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path, array $defaults = array<span class="params">()</span>, array $requirements = array<span class="params">()</span>, array $options = array<span class="params">()</span>, $host = <span class="string">''</span>, $schemes = array<span class="params">()</span>, $methods = array<span class="params">()</span>, $condition = <span class="string">''</span>)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;setPath($path);</div><div class="line">        <span class="keyword">$this</span>-&gt;setDefaults($defaults);</div><div class="line">        <span class="keyword">$this</span>-&gt;setRequirements($requirements);</div><div class="line">        <span class="keyword">$this</span>-&gt;setOptions($options);</div><div class="line">        <span class="keyword">$this</span>-&gt;setHost($host);</div><div class="line">        <span class="keyword">$this</span>-&gt;setSchemes($schemes);</div><div class="line">        <span class="keyword">$this</span>-&gt;setMethods($methods);</div><div class="line">        <span class="keyword">$this</span>-&gt;setCondition($condition);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setOptions</span><span class="params">(array $options)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;options = <span class="keyword">array</span>(</div><div class="line">            <span class="string">'compiler_class'</span> =&gt; <span class="string">'Symfony\\Component\\Routing\\RouteCompiler'</span>,</div><div class="line">        );</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;addOptions($options);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出， <code>laravel</code> 初始化路由的时候，分别初始化了 <code>path</code>、<code>defaults</code>、<code>requirements</code>、<code>host</code>，其余都是默认值。其中 <code>host</code> 是路由的 <code>domain</code> 去除 <code>http</code>、<code>https</code> 之后的主域。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">domain</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;action[<span class="string">'domain'</span>])</div><div class="line">            ? str_replace([<span class="string">'http://'</span>, <span class="string">'https://'</span>], <span class="string">''</span>, <span class="keyword">$this</span>-&gt;action[<span class="string">'domain'</span>]) : <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="路由的正则编译"><a href="#路由的正则编译" class="headerlink" title="路由的正则编译"></a>路由的正则编译</h2><p>路由的编译由 <code>symfony</code> 的 <code>route</code> 类完成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">compile</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> !== <span class="keyword">$this</span>-&gt;compiled) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;compiled;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $class = <span class="keyword">$this</span>-&gt;getOption(<span class="string">'compiler_class'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;compiled = $class::compile(<span class="keyword">$this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>compiler_class</code> 是初始化的时候提供的类 <code>Symfony\\Component\\Routing\\RouteCompiler</code>.</p>
<p>下面是就是路由编译的主要功能实现：</p>
<h3 id="compile-函数"><a href="#compile-函数" class="headerlink" title="compile 函数"></a>compile 函数</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Routing</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteCompiler</span> <span class="keyword">implements</span> <span class="title">RouteCompilerInterface</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">compile</span><span class="params">(Route $route)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $hostVariables = <span class="keyword">array</span>();</div><div class="line">        $variables = <span class="keyword">array</span>();</div><div class="line">        $hostRegex = <span class="keyword">null</span>;</div><div class="line">        $hostTokens = <span class="keyword">array</span>();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="string">''</span> !== $host = $route-&gt;getHost()) &#123;</div><div class="line">            $result = <span class="keyword">self</span>::compilePattern($route, $host, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">            $hostVariables = $result[<span class="string">'variables'</span>];</div><div class="line">            $variables = $hostVariables;</div><div class="line"></div><div class="line">            $hostTokens = $result[<span class="string">'tokens'</span>];</div><div class="line">            $hostRegex = $result[<span class="string">'regex'</span>];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $path = $route-&gt;getPath();</div><div class="line"></div><div class="line">        $result = <span class="keyword">self</span>::compilePattern($route, $path, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">        $staticPrefix = $result[<span class="string">'staticPrefix'</span>];</div><div class="line"></div><div class="line">        $pathVariables = $result[<span class="string">'variables'</span>];</div><div class="line"></div><div class="line">        <span class="keyword">foreach</span> ($pathVariables <span class="keyword">as</span> $pathParam) &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="string">'_fragment'</span> === $pathParam) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> \InvalidArgumentException(sprintf(<span class="string">'Route pattern "%s" cannot contain "_fragment" as a path parameter.'</span>, $route-&gt;getPath()));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $variables = array_merge($variables, $pathVariables);</div><div class="line"></div><div class="line">        $tokens = $result[<span class="string">'tokens'</span>];</div><div class="line">        $regex = $result[<span class="string">'regex'</span>];</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CompiledRoute(</div><div class="line">            $staticPrefix,</div><div class="line">            $regex,</div><div class="line">            $tokens,</div><div class="line">            $pathVariables,</div><div class="line">            $hostRegex,</div><div class="line">            $hostTokens,</div><div class="line">            $hostVariables,</div><div class="line">            array_unique($variables)</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，路由的正则编译由两个部分构成：主域的正则编译与 <code>uri</code> 的正则编译。这两个部分的编译功能由函数 <code>compilePattern</code> 负责，这个函数会有返回三种数据结果，以 <code>/foo/{bar}</code> 为例： </p>
<ul>
<li><code>variables</code> 代表正则匹配的路由参数,如 <code>bar</code></li>
<li><code>tokens</code> 代表正则匹配的普通路由字符串,如 <code>foo</code></li>
<li><code>regex</code> 代表路由匹配的正则表达式结果</li>
<li>有时候也会有 <code>$staticPrefix</code>,这个是路由 <code>url</code> 前没有路由参数的字符串前缀，如 <code>/foo/</code>.</li>
</ul>
<h3 id="compilePattern-函数"><a href="#compilePattern-函数" class="headerlink" title="compilePattern 函数"></a>compilePattern 函数</h3><p>由于 <code>symfony</code> 原始的正则编译稍微复杂，本文剔除了一些处理 <code>utf8</code> 和异常处理的代码，特意挑选计算正则表达式的主干代码，如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">compilePattern</span><span class="params">(Route $route, $pattern, $isHost)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">       $tokens = <span class="keyword">array</span>();</div><div class="line">       $variables = <span class="keyword">array</span>();</div><div class="line">       $matches = <span class="keyword">array</span>();</div><div class="line">       $pos = <span class="number">0</span>;</div><div class="line">       $defaultSeparator = $isHost ? <span class="string">'.'</span> : <span class="string">'/'</span>;</div><div class="line">      </div><div class="line">       preg_match_all(<span class="string">'#\&#123;\w+\&#125;#'</span>, $pattern, $matches, PREG_OFFSET_CAPTURE | PREG_SET_ORDER);</div><div class="line">       <span class="keyword">foreach</span> ($matches <span class="keyword">as</span> $match) &#123;</div><div class="line">           $varName = substr($match[<span class="number">0</span>][<span class="number">0</span>], <span class="number">1</span>, <span class="number">-1</span>);</div><div class="line">           $precedingText = substr($pattern, $pos, $match[<span class="number">0</span>][<span class="number">1</span>] - $pos);</div><div class="line">           $pos = $match[<span class="number">0</span>][<span class="number">1</span>] + strlen($match[<span class="number">0</span>][<span class="number">0</span>]);</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (!strlen($precedingText)) &#123;</div><div class="line">               $precedingChar = <span class="string">''</span>;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               $precedingChar = substr($precedingText, <span class="number">-1</span>);</div><div class="line">           &#125;</div><div class="line">           $isSeparator = <span class="string">''</span> !== $precedingChar &amp;&amp; <span class="keyword">false</span> !== strpos(<span class="keyword">static</span>::SEPARATORS, $precedingChar);</div><div class="line"></div><div class="line">           <span class="keyword">if</span> ($isSeparator &amp;&amp; $precedingText !== $precedingChar) &#123;</div><div class="line">               $tokens[] = <span class="keyword">array</span>(<span class="string">'text'</span>, substr($precedingText, <span class="number">0</span>, -strlen($precedingChar)));</div><div class="line">           &#125; <span class="keyword">elseif</span> (!$isSeparator &amp;&amp; strlen($precedingText) &gt; <span class="number">0</span>) &#123;</div><div class="line">               $tokens[] = <span class="keyword">array</span>(<span class="string">'text'</span>, $precedingText);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           $regexp = $route-&gt;getRequirement($varName);</div><div class="line">           <span class="keyword">if</span> (<span class="keyword">null</span> === $regexp) &#123;</div><div class="line">               $followingPattern = (string) substr($pattern, $pos);</div><div class="line">               </div><div class="line">               $nextSeparator = <span class="keyword">self</span>::findNextSeparator($followingPattern, $useUtf8);</div><div class="line">               $regexp = sprintf(</div><div class="line">                   <span class="string">'[^%s%s]+'</span>,</div><div class="line">                   preg_quote($defaultSeparator, <span class="keyword">self</span>::REGEX_DELIMITER),</div><div class="line">                   $defaultSeparator !== $nextSeparator &amp;&amp; <span class="string">''</span> !== $nextSeparator ? preg_quote($nextSeparator, <span class="keyword">self</span>::REGEX_DELIMITER) : <span class="string">''</span></div><div class="line">               );</div><div class="line">               <span class="keyword">if</span> ((<span class="string">''</span> !== $nextSeparator &amp;&amp; !preg_match(<span class="string">'#^\&#123;\w+\&#125;#'</span>, $followingPattern)) || <span class="string">''</span> === $followingPattern) &#123;</div><div class="line">                   $regexp .= <span class="string">'+'</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           $tokens[] = <span class="keyword">array</span>(<span class="string">'variable'</span>, $isSeparator ? $precedingChar : <span class="string">''</span>, $regexp, $varName);</div><div class="line">           $variables[] = $varName;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> ($pos &lt; strlen($pattern)) &#123;</div><div class="line">           $tokens[] = <span class="keyword">array</span>(<span class="string">'text'</span>, substr($pattern, $pos));</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// find the first optional token</span></div><div class="line">       $firstOptional = PHP_INT_MAX;</div><div class="line">       <span class="keyword">if</span> (!$isHost) &#123;</div><div class="line">           <span class="keyword">for</span> ($i = count($tokens) - <span class="number">1</span>; $i &gt;= <span class="number">0</span>; --$i) &#123;</div><div class="line">               $token = $tokens[$i];</div><div class="line">               <span class="keyword">if</span> (<span class="string">'variable'</span> === $token[<span class="number">0</span>] &amp;&amp; $route-&gt;hasDefault($token[<span class="number">3</span>])) &#123;</div><div class="line">                   $firstOptional = $i;</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// compute the matching regexp</span></div><div class="line">       $regexp = <span class="string">''</span>;</div><div class="line">       <span class="keyword">for</span> ($i = <span class="number">0</span>, $nbToken = count($tokens); $i &lt; $nbToken; ++$i) &#123;</div><div class="line">           $regexp .= <span class="keyword">self</span>::computeRegexp($tokens, $i, $firstOptional);</div><div class="line">       &#125;</div><div class="line">       $regexp = <span class="keyword">self</span>::REGEX_DELIMITER.<span class="string">'^'</span>.$regexp.<span class="string">'$'</span>.<span class="keyword">self</span>::REGEX_DELIMITER.<span class="string">'s'</span>.($isHost ? <span class="string">'i'</span> : <span class="string">''</span>);</div><div class="line"></div><div class="line">       <span class="keyword">return</span> <span class="keyword">array</span>(</div><div class="line">           <span class="string">'staticPrefix'</span> =&gt; <span class="string">'text'</span> === $tokens[<span class="number">0</span>][<span class="number">0</span>] ? $tokens[<span class="number">0</span>][<span class="number">1</span>] : <span class="string">''</span>,</div><div class="line">           <span class="string">'regex'</span> =&gt; $regexp,</div><div class="line">           <span class="string">'tokens'</span> =&gt; array_reverse($tokens),</div><div class="line">           <span class="string">'variables'</span> =&gt; $variables,</div><div class="line">       );</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>下面本文将以 <code>prefix/{foo}/{baz}.{ext}/tail</code> 为例，来详细讲一下路由 <code>uri</code> 的正则编译过程。</p>
<h3 id="preg-match-all-全匹配"><a href="#preg-match-all-全匹配" class="headerlink" title="preg_match_all 全匹配"></a><code>preg_match_all</code> 全匹配</h3><p>由于 <code>preg_match_all</code> 使用了 <code>PREG_SET_ORDER</code>,因此结果数组 <code>matches</code> 中每一个元素都是一次匹配的结果，本例中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">$matches = <span class="keyword">array</span> (</div><div class="line">	<span class="number">0</span> = <span class="keyword">array</span> (</div><div class="line">		<span class="number">0</span> = <span class="keyword">array</span> (</div><div class="line">			<span class="number">0</span> = <span class="string">"&#123;foo&#125;"</span>,</div><div class="line">			<span class="number">1</span> = <span class="number">8</span></div><div class="line">		)</div><div class="line">	)</div><div class="line">    <span class="number">1</span> = <span class="keyword">array</span> (</div><div class="line">		<span class="number">0</span> = <span class="keyword">array</span> (</div><div class="line">			<span class="number">0</span> = <span class="string">"&#123;baz&#125;"</span>,</div><div class="line">			<span class="number">1</span> = <span class="number">14</span></div><div class="line">		)</div><div class="line">	)</div><div class="line">	<span class="number">2</span> = <span class="keyword">array</span> (</div><div class="line">		<span class="number">0</span> = <span class="keyword">array</span> (</div><div class="line">			<span class="number">0</span> = <span class="string">"&#123;ext&#125;"</span>,</div><div class="line">			<span class="number">1</span> = <span class="number">20</span></div><div class="line">		)</div><div class="line">	)</div><div class="line">)</div></pre></td></tr></table></figure>
<p>接下来，程序会用循环来分别处理各个匹配的结果。</p>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>每个匹配结果都会先计算变量: <code>varName</code>、<code>precedingText</code>、<code>precedingChar</code>、<code>isSeparator</code></p>
<ul>
<li><code>varName</code> 匹配结果会将路由参数提取出来，本例中：<code>foo</code>、<code>baz</code>、<code>ext</code></li>
<li><code>precedingText</code> 是两个路由参数之间的字符串，本例中：<code>prefix/</code>、<code>/</code>、<code>.</code></li>
<li><code>precedingChar</code> 是每个路由参数之前的字符，也就是 <code>precedingText</code> 的最后一个字符,本例中：<code>/</code>、<code>/</code>、<code>.</code></li>
<li><code>isSeparator</code> 判断 <code>precedingChar</code> 是否是 <code>url</code> 的间隔符，本例中：<code>true</code>、<code>true</code>、<code>true</code></li>
</ul>
<h3 id="tokens-text"><a href="#tokens-text" class="headerlink" title="tokens-text"></a>tokens-text</h3><p>将 <code>precedingText</code> 记录进 <code>tokens</code> 数组，key 为 <code>text</code>。<br>第一次循环，tokens：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">tokens = <span class="keyword">array</span> (</div><div class="line">	<span class="number">0</span> = text,</div><div class="line">	<span class="number">1</span> = prefix,</div><div class="line">)</div></pre></td></tr></table></figure>
<p>第二次循环与第三次循环由于 <code>precedingText</code> == <code>precedingChar</code>，所以并不会记录。</p>
<h3 id="构建-regexp"><a href="#构建-regexp" class="headerlink" title="构建 regexp"></a>构建 regexp</h3><p>若在路由定义的过程中利用 <code>where</code> 属性或者 <code>pattern</code> 为路由的参数设置正则约束，那么此时就会将约束规则赋给 <code>regexp</code>，否则就会启用构建 <code>regexp</code> 的过程：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$followingPattern = (string) substr($pattern, $pos);</div><div class="line">$nextSeparator = <span class="keyword">self</span>::findNextSeparator($followingPattern, $useUtf8);</div><div class="line"></div><div class="line">$regexp = sprintf(</div><div class="line">            <span class="string">'[^%s%s]+'</span>,</div><div class="line">            preg_quote($defaultSeparator, <span class="keyword">self</span>::REGEX_DELIMITER),</div><div class="line">            $defaultSeparator !== $nextSeparator &amp;&amp; <span class="string">''</span> !== $nextSeparator ? preg_quote($nextSeparator, <span class="keyword">self</span>::REGEX_DELIMITER) : <span class="string">''</span></div><div class="line">);</div><div class="line"></div><div class="line"><span class="keyword">if</span> ((<span class="string">''</span> !== $nextSeparator &amp;&amp; !preg_match(<span class="string">'#^\&#123;\w+\&#125;#'</span>, $followingPattern)) || <span class="string">''</span> === $followingPattern) &#123;    </div><div class="line">    $regexp .= <span class="string">'+'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>构建  <code>regexp</code> 有两个部分，</p>
<ul>
<li>寻找 <code>nextSeparator</code> ：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">findNextSeparator</span><span class="params">($pattern, $useUtf8)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="string">''</span> == $pattern) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">''</span>;</div><div class="line">    &#125;</div><div class="line">       </div><div class="line">    <span class="keyword">if</span> (<span class="string">''</span> === $pattern = preg_replace(<span class="string">'#\&#123;\w+\&#125;#'</span>, <span class="string">''</span>, $pattern)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">''</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span> !== strpos(<span class="keyword">static</span>::SEPARATORS, $pattern[<span class="number">0</span>]) ? $pattern[<span class="number">0</span>] : <span class="string">''</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个函数的意义在于为路由的 <code>uri</code> 的路由参数寻找非默认间隔符，例如，路由可以这样设置 <code>uri</code> ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/&#123;baz&#125;.&#123;ext&#125;/</div></pre></td></tr></table></figure>
<p>默认的间隔符就是 <code>/</code>，如果不设置非默认间隔符的时候，那么 <code>regexp = [^/]</code>，<code>mobile.html</code> 这样的请求就会被 <code>{baz}</code> 这个参数全部匹配到，<code>{ext}</code> 就没有任何参数来对应。设置了非默认间隔符后 <code>regexp = [^/.]</code>, <code>baz</code> 就会匹配 <code>mobile</code>，<code>ext</code> 就会匹配 <code>html</code>。</p>
<ul>
<li>侵占型正则表达式</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ((<span class="string">''</span> !== $nextSeparator &amp;&amp; !preg_match(<span class="string">'#^\&#123;\w+\&#125;#'</span>, $followingPattern)) || <span class="string">''</span> === $followingPattern) &#123;</div><div class="line">    $regexp .= <span class="string">'+'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为了减少贪婪型正则表达式的回溯导致的性能浪费，当后续字符串已经结束或者不存在 <code>/{x}{y}</code> 这样情况的时候，程序将贪婪型正则表达式改为侵占型正则表达式。有关正则表达式的模式请查看：<a href="http://blog.csdn.net/u014762221/article/details/68953155" target="_blank" rel="external">正则表达式之 贪婪与非贪婪模式详解（概述）</a></p>
<h3 id="tokens-variable"><a href="#tokens-variable" class="headerlink" title="tokens-variable"></a>tokens-variable</h3><p>获取路由参数和正则表达式之后，就要更新 <code>tokens</code>,分别将 <code>isSeparator</code>, <code>regexp</code>, <code>varName</code> 更新到结果数组中。</p>
<p>以 <code>prefix/{foo}/{baz}.{ext}/tail</code> 为例，<code>$tokens</code> 在各个循环时值为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">$tokens = <span class="keyword">array</span> (</div><div class="line">	<span class="number">0</span> = <span class="keyword">array</span> (</div><div class="line">		<span class="number">0</span> = ‘text’,</div><div class="line">		<span class="number">1</span> = <span class="string">'/prefix'</span></div><div class="line">	)</div><div class="line">	<span class="number">1</span> = <span class="keyword">array</span> (</div><div class="line">		<span class="number">0</span> = ‘variable’,</div><div class="line">		<span class="number">1</span> = <span class="string">'/'</span>,</div><div class="line">		<span class="number">0</span> = ‘[^/]++’,</div><div class="line">		<span class="number">1</span> = <span class="string">'foo'</span></div><div class="line">	)<span class="comment">//第一次循环结束</span></div><div class="line">	<span class="number">2</span> = <span class="keyword">array</span> (</div><div class="line">		<span class="number">0</span> = ‘variable’,</div><div class="line">		<span class="number">1</span> = <span class="string">'/'</span>,</div><div class="line">		<span class="number">0</span> = ‘[^/\.]++’,</div><div class="line">		<span class="number">1</span> = <span class="string">'baz'</span></div><div class="line">	)<span class="comment">//第二次循环结束</span></div><div class="line">	<span class="number">3</span> = <span class="keyword">array</span> (</div><div class="line">		<span class="number">0</span> = ‘variable’,</div><div class="line">		<span class="number">1</span> = <span class="string">'.'</span>,</div><div class="line">		<span class="number">0</span> = ‘[^/]++’,</div><div class="line">		<span class="number">1</span> = <span class="string">'ext'</span></div><div class="line">	)<span class="comment">//循环结束</span></div><div class="line">	<span class="number">4</span> = <span class="keyword">array</span> (</div><div class="line">		<span class="number">0</span> = ‘text’,</div><div class="line">		<span class="number">1</span> = <span class="string">'/tail'</span></div><div class="line">	)<span class="comment">//	循环外</span></div><div class="line">)</div></pre></td></tr></table></figure>
<h3 id="默认路由参数"><a href="#默认路由参数" class="headerlink" title="默认路由参数"></a>默认路由参数</h3><p>接下来就要计算首个默认路由参数在整个路由 <code>url</code> 的位置，以便在生成正则表达式中使用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$firstOptional = PHP_INT_MAX;</div><div class="line"><span class="keyword">if</span> (!$isHost) &#123;</div><div class="line">    <span class="keyword">for</span> ($i = count($tokens) - <span class="number">1</span>; $i &gt;= <span class="number">0</span>; --$i) &#123;</div><div class="line">        $token = $tokens[$i];</div><div class="line">        <span class="keyword">if</span> (<span class="string">'variable'</span> === $token[<span class="number">0</span>] &amp;&amp; $route-&gt;hasDefault($token[<span class="number">3</span>])) &#123;</div><div class="line">            $firstOptional = $i;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="计算正则表达式"><a href="#计算正则表达式" class="headerlink" title="计算正则表达式"></a>计算正则表达式</h3><p>所有的 <code>tokens</code> 数组都构建完毕，接下来就需要利用这个数组来构建正则表达式了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$regexp = <span class="string">''</span>;</div><div class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>, $nbToken = count($tokens); $i &lt; $nbToken; ++$i) &#123;</div><div class="line">    $regexp .= <span class="keyword">self</span>::computeRegexp($tokens, $i, $firstOptional);</div><div class="line">&#125;</div><div class="line">$regexp = <span class="keyword">self</span>::REGEX_DELIMITER.<span class="string">'^'</span>.$regexp.<span class="string">'$'</span>.<span class="keyword">self</span>::REGEX_DELIMITER.<span class="string">'s'</span>.($isHost ? <span class="string">'i'</span> : <span class="string">''</span>);</div></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">computeRegexp</span><span class="params">(array $tokens, $index, $firstOptional)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $token = $tokens[$index];</div><div class="line">    <span class="keyword">if</span> (<span class="string">'text'</span> === $token[<span class="number">0</span>]) &#123;</div><div class="line">        <span class="comment">// Text tokens</span></div><div class="line">        <span class="keyword">return</span> preg_quote($token[<span class="number">1</span>], <span class="keyword">self</span>::REGEX_DELIMITER);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// Variable tokens</span></div><div class="line">        <span class="keyword">if</span> (<span class="number">0</span> === $index &amp;&amp; <span class="number">0</span> === $firstOptional) &#123;</div><div class="line">            <span class="comment">// When the only token is an optional variable token, the separator is required</span></div><div class="line">            <span class="keyword">return</span> sprintf(<span class="string">'%s(?P&lt;%s&gt;%s)?'</span>, preg_quote($token[<span class="number">1</span>], <span class="keyword">self</span>::REGEX_DELIMITER), $token[<span class="number">3</span>], $token[<span class="number">2</span>]);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            $regexp = sprintf(<span class="string">'%s(?P&lt;%s&gt;%s)'</span>, preg_quote($token[<span class="number">1</span>], <span class="keyword">self</span>::REGEX_DELIMITER), $token[<span class="number">3</span>], $token[<span class="number">2</span>]);</div><div class="line">            <span class="keyword">if</span> ($index &gt;= $firstOptional) &#123;</div><div class="line">                $regexp = <span class="string">"(?:$regexp"</span>;</div><div class="line">                $nbTokens = count($tokens);</div><div class="line">                <span class="keyword">if</span> ($nbTokens - <span class="number">1</span> == $index) &#123;</div><div class="line">                    <span class="comment">// Close the optional subpatterns</span></div><div class="line">                    $regexp .= str_repeat(<span class="string">')?'</span>, $nbTokens - $firstOptional - (<span class="number">0</span> === $firstOptional ? <span class="number">1</span> : <span class="number">0</span>));</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> $regexp;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>computeRegexp</code> 函数的大致流程为：</p>
<ul>
<li>若 <code>tokens</code> 当前元素是 <code>text</code> ，不是路由参数的时候，直接赋值原字符串即可</li>
<li>若 <code>url</code> 中路由参数都是可选参数，且没有任何 <code>text</code>，那么第一个可选参数使用捕获分组</li>
<li>若当前路由参数是可选参数的时候，需要在正则表达式中不断叠加非捕获分组 <code>(?</code>，再最后设置为可选分组 <code>)?</code>，例如 <code>(?:/(?P&lt;baz&gt;[^/]++)(?:/(?P&lt;ext&gt;[^/]++))?)?</code></li>
<li>若当前路由参数不是可选参数的时候，正则表达式就是固定模式，例如： <code>/(?P&lt;foo&gt;[^/]++)</code></li>
</ul>
<p>利用 <code>computeRegexp</code> 函数拼接正则表达式后，还要在最两侧分隔符、开始符 <code>^</code>,结束符 <code>$</code>、单行修正符 <code>s</code>，如果是主域的正则表达式，还要添加不区分大小写的修正符 <code>i</code>。</p>
<p>以 <code>prefix/{foo}/{baz}.{ext}/tail</code> 为例,每次生成的正则表达式如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/prefix</div><div class="line">/prefix/(?P&lt;foo&gt;[^/]++)</div><div class="line">/prefix/(?P&lt;foo&gt;[^/]++)/(?P&lt;baz&gt;[^/\.]++)</div><div class="line">/prefix/(?P&lt;foo&gt;[^/]++)/(?P&lt;baz&gt;[^/\.]++)\.(?P&lt;ext&gt;[^/]++)</div><div class="line">/prefix/(?P&lt;foo&gt;[^/]++)/(?P&lt;baz&gt;[^/\.]++)\.(?P&lt;ext&gt;[^/]++)/tail</div><div class="line"><span class="comment">#^/prefix/(?P&lt;foo&gt;[^/]++)/(?P&lt;baz&gt;[^/\.]++)\.(?P&lt;ext&gt;[^/]++)/tail$#s</span></div></pre></td></tr></table></figure>
<p>以 <code>{foo?}/{baz?}.{ext?}</code> 为例,每次生成的正则表达式如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">/(?P&lt;foo&gt;[^/]++)?</div><div class="line">/(?P&lt;foo&gt;[^/]++)?(?:/(?P&lt;baz&gt;[^/\.]++)</div><div class="line">/(?P&lt;foo&gt;[^/]++)?(?:/(?P&lt;baz&gt;[^/\.]++)(?:\.(?P&lt;ext&gt;[^/]++))?)?</div><div class="line"><span class="comment">#^/(?P&lt;foo&gt;[^/]++)?(?:/(?P&lt;baz&gt;[^/\.]++)(?:\.(?P&lt;ext&gt;[^/]++))?)?$#s</span></div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/07/23/Laravel HTTP——Pipeline 中间件处理源码分析/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/23/Laravel HTTP——Pipeline 中间件处理源码分析/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-23T15:17:23+08:00">
                2017-07-23
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/23/Laravel HTTP——Pipeline 中间件处理源码分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/23/Laravel HTTP——Pipeline 中间件处理源码分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/23/Laravel HTTP——Pipeline 中间件处理源码分析/" class="leancloud_visitors" data-flag-title="">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>当所有的路由都加载完毕后，就会根据请求的 <code>url</code> 来将请求分发到对应的路由上去。然而，在分发到路由之前还要经过各种中间件的计算。<code>laravel</code> 利用装饰者模式来实现中间件的功能。</p>
<h1 id="从原始装饰者模式到闭包装饰者"><a href="#从原始装饰者模式到闭包装饰者" class="headerlink" title="从原始装饰者模式到闭包装饰者"></a>从原始装饰者模式到闭包装饰者</h1><p>装饰者模式是设计模式的一种，主要进行对象的多次处理与过滤，是在开放-关闭原则下实现动态添加或减少功能的一种方式。下面先看一个装饰者模式的例子：</p>
<p>总共有两种咖啡：Decaf、Espresso，另有两种调味品：Mocha、Whip（3种设计的主要差别在于抽象方式不同）</p>
<p>装饰模式分为3个部分：</p>
<p>1，抽象组件 – 对应Coffee类</p>
<p>2，具体组件 – 对应具体的咖啡，如：Decaf，Espresso</p>
<p>3，装饰者 – 对应调味品，如：Mocha，Whip</p>
<h2 id="原始装饰者模式"><a href="#原始装饰者模式" class="headerlink" title="原始装饰者模式"></a>原始装饰者模式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Coffee</span></span></div><div class="line"><span class="class"></span>&#123;  </div><div class="line">    <span class="keyword">public</span> double cost();  </div><div class="line">&#125; </div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Espresso</span> <span class="keyword">implements</span> <span class="title">Coffee</span> </span></div><div class="line"><span class="class"></span>&#123;  </div><div class="line">    <span class="keyword">public</span> double cost()</div><div class="line">    &#123;  </div><div class="line">        <span class="keyword">return</span> <span class="number">2.5</span>;  </div><div class="line">    &#125;  </div><div class="line">&#125;  </div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dressing</span> <span class="keyword">implements</span> <span class="title">Coffee</span> </span></div><div class="line"><span class="class"></span>&#123;  </div><div class="line">    <span class="keyword">private</span> Coffee coffee;  </div><div class="line">      </div><div class="line">    <span class="keyword">public</span> Dressing(Coffee coffee)</div><div class="line">    &#123;  </div><div class="line">        this.coffee = coffee;  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    <span class="keyword">public</span> double cost()</div><div class="line">    &#123;  </div><div class="line">        <span class="keyword">return</span> coffee.cost();  </div><div class="line">    &#125;  </div><div class="line">&#125;  </div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Whip</span> <span class="keyword">extends</span> <span class="title">Dressing</span> </span>&#123;  </div><div class="line">    <span class="keyword">public</span> Whip(Coffee coffee)</div><div class="line">    &#123;  </div><div class="line">        super(coffee);  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    <span class="keyword">public</span> double cost()</div><div class="line">    &#123;  </div><div class="line">        <span class="keyword">return</span> super.cost() + <span class="number">0.1</span>;  </div><div class="line">    &#125;  </div><div class="line">&#125; </div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mocha</span> <span class="keyword">extends</span> <span class="title">Dressing</span> </span></div><div class="line"><span class="class"></span>&#123;  </div><div class="line">    <span class="keyword">public</span> Mocha(Coffee coffee)</div><div class="line">    &#123;  </div><div class="line">        super(coffee);  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    <span class="keyword">public</span> double cost()</div><div class="line">    &#123;  </div><div class="line">        <span class="keyword">return</span> super.cost() + <span class="number">0.5</span>;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当我们使用装饰者模式的时候：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;  </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> void main(String[] args) &#123;  </div><div class="line">        Coffee coffee = <span class="keyword">new</span> Espresso();  </div><div class="line">        coffee = <span class="keyword">new</span> Mocha(coffee);  </div><div class="line">        coffee = <span class="keyword">new</span> Mocha(coffee);  </div><div class="line">        coffee = <span class="keyword">new</span> Whip(coffee);  </div><div class="line">        <span class="comment">//3.6(2.5 + 0.5 + 0.5 + 0.1)  </span></div><div class="line">        System.out.println(coffee.cost());  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以看出来，装饰者模式就是利用装饰者类来对具体类不断的进行多层次的处理，首先我们创建了 <code>Espresso</code> 类，然后第一次利用 <code>Mocha</code> 装饰者对 <code>Espresso</code> 咖啡加了摩卡，第二次重复加了摩卡，第三次利用装饰者 <code>Whip</code> 对 <code>Espresso</code> 咖啡加了奶油。每次加入新的调料，装饰者都会对价格 <code>cost</code> 做一些处理（+0.1、+0.5）。</p>
<h2 id="无构造函数的装饰者"><a href="#无构造函数的装饰者" class="headerlink" title="无构造函数的装饰者"></a>无构造函数的装饰者</h2><p>我们对这个装饰者进行一些改造：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Espresso</span></span></div><div class="line"><span class="class"></span>&#123;  </div><div class="line">    double cost;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> double cost()</div><div class="line">    &#123;  </div><div class="line">        <span class="keyword">$this</span>-&gt; cost = <span class="number">2.5</span>;  </div><div class="line">    &#125;  </div><div class="line">&#125;  </div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dressing</span> </span></div><div class="line"><span class="class"></span>&#123;    </div><div class="line">    <span class="keyword">public</span> double cost(Espresso $espresso)</div><div class="line">    &#123;  </div><div class="line">        <span class="keyword">return</span> ($espresso);</div><div class="line">    &#125;  </div><div class="line">&#125;  </div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Whip</span> <span class="keyword">extends</span> <span class="title">Dressing</span> </span></div><div class="line"><span class="class"></span>&#123;  </div><div class="line">    <span class="keyword">public</span> double cost(Espresso $espresso)</div><div class="line">    &#123;  </div><div class="line">        $espresso-&gt;cost = espresso-&gt;cost() + <span class="number">0.1</span>;  </div><div class="line">        </div><div class="line">        <span class="keyword">return</span> ($espresso);</div><div class="line">    &#125;  </div><div class="line">&#125; </div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mocha</span> <span class="keyword">extends</span> <span class="title">Dressing</span> </span></div><div class="line"><span class="class"></span>&#123;   </div><div class="line">    <span class="keyword">public</span> double cost(Espresso $espresso)</div><div class="line">    &#123;  </div><div class="line">        $espresso-&gt;cost = espresso-&gt;cost() + <span class="number">0.5</span>;  </div><div class="line">        </div><div class="line">        <span class="keyword">return</span> ($espresso);</div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;  </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> void main(String[] args) &#123;  </div><div class="line">        Coffee $coffee = <span class="keyword">new</span> Espresso();  </div><div class="line">        </div><div class="line">        $coffee = (<span class="keyword">new</span> Mocha())-&gt;cost($coffee); </div><div class="line">        $coffee = (<span class="keyword">new</span> Mocha())-&gt;cost($coffee); </div><div class="line">        $coffee = (<span class="keyword">new</span> Whip())-&gt;cost($coffee);  </div><div class="line">       </div><div class="line">        <span class="comment">//3.6(2.5 + 0.5 + 0.5 + 0.1)  </span></div><div class="line">        System.out.println(coffee.cost());  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>改造后，装饰者类通过函数 <code>cost</code> 来注入具体类 <code>caffee</code>，而不是通过构造函数，这样做有助于自动化进行装饰处理。我们改造后发现，想要对具体类通过装饰类进行处理，需要不断的调用 <code>cost</code> 函数，如果有10个装饰操作，就要手动写10个语句，因此我们继续进行改造：</p>
<h2 id="闭包装饰者模式"><a href="#闭包装饰者模式" class="headerlink" title="闭包装饰者模式"></a>闭包装饰者模式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Espresso</span></span></div><div class="line"><span class="class"></span>&#123;  </div><div class="line">    double cost;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> double cost()</div><div class="line">    &#123;  </div><div class="line">        <span class="keyword">$this</span>-&gt; cost = <span class="number">2.5</span>;  </div><div class="line">    &#125;  </div><div class="line">&#125;  </div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dressing</span> </span></div><div class="line"><span class="class"></span>&#123;    </div><div class="line">    <span class="keyword">public</span> double cost(Espresso $espresso,  Closure $closure)</div><div class="line">    &#123;  </div><div class="line">        <span class="keyword">return</span> ($espresso);</div><div class="line">    &#125;  </div><div class="line">&#125;  </div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Whip</span> <span class="keyword">extends</span> <span class="title">Dressing</span> </span></div><div class="line"><span class="class"></span>&#123;  </div><div class="line">    <span class="keyword">public</span> double cost(Espresso $espresso, Closure $closure)</div><div class="line">    &#123;  </div><div class="line">        $espresso-&gt;cost = espresso-&gt;cost() + <span class="number">0.1</span>;  </div><div class="line">        </div><div class="line">        <span class="keyword">return</span> $closure($espresso);</div><div class="line">    &#125;  </div><div class="line">&#125; </div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mocha</span> <span class="keyword">extends</span> <span class="title">Dressing</span> </span></div><div class="line"><span class="class"></span>&#123;   </div><div class="line">    <span class="keyword">public</span> double cost(Espresso $espresso, Closure $closure)</div><div class="line">    &#123;  </div><div class="line">        $espresso-&gt;cost = espresso-&gt;cost() + <span class="number">0.5</span>;  </div><div class="line">        </div><div class="line">        <span class="keyword">return</span> $closure($espresso);</div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;  </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> void main(String[] args) &#123;  </div><div class="line">        Coffee $coffee = <span class="keyword">new</span> Espresso();  </div><div class="line">        </div><div class="line">        $fun = <span class="function"><span class="keyword">function</span><span class="params">($coffee，$fuc，$dressing)</span> </span>&#123;</div><div class="line">            $dressing-&gt;cost($coffee, $fuc); </div><div class="line">        &#125;                </div><div class="line">        </div><div class="line">        </div><div class="line">        $fuc0 = <span class="function"><span class="keyword">function</span><span class="params">($coffee)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> $coffee;</div><div class="line">        &#125;;</div><div class="line">        </div><div class="line">        $fuc1 = <span class="function"><span class="keyword">function</span><span class="params">($coffee)</span> <span class="title">use</span> <span class="params">($fuc0, $dressing = <span class="params">(new Mocha<span class="params">()</span>，$fuc)</span> &#123;</span></span></div><div class="line"><span class="function"><span class="params">            return $fun<span class="params">($coffee, $fuc0, $dressing)</span>;</span></span></div><div class="line"><span class="function"><span class="params">        &#125;</span></span></div><div class="line"><span class="function"><span class="params">        </span></span></div><div class="line"><span class="function"><span class="params">        $fuc2 = function<span class="params">($coffee)</span> use <span class="params">($fuc1, $dressing = <span class="params">(new Mocha<span class="params">()</span>，$fun)</span> &#123;</span></span></span></div><div class="line"><span class="function"><span class="params"><span class="params">            return $fuc<span class="params">($coffee, $fun1, $dressing)</span>;</span></span></span></div><div class="line"><span class="function"><span class="params"><span class="params">        &#125;</span></span></span></div><div class="line"><span class="function"><span class="params"><span class="params">        </span></span></span></div><div class="line"><span class="function"><span class="params"><span class="params">        $fuc3 = function<span class="params">($coffee)</span> use <span class="params">($fuc2, $dressing = <span class="params">(new Whip<span class="params">()</span>，$fun)</span> &#123;</span></span></span></span></div><div class="line"><span class="function"><span class="params"><span class="params"><span class="params">            return $fuc<span class="params">($coffee, $fun2, $dressing)</span>;</span></span></span></span></div><div class="line"><span class="function"><span class="params"><span class="params"><span class="params">        &#125;</span></span></span></span></div><div class="line"><span class="function"><span class="params"><span class="params"><span class="params">              </span></span></span></span></div><div class="line"><span class="function"><span class="params"><span class="params"><span class="params">        $coffee = $fun3<span class="params">($coffee)</span>;</span></span></span></span></div><div class="line"><span class="function"><span class="params"><span class="params"><span class="params">       </span></span></span></span></div><div class="line"><span class="function"><span class="params"><span class="params"><span class="params">        //<span class="number">3.6</span><span class="params">(<span class="number">2.5</span> + <span class="number">0.5</span> + <span class="number">0.5</span> + <span class="number">0.1</span>)</span>  </span></span></span></span></div><div class="line"><span class="function"><span class="params"><span class="params"><span class="params">        System.out.println<span class="params">(coffee.cost<span class="params">()</span>)</span>;  </span></span></span></span></div><div class="line"><span class="function"><span class="params"><span class="params"><span class="params">    &#125;  </span></span></span></span></div><div class="line"><span class="function"><span class="params"><span class="params"><span class="params">&#125;</span></span></span></span></div></pre></td></tr></table></figure>
<p>在这次改造中，我们使用了闭包函数，这样做的目的在于，我们只需要最后一句 <code>$fun3($coffee)</code>,就可以启动整个装饰链条。</p>
<h2 id="闭包装饰者的抽象化"><a href="#闭包装饰者的抽象化" class="headerlink" title="闭包装饰者的抽象化"></a>闭包装饰者的抽象化</h2><p>然而这种改造还不够深入，因为我们还可以把 <code>$fuc1</code>、<code>$fuc2</code>、<code>$fuc3</code> 继续抽象化为一个闭包函数，这个闭包函数仅仅是参数 <code>$fuc</code>、<code>$dressing</code> 每次不同，<code>$coffee</code> 相同，因此改造如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;  </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> void main(String[] args) &#123;  </div><div class="line">        Coffee $coffee = <span class="keyword">new</span> Espresso();  </div><div class="line">        </div><div class="line">        $fun = <span class="function"><span class="keyword">function</span><span class="params">($coffee)</span> <span class="title">use</span> <span class="params">($fuc，$dressing)</span> </span>&#123;</div><div class="line">            $dressing-&gt;cost($coffee, $fuc); </div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        $fuc = <span class="function"><span class="keyword">function</span><span class="params">($fuc，$dressing)</span> <span class="title">use</span> <span class="params">($fun)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> $fun;</div><div class="line">        &#125;;</div><div class="line">                </div><div class="line">        </div><div class="line">        $fuc0 = <span class="function"><span class="keyword">function</span><span class="params">($coffee)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> $coffee;</div><div class="line">        &#125;;</div><div class="line">        </div><div class="line">        $fuc1 = $fuc($fuc0, (<span class="keyword">new</span> Mocha());</div><div class="line">        </div><div class="line">        $fuc2 = $fuc($fuc1, (<span class="keyword">new</span> Mocha());</div><div class="line">        </div><div class="line">        $fuc3 = $fuc($fuc2, (<span class="keyword">new</span> Whip());</div><div class="line">              </div><div class="line">        $coffee = $fun3($coffee);</div><div class="line">       </div><div class="line">        <span class="comment">//3.6(2.5 + 0.5 + 0.5 + 0.1)  </span></div><div class="line">        System.out.println(coffee.cost());  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这次，我们把之前的闭包分为两个部分，<code>$fun</code> 负责具体类的参数传递，<code>$fuc</code>负责装饰者和闭包函数的参数传递。在最后一句 <code>$fun3</code>,只需要传递一个具体类，就可以启动整个装饰链条。</p>
<h2 id="闭包装饰者的自动化"><a href="#闭包装饰者的自动化" class="headerlink" title="闭包装饰者的自动化"></a>闭包装饰者的自动化</h2><p>到这里，我们还有一件事没有完成，那就是 <code>$fuc1</code>、<code>$fuc2</code>、<code>$fuc3</code> 这些闭包的构建还是手动的，我们需要将这个过程改为自动的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;  </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> void main(String[] args) &#123;  </div><div class="line">        Coffee $coffee = <span class="keyword">new</span> Espresso();  </div><div class="line">        </div><div class="line">        $fun = <span class="function"><span class="keyword">function</span><span class="params">($coffee)</span> <span class="title">use</span> <span class="params">($fuc，$dressing)</span> </span>&#123;</div><div class="line">            $dressing-&gt;cost($coffee, $fuc); </div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        $fuc = <span class="function"><span class="keyword">function</span><span class="params">($fuc，$dressing)</span> <span class="title">use</span> <span class="params">($fun)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> $fun;</div><div class="line">        &#125;;</div><div class="line">                </div><div class="line">        </div><div class="line">        $fuc0 = <span class="function"><span class="keyword">function</span><span class="params">($coffee)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> $coffee;</div><div class="line">        &#125;;</div><div class="line">        </div><div class="line">        $fucn = array_reduce(</div><div class="line">            [(<span class="keyword">new</span> Mocha(),(<span class="keyword">new</span> Mocha(),(<span class="keyword">new</span> Whip()], $fuc, $fuc0</div><div class="line">        );</div><div class="line">              </div><div class="line">        $coffee = $fucn($coffee);</div><div class="line">       </div><div class="line">        <span class="comment">//3.6(2.5 + 0.5 + 0.5 + 0.1)  </span></div><div class="line">        System.out.println(coffee.cost());  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="laravel的闭包装饰者——Pipeline"><a href="#laravel的闭包装饰者——Pipeline" class="headerlink" title="laravel的闭包装饰者——Pipeline"></a>laravel的闭包装饰者——Pipeline</h1><p>上一章我们说到了路由的注册启动与加载过程，这个过程由 <code>bootstrap()</code> 完成。当所有的路由加载完毕后，就要进行各种中间件的处理了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequestThroughRouter</span><span class="params">($request)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</div><div class="line"></div><div class="line">    Facade::clearResolvedInstance(<span class="string">'request'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;bootstrap();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline(<span class="keyword">$this</span>-&gt;app))</div><div class="line">                -&gt;send($request)</div><div class="line">                -&gt;through(<span class="keyword">$this</span>-&gt;app-&gt;shouldSkipMiddleware() ? [] : <span class="keyword">$this</span>-&gt;middleware)</div><div class="line">                -&gt;then(<span class="keyword">$this</span>-&gt;dispatchToRouter());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">shouldSkipMiddleware</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;bound(<span class="string">'middleware.disable'</span>) &amp;&amp;</div><div class="line">           <span class="keyword">$this</span>-&gt;make(<span class="string">'middleware.disable'</span>) === <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> <code>laravel</code> 的中间件处理由 <code>Pipeline</code> 来完成，它是一个闭包装饰者模式，其中 </p>
<ul>
<li><code>request</code> 是具体类，相当于我们上面的 <code>caffee</code> 类；</li>
<li><code>middleware</code> 中间件是装饰者类，相当于上面的 <code>dressing</code> 类；</li>
</ul>
<p>我们先看看这个类内部的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pipeline</span> <span class="keyword">implements</span> <span class="title">PipelineContract</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Container $container = null)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">      <span class="keyword">$this</span>-&gt;container = $container;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">($passable)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;passable = $passable;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">through</span><span class="params">($pipes)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;pipes = is_array($pipes) ? $pipes : func_get_args();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">then</span><span class="params">(Closure $destination)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $pipeline = array_reduce(</div><div class="line">            array_reverse(<span class="keyword">$this</span>-&gt;pipes), <span class="keyword">$this</span>-&gt;carry(), <span class="keyword">$this</span>-&gt;prepareDestination($destination)</div><div class="line">        );</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $pipeline(<span class="keyword">$this</span>-&gt;passable);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">prepareDestination</span><span class="params">(Closure $destination)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($passable)</span> <span class="title">use</span> <span class="params">($destination)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> $destination($passable);</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">carry</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($stack, $pipe)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($passable)</span> <span class="title">use</span> <span class="params">($stack, $pipe)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> ($pipe <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">                    <span class="keyword">return</span> $pipe($passable, $stack);</div><div class="line">                &#125; <span class="keyword">elseif</span> (! is_object($pipe)) &#123;</div><div class="line">                    <span class="keyword">list</span>($name, $parameters) = <span class="keyword">$this</span>-&gt;parsePipeString($pipe);</div><div class="line"></div><div class="line">                    $pipe = <span class="keyword">$this</span>-&gt;getContainer()-&gt;make($name);</div><div class="line"></div><div class="line">                    $parameters = array_merge([$passable, $stack], $parameters);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    $parameters = [$passable, $stack];</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">return</span> $pipe-&gt;&#123;<span class="keyword">$this</span>-&gt;method&#125;(...$parameters);</div><div class="line">            &#125;;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>pipeline</code> 的构造和我们上面所讲的闭包装饰者相同，我们着重来看 <code>carry()</code> 函数的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="params">($stack, $pipe)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最外层的闭包相当于上个章节的 <code>$fuc</code>,</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="params">($passable)</span> <span class="title">use</span> <span class="params">($stack, $pipe)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>里面的这一层比闭包型党与上个章节的 <code>$fun</code>，</p>
<p><code>prepareDestination</code> 这个函数相当于上面的 <code>$fuc0</code>,</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($pipe <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">       <span class="keyword">return</span> $pipe($passable, $stack);</div><div class="line">   &#125; <span class="keyword">elseif</span> (! is_object($pipe)) &#123;</div><div class="line">       <span class="keyword">list</span>($name, $parameters) = <span class="keyword">$this</span>-&gt;parsePipeString($pipe);</div><div class="line"></div><div class="line">       $pipe = <span class="keyword">$this</span>-&gt;getContainer()-&gt;make($name);</div><div class="line"></div><div class="line">       $parameters = array_merge([$passable, $stack], $parameters);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       $parameters = [$passable, $stack];</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> $pipe-&gt;&#123;<span class="keyword">$this</span>-&gt;method&#125;(...$parameters);</div></pre></td></tr></table></figure>
<p>这一部分相当于上个章节的 <code>$dressing-&gt;cost($coffee, $fuc);</code>,这部分主要解析中间件 <code>handle()</code> 函数的参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">via</span><span class="params">($method)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;method = $method;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parsePipeString</span><span class="params">($pipe)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">list</span>($name, $parameters) = array_pad(explode(<span class="string">':'</span>, $pipe, <span class="number">2</span>), <span class="number">2</span>, []);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (is_string($parameters)) &#123;</div><div class="line">    	$parameters = explode(<span class="string">','</span>, $parameters);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> [$name, $parameters];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样，<code>laravel</code> 就实现了中间件对 <code>request</code> 的层层处理。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/master.jpg"
               alt="Leo Yang" />
          <p class="site-author-name" itemprop="name">Leo Yang</p>
           
              <p class="site-description motion-element" itemprop="description">Life and Learn!</p>
          
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/LeoYang90" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/liang-de-tai-yang" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Leo Yang</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"leoyang90"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("ftMscWAwCsyt12PCu9jVqOrL-gzGzoHsz", "39fy4YEUohtU0wVi4r4MuKEI");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
