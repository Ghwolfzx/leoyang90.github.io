<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0" />






<meta name="description" content="Life and Learn!">
<meta property="og:type" content="website">
<meta property="og:title" content="LEOYANG&#39;S BLOG">
<meta property="og:url" content="https://leoyang90.github.io/page/3/index.html">
<meta property="og:site_name" content="LEOYANG&#39;S BLOG">
<meta property="og:description" content="Life and Learn!">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LEOYANG&#39;S BLOG">
<meta name="twitter:description" content="Life and Learn!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'LeoYang'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://leoyang90.github.io/page/3/"/>





  <title> LEOYANG'S BLOG </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c45898c39ba7512b69229aa34c07263a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">LEOYANG'S BLOG</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Notes and Blogs</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'qzqmBx1WzwFX9LPuU1Rc','2.0.0');
</script>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/07/19/Laravel HTTP——路由加载源码分析/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/19/Laravel HTTP——路由加载源码分析/" itemprop="url">
                  Laravel HTTP——添加路由源码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-19T17:46:00+08:00">
                2017-07-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/19/Laravel HTTP——路由加载源码分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/19/Laravel HTTP——路由加载源码分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/19/Laravel HTTP——路由加载源码分析/" class="leancloud_visitors" data-flag-title="Laravel HTTP——添加路由源码分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>作为 <code>laravel</code> 极其重要的一部分，<code>route</code> 功能贯穿着整个网络请求，是 <code>request</code> 生命周期的主干。本文主要讲述 <code>route</code> 服务的注册与启动、路由的属性注册。本篇内容相对简单，更多的是框架添加路由的整体设计流程。</p>
<h1 id="route-服务的注册"><a href="#route-服务的注册" class="headerlink" title="route 服务的注册"></a>route 服务的注册</h1><p><code>laravel</code> 在接受到请求后，先进行了服务容器与 <code>http</code> 核心的初始化，再进行了请求 <code>request</code> 的构造与分发。</p>
<p><code>route</code> 服务的注册—— <code>RoutingServiceProvider</code> 发生在服务容器 <code>container</code> 的初始化上;</p>
<p><code>route</code> 服务的启动与加载—— <code>RouteServiceProvider</code> 发生在 <code>request</code> 的分发上。</p>
<h2 id="route-服务的注册——RoutingServiceProvider"><a href="#route-服务的注册——RoutingServiceProvider" class="headerlink" title="route 服务的注册——RoutingServiceProvider"></a>route 服务的注册——RoutingServiceProvider</h2><p>所有需要 <code>laravel</code> 服务的请求都会加载入口文件 <code>index.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/autoload.php'</span>;</div><div class="line"></div><div class="line">$app = <span class="keyword">require_once</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/app.php'</span>;</div></pre></td></tr></table></figure>
<p>第一句我们在之前的博客提过，是实现 <code>PSR0</code>    、<code>PSR4</code>标准自动加载的功能模块，第二句就是今天说的 <code>container</code> 的初始化：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$app = <span class="keyword">new</span> Illuminate\Foundation\Application(</div><div class="line">    realpath(<span class="keyword">__DIR__</span>.<span class="string">'/../'</span>)</div><div class="line">);</div></pre></td></tr></table></figure>
<p><code>Application</code> :</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">Container</span> <span class="keyword">implements</span> <span class="title">ApplicationContract</span>, <span class="title">HttpKernelInterface</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($basePath = null)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> ($basePath) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;setBasePath($basePath);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;registerBaseBindings();</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;registerBaseServiceProviders();</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;registerCoreContainerAliases();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>路由服务的注册就在 <code>registerBaseServiceProviders()</code> 这个函数中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerBaseServiceProviders</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;register(<span class="keyword">new</span> EventServiceProvider(<span class="keyword">$this</span>));</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;register(<span class="keyword">new</span> LogServiceProvider(<span class="keyword">$this</span>));</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;register(<span class="keyword">new</span> RoutingServiceProvider(<span class="keyword">$this</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>RoutingServiceProvider</code> :</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Routing</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RoutingServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;registerRouter();</div><div class="line"></div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerRouter</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;app-&gt;singleton(<span class="string">'router'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Router($app[<span class="string">'events'</span>], $app);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    ...</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，<code>RoutingServiceProvider</code> 做的事情比较简单，就是向服务容易中注册 <code>router</code>。</p>
<h2 id="route-服务的启动与加载——RouteServiceProvider"><a href="#route-服务的启动与加载——RouteServiceProvider" class="headerlink" title="route 服务的启动与加载——RouteServiceProvider"></a><code>route</code> 服务的启动与加载——RouteServiceProvider</h2><p><code>laravel</code> 在初始化 <code>Application</code> 后，就要进行 <code>http/Kernel</code> 的构造： </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</div><div class="line"></div><div class="line">$response = $kernel-&gt;handle(</div><div class="line">    $request = Illuminate\Http\Request::capture()</div><div class="line">);</div><div class="line">``` </div><div class="line"></div><div class="line">初始化结束后，就会调用 `handle` 函数，这个函数用于 `laravel` 各个功能服务的注册启动，还有 `request` 的分发：</div><div class="line"></div><div class="line">```php</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        $request-&gt;enableHttpMethodParameterOverride();</div><div class="line"></div><div class="line">        $response = <span class="keyword">$this</span>-&gt;sendRequestThroughRouter($request);</div><div class="line">    &#125; </div><div class="line">    </div><div class="line">    <span class="keyword">return</span> $response;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequestThroughRouter</span><span class="params">($request)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</div><div class="line"></div><div class="line">    Facade::clearResolvedInstance(<span class="string">'request'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;bootstrap();<span class="comment">//各种服务的注册与启动</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline(<span class="keyword">$this</span>-&gt;app))<span class="comment">//请求的分发</span></div><div class="line">                -&gt;send($request)</div><div class="line">                -&gt;through(<span class="keyword">$this</span>-&gt;app-&gt;shouldSkipMiddleware() ? [] : <span class="keyword">$this</span>-&gt;middleware)</div><div class="line">                -&gt;then(<span class="keyword">$this</span>-&gt;dispatchToRouter());</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>路由服务的启动与加载就在其中一个函数中 <code>bootstrap</code>，这个函数用于各种服务的注册与启动，比较复杂，我们有机会在以后单独来说。</p>
<p>总之，这个函数会调用 <code>RouteServiceProvider</code> 这个类的两个函数： 注册——<code>register</code>、启动——<code>boot</code>。</p>
<p>由于 <code>route</code> 的注册工作由之前 <code>RoutingServiceProvider</code> 完成，所以 <code>RouteServiceProvider</code> 的 <code>register</code> 是空的，这里它只负责路由的启动与加载工作，我们主要看 <code>boot</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Support</span>\<span class="title">Providers</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="comment">//</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;setRootControllerNamespace();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;app-&gt;routesAreCached()) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;loadCachedRoutes();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;loadRoutes();</div><div class="line"></div><div class="line">            <span class="keyword">$this</span>-&gt;app-&gt;booted(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">$this</span>-&gt;app[<span class="string">'router'</span>]-&gt;getRoutes()-&gt;refreshNameLookups();</div><div class="line">                <span class="keyword">$this</span>-&gt;app[<span class="string">'router'</span>]-&gt;getRoutes()-&gt;refreshActionLookups();</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">loadCachedRoutes</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;app-&gt;booted(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">require</span> <span class="keyword">$this</span>-&gt;app-&gt;getCachedRoutesPath();</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">loadRoutes</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (method_exists(<span class="keyword">$this</span>, <span class="string">'map'</span>)) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;app-&gt;call([<span class="keyword">$this</span>, <span class="string">'map'</span>]);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">Container</span> <span class="keyword">implements</span> <span class="title">ApplicationContract</span>, <span class="title">HttpKernelInterface</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">routesAreCached</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>[<span class="string">'files'</span>]-&gt;exists(<span class="keyword">$this</span>-&gt;getCachedRoutesPath());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCachedRoutesPath</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;bootstrapPath().<span class="string">'/cache/routes.php'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从 <code>boot</code> 中可以看出，<code>laravel</code> 首先去寻找路由的缓存文件，没有缓存文件再去进行加载路由。缓存文件一般在 <code>bootstrap/cache/routes.php</code> 文件中。</p>
<p>加载路由主要调用 <code>map</code> 函数，这个函数一般在 <code>App\Providers\RouteServiceProvider</code> 这个类中，这个类继承上面的 <code>Illuminate\Foundation\Support\Providers\RouteServiceProvider</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Support</span>\<span class="title">Providers</span>\<span class="title">RouteServiceProvider</span> <span class="title">as</span> <span class="title">ServiceProvider</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">map</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;mapApiRoutes();</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;mapWebRoutes();</div><div class="line"></div><div class="line">        <span class="comment">//</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">mapWebRoutes</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        Route::middleware(<span class="string">'web'</span>)</div><div class="line">             -&gt;namespace(<span class="keyword">$this</span>-&gt;namespace)</div><div class="line">             -&gt;group(base_path(<span class="string">'routes/web.php'</span>));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">mapApiRoutes</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        Route::prefix(<span class="string">'api'</span>)</div><div class="line">             -&gt;middleware(<span class="string">'api'</span>)</div><div class="line">             -&gt;namespace(<span class="keyword">$this</span>-&gt;namespace)</div><div class="line">             -&gt;group(base_path(<span class="string">'routes/api.php'</span>));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>laravle</code> 将路由分为两个大组：<code>api</code>、<code>web</code>。这两个部分的路由分别写在两个文件中：<code>routes/web.php</code>、<code>routes/api.php</code>。</p>
<h2 id="路由的加载"><a href="#路由的加载" class="headerlink" title="路由的加载"></a>路由的加载</h2><p>所谓的路由加载，就是将定义路由时添加的属性，例如 ‘name’、’domain’、’scheme’ 等等保存起来，以待后用。</p>
<ul>
<li><code>laravel</code> 定义路由的属性的方法很灵活，可以定义在路由群组前，例如：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Route::domain(<span class="string">'route.domain.name'</span>)</div><div class="line">     -&gt;group(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</div><div class="line">			Route::get(<span class="string">'foo'</span>,<span class="string">'controller@method'</span>);</div><div class="line">     &#125;)</div></pre></td></tr></table></figure>
<ul>
<li>可以定义在路由群组中，例如：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Route::group(<span class="string">'domain'</span> =&gt; <span class="string">'group.domain.name'</span>,<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</div><div class="line">    		Route::get(<span class="string">'foo'</span>,<span class="string">'controller@method'</span>);</div><div class="line">    &#125;)</div></pre></td></tr></table></figure>
<ul>
<li>可以定义在 <code>method</code> 的前面，例如：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Route::domain(<span class="string">'route.domain.name'</span>)</div><div class="line">     -&gt;get(<span class="string">'foo'</span>,<span class="string">'controller@method'</span>);</div></pre></td></tr></table></figure>
<ul>
<li>可以定义在 <code>method</code> 中，例如：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'foo'</span>,[<span class="string">'domain'</span> =&gt; <span class="string">'route.domain.name'</span>,<span class="string">'use'</span> =&gt; <span class="string">'controller@method'</span>]);</div></pre></td></tr></table></figure>
<ul>
<li>还可以定义在 <code>method</code> 后，例如：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'&#123;one&#125;'</span>, <span class="string">'use'</span> =&gt; <span class="string">'controller@method'</span>)</div><div class="line">     -&gt;where(<span class="string">'one'</span>, <span class="string">'(.+)'</span>);</div></pre></td></tr></table></figure>
<p>事实上，路由的加载功能主要有三个类负责： <code>Illuminate\Routing\Router</code>、<code>Illuminate\Routing\Route</code>、<code>Illuminate\Routing\RouteRegistrar</code>。</p>
<p><code>Router</code> 在整个路由功能中都是起着中枢的作用， <code>RouteRegistrar</code> 主要负责位于 <code>group</code>、<code>method</code> 这些函数之前的属性注册，例如上面的第一种和第三种，<code>route</code> 主要负责位于 <code>group</code>、<code>method</code> 这些函数之后的属性注册，例如第五种。</p>
<h1 id="RouteRegistrar-路由加载"><a href="#RouteRegistrar-路由加载" class="headerlink" title="RouteRegistrar 路由加载"></a>RouteRegistrar 路由加载</h1><h2 id="属性注册"><a href="#属性注册" class="headerlink" title="属性注册"></a>属性注册</h2><p>当我们想要在 <code>Route</code> 后面直接利用 <code>domain()</code>、<code>name()</code> 等函数来为路由注册属性的时候，我们实际调用的是 <code>router</code> 的魔术方法 <code>__call()</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Routing</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span> <span class="keyword">implements</span> <span class="title">RegistrarContract</span>, <span class="title">BindingRegistrar</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $parameters)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">static</span>::hasMacro($method)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;macroCall($method, $parameters);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> RouteRegistrar(<span class="keyword">$this</span>))-&gt;attribute($method, $parameters[<span class="number">0</span>]);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在类 <code>RouteRegistrar</code> 中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteRegistrar</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">protected</span> $allowedAttributes = [</div><div class="line">    	<span class="string">'as'</span>, <span class="string">'domain'</span>, <span class="string">'middleware'</span>, <span class="string">'name'</span>, <span class="string">'namespace'</span>, <span class="string">'prefix'</span>,</div><div class="line">    ];</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">attribute</span><span class="params">($key, $value)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (! in_array($key, <span class="keyword">$this</span>-&gt;allowedAttributes)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(<span class="string">"Attribute [&#123;$key&#125;] does not exist."</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;attributes[array_get(<span class="keyword">$this</span>-&gt;aliases, $key, $key)] = $value;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="添加路由"><a href="#添加路由" class="headerlink" title="添加路由"></a>添加路由</h2><p>注册属性之后，创建路由的时候，可以仅仅提供 <code>uri</code>，可以提供 <code>uri</code> 与 闭包，可以提供 <code>uri</code> 与 控制器，可以提供 <code>uri</code> 与数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Route::as(<span class="string">'Foo'</span>)</div><div class="line">     -&gt;namespace(<span class="string">'Namespace\\Example\\'</span>)</div><div class="line">     -&gt;get(<span class="string">'foo/bar'</span>);<span class="comment">//仅仅 uri</span></div><div class="line">     </div><div class="line">Route::as(<span class="string">'Foo'</span>)</div><div class="line">     -&gt;namespace(<span class="string">'Namespace\\Example\\'</span>)</div><div class="line">     -&gt;get(<span class="string">'foo/bar'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">       &#125;); <span class="comment">//uri 与闭包</span></div><div class="line">    </div><div class="line">Route::as(<span class="string">'Foo'</span>)</div><div class="line">     -&gt;namespace(<span class="string">'Namespace\\Example\\'</span>)</div><div class="line">     -&gt;get(<span class="string">'foo/bar'</span>, <span class="string">'controller@method'</span>);<span class="comment">//uri 与控制器     </span></div><div class="line">     </div><div class="line">Route::as(<span class="string">'Foo'</span>)</div><div class="line">     -&gt;namespace(<span class="string">'Namespace\\Example\\'</span>)</div><div class="line">     -&gt;get(<span class="string">'foo/bar'</span>, [<span class="string">'as'</span>=&gt; <span class="string">'foo'</span>,<span class="string">'use'</span> =&gt;<span class="string">'controller@method'</span>]);<span class="comment">//uri 与数组</span></div></pre></td></tr></table></figure>
<p>利用 <code>get</code>、<code>post</code> 等方法创建新的路由时，会调用类 <code>RouteRegistrar</code> 中的魔术方法 <code>__call()</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteRegistrar</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">protected</span> $passthru = [</div><div class="line">        <span class="string">'get'</span>, <span class="string">'post'</span>, <span class="string">'put'</span>, <span class="string">'patch'</span>, <span class="string">'delete'</span>, <span class="string">'options'</span>, <span class="string">'any'</span>,</div><div class="line">    ];</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $parameters)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (in_array($method, <span class="keyword">$this</span>-&gt;passthru)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;registerRoute($method, ...$parameters);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (in_array($method, <span class="keyword">$this</span>-&gt;allowedAttributes)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;attribute($method, $parameters[<span class="number">0</span>]);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BadMethodCallException(<span class="string">"Method [&#123;$method&#125;] does not exist."</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerRoute</span><span class="params">($method, $uri, $action = null)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (! is_array($action)) &#123;</div><div class="line">            $action = array_merge(<span class="keyword">$this</span>-&gt;attributes, $action ? [<span class="string">'uses'</span> =&gt; $action] : []);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;router-&gt;&#123;$method&#125;($uri, <span class="keyword">$this</span>-&gt;compileAction($action));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileAction</span><span class="params">($action)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (is_null($action)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;attributes;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (is_string($action) || $action <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">            $action = [<span class="string">'uses'</span> =&gt; $action];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> array_merge(<span class="keyword">$this</span>-&gt;attributes, $action);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>也就是说，<code>RouteRegistrar</code> 在这里会为闭包或控制器等所有非数组的 <code>action</code> 添加 <code>use</code> 键，然后才会去 <code>router</code> 中创建路由。</p>
<h2 id="添加路由群组"><a href="#添加路由群组" class="headerlink" title="添加路由群组"></a>添加路由群组</h2><p>注册属性之后，还可以创建路由群组，但是这时路由群组不允许添加属性 <code>action</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteRegistrar</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">group</span><span class="params">($callback)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;router-&gt;group(<span class="keyword">$this</span>-&gt;attributes, $callback);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Router-路由群组加载"><a href="#Router-路由群组加载" class="headerlink" title="Router 路由群组加载"></a>Router 路由群组加载</h1><p>路由群组的功能可以不断叠加递归，因此每次调用 <code>group</code> ，都要用新路由群组的属性与旧路由群组属性合并，以待新的路由去继承。 <code>group</code> 参数可以是闭包函数，也可以是包含定义路由的文件路径。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">group</span><span class="params">(array $attributes, $routes)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;updateGroupStack($attributes);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;loadRoutes($routes);</div><div class="line"></div><div class="line">    array_pop(<span class="keyword">$this</span>-&gt;groupStack);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">updateGroupStack</span><span class="params">(array $attributes)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;groupStack)) &#123;</div><div class="line">        $attributes = RouteGroup::merge($attributes, end(<span class="keyword">$this</span>-&gt;groupStack));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;groupStack[] = $attributes;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">loadRoutes</span><span class="params">($routes)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> ($routes <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">        $routes(<span class="keyword">$this</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $router = <span class="keyword">$this</span>;</div><div class="line"></div><div class="line">        <span class="keyword">require</span> $routes;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>关于路由群组属性的合并, </p>
<ul>
<li><code>prefix</code>、<code>as</code>、<code>namespace</code> 这几个属性会连接在一起，例如 <code>prefix1/prefix2/prefix3</code>，</li>
<li><code>where</code> 属性数组相同的会被替换，不同的会被合并。</li>
<li><code>domain</code> 属性会被替换。</li>
<li>其他属性，例如 <code>middleware</code> 数组会直接被合并，即使存在相同的元素。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteGroup</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">merge</span><span class="params">($new, $old)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($new[<span class="string">'domain'</span>])) &#123;</div><div class="line">            <span class="keyword">unset</span>($old[<span class="string">'domain'</span>]);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $new = array_merge(<span class="keyword">static</span>::formatAs($new, $old), [</div><div class="line">            <span class="string">'namespace'</span> =&gt; <span class="keyword">static</span>::formatNamespace($new, $old),</div><div class="line">            <span class="string">'prefix'</span> =&gt; <span class="keyword">static</span>::formatPrefix($new, $old),</div><div class="line">            <span class="string">'where'</span> =&gt; <span class="keyword">static</span>::formatWhere($new, $old),</div><div class="line">        ]);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> array_merge_recursive(Arr::except(</div><div class="line">            $old, [<span class="string">'namespace'</span>, <span class="string">'prefix'</span>, <span class="string">'where'</span>, <span class="string">'as'</span>]</div><div class="line">        ), $new);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Router-路由加载"><a href="#Router-路由加载" class="headerlink" title="Router 路由加载"></a>Router 路由加载</h1><p>添加路由需要很多步骤，需要将路由本身的属性和路由群组的属性相结合。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($uri, $action = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;addRoute([<span class="string">'GET'</span>, <span class="string">'HEAD'</span>], $uri, $action);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addRoute</span><span class="params">($methods, $uri, $action)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;routes-&gt;add(<span class="keyword">$this</span>-&gt;createRoute($methods, $uri, $action));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createRoute</span><span class="params">($methods, $uri, $action)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">      </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;actionReferencesController($action)) &#123;</div><div class="line">        $action = <span class="keyword">$this</span>-&gt;convertToControllerAction($action);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $route = <span class="keyword">$this</span>-&gt;newRoute(</div><div class="line">        $methods, <span class="keyword">$this</span>-&gt;prefix($uri), $action</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;hasGroupStack()) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;mergeGroupAttributesIntoRoute($route);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;addWhereClausesToRoute($route);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $route;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上面来看，添加一个新的路由需要：</p>
<ul>
<li>给路由的控制器添加 <code>group</code> 的 <code>namespace</code></li>
<li>给路由的 <code>uri</code> 添加 <code>group</code> 的 <code>prefix</code> 前缀</li>
<li>创建新的路由</li>
<li>更新路由的属性信息</li>
<li>为路由添加 <code>router</code>-<code>pattern</code> 正则约束</li>
<li>路由添加到 <code>RouteCollection</code> 中</li>
</ul>
<h2 id="控制器-namespace"><a href="#控制器-namespace" class="headerlink" title="控制器 namespace"></a>控制器 namespace</h2><p>路由控制器的命名空间一般不用特别指定，默认值是 <code>\App\Http\Controllers</code>，每次创建新的路由，都要将默认的命名空间添加到控制器中去：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">actionReferencesController</span><span class="params">($action)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! $action <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">        <span class="keyword">return</span> is_string($action) || (<span class="keyword">isset</span>($action[<span class="string">'uses'</span>]) &amp;&amp; is_string($action[<span class="string">'uses'</span>]));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">convertToControllerAction</span><span class="params">($action)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (is_string($action)) &#123;</div><div class="line">        $action = [<span class="string">'uses'</span> =&gt; $action];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;groupStack)) &#123;</div><div class="line">        $action[<span class="string">'uses'</span>] = <span class="keyword">$this</span>-&gt;prependGroupNamespace($action[<span class="string">'uses'</span>]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $action[<span class="string">'controller'</span>] = $action[<span class="string">'uses'</span>];</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $action;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">prependGroupNamespace</span><span class="params">($class)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $group = end(<span class="keyword">$this</span>-&gt;groupStack);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">isset</span>($group[<span class="string">'namespace'</span>]) &amp;&amp; strpos($class, <span class="string">'\\'</span>) !== <span class="number">0</span></div><div class="line">            ? $group[<span class="string">'namespace'</span>].<span class="string">'\\'</span>.$class : $class;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="uri-前缀"><a href="#uri-前缀" class="headerlink" title="uri 前缀"></a>uri 前缀</h2><p>在创建新的路由前，需要将路由群组的 <code>prefix</code> 添加到路由的 <code>uri</code> 中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">prefix</span><span class="params">($uri)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> trim(trim(<span class="keyword">$this</span>-&gt;getLastGroupPrefix(), <span class="string">'/'</span>).<span class="string">'/'</span>.trim($uri, <span class="string">'/'</span>), <span class="string">'/'</span>) ?: <span class="string">'/'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getLastGroupPrefix</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;groupStack)) &#123;</div><div class="line">        $last = end(<span class="keyword">$this</span>-&gt;groupStack);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">isset</span>($last[<span class="string">'prefix'</span>]) ? $last[<span class="string">'prefix'</span>] : <span class="string">''</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">''</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="创建新的路由"><a href="#创建新的路由" class="headerlink" title="创建新的路由"></a>创建新的路由</h2><p>路由的创建需要 <code>Route</code> 类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">newRoute</span><span class="params">($methods, $uri, $action)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> Route($methods, $uri, $action))</div><div class="line">                -&gt;setRouter(<span class="keyword">$this</span>)</div><div class="line">                -&gt;setContainer(<span class="keyword">$this</span>-&gt;container);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>关于 <code>Router</code> 类添加新的路由我们在下一部分详细说。</p>
<h2 id="更新路由属性信息"><a href="#更新路由属性信息" class="headerlink" title="更新路由属性信息"></a>更新路由属性信息</h2><p>创建新的路由之后，需要将路由本身的属性 <code>action</code> 与路由群组的属性结合在一起：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasGroupStack</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> ! <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;groupStack);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">mergeGroupAttributesIntoRoute</span><span class="params">($route)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $route-&gt;setAction(<span class="keyword">$this</span>-&gt;mergeWithLastGroup($route-&gt;getAction()));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="添加全局正则约束到路由"><a href="#添加全局正则约束到路由" class="headerlink" title="添加全局正则约束到路由"></a>添加全局正则约束到路由</h2><p>上一篇文章我们说过，我们可以为路由通过 <code>pattern</code> 方法添加全局的参数正则约束，所有每次添加新的路由都要将这个全局正则约束添加到路由中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pattern</span><span class="params">($key, $pattern)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;patterns[$key] = $pattern;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addWhereClausesToRoute</span><span class="params">($route)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $route-&gt;where(array_merge(</div><div class="line">        <span class="keyword">$this</span>-&gt;patterns, <span class="keyword">isset</span>($route-&gt;getAction()[<span class="string">'where'</span>]) ? $route-&gt;getAction()[<span class="string">'where'</span>] : []</div><div class="line">    ));</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $route;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Route-路由加载"><a href="#Route-路由加载" class="headerlink" title="Route 路由加载"></a>Route 路由加载</h1><p>前面说过，路由的创建是由 <code>Route</code> 这个类完成的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($methods, $uri, $action)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;uri = $uri;</div><div class="line">    <span class="keyword">$this</span>-&gt;methods = (<span class="keyword">array</span>) $methods;</div><div class="line">    <span class="keyword">$this</span>-&gt;action = <span class="keyword">$this</span>-&gt;parseAction($action);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (in_array(<span class="string">'GET'</span>, <span class="keyword">$this</span>-&gt;methods) &amp;&amp; ! in_array(<span class="string">'HEAD'</span>, <span class="keyword">$this</span>-&gt;methods)) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;methods[] = <span class="string">'HEAD'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;action[<span class="string">'prefix'</span>])) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;prefix(<span class="keyword">$this</span>-&gt;action[<span class="string">'prefix'</span>]);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由此可以看出，路由的创建主要是路由的各个属性的初始化，其中值得注意的有两个： <code>action</code> 与 <code>prefix</code></p>
<h2 id="action-解析"><a href="#action-解析" class="headerlink" title="action 解析"></a>action 解析</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseAction</span><span class="params">($action)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> RouteAction::parse(<span class="keyword">$this</span>-&gt;uri, $action);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以看出，添加新的路由时， <code>action</code> 属性需要利用 <code>RouteAction</code> 类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteAction</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">parse</span><span class="params">($uri, $action)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (is_null($action)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">static</span>::missingAction($uri);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (is_callable($action)) &#123;</div><div class="line">            <span class="keyword">return</span> [<span class="string">'uses'</span> =&gt; $action];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">elseif</span> (! <span class="keyword">isset</span>($action[<span class="string">'uses'</span>])) &#123;</div><div class="line">            $action[<span class="string">'uses'</span>] = <span class="keyword">static</span>::findCallable($action);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (is_string($action[<span class="string">'uses'</span>]) &amp;&amp; ! Str::contains($action[<span class="string">'uses'</span>], <span class="string">'@'</span>)) &#123;</div><div class="line">            $action[<span class="string">'uses'</span>] = <span class="keyword">static</span>::makeInvokable($action[<span class="string">'uses'</span>]);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $action;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">findCallable</span><span class="params">(array $action)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> Arr::first($action, <span class="function"><span class="keyword">function</span> <span class="params">($value, $key)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> is_callable($value) &amp;&amp; is_numeric($key);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">makeInvokable</span><span class="params">($action)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (! method_exists($action, <span class="string">'__invoke'</span>)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnexpectedValueException(<span class="string">"Invalid route action: [&#123;$action&#125;]."</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $action.<span class="string">'@__invoke'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>前面的博客我们说过，创建路由的时候，除了为路由分配控制器之外，还可以为路由分配闭包函数，还有类函数，例如之前说的单动作控制器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">$router-&gt;get(<span class="string">'foo/bar2'</span>, [‘domain’ =&gt; <span class="string">'www.example.com'</span>, <span class="string">'Illuminate\Tests\Routing\ActionStub'</span>]);</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActionStub</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'hello'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因此，解析 <code>action</code> 主要做两件事：</p>
<ul>
<li><p>为闭包函数添加 <code>use</code> 键。对于此时没有 <code>use</code> 键的路由，由于之前在 <code>Router</code> 中已经为控制器添加 <code>use</code> 键，因此这时没有 <code>use</code> 键的，必然是闭包函数，在这里直接或者在 <code>action</code> 中寻找闭包函数后，为闭包函数添加 <code>use</code> 键。</p>
</li>
<li><p>单动作控制器添加 <code>__invoke</code>。对于单动作控制器来说，此时已经和控制器一样拥有 ‘use’ 键，但是并没有 <code>@</code> 符号，此时就会调用 <code>makeInvokable</code> 函数来将 <code>__invoke</code> 添加到后面。</p>
</li>
</ul>
<h2 id="prefix-前缀"><a href="#prefix-前缀" class="headerlink" title="prefix 前缀"></a>prefix 前缀</h2><p>路由自身也有 <code>prefix</code> 属性，而且这个属性要加在其他 <code>prefix</code> 的最前面,作为路由的 <code>uri</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">prefix</span><span class="params">($prefix)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $uri = rtrim($prefix, <span class="string">'/'</span>).<span class="string">'/'</span>.ltrim(<span class="keyword">$this</span>-&gt;uri, <span class="string">'/'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;uri = trim($uri, <span class="string">'/'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Route-路由属性加载"><a href="#Route-路由属性加载" class="headerlink" title="Route 路由属性加载"></a>Route 路由属性加载</h1><p>除了 <code>RouteRegistrar</code> 之外，<code>Route</code> 也可以为路由添加属性：</p>
<h2 id="prefix-前缀-1"><a href="#prefix-前缀-1" class="headerlink" title="prefix 前缀"></a>prefix 前缀</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">prefix</span><span class="params">($prefix)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $uri = rtrim($prefix, <span class="string">'/'</span>).<span class="string">'/'</span>.ltrim(<span class="keyword">$this</span>-&gt;uri, <span class="string">'/'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;uri = trim($uri, <span class="string">'/'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="where-正则约束"><a href="#where-正则约束" class="headerlink" title="where 正则约束"></a>where 正则约束</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">where</span><span class="params">($name, $expression = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;parseWhere($name, $expression) <span class="keyword">as</span> $name =&gt; $expression) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;wheres[$name] = $expression;</div><div class="line">    &#125;</div><div class="line"> 	</div><div class="line"> 	<span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;     </div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseWhere</span><span class="params">($name, $expression)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> is_array($name) ? $name : [$name =&gt; $expression];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="middleware-中间件"><a href="#middleware-中间件" class="headerlink" title="middleware 中间件"></a>middleware 中间件</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">middleware</span><span class="params">($middleware = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (is_null($middleware)) &#123;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">array</span>) Arr::get(<span class="keyword">$this</span>-&gt;action, <span class="string">'middleware'</span>, []);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (is_string($middleware)) &#123;</div><div class="line">        $middleware = func_get_args();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;action[<span class="string">'middleware'</span>] = array_merge(</div><div class="line">        (<span class="keyword">array</span>) Arr::get(<span class="keyword">$this</span>-&gt;action, <span class="string">'middleware'</span>, []), $middleware</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="uses-控制器"><a href="#uses-控制器" class="headerlink" title="uses 控制器"></a>uses 控制器</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">uses</span><span class="params">($action)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $action = is_string($action) ? <span class="keyword">$this</span>-&gt;addGroupNamespaceToStringUses($action) : $action;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setAction(array_merge(<span class="keyword">$this</span>-&gt;action, <span class="keyword">$this</span>-&gt;parseAction([</div><div class="line">        <span class="string">'uses'</span> =&gt; $action,</div><div class="line">        <span class="string">'controller'</span> =&gt; $action,</div><div class="line">    ])));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="name-命名"><a href="#name-命名" class="headerlink" title="name 命名"></a>name 命名</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">name</span><span class="params">($name)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;action[<span class="string">'as'</span>] = <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;action[<span class="string">'as'</span>]) ? <span class="keyword">$this</span>-&gt;action[<span class="string">'as'</span>].$name : $name;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="RouteCollection-添加路由"><a href="#RouteCollection-添加路由" class="headerlink" title="RouteCollection 添加路由"></a>RouteCollection 添加路由</h1><p>在上面的部分，我们看到添加路由的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addRoute</span><span class="params">($methods, $uri, $action)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;routes-&gt;add(<span class="keyword">$this</span>-&gt;createRoute($methods, $uri, $action));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>新创建的路由会加入到 <code>RouteCollection</code> 中，会更新类中的 <code>routes</code>、<code>allRoutes</code>、<code>nameList</code>、<code>actionList</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(Route $route)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;addToCollections($route);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;addLookups($route);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $route;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addToCollections</span><span class="params">($route)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $domainAndUri = $route-&gt;domain().$route-&gt;uri();</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> ($route-&gt;methods() <span class="keyword">as</span> $method) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;routes[$method][$domainAndUri] = $route;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;allRoutes[$method.$domainAndUri] = $route;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addLookups</span><span class="params">($route)</span></span></div><div class="line"><span class="function"></span>&#123;   </div><div class="line">    $action = $route-&gt;getAction();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($action[<span class="string">'as'</span>])) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;nameList[$action[<span class="string">'as'</span>]] = $route;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">isset</span>($action[<span class="string">'controller'</span>])) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;addToActionList($action, $route);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addToActionList</span><span class="params">($action, $route)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;actionList[trim($action[<span class="string">'controller'</span>], <span class="string">'\\'</span>)] = $route;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们在上面路由的注册启动章节说道，路由的启动是 <code>namespace Illuminate\Foundation\Support\Providers\RouteServiceProvider</code> 完成的，调用的是 <code>boot</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;setRootControllerNamespace();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;app-&gt;routesAreCached()) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;loadCachedRoutes();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;loadRoutes();</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;app-&gt;booted(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;app[<span class="string">'router'</span>]-&gt;getRoutes()-&gt;refreshNameLookups();</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在最后一句，程序将会在所有服务都启动后运行 <code>refreshNameLookups</code> 函数，把所有的 <code>name</code> 属性加载到 <code>RouteCollection</code> 中:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">refreshNameLookups</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;nameList = [];</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;allRoutes <span class="keyword">as</span> $route) &#123;</div><div class="line">        <span class="keyword">if</span> ($route-&gt;getName()) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;nameList[$route-&gt;getName()] = $route;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试样例如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testRouteCollectionCanRefreshNameLookups</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $routeIndex = <span class="keyword">new</span> Route(<span class="string">'GET'</span>, <span class="string">'foo/index'</span>, [</div><div class="line">        <span class="string">'uses'</span> =&gt; <span class="string">'FooController@index'</span>,</div><div class="line">    ]);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertNull($routeIndex-&gt;getName());</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;routeCollection-&gt;add($routeIndex)-&gt;name(<span class="string">'route_name'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertNull(<span class="keyword">$this</span>-&gt;routeCollection-&gt;getByName(<span class="string">'route_name'</span>));</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;routeCollection-&gt;refreshNameLookups();</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals($routeIndex, <span class="keyword">$this</span>-&gt;routeCollection-&gt;getByName(<span class="string">'route_name'</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/07/16/Laravel HTTP——路由/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/16/Laravel HTTP——路由/" itemprop="url">
                  Laravel HTTP——路由
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-16T00:07:00+08:00">
                2017-07-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/laravel/" itemprop="url" rel="index">
                    <span itemprop="name">laravel</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/laravel/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/laravel/php/router/" itemprop="url" rel="index">
                    <span itemprop="name">router</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/16/Laravel HTTP——路由/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/16/Laravel HTTP——路由/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/16/Laravel HTTP——路由/" class="leancloud_visitors" data-flag-title="Laravel HTTP——路由">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>作为一个 web 后台框架，路由无疑是极其重要的一部分。本博客接下来几篇文章都将会围绕路由这一主题来展开讨论，分别讲述：</p>
<blockquote>
<ul>
<li>路由的使用</li>
<li>路由属性注册</li>
<li>路由的正则编译与匹配</li>
<li>路由的中间件</li>
<li>路由的控制器与参数绑定</li>
<li>RESTful 路由</li>
</ul>
</blockquote>
<p>和之前一样，第一篇将会利用单元测试样例说明我们在平时可能用到的 route 的 api 函数用法，后面几篇文章将会剖析 laravel 的 route 源码。下面开始介绍 laravel 中路由的各种用法。</p>
<hr>
<h1 id="路由属性注册"><a href="#路由属性注册" class="headerlink" title="路由属性注册"></a>路由属性注册</h1><p>所有 Laravel 路由都定义在位于 routes 目录下的路由文件中，这些文件通过框架自动加载。routes/web.php 文件定义了 web 界面的路由，这些路由被分配了 web 中间件组，从而可以提供 session 和 csrf 防护等功能。routes/api.php 中的路由是无状态的，被分配了 api 中间件组。</p>
<p>对大多数应用而言，都是从 routes/web.php 文件开始定义路由。</p>
<h2 id="路由-method-方法"><a href="#路由-method-方法" class="headerlink" title="路由 method 方法"></a>路由 method 方法</h2><p>我们可以注册路由来响应任何 HTTP 请求：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Route::get($uri, $callback);</div><div class="line">Route::post($uri, $callback);</div><div class="line">Route::put($uri, $callback);</div><div class="line">Route::patch($uri, $callback);</div><div class="line">Route::delete($uri, $callback);</div><div class="line">Route::options($uri, $callback);</div></pre></td></tr></table></figure>
<p>有时候还需要注册路由响应多个 HTTP 请求——这可以通过 <code>match</code> 方法来实现。或者，可以使用 <code>any</code> 方法注册一个路由来响应所有 HTTP 请求：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Route::match([<span class="string">'get'</span>, <span class="string">'post'</span>], <span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line">Route::any(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>值得注意的是，一般的HTML表单仅仅支持<code>get</code>、<code>post</code>，并不支持<code>put</code>、<code>patch</code>、<code>delete</code>等动作，这时候就需要在前端添加一个隐藏的 <code>_method</code> 字段到给表单中，其值被用作 <code>HTTP</code> 请求方法名：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;input type=<span class="string">"hidden"</span> name=<span class="string">"_method"</span> value=<span class="string">"PUT"</span>&gt;</div></pre></td></tr></table></figure>
<p>在 web 路由文件中所有请求方式为<code>PUT</code>、<code>POST</code>或<code>DELETE</code>的 HTML 表单都会包含一个<code>CSRF</code>令牌字段，否则，请求会被拒绝。关于 <code>CSRF</code> 的更多细节，可以参考 <a href="http://www.cnblogs.com/hyddd/archive/2009/04/09/1432744.html?login=1" target="_blank" rel="external">浅谈CSRF攻击方式</a>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;form method=<span class="string">"POST"</span> action=<span class="string">"/profile"</span>&gt;</div><div class="line">    &#123;&#123; csrf_field() &#125;&#125;</div><div class="line">    ...</div><div class="line">&lt;/form&gt;</div></pre></td></tr></table></figure>
<h2 id="路由-scheme-协议"><a href="#路由-scheme-协议" class="headerlink" title="路由 scheme 协议"></a>路由 scheme 协议</h2><p>对于 web 后台框架来说，路由的 <code>scheme</code> 底层协议一般使用 <code>http</code>、<code>https</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'foo/&#123;bar&#125;'</span>, [<span class="string">'http'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;]);</div><div class="line">Route::get(<span class="string">'foo/&#123;bar&#125;'</span>, [<span class="string">'https'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;]);</div></pre></td></tr></table></figure>
<h2 id="路由-domain-子域名"><a href="#路由-domain-子域名" class="headerlink" title="路由 domain 子域名"></a>路由 domain 子域名</h2><p>子域名可以像 URI 一样被分配给路由参数，子域名可以通过路由属性中的 <code>domain</code> 来指定：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Route::domain(<span class="string">'api.name.bar'</span>)</div><div class="line">     -&gt;get(<span class="string">'foo/bar'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $name;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">Route::get(<span class="string">'foo/bar'</span>, [<span class="string">'domain'</span> =&gt; <span class="string">'api.name.bar'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $name;</div><div class="line">    &#125;]);</div></pre></td></tr></table></figure>
<h2 id="路由-prefix-前缀"><a href="#路由-prefix-前缀" class="headerlink" title="路由 prefix 前缀"></a>路由 prefix 前缀</h2><p>可以为路由添加一个给定 <code>URI</code> 前缀，通过利用路由属性的 <code>prefix</code> 指定：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Route::prefix(<span class="string">'pre'</span>)</div><div class="line">     -&gt;get(<span class="string">'foo/bar'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">Route::get(<span class="string">'foo/bar'</span>, [<span class="string">'prefix'</span> =&gt; <span class="string">'pre'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;]);</div><div class="line">    </div><div class="line">Route::get(<span class="string">'foo/bar'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;)-&gt;prefix(<span class="string">'pre'</span>);</div></pre></td></tr></table></figure>
<h2 id="路由-where-正则约束"><a href="#路由-where-正则约束" class="headerlink" title="路由 where 正则约束"></a>路由 where 正则约束</h2><p>可以为路由的 <code>URI</code> 参数指定正则约束：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'&#123;one&#125;'</span>, [<span class="string">'where'</span> =&gt; [<span class="string">'one'</span> =&gt; <span class="string">'(.+)'</span>], <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;]);</div><div class="line">    </div><div class="line">Route::get(<span class="string">'&#123;one&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;)-&gt;where(<span class="string">'one'</span>, <span class="string">'(.+)'</span>);</div></pre></td></tr></table></figure>
<p>如果想要路由参数在全局范围内被给定正则表达式约束，可以使用 <code>pattern</code> 方法。在 <code>RouteServiceProvider</code> 类的 <code>boot</code> 方法中定义约束模式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    Route::pattern(<span class="string">'one'</span>, <span class="string">'(.+)'</span>);</div><div class="line">    <span class="keyword">parent</span>::boot();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="路由-middleware-中间件"><a href="#路由-middleware-中间件" class="headerlink" title="路由 middleware 中间件"></a>路由 middleware 中间件</h2><p>为路由添加中间件，通过利用路由属性的 <code>middleware</code> 指定：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Route::middleware(<span class="string">'web'</span>)</div><div class="line">     -&gt;get(<span class="string">'foo/bar'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">Route::get(<span class="string">'foo/bar'</span>, [<span class="string">'middleware'</span> =&gt; <span class="string">'web'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;]);</div><div class="line"></div><div class="line">Route::get(<span class="string">'foo/bar'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;)-&gt;middleware(<span class="string">'web'</span>);</div></pre></td></tr></table></figure>
<h2 id="路由-namespace-属性"><a href="#路由-namespace-属性" class="headerlink" title="路由 namespace 属性"></a>路由 namespace 属性</h2><p>可以为路由的控制器添加 <code>namespace</code> 来指定控制器的命名空间：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Route::namespace(<span class="string">'Namespace\\Example\\'</span>)</div><div class="line">     -&gt;get(<span class="string">'foo/bar'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">Route::get(<span class="string">'foo/bar'</span>, [<span class="string">'namespace'</span> =&gt; <span class="string">'Namespace\\Example\\'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;]);</div></pre></td></tr></table></figure>
<h2 id="路由-uses-属性"><a href="#路由-uses-属性" class="headerlink" title="路由 uses 属性"></a>路由 uses 属性</h2><p>可以为路由添加 <code>URI</code> 对应的执行逻辑，例如闭包或者控制器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'foo/bar'</span>, [<span class="string">'uses'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;]);</div><div class="line">    </div><div class="line">Route::get(<span class="string">'foo/bar'</span>, [<span class="string">'uses'</span> =&gt; ‘Illuminate\Tests\Routing\RouteTestControllerStub@index’]);</div><div class="line"></div><div class="line">Route::get(<span class="string">'foo/bar'</span>)-&gt;uses(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">Route::get(<span class="string">'foo/bar'</span>)-&gt;uses(‘Illuminate\Tests\Routing\RouteTestControllerStub@index’);</div></pre></td></tr></table></figure>
<h2 id="路由-as-别名"><a href="#路由-as-别名" class="headerlink" title="路由 as 别名"></a>路由 as 别名</h2><p>可以为路由指定别名，通过路由属性的 <code>as</code> 来指定：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Route::as(<span class="string">'Foo'</span>)</div><div class="line">     -&gt;get(<span class="string">'foo/bar'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">Route::name(<span class="string">'Foo'</span>)</div><div class="line">     -&gt;get(<span class="string">'foo/bar'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">Route::get(<span class="string">'foo/bar'</span>, [<span class="string">'as'</span> =&gt; <span class="string">'Foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;]);</div><div class="line"></div><div class="line">Route::get(<span class="string">'foo/bar'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;)-&gt;name(<span class="string">'Foo'</span>);</div></pre></td></tr></table></figure>
<h2 id="路由-group-群组属性"><a href="#路由-group-群组属性" class="headerlink" title="路由 group 群组属性"></a>路由 group 群组属性</h2><p>可以为一系列具有类似属性的路由归为同一组，利用 <code>group</code> 将这些路由归并到一起：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">Route::group([<span class="string">'domain'</span>     =&gt; <span class="string">'group.domain.name'</span>,</div><div class="line">              <span class="string">'prefix'</span>     =&gt; <span class="string">'grouppre'</span>,</div><div class="line">              <span class="string">'where'</span>      =&gt; [<span class="string">'one'</span> =&gt; <span class="string">'(.+)'</span>], </div><div class="line">              <span class="string">'middleware'</span> =&gt; <span class="string">'groupMiddleware'</span>,</div><div class="line">              <span class="string">'namespace'</span>  =&gt; <span class="string">'Namespace\\Group\\'</span>, </div><div class="line">              <span class="string">'as'</span>         =&gt; <span class="string">'Group::'</span>,]</div><div class="line">              <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">                  Route::get(<span class="string">'/replace'</span>,‘domain’ =&gt; <span class="string">'route.domain.name'</span>，</div><div class="line">                                        <span class="string">'uses'</span>   =&gt; <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">                                        <span class="keyword">return</span> <span class="string">'replace'</span>;</div><div class="line">                  &#125;);</div><div class="line"></div><div class="line">                 Route::get(<span class="string">'additional/&#123;one&#125;/&#123;two&#125;'</span>, <span class="string">'prefix'</span>     =&gt; <span class="string">'routepre'</span>,</div><div class="line">                                                      <span class="string">'where'</span>      =&gt; <span class="string">'['</span>one<span class="string">' =&gt; '</span>([<span class="number">0</span><span class="number">-9</span>]+)<span class="string">','</span>two<span class="string">' =&gt; '</span>(.+)<span class="string">']'</span>,</div><div class="line">                                                      <span class="string">'middleware'</span> =&gt; <span class="string">'routeMiddleware'</span>,</div><div class="line">                                                      <span class="string">'namespace'</span>  =&gt; <span class="string">'Namespace\\Group\\'</span>, </div><div class="line">                                                      <span class="string">'as'</span>         =&gt; <span class="string">'Route'</span>,</div><div class="line">                                                      <span class="string">'use         =&gt; '</span><span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">                                                      <span class="keyword">return</span> <span class="string">'additional'</span>;</div><div class="line">                 &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'replace'</span>, $router-&gt;dispatch(Request::create(<span class="string">'http://route.domain.name/grouppre/replace'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'additional'</span>, $router-&gt;dispatch(Request::create(<span class="string">'http://group.domain.name/routepre/grouppre/additional/111/add'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line"></div><div class="line">$routes = $router-&gt;getRoutes()-&gt;getRoutes();</div><div class="line">$action = $routes[<span class="number">0</span>]-&gt;getAction();</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'Namespace\\Group\\'</span>, $action[<span class="string">'namespace'</span>]);</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'Group::'</span>, $action[<span class="string">'as'</span>]);</div><div class="line"></div><div class="line">$routes = $router-&gt;getRoutes()-&gt;getRoutes();</div><div class="line">$action = $routes[<span class="number">1</span>]-&gt;getAction();</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals([<span class="string">'groupMiddleware'</span>, <span class="string">'routeMiddleware'</span>], $action[<span class="string">'middleware'</span>]);</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'Namespace\\Group\\Namespace\\Group\\'</span>, $action[<span class="string">'namespace'</span>]);</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'Group::Route'</span>, $action[<span class="string">'as'</span>]);</div></pre></td></tr></table></figure>
<p><code>group</code> 群组的属性分为两类：替换型、递增型。当群组属性与路由属性重复的时候，替换型属性会用路由的属性替换群组的属性，递增型的属性会综合路由和群组的属性。</p>
<p>在上面的例子可以看出：</p>
<ul>
<li><code>domain</code> 这个属性是替换型属性，路由的属性会覆盖和替换群组的这几个属性；</li>
<li><code>prefix</code>、<code>middleware</code>、<code>namespace</code>、<code>as</code> 、<code>where</code> 这几个属性是递增型属性，路由的属性和群组属性会相互结合。</li>
</ul>
<p>另外值得注意的是：</p>
<ul>
<li>路由的 <code>prefix</code> 属性具有优先级,因此上面第二个路由的 <code>uri</code> 是 <code>routepre/grouppre/additional/111/add</code>,而不是 <code>grouppre/routepre/additional/111/add</code>；</li>
<li><code>where</code>属性对于相同的路由参数会替换，不同的路由参数会结合，因此上面 <code>where</code> 中 <code>one</code> 被替换，<code>two</code> 被结合进来</li>
</ul>
<h1 id="路由参数与匹配"><a href="#路由参数与匹配" class="headerlink" title="路由参数与匹配"></a>路由参数与匹配</h1><p>laravel 允许在注册定义路由的时候设定路由参数，以供控制器或者闭包所用。路由参数可以设定在 <code>URI</code> 中，也可以设定在 <code>domain</code> 中。</p>
<h2 id="路由编码匹配"><a href="#路由编码匹配" class="headerlink" title="路由编码匹配"></a>路由编码匹配</h2><p>对于已编码的请求 <code>URI</code>，框架会自动进行解码然后进行匹配:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line"> $router-&gt;get(<span class="string">'foo/bar/åαф'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> <span class="string">'hello'</span>;</div><div class="line">&#125;);</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'hello'</span>, $router-&gt;dispatch(Request::create(<span class="string">'foo/bar/%C3%A5%CE%B1%D1%84'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line"></div><div class="line">$router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">$route = $router-&gt;get(<span class="string">'foo/&#123;file&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($file)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> $file;</div><div class="line">&#125;);</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'oxygen%20'</span>, $router-&gt;dispatch(Request::create(<span class="string">'http://test.com/foo/oxygen%2520'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div></pre></td></tr></table></figure>
<h2 id="路由参数"><a href="#路由参数" class="headerlink" title="路由参数"></a>路由参数</h2><p>路由参数总是通过花括号进行包裹，这些参数在路由被执行时会被传递到路由的闭包。路由参数不能包含 - 字符，需要的话可以使用 _ 替代。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">$router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">$route = $router-&gt;get(<span class="string">'foo/&#123;age&#125;'</span>, [<span class="string">'domain'</span> =&gt; <span class="string">'api.&#123;name&#125;.bar'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($name, $age)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> $name.$age;</div><div class="line">&#125;]);</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'taylor25'</span>, $router-&gt;dispatch(Request::create(<span class="string">'http://api.taylor.bar/foo/25'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line"></div><div class="line">$route = <span class="keyword">new</span> Route(<span class="string">'GET'</span>, <span class="string">'images/&#123;id&#125;.&#123;ext&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">$request1 = Request::create(<span class="string">'images/1.png'</span>, <span class="string">'GET'</span>);</div><div class="line"><span class="keyword">$this</span>-&gt;assertTrue($route-&gt;matches($request1));</div><div class="line">$route-&gt;bind($request1);</div><div class="line"><span class="keyword">$this</span>-&gt;assertTrue($route-&gt;hasParameter(<span class="string">'id'</span>));</div><div class="line"><span class="keyword">$this</span>-&gt;assertFalse($route-&gt;hasParameter(<span class="string">'foo'</span>));</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'1'</span>, $route-&gt;parameter(<span class="string">'id'</span>));</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'png'</span>, $route-&gt;parameter(<span class="string">'ext'</span>));</div></pre></td></tr></table></figure>
<h2 id="路由可选参数"><a href="#路由可选参数" class="headerlink" title="路由可选参数"></a>路由可选参数</h2><p>有时候可能需要指定可选的路由参数，这可以通过在参数名后加一个 ? 标记来实现，这种情况下需要给相应的变量指定默认值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">$router-&gt;get(<span class="string">'&#123;foo?&#125;/&#123;baz?&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($name = <span class="string">'taylor'</span>, $age = <span class="number">25</span>)</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> $name.$age;</div><div class="line">&#125;);</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'fred25'</span>, $router-&gt;dispatch(Request::create(<span class="string">'fred'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line"></div><div class="line">$router-&gt;get(<span class="string">'default/&#123;foo?&#125;/&#123;baz?&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($name, $age = <span class="number">25</span>)</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> $name.$age;</div><div class="line">&#125;)-&gt;default(<span class="string">'name'</span>, <span class="string">'taylor'</span>);</div><div class="line"><span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'fred25'</span>, $router-&gt;dispatch(Request::create(<span class="string">'fred'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div></pre></td></tr></table></figure>
<h2 id="路由参数正则约束"><a href="#路由参数正则约束" class="headerlink" title="路由参数正则约束"></a>路由参数正则约束</h2><p>可以使用路由实例上的 <code>where</code> 方法来约束路由参数的格式。<code>where</code> 方法接收参数名和一个正则表达式来定义该参数如何被约束：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'user/&#123;name&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">    <span class="comment">//</span></div><div class="line">&#125;)-&gt;where(<span class="string">'name'</span>, <span class="string">'[A-Za-z]+'</span>);</div></pre></td></tr></table></figure>
<p>如果想要路由参数在全局范围内被给定正则表达式约束，可以使用 <code>pattern</code> 方法。在 <code>RouteServiceProvider</code> 类的 <code>boot</code> 方法中定义约束模式:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    Route::pattern(<span class="string">'id'</span>, <span class="string">'[0-9]+'</span>);</div><div class="line">    <span class="keyword">parent</span>::boot();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>值得注意的是，路由参数是不允许出现 <code>/</code> 字符的，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$router-&gt;get(<span class="string">'&#123;one?&#125;'</span>, [</div><div class="line">            <span class="string">'uses'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($one = null)</span></span>&#123;</div><div class="line">                 <span class="keyword">return</span> $one;</div><div class="line">            &#125;,</div><div class="line">        ]);</div><div class="line">$request = Request::create(<span class="string">'foo/bar/baz'</span>, <span class="string">'GET'</span>);</div><div class="line"><span class="keyword">$this</span>-&gt;assertFalse($route-&gt;matches($request2));</div></pre></td></tr></table></figure>
<p>上例中 <code>one</code> 只能匹配 <code>foo</code>，不能匹配 <code>foo/bar/baz</code>,这时就需要对 <code>one</code> 进行正则约束：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testLeadingParamDoesntReceiveForwardSlashOnEmptyPath</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">    $router-&gt;get(<span class="string">'&#123;one?&#125;'</span>, [</div><div class="line">            <span class="string">'uses'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($one = null)</span></span>&#123;</div><div class="line">                 <span class="keyword">return</span> $one;</div><div class="line">            &#125;,</div><div class="line">            <span class="string">'where'</span> =&gt; [<span class="string">'one'</span> =&gt; <span class="string">'(.+)'</span>],</div><div class="line">        ]);</div><div class="line">        </div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'foo'</span>, $router-&gt;dispatch(Request::create(<span class="string">'/foo'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'foo/bar/baz'</span>, $router-&gt;dispatch(Request::create(<span class="string">'/foo/bar/baz'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="路由中间件"><a href="#路由中间件" class="headerlink" title="路由中间件"></a>路由中间件</h1><p>HTTP 中间件为过滤进入应用的 HTTP 请求提供了一套便利的机制。例如，Laravel 内置了一个中间件来验证用户是否经过认证，如果用户没有经过认证，中间件会将用户重定向到登录页面，否则如果用户经过认证，中间件就会允许请求继续往前进入下一步操作。</p>
<p>Laravel框架自带了一些中间件，包括认证、CSRF 保护中间件等等。所有的中间件都位于 app/Http/Middleware 目录。</p>
<h2 id="中间件之前-之后-终止"><a href="#中间件之前-之后-终止" class="headerlink" title="中间件之前/之后/终止"></a>中间件之前/之后/终止</h2><p>一个中间件是请求前还是请求后执行取决于中间件本身。比如，以下中间件会在请求处理前执行一些任务：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BeforeMiddleware</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="comment">// 执行动作</span></div><div class="line"></div><div class="line">        <span class="keyword">return</span> $next($request);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AfterMiddleware</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $response = $next($request);</div><div class="line"></div><div class="line">        <span class="comment">// 执行动作</span></div><div class="line"></div><div class="line">        <span class="keyword">return</span> $response;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有时候中间件可能需要在 HTTP 响应发送到浏览器之后做一些工作。比如，Laravel 内置的“session”中间件会在响应发送到浏览器之后将 Session 数据写到存储器中，为了实现这个功能，需要定义一个终止中间件并添加 terminate 方法到这个中间件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StartSession</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> $next($request);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">terminate</span><span class="params">($request, $response)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="comment">// 存储session数据...</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="全局中间件"><a href="#全局中间件" class="headerlink" title="全局中间件"></a>全局中间件</h2><p>如果你想要中间件在每一个 HTTP 请求期间被执行，只需要将相应的中间件类设置到 <code>app/Http/Kernel.php</code> 的数组属性 <code>$middleware</code> 中即可。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $middleware = [</div><div class="line">        \Illuminate\Foundation\Http\Middleware\CheckForMaintenanceMode::class,</div><div class="line">        \Illuminate\Foundation\Http\Middleware\ValidatePostSize::class,</div><div class="line">        \App\Http\Middleware\TrimStrings::class,</div><div class="line">        \Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull::class,</div><div class="line">    ];</div></pre></td></tr></table></figure>
<h2 id="路由中间件-1"><a href="#路由中间件-1" class="headerlink" title="路由中间件"></a>路由中间件</h2><p>如果你想要分配中间件到指定路由，可以传递完整的类名：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>\<span class="title">CheckAge</span>;</div><div class="line"></div><div class="line">Route::get(<span class="string">'admin/profile'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//</span></div><div class="line">&#125;)-&gt;middleware(CheckAge::class);</div></pre></td></tr></table></figure>
<p>或者可以给中间件提供一个别名：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testDefinedClosureMiddleware</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">    $router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">    $router-&gt;get(<span class="string">'foo/bar'</span>, [<span class="string">'middleware'</span> =&gt; <span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'hello'</span>;</div><div class="line">    &#125;]);</div><div class="line">    $router-&gt;aliasMiddleware(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($request, $next)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'caught'</span>;</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'caught'</span>, $router-&gt;dispatch(Request::create(<span class="string">'foo/bar'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>也可以应该在 <code>app/Http/Kernel.php</code> 文件中分配给该中间件一个 <code>key</code>，默认情况下，该类的 <code>$routeMiddleware</code> 属性包含了 <code>Laravel</code> 自带的中间件，要添加你自己的中间件，只需要将其追加到后面并为其分配一个 <code>key</code>，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $routeMiddleware = [</div><div class="line">    <span class="string">'auth'</span> =&gt; \Illuminate\Auth\Middleware\Authenticate::class,</div><div class="line">    <span class="string">'auth.basic'</span> =&gt; \Illuminate\Auth\Middleware\AuthenticateWithBasicAuth::class,</div><div class="line">    <span class="string">'bindings'</span> =&gt; \Illuminate\Routing\Middleware\SubstituteBindings::class,</div><div class="line">    <span class="string">'can'</span> =&gt; \Illuminate\Auth\Middleware\Authorize::class,</div><div class="line">    <span class="string">'guest'</span> =&gt; \App\Http\Middleware\RedirectIfAuthenticated::class,</div><div class="line">    <span class="string">'throttle'</span> =&gt; \Illuminate\Routing\Middleware\ThrottleRequests::class,</div><div class="line">];</div><div class="line"></div><div class="line">Route::get(<span class="string">'admin/profile'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//</span></div><div class="line">&#125;)-&gt;middleware(<span class="string">'auth'</span>);</div></pre></td></tr></table></figure>
<p>使用数组分配多个中间件到路由：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//</span></div><div class="line">&#125;)-&gt;middleware(<span class="string">'first'</span>, <span class="string">'second'</span>);</div></pre></td></tr></table></figure>
<h2 id="中间件组"><a href="#中间件组" class="headerlink" title="中间件组"></a>中间件组</h2><p>有时候你可能想要通过指定一个键名的方式将相关中间件分到同一个组里面，从而更方便将其分配到路由中，这可以通过使用 <code>HTTP Kernel</code> 的 <code>$middlewareGroups</code> 属性实现。</p>
<p><code>Laravel</code> 自带了开箱即用的 <code>web</code> 和 <code>api</code> 两个中间件组以分别包含可以应用到 <code>Web UI</code> 和 <code>API</code> 路由的通用中间件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $middlewareGroups = [</div><div class="line">    <span class="string">'web'</span> =&gt; [</div><div class="line">        \App\Http\Middleware\EncryptCookies::class,</div><div class="line">        \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,</div><div class="line">        \Illuminate\Session\Middleware\StartSession::class,</div><div class="line">        \Illuminate\View\Middleware\ShareErrorsFromSession::class,</div><div class="line">        \App\Http\Middleware\VerifyCsrfToken::class,</div><div class="line">        \Illuminate\Routing\Middleware\SubstituteBindings::class,</div><div class="line">    ],</div><div class="line"></div><div class="line">    <span class="string">'api'</span> =&gt; [</div><div class="line">        <span class="string">'throttle:60,1'</span>,</div><div class="line">        <span class="string">'auth:api'</span>,</div><div class="line">    ],</div><div class="line">];</div><div class="line"></div><div class="line">Route::get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//</span></div><div class="line">&#125;)-&gt;middleware(<span class="string">'web'</span>);</div></pre></td></tr></table></figure>
<p>值得注意的是，中间件组中可以循环嵌套中间件组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testMiddlewareGroupsCanReferenceOtherGroups</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">    <span class="keyword">unset</span>($_SERVER[<span class="string">'__middleware.group'</span>]);</div><div class="line">    $router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">    $router-&gt;get(<span class="string">'foo/bar'</span>, [<span class="string">'middleware'</span> =&gt; <span class="string">'web'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'hello'</span>;</div><div class="line">    &#125;]);</div><div class="line"></div><div class="line">    $router-&gt;aliasMiddleware(<span class="string">'two'</span>, <span class="string">'Illuminate\Tests\Routing\RoutingTestMiddlewareGroupTwo'</span>);</div><div class="line">    $router-&gt;middlewareGroup(<span class="string">'first'</span>, [<span class="string">'two:abigail'</span>]);</div><div class="line">    $router-&gt;middlewareGroup(<span class="string">'web'</span>, [<span class="string">'Illuminate\Tests\Routing\RoutingTestMiddlewareGroupOne'</span>, <span class="string">'first'</span>]);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'caught abigail'</span>, $router-&gt;dispatch(Request::create(<span class="string">'foo/bar'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line">    <span class="keyword">$this</span>-&gt;assertTrue($_SERVER[<span class="string">'__middleware.group'</span>]);</div><div class="line"></div><div class="line">    <span class="keyword">unset</span>($_SERVER[<span class="string">'__middleware.group'</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="中间件参数"><a href="#中间件参数" class="headerlink" title="中间件参数"></a>中间件参数</h2><p>中间件还可以接收额外的自定义参数，例如，如果应用需要在执行给定动作之前验证认证用户是否拥有指定的角色，可以创建一个 <code>CheckRole</code> 来接收角色名作为额外参数。</p>
<p>额外的中间件参数会在 <code>$next</code> 参数之后传入中间件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CheckRole</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next, $role)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (! $request-&gt;user()-&gt;hasRole($role)) &#123;</div><div class="line">            <span class="comment">// Redirect...</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $next($request);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">Route::put(<span class="string">'post/&#123;id&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($id)</span> </span>&#123;</div><div class="line">    <span class="comment">//</span></div><div class="line">&#125;)-&gt;middleware(<span class="string">'role:editor'</span>);</div></pre></td></tr></table></figure>
<h2 id="中间件的顺序"><a href="#中间件的顺序" class="headerlink" title="中间件的顺序"></a>中间件的顺序</h2><p>当 <code>router</code> 中有多个中间件的时候，中间件的执行顺序并不是严格按照中间件数组进行的，框架中存在一个数组 <code>$middlewarePriority</code>,规定了这个数组中各个中间件的顺序：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $middlewarePriority = [</div><div class="line">        \Illuminate\Session\Middleware\StartSession::class,</div><div class="line">        \Illuminate\View\Middleware\ShareErrorsFromSession::class,</div><div class="line">        \Illuminate\Auth\Middleware\Authenticate::class,</div><div class="line">        \Illuminate\Session\Middleware\AuthenticateSession::class,</div><div class="line">        \Illuminate\Routing\Middleware\SubstituteBindings::class,</div><div class="line">        \Illuminate\Auth\Middleware\Authorize::class,</div><div class="line">    ];</div></pre></td></tr></table></figure>
<p>当我们使用了上面其中多个中间件的时候，框架会自动按照上面的数组进行排序：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testMiddlewarePrioritySorting</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $middleware = [</div><div class="line">        Placeholder1::class,</div><div class="line">        SubstituteBindings::class,</div><div class="line">        Placeholder2::class,</div><div class="line">        Authenticate::class,</div><div class="line">        Placeholder3::class,</div><div class="line">    ];</div><div class="line"></div><div class="line">    $router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line"></div><div class="line">    $router-&gt;middlewarePriority = [Authenticate::class, SubstituteBindings::class, Authorize::class];</div><div class="line"></div><div class="line">    $route = $router-&gt;get(<span class="string">'foo'</span>, [<span class="string">'middleware'</span> =&gt; $middleware, <span class="string">'uses'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $name;</div><div class="line">    &#125;]);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals([</div><div class="line">        Placeholder1::class,</div><div class="line">        Authenticate::class,</div><div class="line">        SubstituteBindings::class,</div><div class="line">        Placeholder2::class,</div><div class="line">        Placeholder3::class,</div><div class="line">    ], $router-&gt;gatherRouteMiddleware($route));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h1><h2 id="控制器类"><a href="#控制器类" class="headerlink" title="控制器类"></a>控制器类</h2><p>更普遍的方法是使用控制器来组织管理这些行为。控制器可以将相关的 <code>HTTP</code> 请求封装到一个类中进行处理。通常控制器存放在 <code>app/Http/Controllers</code> 目录中.</p>
<p>所有的 Laravel 控制器应该继承自 Laravel 自带的控制器基类 <code>Controller</code>，控制器基类提供了一些很方便的方法如 <code>middleware</code>，用于添加中间件到控制器动作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">($id)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> view(<span class="string">'user.profile'</span>, [<span class="string">'user'</span> =&gt; User::findOrFail($id)]);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Route::get(<span class="string">'user/&#123;id&#125;'</span>, <span class="string">'UserController@show'</span>);</div></pre></td></tr></table></figure>
<h2 id="单动作控制器"><a href="#单动作控制器" class="headerlink" title="单动作控制器"></a>单动作控制器</h2><p>如果想要定义一个只处理一个动作的控制器，可以在这个控制器中定义 __invoke 方法,当为这个单动作控制器注册路由的时候，不需要指定方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testDispatchingCallableActionClasses</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">    $router-&gt;get(<span class="string">'foo/bar'</span>, <span class="string">'Illuminate\Tests\Routing\ActionStub'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'hello'</span>, $router-&gt;dispatch(Request::create(<span class="string">'foo/bar'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line"></div><div class="line">    $router-&gt;get(<span class="string">'foo/bar2'</span>, [</div><div class="line">        <span class="string">'uses'</span> =&gt; <span class="string">'Illuminate\Tests\Routing\ActionStub@func'</span>,</div><div class="line">    ]);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'hello2'</span>, $router-&gt;dispatch(Request::create(<span class="string">'foo/bar2'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActionStub</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'hello'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="控制器中间件"><a href="#控制器中间件" class="headerlink" title="控制器中间件"></a>控制器中间件</h2><p>将中间件放在控制器构造函数中更方便，在控制器的构造函数中使用 middleware 方法你可以很轻松的分配中间件给该控制器。你甚至可以限定该中间件应用到该控制器类的指定方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;middleware(<span class="string">'auth'</span>);</div><div class="line">        <span class="keyword">$this</span>-&gt;middleware(<span class="string">'log'</span>)-&gt;only(<span class="string">'index'</span>);</div><div class="line">        <span class="keyword">$this</span>-&gt;middleware(<span class="string">'subscribed'</span>)-&gt;except(<span class="string">'store'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="callAction-方法"><a href="#callAction-方法" class="headerlink" title="callAction 方法"></a>callAction 方法</h2><p>值得注意的是每次执行控制器方法都会先执行控制器的 <code>callAction</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">callAction</span><span class="params">($method, $parameters)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> call_user_func_array([<span class="keyword">$this</span>, $method], $parameters);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试样例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">unset</span>($_SERVER[<span class="string">'__test.controller_callAction_parameters'</span>]);</div><div class="line">$router-&gt;get(($str = str_random()).<span class="string">'/&#123;one&#125;/&#123;two&#125;'</span>, <span class="string">'Illuminate\Tests\Routing\RouteTestAnotherControllerWithParameterStub@oneArgument'</span>);</div><div class="line">$router-&gt;dispatch(Request::create($str.<span class="string">'/one/two'</span>, <span class="string">'GET'</span>));</div><div class="line"> <span class="keyword">$this</span>-&gt;assertEquals([<span class="string">'one'</span> =&gt; <span class="string">'one'</span>, <span class="string">'two'</span> =&gt; <span class="string">'two'</span>], $_SERVER[<span class="string">'__test.controller_callAction_parameters'</span>]);</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteTestAnotherControllerWithParameterStub</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">callAction</span><span class="params">($method, $parameters)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $_SERVER[<span class="string">'__test.controller_callAction_parameters'</span>] = $parameters;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">oneArgument</span><span class="params">($one)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="call方法"><a href="#call方法" class="headerlink" title="__call方法"></a>__call方法</h2><p>和普通类一样，若控制器中没有对应 <code>classname@method</code> 中的 <code>method</code> ,则会调用类的 <code>__call</code> 函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testCallableControllerRouting</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line"></div><div class="line">    $router-&gt;get(<span class="string">'foo/bar'</span>, <span class="string">'Illuminate\Tests\Routing\RouteTestControllerCallableStub@bar'</span>);</div><div class="line">    $router-&gt;get(<span class="string">'foo/baz'</span>, <span class="string">'Illuminate\Tests\Routing\RouteTestControllerCallableStub@baz'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'bar'</span>, $router-&gt;dispatch(Request::create(<span class="string">'foo/bar'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'baz'</span>, $router-&gt;dispatch(Request::create(<span class="string">'foo/baz'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteTestControllerCallableStub</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $arguments = [])</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> $method;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="路由参数依赖注入与绑定"><a href="#路由参数依赖注入与绑定" class="headerlink" title="路由参数依赖注入与绑定"></a>路由参数依赖注入与绑定</h1><p>Laravel 使用服务容器解析所有的 Laravel 控制器，因此，可以在控制器的构造函数中类型声明任何依赖，这些依赖会被自动解析并注入到控制器实例中。路由的参数绑定可以分为两种：显示绑定与隐示绑定。</p>
<h2 id="路由隐示绑定"><a href="#路由隐示绑定" class="headerlink" title="路由隐示绑定"></a>路由隐示绑定</h2><ul>
<li>控制器方法期望输入路由参数，只需要将路由参数放到其他依赖之后</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Route::put(<span class="string">'user/&#123;id&#125;'</span>, <span class="string">'UserController@update'</span>);</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(Request $request, $id)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>可以在控制器的动作方法中进行依赖的类型提示，例如，我们可以在某个方法中类型提示 <code>Illuminate\Http\Request</code> 实例：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span><span class="params">(Request $request)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $name = $request-&gt;input(<span class="string">'name'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>可以为控制器的动作方法中添加数据库模型的主键，框架会自动利用主键来获取对应的记录，需要注意的是，route定义路由的路由参数必须和控制器内的变量名相同，例如下例中路由参数 <code>userid</code> 和控制器参数 <code>userid</code>:</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Route::put(<span class="string">'user/&#123;userid&#125;'</span>, <span class="string">'UserController@update'</span>);</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(UserModel $userid)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $userid-&gt;name = <span class="string">'taylor'</span>;</div><div class="line">        $userid-&gt;update();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>综合测试样例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testImplicitBindingsWithOptionalParameter</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">unset</span>($_SERVER[<span class="string">'__test.controller_callAction_parameters'</span>]);</div><div class="line">    $router-&gt;get(($str = str_random()).<span class="string">'/&#123;user&#125;/&#123;defaultNull?&#125;/&#123;team?&#125;'</span>, [</div><div class="line">        <span class="string">'middleware'</span> =&gt; SubstituteBindings::class,</div><div class="line">        <span class="string">'uses'</span> =&gt; <span class="string">'Illuminate\Tests\Routing\RouteTestAnotherControllerWithParameterStub@withModels'</span>,</div><div class="line">    ]);</div><div class="line">    </div><div class="line">    $router-&gt;dispatch(Request::create($str.<span class="string">'/1'</span>, <span class="string">'GET'</span>));</div><div class="line"></div><div class="line">    $values = array_values($_SERVER[<span class="string">'__test.controller_callAction_parameters'</span>]);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertInstanceOf(<span class="string">'Illuminate\Http\Request'</span>, $values[<span class="number">0</span>]);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="number">1</span>, $values[<span class="number">1</span>]-&gt;value);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertNull($values[<span class="number">2</span>]);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertInstanceOf(<span class="string">'Illuminate\Tests\Routing\RoutingTestTeamModel'</span>, $values[<span class="number">3</span>]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteTestAnotherControllerWithParameterStub</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">callAction</span><span class="params">($method, $parameters)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $_SERVER[<span class="string">'__test.controller_callAction_parameters'</span>] = $parameters;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">withModels</span><span class="params">(Request $request, RoutingTestUserModel $user, $defaultNull = null, RoutingTestTeamModel $team = null)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RoutingTestUserModel</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRouteKeyName</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'id'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">where</span><span class="params">($key, $value)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;value = $value;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">first</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">firstOrFail</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RoutingTestTeamModel</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRouteKeyName</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'id'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">where</span><span class="params">($key, $value)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;value = $value;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">first</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">firstOrFail</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="路由显示绑定"><a href="#路由显示绑定" class="headerlink" title="路由显示绑定"></a>路由显示绑定</h2><p>除了隐示地转化路由参数外，我们还可以给路由参数显示提供绑定。显示绑定有 <code>bind</code>、<code>model</code> 两种方法。</p>
<ul>
<li>通过 <code>bind</code> 为参数绑定闭包函数：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testRouteBinding</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">    $router-&gt;get(<span class="string">'foo/&#123;bar&#125;'</span>, [<span class="string">'middleware'</span> =&gt; SubstituteBindings::class, <span class="string">'uses'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">         <span class="keyword">return</span> $name;</div><div class="line">    &#125;]);</div><div class="line">    $router-&gt;bind(<span class="string">'bar'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($value)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> strtoupper($value);</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'TAYLOR'</span>, $router-&gt;dispatch(Request::create(<span class="string">'foo/taylor'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>通过 <code>bind</code> 为参数绑定类方法，可以指定 <code>classname@method</code>，也可以直接使用类名，默认会调用类的 <code>bind</code> 函数：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testRouteClassBinding</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">    $router-&gt;get(<span class="string">'foo/&#123;bar&#125;'</span>, [<span class="string">'middleware'</span> =&gt; SubstituteBindings::class, <span class="string">'uses'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">    	<span class="keyword">return</span> $name;</div><div class="line">    &#125;]);</div><div class="line">    $router-&gt;bind(<span class="string">'bar'</span>, <span class="string">'Illuminate\Tests\Routing\RouteBindingStub'</span>);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'TAYLOR'</span>, $router-&gt;dispatch(Request::create(<span class="string">'foo/taylor'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testRouteClassMethodBinding</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">    $router-&gt;get(<span class="string">'foo/&#123;bar&#125;'</span>, [<span class="string">'middleware'</span> =&gt; SubstituteBindings::class, <span class="string">'uses'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $name;</div><div class="line">    &#125;]);</div><div class="line">    $router-&gt;bind(<span class="string">'bar'</span>, <span class="string">'Illuminate\Tests\Routing\RouteBindingStub@find'</span>);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'dragon'</span>, $router-&gt;dispatch(Request::create(<span class="string">'foo/Dragon'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteBindingStub</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span><span class="params">($value, $route)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> strtoupper($value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">find</span><span class="params">($value, $route)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> strtolower($value);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>通过 <code>model</code> 为参数绑定数据库模型，路由的参数就不需要和控制器方法中的变量名相同，<code>laravel</code> 会利用路由参数的值去调用 <code>where</code> 方法查找对应记录：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($model = $instance-&gt;where($instance-&gt;getRouteKeyName(), $value)-&gt;first()) &#123;</div><div class="line">     <span class="keyword">return</span> $model;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试样例如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testModelBinding</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">    $router-&gt;get(<span class="string">'foo/&#123;bar&#125;'</span>, [<span class="string">'middleware'</span> =&gt; SubstituteBindings::class, <span class="string">'uses'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $name;</div><div class="line">    &#125;]);</div><div class="line">    $router-&gt;model(<span class="string">'bar'</span>, <span class="string">'Illuminate\Tests\Routing\RouteModelBindingStub'</span>);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'TAYLOR'</span>, $router-&gt;dispatch(Request::create(<span class="string">'foo/taylor'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteModelBindingStub</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRouteKeyName</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'id'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">where</span><span class="params">($key, $value)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;value = $value;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">first</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> strtoupper(<span class="keyword">$this</span>-&gt;value);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>若绑定的 <code>model</code> 并没有找到对应路由参数的记录，可以在 <code>model</code> 中定义一个闭包函数，路由参数会调用闭包函数：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testModelBindingWithCustomNullReturn</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">    $router-&gt;get(<span class="string">'foo/&#123;bar&#125;'</span>, [<span class="string">'middleware'</span> =&gt; SubstituteBindings::class, <span class="string">'uses'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $name;</div><div class="line">    &#125;]);</div><div class="line">    $router-&gt;model(<span class="string">'bar'</span>, <span class="string">'Illuminate\Tests\Routing\RouteModelBindingNullStub'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'missing'</span>;</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'missing'</span>, $router-&gt;dispatch(Request::create(<span class="string">'foo/taylor'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testModelBindingWithBindingClosure</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">    $router-&gt;get(<span class="string">'foo/&#123;bar&#125;'</span>, [<span class="string">'middleware'</span> =&gt; SubstituteBindings::class, <span class="string">'uses'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $name;</div><div class="line">    &#125;]);</div><div class="line">    $router-&gt;model(<span class="string">'bar'</span>, <span class="string">'Illuminate\Tests\Routing\RouteModelBindingNullStub'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($value)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> RouteModelBindingClosureStub())-&gt;findAlternate($value);</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'tayloralt'</span>, $router-&gt;dispatch(Request::create(<span class="string">'foo/TAYLOR'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteModelBindingNullStub</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRouteKeyName</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'id'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">where</span><span class="params">($key, $value)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">first</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouteModelBindingClosureStub</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findAlternate</span><span class="params">($value)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> strtolower($value).<span class="string">'alt'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="router扩展方法"><a href="#router扩展方法" class="headerlink" title="router扩展方法"></a>router扩展方法</h1><p>router支持添加自定义的方法，只需要利用 <code>macro</code> 函数来注册对应的函数名和函数实现：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testMacro</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $router = <span class="keyword">$this</span>-&gt;getRouter();</div><div class="line">    $router-&gt;macro(<span class="string">'webhook'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($router)</span> </span>&#123;</div><div class="line">        $router-&gt;match([<span class="string">'GET'</span>, <span class="string">'POST'</span>], <span class="string">'webhook'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">'OK'</span>;</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">    $router-&gt;webhook();</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'OK'</span>, $router-&gt;dispatch(Request::create(<span class="string">'webhook'</span>, <span class="string">'GET'</span>))-&gt;getContent());</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'OK'</span>, $router-&gt;dispatch(Request::create(<span class="string">'webhook'</span>, <span class="string">'POST'</span>))-&gt;getContent());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/05/29/Laravel Container——container-detail-feature/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/29/Laravel Container——container-detail-feature/" itemprop="url">
                  Laravel核心——服务容器的细节特性
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-29T00:13:00+08:00">
                2017-05-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/laravel/" itemprop="url" rel="index">
                    <span itemprop="name">laravel</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/laravel/container/" itemprop="url" rel="index">
                    <span itemprop="name">container</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/05/29/Laravel Container——container-detail-feature/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/05/29/Laravel Container——container-detail-feature/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/05/29/Laravel Container——container-detail-feature/" class="leancloud_visitors" data-flag-title="Laravel核心——服务容器的细节特性">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在前面几个博客中，我详细讲了 Ioc 容器各个功能的使用、绑定的源码、解析的源码，今天这篇博客会详细介绍 Ioc 容器的一些细节，一些特性，以便更好地掌握容器的功能。</p>
<p>注：本文使用的测试类与测试对象都取自 laravel 的单元测试文件src/illuminate/tests/Container/ContainerTest.php</p>
<h1 id="rebind绑定特性"><a href="#rebind绑定特性" class="headerlink" title="rebind绑定特性"></a>rebind绑定特性</h1><h2 id="rebind-在绑定之前"><a href="#rebind-在绑定之前" class="headerlink" title="rebind 在绑定之前"></a>rebind 在绑定之前</h2><p>instance 和 普通 bind 绑定一样，当重新绑定的时候都会调用 rebind 回调函数，但是有趣的是，对于普通 bind 绑定来说，rebind 回调函数被调用的条件是当前接口被解析过：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testReboundListeners</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">unset</span>($_SERVER[<span class="string">'__test.rebind'</span>]);</div><div class="line"></div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;rebinding(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        $_SERVER[<span class="string">'__test.rebind'</span>] = <span class="keyword">true</span>;</div><div class="line">    &#125;);</div><div class="line">    $container-&gt;bind(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;);</div><div class="line">    $container-&gt;make(<span class="string">'foo'</span>);</div><div class="line">    $container-&gt;bind(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertTrue($_SERVER[<span class="string">'__test.rebind'</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以遇到下面这样的情况,rebinding 的回调函数是不会调用的：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testReboundListeners</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">unset</span>($_SERVER[<span class="string">'__test.rebind'</span>]);</div><div class="line"></div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;rebinding(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        $_SERVER[<span class="string">'__test.rebind'</span>] = <span class="keyword">true</span>;</div><div class="line">    &#125;);</div><div class="line">    $container-&gt;bind(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;);</div><div class="line">    $container-&gt;bind(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertFalse(<span class="keyword">isset</span>($_SERVER[<span class="string">'__test.rebind'</span>]));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>有趣的是对于 instance 绑定：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testReboundListeners</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">unset</span>($_SERVER[<span class="string">'__test.rebind'</span>]);</div><div class="line"></div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;rebinding(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        $_SERVER[<span class="string">'__test.rebind'</span>] = <span class="keyword">true</span>;</div><div class="line">    &#125;);</div><div class="line">    $container-&gt;bind(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;);</div><div class="line">    $container-&gt;instance(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertTrue(<span class="keyword">isset</span>($_SERVER[<span class="string">'__test.rebind'</span>]));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>rebinding 回调函数却是可以被调用的。其实原因就是 instance 源码中 rebinding 回调函数调用的条件是 rebound 为真，而普通 bind 函数调用 rebinding 回调函数的条件是 resolved 为真. 目前笔者不是很清楚为什么要对 instance 和 bind 区别对待，希望有大牛指导。</p>
<h2 id="rebind-在绑定之后"><a href="#rebind-在绑定之后" class="headerlink" title="rebind 在绑定之后"></a>rebind 在绑定之后</h2><p>为了使得 rebind 回调函数在下一次的绑定中被激活，在 rebind 函数的源码中，如果判断当前对象已经绑定过，那么将会立即解析：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rebinding</span><span class="params">($abstract, Closure $callback)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;reboundCallbacks[$abstract = <span class="keyword">$this</span>-&gt;getAlias($abstract)][] = $callback;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;bound($abstract)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;make($abstract);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>单元测试代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testReboundListeners1</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">unset</span>($_SERVER[<span class="string">'__test.rebind'</span>]);</div><div class="line"></div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;bind(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'foo'</span>;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    $container-&gt;resolving(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        $_SERVER[<span class="string">'__test.rebind'</span>] = <span class="keyword">true</span>;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    $container-&gt;rebinding(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($container,$object)</span> </span>&#123;<span class="comment">//会立即解析</span></div><div class="line">        $container[<span class="string">'foobar'</span>] = $object.<span class="string">'bar'</span>;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertTrue($_SERVER[<span class="string">'__test.rebind'</span>]);</div><div class="line"></div><div class="line">    $container-&gt;bind(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'bar'</span>, $container[<span class="string">'foobar'</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="resolving-特性"><a href="#resolving-特性" class="headerlink" title="resolving 特性"></a>resolving 特性</h1><h2 id="resolving-回调的类型"><a href="#resolving-回调的类型" class="headerlink" title="resolving 回调的类型"></a>resolving 回调的类型</h2><p>resolving 不仅可以针对接口执行回调函数，还可以针对接口实现的类型进行回调函数。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testResolvingCallbacksAreCalledForType</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;resolving(<span class="string">'StdClass'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($object)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $object-&gt;name = <span class="string">'taylor'</span>;</div><div class="line">    &#125;);</div><div class="line">    $container-&gt;bind(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">new</span> StdClass;</div><div class="line">    &#125;);</div><div class="line">    $instance = $container-&gt;make(<span class="string">'foo'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'taylor'</span>, $instance-&gt;name);</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testResolvingCallbacksShouldBeFiredWhenCalledWithAliases</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;alias(<span class="string">'StdClass'</span>, <span class="string">'std'</span>);</div><div class="line">    $container-&gt;resolving(<span class="string">'std'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($object)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $object-&gt;name = <span class="string">'taylor'</span>;</div><div class="line">    &#125;);</div><div class="line">    $container-&gt;bind(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StdClass;</div><div class="line">    &#125;);</div><div class="line">    $instance = $container-&gt;make(<span class="string">'foo'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'taylor'</span>, $instance-&gt;name);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="resolving-回调与-instance"><a href="#resolving-回调与-instance" class="headerlink" title="resolving 回调与 instance"></a>resolving 回调与 instance</h2><p>前面讲过，对于 singleton 绑定来说，resolving 回调函数仅仅运行一次，只在 singleton 第一次解析的时候才会调用。如果我们利用 instance 直接绑定类的对象，不需要解析，那么 resolving 回调函数将不会被调用：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testResolvingCallbacksAreCalledForSpecificAbstracts</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;resolving(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($object)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $object-&gt;name = <span class="string">'taylor'</span>;</div><div class="line">    &#125;);</div><div class="line">    $obj = <span class="keyword">new</span> StdClass;</div><div class="line">    $container-&gt;instance(<span class="string">'foo'</span>, $obj);</div><div class="line">    $instance = $container-&gt;make(<span class="string">'foo'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertFalse(<span class="keyword">isset</span>($instance-&gt;name));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="extend-扩展特性"><a href="#extend-扩展特性" class="headerlink" title="extend 扩展特性"></a>extend 扩展特性</h1><p>extend 用于扩展绑定对象的功能，对于普通绑定来说，这个函数的位置很灵活：</p>
<h2 id="在绑定前扩展"><a href="#在绑定前扩展" class="headerlink" title="在绑定前扩展"></a>在绑定前扩展</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testExtendIsLazyInitialized</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    ContainerLazyExtendStub::$initialized = <span class="keyword">false</span>;</div><div class="line">    </div><div class="line">    $container = <span class="keyword">new</span> Container;      </div><div class="line">    $container-&gt;extend(<span class="string">'Illuminate\Tests\Container\ContainerLazyExtendStub'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($obj, $container)</span> </span>&#123;</div><div class="line">        $obj-&gt;init();</div><div class="line">        <span class="keyword">return</span> $obj;   </div><div class="line">    &#125;);    </div><div class="line">    $container-&gt;bind(<span class="string">'Illuminate\Tests\Container\ContainerLazyExtendStub'</span>); </div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertFalse(ContainerLazyExtendStub::$initialized);   </div><div class="line">    $container-&gt;make(<span class="string">'Illuminate\Tests\Container\ContainerLazyExtendStub'</span>);   </div><div class="line">    <span class="keyword">$this</span>-&gt;assertTrue(ContainerLazyExtendStub::$initialized);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="在绑定后解析前扩展"><a href="#在绑定后解析前扩展" class="headerlink" title="在绑定后解析前扩展"></a>在绑定后解析前扩展</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testExtendIsLazyInitialized</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    ContainerLazyExtendStub::$initialized = <span class="keyword">false</span>;</div><div class="line">    </div><div class="line">    $container = <span class="keyword">new</span> Container;   </div><div class="line">    $container-&gt;bind(<span class="string">'Illuminate\Tests\Container\ContainerLazyExtendStub'</span>);    </div><div class="line">    $container-&gt;extend(<span class="string">'Illuminate\Tests\Container\ContainerLazyExtendStub'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($obj, $container)</span> </span>&#123;</div><div class="line">        $obj-&gt;init();</div><div class="line">        <span class="keyword">return</span> $obj;   </div><div class="line">    &#125;);    </div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertFalse(ContainerLazyExtendStub::$initialized);   </div><div class="line">    $container-&gt;make(<span class="string">'Illuminate\Tests\Container\ContainerLazyExtendStub'</span>);   </div><div class="line">    <span class="keyword">$this</span>-&gt;assertTrue(ContainerLazyExtendStub::$initialized);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="在解析后扩展"><a href="#在解析后扩展" class="headerlink" title="在解析后扩展"></a>在解析后扩展</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testExtendIsLazyInitialized</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    ContainerLazyExtendStub::$initialized = <span class="keyword">false</span>;</div><div class="line">    </div><div class="line">    $container = <span class="keyword">new</span> Container;   </div><div class="line">    $container-&gt;bind(<span class="string">'Illuminate\Tests\Container\ContainerLazyExtendStub'</span>);         </div><div class="line">    </div><div class="line">    $container-&gt;make(<span class="string">'Illuminate\Tests\Container\ContainerLazyExtendStub'</span>); </div><div class="line">    <span class="keyword">$this</span>-&gt;assertFalse(ContainerLazyExtendStub::$initialized);</div><div class="line">    </div><div class="line">    $container-&gt;extend(<span class="string">'Illuminate\Tests\Container\ContainerLazyExtendStub'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($obj, $container)</span> </span>&#123;</div><div class="line">        $obj-&gt;init();</div><div class="line">        <span class="keyword">return</span> $obj;   </div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertFalse(ContainerLazyExtendStub::$initialized);  </div><div class="line">      </div><div class="line">    $container-&gt;make(<span class="string">'Illuminate\Tests\Container\ContainerLazyExtendStub'</span>); </div><div class="line">    <span class="keyword">$this</span>-&gt;assertTrue(ContainerLazyExtendStub::$initialized);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，无论在哪个位置，extend 扩展都有 lazy 初始化的特点，也就是使用 extend 函数并不会立即起作用，而是要等到 make 解析才会激活。</p>
<h2 id="extend-与-instance-绑定"><a href="#extend-与-instance-绑定" class="headerlink" title="extend 与 instance 绑定"></a>extend 与 instance 绑定</h2><p>对于 instance 绑定来说，暂时 extend 的位置需要位于 instance 之后才会起作用，并且会立即起作用，没有 lazy 的特点：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testExtendInstancesArePreserved</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line"></div><div class="line">    $obj = <span class="keyword">new</span> StdClass;</div><div class="line">    $obj-&gt;foo = <span class="string">'foo'</span>;</div><div class="line">    $container-&gt;instance(<span class="string">'foo'</span>, $obj);</div><div class="line">    $container-&gt;extend(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($obj, $container)</span> </span>&#123;</div><div class="line">        $obj-&gt;bar = <span class="string">'baz'</span>;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $obj;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'foo'</span>, $container-&gt;make(<span class="string">'foo'</span>)-&gt;foo);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'baz'</span>, $container-&gt;make(<span class="string">'foo'</span>)-&gt;bar);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="extend-绑定与-rebind-回调"><a href="#extend-绑定与-rebind-回调" class="headerlink" title="extend 绑定与 rebind 回调"></a>extend 绑定与 rebind 回调</h2><p>无论扩展对象是 instance 绑定还是 bind 绑定，extend 都会启动 rebind 回调函数：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testExtendReBindingInstance</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $_SERVER[<span class="string">'_test_rebind'</span>] = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;rebinding(<span class="string">'foo'</span>,<span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</div><div class="line">        $_SERVER[<span class="string">'_test_rebind'</span>] = <span class="keyword">true</span>;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    $obj = <span class="keyword">new</span> StdClass;</div><div class="line">    $container-&gt;instance(<span class="string">'foo'</span>,$obj);</div><div class="line"></div><div class="line">    $container-&gt;make(<span class="string">'foo'</span>);</div><div class="line"></div><div class="line">    $container-&gt;extend(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($obj, $container)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $obj;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    this-&gt;assertTrue($_SERVER[<span class="string">'_test_rebind'</span>]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testExtendReBinding</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $_SERVER[<span class="string">'_test_rebind'</span>] = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;rebinding(<span class="string">'foo'</span>,<span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</div><div class="line">        $_SERVER[<span class="string">'_test_rebind'</span>] = <span class="keyword">true</span>;</div><div class="line">    &#125;);</div><div class="line">    $container-&gt;bind(<span class="string">'foo'</span>,<span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</div><div class="line">        $obj = <span class="keyword">new</span> StdClass;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $obj;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    $container-&gt;make(<span class="string">'foo'</span>);</div><div class="line"></div><div class="line">    $container-&gt;extend(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($obj, $container)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $obj;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    this-&gt;assertFalse($_SERVER[<span class="string">'_test_rebind'</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="contextual-绑定特性"><a href="#contextual-绑定特性" class="headerlink" title="contextual 绑定特性"></a>contextual 绑定特性</h1><h2 id="contextual-在绑定前"><a href="#contextual-在绑定前" class="headerlink" title="contextual 在绑定前"></a>contextual 在绑定前</h2><p>contextual 绑定不仅可以与 bind 绑定合作，相互不干扰，还可以与 instance 绑定相互合作。而且 instance 的位置也很灵活，可以在 contextual 绑定前，也可以在contextual 绑定后：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testContextualBindingWorksForExistingInstancedBindings</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line"></div><div class="line">    $container-&gt;instance(<span class="string">'Illuminate\Tests\Container\IContainerContractStub'</span>, <span class="keyword">new</span> ContainerImplementationStub);</div><div class="line"></div><div class="line">    $container-&gt;when(<span class="string">'Illuminate\Tests\Container\ContainerTestContextInjectOne'</span>)-&gt;needs(<span class="string">'Illuminate\Tests\Container\IContainerContractStub'</span>)-&gt;give(<span class="string">'Illuminate\Tests\Container\ContainerImplementationStubTwo'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertInstanceOf(</div><div class="line">             <span class="string">'Illuminate\Tests\Container\ContainerImplementationStubTwo'</span>,</div><div class="line">             $container-&gt;make(<span class="string">'Illuminate\Tests\Container\ContainerTestContextInjectOne'</span>)-&gt;impl</div><div class="line">     );</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="contextual-在绑定后"><a href="#contextual-在绑定后" class="headerlink" title="contextual 在绑定后"></a>contextual 在绑定后</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testContextualBindingWorksForNewlyInstancedBindings</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line"></div><div class="line">    $container-&gt;when(<span class="string">'Illuminate\Tests\Container\ContainerTestContextInjectOne'</span>)-&gt;needs(<span class="string">'Illuminate\Tests\Container\IContainerContractStub'</span>)-&gt;give(<span class="string">'Illuminate\Tests\Container\ContainerImplementationStubTwo'</span>);</div><div class="line"></div><div class="line">    $container-&gt;instance(<span class="string">'Illuminate\Tests\Container\IContainerContractStub'</span>, <span class="keyword">new</span> ContainerImplementationStub);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertInstanceOf(</div><div class="line">            <span class="string">'Illuminate\Tests\Container\ContainerImplementationStubTwo'</span>,</div><div class="line">        $container-&gt;make(<span class="string">'Illuminate\Tests\Container\ContainerTestContextInjectOne'</span>)-&gt;impl</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="contextual-绑定与别名"><a href="#contextual-绑定与别名" class="headerlink" title="contextual 绑定与别名"></a>contextual 绑定与别名</h2><p>contextual 绑定也可以在别名上进行，无论赋予别名的位置是 contextual 的前面还是后面：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testContextualBindingDoesntOverrideNonContextualResolution</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line"></div><div class="line">    $container-&gt;instance(<span class="string">'stub'</span>, <span class="keyword">new</span> ContainerImplementationStub);</div><div class="line">    $container-&gt;alias(<span class="string">'stub'</span>, <span class="string">'Illuminate\Tests\Container\IContainerContractStub'</span>);</div><div class="line"></div><div class="line">    $container-&gt;when(<span class="string">'Illuminate\Tests\Container\ContainerTestContextInjectTwo'</span>)-&gt;needs(<span class="string">'Illuminate\Tests\Container\IContainerContractStub'</span>)-&gt;give(<span class="string">'Illuminate\Tests\Container\ContainerImplementationStubTwo'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertInstanceOf(</div><div class="line">            <span class="string">'Illuminate\Tests\Container\ContainerImplementationStubTwo'</span>,</div><div class="line">            $container-&gt;make(<span class="string">'Illuminate\Tests\Container\ContainerTestContextInjectTwo'</span>)-&gt;impl</div><div class="line">        );</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertInstanceOf(</div><div class="line">            <span class="string">'Illuminate\Tests\Container\ContainerImplementationStub'</span>,</div><div class="line">            $container-&gt;make(<span class="string">'Illuminate\Tests\Container\ContainerTestContextInjectOne'</span>)-&gt;impl</div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testContextualBindingWorksOnNewAliasedBindings</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line"></div><div class="line">    $container-&gt;when(<span class="string">'Illuminate\Tests\Container\ContainerTestContextInjectOne'</span>)-&gt;needs(<span class="string">'Illuminate\Tests\Container\IContainerContractStub'</span>)-&gt;give(<span class="string">'Illuminate\Tests\Container\ContainerImplementationStubTwo'</span>);</div><div class="line"></div><div class="line">    $container-&gt;bind(<span class="string">'stub'</span>, ContainerImplementationStub::class);</div><div class="line">    $container-&gt;alias(<span class="string">'stub'</span>, <span class="string">'Illuminate\Tests\Container\IContainerContractStub'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertInstanceOf(</div><div class="line">          <span class="string">'Illuminate\Tests\Container\ContainerImplementationStubTwo'</span>,</div><div class="line">          $container-&gt;make(<span class="string">'Illuminate\Tests\Container\ContainerTestContextInjectOne'</span>)-&gt;impl</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="争议"><a href="#争议" class="headerlink" title="争议"></a>争议</h2><p>目前比较有争议的是下面的情况：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testContextualBindingWorksOnExistingAliasedInstances</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line"></div><div class="line">    $container-&gt;alias(<span class="string">'Illuminate\Tests\Container\IContainerContractStub'</span>, <span class="string">'stub'</span>);</div><div class="line">    $container-&gt;instance(<span class="string">'stub'</span>, <span class="keyword">new</span> ContainerImplementationStub);</div><div class="line"></div><div class="line">    $container-&gt;when(<span class="string">'Illuminate\Tests\Container\ContainerTestContextInjectOne'</span>)-&gt;needs(<span class="string">'stub'</span>)-&gt;give(<span class="string">'Illuminate\Tests\Container\ContainerImplementationStubTwo'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertInstanceOf(</div><div class="line">        <span class="string">'Illuminate\Tests\Container\ContainerImplementationStubTwo'</span>,</div><div class="line">        $container-&gt;make(<span class="string">'Illuminate\Tests\Container\ContainerTestContextInjectOne'</span>)-&gt;impl</div><div class="line">    ); </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由于instance的特性，当别名被绑定到其他对象上时，别名 stub 已经失去了与 Illuminate\Tests\Container\IContainerContractStub 之间的关系，因此不能使用 stub 代替作上下文绑定。<br>但是另一方面：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testContextualBindingWorksOnBoundAlias</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line"></div><div class="line">    $container-&gt;alias(<span class="string">'Illuminate\Tests\Container\IContainerContractStub'</span>, <span class="string">'stub'</span>);</div><div class="line">    $container-&gt;bind(<span class="string">'stub'</span>, ContainerImplementationStub::class);</div><div class="line"></div><div class="line">    $container-&gt;when(<span class="string">'Illuminate\Tests\Container\ContainerTestContextInjectOne'</span>)-&gt;needs(<span class="string">'stub'</span>)-&gt;give(<span class="string">'Illuminate\Tests\Container\ContainerImplementationStubTwo'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertInstanceOf(</div><div class="line">        <span class="string">'Illuminate\Tests\Container\ContainerImplementationStubTwo'</span>,</div><div class="line">        $container-&gt;make(<span class="string">'Illuminate\Tests\Container\ContainerTestContextInjectOne'</span>)-&gt;impl</div><div class="line">    ); </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>代码只是从 instance 绑定改为 bind 绑定，由于 bind 绑定只切断了别名中的 alias 数组的联系，并没有断绝abstractAlias数组的联系，因此这段代码却可以通过，很让人难以理解。本人在给 Taylor Otwell 提出 PR 时，作者原话为“I’m not making any of these changes to the container on a patch release.”。也许，在以后(5.5或以后)版本作者会更新这里的逻辑，我们就可以看看服务容器对别名绑定的态度了，大家也最好不要这样用。</p>
<h1 id="服务容器中的闭包函数参数"><a href="#服务容器中的闭包函数参数" class="headerlink" title="服务容器中的闭包函数参数"></a>服务容器中的闭包函数参数</h1><p>服务容器中很多函数都有闭包函数，这些闭包函数可以放入特定的参数，在绑定或者解析过程中，这些参数会被服务容器自动带入各种类对象或者服务容器实例。</p>
<h2 id="bind-闭包参数"><a href="#bind-闭包参数" class="headerlink" title="bind 闭包参数"></a>bind 闭包参数</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testAliasesWithArrayOfParameters</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;    </div><div class="line">    $container-&gt;bind(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app, $config)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $config;    </div><div class="line">    &#125;);    </div><div class="line"></div><div class="line">    $container-&gt;alias(<span class="string">'foo'</span>, <span class="string">'baz'</span>);    </div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], $container-&gt;makeWith(<span class="string">'baz'</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="extend-闭包参数"><a href="#extend-闭包参数" class="headerlink" title="extend 闭包参数"></a>extend 闭包参数</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testExtendedBindings</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;    </div><div class="line">    $container[<span class="string">'foo'</span>] = <span class="string">'foo’;    </span></div><div class="line"><span class="string">    $container-&gt;extend('</span>foo<span class="string">', function ($old, $container) &#123;</span></div><div class="line"><span class="string">        return $old.'</span>bar’;    </div><div class="line">    &#125;);</div><div class="line">   </div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'foobar'</span>, $container-&gt;make(<span class="string">'foo'</span>));</div><div class="line">    </div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    </div><div class="line">    $container-&gt;singleton(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (object) [<span class="string">'name'</span> =&gt; <span class="string">'taylor'</span>];    </div><div class="line">    &#125;);    </div><div class="line">    $container-&gt;extend(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($old, $container)</span> </span>&#123;</div><div class="line">        $old-&gt;age = <span class="number">26</span>;</div><div class="line">        <span class="keyword">return</span> $old;    </div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    $result = $container-&gt;make(<span class="string">'foo'</span>);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'taylor'</span>, $result-&gt;name);    </div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="number">26</span>, $result-&gt;age);   </div><div class="line">    <span class="keyword">$this</span>-&gt;assertSame($result, $container-&gt;make(<span class="string">'foo'</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="bindmethod-闭包参数"><a href="#bindmethod-闭包参数" class="headerlink" title="bindmethod 闭包参数"></a>bindmethod 闭包参数</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testCallWithBoundMethod</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;bindMethod(<span class="string">'Illuminate\Tests\Container\ContainerTestCallStub@unresolvable'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($stub,$container)</span> </span>&#123;</div><div class="line">        $container[<span class="string">'foo'</span>] = <span class="string">'foo'</span>;</div><div class="line">        <span class="keyword">return</span> $stub-&gt;unresolvable(<span class="string">'foo'</span>, <span class="string">'bar'</span>);</div><div class="line">    &#125;);</div><div class="line">    $result = $container-&gt;call(<span class="string">'Illuminate\Tests\Container\ContainerTestCallStub@unresolvable'</span>);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals([<span class="string">'foo'</span>, <span class="string">'bar'</span>], $result);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'foo'</span>,$container[<span class="string">'foo'</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="resolve-闭包参数"><a href="#resolve-闭包参数" class="headerlink" title="resolve 闭包参数"></a>resolve 闭包参数</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testResolvingCallbacksAreCalledForSpecificAbstracts</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">     $container = <span class="keyword">new</span> Container;</div><div class="line">     $container-&gt;resolving(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($object，$container)</span> </span>&#123;</div><div class="line">         <span class="keyword">return</span> $object-&gt;name = <span class="string">'taylor'</span>;</div><div class="line">     &#125;);</div><div class="line"> </div><div class="line">     $container-&gt;bind(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StdClass;</div><div class="line">     &#125;);</div><div class="line">     $instance = $container-&gt;make(<span class="string">'foo'</span>);</div><div class="line"></div><div class="line">     <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'taylor'</span>, $instance-&gt;name);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="rebinding-闭包参数"><a href="#rebinding-闭包参数" class="headerlink" title="rebinding 闭包参数"></a>rebinding 闭包参数</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testReboundListeners</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;bind(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'foo'</span>;</div><div class="line">    &#125;);</div><div class="line">  </div><div class="line">    $container-&gt;rebinding(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($container,$object)</span> </span>&#123;</div><div class="line">         $container[<span class="string">'bar'</span>] = $object.<span class="string">'bar'</span>;</div><div class="line">    &#125;);</div><div class="line">  </div><div class="line">    $container-&gt;bind(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'bar'</span>,$container[<span class="string">'foobar'</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/05/07/Laravel Container——laravel-container-resolve/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/07/Laravel Container——laravel-container-resolve/" itemprop="url">
                  Laravel核心——Ioc服务容器源码解析（服务器解析）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-07T21:32:00+08:00">
                2017-05-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/laravel/" itemprop="url" rel="index">
                    <span itemprop="name">laravel</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/laravel/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/05/07/Laravel Container——laravel-container-resolve/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/05/07/Laravel Container——laravel-container-resolve/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/05/07/Laravel Container——laravel-container-resolve/" class="leancloud_visitors" data-flag-title="Laravel核心——Ioc服务容器源码解析（服务器解析）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="make解析"><a href="#make解析" class="headerlink" title="make解析"></a>make解析</h1><p>首先欢迎关注我的博客： <a href="http://www.leoyang90.cn" target="_blank" rel="external">www.leoyang90.cn</a></p>
<p>服务容器对对象的自动解析是服务容器的核心功能，make 函数、build 函数是实例化对象重要的核心，先大致看一下代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">($abstract)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $abstract = <span class="keyword">$this</span>-&gt;getAlias($abstract);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;deferredServices[$abstract])) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;loadDeferredProvider($abstract);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">parent</span>::make($abstract);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">($abstract)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resolve($abstract);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">resolve</span><span class="params">($abstract, $parameters = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $abstract = <span class="keyword">$this</span>-&gt;getAlias($abstract);</div><div class="line">    </div><div class="line">    $needsContextualBuild = ! <span class="keyword">empty</span>($parameters) || ! is_null(</div><div class="line">        <span class="keyword">$this</span>-&gt;getContextualConcrete($abstract)</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="comment">// If an instance of the type is currently being managed as a singleton we'll</span></div><div class="line">    <span class="comment">// just return an existing instance instead of instantiating new instances</span></div><div class="line">    <span class="comment">// so the developer can keep using the same objects instance every time.</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;instances[$abstract]) &amp;&amp; ! $needsContextualBuild) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;instances[$abstract];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $concrete = <span class="keyword">$this</span>-&gt;getConcrete($abstract);</div><div class="line"></div><div class="line">    <span class="comment">// We're ready to instantiate an instance of the concrete type registered for</span></div><div class="line">    <span class="comment">// the binding. This will instantiate the types, as well as resolve any of</span></div><div class="line">    <span class="comment">// its "nested" dependencies recursively until all have gotten resolved.</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isBuildable($concrete, $abstract)) &#123;</div><div class="line">        $object = <span class="keyword">$this</span>-&gt;build($concrete);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $object = <span class="keyword">$this</span>-&gt;make($concrete);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// If we defined any extenders for this type, we'll need to spin through them</span></div><div class="line">    <span class="comment">// and apply them to the object being built. This allows for the extension</span></div><div class="line">    <span class="comment">// of services, such as changing configuration or decorating the object.</span></div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;getExtenders($abstract) <span class="keyword">as</span> $extender) &#123;</div><div class="line">        $object = $extender($object, <span class="keyword">$this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// If the requested type is registered as a singleton we'll want to cache off</span></div><div class="line">    <span class="comment">// the instances in "memory" so we can return it later without creating an</span></div><div class="line">    <span class="comment">// entirely new instance of an object on each subsequent request for it.</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isShared($abstract) &amp;&amp; ! $needsContextualBuild) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;instances[$abstract] = $object;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;fireResolvingCallbacks($abstract, $object);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;resolved[$abstract] = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $object;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在讲解解析流程之前，我们先说说使用make函数进行解析的分类：</p>
<p><img src="http://i4.buimg.com/593560/49eb89516c6034ef.png" alt="Markdown"></p>
<p>我们详细的讲一下上图。这里我把使用make函数进行解析的情况分为大致两种：</p>
<blockquote>
<ul>
<li>解析对象没有绑定过任何类，例如：</li>
</ul>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$app-&gt;make(<span class="string">'App\Http\Controllers\HomeController'</span>);</div></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>解析对象绑定过实现类</li>
</ul>
</blockquote>
<p>对于绑定过实现类的对象可以分为两种：</p>
<blockquote>
<ul>
<li>绑定的是类名，例如：</li>
</ul>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$app-&gt;when(<span class="string">'App\Http\Controllers\HomeController'</span>)</div><div class="line">-&gt;needs(<span class="string">'App\Http\Requests\InRequest'</span>)</div><div class="line">-&gt;give(<span class="string">'App\Http\Requests\TestsRequest'</span>);</div></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>绑定的是闭包</li>
</ul>
</blockquote>
<p>对于绑定的是闭包的又可以分为：</p>
<blockquote>
<ul>
<li>用户绑定闭包，例如：</li>
</ul>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$app-&gt;singleton(<span class="string">'auth'</span>,<span class="function"><span class="keyword">function</span><span class="params">($app)</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AuthManager($app)</div><div class="line">&#125;)；／／对象类直接实现方法</div><div class="line"></div><div class="line">$app-&gt;singleton(EloquentFactory::class, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> EloquentFactory::construct(</div><div class="line">        $app-&gt;make(FakerGenerator::class), database_path(<span class="string">'factories'</span>)</div><div class="line">);／／对象类依赖注入</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>服务容器外包一层闭包函数（make／build），例如：</li>
</ul>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$app-&gt;singleton(</div><div class="line">    Illuminate\Contracts\Http\Kernel::class,</div><div class="line">    App\Http\Kernel::class</div><div class="line">);<span class="comment">//包装make</span></div><div class="line"></div><div class="line">$app-&gt;singleton(</div><div class="line">    App\ConSole\Kernel::class,</div><div class="line">);<span class="comment">//包装build</span></div></pre></td></tr></table></figure>
<p>我们在这里先大致讲一下服务容器解析的流程，值得注意的是其中 build 函数有可能会递归调用 make：</p>
<p><img src="http://i2.muimg.com/593560/ee3e05dce90393fc.png" alt="Markdown"></p>
<blockquote>
<ol>
<li>获取服务名称。</li>
<li>加载延迟服务。判断当前的接口是否是延迟服务提供者，若是延迟服务提供者，那么还要对服务提供者进行注册与启动操作。</li>
<li>解析单例。如果接口服务是已经被解析过的单例对象，而且并非上下文绑定，那么直接取出对象。</li>
<li>获取注册的实现。实现方式可能是上下文绑定的，也可能是 binding 数组中的闭包，也有可能就是接口本身。</li>
<li>build 解析。首先判断是否需要递归。是，则递归 make；否，则调用 build 函数；直到调用 build 为止</li>
<li>执行扩展。若当前解析对象存在扩展，运行扩展函数。</li>
<li>创造单例对象。若 shared 为真，且不存在上下文绑定，则放入单例数组中</li>
<li>回调</li>
<li>标志解析</li>
</ol>
</blockquote>
<p>下面我们开始详细分解代码逻辑。由于 getAlias 函数已经在 <a href="http://leoyang90.cn/2017/05/07/laravel-container-bind/" target="_blank" rel="external">上一篇</a> 讲过，这里不会再说。而loadDeferredProvider 函数作用是加载延迟服务，与容器解析关系不大，我们放在以后再说。</p>
<h2 id="获取注册的实现"><a href="#获取注册的实现" class="headerlink" title="获取注册的实现"></a>获取注册的实现</h2><p>获取解析类的真正实现，函数优先去获取上下文绑定的实现，否则获取 binding 数组中的实现，获取不到就是直接返回自己作为实现：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getConcrete</span><span class="params">($abstract)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! is_null($concrete = <span class="keyword">$this</span>-&gt;getContextualConcrete($abstract))) &#123;</div><div class="line">        <span class="keyword">return</span> $concrete;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;bindings[$abstract])) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;bindings[$abstract][<span class="string">'concrete'</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $abstract;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>一般来说，上下文绑定的服务是通过依赖注入来实现的：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;when(PhotoController::class)</div><div class="line">          -&gt;needs(Filesystem::class)</div><div class="line">          -&gt;give(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">              <span class="keyword">return</span> Storage::disk(<span class="string">'local'</span>);</div><div class="line">          &#125;);</div><div class="line">       </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PhotoController</span></span>&#123;</div><div class="line">    <span class="keyword">protected</span> $file;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Filesystem $file)</span></span>&#123;</div><div class="line">      <span class="keyword">$this</span>-&gt;file = $file;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>服务容器会在解析 PhotoController 的时候，通过放射获取参数类型 Filesystem，并且会把 Filesystem 自动解析为 Storage::disk(‘local’)。如何实现的呢？首先，从 <a href="http://leoyang90.cn/2017/05/07/laravel-container-bind/" target="_blank" rel="external">上一篇</a> 文章我们知道，当进行上下文绑定的时候，实际上是维护 contextual 数组，通过上下文绑定，这个数组中存在：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">contextual[PhotoController][Filesystem] = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123; <span class="keyword">return</span> Storage::disk(<span class="string">'local'</span>); &#125;</div></pre></td></tr></table></figure></p>
<p>若是服务容器试图构造 PhotoController 类，那么由于其构造函数依赖于 Filesystem，所以容器必须先生成 Filesystem 类，然后再注入到 PhotoController 中。</p>
<p>在构造 Filesystem 之前，服务容器会先把 PhotoController 放入 buildStack 中，继而再去解析 Filesystem。</p>
<p>解析 Filesystem 时，运行 getContextualConcrete 函数：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getContextualConcrete</span><span class="params">($abstract)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! is_null($binding = <span class="keyword">$this</span>-&gt;findInContextualBindings($abstract))) &#123;</div><div class="line">        <span class="keyword">return</span> $binding;</div><div class="line">    &#125;</div><div class="line">     </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;abstractAliases[$abstract])) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;abstractAliases[$abstract] <span class="keyword">as</span> $alias) &#123;</div><div class="line">        <span class="keyword">if</span> (! is_null($binding = <span class="keyword">$this</span>-&gt;findInContextualBindings($alias))) &#123;</div><div class="line">            <span class="keyword">return</span> $binding;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">findInContextualBindings</span><span class="params">($abstract)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;contextual[end(<span class="keyword">$this</span>-&gt;buildStack)][$abstract])) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;contextual[end(<span class="keyword">$this</span>-&gt;buildStack)][$abstract];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从上面可以看出，getContextualConcrete 函数把当前解析的类（Filesystem）作为 abstract，buildStack 最后一个类（PhotoController）作为 concrete，寻找 this-&gt;contextual[concrete] [abstract] （contextual[PhotoController] [Filesystem]）中的值，在这个例子里面这个数组值就是那个匿名函数。</p>
<h2 id="build-解析"><a href="#build-解析" class="headerlink" title="build 解析"></a>build 解析</h2><p>对于服务容器来说，绑定是可以递归的，例如：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$app-&gt;bind(<span class="string">'a'</span>,<span class="string">'b'</span>);</div><div class="line">$app-&gt;bind(<span class="string">'b'</span>,<span class="string">'c'</span>);</div><div class="line">$app-&gt;bind(<span class="string">'c'</span>,<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> C;</div><div class="line">  &#125;)</div></pre></td></tr></table></figure></p>
<p>遇到这样的情况，bind 绑定中 getClosure 函数开始发挥作用，该函数会给类包一层闭包，闭包内调用 make 函数，服务容器会不断递归调用 make 函数，直到最后一层，也就是绑定 c 的匿名函数。但是另一方面，有一些绑定方式并没有调用 bind 函数，例如上下文绑定 context：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;when(E::class)</div><div class="line">          -&gt;needs(F::class)</div><div class="line">          -&gt;give(A::class);</div></pre></td></tr></table></figure></p>
<p>当make(E::class)的时候，getConcrete 返回 A 类，而不是调用 make 函数的闭包，所以并不会启动递归流程得到 C 的匿名函数，所以造成 A 类完全无法解析，isBuildable 函数就是解决这种问题的，当发现需要解析构造的对象很有可能是递归的，那么就递归调用 make 函数，否则才会调用build。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isBuildable($concrete, $abstract)) &#123;</div><div class="line">        $object = <span class="keyword">$this</span>-&gt;build($concrete);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $object = <span class="keyword">$this</span>-&gt;make($concrete);</div><div class="line">    &#125;</div><div class="line">...</div><div class="line">     </div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">isBuildable</span><span class="params">($concrete, $abstract)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> $concrete === $abstract || $concrete <span class="keyword">instanceof</span> Closure;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="执行扩展"><a href="#执行扩展" class="headerlink" title="执行扩展"></a>执行扩展</h2><p>获取扩展闭包，并运行扩展函数：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getExtenders</span><span class="params">($abstract)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $abstract = <span class="keyword">$this</span>-&gt;getAlias($abstract);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;extenders[$abstract])) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;extenders[$abstract];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> [];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="回调"><a href="#回调" class="headerlink" title="回调"></a>回调</h2><p>先后启动全局的解析事件回调函数，再启动针对类型的事件回调函数：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">fireResolvingCallbacks</span><span class="params">($abstract, $object)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;fireCallbackArray($object, <span class="keyword">$this</span>-&gt;globalResolvingCallbacks);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;fireCallbackArray(</div><div class="line">        $object, <span class="keyword">$this</span>-&gt;getCallbacksForType($abstract, $object, <span class="keyword">$this</span>-&gt;resolvingCallbacks)</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;fireAfterResolvingCallbacks($abstract, $object);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getCallbacksForType</span><span class="params">($abstract, $object, array $callbacksPerType)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $results = [];</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> ($callbacksPerType <span class="keyword">as</span> $type =&gt; $callbacks) &#123;</div><div class="line">        <span class="keyword">if</span> ($type === $abstract || $object <span class="keyword">instanceof</span> $type) &#123;</div><div class="line">            $results = array_merge($results, $callbacks);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $results;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">fireAfterResolvingCallbacks</span><span class="params">($abstract, $object)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;fireCallbackArray($object, <span class="keyword">$this</span>-&gt;globalAfterResolvingCallbacks);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;fireCallbackArray(</div><div class="line">        $object, <span class="keyword">$this</span>-&gt;getCallbacksForType($abstract, $object, <span class="keyword">$this</span>-&gt;afterResolvingCallbacks)</div><div class="line">    );</div></pre></td></tr></table></figure></p>
<h1 id="build-解析-1"><a href="#build-解析-1" class="headerlink" title="build 解析"></a>build 解析</h1><hr>
<p>make 函数承担了解析的大致框架，build 主要的职责就是利用反射将类构造出来，先看看主要代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">build</span><span class="params">($concrete)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="comment">// If the concrete type is actually a Closure, we will just execute it and</span></div><div class="line">    <span class="comment">// hand back the results of the functions, which allows functions to be</span></div><div class="line">    <span class="comment">// used as resolvers for more fine-tuned resolution of these objects.</span></div><div class="line">    <span class="keyword">if</span> ($concrete <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">         <span class="keyword">return</span> $concrete(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;getLastParameterOverride());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $reflector = <span class="keyword">new</span> ReflectionClass($concrete);</div><div class="line"></div><div class="line">    <span class="comment">// If the type is not instantiable, the developer is attempting to resolve</span></div><div class="line">    <span class="comment">// an abstract type such as an Interface of Abstract Class and there is</span></div><div class="line">    <span class="comment">// no binding registered for the abstractions so we need to bail out.</span></div><div class="line">    <span class="keyword">if</span> (! $reflector-&gt;isInstantiable()) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;notInstantiable($concrete);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;buildStack[] = $concrete;</div><div class="line"></div><div class="line">    $constructor = $reflector-&gt;getConstructor();</div><div class="line"></div><div class="line">    <span class="comment">// If there are no constructors, that means there are no dependencies then</span></div><div class="line">    <span class="comment">// we can just resolve the instances of the objects right away, without</span></div><div class="line">    <span class="comment">// resolving any other types or dependencies out of these containers.</span></div><div class="line">    <span class="keyword">if</span> (is_null($constructor)) &#123;</div><div class="line">        array_pop(<span class="keyword">$this</span>-&gt;buildStack);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> $concrete;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $dependencies = $constructor-&gt;getParameters();</div><div class="line"></div><div class="line">    <span class="comment">// Once we have all the constructor's parameters we can create each of the</span></div><div class="line">    <span class="comment">// dependency instances and then use the reflection instances to make a</span></div><div class="line">    <span class="comment">// new instance of this class, injecting the created dependencies in.</span></div><div class="line">    $instances = <span class="keyword">$this</span>-&gt;resolveDependencies(</div><div class="line">        $dependencies</div><div class="line">    );</div><div class="line"></div><div class="line">    array_pop(<span class="keyword">$this</span>-&gt;buildStack);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $reflector-&gt;newInstanceArgs($instances);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们下面详细的说一下各个部分：</p>
<h2 id="闭包函数执行"><a href="#闭包函数执行" class="headerlink" title="闭包函数执行"></a>闭包函数执行</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($concrete <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">     <span class="keyword">return</span> $concrete(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;getLastParameterOverride());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码很简单，但是作用很大。前面说过闭包函数有很多种类：</p>
<ul>
<li>用户绑定时提供的直接提供实现类的方式：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$app-&gt;singleton(<span class="string">'auth'</span>,<span class="function"><span class="keyword">function</span><span class="params">($app)</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AuthManager($app)</div><div class="line">&#125;)；／／对象类直接实现方法</div></pre></td></tr></table></figure>
<p>这种情况 concrete(this) 直接就可以解析构造出具体实现类，服务容器解析完毕。</p>
<ul>
<li>用户绑定时提供的带有依赖注入的实现：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$app-&gt;singleton(EloquentFactory::class, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> EloquentFactory::construct(</div><div class="line">        $app-&gt;make(FakerGenerator::class), database_path(<span class="string">'factories'</span>)</div><div class="line">);／／对象类依赖注入</div></pre></td></tr></table></figure>
<p>这种情况下，concrete(this) 会转而去解析 FakerGenerator::class，递归调用 make 函数。</p>
<ul>
<li>bind函数使用 getClosure 包装而来：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span><span class="params">($container, $parameters = [])</span></span>&#123;</div><div class="line">    method = make/build;</div><div class="line">    <span class="keyword">return</span> $container-&gt;$method($concrete, $parameters);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这种情况，concrete(this) 将会继续递归调用 make 或者 build。</p>
<h2 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h2><p>当 build 的参数是类名而不是闭包的时候，就要利用反射构建类对象，如果构建的类对象不需要依赖任何其他参数，那么：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$reflector = <span class="keyword">new</span> ReflectionClass($concrete);</div><div class="line">$constructor = $reflector-&gt;getConstructor();</div><div class="line"><span class="keyword">if</span> (is_null($constructor)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> $concrete;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果需要依赖注入，那么就要用反射机制来获取 __construct 函数所需要注入的依赖，如果在make的时候带入参数值，那么直接利用传入的参数值；如果依赖是类对像，那么递归调用 make 函数；如果依赖是变量值，那么就从上下文中或者参数默认值中去获取：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">$dependencies = $constructor-&gt;getParameters();</div><div class="line">$instances = <span class="keyword">$this</span>-&gt;resolveDependencies($dependencies);</div><div class="line">...</div><div class="line">     </div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveDependencies</span><span class="params">(array $dependencies)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $results = [];</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> ($dependencies <span class="keyword">as</span> $dependency) &#123;</div><div class="line">      </div><div class="line">      <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;hasParameterOverride($dependency)) &#123;</div><div class="line">          $results[] = <span class="keyword">$this</span>-&gt;getParameterOverride($dependency);</div><div class="line">               </div><div class="line">          <span class="keyword">continue</span>;</div><div class="line">      &#125;</div><div class="line">      </div><div class="line">      $results[] = is_null($class = $dependency-&gt;getClass())</div><div class="line">                            ? <span class="keyword">$this</span>-&gt;resolvePrimitive($dependency)</div><div class="line">                            : <span class="keyword">$this</span>-&gt;resolveClass($dependency);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $results;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>解析变量值参数，如果变量值在上下文绑定中设置过，则去取上下文绑定的值，否则通过反射去取参数默认值，如果没有默认值，那么就要终止报错：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resolvePrimitive</span><span class="params">(ReflectionParameter $parameter)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">      <span class="keyword">if</span> (! is_null($concrete = <span class="keyword">$this</span>-&gt;getContextualConcrete(<span class="string">'$'</span>.$parameter-&gt;name))) &#123;</div><div class="line">          <span class="keyword">return</span> $concrete <span class="keyword">instanceof</span> Closure ? $concrete(<span class="keyword">$this</span>) : $concrete;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> ($parameter-&gt;isDefaultValueAvailable()) &#123;</div><div class="line">          <span class="keyword">return</span> $parameter-&gt;getDefaultValue();</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">$this</span>-&gt;unresolvablePrimitive($parameter);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">hasParameterOverride</span><span class="params">($dependency)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> array_key_exists(</div><div class="line">        $dependency-&gt;name, <span class="keyword">$this</span>-&gt;getLastParameterOverride()</div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getParameterOverride</span><span class="params">($dependency)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getLastParameterOverride()[$dependency-&gt;name];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getLastParameterOverride</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> count(<span class="keyword">$this</span>-&gt;with) ? end(<span class="keyword">$this</span>-&gt;with) : [];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>解析类参数，利用服务容器进行依赖注入：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveClass</span><span class="params">(ReflectionParameter $parameter)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;make($parameter-&gt;getClass()-&gt;name);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">catch</span> (BindingResolutionException $e) &#123;</div><div class="line">          <span class="keyword">if</span> ($parameter-&gt;isOptional()) &#123;</div><div class="line">              <span class="keyword">return</span> $parameter-&gt;getDefaultValue();</div><div class="line">          &#125;</div><div class="line"></div><div class="line">        <span class="keyword">throw</span> $e;</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="buildstack-解析栈"><a href="#buildstack-解析栈" class="headerlink" title="buildstack 解析栈"></a>buildstack 解析栈</h2><p>值的注意的是服务容器里面有个 buildStack，每次利用反射对参数进行依赖注入的时候，都要向这个数组中压入当前的解析对象，前面说过这部分是为了上下文绑定而设计的：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="keyword">$this</span>-&gt;buildStack[] = $concrete;<span class="comment">//压入数组栈中</span></div><div class="line">...</div><div class="line">$instances = <span class="keyword">$this</span>-&gt;resolveDependencies($dependencies);／／解析依赖注入的参数</div><div class="line">array_pop(<span class="keyword">$this</span>-&gt;buildStack);／／弹出数组栈</div><div class="line">...</div></pre></td></tr></table></figure></p>
<h1 id="解析标签"><a href="#解析标签" class="headerlink" title="解析标签"></a>解析标签</h1><hr>
<p>使用标签绑定的类，将会使用 tagged 来解析:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tagged</span><span class="params">($tag)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $results = [];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;tags[$tag])) &#123;</div><div class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;tags[$tag] <span class="keyword">as</span> $abstract) &#123;</div><div class="line">            $results[] = <span class="keyword">$this</span>-&gt;make($abstract);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $results;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="call方法注入"><a href="#call方法注入" class="headerlink" title="call方法注入"></a>call方法注入</h1><hr>
<p>服务容器中，我们直接使用或者间接的使用 make 来构造服务对象，但是在实际的应用场景中，会有这样的需求：我们拥有一个对象或者闭包函数，想要调用它的一个函数，但是它函数里面却有其他类的参数，这个就需要进行 call 方法注入<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">call</span><span class="params">($callback, array $parameters = [], $defaultMethod = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> BoundMethod::call(<span class="keyword">$this</span>, $callback, $parameters, $defaultMethod);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在 <a href="http://www.leoyang90.cn/2017/05/06/Laravel-container/" target="_blank" rel="external">上一篇</a> 文章中，我们说过，call 函数中的 callback 参数有以下几种形式：</p>
<ul>
<li>闭包 Closure</li>
<li>class@method</li>
<li>类静态函数，class::method</li>
<li>类静态函数： [ className／classObj,  method ]；类非静态函数： [ classObj,  method ]</li>
<li>若 defaultMethod 不为空，className<br>首先，我们先看看 call 方法注入的流程图：</li>
</ul>
<p><img src="http://i2.muimg.com/593560/6feca883154f32e2.png" alt="Markdown"></p>
<p>从流程图中我们可以看出来，虽然调用 call 的形式有 5 种，但是实际最终的形式是三种，第二种和第五种被转化为了第四种。<br>接下来，我们详细的解析源码：</p>
<h2 id="call"><a href="#call" class="headerlink" title="call"></a>call</h2><p>先看一下 call 方法的主体：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">call</span><span class="params">($container, $callback, array $parameters = [], $defaultMethod = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">static</span>::isCallableWithAtSign($callback) || $defaultMethod) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::callClass($container, $callback, $parameters, $defaultMethod);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">static</span>::callBoundMethod($container, $callback, <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($container, $callback, $parameters)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> call_user_func_array(</div><div class="line">            $callback, <span class="keyword">static</span>::getMethodDependencies($container, $callback, $parameters)</div><div class="line">        );</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出来，call 方法注入主要有 4 个大的步骤：</p>
<ol>
<li>对于 className@method 和 className-defaultMethod，实例化 className 为类对象，转化为 [ classObj,  method ]。</li>
<li>判断 [ classObj ／ classname,  method ] 是否存在被绑定的方法，如果有则调用。</li>
<li>利用服务容器解析依赖的参数。</li>
<li>调用 call_user_func_array。</li>
</ol>
<h2 id="实例化类对象"><a href="#实例化类对象" class="headerlink" title="实例化类对象"></a>实例化类对象</h2><p>在这里 className@method 和 className-defaultMethod 两种情况被转化为 [ classObj,  method ]， className会被实例化为类对象，并重新调用 call：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">isCallableWithAtSign</span><span class="params">($callback)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> is_string($callback) &amp;&amp; strpos($callback, <span class="string">'@'</span>) !== <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">callClass</span><span class="params">($container, $target, array $parameters = [], $defaultMethod = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $segments = explode(<span class="string">'@'</span>, $target);</div><div class="line"></div><div class="line">    $method = count($segments) == <span class="number">2</span></div><div class="line">                    ? $segments[<span class="number">1</span>] : $defaultMethod;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (is_null($method)) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(<span class="string">'Method not provided.'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">static</span>::call(</div><div class="line">        $container, [$container-&gt;make($segments[<span class="number">0</span>]), $method], $parameters</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="执行绑定方法"><a href="#执行绑定方法" class="headerlink" title="执行绑定方法"></a>执行绑定方法</h2><p>针对 [ className／classObj,  method ], 调用被绑定的方法：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">callBoundMethod</span><span class="params">($container, $callback, $default)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! is_array($callback)) &#123;</div><div class="line">        <span class="keyword">return</span> value($default);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $method = <span class="keyword">static</span>::normalizeMethod($callback);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($container-&gt;hasMethodBinding($method)) &#123;</div><div class="line">        <span class="keyword">return</span> $container-&gt;callMethodBinding($method, $callback[<span class="number">0</span>]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> value($default);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">normalizeMethod</span><span class="params">($callback)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $class = is_string($callback[<span class="number">0</span>]) ? $callback[<span class="number">0</span>] : get_class($callback[<span class="number">0</span>]);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">"&#123;$class&#125;@&#123;$callback[1]&#125;"</span>;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasMethodBinding</span><span class="params">($method)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;methodBindings[$method]);</div><div class="line">&#125;        </div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">callMethodBinding</span><span class="params">($method, $instance)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> call_user_func(<span class="keyword">$this</span>-&gt;methodBindings[$method], $instance, <span class="keyword">$this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那么这个被绑定的方法 methodBindings 从哪里来呢，就是 <a href="http://www.leoyang90.cn/2017/05/06/Laravel-container/" target="_blank" rel="external">上一篇</a> 文章提的 bindMethod：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bindMethod</span><span class="params">($method, $callback)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;methodBindings[$method] = $callback;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从上面可以看出来，methodBindings 中 callback 参数一定是 classname@method 形式的。</p>
<h2 id="实例化依赖"><a href="#实例化依赖" class="headerlink" title="实例化依赖"></a>实例化依赖</h2><p>这一步就要通过反射来获取函数方法需要注入的参数类型，然后利用服务容器对参数类型进行解析构建：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getMethodDependencies</span><span class="params">($container, $callback, array $parameters = [])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $dependencies = [];</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">static</span>::getCallReflector($callback)-&gt;getParameters() <span class="keyword">as</span> $parameter) &#123;</div><div class="line">        <span class="keyword">static</span>::addDependencyForCallParameter($container, $parameter, $parameters, $dependencies);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> array_merge($dependencies, $parameters);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>getCallReflector 函数利用反射来获取参数类型，值得注意的是class::method是需要拆分处理的：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getCallReflector</span><span class="params">($callback)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (is_string($callback) &amp;&amp; strpos($callback, <span class="string">'::'</span>) !== <span class="keyword">false</span>) &#123;</div><div class="line">        $callback = explode(<span class="string">'::'</span>, $callback);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> is_array($callback)</div><div class="line">                    ? <span class="keyword">new</span> ReflectionMethod($callback[<span class="number">0</span>], $callback[<span class="number">1</span>])</div><div class="line">                    : <span class="keyword">new</span> ReflectionFunction($callback);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>利用传入的参数，利用服务容器构建解析参数类型，或者获取参数默认值：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">addDependencyForCallParameter</span><span class="params">($container, $parameter,</span></span></div><div class="line"><span class="function"><span class="params">                                                            array &amp;$parameters, &amp;$dependencies)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (array_key_exists($parameter-&gt;name, $parameters)) &#123;</div><div class="line">        $dependencies[] = $parameters[$parameter-&gt;name];</div><div class="line"></div><div class="line">        <span class="keyword">unset</span>($parameters[$parameter-&gt;name]);</div><div class="line">    &#125; <span class="keyword">elseif</span> ($parameter-&gt;getClass()) &#123;</div><div class="line">        $dependencies[] = $container-&gt;make($parameter-&gt;getClass()-&gt;name);</div><div class="line">    &#125; <span class="keyword">elseif</span> ($parameter-&gt;isDefaultValueAvailable()) &#123;</div><div class="line">        $dependencies[] = $parameter-&gt;getDefaultValue();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="call-user-func-array"><a href="#call-user-func-array" class="headerlink" title="call_user_func_array"></a>call_user_func_array</h2><p>关于这个函数可以参考 <a href="https://segmentfault.com/a/1190000006981167" target="_blank" rel="external">Laravel学习笔记之Callback Type</a><br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">call_user_func_array(</div><div class="line">            $callback, <span class="keyword">static</span>::getMethodDependencies($container, $callback, $parameters)</div><div class="line">        );</div></pre></td></tr></table></figure></p>
<blockquote>
<p>Written with <a href="https://stackedit.io/" target="_blank" rel="external">StackEdit</a>.</p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/05/07/Laravel Container——laravel-container-bind/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/07/Laravel Container——laravel-container-bind/" itemprop="url">
                  Laravel核心——Ioc服务容器源码解析（服务器绑定）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-07T20:02:00+08:00">
                2017-05-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/源码/" itemprop="url" rel="index">
                    <span itemprop="name">源码</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/源码/laravel/" itemprop="url" rel="index">
                    <span itemprop="name">laravel</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/05/07/Laravel Container——laravel-container-bind/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/05/07/Laravel Container——laravel-container-bind/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/05/07/Laravel Container——laravel-container-bind/" class="leancloud_visitors" data-flag-title="Laravel核心——Ioc服务容器源码解析（服务器绑定）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="服务容器的绑定"><a href="#服务容器的绑定" class="headerlink" title="服务容器的绑定"></a>服务容器的绑定</h1><h2 id="bind-绑定"><a href="#bind-绑定" class="headerlink" title="bind 绑定"></a>bind 绑定</h2><p>欢迎关注我的博客：<a href="http://www.leoyang90.cn" target="_blank" rel="external">www.leoyang90.cn</a></p>
<p>bind 绑定是服务容器最常用的绑定方式，在 <a href="http://leoyang90.cn/2017/05/06/Laravel-container/" target="_blank" rel="external">上一篇</a>文章中我们讨论过，bind 的绑定有三种：</p>
<blockquote>
<ul>
<li>绑定自身</li>
<li>绑定闭包</li>
<li>绑定接口</li>
</ul>
</blockquote>
<p>今天，我们这篇文章主要从源码上讲解 Ioc 服务容器是如何进行绑定的。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* Register a binding with the container.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> string|array $abstract</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> \Closure|string|null $concrete</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> bool $shared</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span><span class="params">($abstract, $concrete = null, $shared = false)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="comment">// If no concrete type was given, we will simply set the concrete type to the</span></div><div class="line">  <span class="comment">// abstract type. After that, the concrete type to be registered as shared</span></div><div class="line">  <span class="comment">// without being forced to state their classes in both of the parameters.</span></div><div class="line">  <span class="keyword">$this</span>-&gt;dropStaleInstances($abstract);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (is_null($concrete)) &#123;</div><div class="line">    $concrete = $abstract;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// If the factory is not a Closure, it means it is just a class name which is</span></div><div class="line">  <span class="comment">// bound into this container to the abstract type and we will just wrap it</span></div><div class="line">  <span class="comment">// up inside its own Closure to give us more convenience when extending.</span></div><div class="line">  <span class="keyword">if</span> (! $concrete <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">    $concrete = <span class="keyword">$this</span>-&gt;getClosure($abstract, $concrete);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">$this</span>-&gt;bindings[$abstract] = compact(<span class="string">'concrete'</span>, <span class="string">'shared'</span>);</div><div class="line"></div><div class="line">  <span class="comment">// If the abstract type was already resolved in this container we'll fire the</span></div><div class="line">  <span class="comment">// rebound listener so that any objects which have already gotten resolved</span></div><div class="line">  <span class="comment">// can have their copy of the object updated via the listener callbacks.</span></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;resolved($abstract)) &#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;rebound($abstract);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从源码中我们可以看出，服务器的绑定有如下几个步骤：</p>
<blockquote>
<ol>
<li>去除原有注册。去除当前绑定接口的原有实现单例对象，和原有的别名，为实现绑定新的实现做准备。</li>
<li>加装闭包。如果实现类不是闭包（绑定自身或者绑定接口），那么就创建闭包，以实现 lazy 加载。</li>
<li>注册。将闭包函数和单例变量存入 bindings 数组中，以备解析时使用。</li>
<li>回调。如果绑定的接口已经被解析过了，将会调用回调函数，对已经解析过的对象进行调整。</li>
</ol>
</blockquote>
<h3 id="去除原有注册"><a href="#去除原有注册" class="headerlink" title="去除原有注册"></a>去除原有注册</h3><p>dropStaleInstances 用于去除当前接口原有的注册和别名，这里负责清除绑定的 aliases 和单例对象的 instances，bindings 后面再做修改：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">dropStaleInstances</span><span class="params">($abstract)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;instances[$abstract], <span class="keyword">$this</span>-&gt;aliases[$abstract]);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="加装闭包"><a href="#加装闭包" class="headerlink" title="加装闭包"></a>加装闭包</h3><p>getClosure 的作用是为注册的非闭包实现外加闭包，这样做有两个作用：</p>
<ul>
<li>延时加载</li>
</ul>
<p>服务容器在 getClosure 中为每个绑定的类都包一层闭包，这样服务容器就只有进行解析的时候闭包才会真正进行运行，实现了 lazy 加载的功能。</p>
<ul>
<li>递归绑定</li>
</ul>
<p>对于服务容器来说，绑定是可以递归的，例如：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$app-&gt;bind(A::class,B::class);</div><div class="line">$app-&gt;bind(B::class,C::class);</div><div class="line">$app-&gt;bind(C::class,<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> C;</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>对于 A 类，我们直接解析 A 可以得到 B 类，但是如果仅仅到此为止，服务容器直接去用反射去创建 B 类的话，那么就很有可能创建失败，因为 B 类很有可能也是接口，B 接口绑定了其他实现类，要知道接口是无法实例化的。</p>
<p>因此服务容器需要递归地对 A 进行解析，这个就是 getClosure 的作用，它把所有可能会递归的绑定在闭包中都用 make 函数，这样解析 make(A::class) 的时候得到闭包 make(B::class)，make(B::class) 的时候会得到闭包 make(C::class)，make(C::class) 终于可以得到真正的实现了。</p>
<p>对于自我绑定的情况，因为不存在递归情况，所以在闭包中会使用 build 函数直接创建对象。（如果仍然使用 make，那就无限循环了）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getClosure</span><span class="params">($abstract, $concrete)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($container, $parameters = [])</span> <span class="title">use</span> <span class="params">($abstract, $concrete)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> ($abstract == $concrete) &#123;</div><div class="line">            <span class="keyword">return</span> $container-&gt;build($concrete);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> $container-&gt;makeWith($concrete, $parameters);</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h3><p>注册就是向 binding 数组中添加注册的接口与它的实现，其中 compact() 函数创建包含变量名和它们的值的数组，创建后的结果为：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$bindings[$abstract] = [</div><div class="line">  <span class="string">'concrete'</span> =&gt; $concrete,</div><div class="line">  <span class="string">'shared'</span> =&gt; $shared</div><div class="line">]</div></pre></td></tr></table></figure></p>
<h3 id="回调"><a href="#回调" class="headerlink" title="回调"></a>回调</h3><p>注册之后，还要查看当前注册的接口是否已经被实例化，如果已经被服务容器实例化过，那么就要调用回调函数。（若存在回调函数）<br>resolved() 函数用于判断当前接口是否曾被解析过，在判断之前，先获取了接口的最终服务名：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">resolved</span><span class="params">($abstract)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isAlias($abstract)) &#123;</div><div class="line">        $abstract = <span class="keyword">$this</span>-&gt;getAlias($abstract);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;resolved[$abstract]) ||</div><div class="line">        <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;instances[$abstract]);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isAlias</span><span class="params">($name)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;aliases[$name]);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>getAlias() 函数利用递归的方法获取别名的最终服务名称：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAlias</span><span class="params">($abstract)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;aliases[$abstract])) &#123;</div><div class="line">        <span class="keyword">return</span> $abstract;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;aliases[$abstract] === $abstract) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> LogicException(<span class="string">"[&#123;$abstract&#125;] is aliased to itself."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getAlias(<span class="keyword">$this</span>-&gt;aliases[$abstract]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果当前接口已经被解析过了，那么就要运行回调函数：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">rebound</span><span class="params">($abstract)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $instance = <span class="keyword">$this</span>-&gt;make($abstract);</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;getReboundCallbacks($abstract) <span class="keyword">as</span> $callback) &#123;</div><div class="line">        call_user_func($callback, <span class="keyword">$this</span>, $instance);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getReboundCallbacks</span><span class="params">($abstract)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;reboundCallbacks[$abstract])) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;reboundCallbacks[$abstract];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> [];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里面的 reboundCallbacks 从哪里来呢？这就是 <a href="http://www.leoyang90.cn/2017/05/06/Laravel-container/" target="_blank" rel="external">Laravel核心——Ioc服务容器</a>  文章中提到的 rebinding<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rebinding</span><span class="params">($abstract, Closure $callback)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;reboundCallbacks[$abstract = <span class="keyword">$this</span>-&gt;getAlias($abstract)][] = $callback;</div><div class="line">   </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;bound($abstract)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;make($abstract);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>值得注意的是： rebinding 函数不仅绑定了回调函数，同时顺带还对接口abstract进行了解析，因为只有解析过，下次注册才会调用回调函数。</p>
<h2 id="singleton-绑定"><a href="#singleton-绑定" class="headerlink" title="singleton 绑定"></a>singleton 绑定</h2><p>singleton 绑定仅仅是 bind 绑定的一个 shared 为真的形式：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">singleton</span><span class="params">($abstract, $concrete = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;bind($abstract, $concrete, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="instance-绑定"><a href="#instance-绑定" class="headerlink" title="instance 绑定"></a>instance 绑定</h2><p>不对接口进行解析，直接给接口一个实例作为单例对象。从下面可以看出，主要的工作就是去除接口在abstractAliases 数组和 aliases 数组中的痕迹，防止 make 函数根据别名继续解析下去出现错误。如果当前接口曾经注册过，那么就调用回调函数。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">instance</span><span class="params">($abstract, $instance)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;removeAbstractAlias($abstract);</div><div class="line"></div><div class="line">    $isBound = <span class="keyword">$this</span>-&gt;bound($abstract);</div><div class="line">     </div><div class="line">    <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;aliases[$abstract]); </div><div class="line">           </div><div class="line">    <span class="keyword">$this</span>-&gt;instances[$abstract] = $instance;</div><div class="line">        </div><div class="line">    <span class="keyword">if</span> ($isBound) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;rebound($abstract);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">removeAbstractAlias</span><span class="params">($searched)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;aliases[$searched])) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;abstractAliases <span class="keyword">as</span> $abstract =&gt; $aliases) &#123;</div><div class="line">        <span class="keyword">foreach</span> ($aliases <span class="keyword">as</span> $index =&gt; $alias) &#123;</div><div class="line">            <span class="keyword">if</span> ($alias == $searched) &#123;</div><div class="line">                <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;abstractAliases[$abstract][$index]);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bound</span><span class="params">($abstract)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;bindings[$abstract]) ||</div><div class="line">           <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;instances[$abstract]) ||</div><div class="line">           <span class="keyword">$this</span>-&gt;isAlias($abstract);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Context-绑定"><a href="#Context-绑定" class="headerlink" title="Context 绑定"></a>Context 绑定</h2><p>Context 绑定一般用于依赖注入，当我们利用依赖注入来自动实例化对象时，服务容器其实是利用反射机制来为构造函数实例化它的参数，这个过程中，被实例化的对象就是下面的 concrete，构造函数的参数接口是 abstract，参数接口实际的实现是 implementation。<br>例如：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;when(PhotoController::class)</div><div class="line">          -&gt;needs(Filesystem::class)</div><div class="line">          -&gt;give(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">              <span class="keyword">return</span> Storage::disk(<span class="string">'local'</span>);</div><div class="line">          &#125;);</div></pre></td></tr></table></figure></p>
<p>这里实例化对象 concrete 就是 PhotoController，构造函数的参数接口 abstract 就是 Filesystem。参数接口实际实现 implementation 是 Storage::disk(‘local’)。</p>
<p>这样，每次进行解析构造函数的参数接口的时候，都会去判断当前的 contextual 数组里面 concrete[concrete] [abstract]（也就是 concrete[PhotoController::class] [Filesystem::class]）对应的上下文绑定，如果有就直接从数组中取出来，如果没有就按照正常方式解析。<br>值得注意的是，concrete 和 abstract 都是利用 getAlias 函数，保证最后拿到的不是别名。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">when</span><span class="params">($concrete)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ContextualBindingBuilder(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;getAlias($concrete));</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Container $container, $concrete)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;concrete = $concrete;</div><div class="line">    <span class="keyword">$this</span>-&gt;container = $container;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">needs</span><span class="params">($abstract)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;needs = $abstract;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">give</span><span class="params">($implementation)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;container-&gt;addContextualBinding(</div><div class="line">        <span class="keyword">$this</span>-&gt;concrete, <span class="keyword">$this</span>-&gt;needs, $implementation</div><div class="line">    );</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addContextualBinding</span><span class="params">($concrete, $abstract, $implementation)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;contextual[$concrete][<span class="keyword">$this</span>-&gt;getAlias($abstract)] = $implementation;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="tag-绑定"><a href="#tag-绑定" class="headerlink" title="tag 绑定"></a>tag 绑定</h2><p>标签绑定比较简单，绑定过程就是将标签和接口之间建立一个对应数组，在解析的过程中，按照标签把所有接口都解析一遍即可。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tag</span><span class="params">($abstracts, $tags)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $tags = is_array($tags) ? $tags : array_slice(func_get_args(), <span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> ($tags <span class="keyword">as</span> $tag) &#123;</div><div class="line">        <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;tags[$tag])) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;tags[$tag] = [];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">foreach</span> ((<span class="keyword">array</span>) $abstracts <span class="keyword">as</span> $abstract) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;tags[$tag][] = $abstract;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="数组绑定"><a href="#数组绑定" class="headerlink" title="数组绑定"></a>数组绑定</h2><p>利用数组进行绑定的时候 ($app()[A::class] = B::class)，服务容器会调用 offsetSet 函数:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetSet</span><span class="params">($key, $value)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;bind($key, $value <span class="keyword">instanceof</span> Closure ? $value : <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($value)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> $value;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="extend扩展"><a href="#extend扩展" class="headerlink" title="extend扩展"></a>extend扩展</h1><p>extend 扩展分为两种，一种是针对instance注册的对象，这种情况将立即起作用，并更新之前实例化的对象;另一种情况是非 instance 注册的对象，那么闭包函数将会被放入 extenders 数组中，将在下一次实例化对象的时候才起作用：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">extend</span><span class="params">($abstract, Closure $closure)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $abstract = <span class="keyword">$this</span>-&gt;getAlias($abstract);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;instances[$abstract])) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;instances[$abstract] = $closure(<span class="keyword">$this</span>-&gt;instances[$abstract], <span class="keyword">$this</span>);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;rebound($abstract);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;extenders[$abstract][] = $closure;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;resolved()) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;rebound($abstract);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="服务器事件"><a href="#服务器事件" class="headerlink" title="服务器事件"></a>服务器事件</h1><p>服务器的事件注册依靠 resolving 函数和 afterResolving 函数，这两个函数维护着 globalResolvingCallbacks、resolvingCallbacks、globalAfterResolvingCallbacks、afterResolvingCallbacks 数组，这些数组中存放着事件的回调闭包函数，每当对对象进行解析时就会遍历这些数组，触发事件：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">resolving</span><span class="params">($abstract, Closure $callback = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (is_string($abstract)) &#123;</div><div class="line">        $abstract = <span class="keyword">$this</span>-&gt;getAlias($abstract);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (is_null($callback) &amp;&amp; $abstract <span class="keyword">instanceof</span> Closure) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;globalResolvingCallbacks[] = $abstract;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;resolvingCallbacks[$abstract][] = $callback;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">afterResolving</span><span class="params">($abstract, Closure $callback = null)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (is_string($abstract)) &#123;</div><div class="line">        $abstract = <span class="keyword">$this</span>-&gt;getAlias($abstract);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($abstract <span class="keyword">instanceof</span> Closure &amp;&amp; is_null($callback)) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;globalAfterResolvingCallbacks[] = $abstract;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;afterResolvingCallbacks[$abstract][] = $callback;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>Written with <a href="https://stackedit.io/" target="_blank" rel="external">StackEdit</a>.</p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/05/06/Laravel Container——Laravel-container/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/06/Laravel Container——Laravel-container/" itemprop="url">
                  Laravel核心——Ioc服务容器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-06T16:45:00+08:00">
                2017-05-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/laravel/" itemprop="url" rel="index">
                    <span itemprop="name">laravel</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/laravel/源码/" itemprop="url" rel="index">
                    <span itemprop="name">源码</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/05/06/Laravel Container——Laravel-container/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/05/06/Laravel Container——Laravel-container/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/05/06/Laravel Container——Laravel-container/" class="leancloud_visitors" data-flag-title="Laravel核心——Ioc服务容器">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="服务容器"><a href="#服务容器" class="headerlink" title="服务容器"></a>服务容器</h1><hr>
<p>在说 Ioc 容器之前，我们需要了解什么是 Ioc 容器。</p>
<blockquote>
<p>Laravel 服务容器是一个用于管理类依赖和执行依赖注入的强大工具。</p>
</blockquote>
<p>在理解这句话之前，我们需要先了解一下服务容器的来龙去脉： <a href="https://www.insp.top/learn-laravel-container" target="_blank" rel="external">laravel神奇的服务容器</a>。这篇博客告诉我们，服务容器就是工厂模式的升级版，对于传统的工厂模式来说，虽然解耦了对象和外部资源之间的关系，但是工厂和外部资源之间却存在了耦和。而服务容器在为对象创建了外部资源的同时，又与外部资源没有任何关系，这个就是 Ioc 容器。<br>&emsp;<br>所谓的依赖注入和控制反转:  <a href="http://blog.csdn.net/doris_crazy/article/details/18353197" target="_blank" rel="external">依赖注入和控制反转</a>，就是</p>
<blockquote>
<p>只要不是由内部生产（比如初始化、构造函数  __construct  中通过工厂方法、自行手动 new 的），而是由外部以参数或其他形式注入的，都属于依赖注入（DI）</p>
</blockquote>
<p>也就是说：</p>
<blockquote>
<p>依赖注入是从应用程序的角度在描述，可以把依赖注入描述完整点：应用程序依赖容器创建并注入它所需要的外部资源；</p>
<p>控制反转是从容器的角度在描述，描述完整点：容器控制应用程序，由容器反向的向应用程序注入应用程序所需要的外部资源。</p>
</blockquote>
<h1 id="Laravel中的服务容器"><a href="#Laravel中的服务容器" class="headerlink" title="Laravel中的服务容器"></a>Laravel中的服务容器</h1><hr>
<p>Laravel服务容器主要承担两个作用：绑定与解析，服务容器的结构如下：<br>&emsp;<br><img src="http://i1.piimg.com/593560/2f28f1762b1b09f9.png" alt="Markdown"></p>
<h2 id="绑定"><a href="#绑定" class="headerlink" title="绑定"></a>绑定</h2><p>所谓的绑定就是将接口与实现建立对应关系。几乎所有的服务容器绑定都是在服务提供者中完成，也就是在服务提供者中绑定。</p>
<blockquote>
<p>如果一个类没有基于任何接口那么就没有必要将其绑定到容器。容器并不需要被告知如何构建对象，因为它会使用  PHP 的反射服务自动解析出具体的对象。</p>
</blockquote>
<p>也就是说，如果需要依赖注入的外部资源如果没有接口，那么就不需要绑定，直接利用服务容器进行解析就可以了，服务容器会根据类名利用反射对其进行自动构造。</p>
<h3 id="bind绑定"><a href="#bind绑定" class="headerlink" title="bind绑定"></a>bind绑定</h3><p>绑定有多种方法，首先最常用的是bind函数的绑定：</p>
<ul>
<li>绑定自身</li>
</ul>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;bind(<span class="string">'App\Services\RedisEventPusher'</span>, <span class="keyword">null</span>);</div></pre></td></tr></table></figure>
<ul>
<li>绑定闭包</li>
</ul>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;bind(<span class="string">'name'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'Taylor'</span>;</div><div class="line">&#125;);<span class="comment">//闭包返回变量</span></div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;bind(<span class="string">'HelpSpot\API'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> HelpSpot\API::class;</div><div class="line">&#125;);<span class="comment">//闭包直接提供类实现方式</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testSharedClosureResolution</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $class = <span class="keyword">new</span> stdClass;</div><div class="line">    $container-&gt;bind(<span class="string">'class'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($class)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $class;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertSame($class, $container-&gt;make(<span class="string">'class'</span>));</div><div class="line">&#125;<span class="comment">//闭包返回类变量</span></div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;bind(<span class="string">'HelpSpot\API'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HelpSpot\API();</div><div class="line">&#125;);<span class="comment">//闭包直接提供类实现方式</span></div><div class="line">  </div><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;bind(<span class="string">'HelpSpot\API'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HelpSpot\API($app-&gt;make(<span class="string">'HttpClient'</span>));</div><div class="line">&#125;);<span class="comment">//闭包返回需要依赖注入的类</span></div></pre></td></tr></table></figure>
<ul>
<li>绑定接口</li>
</ul>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testCanBuildWithoutParameterStackWithConstructors</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;bind(<span class="string">'Illuminate\Tests\Container\IContainerContractStub'</span>, </div><div class="line">                     <span class="string">'Illuminate\Tests\Container\ContainerImplementationStub'</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">$this</span>-&gt;assertInstanceOf(ContainerDependentStub::class, </div><div class="line">                            $container-&gt;build(ContainerDependentStub::class));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IContainerContractStub</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContainerImplementationStub</span> <span class="keyword">implements</span> <span class="title">IContainerContractStub</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContainerDependentStub</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> $impl;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(IContainerContractStub $impl)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;impl = $impl;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这三种绑定方式中，第一种绑定自身一般用于绑定单例。</p>
<h3 id="bindif绑定"><a href="#bindif绑定" class="headerlink" title="bindif绑定"></a>bindif绑定</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testBindIfDoesntRegisterIfServiceAlreadyRegistered</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;bind(<span class="string">'name'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></div><div class="line"><span class="function">         <span class="title">return</span> '<span class="title">Taylor</span>'</span>;</div><div class="line">     &#125;);</div><div class="line"></div><div class="line">    $container-&gt;bindIf(<span class="string">'name'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">         <span class="keyword">return</span> <span class="string">'Dayle'</span>;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'Taylor'</span>, $container-&gt;make(<span class="string">'name'</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="singleton绑定"><a href="#singleton绑定" class="headerlink" title="singleton绑定"></a>singleton绑定</h3><p>singleton 方法绑定一个只需要解析一次的类或接口到容器，然后接下来对容器的调用将会返回同一个实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;singleton(<span class="string">'HelpSpot\API'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HelpSpot\API($app-&gt;make(<span class="string">'HttpClient'</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>值得注意的是，singleton绑定在解析的时候若存在参数重载，那么就自动取消单例模式。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testSingletonBindingsNotRespectedWithMakeParameters</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line"></div><div class="line">    $container-&gt;singleton(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app, $config)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $config;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals([<span class="string">'name'</span> =&gt; <span class="string">'taylor'</span>], $container-&gt;makeWith(<span class="string">'foo'</span>, [<span class="string">'name'</span> =&gt; <span class="string">'taylor'</span>]));</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals([<span class="string">'name'</span> =&gt; <span class="string">'abigail'</span>], $container-&gt;makeWith(<span class="string">'foo'</span>, [<span class="string">'name'</span> =&gt; <span class="string">'abigail'</span>]));</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h3 id="instance绑定"><a href="#instance绑定" class="headerlink" title="instance绑定"></a>instance绑定</h3><p>我们还可以使用 instance 方法绑定一个已存在的对象实例到容器，随后调用容器将总是返回给定的实例：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$api = <span class="keyword">new</span> HelpSpot\API(<span class="keyword">new</span> HttpClient);</div><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'HelpSpot\Api'</span>, $api);</div></pre></td></tr></table></figure>
<h3 id="Context绑定"><a href="#Context绑定" class="headerlink" title="Context绑定"></a>Context绑定</h3><p>有时侯我们可能有两个类使用同一个接口，但我们希望在每个类中注入不同实现，例如，两个控制器依赖 Illuminate\Contracts\Filesystem\Filesystem 契约的不同实现。Laravel 为此定义了简单、平滑的接口：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Storage</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">VideoController</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">PhotoControllers</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Filesystem</span>\<span class="title">Filesystem</span>;</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;when(StorageController::class)</div><div class="line">          -&gt;needs(Filesystem::class)</div><div class="line">          -&gt;give(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">            Storage::class</div><div class="line">          &#125;);<span class="comment">//提供类名</span></div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;when(PhotoController::class)</div><div class="line">          -&gt;needs(Filesystem::class)</div><div class="line">          -&gt;give(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">             <span class="keyword">return</span> <span class="keyword">new</span> Storage();</div><div class="line">          &#125;);<span class="comment">//提供实现方式</span></div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;when(VideoController::class)</div><div class="line">          -&gt;needs(Filesystem::class)</div><div class="line">          -&gt;give(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Storage($app-&gt;make(Disk::class));</div><div class="line">          &#125;);<span class="comment">//需要依赖注入</span></div></pre></td></tr></table></figure>
<h3 id="原始值绑定"><a href="#原始值绑定" class="headerlink" title="原始值绑定"></a>原始值绑定</h3><p>我们可能有一个接收注入类的类，同时需要注入一个原生的数值比如整型，可以结合上下文轻松注入这个类需要的任何值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;when(<span class="string">'App\Http\Controllers\UserController'</span>)</div><div class="line">          -&gt;needs(<span class="string">'$variableName'</span>)</div><div class="line">          -&gt;give($value);</div></pre></td></tr></table></figure>
<h3 id="数组绑定"><a href="#数组绑定" class="headerlink" title="数组绑定"></a>数组绑定</h3><p>数组绑定一般用于绑定闭包和变量，但是不能绑定接口，否则只能返回接口的实现类名字符串,并不能返回实现类的对象。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testArrayAccess</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container[IContainerContractStub::class] = ContainerImplementationStub::class;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertTrue(<span class="keyword">isset</span>($container[IContainerContractStub::class]));</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(ContainerImplementationStub::class, </div><div class="line">                        $container[IContainerContractStub::class]);</div><div class="line"></div><div class="line">    <span class="keyword">unset</span>($container[<span class="string">'something'</span>]);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertFalse(<span class="keyword">isset</span>($container[<span class="string">'something'</span>]));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="标签绑定"><a href="#标签绑定" class="headerlink" title="标签绑定"></a>标签绑定</h3><p>少数情况下，我们需要解析特定分类下的所有绑定，例如，你正在构建一个接收多个不同 Report 接口实现的报告聚合器，在注册完 Report 实现之后，可以通过 tag 方法给它们分配一个标签：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;bind(<span class="string">'SpeedReport'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;bind(<span class="string">'MemoryReport'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;tag([<span class="string">'SpeedReport'</span>, <span class="string">'MemoryReport'</span>], <span class="string">'reports'</span>);</div></pre></td></tr></table></figure>
<p>这些服务被打上标签后，可以通过 tagged 方法来轻松解析它们：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;bind(<span class="string">'ReportAggregator'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ReportAggregator($app-&gt;tagged(<span class="string">'reports'</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testContainerTags</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">       $container = <span class="keyword">new</span> Container;</div><div class="line">       $container-&gt;tag(<span class="string">'Illuminate\Tests\Container\ContainerImplementationStub'</span>, <span class="string">'foo'</span>, <span class="string">'bar'</span>);</div><div class="line">       $container-&gt;tag(<span class="string">'Illuminate\Tests\Container\ContainerImplementationStubTwo'</span>, [<span class="string">'foo'</span>]);</div><div class="line"></div><div class="line">       <span class="keyword">$this</span>-&gt;assertCount(<span class="number">1</span>, $container-&gt;tagged(<span class="string">'bar'</span>));</div><div class="line">       <span class="keyword">$this</span>-&gt;assertCount(<span class="number">2</span>, $container-&gt;tagged(<span class="string">'foo'</span>));</div><div class="line">       <span class="keyword">$this</span>-&gt;assertInstanceOf(<span class="string">'Illuminate\Tests\Container\ContainerImplementationStub'</span>, $container-&gt;tagged(<span class="string">'foo'</span>)[<span class="number">0</span>]);</div><div class="line">       <span class="keyword">$this</span>-&gt;assertInstanceOf(<span class="string">'Illuminate\Tests\Container\ContainerImplementationStub'</span>, $container-&gt;tagged(<span class="string">'bar'</span>)[<span class="number">0</span>]);</div><div class="line">       <span class="keyword">$this</span>-&gt;assertInstanceOf(<span class="string">'Illuminate\Tests\Container\ContainerImplementationStubTwo'</span>, $container-&gt;tagged(<span class="string">'foo'</span>)[<span class="number">1</span>]);</div><div class="line"></div><div class="line">       $container = <span class="keyword">new</span> Container;</div><div class="line">       $container-&gt;tag([<span class="string">'Illuminate\Tests\Container\ContainerImplementationStub'</span>, <span class="string">'Illuminate\Tests\Container\ContainerImplementationStubTwo'</span>], [<span class="string">'foo'</span>]);</div><div class="line">       <span class="keyword">$this</span>-&gt;assertCount(<span class="number">2</span>, $container-&gt;tagged(<span class="string">'foo'</span>));</div><div class="line">       <span class="keyword">$this</span>-&gt;assertInstanceOf(<span class="string">'Illuminate\Tests\Container\ContainerImplementationStub'</span>, $container-&gt;tagged(<span class="string">'foo'</span>)[<span class="number">0</span>]);</div><div class="line">       <span class="keyword">$this</span>-&gt;assertInstanceOf(<span class="string">'Illuminate\Tests\Container\ContainerImplementationStubTwo'</span>, $container-&gt;tagged(<span class="string">'foo'</span>)[<span class="number">1</span>]);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;assertEmpty($container-&gt;tagged(<span class="string">'this_tag_does_not_exist'</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="extend扩展"><a href="#extend扩展" class="headerlink" title="extend扩展"></a>extend扩展</h3><p>extend是在当原来的类被注册或者实例化出来后，可以对其进行扩展，而且可以支持多重扩展：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testExtendInstancesArePreserved</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;bind(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        $obj = <span class="keyword">new</span> StdClass;</div><div class="line">        $obj-&gt;foo = <span class="string">'bar'</span>;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $obj;</div><div class="line">    &#125;);</div><div class="line"> </div><div class="line">    $obj = <span class="keyword">new</span> StdClass;</div><div class="line">    $obj-&gt;foo = <span class="string">'foo'</span>;</div><div class="line">    $container-&gt;instance(<span class="string">'foo'</span>, $obj);</div><div class="line">  </div><div class="line">    $container-&gt;extend(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($obj, $container)</span> </span>&#123;</div><div class="line">        $obj-&gt;bar = <span class="string">'baz'</span>;</div><div class="line">        <span class="keyword">return</span> $obj;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    $container-&gt;extend(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($obj, $container)</span> </span>&#123;</div><div class="line">        $obj-&gt;baz = <span class="string">'foo'</span>;</div><div class="line">        <span class="keyword">return</span> $obj;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'foo'</span>, $container-&gt;make(<span class="string">'foo'</span>)-&gt;foo);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'baz'</span>, $container-&gt;make(<span class="string">'foo'</span>)-&gt;bar);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'foo'</span>, $container-&gt;make(<span class="string">'foo'</span>)-&gt;baz);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Rebounds与Rebinding"><a href="#Rebounds与Rebinding" class="headerlink" title="Rebounds与Rebinding"></a>Rebounds与Rebinding</h3><p>绑定是针对接口的，是为接口提供实现方式的方法。我们可以对接口在不同的时间段里提供不同的实现方法，一般来说，对同一个接口提供新的实现方法后，不会对已经实例化的对象产生任何影响。但是在一些场景下，在提供新的接口实现后，我们希望对已经实例化的对象重新做一些改变，这个就是 rebinding 函数的用途。<br>下面就是一个例子：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Car</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Fuel $fuel)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;fuel = $fuel;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">refuel</span><span class="params">($litres)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> $litres * <span class="keyword">$this</span>-&gt;fuel-&gt;getPrice();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setFuel</span><span class="params">(Fuel $fuel)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;fuel = $fuel;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JeepWrangler</span> <span class="keyword">extends</span> <span class="title">Car</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Fuel</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getPrice</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Petrol</span> <span class="keyword">implements</span> <span class="title">Fuel</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getPrice</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">130.7</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们在服务容器中是这样对car接口和fuel接口绑定的：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;bind(<span class="string">'fuel'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Petrol;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;bind(<span class="string">'car'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JeepWrangler($app[<span class="string">'fuel'</span>]);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;make(<span class="string">'car'</span>);</div></pre></td></tr></table></figure></p>
<p>如果car被服务容器解析实例化成对象之后，有人修改了 fuel 接口的实现，从 Petrol 改为 PremiumPetrol：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;bind(<span class="string">'fuel'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PremiumPetrol;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>由于 car 已经被实例化，那么这个接口实现的改变并不会影响到 car 的实现，假若我们想要 car 的成员变量 fuel 随着 fuel 接口的变化而变化，我们就需要一个回调函数，每当对 fuel 接口实现进行改变的时候，都要对 car 的 fuel 变量进行更新，这就是 rebinding 的用途：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;bindShared(<span class="string">'car'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JeepWrangler($app-&gt;rebinding(<span class="string">'fuel'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app, $fuel)</span> </span>&#123;</div><div class="line">        $app[<span class="string">'car'</span>]-&gt;setFuel($fuel);</div><div class="line">    &#125;));</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="服务别名"><a href="#服务别名" class="headerlink" title="服务别名"></a>服务别名</h2><h3 id="什么是服务别名"><a href="#什么是服务别名" class="headerlink" title="什么是服务别名"></a>什么是服务别名</h3><p>在说服务容器的解析之前，需要先说说服务的别名。什么是服务别名呢？不同于上一个博客中提到的 Facade 门面的别名(在 config/app 中定义)，这里的别名服务绑定名称的别名。通过服务绑定的别名，在解析服务的时候，跟不使用别名的效果一致。别名的作用也是为了同时支持全类型的服务绑定名称以及简短的服务绑定名称考虑的。<br>&emsp;<br>通俗的讲，假如我们想要创建 auth 服务，我们既可以这样写：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;make(<span class="string">'auth'</span>)</div></pre></td></tr></table></figure>
<p>又可以写成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;make(<span class="string">'\Illuminate\Auth\AuthManager::class'</span>)</div></pre></td></tr></table></figure>
<p>还可以写成</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;make(<span class="string">'\Illuminate\Contracts\Auth\Factory::class'</span>)</div></pre></td></tr></table></figure>
<p>后面两个服务的名字都是 auth 的别名，使用别名和使用 auth 的效果是相同的。</p>
<h3 id="服务别名的递归"><a href="#服务别名的递归" class="headerlink" title="服务别名的递归"></a>服务别名的递归</h3><p>需要注意的是别名是可以递归的：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">app()-&gt;alias(<span class="string">'service'</span>, <span class="string">'alias_a'</span>);</div><div class="line">app()-&gt;alias(<span class="string">'alias_a'</span>, <span class="string">'alias_b'</span>);</div><div class="line">app()-alias(<span class="string">'alias_b'</span>, <span class="string">'alias_c'</span>);</div></pre></td></tr></table></figure></p>
<p>会得到：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="string">'alias_a'</span> =&gt; <span class="string">'service'</span></div><div class="line"><span class="string">'alias_b'</span> =&gt; <span class="string">'alias_a'</span></div><div class="line"><span class="string">'alias_c'</span> =&gt; <span class="string">'alias_b'</span></div></pre></td></tr></table></figure></p>
<h3 id="服务别名的实现"><a href="#服务别名的实现" class="headerlink" title="服务别名的实现"></a>服务别名的实现</h3><p>那么这些别名是如何加载到服务容器里面的呢？实际上，服务容器里面有个 aliases 数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$aliases = [</div><div class="line">  <span class="string">'app'</span> =&gt; [\Illuminate\Foundation\Application::class, \Illuminate\Contracts\Container\Container::class, \Illuminate\Contracts\Foundation\Application::class],</div><div class="line">  <span class="string">'auth'</span> =&gt; [\Illuminate\Auth\AuthManager::class, \Illuminate\Contracts\Auth\Factory::class],</div><div class="line">  <span class="string">'auth.driver'</span> =&gt; [\Illuminate\Contracts\Auth\Guard::class],</div><div class="line">  <span class="string">'blade.compiler'</span> =&gt; [\Illuminate\View\Compilers\BladeCompiler::class],</div><div class="line">  <span class="string">'cache'</span> =&gt; [\Illuminate\Cache\CacheManager::class, \Illuminate\Contracts\Cache\Factory::class],</div><div class="line">...</div><div class="line">]</div></pre></td></tr></table></figure>
<p>而服务容器的初始化的过程中，会运行一个函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">registerCoreContainerAliases</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">foreach</span> ($aliases <span class="keyword">as</span> $key =&gt; $aliases) &#123;</div><div class="line">    <span class="keyword">foreach</span> ($aliases <span class="keyword">as</span> $alias) &#123;</div><div class="line">      <span class="keyword">$this</span>-&gt;alias($key, $alias);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">alias</span><span class="params">($abstract, $alias)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">$this</span>-&gt;aliases[$alias] = $abstract;</div><div class="line"></div><div class="line">  <span class="keyword">$this</span>-&gt;abstractAliases[$abstract][] = $alias;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>加载后，服务容器的aliases和abstractAliases数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">$aliases = [</div><div class="line">  <span class="string">'Illuminate\Foundation\Application'</span> = <span class="string">"app"</span></div><div class="line">  <span class="string">'Illuminate\Contracts\Container\Container'</span> = <span class="string">"app"</span></div><div class="line">  <span class="string">'Illuminate\Contracts\Foundation\Application'</span> = <span class="string">"app"</span></div><div class="line">  <span class="string">'Illuminate\Auth\AuthManager'</span> = <span class="string">"auth"</span></div><div class="line">  <span class="string">'Illuminate\Contracts\Auth\Factory'</span> = <span class="string">"auth"</span></div><div class="line">  <span class="string">'Illuminate\Contracts\Auth\Guard'</span> = <span class="string">"auth.driver"</span></div><div class="line">  <span class="string">'Illuminate\View\Compilers\BladeCompiler'</span> = <span class="string">"blade.compiler"</span></div><div class="line">  <span class="string">'Illuminate\Cache\CacheManager'</span> = <span class="string">"cache"</span></div><div class="line">  <span class="string">'Illuminate\Contracts\Cache\Factory'</span> = <span class="string">"cache"</span></div><div class="line">  ...</div><div class="line">］</div><div class="line">$abstractAliases = [</div><div class="line">  app = &#123;<span class="keyword">array</span>&#125; [<span class="number">3</span>]</div><div class="line">  <span class="number">0</span> = <span class="string">"Illuminate\Foundation\Application"</span></div><div class="line">  <span class="number">1</span> = <span class="string">"Illuminate\Contracts\Container\Container"</span></div><div class="line">  <span class="number">2</span> = <span class="string">"Illuminate\Contracts\Foundation\Application"</span></div><div class="line">  auth = &#123;<span class="keyword">array</span>&#125; [<span class="number">2</span>]</div><div class="line">  <span class="number">0</span> = <span class="string">"Illuminate\Auth\AuthManager"</span></div><div class="line">  <span class="number">1</span> = <span class="string">"Illuminate\Contracts\Auth\Factory"</span></div><div class="line">  auth.driver = &#123;<span class="keyword">array</span>&#125; [<span class="number">1</span>]</div><div class="line">  <span class="number">0</span> = <span class="string">"Illuminate\Contracts\Auth\Guard"</span></div><div class="line">  blade.compiler = &#123;<span class="keyword">array</span>&#125; [<span class="number">1</span>]</div><div class="line">  <span class="number">0</span> = <span class="string">"Illuminate\View\Compilers\BladeCompiler"</span></div><div class="line">  cache = &#123;<span class="keyword">array</span>&#125; [<span class="number">2</span>]</div><div class="line">  <span class="number">0</span> = <span class="string">"Illuminate\Cache\CacheManager"</span></div><div class="line">  <span class="number">1</span> = <span class="string">"Illuminate\Contracts\Cache\Factory"</span></div><div class="line">  ...</div><div class="line">]</div></pre></td></tr></table></figure>
<h2 id="服务解析"><a href="#服务解析" class="headerlink" title="服务解析"></a>服务解析</h2><h3 id="make-解析"><a href="#make-解析" class="headerlink" title="make 解析"></a>make 解析</h3><p>有很多方式可以从容器中解析对象，首先，你可以使用 make 方法，该方法接收你想要解析的类名或接口名作为参数：</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testAutoConcreteResolution</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    <span class="keyword">$this</span>-&gt;assertInstanceOf(<span class="string">'Illuminate\Tests\Container\ContainerConcreteStub'</span>, </div><div class="line">           $container-&gt;make(<span class="string">'Illuminate\Tests\Container\ContainerConcreteStub'</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//带有依赖注入和默认值的解析</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testResolutionOfDefaultParameters</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">       $container = <span class="keyword">new</span> Container;</div><div class="line">       $instance = $container-&gt;make(<span class="string">'Illuminate\Tests\Container\ContainerDefaultValueStub'</span>);</div><div class="line">       <span class="keyword">$this</span>-&gt;assertInstanceOf(<span class="string">'Illuminate\Tests\Container\ContainerConcreteStub'</span>, </div><div class="line">                                $instance-&gt;stub);</div><div class="line">       <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'taylor'</span>, $instance-&gt;default);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testResolvingWithArrayOfParameters</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    </div><div class="line">    $instance = $container-&gt;makeWith(ContainerDefaultValueStub::class, [<span class="string">'default'</span> =&gt; <span class="string">'adam'</span>]);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'adam'</span>, $instance-&gt;default);</div><div class="line">    </div><div class="line">    $instance = $container-&gt;make(ContainerDefaultValueStub::class);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'taylor'</span>, $instance-&gt;default);</div><div class="line">    </div><div class="line">    $container-&gt;bind(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app, $config)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $config;</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], $container-&gt;makeWith(<span class="string">'foo'</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testNestedDependencyResolution</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;bind(<span class="string">'Illuminate\Tests\Container\IContainerContractStub'</span>, <span class="string">'Illuminate\Tests\Container\ContainerImplementationStub'</span>);</div><div class="line">    $class = $container-&gt;make(<span class="string">'Illuminate\Tests\Container\ContainerNestedDependentStub'</span>);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertInstanceOf(<span class="string">'Illuminate\Tests\Container\ContainerDependentStub'</span>, $class-&gt;inner);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertInstanceOf(<span class="string">'Illuminate\Tests\Container\ContainerImplementationStub'</span>, $class-&gt;inner-&gt;impl);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContainerDefaultValueStub</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> $stub;</div><div class="line">    <span class="keyword">public</span> $default;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(ContainerConcreteStub $stub, $default = <span class="string">'taylor'</span>)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;stub = $stub;</div><div class="line">        <span class="keyword">$this</span>-&gt;default = $default;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContainerConcreteStub</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContainerImplementationStub</span> <span class="keyword">implements</span> <span class="title">IContainerContractStub</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContainerDependentStub</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> $impl;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(IContainerContractStub $impl)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;impl = $impl;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContainerNestedDependentStub</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> $inner;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(ContainerDependentStub $inner)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;inner = $inner;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  如果你所在的代码位置访问不了 $app 变量，可以使用辅助函数resolve：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$api = resolve(<span class="string">'HelpSpot\API'</span>);</div></pre></td></tr></table></figure>
<h3 id="自动注入"><a href="#自动注入" class="headerlink" title="自动注入"></a>自动注入</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Users</span>\<span class="title">Repository</span> <span class="title">as</span> <span class="title">UserRepository</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">  * 用户仓库实例</span></div><div class="line"><span class="comment">  */</span></div><div class="line">  <span class="keyword">protected</span> $users;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">  * 创建一个控制器实例</span></div><div class="line"><span class="comment">  *</span></div><div class="line"><span class="comment">  * <span class="doctag">@param</span> UserRepository $users 自动注入</span></div><div class="line"><span class="comment">  * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">  */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UserRepository $users)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;users = $users;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="call-方法注入"><a href="#call-方法注入" class="headerlink" title="call 方法注入"></a>call 方法注入</h3><p>make 解析是服务容器进行解析构建类对象时所用的方法，在实际应用中，还有另外一个需求，那就是当前已经获取了一个类对象，我们想要调用它的一个方法函数，这时发现这个方法中参数众多，如果一个个的 make 会比较繁琐，这个时候就要用到 call 解析了。我们可以看这个例子：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskRepository</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testContainerCall</span><span class="params">(User $user,Task $task)</span></span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;assertInstanceOf(User::class, $user);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;assertInstanceOf(Task::class, $task);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">testContainerCallStatic</span><span class="params">(User $user,Task $task)</span></span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;assertInstanceOf(User::class, $user);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;assertInstanceOf(Task::class, $task);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testCallback</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'call callback successfully!'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testDefaultMethod</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'default Method successfully!'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="闭包函数注入"><a href="#闭包函数注入" class="headerlink" title="闭包函数注入"></a>闭包函数注入</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testCallWithDependencies</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">      $container = <span class="keyword">new</span> Container;</div><div class="line">      $result = $container-&gt;call(<span class="function"><span class="keyword">function</span> <span class="params">(StdClass $foo, $bar = [])</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> func_get_args();</div><div class="line">      &#125;);</div><div class="line"></div><div class="line">      <span class="keyword">$this</span>-&gt;assertInstanceOf(<span class="string">'stdClass'</span>, $result[<span class="number">0</span>]);</div><div class="line">      <span class="keyword">$this</span>-&gt;assertEquals([], $result[<span class="number">1</span>]);</div><div class="line"></div><div class="line">      $result = $container-&gt;call(<span class="function"><span class="keyword">function</span> <span class="params">(StdClass $foo, $bar = [])</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> func_get_args();</div><div class="line">      &#125;, [<span class="string">'bar'</span> =&gt; <span class="string">'taylor'</span>]);</div><div class="line"></div><div class="line">      <span class="keyword">$this</span>-&gt;assertInstanceOf(<span class="string">'stdClass'</span>, $result[<span class="number">0</span>]);</div><div class="line">      <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'taylor'</span>, $result[<span class="number">1</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="普通函数注入"><a href="#普通函数注入" class="headerlink" title="普通函数注入"></a>普通函数注入</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testCallWithGlobalMethodName</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $result = $container-&gt;call(<span class="string">'Illuminate\Tests\Container\containerTestInject'</span>);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertInstanceOf(<span class="string">'Illuminate\Tests\Container\ContainerConcreteStub'</span>, $result[<span class="number">0</span>]);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'taylor'</span>, $result[<span class="number">1</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="静态方法注入"><a href="#静态方法注入" class="headerlink" title="静态方法注入"></a>静态方法注入</h4><p>服务容器的 call 解析主要依靠 call_user_func_array() 函数，关于这个函数可以查看 <a href="https://segmentfault.com/a/1190000006981167" target="_blank" rel="external">Laravel学习笔记之Callback Type - 来生做个漫画家</a>，这个函数对类中的静态函数和非静态函数有一些区别，对于静态函数来说：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContainerCallTest</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testContainerCallStatic</span><span class="params">()</span></span>&#123;</div><div class="line">        App::call(TaskRepository::class.<span class="string">'@testContainerCallStatic'</span>);</div><div class="line">        App::call(TaskRepository::class.<span class="string">'::testContainerCallStatic'</span>);</div><div class="line">        App::call([TaskRepository::class,<span class="string">'testContainerCallStatic'</span>]);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>服务容器调用类的静态方法有三种，注意第三种使用数组的形式，数组中可以直接传类名  TaskRepository::class；</p>
<h4 id="非静态方法注入"><a href="#非静态方法注入" class="headerlink" title="非静态方法注入"></a>非静态方法注入</h4><p>对于类的非静态方法：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContainerCallTest</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testContainerCall</span><span class="params">()</span></span>&#123;</div><div class="line">        $taskRepo = <span class="keyword">new</span> TaskRepository();</div><div class="line">        App::call(TaskRepository::class.<span class="string">'@testContainerCall'</span>);</div><div class="line">        App::call([$taskRepo,<span class="string">'testContainerCall'</span>]);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们可以看到非静态方法只有两种调用方式，而且第二种数组传递的参数是类对象，原因就是 call_user_func_array函数的限制，对于非静态方法只能传递对象。</p>
<h4 id="bindmethod-方法绑定"><a href="#bindmethod-方法绑定" class="headerlink" title="bindmethod 方法绑定"></a>bindmethod 方法绑定</h4><p>服务容器还有一个 bindmethod 的方法，可以绑定类的一个方法到自定义的函数：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testContainCallMethodBind</span><span class="params">()</span></span>&#123;</div><div class="line"></div><div class="line">    App::bindMethod(TaskRepository::class.<span class="string">'@testContainerCallStatic'</span>,<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">         $taskRepo = <span class="keyword">new</span> TaskRepository();</div><div class="line">         $taskRepo-&gt;testCallback();</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    App::call(TaskRepository::class.<span class="string">'@testContainerCallStatic'</span>);</div><div class="line">    App::call(TaskRepository::class.<span class="string">'::testContainerCallStatic'</span>);</div><div class="line">    App::call([TaskRepository::class,<span class="string">'testContainerCallStatic'</span>]);</div><div class="line"></div><div class="line">    App::bindMethod(TaskRepository::class.<span class="string">'@testContainerCall'</span>,<span class="function"><span class="keyword">function</span> <span class="params">(TaskRepository $taskRepo)</span> </span>&#123; $taskRepo-&gt;testCallback(); &#125;);</div><div class="line"></div><div class="line">    $taskRepo = <span class="keyword">new</span> TaskRepository();</div><div class="line">    App::call(TaskRepository::class.<span class="string">'@testContainerCall'</span>);</div><div class="line">    App::call([$taskRepo,<span class="string">'testContainerCall'</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从结果上看，bindmethod 不会对静态的第二种解析方法（ :: 解析方式）起作用，对于其他方式都会调用绑定的函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testCallWithBoundMethod</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">      $container = <span class="keyword">new</span> Container;</div><div class="line">      $container-&gt;bindMethod(<span class="string">'Illuminate\Tests\Container\ContainerTestCallStub@unresolvable'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($stub)</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> $stub-&gt;unresolvable(<span class="string">'foo'</span>, <span class="string">'bar'</span>);</div><div class="line">      &#125;);</div><div class="line">      $result = $container-&gt;call(<span class="string">'Illuminate\Tests\Container\ContainerTestCallStub@unresolvable'</span>);</div><div class="line">      <span class="keyword">$this</span>-&gt;assertEquals([<span class="string">'foo'</span>, <span class="string">'bar'</span>], $result);</div><div class="line"></div><div class="line">      $container = <span class="keyword">new</span> Container;</div><div class="line">      $container-&gt;bindMethod(<span class="string">'Illuminate\Tests\Container\ContainerTestCallStub@unresolvable'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($stub)</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> $stub-&gt;unresolvable(<span class="string">'foo'</span>, <span class="string">'bar'</span>);</div><div class="line">  &#125;);</div><div class="line">      $result = $container-&gt;call([<span class="keyword">new</span> ContainerTestCallStub, <span class="string">'unresolvable'</span>]);</div><div class="line">      <span class="keyword">$this</span>-&gt;assertEquals([<span class="string">'foo'</span>, <span class="string">'bar'</span>], $result);</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContainerTestCallStub</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unresolvable</span><span class="params">($foo, $bar)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> func_get_args();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="默认函数注入"><a href="#默认函数注入" class="headerlink" title="默认函数注入"></a>默认函数注入</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testContainCallDefultMethod</span><span class="params">()</span></span>&#123;</div><div class="line"></div><div class="line">    App::call(TaskRepository::class,[],<span class="string">'testContainerCall'</span>);</div><div class="line"></div><div class="line">    App::call(TaskRepository::class,[],<span class="string">'testContainerCallStatic'</span>);</div><div class="line"></div><div class="line">    App::bindMethod(TaskRepository::class.<span class="string">'@testContainerCallStatic'</span>,<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        $taskRepo = <span class="keyword">new</span> TaskRepository();</div><div class="line">        $taskRepo-&gt;testCallback();</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    App::bindMethod(TaskRepository::class.<span class="string">'@testContainerCall'</span>,<span class="function"><span class="keyword">function</span> <span class="params">(TaskRepository $taskRepo)</span> </span>&#123;  $taskRepo-&gt;testCallback(); &#125;);</div><div class="line"></div><div class="line">    App::call(TaskRepository::class,[],<span class="string">'testContainerCall'</span>);</div><div class="line"></div><div class="line">    App::call(TaskRepository::class,[],<span class="string">'testContainerCallStatic'</span>);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>值得注意的是，这种默认函数注入的方法使得非静态的方法也可以利用类名去调用，并不需要对象。默认函数注入也回受到 bindmethod 函数的影响。</p>
<h3 id="数组解析"><a href="#数组解析" class="headerlink" title="数组解析"></a>数组解析</h3>  <figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app()[<span class="string">'service'</span>];</div></pre></td></tr></table></figure>
<h3 id="app-service-的形式"><a href="#app-service-的形式" class="headerlink" title="app($service)的形式"></a>app($service)的形式</h3>  <figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app(<span class="string">'service'</span>);</div></pre></td></tr></table></figure>
<h2 id="服务容器事件"><a href="#服务容器事件" class="headerlink" title="服务容器事件"></a>服务容器事件</h2><p>每当服务容器解析一个对象时就会触发一个事件。你可以使用 resolving 方法监听这个事件：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;resolving(<span class="function"><span class="keyword">function</span> <span class="params">($object, $app)</span> </span>&#123;</div><div class="line">  <span class="comment">// 解析任何类型的对象时都会调用该方法...</span></div><div class="line">&#125;);</div><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;resolving(HelpSpot\API::class, <span class="function"><span class="keyword">function</span> <span class="params">($api, $app)</span> </span>&#123;</div><div class="line">  <span class="comment">// 解析「HelpSpot\API」类型的对象时调用...</span></div><div class="line">&#125;);</div><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;afterResolving(<span class="function"><span class="keyword">function</span> <span class="params">($object, $app)</span> </span>&#123;</div><div class="line">  <span class="comment">// 解析任何类型的对象后都会调用该方法...</span></div><div class="line">&#125;);</div><div class="line"><span class="keyword">$this</span>-&gt;app-&gt;afterResolving(HelpSpot\API::class, <span class="function"><span class="keyword">function</span> <span class="params">($api, $app)</span> </span>&#123;</div><div class="line">  <span class="comment">// 解析「HelpSpot\API」类型的对象后调用...</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>服务容器每次解析对象的时候，都会调用这些通过 resolving 和 afterResolving 函数传入的闭包函数，也就是触发这些事件。<br>注意：如果是单例，则只在解析时会触发一次<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testResolvingCallbacksAreCalled</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;resolving(<span class="function"><span class="keyword">function</span> <span class="params">($object)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $object-&gt;name = <span class="string">'taylor'</span>;</div><div class="line">    &#125;);</div><div class="line">    $container-&gt;bind(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StdClass;</div><div class="line">    &#125;);</div><div class="line">    $instance = $container-&gt;make(<span class="string">'foo'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'taylor'</span>, $instance-&gt;name);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testResolvingCallbacksAreCalledForType</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;resolving(<span class="string">'StdClass'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($object)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $object-&gt;name = <span class="string">'taylor'</span>;</div><div class="line">    &#125;);</div><div class="line">    $container-&gt;bind(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">new</span> StdClass;</div><div class="line">    &#125;);</div><div class="line">    $instance = $container-&gt;make(<span class="string">'foo'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'taylor'</span>, $instance-&gt;name);</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testResolvingCallbacksShouldBeFiredWhenCalledWithAliases</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;alias(<span class="string">'StdClass'</span>, <span class="string">'std'</span>);</div><div class="line">    $container-&gt;resolving(<span class="string">'std'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($object)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $object-&gt;name = <span class="string">'taylor'</span>;</div><div class="line">    &#125;);</div><div class="line">    $container-&gt;bind(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StdClass;</div><div class="line">    &#125;);</div><div class="line">    $instance = $container-&gt;make(<span class="string">'foo'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'taylor'</span>, $instance-&gt;name);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="装饰函数"><a href="#装饰函数" class="headerlink" title="装饰函数"></a>装饰函数</h2><p>容器的装饰函数有两种，wrap用于装饰call，factory用于装饰make：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testContainerWrap</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">      $result = $container-&gt;wrap(<span class="function"><span class="keyword">function</span> <span class="params">(StdClass $foo, $bar = [])</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> func_get_args();</div><div class="line">      &#125;, [<span class="string">'bar'</span> =&gt; <span class="string">'taylor'</span>]);</div><div class="line"></div><div class="line">      <span class="keyword">$this</span>-&gt;assertInstanceOf(<span class="string">'Closure'</span>, $result);</div><div class="line">      $result = $result();</div><div class="line"></div><div class="line">      <span class="keyword">$this</span>-&gt;assertInstanceOf(<span class="string">'stdClass'</span>, $result[<span class="number">0</span>]);</div><div class="line">      <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'taylor'</span>, $result[<span class="number">1</span>]);</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testContainerGetFactory</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;bind(<span class="string">'name'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'Taylor’;</span></div><div class="line"><span class="string">    &#125;);</span></div><div class="line"><span class="string">    $factory = $container-&gt;factory('</span>name<span class="string">');</span></div><div class="line"><span class="string">    $this-&gt;assertEquals($container-&gt;make('</span>name<span class="string">'), $factory());</span></div><div class="line"><span class="string">&#125;</span></div></pre></td></tr></table></figure></p>
<h2 id="容器重置flush"><a href="#容器重置flush" class="headerlink" title="容器重置flush"></a>容器重置flush</h2><p>容器的重置函数flush会清空容器内部的aliases、abstractAliases、resolved、bindings、instances<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testContainerFlushFlushesAllBindingsAliasesAndResolvedInstances</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $container = <span class="keyword">new</span> Container;</div><div class="line">    $container-&gt;bind(<span class="string">'ConcreteStub'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ContainerConcreteStub;</div><div class="line">    &#125;, <span class="keyword">true</span>);</div><div class="line">    $container-&gt;alias(<span class="string">'ConcreteStub'</span>, <span class="string">'ContainerConcreteStub'</span>);</div><div class="line">    </div><div class="line">    $concreteStubInstance = $container-&gt;make(<span class="string">'ConcreteStub'</span>);</div><div class="line">    <span class="keyword">$this</span>-&gt;assertTrue($container-&gt;resolved(<span class="string">'ConcreteStub'</span>));</div><div class="line">    <span class="keyword">$this</span>-&gt;assertTrue($container-&gt;isAlias(<span class="string">'ContainerConcreteStub'</span>));</div><div class="line">    <span class="keyword">$this</span>-&gt;assertArrayHasKey(<span class="string">'ConcreteStub'</span>, $container-&gt;getBindings());</div><div class="line">    <span class="keyword">$this</span>-&gt;assertTrue($container-&gt;isShared(<span class="string">'ConcreteStub'</span>));</div><div class="line">    </div><div class="line">    $container-&gt;flush();</div><div class="line">    <span class="keyword">$this</span>-&gt;assertFalse($container-&gt;resolved(<span class="string">'ConcreteStub'</span>));</div><div class="line">    <span class="keyword">$this</span>-&gt;assertFalse($container-&gt;isAlias(<span class="string">'ContainerConcreteStub'</span>));</div><div class="line">    <span class="keyword">$this</span>-&gt;assertEmpty($container-&gt;getBindings());</div><div class="line">    <span class="keyword">$this</span>-&gt;assertFalse($container-&gt;isShared(<span class="string">'ConcreteStub'</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>Written with <a href="https://stackedit.io/" target="_blank" rel="external">StackEdit</a>.</p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/03/19/Laravel-Facade——Laravel-Facade/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/19/Laravel-Facade——Laravel-Facade/" itemprop="url">
                  Laravel框架门面Facade源码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-19T13:53:00+08:00">
                2017-03-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/laravel/" itemprop="url" rel="index">
                    <span itemprop="name">laravel</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/laravel/facade/" itemprop="url" rel="index">
                    <span itemprop="name">facade</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/laravel/facade/源码/" itemprop="url" rel="index">
                    <span itemprop="name">源码</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/19/Laravel-Facade——Laravel-Facade/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/19/Laravel-Facade——Laravel-Facade/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/03/19/Laravel-Facade——Laravel-Facade/" class="leancloud_visitors" data-flag-title="Laravel框架门面Facade源码分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这篇文章我们开始讲laravel框架中的门面Facade，什么是门面呢？官方文档：</p>
<blockquote>
<p>&emsp;&emsp;Facades（读音：/fəˈsäd/ ）为应用程序的服务容器中可用的类提供了一个「静态」接口。Laravel 自带了很多 facades ，几乎可以用来访问到 Laravel 中所有的服务。Laravel facades 实际上是服务容器中那些底层类的「静态代理」，相比于传统的静态方法， facades 在提供了简洁且丰富的语法同时，还带来了更好的可测试性和扩展性。</p>
</blockquote>
<p>&emsp;&emsp;什么意思呢？首先，我们要知道laravel框架的核心就是个Ioc容器即<a href="http://d.laravel-china.org/docs/5.4/container" target="_blank" rel="external">服务容器</a>，功能类似于一个工厂模式，是个高级版的工厂。laravel的其他功能例如路由、缓存、日志、数据库其实都是类似于插件或者零件一样，叫做<a href="http://d.laravel-china.org/docs/5.4/providers" target="_blank" rel="external">服务</a>。Ioc容器主要的作用就是生产各种零件，就是提供各个服务。在laravel中，如果我们想要用某个服务，该怎么办呢？最简单的办法就是调用服务容器的make函数，或者利用依赖注入，或者就是今天要讲的门面Facade。门面相对于其他方法来说，最大的特点就是简洁，例如我们经常使用的Router，如果利用服务容器的make：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">App::make(<span class="string">'router'</span>)-&gt;get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> view(<span class="string">'welcome'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</code></pre><p>如果利用门面：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> view(<span class="string">'welcome'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</code></pre><p>可以看出代码更加简洁。其实，下面我们就会介绍门面最后调用的函数也是服务容器的make函数。</p>
<h1 id="Facade的原理"><a href="#Facade的原理" class="headerlink" title="Facade的原理"></a>Facade的原理</h1><p>&emsp;&emsp;我们以Route为例，来讲解一下门面Facade的原理与实现。我们先来看Route的门面类：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Route</span> <span class="keyword">extends</span> <span class="title">Facade</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeAccessor</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'router'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;很简单吧？其实每个门面类也就是重定义一下getFacadeAccessor函数就行了，这个函数返回服务的唯一名称：router。需要注意的是要确保这个名称可以用服务容器的make函数创建成功(App::make(‘router’))，原因我们马上就会讲到。<br>&emsp;&emsp;那么当我们写出Route::get()这样的语句时，到底发生了什么呢？奥秘就在基类Facade中。</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span><span class="params">($method, $args)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">       $instance = <span class="keyword">static</span>::getFacadeRoot();</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (! $instance) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'A facade root has not been set.'</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> $instance-&gt;$method(...$args);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;当运行Route::get()时，发现门面Route没有静态get()函数，PHP就会调用这个魔术函数__callStatic。我们看到这个魔术函数做了两件事：获得对象实例，利用对象调用get()函数。首先先看看如何获得对象实例的：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeRoot</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">static</span>::resolveFacadeInstance(<span class="keyword">static</span>::getFacadeAccessor());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeAccessor</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'Facade does not implement getFacadeAccessor method.'</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveFacadeInstance</span><span class="params">($name)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">       <span class="keyword">if</span> (is_object($name)) &#123;</div><div class="line">           <span class="keyword">return</span> $name;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">static</span>::$resolvedInstance[$name])) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">static</span>::$resolvedInstance[$name];</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> <span class="keyword">static</span>::$resolvedInstance[$name] = <span class="keyword">static</span>::$app[$name];</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;我们看到基类getFacadeRoot()调用了getFacadeAccessor()，也就是我们的服务重载的函数，如果调用了基类的getFacadeAccessor，就会抛出异常。在我们的例子里getFacadeAccessor()返回了“router”，接下来getFacadeRoot()又调用了resolveFacadeInstance()。在这个函数里重点就是</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="keyword">static</span>::$resolvedInstance[$name] = <span class="keyword">static</span>::$app[$name];</div></pre></td></tr></table></figure>
</code></pre><p>我们看到，在这里利用了\$app也就是服务容器创建了“router”，创建成功后放入$resolvedInstance作为缓存，以便以后快速加载。<br>&emsp;&emsp;好了，Facade的原理到这里就讲完了，但是到这里我们有个疑惑，为什么代码中写Route就可以调用Illuminate\Support\Facades\Route呢？这个就是别名的用途了，很多门面都有自己的别名，这样我们就不必在代码里面写use Illuminate\Support\Facades\Route，而是可以直接用Route了。</p>
<h1 id="别名Aliases"><a href="#别名Aliases" class="headerlink" title="别名Aliases"></a>别名Aliases</h1><p>&emsp;&emsp;为什么我们可以在laravel中全局用Route，而不需要使用use Illuminate\Support\Facades\Route?其实奥秘在于一个PHP函数：<a href="http://www.php.net/manual/zh/function.class-alias.php" target="_blank" rel="external">class_alias</a>，它可以为任何类创建别名。laravel在启动的时候为各个门面类调用了class_alias函数，因此不必直接用类名，直接用别名即可。在config文件夹的app文件里面存放着门面与类名的映射：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="string">'aliases'</span> =&gt; [</div><div class="line"></div><div class="line">       <span class="string">'App'</span> =&gt; Illuminate\Support\Facades\App::class,</div><div class="line">       <span class="string">'Artisan'</span> =&gt; Illuminate\Support\Facades\Artisan::class,</div><div class="line">       <span class="string">'Auth'</span> =&gt; Illuminate\Support\Facades\Auth::class,</div><div class="line">       ...</div><div class="line">       ]</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;下面我们来看看laravel是如何为门面类创建别名的。</p>
<h2 id="启动别名Aliases服务"><a href="#启动别名Aliases服务" class="headerlink" title="启动别名Aliases服务"></a>启动别名Aliases服务</h2><p>&emsp;&emsp;说到laravel的启动，我们离不开index.php：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/autoload.php'</span>;</div><div class="line"></div><div class="line">$app = <span class="keyword">require_once</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/app.php'</span>;</div><div class="line"></div><div class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</div><div class="line"></div><div class="line">$response = $kernel-&gt;handle(</div><div class="line">   $request = Illuminate\Http\Request::capture()</div><div class="line">);</div><div class="line">...</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;第一句就是我们前面博客说的composer的自动加载，接下来第二句获取laravel核心的Ioc容器，第三句“制造”出Http请求的内核，第四句是我们这里的关键，这句牵扯很大，laravel里面所有功能服务的注册加载，乃至Http请求的构造与传递都是这一句的功劳。</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$request = Illuminate\Http\Request::capture()</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;这句是laravel通过全局$_SERVER数组构造一个Http请求的语句，接下来会调用Http的内核函数handle：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        $request-&gt;enableHttpMethodParameterOverride();</div><div class="line"></div><div class="line">        $response = <span class="keyword">$this</span>-&gt;sendRequestThroughRouter($request);</div><div class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;reportException($e);</div><div class="line">	</div><div class="line">        $response = <span class="keyword">$this</span>-&gt;renderException($request, $e);</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable $e) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;reportException($e = <span class="keyword">new</span> FatalThrowableError($e));</div><div class="line"></div><div class="line">        $response = <span class="keyword">$this</span>-&gt;renderException($request, $e);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    event(<span class="keyword">new</span> Events\RequestHandled($request, $response));</div><div class="line">	</div><div class="line">    <span class="keyword">return</span> $response;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;在handle函数方法中enableHttpMethodParameterOverride函数是允许在表单中使用delete、put等类型的请求。我们接着看sendRequestThroughRouter：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequestThroughRouter</span><span class="params">($request)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</div><div class="line"></div><div class="line">    Facade::clearResolvedInstance(<span class="string">'request'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;bootstrap();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline(<span class="keyword">$this</span>-&gt;app))</div><div class="line">                -&gt;send($request)</div><div class="line">             -&gt;through(<span class="keyword">$this</span>-&gt;app-&gt;shouldSkipMiddleware() ? [] : </div><div class="line">                       <span class="keyword">$this</span>-&gt;middleware)</div><div class="line">                -&gt;then(<span class="keyword">$this</span>-&gt;dispatchToRouter());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;前两句是在laravel的Ioc容器设置request请求的对象实例，Facade中清楚request的缓存实例。bootstrap：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">       <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;app-&gt;hasBeenBootstrapped()) &#123;</div><div class="line">           <span class="keyword">$this</span>-&gt;app-&gt;bootstrapWith(<span class="keyword">$this</span>-&gt;bootstrappers());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> $bootstrappers = [</div><div class="line">       \Illuminate\Foundation\Bootstrap\LoadEnvironmentVariables::class,</div><div class="line">       \Illuminate\Foundation\Bootstrap\LoadConfiguration::class,</div><div class="line">       \Illuminate\Foundation\Bootstrap\HandleExceptions::class,</div><div class="line">       \Illuminate\Foundation\Bootstrap\RegisterFacades::class,</div><div class="line">       \Illuminate\Foundation\Bootstrap\RegisterProviders::class,</div><div class="line">       \Illuminate\Foundation\Bootstrap\BootProviders::class,</div><div class="line">  ];</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;$bootstrappers是Http内核里专门用于启动的组件，bootstrap函数中调用Ioc容器的bootstrapWith函数来创建这些组件并利用组件进行启动服务。app-&gt;bootstrapWith：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrapWith</span><span class="params">(array $bootstrappers)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;hasBeenBootstrapped = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> ($bootstrappers <span class="keyword">as</span> $bootstrapper) &#123;</div><div class="line">        <span class="keyword">$this</span>[<span class="string">'events'</span>]-&gt;fire(<span class="string">'bootstrapping: '</span>.$bootstrapper, [<span class="keyword">$this</span>]);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;make($bootstrapper)-&gt;bootstrap(<span class="keyword">$this</span>);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>[<span class="string">'events'</span>]-&gt;fire(<span class="string">'bootstrapped: '</span>.$bootstrapper, [<span class="keyword">$this</span>]);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;可以看到bootstrapWith函数也就是利用Ioc容器创建各个启动服务的实例后，回调启动自己的函数bootstrap，在这里我们只看我们Facade的启动组件</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\Illuminate\Foundation\Bootstrap\RegisterFacades::class</div></pre></td></tr></table></figure>
</code></pre><p>RegisterFacades的bootstrap函数：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterFacades</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span><span class="params">(Application $app)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        Facade::clearResolvedInstances();</div><div class="line"></div><div class="line">        Facade::setFacadeApplication($app);</div><div class="line"></div><div class="line">        AliasLoader::getInstance($app-&gt;make(<span class="string">'config'</span>)-&gt;get(<span class="string">'app.aliases'</span>, []))</div><div class="line">                     -&gt;register();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;可以看出来，bootstrap做了一下几件事：</p>
<blockquote>
<ol>
<li>清除了Facade中的缓存</li>
<li>设置Facade的Ioc容器</li>
<li>获得我们前面讲的config文件夹里面app文件aliases别名映射数组</li>
<li>使用aliases实例化初始化AliasLoader</li>
<li>调用AliasLoader-&gt;register()</li>
</ol>
</blockquote>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;registered) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;prependToLoaderStack();</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;registered = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">prependToLoaderStack</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    spl_autoload_register([<span class="keyword">$this</span>, <span class="string">'load'</span>], <span class="keyword">true</span>, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;我们可以看出，别名服务的启动关键就是这个spl_autoload_register，这个函数我们应该很熟悉了，在自动加载中这个函数用于解析命名空间，在这里用于解析别名的真正类名。</p>
<h2 id="别名Aliases服务"><a href="#别名Aliases服务" class="headerlink" title="别名Aliases服务"></a>别名Aliases服务</h2><p>&emsp;&emsp;我们首先来看看被注册到spl_autoload_register的函数，load：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span><span class="params">($alias)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">static</span>::$facadeNamespace &amp;&amp; strpos($alias, </div><div class="line">                                    <span class="keyword">static</span>::$facadeNamespace) === <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;loadFacade($alias);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;aliases[$alias])) &#123;</div><div class="line">        <span class="keyword">return</span> class_alias(<span class="keyword">$this</span>-&gt;aliases[$alias], $alias);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;这个函数的下面很好理解，就是class_alias利用别名映射数组将别名映射到真正的门面类中去，但是上面这个是什么呢?实际上，这个是laravel5.4版本新出的功能叫做实时门面服务。</p>
<h2 id="实时门面服务"><a href="#实时门面服务" class="headerlink" title="实时门面服务"></a>实时门面服务</h2><p>&emsp;&emsp;其实门面功能已经很简单了，我们只需要定义一个类继承Facade即可，但是laravel5.4打算更近一步——自动生成门面子类，这就是实时门面。<br>&emsp;&emsp;实时门面怎么用？看下面的例子：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaymentGateway</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">protected</span> $tax;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(TaxCalculator $tax)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;tax = $tax;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>这是一个自定义的类，如果我们想要为这个类定义一个门面，在laravel5.4我们可以这么做：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">Facades</span>\ &#123;</div><div class="line">    <span class="title">App</span>\<span class="title">Services</span>\<span class="title">PaymentGateway</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line">Route::get(<span class="string">'/pay/&#123;amount&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($amount)</span> </span>&#123;</div><div class="line">    PaymentGateway::pay($amount);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;当然如果你愿意，你还可以在alias数组为门面添加一个别名映射”PaymentGateway” =&gt; “use Facades\App\Services\PaymentGateway”，这样就不用写这么长的名字了。<br>&emsp;&emsp;那么这么做的原理是什么呢？我们接着看源码：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">static</span> $facadeNamespace = <span class="string">'Facades\\'</span>;</div><div class="line"><span class="keyword">if</span> (<span class="keyword">static</span>::$facadeNamespace &amp;&amp; strpos($alias, <span class="keyword">static</span>::$facadeNamespace) === <span class="number">0</span>) &#123;</div><div class="line">   <span class="keyword">$this</span>-&gt;loadFacade($alias);</div><div class="line"></div><div class="line">   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;如果命名空间是以Facades\开头的，那么就会调用实时门面的功能，调用loadFacade函数：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">loadFacade</span><span class="params">($alias)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">       tap(<span class="keyword">$this</span>-&gt;ensureFacadeExists($alias), <span class="function"><span class="keyword">function</span> <span class="params">($path)</span> </span>&#123;</div><div class="line">           <span class="keyword">require</span> $path;</div><div class="line">       &#125;);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;<a href="https://segmentfault.com/a/1190000008447747" target="_blank" rel="external">tap</a>是laravel的全局帮助函数，ensureFacadeExists函数负责自动生成门面类，loadFacade负责加载门面类：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">   <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">ensureFacadeExists</span><span class="params">($alias)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (file_exists($path = storage_path(<span class="string">'framework/cache/facade-'</span>.sha1($alias).<span class="string">'.php'</span>))) &#123;</div><div class="line">        <span class="keyword">return</span> $path;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    file_put_contents($path, <span class="keyword">$this</span>-&gt;formatFacadeStub(</div><div class="line">        $alias, file_get_contents(<span class="keyword">__DIR__</span>.<span class="string">'/stubs/facade.stub'</span>)</div><div class="line">    ));</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $path;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;可以看出来，laravel框架生成的门面类会放到stroge/framework/cache/文件夹下，名字以facade开头，以命名空间的哈希结尾。如果存在这个文件就会返回，否则就要利用file_put_contents生成这个文件，formatFacadeStub：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">   <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">formatFacadeStub</span><span class="params">($alias, $stub)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $replacements = [</div><div class="line">        str_replace(<span class="string">'/'</span>, <span class="string">'\\'</span>, dirname(str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, $alias))),</div><div class="line">        class_basename($alias),</div><div class="line">        substr($alias, strlen(<span class="keyword">static</span>::$facadeNamespace)),</div><div class="line">    ];</div><div class="line"></div><div class="line">    <span class="keyword">return</span> str_replace(</div><div class="line">        [<span class="string">'DummyNamespace'</span>, <span class="string">'DummyClass'</span>, <span class="string">'DummyTarget'</span>], $replacements, $stub</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>简单的说，对于Facades\App\Services\PaymentGateway，$replacements第一项是门面命名空间，将Facades\App\Services\PaymentGateway转为Facades/App/Services/PaymentGateway，取前面Facades/App/Services/，再转为命名空间Facades\App\Services\；第二项是门面类名，PaymentGateway；第三项是门面类的服务对象，App\Services\PaymentGateway，用这些来替换门面的模板文件：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">DummyNamespace</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Facade</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * <span class="doctag">@see</span> \DummyTarget</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DummyClass</span> <span class="keyword">extends</span> <span class="title">Facade</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Get the registered name of the component.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeAccessor</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'DummyTarget'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>替换后的文件是：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Facades</span>\<span class="title">App</span>\<span class="title">Services</span>\;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Facade</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * <span class="doctag">@see</span> \DummyTarget</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaymentGateway</span> <span class="keyword">extends</span> <span class="title">Facade</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Get the registered name of the component.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeAccessor</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'App\Services\PaymentGateway'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>就是这么简单！！！</p>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>&emsp;&emsp;门面的原理就是这些，相对来说门面服务的原理比较简单，和自动加载相互配合使得代码更加简洁，希望大家可以更好的使用这些门面！</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/03/18/Composer-Autoload-Source-Reading-——-Register-and-Run/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/18/Composer-Autoload-Source-Reading-——-Register-and-Run/" itemprop="url">
                  Composer的Autoload源码实现——注册与运行
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-18T12:20:00+08:00">
                2017-03-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/composer/" itemprop="url" rel="index">
                    <span itemprop="name">composer</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/composer/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/composer/php/laravel/" itemprop="url" rel="index">
                    <span itemprop="name">laravel</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/18/Composer-Autoload-Source-Reading-——-Register-and-Run/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/18/Composer-Autoload-Source-Reading-——-Register-and-Run/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/03/18/Composer-Autoload-Source-Reading-——-Register-and-Run/" class="leancloud_visitors" data-flag-title="Composer的Autoload源码实现——注册与运行">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><hr>
<p> &emsp;&emsp;<a href="http://leoyang90.cn/2017/03/13/Composer%20Autoload%20Source%20Reading%20%E2%80%94%E2%80%94%20Start%20and%20Initialize/" target="_blank" rel="external">上一篇</a>文章我们讲到了Composer自动加载功能的启动与初始化，经过启动与初始化，自动加载核心类对象已经获得了顶级命名空间与相应目录的映射，换句话说，如果有命名空间’App\Console\Kernel，我们已经知道了App\对应的目录，接下来我们就要解决下面的就是\Console\Kernel这一段。</p>
<h1 id="Composer自动加载源码分析——注册"><a href="#Composer自动加载源码分析——注册" class="headerlink" title="Composer自动加载源码分析——注册"></a>Composer自动加载源码分析——注册</h1><hr>
<p>  &emsp;&emsp;我们先回顾一下自动加载引导类：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getLoader</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">    <span class="comment">/***************************经典单例模式********************/</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> !== <span class="keyword">self</span>::$loader) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::$loader;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/***********************获得自动加载核心类对象********************/</span></div><div class="line">    spl_autoload_register(<span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit</span></div><div class="line"><span class="string">    832ea71bfb9a4128da8660baedaac82e'</span>, <span class="string">'loadClassLoader'</span>), <span class="keyword">true</span>, <span class="keyword">true</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>::$loader = $loader = <span class="keyword">new</span> \Composer\Autoload\ClassLoader();</div><div class="line">    </div><div class="line">    spl_autoload_unregister(<span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit</span></div><div class="line"><span class="string">    832ea71bfb9a4128da8660baedaac82e'</span>, <span class="string">'loadClassLoader'</span>));</div><div class="line"></div><div class="line">    <span class="comment">/***********************初始化自动加载核心类对象********************/</span></div><div class="line">    $useStaticLoader = PHP_VERSION_ID &gt;= <span class="number">50600</span> &amp;&amp; </div><div class="line">    !defined(<span class="string">'HHVM_VERSION'</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ($useStaticLoader) &#123;</div><div class="line">        <span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_static.php'</span>;</div><div class="line"></div><div class="line">        call_user_func(\Composer\Autoload\ComposerStaticInit</div><div class="line">        <span class="number">832</span>ea71bfb9a4128da8660baedaac82e::getInitializer($loader));</div><div class="line">  </div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_namespaces.php'</span>;</div><div class="line">        <span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</div><div class="line">            $loader-&gt;set($namespace, $path);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_psr4.php'</span>;</div><div class="line">        <span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</div><div class="line">            $loader-&gt;setPsr4($namespace, $path);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $classMap = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_classmap.php'</span>;</div><div class="line">        <span class="keyword">if</span> ($classMap) &#123;</div><div class="line">            $loader-&gt;addClassMap($classMap);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/***********************注册自动加载核心类对象********************/</span></div><div class="line">    $loader-&gt;register(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="comment">/***********************自动加载全局函数********************/</span></div><div class="line">    <span class="keyword">if</span> ($useStaticLoader) &#123;</div><div class="line">        $includeFiles = Composer\Autoload\ComposerStaticInit</div><div class="line">        <span class="number">832</span>ea71bfb9a4128da8660baedaac82e::$files;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $includeFiles = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_files.php'</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">foreach</span> ($includeFiles <span class="keyword">as</span> $fileIdentifier =&gt; $file) &#123;</div><div class="line">        composerRequire</div><div class="line">        <span class="number">832</span>ea71bfb9a4128da8660baedaac82e($fileIdentifier, $file);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $loader;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>现在我们开始引导类的第四部分：注册自动加载核心类对象。我们来看看核心类的register()函数：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">($prepend = false)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">       spl_autoload_register(<span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">'loadClass'</span>), <span class="keyword">true</span>, $prepend);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</code></pre><p>简单到爆炸啊！一行代码实现自动加载有木有！其实奥秘都在自动加载核心类ClassLoader的loadClass()函数上，这个函数负责按照PSR标准将顶层命名空间以下的内容转为对应的目录，也就是上面所说的将’App\Console\Kernel中’Console\Kernel这一段转为目录，至于怎么转的我们在下面“Composer自动加载源码分析——运行”讲。核心类ClassLoader将loadClass()函数注册到PHP SPL中的spl_autoload_register()里面去，这个函数的来龙去脉我们之前<a href="http://leoyang90.cn/2017/03/11/PHP-Composer-autoload/" target="_blank" rel="external">文章</a>讲过。这样，每当PHP遇到一个不认识的命名空间的时候，PHP会自动调用注册到spl_autoload_register里面的函数堆栈，运行其中的每个函数，直到找到命名空间对应的文件。</p>
<h1 id="Composer自动加载源码分析——全局函数的自动加载"><a href="#Composer自动加载源码分析——全局函数的自动加载" class="headerlink" title="Composer自动加载源码分析——全局函数的自动加载"></a>Composer自动加载源码分析——全局函数的自动加载</h1><p> &emsp;&emsp;Composer不止可以自动加载命名空间，还可以加载全局函数。怎么实现的呢？很简单，把全局函数写到特定的文件里面去，在程序运行前挨个require就行了。这个就是composer自动加载的第五步，加载全局函数。</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($useStaticLoader) &#123;</div><div class="line">         $includeFiles = Composer\Autoload\ComposerStaticInit832ea71bfb9a4128da8660baedaac82e::$files;</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">         $includeFiles = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_files.php'</span>;</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">foreach</span> ($includeFiles <span class="keyword">as</span> $fileIdentifier =&gt; $file) &#123;</div><div class="line">         composerRequire832ea71bfb9a4128da8660baedaac82e($fileIdentifier, $file);</div><div class="line">     &#125;</div></pre></td></tr></table></figure>
</code></pre><p>  跟核心类的初始化一样，全局函数自动加载也分为两种：静态初始化和普通初始化，静态加载只支持PHP5.6以上并且不支持HHVM。</p>
<h2 id="静态初始化："><a href="#静态初始化：" class="headerlink" title="静态初始化："></a>静态初始化：</h2><p>  ComposerStaticInit832ea71bfb9a4128da8660baedaac82e::$files：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> $files = <span class="keyword">array</span> (</div><div class="line">    <span class="string">'0e6d7bf4a5811bfa5cf40c5ccd6fae6a'</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/symfony/polyfill-mbstring/bootstrap.php'</span>,</div><div class="line">    <span class="string">'667aeda72477189d0494fecd327c3641'</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/symfony/var-dumper/Resources/functions/dump.php'</span>,</div><div class="line">    ...</div><div class="line">);</div></pre></td></tr></table></figure>
</code></pre><p>  看到这里我们可能又要有疑问了，为什么不直接放文件路径名，还要一个hash干什么呢？这个我们一会儿讲，我们这里先了解一下这个数组的结构。</p>
<h2 id="普通初始化"><a href="#普通初始化" class="headerlink" title="普通初始化"></a>普通初始化</h2><p>  autoload_files:</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$vendorDir = dirname(dirname(<span class="keyword">__FILE__</span>));</div><div class="line">$baseDir = dirname($vendorDir);</div><div class="line"></div><div class="line"><span class="keyword">return</span> <span class="keyword">array</span>(</div><div class="line">   <span class="string">'0e6d7bf4a5811bfa5cf40c5ccd6fae6a'</span> =&gt; $vendorDir . <span class="string">'/symfony/polyfill-mbstring/bootstrap.php'</span>,</div><div class="line">   <span class="string">'667aeda72477189d0494fecd327c3641'</span> =&gt; $vendorDir . <span class="string">'/symfony/var-dumper/Resources/functions/dump.php'</span>,</div><div class="line">   ....</div><div class="line">);</div></pre></td></tr></table></figure>
</code></pre><p>其实跟静态初始化区别不大。</p>
<h2 id="加载全局函数"><a href="#加载全局函数" class="headerlink" title="加载全局函数"></a>加载全局函数</h2><pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">   <span class="class"><span class="keyword">class</span> <span class="title">ComposerAutoloaderInit832ea71bfb9a4128da8660baedaac82e</span></span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getLoader</span><span class="params">()</span></span>&#123;</div><div class="line">	  ...</div><div class="line">	  <span class="keyword">foreach</span> ($includeFiles <span class="keyword">as</span> $fileIdentifier =&gt; $file) &#123;</div><div class="line">           composerRequire832ea71bfb9a4128da8660baedaac82e($fileIdentifier, $file);</div><div class="line">      &#125;</div><div class="line">      ...</div><div class="line">  &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">composerRequire832ea71bfb9a4128da8660baedaac82e</span><span class="params">($fileIdentifier, $file)</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(\$GLOBALS[<span class="string">'__composer_autoload_files'</span>][\$fileIdentifier])) &#123;</div><div class="line">        <span class="keyword">require</span> $file;</div><div class="line"></div><div class="line">        $GLOBALS[<span class="string">'__composer_autoload_files'</span>][$fileIdentifier] = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p> &emsp;&emsp;这一段很有讲究，<strong>第一个问题</strong>：为什么自动加载引导类的getLoader()函数不直接require \$includeFiles里面的每个文件名，而要用类外面的函数composerRequire832ea71bfb9a4128da8660baedaac82e0？(顺便说下这个函数名hash仍然为了避免和用户定义函数冲突)因为怕有人在全局函数所在的文件<strong>写\$this或者self</strong>。<br> &emsp;&emsp;假如\$includeFiles有个app/helper.php文件，这个helper.php文件的函数外有一行代码：\$this-&gt;foo()，如果引导类在getLoader()函数直接require(\$file)，那么引导类就会运行这句代码，调用自己的foo()函数，这显然是错的。事实上helper.php就不应该出现\$this或self这样的代码，这样写一般都是用户写错了的，一旦这样的事情发生，第一种情况：引导类恰好有foo()函数，那么就会莫名其妙执行了引导类的foo();第二种情况：引导类没有foo()函数，但是却甩出来引导类没有foo()方法这样的错误提示，用户不知道自己哪里错了。把require语句放到引导类的外面，遇到$this或者self，程序就会告诉用户根本没有类，$this或self无效，错误信息更加明朗。<br>&emsp;&emsp;<strong>第二个问题</strong>，为什么要用hash作为\$fileIdentifier，上面的代码明显可以看出来这个变量是用来控制全局函数只被require一次的，那为什么不用require_once呢？事实上require_once比require效率低很多，使用全局变量\$GLOBALS这样控制加载会更快。还有一个原因我猜测应该是require_once对相对路径的支持并不理想，所以composer尽量少用require_once。</p>
<h1 id="Composer自动加载源码分析——运行"><a href="#Composer自动加载源码分析——运行" class="headerlink" title="Composer自动加载源码分析——运行"></a>Composer自动加载源码分析——运行</h1><p>  &emsp;&emsp;我们终于来到了核心的核心——composer自动加载的真相，命名空间如何通过composer转为对应目录文件的奥秘就在这一章。<br> &emsp;&emsp;前面说过，ClassLoader的register()函数将loadClass()函数注册到PHP的SPL函数堆栈中，每当PHP遇到不认识的命名空间时就会调用函数堆栈的每个函数，直到加载命名空间成功。所以loadClass()函数就是自动加载的关键<br> 了。<br> loadClass():</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadClass</span><span class="params">($class)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">       <span class="keyword">if</span> ($file = <span class="keyword">$this</span>-&gt;findFile($class)) &#123;</div><div class="line">           includeFile($file);</div><div class="line"></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findFile</span><span class="params">($class)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">       <span class="comment">// work around for PHP 5.3.0 - 5.3.2 https://bugs.php.net/50731</span></div><div class="line">       <span class="keyword">if</span> (<span class="string">'\\'</span> == $class[<span class="number">0</span>]) &#123;</div><div class="line">           $class = substr($class, <span class="number">1</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// class map lookup</span></div><div class="line">       <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;classMap[$class])) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;classMap[$class];</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;classMapAuthoritative) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       $file = <span class="keyword">$this</span>-&gt;findFileWithExtension($class, <span class="string">'.php'</span>);</div><div class="line"></div><div class="line">       <span class="comment">// Search for Hack files if we are running on HHVM</span></div><div class="line">       <span class="keyword">if</span> ($file === <span class="keyword">null</span> &amp;&amp; defined(<span class="string">'HHVM_VERSION'</span>)) &#123;</div><div class="line">           $file = <span class="keyword">$this</span>-&gt;findFileWithExtension($class, <span class="string">'.hh'</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> ($file === <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="comment">// Remember that this class does not exist.</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;classMap[$class] = <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> $file;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</code></pre><p> &emsp;&emsp;我们看到loadClass()，主要调用findFile()函数。findFile()在解析命名空间的时候主要分为两部分：classMap和findFileWithExtension()函数。classMap很简单，直接看命名空间是否在映射数组中即可。麻烦的是findFileWithExtension()函数，这个函数包含了PSR0和PSR4标准的实现。还有个值得我们注意的是查找路径成功后includeFile()仍然类外面的函数，并不是ClassLoader的成员函数，原理跟上面一样，防止有用户写$this或self。还有就是如果命名空间是以\开头的，要去掉\然后再匹配。<br> findFileWithExtension：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">findFileWithExtension</span><span class="params">($class, $ext)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="comment">// PSR-4 lookup</span></div><div class="line">    $logicalPathPsr4 = strtr($class, <span class="string">'\\'</span>, DIRECTORY_SEPARATOR) . $ext;</div><div class="line"></div><div class="line">    $first = $class[<span class="number">0</span>];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;prefixLengthsPsr4[$first])) &#123;</div><div class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;prefixLengthsPsr4[$first] <span class="keyword">as</span> $prefix =&gt; $length) &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="number">0</span> === strpos($class, $prefix)) &#123;</div><div class="line">                <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;prefixDirsPsr4[$prefix] <span class="keyword">as</span> $dir) &#123;</div><div class="line">                    <span class="keyword">if</span> (file_exists($file = $dir . DIRECTORY_SEPARATOR . substr($logicalPathPsr4, $length))) &#123;</div><div class="line">                        <span class="keyword">return</span> $file;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// PSR-4 fallback dirs</span></div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;fallbackDirsPsr4 <span class="keyword">as</span> $dir) &#123;</div><div class="line">        <span class="keyword">if</span> (file_exists($file = $dir . DIRECTORY_SEPARATOR . $logicalPathPsr4)) &#123;</div><div class="line">            <span class="keyword">return</span> $file;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// PSR-0 lookup</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">false</span> !== $pos = strrpos($class, <span class="string">'\\'</span>)) &#123;</div><div class="line">        <span class="comment">// namespaced class name</span></div><div class="line">        $logicalPathPsr0 = substr($logicalPathPsr4, <span class="number">0</span>, $pos + <span class="number">1</span>)</div><div class="line">            . strtr(substr($logicalPathPsr4, $pos + <span class="number">1</span>), <span class="string">'_'</span>, DIRECTORY_SEPARATOR);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// PEAR-like class name</span></div><div class="line">        $logicalPathPsr0 = strtr($class, <span class="string">'_'</span>, DIRECTORY_SEPARATOR) . $ext;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;prefixesPsr0[$first])) &#123;</div><div class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;prefixesPsr0[$first] <span class="keyword">as</span> $prefix =&gt; $dirs) &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="number">0</span> === strpos($class, $prefix)) &#123;</div><div class="line">                <span class="keyword">foreach</span> ($dirs <span class="keyword">as</span> $dir) &#123;</div><div class="line">                    <span class="keyword">if</span> (file_exists($file = $dir . DIRECTORY_SEPARATOR . $logicalPathPsr0)) &#123;</div><div class="line">                        <span class="keyword">return</span> $file;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// PSR-0 fallback dirs</span></div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;fallbackDirsPsr0 <span class="keyword">as</span> $dir) &#123;</div><div class="line">        <span class="keyword">if</span> (file_exists($file = $dir . DIRECTORY_SEPARATOR . $logicalPathPsr0)) &#123;</div><div class="line">            <span class="keyword">return</span> $file;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// PSR-0 include paths.</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;useIncludePath &amp;&amp; $file = stream_resolve_include_path($logicalPathPsr0)) &#123;</div><div class="line">        <span class="keyword">return</span> $file;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;下面我们通过举例来说下上面代码的流程：<br>&emsp;&emsp;如果我们在代码中写下’phpDocumentor\Reflection\example’，PHP会通过SPL调用loadClass-&gt;findFile-&gt;findFileWithExtension。首先默认用php作为文件后缀名调用findFileWithExtension函数里，利用PSR4标准尝试解析目录文件，如果文件不存在则继续用PSR0标准解析，如果解析出来的目录文件仍然不存在，但是环境是HHVM虚拟机，继续用后缀名为hh再次调用findFileWithExtension函数，如果不存在，说明此命名空间无法加载，放到classMap中设为false，以便以后更快地加载。<br>&emsp;&emsp;对于phpDocumentor\Reflection\example，当尝试利用PSR4标准映射目录时，步骤如下：</p>
<h2 id="PSR4标准加载"><a href="#PSR4标准加载" class="headerlink" title="PSR4标准加载"></a>PSR4标准加载</h2><blockquote>
<ul>
<li>将\转为文件分隔符/，加上后缀php或hh，得到\$logicalPathPsr4即phpDocumentor//Reflection//example.php(hh);</li>
<li>利用命名空间第一个字母p作为前缀索引搜索prefixLengthsPsr4数组，查到下面这个数组：</li>
</ul>
</blockquote>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">p<span class="string">' =&gt; </span></div><div class="line"><span class="string">       array (</span></div><div class="line"><span class="string">           '</span>phpDocumentor\\Reflection\\<span class="string">' =&gt; 25,</span></div><div class="line"><span class="string">           '</span>phpDocumentor\\Fake\\<span class="string">' =&gt; 19,</span></div><div class="line"><span class="string">     )</span></div></pre></td></tr></table></figure>
</code></pre><blockquote>
<ul>
<li>遍历这个数组，得到两个顶层命名空间phpDocumentor\Reflection\和phpDocumentor\Fake\</li>
<li>用这两个顶层命名空间与phpDocumentor\Reflection\example_e相比较，可以得到phpDocumentor\Reflection\这个顶层命名空间</li>
<li>在prefixLengthsPsr4映射数组中得到phpDocumentor\Reflection\长度为25。</li>
<li>在prefixDirsPsr4映射数组中得到phpDocumentor\Reflection\的目录映射为：</li>
</ul>
</blockquote>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="string">'phpDocumentor\\Reflection\\'</span> =&gt; </div><div class="line">       <span class="keyword">array</span> (</div><div class="line">           <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/phpdocumentor/reflection-common/src'</span>,</div><div class="line">           <span class="number">1</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/phpdocumentor/type-resolver/src'</span>,</div><div class="line">           <span class="number">2</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/phpdocumentor/reflection-docblock/src'</span>,</div><div class="line">       ),</div></pre></td></tr></table></figure>
</code></pre><blockquote>
<ul>
<li>遍历这个映射数组，得到三个目录映射；</li>
<li>查看 “目录+文件分隔符//+substr(\$logicalPathPsr4, \$length)”文件是否存在，存在即返回。这里就是’__DIR__/../phpdocumentor/reflection-common/src + /+ substr(phpDocumentor/Reflection/example_e.php(hh),25)’</li>
<li>如果失败，则利用fallbackDirsPsr4数组里面的目录继续判断是否存在文件，具体方法是“目录+文件分隔符//+\$logicalPathPsr4”</li>
</ul>
</blockquote>
<h2 id="PSR0标准加载"><a href="#PSR0标准加载" class="headerlink" title="PSR0标准加载"></a>PSR0标准加载</h2><p>如果PSR4标准加载失败，则要进行PSR0标准加载：</p>
<blockquote>
<ul>
<li>找到phpDocumentor\Reflection\example<em>e最后“\”的位置，将其后面文件名中’‘</em>’‘字符转为文件分隔符“/”,得到$logicalPathPsr0即phpDocumentor/Reflection/example/e.php(hh)<br>利用命名空间第一个字母p作为前缀索引搜索prefixLengthsPsr4数组，查到下面这个数组：</li>
</ul>
</blockquote>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="string">'P'</span> =&gt; </div><div class="line">    <span class="keyword">array</span> (</div><div class="line">        <span class="string">'Prophecy\\'</span> =&gt; </div><div class="line">        <span class="keyword">array</span> (</div><div class="line">            <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/phpspec/prophecy/src'</span>,</div><div class="line">        ),</div><div class="line">        <span class="string">'phpDocumentor'</span> =&gt; </div><div class="line">        <span class="keyword">array</span> (</div><div class="line">            <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/erusev/parsedown'</span>,</div><div class="line">        ),</div><div class="line">    ),</div></pre></td></tr></table></figure>
</code></pre><blockquote>
<ul>
<li>遍历这个数组，得到两个顶层命名空间phpDocumentor和Prophecy</li>
<li>用这两个顶层命名空间与phpDocumentor\Reflection\example_e相比较，可以得到phpDocumentor这个顶层命名空间</li>
<li>在映射数组中得到phpDocumentor目录映射为’__DIR__ . ‘/..’ . ‘/erusev/parsedown’</li>
<li>查看 “目录+文件分隔符//+\$logicalPathPsr0”文件是否存在，存在即返回。这里就是<br>“__DIR__ . ‘/..’ . ‘/erusev/parsedown + //+ phpDocumentor//Reflection//example/e.php(hh)”</li>
<li>如果失败，则利用fallbackDirsPsr0数组里面的目录继续判断是否存在文件，具体方法是“目录+文件分隔符//+\$logicalPathPsr0”</li>
<li>如果仍然找不到，则利用stream_resolve_include_path()，在当前include目录寻找该文件，如果找到返回绝对路径。</li>
</ul>
</blockquote>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>&emsp;&emsp;经过三篇文章，终于写完了PHP Composer自动加载的原理与实现，结下来我们开始讲解laravel框架下的门面Facade,这个门面功能和自动加载有着一些联系.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/03/13/Composer Autoload Source Reading —— Start and Initialize/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/13/Composer Autoload Source Reading —— Start and Initialize/" itemprop="url">
                  Composer的Autoload源码实现——启动与初始化
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-13T22:49:00+08:00">
                2017-03-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码/" itemprop="url" rel="index">
                    <span itemprop="name">源码</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码/composer/" itemprop="url" rel="index">
                    <span itemprop="name">composer</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码/composer/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/13/Composer Autoload Source Reading —— Start and Initialize/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/13/Composer Autoload Source Reading —— Start and Initialize/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/03/13/Composer Autoload Source Reading —— Start and Initialize/" class="leancloud_visitors" data-flag-title="Composer的Autoload源码实现——启动与初始化">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>&emsp;&emsp;<a href="http://leoyang90.cn/2017/03/11/PHP-Composer-autoload/" target="_blank" rel="external">上一篇文章</a>，我们讨论了PHP的自动加载原理、PHP的命名空间、PHP的PSR0与PSR4标准，有了这些知识，其实我们就可以按照PSR4标准写出可以自动加载的程序了。然而我们为什么要自己写呢？尤其是有Composer这神一样的包管理器的情况下？</p>
<hr>
<h1 id="Composer自动加载概论"><a href="#Composer自动加载概论" class="headerlink" title="Composer自动加载概论"></a>Composer自动加载概论</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>&emsp;&emsp;Composer 是 PHP 的一个依赖管理工具。它允许你申明项目所依赖的代码库，它会在你的项目中为你安装他们。详细内容可以查看<a href="http://docs.phpcomposer.com/00-intro.html" target="_blank" rel="external">Composer 中文网</a>。<br>&emsp;&emsp;Composer Composer 将这样为你解决问题：</p>
<blockquote>
<ul>
<li>你有一个项目依赖于若干个库。</li>
<li>其中一些库依赖于其他库。</li>
<li>你声明你所依赖的东西。</li>
<li>Composer 会找出哪个版本的包需要安装，并安装它们（将它们下载到你的项目中）。</li>
</ul>
</blockquote>
<p>&emsp;&emsp; 例如，你正在创建一个项目，你需要一个库来做日志记录。你决定使用 monolog。为了将它添加到你的项目中，你所需要做的就是创建一个 composer.json 文件，其中描述了项目的依赖关系。</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"require"</span>: &#123;</div><div class="line">    <span class="string">"monolog/monolog"</span>: <span class="string">"1.2.*"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;然后我们只要在项目里面直接use Monolog\Logger即可，神奇吧！<br>&emsp;&emsp; 简单的说，Composer帮助我们下载好了符合PSR0或PSR4标准的第三方库，并把文件放在相应位置；帮我们写了_autoload()函数，注册到了spl_register()函数，当我们想用第三方库的时候直接使用命名空间即可。<br>&emsp;&emsp;<br>&emsp;&emsp;那么当我们想要写自己的命名空间的时候，该怎么办呢？很简单，我们只要按照PSR4标准命名我们的命名空间，放置我们的文件，然后在composer里面写好顶级域名与具体目录的映射，就可以享用composer的便利了。<br>&emsp;&emsp; 当然如果有一个非常棒的框架，我们会惊喜地发现，在composer里面写顶级域名映射这事我们也不用做了，框架已经帮我们写好了顶级域名映射了，我们只需要在框架里面新建文件，在新建的文件中写好命名空间，就可以在任何地方use我们的命名空间了。<br>&emsp;&emsp; 下面我们就以laravel框架为例，讲一讲composer是如何实现PSR0和PSR4标准的自动加载功能。</p>
<h2 id="Composer自动加载文件"><a href="#Composer自动加载文件" class="headerlink" title="Composer自动加载文件"></a>Composer自动加载文件</h2><p>&emsp;&emsp;首先，我们先大致了解一下Composer自动加载所用到的源文件。</p>
<blockquote>
<ol>
<li>autoload_real.php：自动加载功能的引导类。任务是composer加载类的初始化(顶级命名空间与文件路                     径映射初始化)和注册(spl_autoload_register())。</li>
<li>ClassLoader.php：composer加载类。composer自动加载功能的核心类。</li>
<li>autoload_static.php：顶级命名空间初始化类，用于给核心类初始化顶级命名空间。</li>
<li>autoload_classmap.php：自动加载的最简单形式，有完整的命名空间和文件目录的映射；</li>
<li>autoload_files.php：用于加载全局函数的文件，存放各个全局函数所在的文件路径名；</li>
<li>autoload_namespaces.php：符合PSR0标准的自动加载文件，存放着顶级命名空间与文件的映射；</li>
<li>autoload_psr4.php：符合PSR4标准的自动加载文件，存放着顶级命名空间与文件的映射；</li>
</ol>
</blockquote>
<h1 id="laravel框架下Composer的自动加载源码分析——启动"><a href="#laravel框架下Composer的自动加载源码分析——启动" class="headerlink" title="laravel框架下Composer的自动加载源码分析——启动"></a>laravel框架下Composer的自动加载源码分析——启动</h1><hr>
<p>&emsp;&emsp; laravel框架的初始化是需要composer自动加载协助的，所以laravel的入口文件index.php第一句就是利用composer来实现自动加载功能。</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/autoload.php'</span>;</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;咱们接着去看bootstrap目录下的autoload.php：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">define(<span class="string">'LARAVEL_START'</span>, microtime(<span class="keyword">true</span>));</div><div class="line">    </div><div class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">'/../vendor/autoload.php'</span>;</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;再去vendor目录下的autoload.php：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/composer'</span> . <span class="string">'/autoload_real.php'</span>;</div><div class="line"></div><div class="line"><span class="keyword">return</span> ComposerAutoloaderInit</div><div class="line">       <span class="number">832</span>ea71bfb9a4128da8660baedaac82e::getLoader();</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;为什么框架要在bootstrap/autoload.php转一下？个人理解，laravel这样设计有利于支持或扩展<strong>任意</strong>有自动加载的第三方库。<br>&emsp;&emsp;好了，我们终于要看到了Composer真正要显威的地方了。autoload_real里面就是一个自动加载功能的引导类，这个类不负责具体功能逻辑，只做了两件事：初始化自动加载类、注册自动加载类。<br>&emsp;&emsp;到autoload_real这个文件里面去看，发现这个引导类的名字叫ComposerAutoloaderInit832ea71bfb9a4128da8660baedaac82e，为什么要叫这么古怪的名字呢？因为这是防止用户自定义类名跟这个类重复冲突了，所以在类名上加了一个hash值。其实还有一个做法我们更加熟悉，那就是不直接定义类名，而是定义一个命名空间。这里为什么不定义一个命名空间呢？个人理解：命名空间一般都是为了复用，而这个类只需要运行一次即可，以后也不会用得到，用hash值更加合适。</p>
<h1 id="laravel框架下Composer的自动加载源码分析——autoload-real引导类"><a href="#laravel框架下Composer的自动加载源码分析——autoload-real引导类" class="headerlink" title="laravel框架下Composer的自动加载源码分析——autoload_real引导类"></a>laravel框架下Composer的自动加载源码分析——autoload_real引导类</h1><hr>
<p>&emsp;&emsp;在vendor目录下的autoload.php文件中我们可以看出，程序主要调用了引导类的静态方法getLoader()，我们接着看看这个函数。</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getLoader</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">    <span class="comment">/***************************经典单例模式********************/</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> !== <span class="keyword">self</span>::$loader) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::$loader;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/***********************获得自动加载核心类对象********************/</span></div><div class="line">    spl_autoload_register(<span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit</span></div><div class="line"><span class="string">    832ea71bfb9a4128da8660baedaac82e'</span>, <span class="string">'loadClassLoader'</span>), <span class="keyword">true</span>, <span class="keyword">true</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>::$loader = $loader = <span class="keyword">new</span> \Composer\Autoload\ClassLoader();</div><div class="line">    </div><div class="line">    spl_autoload_unregister(<span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit</span></div><div class="line"><span class="string">    832ea71bfb9a4128da8660baedaac82e'</span>, <span class="string">'loadClassLoader'</span>));</div><div class="line"></div><div class="line">    <span class="comment">/***********************初始化自动加载核心类对象********************/</span></div><div class="line">    $useStaticLoader = PHP_VERSION_ID &gt;= <span class="number">50600</span> &amp;&amp; </div><div class="line">    !defined(<span class="string">'HHVM_VERSION'</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ($useStaticLoader) &#123;</div><div class="line">        <span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_static.php'</span>;</div><div class="line"></div><div class="line">        call_user_func(\Composer\Autoload\ComposerStaticInit</div><div class="line">        <span class="number">832</span>ea71bfb9a4128da8660baedaac82e::getInitializer($loader));</div><div class="line">  </div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_namespaces.php'</span>;</div><div class="line">        <span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</div><div class="line">            $loader-&gt;set($namespace, $path);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_psr4.php'</span>;</div><div class="line">        <span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</div><div class="line">            $loader-&gt;setPsr4($namespace, $path);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $classMap = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_classmap.php'</span>;</div><div class="line">        <span class="keyword">if</span> ($classMap) &#123;</div><div class="line">            $loader-&gt;addClassMap($classMap);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/***********************注册自动加载核心类对象********************/</span></div><div class="line">    $loader-&gt;register(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="comment">/***********************自动加载全局函数********************/</span></div><div class="line">    <span class="keyword">if</span> ($useStaticLoader) &#123;</div><div class="line">        $includeFiles = Composer\Autoload\ComposerStaticInit</div><div class="line">        <span class="number">832</span>ea71bfb9a4128da8660baedaac82e::$files;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $includeFiles = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_files.php'</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">foreach</span> ($includeFiles <span class="keyword">as</span> $fileIdentifier =&gt; $file) &#123;</div><div class="line">        composerRequire</div><div class="line">        <span class="number">832</span>ea71bfb9a4128da8660baedaac82e($fileIdentifier, $file);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $loader;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>  &emsp;&emsp;从上面可以看出，我把自动加载引导类分为5个部分。</p>
<h2 id="第一部分——单例"><a href="#第一部分——单例" class="headerlink" title="第一部分——单例"></a>第一部分——单例</h2><hr>
<p>  第一部分很简单，就是个最经典的单例模式，自动加载类只能有一个。</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="keyword">null</span> !== <span class="keyword">self</span>::$loader) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">self</span>::$loader;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
</code></pre><h2 id="第二部分——构造ClassLoader核心类"><a href="#第二部分——构造ClassLoader核心类" class="headerlink" title="第二部分——构造ClassLoader核心类"></a>第二部分——构造ClassLoader核心类</h2><hr>
<p>&emsp;&emsp;第二部分new一个自动加载的核心类对象。</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/***********************获得自动加载核心类对象********************/</span></div><div class="line">spl_autoload_register(<span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit</span></div><div class="line"><span class="string">832ea71bfb9a4128da8660baedaac82e'</span>, <span class="string">'loadClassLoader'</span>), <span class="keyword">true</span>, <span class="keyword">true</span>);</div><div class="line"></div><div class="line"><span class="keyword">self</span>::$loader = $loader = <span class="keyword">new</span> \Composer\Autoload\ClassLoader();</div><div class="line"></div><div class="line">spl_autoload_unregister(<span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit</span></div><div class="line"><span class="string">832ea71bfb9a4128da8660baedaac82e'</span>, <span class="string">'loadClassLoader'</span>));</div></pre></td></tr></table></figure>
</code></pre><p>loadClassLoader()函数：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">loadClassLoader</span><span class="params">($class)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="string">'Composer\Autoload\ClassLoader'</span> === $class) &#123;</div><div class="line">        <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/ClassLoader.php'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>  &emsp;&emsp;  从程序里面我们可以看出，composer先向PHP自动加载机制注册了一个函数，这个函数require了ClassLoader文件。成功new出该文件中核心类ClassLoader()后，又销毁了该函数。为什么不直接require，而要这么麻烦？原因就是怕有的用户也定义了个\Composer\Autoload\ClassLoader命名空间，导致自动加载错误文件。那为什么不跟引导类一样用个hash呢？因为这个类是可以复用的，框架允许用户使用这个类。</p>
<h2 id="第三部分——初始化核心类对象"><a href="#第三部分——初始化核心类对象" class="headerlink" title="第三部分——初始化核心类对象"></a>第三部分——初始化核心类对象</h2><hr>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/***********************初始化自动加载核心类对象********************/</span></div><div class="line">$useStaticLoader = PHP_VERSION_ID &gt;= <span class="number">50600</span> &amp;&amp; !defined(<span class="string">'HHVM_VERSION'</span>);</div><div class="line"><span class="keyword">if</span> ($useStaticLoader) &#123;</div><div class="line">   <span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_static.php'</span>;</div><div class="line"></div><div class="line">   call_user_func(\Composer\Autoload\ComposerStaticInit</div><div class="line">   <span class="number">832</span>ea71bfb9a4128da8660baedaac82e::getInitializer($loader));</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    $map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_namespaces.php'</span>;</div><div class="line">    <span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</div><div class="line">       $loader-&gt;set($namespace, $path);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_psr4.php'</span>;</div><div class="line">    <span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</div><div class="line">       $loader-&gt;setPsr4($namespace, $path);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $classMap = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_classmap.php'</span>;</div><div class="line">    <span class="keyword">if</span> ($classMap) &#123;</div><div class="line">        $loader-&gt;addClassMap($classMap);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
</code></pre><p>   &emsp;&emsp;  这一部分就是对自动加载类的初始化，主要是给自动加载核心类初始化顶级命名空间映射。初始化的方法有两种：(1)使用autoload_static进行静态初始化；(2)调用核心类接口初始化。</p>
<h3 id="autoload-static静态初始化"><a href="#autoload-static静态初始化" class="headerlink" title="autoload_static静态初始化"></a>autoload_static静态初始化</h3><hr>
<p>  &emsp;&emsp;静态初始化只支持PHP5.6以上版本并且不支持HHVM虚拟机。我们深入autoload_static.php这个文件发现这个文件定义了一个用于静态初始化的类，名字叫ComposerStaticInit832ea71bfb9a4128da8660baedaac82e，仍然为了避免冲突加了hash值。这个类很简单：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ComposerStaticInit832ea71bfb9a4128da8660baedaac82e</span></span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> $files = <span class="keyword">array</span>(...);</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> $prefixLengthsPsr4 = <span class="keyword">array</span>(...);</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> $prefixDirsPsr4 = <span class="keyword">array</span>(...);</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> $prefixesPsr0 = <span class="keyword">array</span>(...);</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> $classMap = <span class="keyword">array</span> (...);</div><div class="line">     </div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInitializer</span><span class="params">(ClassLoader $loader)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> \Closure::bind(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($loader)</span> </span>&#123;</div><div class="line">        $loader-&gt;prefixLengthsPsr4 = ComposerStaticInit832ea71bfb9a4128da8660baedaac82e::$prefixLengthsPsr4;</div><div class="line">        $loader-&gt;prefixDirsPsr4 = ComposerStaticInit832ea71bfb9a4128da8660baedaac82e::$prefixDirsPsr4;</div><div class="line">        $loader-&gt;prefixesPsr0 = ComposerStaticInit832ea71bfb9a4128da8660baedaac82e::$prefixesPsr0;</div><div class="line">        $loader-&gt;classMap = ComposerStaticInit832ea71bfb9a4128da8660baedaac82e::$classMap;</div><div class="line"></div><div class="line">    &#125;, <span class="keyword">null</span>, ClassLoader::class);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>   &emsp;&emsp;这个静态初始化类的核心就是getInitializer()函数，它将自己类中的顶级命名空间映射给了ClassLoader类。值得注意的是这个函数返回的是一个匿名函数，为什么呢？原因就是ClassLoader类中的prefixLengthsPsr4、prefixDirsPsr4等等都是private的。。。普通的函数没办法给类的private成员变量赋值。利用匿名函数的绑定功能就可以将把匿名函数转为ClassLoader类的成员函数。关于匿名函数的<a href="http://www.cnblogs.com/yjf512/p/4421289.html" target="_blank" rel="external">绑定功能</a>。<br> &emsp;&emsp;接下来就是顶级命名空间初始化的关键了。</p>
<h4 id="最简单的classMap"><a href="#最简单的classMap" class="headerlink" title="最简单的classMap:"></a><strong>最简单的classMap:</strong></h4><pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> $classMap = <span class="keyword">array</span> (</div><div class="line">    <span class="string">'App\\Console\\Kernel'</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../..'</span> . <span class="string">'/app/Console/Kernel.php'</span>,</div><div class="line">    <span class="string">'App\\Exceptions\\Handler'</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../..'</span> . <span class="string">'/app/Exceptions/Handler.php'</span>,</div><div class="line">    <span class="string">'App\\Http\\Controllers\\Auth\\ForgotPasswordController'</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../..'</span> . <span class="string">'/app/Http/Controllers/Auth/ForgotPasswordController.php'</span>,</div><div class="line">    <span class="string">'App\\Http\\Controllers\\Auth\\LoginController'</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../..'</span> . <span class="string">'/app/Http/Controllers/Auth/LoginController.php'</span>,</div><div class="line">    <span class="string">'App\\Http\\Controllers\\Auth\\RegisterController'</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../..'</span> . <span class="string">'/app/Http/Controllers/Auth/RegisterController.php'</span>,</div><div class="line">    ...)</div></pre></td></tr></table></figure>
</code></pre><p> &emsp;&emsp;简单吧，直接命名空间全名与目录的映射，没有顶级命名空间。。。简单粗暴，也导致这个数组相当的大。</p>
<h4 id="PSR0顶级命名空间映射："><a href="#PSR0顶级命名空间映射：" class="headerlink" title="PSR0顶级命名空间映射："></a><strong>PSR0顶级命名空间映射：</strong></h4><pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="keyword">static</span> $prefixesPsr0 = <span class="keyword">array</span> (</div><div class="line">    <span class="string">'P'</span> =&gt; </div><div class="line">    <span class="keyword">array</span> (</div><div class="line">        <span class="string">'Prophecy\\'</span> =&gt; </div><div class="line">        <span class="keyword">array</span> (</div><div class="line">            <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/phpspec/prophecy/src'</span>,</div><div class="line">        ),</div><div class="line">        <span class="string">'Parsedown'</span> =&gt; </div><div class="line">        <span class="keyword">array</span> (</div><div class="line">            <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/erusev/parsedown'</span>,</div><div class="line">        ),</div><div class="line">    ),</div><div class="line">    <span class="string">'M'</span> =&gt; </div><div class="line">    <span class="keyword">array</span> (</div><div class="line">        <span class="string">'Mockery'</span> =&gt; </div><div class="line">        <span class="keyword">array</span> (</div><div class="line">            <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/mockery/mockery/library'</span>,</div><div class="line">        ),</div><div class="line">    ),</div><div class="line">    <span class="string">'J'</span> =&gt; </div><div class="line">    <span class="keyword">array</span> (</div><div class="line">        <span class="string">'JakubOnderka\\PhpConsoleHighlighter'</span> =&gt; </div><div class="line">        <span class="keyword">array</span> (</div><div class="line">            <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/jakub-onderka/php-console-highlighter/src'</span>,</div><div class="line">        ),</div><div class="line">        <span class="string">'JakubOnderka\\PhpConsoleColor'</span> =&gt; </div><div class="line">        <span class="keyword">array</span> (</div><div class="line">            <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/jakub-onderka/php-console-color/src'</span>,</div><div class="line">        ),</div><div class="line">    ),</div><div class="line">    <span class="string">'D'</span> =&gt; </div><div class="line">    <span class="keyword">array</span> (</div><div class="line">        <span class="string">'Doctrine\\Common\\Inflector\\'</span> =&gt; </div><div class="line">        <span class="keyword">array</span> (</div><div class="line">            <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/doctrine/inflector/lib'</span>,</div><div class="line">        ),</div><div class="line">    ),</div><div class="line">);</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;为了快速找到顶级命名空间，我们这里使用命名空间第一个字母作为前缀索引。这个映射的用法比较明显，假如我们有Parsedown/example这样的命名空间，首先通过首字母P，找到</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="string">'P'</span> =&gt; </div><div class="line">    <span class="keyword">array</span> (</div><div class="line">        <span class="string">'Prophecy\\'</span> =&gt; </div><div class="line">        <span class="keyword">array</span> (</div><div class="line">            <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/phpspec/prophecy/src'</span>,</div><div class="line">        ),</div><div class="line">        <span class="string">'Parsedown'</span> =&gt; </div><div class="line">        <span class="keyword">array</span> (</div><div class="line">            <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/erusev/parsedown'</span>,</div><div class="line">        ),</div><div class="line">    )</div></pre></td></tr></table></figure>
</code></pre><p>这个数组，然后我们就会遍历这个数组来和Parsedown/example比较，发现第一个Prophecy不符合，第二个Parsedown符合，然后得到了映射目录：(<strong>映射目录可能不止一个</strong>)</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">array</span> (</div><div class="line">          <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/erusev/parsedown'</span>,</div><div class="line">       )</div></pre></td></tr></table></figure>
<p>  我们会接着遍历这个数组，尝试__DIR__ .’/..’ . ‘/erusev/parsedown/Parsedown/example.php是否存在，如果不存在接着遍历数组(这个例子数组只有一个元素)，如果数组遍历完都没有，就会加载失败。 </p>
<h4 id="PSR4标准顶级命名空间映射数组："><a href="#PSR4标准顶级命名空间映射数组：" class="headerlink" title="PSR4标准顶级命名空间映射数组："></a><strong>PSR4标准顶级命名空间映射数组：</strong></h4><pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> $prefixLengthsPsr4 = <span class="keyword">array</span>(</div><div class="line"><span class="string">'p'</span> =&gt; </div><div class="line"><span class="keyword">array</span> (</div><div class="line">    <span class="string">'phpDocumentor\\Reflection\\'</span> =&gt; <span class="number">25</span>,</div><div class="line">),</div><div class="line"><span class="string">'S'</span> =&gt; </div><div class="line"><span class="keyword">array</span> (</div><div class="line">    <span class="string">'Symfony\\Polyfill\\Mbstring\\'</span> =&gt; <span class="number">26</span>,</div><div class="line">    <span class="string">'Symfony\\Component\\Yaml\\'</span> =&gt; <span class="number">23</span>,</div><div class="line">    <span class="string">'Symfony\\Component\\VarDumper\\'</span> =&gt; <span class="number">28</span>,</div><div class="line">    ...</div><div class="line">),</div><div class="line">...);</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> $prefixDirsPsr4 = <span class="keyword">array</span> (</div><div class="line"><span class="string">'phpDocumentor\\Reflection\\'</span> =&gt; </div><div class="line"><span class="keyword">array</span> (</div><div class="line">    <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/phpdocumentor/reflection-common/src'</span>,</div><div class="line">    <span class="number">1</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/phpdocumentor/type-resolver/src'</span>,</div><div class="line">    <span class="number">2</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/phpdocumentor/reflection-docblock/src'</span>,</div><div class="line">),</div><div class="line"> <span class="string">'Symfony\\Polyfill\\Mbstring\\'</span> =&gt; </div><div class="line"><span class="keyword">array</span> (</div><div class="line">    <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/symfony/polyfill-mbstring'</span>,</div><div class="line">),</div><div class="line"><span class="string">'Symfony\\Component\\Yaml\\'</span> =&gt; </div><div class="line"><span class="keyword">array</span> (</div><div class="line">    <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/symfony/yaml'</span>,</div><div class="line">),</div><div class="line">...)</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;PSR4标准顶级命名空间映射用了两个数组，第一个和PSR0一样用命名空间第一个字母作为前缀索引，然后是顶级命名空间，但是最终并不是文件路径，而是顶级命名空间的长度。为什么呢？因为前一篇<a href="http://leoyang90.cn/2017/03/11/PHP-Composer-autoload/" target="_blank" rel="external">文章</a>我们说过，PSR4标准的文件目录更加灵活，更加简洁。PSR0中顶级命名空间目录直接加到命名空间前面就可以得到路径(Parsedown/example =&gt; __DIR__ .’/..’ . ‘/erusev/parsedown/<strong>Parsedown/example.php</strong>)，而PSR4标准却是用顶级命名空间目录替换顶级命名空间（Parsedown/example =&gt; __DIR__ .’/..’ . ‘/erusev/parsedown/<strong>example.php</strong>)，所以获得顶级命名空间的长度很重要。<br>&emsp;&emsp;具体的用法：假如我们找Symfony\Polyfill\Mbstring\example这个命名空间，和PSR0一样通过前缀索引和字符串匹配我们得到了</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'Symfony\\Polyfill\\Mbstring\\'</span> =&gt; <span class="number">26</span>,</div></pre></td></tr></table></figure>
</code></pre><p>这条记录，键是顶级命名空间，值是命名空间的长度。拿到顶级命名空间后去$prefixDirsPsr4数组获取它的映射目录数组：(<strong>注意映射目录可能不止一条</strong>)</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="string">'Symfony\\Polyfill\\Mbstring\\'</span> =&gt; </div><div class="line">    <span class="keyword">array</span> (</div><div class="line">        <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/symfony/polyfill-mbstring'</span>,</div><div class="line">    )</div></pre></td></tr></table></figure>
</code></pre><p>然后我们就可以将命名空间Symfony\Polyfill\Mbstring\example前26个字符替换成目录__DIR__ . ‘/..’ . ‘/symfony/polyfill-mbstring，我们就得到了__DIR__ . ‘/..’ . ‘/symfony/polyfill-mbstring/example.php，先验证磁盘上这个文件是否存在，如果不存在接着遍历。如果遍历后没有找到，则加载失败。<br>&emsp;&emsp;<br>&emsp;&emsp;自动加载核心类ClassLoader的静态初始化完成！！！</p>
<h3 id="ClassLoader接口初始化"><a href="#ClassLoader接口初始化" class="headerlink" title="ClassLoader接口初始化"></a>ClassLoader接口初始化</h3><hr>
<p>&emsp;&emsp;如果PHP版本低于5.6或者使用HHVM虚拟机环境，那么就要使用核心类的接口进行初始化。</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//PSR0标准</span></div><div class="line">$map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_namespaces.php'</span>;</div><div class="line"><span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</div><div class="line">   $loader-&gt;set($namespace, $path);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//PSR4标准</span></div><div class="line">$map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_psr4.php'</span>;</div><div class="line"><span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</div><div class="line">   $loader-&gt;setPsr4($namespace, $path);</div><div class="line">&#125;</div><div class="line"></div><div class="line">$classMap = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_classmap.php'</span>;</div><div class="line"><span class="keyword">if</span> ($classMap) &#123;</div><div class="line">   $loader-&gt;addClassMap($classMap);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><h4 id="PSR0标准"><a href="#PSR0标准" class="headerlink" title="PSR0标准"></a><strong>PSR0标准</strong></h4><p>autoload_namespaces：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">   <span class="keyword">return</span> <span class="keyword">array</span>(</div><div class="line">   <span class="string">'Prophecy\\'</span> =&gt; <span class="keyword">array</span>($vendorDir . <span class="string">'/phpspec/prophecy/src'</span>),</div><div class="line">   <span class="string">'Parsedown'</span> =&gt; <span class="keyword">array</span>($vendorDir . <span class="string">'/erusev/parsedown'</span>),</div><div class="line">   <span class="string">'Mockery'</span> =&gt; <span class="keyword">array</span>($vendorDir . <span class="string">'/mockery/mockery/library'</span>),</div><div class="line">   <span class="string">'JakubOnderka\\PhpConsoleHighlighter'</span> =&gt; <span class="keyword">array</span>($vendorDir . <span class="string">'/jakub-onderka/php-console-highlighter/src'</span>),</div><div class="line">   <span class="string">'JakubOnderka\\PhpConsoleColor'</span> =&gt; <span class="keyword">array</span>($vendorDir . <span class="string">'/jakub-onderka/php-console-color/src'</span>),</div><div class="line">   <span class="string">'Doctrine\\Common\\Inflector\\'</span> =&gt; <span class="keyword">array</span>($vendorDir . <span class="string">'/doctrine/inflector/lib'</span>),</div><div class="line">);</div></pre></td></tr></table></figure>
</code></pre><p>PSR0标准的初始化接口：    </p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">($prefix, $paths)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (!$prefix) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;fallbackDirsPsr0 = (<span class="keyword">array</span>) $paths;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;prefixesPsr0[$prefix[<span class="number">0</span>]][$prefix] = (<span class="keyword">array</span>) $paths;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>很简单，PSR0标准取出命名空间的第一个字母作为索引，一个索引对应多个顶级命名空间，一个顶级命名空间对应多个目录路径，具体形式可以查看上面我们讲的autoload_static的$prefixesPsr0。如果没有顶级命名空间，就只存储一个路径名，以便在后面尝试加载。</p>
<h4 id="PSR4标准"><a href="#PSR4标准" class="headerlink" title="PSR4标准"></a><strong>PSR4标准</strong></h4><p>autoload_psr4</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="keyword">array</span>(</div><div class="line"><span class="string">'XdgBaseDir\\'</span> =&gt; <span class="keyword">array</span>($vendorDir . <span class="string">'/dnoegel/php-xdg-base-dir/src'</span>),</div><div class="line"><span class="string">'Webmozart\\Assert\\'</span> =&gt; <span class="keyword">array</span>($vendorDir . <span class="string">'/webmozart/assert/src'</span>),</div><div class="line"><span class="string">'TijsVerkoyen\\CssToInlineStyles\\'</span> =&gt; <span class="keyword">array</span>($vendorDir . <span class="string">'/tijsverkoyen/css-to-inline-styles/src'</span>),</div><div class="line"><span class="string">'Tests\\'</span> =&gt; <span class="keyword">array</span>($baseDir . <span class="string">'/tests'</span>),</div><div class="line"><span class="string">'Symfony\\Polyfill\\Mbstring\\'</span> =&gt; <span class="keyword">array</span>($vendorDir . <span class="string">'/symfony/polyfill-mbstring'</span>),</div><div class="line">...</div><div class="line">)</div></pre></td></tr></table></figure>
</code></pre><p> PSR4标准的初始化接口:</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setPsr4</span><span class="params">($prefix, $paths)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (!$prefix) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;fallbackDirsPsr4 = (<span class="keyword">array</span>) $paths;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $length = strlen($prefix);</div><div class="line">        <span class="keyword">if</span> (<span class="string">'\\'</span> !== $prefix[$length - <span class="number">1</span>]) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \InvalidArgumentException(<span class="string">"A non-empty PSR-4 prefix must end with a namespace separator."</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">$this</span>-&gt;prefixLengthsPsr4[$prefix[<span class="number">0</span>]][$prefix] = $length;</div><div class="line">        <span class="keyword">$this</span>-&gt;prefixDirsPsr4[$prefix] = (<span class="keyword">array</span>) $paths;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>PSR4初始化接口也很简单。如果没有顶级命名空间，就直接保存目录。如果有命名空间的话，要保证顶级命名空间最后是\，然后分别保存（前缀=》顶级命名空间，顶级命名空间=》顶级命名空间长度），（顶级命名空间=》目录）这两个映射数组。具体形式可以查看上面我们讲的autoload_static的prefixLengthsPsr4、 $prefixDirsPsr4。</p>
<h4 id="傻瓜式命名空间映射"><a href="#傻瓜式命名空间映射" class="headerlink" title="傻瓜式命名空间映射"></a><strong>傻瓜式命名空间映射</strong></h4><p>autoload_classmap：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> $classMap = <span class="keyword">array</span> (</div><div class="line">    <span class="string">'App\\Console\\Kernel'</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../..'</span> . <span class="string">'/app/Console/Kernel.php'</span>,</div><div class="line">    <span class="string">'App\\Exceptions\\Handler'</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../..'</span> . <span class="string">'/app/Exceptions/Handler.php'</span>,</div><div class="line">    ...</div><div class="line">    )</div></pre></td></tr></table></figure>
</code></pre><p>addClassMap:</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addClassMap</span><span class="params">(array $classMap)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;classMap) &#123;</div><div class="line">           <span class="keyword">$this</span>-&gt;classMap = array_merge(<span class="keyword">$this</span>-&gt;classMap, $classMap);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">$this</span>-&gt;classMap = $classMap;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</code></pre><p>这个最简单，就是整个命名空间与目录之间的映射。</p>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>&emsp;&emsp;其实我很想接着写下下去，但是这样会造成篇幅过长，所以我就把自动加载的注册和运行放到下一篇文章了。我们回顾一下，这篇文章主要讲了：（1）框架如何启动composer自动加载;（2）composer自动加载分为5部分；<br>&emsp;&emsp;其实说是5部分，真正重要的就两部分——初始化与注册。初始化负责顶层命名空间的目录映射，注册负责实现顶层以下的命名空间映射规则。</p>
<p> Written with <a href="https://stackedit.io/" target="_blank" rel="external">StackEdit</a>.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://leoyang90.github.io/2017/03/11/PHP-Composer-autoload/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Leo Yang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/master.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="LEOYANG'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="LEOYANG'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/11/PHP-Composer-autoload/" itemprop="url">
                  PHP自动加载功能原理解析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-11T23:25:00+08:00">
                2017-03-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/composer/" itemprop="url" rel="index">
                    <span itemprop="name">composer</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/composer/laravel/" itemprop="url" rel="index">
                    <span itemprop="name">laravel</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/11/PHP-Composer-autoload/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/11/PHP-Composer-autoload/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/03/11/PHP-Composer-autoload/" class="leancloud_visitors" data-flag-title="PHP自动加载功能原理解析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>&emsp;&emsp;<br>&emsp;&emsp;这篇文章是对PHP自动加载功能的一个总结，内容涉及PHP的自动加载功能、PHP的命名空间、PHP的PSR0与PSR4标准等内容。</p>
<hr>
<h1 id="一、PHP自动加载功能"><a href="#一、PHP自动加载功能" class="headerlink" title="一、PHP自动加载功能"></a>一、PHP自动加载功能</h1><h2 id="PHP自动加载功能的由来"><a href="#PHP自动加载功能的由来" class="headerlink" title="PHP自动加载功能的由来"></a>PHP自动加载功能的由来</h2><p>&emsp;&emsp;在PHP开发过程中，如果希望从外部引入一个class，通常会使用include和require方法，去把定义这个class的文件包含进来。这个在小规模开发的时候，没什么大问题。但在大型的开发项目中，使用这种方式会带来一些隐含的问题：如果一个PHP文件需要使用很多其它类，那么就需要很多的require/include语句，这样有可能会造成遗漏或者包含进不必要的类文件。如果大量的文件都需要使用其它的类，那么要保证每个文件都包含正确的类文件肯定是一个噩梦， 况且require_once的代价很大。</p>
<p>&emsp;&emsp;PHP5为这个问题提供了一个解决方案，这就是类的自动装载(autoload)机制。autoload机制可以使得PHP程序有可能在使用类时才自动包含类文件，而不是一开始就将所有的类文件include进来，这种机制也称为lazy loading。 </p>
<p>&emsp;&emsp;总结起来，自动加载功能带来了几处优点：</p>
<blockquote>
<ol>
<li>使用类之前无需include或者require</li>
<li><em>使用类的时候才会require/include文件，实现了lazy loading，避免了require/include多余文件。</em></li>
<li><em>无需考虑引入类的实际磁盘地址，实现了逻辑和实体文件的分离。</em></li>
</ol>
</blockquote>
<p>&emsp;&emsp;<br>&emsp;&emsp;如果想具体详细的了解关于自动加载的功能，可以查看资料：<br>&emsp;&emsp;<a href="http://blog.csdn.net/hguisu/article/details/7463333" target="_blank" rel="external">PHP的类自动加载机制</a><br>&emsp;&emsp;<a href="http://www.jb51.net/article/31279.htm" target="_blank" rel="external">PHP的autoload机制的实现解析</a></p>
<h2 id="PHP自动加载函数-autoload"><a href="#PHP自动加载函数-autoload" class="headerlink" title="PHP自动加载函数__autoload()"></a>PHP自动加载函数__autoload()</h2><p>&emsp;&emsp;通常PHP5在使用一个类时，如果发现这个类没有加载，就会自动运行_autoload()函数，这个函数是我们在程序中自定义的，在这个函数中我们可以加载需要使用的类。下面是个简单的示例：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">__autoload</span><span class="params">($classname)</span> </span>&#123;</div><div class="line">   <span class="keyword">require_once</span> ($classname . <span class="string">"class.php"</span>); </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;在我们这个简单的例子中，我们直接将类名加上扩展名”.class.php”构成了类文件名，然后使用require_once将其加载。从这个例子中，我们可以看出autoload至少要做三件事情：</p>
<blockquote>
<p> <em>1. 根据类名确定类文件名；</em><br> <em>2. 确定类文件所在的磁盘路径(在我们的例子是最简单的情况，类与调用它们的PHP程序文件在同一个文件夹下)；</em><br> <em>3. 将类从磁盘文件中加载到系统中。</em></p>
</blockquote>
<p>&emsp;&emsp;<br>&emsp;&emsp;第三步最简单，只需要使用include/require即可。要实现第一步，第二步的功能，必须在开发时约定类名与磁盘文件的映射方法，只有这样我们才能根据类名找到它对应的磁盘文件。</p>
<p>&emsp;&emsp;当有大量的类文件要包含的时候，我们只要确定相应的规则，然后在<strong>__autoload()函数中，将类名与实际的磁盘文件对应起来，就可以实现lazy loading的效果</strong>。从这里我们也可以看出_autoload()函数的实现中最重要的是类名与实际的磁盘文件映射规则的实现。 </p>
<h2 id="autoload-函数存在的问题"><a href="#autoload-函数存在的问题" class="headerlink" title="__autoload()函数存在的问题"></a>__autoload()函数存在的问题</h2><p>&emsp;&emsp;如果在一个系统的实现中，如果需要使用很多其它的类库，这些类库可能是由不同的开发人员编写的，  其类名与实际的磁盘文件的映射规则不尽相同。这时如果要实现类库文件的自动加载，就必须<strong>在__autoload()函数中将所有的映射规则全部实现</strong>，这样的话autoload()函数有可能会非常复杂，甚至无法实现。最后可能会导致autoload()函数十分臃肿，这时即便能够实现，也会给将来的维护和系统效率带来很大的负面影响。</p>
<p>&emsp;&emsp;那么问题出现在哪里呢？问题出现在<strong>_autoload()是全局函数只能定义一次</strong>，不够灵活，所以所有的类名与文件名对应的逻辑规则都要在一个函数里面实现，造成这个函数的臃肿。那么如何来解决这个问题呢？答案就是使用一个<strong>_autoload调用堆栈</strong>，不同的映射关系写到不同的_autoload函数中去，然后统一注册统一管理，这个就是PHP5引入的SPL Autoload。</p>
<h2 id="SPL-Autoload"><a href="#SPL-Autoload" class="headerlink" title="SPL Autoload"></a>SPL Autoload</h2><p>&emsp;&emsp;SPL是Standard PHP Library(标准PHP库)的缩写。它是PHP5引入的一个扩展库，其主要功能包括autoload机制的实现及包括各种Iterator接口或类。SPL Autoload具体有几个函数：</p>
<blockquote>
<ol>
<li><em>spl_autoload_register：注册__autoload()函数</em></li>
<li><em>spl_autoload_unregister：注销已注册的函数</em> </li>
<li><em>spl_autoload_functions：返回所有已注册的函数</em> </li>
<li><em>spl_autoload_call：尝试所有已注册的函数来加载类</em></li>
<li><em>spl_autoload ：__autoload()的默认实现</em></li>
<li><em>spl_autoload_extionsions： 注册并返回spl_autoload函数使用的默认文件扩展名。</em></li>
</ol>
</blockquote>
<p>&emsp;&emsp;<br>&emsp;&emsp;这几个函数具体详细用法可见<a href="http://www.jb51.net/article/56370.htm" target="_blank" rel="external">php中spl_autoload详解</a></p>
<p> &emsp;&emsp;简单来说，spl_autoload就是SPL自己的定义__autoload()函数，功能很简单，就是去注册的目录(由set_include_path设置)找与$classname同名的.php/.inc文件。当然，你也可以指定特定类型的文件，方法是注册扩展名(spl_autoload_extionsions)。</p>
<p> &emsp;&emsp;而spl_autoload_register()就是我们上面所说的autoload调用堆栈，我们可以向这个函数注册多个我们自己的_autoload()函数，当PHP找不到类名时，PHP就会调用这个堆栈，一个一个去调用自定义的_autoload()函数，实现自动加载功能。如果我们不向这个函数输入任何参数，那么就会注册spl_autoload()函数。</p>
<p>&emsp;&emsp;好啦，PHP自动加载的底层就是这些，注册机制已经非常灵活，但是还缺什么呢？我们上面说过，自动加载关键就是类名和文件的映射，这种映射关系不同框架有不同方法，非常灵活，但是过于灵活就会显得杂乱，PHP有专门对这种映射关系的规范，那就是PSR标准中PSR0与PSR4。</p>
<p>&emsp;&emsp;不过在谈PSR0与PSR4之前，我们还需要了解PHP的命名空间的问题，因为这两个标准其实针对的都不是类名与目录文件的映射，而是命名空间与文件的映射。为什么会这样呢？在我的理解中，规范的面向对象PHP思想，命名空间在一定程度上算是类名的别名，那么为什么要推出命名空间，命名空间的优点是什么呢</p>
<hr>
<h1 id="二、Namespace命名空间"><a href="#二、Namespace命名空间" class="headerlink" title="二、Namespace命名空间"></a>二、Namespace命名空间</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;要了解命名空间，首先先看看<a href="http://php.net/manual/zh/language.namespaces.rationale.php" target="_blank" rel="external">官方文档</a> 中对命名空间的介绍：</p>
<blockquote>
<p>&emsp;&emsp;<em>什么是命名空间？从广义上来说，<strong><font color="#ffffff">命名空间是一种封装事物的方法。</font></strong>在很多地方都可以见到这种抽象概念。例如，在操作系统中目录用来将相关文件分组，<strong><font color="#ffffff">对于目录中的文件来说，它就扮演了命名空间的角色。</font></strong>具体举个例子，文件 foo.txt 可以同时在目录/home/greg 和 /home/other 中存在，但在同一个目录中不能存在两个 foo.txt 文件。另外，在目录 /home/greg 外访问 foo.txt 文件时，我们必须将目录名以及目录分隔符放在文件名之前得到 /home/greg/foo.txt。这个原理应用到程序设计领域就是命名空间的概念。</em><br>&emsp;&emsp;<em>在PHP中，命名空间用来解决在编写类库或应用程序时创建可重用的代码如类或函数时碰到的两类问题：</em><br>&emsp;&emsp;<em>1 用户编写的代码与PHP内部的类/函数/常量或第三方类/函数/常量之间的<strong><font color="#ffffff">名字冲突</font></strong>。</em><br>&emsp;&emsp;<em>2 为很长的标识符名称(通常是为了缓解第一类问题而定义的)创建一个<strong><font color="#ffffff">别名</font></strong>（或简短）的名称，提高源代码的可读性。</em><br>&emsp;&emsp;<strong><em><font color="#ffffff">PHP 命名空间提供了一种将相关的类、函数和常量组合到一起的途径。</font></em></strong></p>
</blockquote>
<p>&emsp;&emsp;<br>&emsp;&emsp;简单来说就是PHP是不允许程序中存在两个名字一样一样的类或者函数或者变量名的，那么有人就很疑惑了，那就不起一样名字不就可以了？事实上很多大程序依赖很多第三方库，名字冲突什么的不要太常见，这个就是官网中的第一个问题。那么如何解决这个问题呢？在没有命名空间的时候，可怜的程序员只能给类名起a_b_c_d_e_f这样的，其中a/b/c/d/e/f一般有其特定意义，这样一般就不会发生冲突了，但是这样长的类名编写起来累，读起来更是难受。因此PHP5就推出了命名空间，类名是类名，命名空间是命名空间，程序写/看的时候直接用类名，运行起来机器看的是命名空间，这样就解决了问题。</p>
<p>&emsp;&emsp;另外，命名空间提供了一种将相关的类、函数和常量组合到一起的途径。这也是面向对象语言命名空间的很大用途，把特定用途所需要的类、变量、函数写到一个命名空间中，进行封装。</p>
<p>&emsp;&emsp;解决了类名的问题，我们终于可以回到PSR标准来了，那么PSR0与PSR4是怎么<strong>规范</strong>文件与命名空间的映射关系的呢？答案就是：对<strong>命名空间的命名</strong>（额，有点绕）、<strong>类文件目录的位置</strong>和<strong>两者映射关系</strong>做出了限制，这个就是标准的核心了。更完整的描述可见<a href="http://laravelacademy.org/post/4221.html" target="_blank" rel="external">现代 PHP 新特性系列（一） —— 命名空间</a></p>
<hr>
<h1 id="三、PSR标准"><a href="#三、PSR标准" class="headerlink" title="三、PSR标准"></a>三、PSR标准</h1><p>&emsp;&emsp;<br>&emsp;&emsp;在说PSR0与PSR4之前先介绍一下PSR标准。PSR标准的发明者和规范者是：PHP-FIG，它的网站是：<a href="www.php-fig.org">www.php-fig.org</a>。就是这个联盟组织发明和创造了PSR-[0-4]规范。FIG 是 Framework Interoperability Group（框架可互用性小组）的缩写，由几位开源框架的开发者成立于 2009 年，从那开始也选取了很多其他成员进来，虽然不是 “官方” 组织，但也代表了社区中不小的一块。组织的目的在于：以最低程度的限制，来统一各个项目的编码规范，避免各家自行发展的风格阻碍了程序设计师开发的困扰，于是大伙发明和总结了PSR，PSR是Proposing a Standards Recommendation（提出标准建议）的缩写，截止到目前为止，总共有5套PSR规范，分别是：</p>
<blockquote>
<p>PSR-0 (Autoloading Standard) <em>自动加载标准</em><br>PSR-1 (Basic Coding Standard)<em>基础编码标准</em><br>PSR-2 (Coding Style Guide) <em>编码风格向导</em><br>PSR-3 (Logger Interface) <em>日志接口</em><br>PSR-4 (Improved Autoloading) <em>自动加载的增强版，可以替换掉PSR-0了。</em></p>
</blockquote>
<p>&emsp;&emsp;<br>&emsp;&emsp;具体详细的规范标准可以查看<a href="https://www.zybuluo.com/phper/note/65033" target="_blank" rel="external">PHP中PSR-[0-4]规范</a></p>
<h2 id="PSR0标准"><a href="#PSR0标准" class="headerlink" title="PSR0标准"></a>PSR0标准</h2><p>&emsp;&emsp;<br>&emsp;&emsp;PRS-0规范是他们出的第1套规范，主要是制定了一些自动加载标准（Autoloading Standard）PSR-0强制性要求几点：</p>
<blockquote>
<p>1、  一个完全合格的namespace和class必须符合这样的结构：“\&lt; Vendor Name&gt;(&lt; Namespace&gt;)*&lt; Class Name&gt;”<br>2、每个namespace必须有一个顶层的namespace（”Vendor Name”提供者名字）<br>3、每个namespace可以有多个子namespace<br>4、当从文件系统中加载时，每个namespace的分隔符(/)要转换成 DIRECTORY<em>SEPARATOR(操作系统路径分隔符)<br>5、在类名中，每个下划线(</em>)符号要转换成DIRECTORY<em>SEPARATOR(操作系统路径分隔符)。在namespace中，下划线\</em>符号是没有（特殊）意义的。<br>6、当从文件系统中载入时，合格的namespace和class一定是以 .php 结尾的<br>7、verdor name,namespaces,class名可以由大小写字母组合而成（大小写敏感的）</p>
</blockquote>
<p>&emsp;&emsp;<br>&emsp;&emsp; 具体规则可能有些让人晕，我们从头讲一下。<br>&emsp;&emsp;<br>&emsp;&emsp;我们先来看PSR0标准大致内容，第1、2、3、7条对命名空间的名字做出了限制，第4、5条对命名空间和文件目录的映射关系做出了限制，第6条是文件后缀名。<br>&emsp;&emsp;<br>&emsp;&emsp; 前面我们说过，PSR标准是如何规范命名空间和所在文件目录之间的映射关系？是通过限制命名空间的名字、所在文件目录的位置和两者映射关系。<br>&emsp;&emsp;<br>&emsp;&emsp;那么我们可能就要问了，哪里限制了文件所在目录的位置了呢？其实答案就是：<br>&emsp;&emsp;</p>
<blockquote>
<p>限制命名空间名字 + 限制命名空间名字与文件目录映射 = 限制文件目录</p>
</blockquote>
<p>&emsp;&emsp;<br>&emsp;&emsp;好了，我们先想一想，对于一个具体程序来说，如果它想要支持PSR0标准,它需要做什么调整呢？</p>
<blockquote>
<ol>
<li>首先，程序必须定义一个符合PSR0标准第4、5条的映射函数，然后把这个函数注册到spl_register()中；</li>
<li>其次，定义一个新的命名空间时，命名空间的名字和所在文件的目录位置必须符合第1、2、3、7条。</li>
</ol>
</blockquote>
<p>&emsp;&emsp;<br>&emsp;&emsp; 一般为了代码维护方便，我们会在一个文件只定义一个命名空间。<br>&emsp;&emsp; 好了，我们有了符合PSR0的命名空间的名字，通过符合PSR0标准的映射关系就可以得到符合PSR0标准的文件目录地址，如果我们按照PSR0标准正确存放文件，就可以顺利require该文件了，我们就可以使用该命名空间啦，是不是很神奇呢？<br>&emsp;&emsp;<br>&emsp;&emsp; 接下来，我们详细地来看看PSR0标准到底规范了什么呢？<br>&emsp;&emsp;<br>&emsp;&emsp; 我们以laravel中第三方库Symfony其中一个命名空间/Symfony/Core/Request为例，讲一讲上面PSR0标准。<br>&emsp;&emsp;</p>
<blockquote>
<ol>
<li>一个完全合格的namespace和class必须符合这样的结构：“\&lt; Vendor Name&gt;(&lt; Namespace&gt;)*&lt; Class Name&gt;”</li>
</ol>
</blockquote>
<p>&emsp;&emsp;上面所展示的/Symfony就是Vendor Name，也就是第三方库的名字，/Core是Namespace名字，一般是我们命名空间的一些属性信息(例如request是Symfony的核心功能)；最后Request就是我们命名空间的名字，这个标准规范就是让人看到命名空间的来源、功能非常明朗，有利于代码的维护。<br>&emsp;&emsp;</p>
<blockquote>
<p>2 . 每个namespace必须有一个顶层的namespace（”Vendor Name”提供者名字）</p>
</blockquote>
<p>&emsp;&emsp;也就是说每个命名空间都要有一个类似于/Symfony的顶级命名空间，为什么要有这种规则呢？因为PSR0标准只负责顶级命名空间之后的映射关系，也就是/Symfony/Core/Request这一部分，关于/Symfony应该关联到哪个目录，那就是用户或者框架自己定义的了。所谓的顶层的namespace，就是自定义了映射关系的命名空间，一般就是提供者名字（第三方库的名字）。换句话说顶级命名空间是自动加载的基础。为什么标准要这么设置呢？原因很简单，如果有个命名空间是/Symfony/Core/Transport/Request，还有个命名空间是/Symfony/Core/Transport/Request1,如果没有顶级命名空间，我们就得写两个路径和这两个命名空间相对应，如果再有Request2、Request3呢。有了顶层命名空间/Symfony，那我们就仅仅需要一个目录对应即可，剩下的就利用PSR标准去解析就行了。<br>&emsp;&emsp;</p>
<blockquote>
<p>3.每个namespace可以有多个子namespace</p>
</blockquote>
<p>&emsp;&emsp;这个很简单，Request可以定义成/Symfony/Core/Request，也可以定义成/Symfony/Core/Transport/Request，/Core这个命名空间下面可以有很多子命名空间，放多少层命名空间都是自己定义。</p>
<p>&emsp;&emsp;</p>
<blockquote>
<p> 4.当从文件系统中加载时，每个namespace的分隔符(/)要转换成 DIRECTORY_SEPARATOR(操作系统路径分隔符)</p>
</blockquote>
<p>&emsp;&emsp;现在我们终于来到了映射规范了。命名空间的/符号要转为路径分隔符，也就是说要把/Symfony/Core/Request这个命名空间转为\Symfony\Core\Request这样的目录结构。<br>&emsp;&emsp;</p>
<blockquote>
<p>5.在类名中，每个下划线_符号要转换成DIRECTORYSEPARATOR(操作系统路径分隔符)。在namespace中，下划线\符号是没有（特殊）意义的。</p>
</blockquote>
<p>&emsp;&emsp;这句话的意思就是说，如果我们的命名空间是/Symfony/Core/Request_a，那么我们就应该把它映射到\Symfony\Core\Request\a这样的目录。为什么会有这种规定呢？这是因为PHP5之前并没有命名空间，程序员只能把名字起成Symfony_Core_Request_a这样，PSR0的这条规定就是为了兼容这种情况。<br>&emsp;&emsp;剩下两个很简单就不说了。<br>&emsp;&emsp;<br>&emsp;&emsp;有这样的命名空间命名规则和映射标准，我们就可以推理出我们应该把命名空间所在的文件该放在哪里了。依旧以Symfony/Core/Request为例， 它的目录是/path/to/project/vendor/Symfony/Core/Request.php，其中/path/to/project是你项目在磁盘的位置，/path/to/project/vendor是项目用的所有第三方库所在目录。/path/to/project/vendor/Symfony就是与顶级命名空间/Symfony存在对应关系的目录，再往下的文件目录就是按照PSR0标准建立的：</p>
<blockquote>
<p>&emsp;&emsp; /Symfony/Core/Request  =&gt;  /Symfony/Core/Request.php</p>
</blockquote>
<p>&emsp;&emsp; 一切很完满了是吗？不，还有一些瑕疵：</p>
<blockquote>
<ol>
<li>我们是否应该还兼容没有命名空间的情况呢？</li>
<li>按照PSR0标准，命名空间/A/B/C/D/E/F必然对应一个目录结构/A/B/C/D/E/F，这种目录结构层次是不是太深了？</li>
</ol>
</blockquote>
<h2 id="PSR4标准"><a href="#PSR4标准" class="headerlink" title="PSR4标准"></a>PSR4标准</h2><p>&emsp;&emsp;2013年底，新出了第5个规范——PSR-4。</p>
<p>&emsp;&emsp;PSR-4规范了如何指定文件路径从而自动加载类定义，同时规范了自动加载文件的位置。这个乍一看和PSR-0重复了，实际上，在功能上确实有所重复。区别在于PSR-4的规范比较干净，去除了兼容PHP 5.3以前版本的内容，有一点PSR-0升级版的感觉。当然，PSR-4也不是要完全替代PSR-0，而是在必要的时候补充PSR-0——当然，如果你愿意，PSR-4也可以替代PSR-0。PSR-4可以和包括PSR-0在内的其他自动加载机制共同使用。<br>&emsp;&emsp;<br>&emsp;&emsp; PSR4标准与PSR0标准的区别：</p>
<blockquote>
<ol>
<li>在类名中使用下划线没有任何特殊含义。</li>
<li>命名空间与文件目录的映射方法有所调整。</li>
</ol>
</blockquote>
<p>&emsp;&emsp;对第二项我们详细解释一下(<a href="http://hanfeng.name/blog/2015/08/17/composer-autoload/" target="_blank" rel="external">Composer自动加载的原理</a>)：<br>&emsp;&emsp;假如我们有一个命名空间：Foo/class，Foo是顶级命名空间，其存在着用户定义的与目录的映射关系：</p>
<pre><code>&quot;Foo/&quot; =&gt; &quot;src/&quot;
</code></pre><p>&emsp;&emsp;按照PSR0标准，映射后的文件目录是:src/Foo/class.php，但是按照PSR4标准，映射后的文件目录就会是:src/class.php，为什么要这么更改呢？原因就是怕命名空间太长导致目录层次太深，使得命名空间和文件目录的映射关系更加灵活。</p>
<p>&emsp;&emsp;再举一个例子,来源<a href="https://segmentfault.com/a/1190000000380008" target="_blank" rel="external">PSR-4——新鲜出炉的PHP规范</a>：<br>&emsp;&emsp;PSR-0风格</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">vendor/</div><div class="line">vendor_name/</div><div class="line">    package_name/</div><div class="line">        src/</div><div class="line">            Vendor_Name/</div><div class="line">                Package_Name/</div><div class="line">                    ClassName.php       <span class="comment"># Vendor_Name\Package_Name\ClassName</span></div><div class="line">        tests/</div><div class="line">            Vendor_Name/</div><div class="line">                Package_Name/</div><div class="line">                    ClassNameTest.php   <span class="comment"># Vendor_Name\Package_Name\ClassName</span></div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;PSR-4风格</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">vendor/</div><div class="line">vendor_name/</div><div class="line">    package_name/</div><div class="line">        src/</div><div class="line">            ClassName.php       <span class="comment"># Vendor_Name\Package_Name\ClassName</span></div><div class="line">        tests/</div><div class="line">            ClassNameTest.php   <span class="comment"># Vendor_Name\Package_Name\ClassNameTest</span></div></pre></td></tr></table></figure>
</code></pre><p>&emsp;&emsp;对比以上两种结构，明显可以看出PSR-4带来更简洁的文件结构。</p>
<hr>
<p>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;Written with <a href="https://stackedit.io/" target="_blank" rel="external">StackEdit</a>.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/master.jpg"
               alt="Leo Yang" />
          <p class="site-author-name" itemprop="name">Leo Yang</p>
           
              <p class="site-description motion-element" itemprop="description">Life and Learn!</p>
          
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/LeoYang90" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/liang-de-tai-yang" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Leo Yang</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"leoyang90"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("ftMscWAwCsyt12PCu9jVqOrL-gzGzoHsz", "39fy4YEUohtU0wVi4r4MuKEI");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
